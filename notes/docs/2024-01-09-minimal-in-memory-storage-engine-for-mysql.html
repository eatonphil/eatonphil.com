<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="canonical" href="https://notes.eatonphil.com/2024-01-09-minimal-in-memory-storage-engine-for-mysql.html">
    <title>Writing a minimal in-memory storage engine for MySQL/MariaDB | notes.eatonphil.com</title>
    <meta name="description" content="Writing a minimal in-memory storage engine for MySQL/MariaDB" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" href="/rss.xml" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono">
  </head>
  <body>
    <header>
      <!-- <div class="lfw"> -->
      <!-- 	<div class="container"> -->
      <!-- 	  <div class="row"> -->
      <!-- 	    <a href="https://eatonphil.com/hire-me.html">Hire me!</a> -->
      <!-- 	  </div> -->
      <!-- 	</div> -->
      <!-- </div> -->
      <div class="container">
        <div>
          <div class="row">
	    <div>
	      <a href="https://eatonphil.com" class="sm-link">
		Home
              </a>
	      <a href="/" class="sm-link">
		Notes
              </a>
	      <a href="/favorites.html" class="sm-link hide-mobile">
		Popular
              </a>
	      <a href="/rss.xml" class="sm-link">
		RSS
              </a>
	    </div>
	    	      
	    <div class="subscribe">
	      <a href="https://eatonphil.com/hire-me.html">Hire me</a>
	      <a class="fancy" href="https://notes.eatonphil.com/2024-01-09-minimal-in-memory-storage-engine-for-mysql.html#subscribe">       
		Subscribe          
	      </a>
            </div>
	  </div>
	  <hr />
	  <div class="">
            <h2>January 9, 2024</h2>
            <h1>Writing a minimal in-memory storage engine for MySQL/MariaDB</h1>
            <div class="row" style="padding-bottom: 5px">
              <div class="tags"><a href="/tags/c++.html" class="tag">c++</a><a href="/tags/mysql.html" class="tag">mysql</a><a href="/tags/postgres.html" class="tag">postgres</a><a href="/tags/databases.html" class="tag">databases</a></div>
            </div>
	  </div>
	</div>
      </div>
    </header>
    <div class="container">
      <div class="col-6">
        <p><!-- -*- mode: markdown -*- --></p>
<p>I <a href="https://eatonphil.com/2024-01-wehack-mysql.html">spent a week</a>
looking at MySQL/MariaDB internals along with ~80 other devs. Although
MySQL and MariaDB are mostly the same (more on that later), I focused
on MariaDB specifically this week.</p>
<p>Before last week I had never built MySQL/MariaDB before. The first day
of this hack week, I got MariaDB building locally and <a href="https://twitter.com/eatonphil/status/1742649922791395501">made a code
tweak</a> so
that <code>SELECT 23</code> returned <code>213</code>, and <a href="https://twitter.com/eatonphil/status/1742654868085526896">another
tweak</a> so
that <code>SELECT 80 + 20</code> returned <code>60</code>. The second day I got a <a href="https://twitter.com/eatonphil/status/1742958892957446490">basic UDF
in C</a>
working so that <code>SELECT mysum(20, 30)</code> returned <code>50</code>.</p>
<p>The rest of the week I spent figuring out how to build a minimal
in-memory storage engine, which I'll walk through in this post. 218 lines
of C++.</p>
<p>It supports <code>CREATE</code>, <code>DROP</code>, <code>INSERT</code>,
and <code>SELECT</code> for tables that only have <code>INTEGER</code> fields. It is
explicitly not thread-safe because I didn't have time to understand
MariaDB's lock primitives.</p>
<p>In this post I'll also talk about how the MariaDB custom storage API
compares to the Postgres one, based on <a href="https://notes.eatonphil.com/2023-11-01-postgres-table-access-methods.html">a previous hack week project I
did</a>.</p>
<p>All code for this post can be found in <a href="https://github.com/eatonphil/mariadb/tree/11.4/storage/memem">my fork on
GitHub</a>.</p>
<h3 id="mysql-and-mariadb">MySQL and MariaDB</h3><p>Before we go further though, why do I keep saying MySQL/MariaDB?</p>
<p>MySQL is GPL licensed (let's completely ignore the commercial
variations of MySQL that Oracle offers). The code is
open-source. However, the development is done behind closed
doors. There is a code dump <a href="https://github.com/mysql/mysql-server/commits/trunk/">every
month</a> or so.</p>
<p>MariaDB is a fork of MySQL by the creator of MySQL (who is no longer
involved, as it happens). It is also GPL licensed (let's completely
ignore the commercial variations of MariaDB that MariaDB Corporation
offers). The code is open-source. The development is also open-source.</p>
<p>When you install "MySQL" in your Linux distro you are <a href="https://mariadb.com/newsroom/press-releases/mariadb-replaces-mysql-as-the-default-in-debian-9/">often
actually</a>
installing MariaDB.</p>
<p>The two are mostly compatible. During this week, I <a href="https://twitter.com/eatonphil/status/1742642758408405237">stumbled
onto</a> that
they evolved support for <code>SELECT .. FROM VALUES ..</code> differently. Some
differences are documented on <a href="https://mariadb.com/kb/en/moving-from-mysql/">the MariaDB
KB</a>. But this KB is
painful to browse. Which leads me to my next point.</p>
<p>The <a href="https://dev.mysql.com/doc/">MySQL docs</a> are excellent. Easy to
read, browse; and they are thorough. The <a href="https://mariadb.com/kb">MariaDB
docs</a> are a work in progress. I'm sorry I
can't be stoic: in just a week I've come to really hate using this
KB. Thankfully, in some twisted way, it also doesn't seem to be very
thorough either. It isn't completely avoidable though since there is
no guarantee MySQL and MariaDB do the same thing.</p>
<p>Ultimately, I spent the week using MariaDB because I'm biased toward
fully open projects. But I kept having to look at MySQL docs, hoping
they were relevant.</p>
<p>Now that you understand the state of things, let's move on to fun
stuff!</p>
<h3 id="storage-engines">Storage engines</h3><p>Mature databases often support swapping out the storage layer. Maybe
you want an in-memory storage layer so that you can quickly run
integration tests. Maybe you want to switch between B-Trees
(read-optimized) and LSM Trees (write-optimized) and unordered heaps
(write-optimized) depending on your workload. Or maybe you just want
to try a third-party storage library
(e.g. <a href="https://rocksdb.org/">RocksDB</a> or <a href="https://sled.rs/">Sled</a> or
<a href="https://tikv.org/">TiKV</a>).</p>
<p>The benefit of swapping out only the storage engine is that, from a
user's perspective, the semantics and features of the database stay
mostly the same. But the database is magically faster for a workload.</p>
<p>You keep powerful user management, extension support, SQL support, and
a well-known wire protocol. You modify only the method of storing the
actual data.</p>
<h4 id="existing-storage-engines">Existing storage engines</h4><p>MySQL/MariaDB is particularly well known for its custom storage engine
support. The MySQL docs for <a href="https://dev.mysql.com/doc/refman/8.0/en/storage-engines.html">alternate storage
engines</a>
are great.</p>
<p>While the docs do warn that you should probably stick with the default
storage engine, that warning didn't quite feel strong enough because
nothing else seemed to indicate the state of other engines.</p>
<p>Specifically, in the past I was always interested in the CSV storage
engine. But when you look at the <a href="https://github.com/MariaDB/server/blob/11.4/storage/csv/ha_tina.cc">actual code for the CSV
engine</a>
there is a pretty strong warning:</p>
<div class="highlight"><pre><span></span>First off, this is a play thing for me, there are a number of things
wrong with it:
  *) It was designed for csv and therefore its performance is highly
     questionable.
  *) Indexes have not been implemented. This is because the files can
     be traded in and out of the table directory without having to worry
     about rebuilding anything.
  *) NULLs and &quot;&quot; are treated equally (like a spreadsheet).
  *) There was in the beginning no point to anyone seeing this other
     then me, so there is a good chance that I haven&#39;t quite documented
     it well.
  *) Less design, more &quot;make it work&quot;

Now there are a few cool things with it:
  *) Errors can result in corrupted data files.
  *) Data files can be read by spreadsheets directly.

TODO:
 *) Move to a block system for larger files
 *) Error recovery, its all there, just need to finish it
 *) Document how the chains work.

-Brian
</pre></div>
<p>The difference between the seeming confidence of the docs and seeming
confidence of the contributor made me chuckle.</p>
<p>The benefit of these diverse storage engines for me was that they give
examples of how to implement the storage engine API. The
<a href="https://github.com/MariaDB/server/blob/11.4/storage/csv">csv</a>,
<a href="https://github.com/MariaDB/server/tree/11.4/storage/blackhole">blackhole</a>,
<a href="https://github.com/MariaDB/server/tree/11.4/storage/example">example</a>,
and <a href="https://github.com/MariaDB/server/tree/11.4/storage/heap">heap</a>
storage engines were particularly helpful to read.</p>
<p>The heap engine is a complete in-memory storage engine. Complete means
complex though. So there seemed to be room for a stripped down version
of an in-memory engine.</p>
<p>And that's we'll cover in this post! First though I want to talk a
little bit about the limitations of custom storage engines.</p>
<h3 id="limitations">Limitations</h3><p>While being able to tailor a storage engine to a workload is powerful,
there are limits to the benefits based on the design of the storage
API.</p>
<p>Both Postgres and MySQL/MariaDB currently have a custom storage API
built around <em>individual rows</em>.</p>
<h4 id="column-wise-execution">Column-wise execution</h4><p>I have <a href="https://notes.eatonphil.com/2023-11-01-postgres-table-access-methods.html">previously
written</a>
that custom storage engines allows you to switch between column- and
row-oriented data storage. Two big reasons to do column-wise storage
are 1) opportunity for compression, and 2) fast operations on a single
column.</p>
<p>The opportunity for 1) compression <em>on disk</em> would still exist even if
you needed to deal with individual rows at the storage API layer since
the compression could happen on disk. However any benefits of passing
around compressed columns <em>in memory</em> disappear if you must convert to
rows for the storage API.</p>
<p>You'd also lose the advantage for 2) fast operations on a single
column if the column must be converted into a row at the storage API
whereupon it's passed to higher levels that perform execution. The
execution would happen row-wise, not column-wise.</p>
<p>All of this is to say that while column-wise storage is possible, the
<em>benefit of doing so</em> is not obvious with the current API design for
both MySQL/MariaDB and Postgres.</p>
<h4 id="vectorization">Vectorization</h4><p>An API built around individual rows also sets limits on the amount of
vectorization you can do. A custom storage engine could still do some
vectorization under the hood: always filling a buffer with N rows and
returning a row from the buffer when the storage API requests a single
row. But there is likely some degree of performance left on the table
with an API that deals with individual rows.</p>
<p>Remember though: if you did batched reads and writes of rows in the
custom storage layer, there isn't necessarily any vectorization
happening at the execution layer. From a <a href="https://notes.eatonphil.com/2023-09-21-how-do-databases-execute-expressions.html">previous
study</a>
I did, neither MySQL/MariaDB nor Postgres do vectorized query
execution. This paragraph isn't a critique of the storage API, it's
just something to keep in mind.</p>
<h4 id="storage-versus-execution">Storage versus execution</h4><p>The general point I'm making here is that unless both the execution
and storage APIs are designed in a certain way, you may attempt
optimizations in the storage layer that are ineffective or even
harmfull because the execution layer doesn't or can't take advantage
of them.</p>
<h4 id="nothing-permanent">Nothing permanent</h4><p>The current limitations of the storage API are not intrinsic aspects
of MySQL/MariaDB or Postgres's design. For both project there used to
be no pluggable storage at all. We can imagine a future patch to
either project that allows support for batched row reads and writes
that together could make column-wise storage and vectorized execution
more feasible.</p>
<p>Even today there have been invasive attempts to fully support
<a href="https://www.citusdata.com/blog/2021/03/06/citus-10-columnar-compression-for-postgres/">column-wise storage and
execution</a>
in Postgres. And there have also been projects to bring <a href="https://github.com/citusdata/postgres_vectorization_test">vectorized
execution to
Postgres</a>.</p>
<p>I'm not as familiar with the MySQL landscape to comment about efforts
at the moment their.</p>
<h3 id="debug-build-of-mariadb-running-locally">Debug build of MariaDB running locally</h3><p>Now that you've got some background, let's get a debug build of
MariaDB!</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/MariaDB/server<span class="w"> </span>mariadb
<span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>mariadb
<span class="gp">$ </span>mkdir<span class="w"> </span>build
<span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>build
<span class="gp">$ </span>cmake<span class="w"> </span>-DCMAKE_BUILD_TYPE<span class="o">=</span>Debug<span class="w"> </span>..
<span class="gp">$ </span>make<span class="w"> </span>-j8
</pre></div>
<p>This takes a while. When I was hacking on Postgres (a C project), it
took 1 minute on my beefy Linux server to build. It took 20-30 minutes
to build MySQL/MariaDB from scratch. That's C++ for you!</p>
<p>Thankfully incremental builds of MySQL/MariaDB for a tweak after the
initial build take roughly the same time as incremental builds of
Postgres after a tweak.</p>
<p>Once the build is done, create a database.</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>./build/scripts/mariadb-install-db<span class="w"> </span>--srcdir<span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="w"> </span>--datadir<span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/db
</pre></div>
<p>And create a config for the database.</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[client]</span>
<span class="go">socket=$(pwd)/mariadb.sock</span>

<span class="go">[mariadb]</span>
<span class="go">socket=$(pwd)/mariadb.sock</span>

<span class="go">basedir=$(pwd)</span>
<span class="go">datadir=$(pwd)/db</span>
<span class="go">pid-file=$(pwd)/db.pid&quot; &gt; my.cnf</span>
</pre></div>
<p>Start up the server.</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>./build/sql/mariadbd<span class="w"> </span>--defaults-extra-file<span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/my.cnf<span class="w"> </span>--debug:d:o,<span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/db.debug
<span class="go">./build/sql/mariadbd: Can&#39;t create file &#39;/var/log/mariadb/mariadb.log&#39; (errno: 13 &quot;Permission denied&quot;)</span>
<span class="go">2024-01-03 17:10:15 0 [Note] Starting MariaDB 11.4.0-MariaDB-debug source revision 3fad2b115569864d8c1b7ea90ce92aa895cfef08 as process 185550</span>
<span class="go">2024-01-03 17:10:15 0 [Note] InnoDB: !!!!!!!! UNIV_DEBUG switched on !!!!!!!!!</span>
<span class="go">2024-01-03 17:10:15 0 [Note] InnoDB: Compressed tables use zlib 1.2.13</span>
<span class="go">2024-01-03 17:10:15 0 [Note] InnoDB: Number of transaction pools: 1</span>
<span class="go">2024-01-03 17:10:15 0 [Note] InnoDB: Using crc32 + pclmulqdq instructions</span>
<span class="go">2024-01-03 17:10:15 0 [Note] InnoDB: Initializing buffer pool, total size = 128.000MiB, chunk size = 2.000MiB</span>
<span class="go">2024-01-03 17:10:15 0 [Note] InnoDB: Completed initialization of buffer pool</span>
<span class="go">2024-01-03 17:10:15 0 [Note] InnoDB: Buffered log writes (block size=512 bytes)</span>
<span class="go">2024-01-03 17:10:15 0 [Note] InnoDB: End of log at LSN=57155</span>
<span class="go">2024-01-03 17:10:15 0 [Note] InnoDB: Opened 3 undo tablespaces</span>
<span class="go">2024-01-03 17:10:15 0 [Note] InnoDB: 128 rollback segments in 3 undo tablespaces are active.</span>
<span class="go">2024-01-03 17:10:15 0 [Note] InnoDB: Setting file &#39;./ibtmp1&#39; size to 12.000MiB. Physically writing the file full; Please wait ...</span>
<span class="go">2024-01-03 17:10:15 0 [Note] InnoDB: File &#39;./ibtmp1&#39; size is now 12.000MiB.</span>
<span class="go">2024-01-03 17:10:15 0 [Note] InnoDB: log sequence number 57155; transaction id 16</span>
<span class="go">2024-01-03 17:10:15 0 [Note] InnoDB: Loading buffer pool(s) from ./db/ib_buffer_pool</span>
<span class="go">2024-01-03 17:10:15 0 [Note] Plugin &#39;FEEDBACK&#39; is disabled.</span>
<span class="go">2024-01-03 17:10:15 0 [Note] Plugin &#39;wsrep-provider&#39; is disabled.</span>
<span class="go">2024-01-03 17:10:15 0 [Note] InnoDB: Buffer pool(s) load completed at 240103 17:10:15</span>
<span class="go">2024-01-03 17:10:15 0 [Note] Server socket created on IP: &#39;0.0.0.0&#39;.</span>
<span class="go">2024-01-03 17:10:15 0 [Note] Server socket created on IP: &#39;::&#39;.</span>
<span class="go">2024-01-03 17:10:15 0 [Note] mariadbd: Event Scheduler: Loaded 0 events</span>
<span class="go">2024-01-03 17:10:15 0 [Note] ./build/sql/mariadbd: ready for connections.</span>
<span class="go">Version: &#39;11.4.0-MariaDB-debug&#39;  socket: &#39;./mariadb.sock&#39;  port: 3306  Source distribution</span>
</pre></div>
<p class="note">
  With that <code>--debug</code> flag, debug logs will show up in
  <code>$(pwd)/db.debug</code>. It's unclear why debug logs are
  treated separately from the console logs shown here. I'd rather them
  all be in one place.
</p><p>In another terminal, run a client and make a request!</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>./build/client/mariadb<span class="w"> </span>--defaults-extra-file<span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/my.cnf<span class="w"> </span>--database<span class="o">=</span><span class="nb">test</span>
<span class="go">Reading table information for completion of table and column names</span>
<span class="go">You can turn off this feature to get a quicker startup with -A</span>

<span class="go">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span>
<span class="go">Your MariaDB connection id is 3</span>
<span class="go">Server version: 11.4.0-MariaDB-debug Source distribution</span>

<span class="go">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span>

<span class="go">Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.</span>

<span class="go">MariaDB [test]&gt; SELECT 1;</span>
<span class="go">+---+</span>
<span class="go">| 1 |</span>
<span class="go">+---+</span>
<span class="go">| 1 |</span>
<span class="go">+---+</span>
<span class="go">1 row in set (0.001 sec)</span>
</pre></div>
<p>Huzzah! Let's write a custom storage engine!</p>
<h3 id="where-does-the-code-go?">Where does the code go?</h3><p>When writing an extension for some project, I usually expect to have
the extension exist in its own repo. I was able to do this with the
<a href="https://github.com/eatonphil/pgtam">Postgres in-memory storage engine I
wrote</a>. And in general, Postgres
extensions exist as their own repos.</p>
<p>I was able to create and build a UDF plugin outside the MariaDB source
tree. But when it came to getting a storage engine to build and load
successfully, I wasted almost an entire day (a large amount of time in
a single hack week) getting nowhere.</p>
<p>Extensions for MySQL/MariaDB are most easily built via the CMake
infrastructure within the repo. Surely there's <em>some</em> way to replicate
that infrastructure from outside the repo but I wasn't able to figure
it out within a day and didn't want to spend more time on it.</p>
<p>Apparently the <a href="https://twitter.com/kastauyra/status/1743346665442935174">normal thing to
do</a> in
MySQL/MariaDB is to keep extensions within a fork of MySQL/MariaDB.</p>
<p>When I switched to this method I was able to very quickly get the
storage engine building and loaded. So that's what we'll do.</p>
<h3 id="boilerplate">Boilerplate</h3><p>Within the MariaDB source tree, create a new folder in the <code>storage</code>
subdirectory.</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>mkdir<span class="w"> </span>storage/memem
</pre></div>
<p>Within <code>storage/memem/CMakeLists.txt</code> add the following.</p>
<div class="highlight"><pre><span></span><span class="c"># Copyright (c) 2006, 2010, Oracle and/or its affiliates. All rights reserved.</span>
<span class="c"># </span>
<span class="c"># This program is free software; you can redistribute it and/or modify</span>
<span class="c"># it under the terms of the GNU General Public License as published by</span>
<span class="c"># the Free Software Foundation; version 2 of the License.</span>
<span class="c"># </span>
<span class="c"># This program is distributed in the hope that it will be useful,</span>
<span class="c"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c"># GNU General Public License for more details.</span>
<span class="c"># </span>
<span class="c"># You should have received a copy of the GNU General Public License</span>
<span class="c"># along with this program; if not, write to the Free Software</span>
<span class="c"># Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1335 USA</span>

<span class="nb">SET</span><span class="p">(</span><span class="s">MEMEM_SOURCES</span><span class="w">  </span><span class="s">ha_memem.cc</span><span class="w"> </span><span class="s">ha_memem.h</span><span class="p">)</span>
<span class="nb">MYSQL_ADD_PLUGIN</span><span class="p">(</span><span class="s">memem</span><span class="w"> </span><span class="o">${</span><span class="nv">MEMEM_SOURCES</span><span class="o">}</span><span class="w"> </span><span class="s">STORAGE_ENGINE</span><span class="p">)</span>
</pre></div>
<p>This hooks into MySQL/MariaDB build infrastructure. So next time you
run <code>make</code> within the <code>build</code> directory we created above, it will also
build this project.</p>
<h3 id="the-storage-engine-class">The storage engine class</h3><p>It would be nice to see a way to extend MySQL in C (for one, because
it would then be easier to port to other languages). But all of the
builtin storage methods use classes. So we'll do that too.</p>
<p>The class we must implement is an instance of
<a href="https://github.com/MariaDB/server/blob/11.4/sql/handler.h#L3200"><code>handler</code></a>. There
is a single <code>handler</code> instance per thread, corresponding to a single
running query. (Postgres gives each query its own process, MySQL gives
each query its own thread.) However, <code>handler</code> instances are reused
across different queries.</p>
<p>There are a number of virtual methods on <code>handler</code> we must implement
in our subclass. For most of them we'll do nothing: simply returning
immediately. These simple methods will be implemented in
<code>ha_memem.h</code>. The methods with more complex logic will be implemented
in <code>ha_memem.cc</code>.</p>
<p>Let's set up includes in <code>ha_memem.h</code>.</p>
<div class="highlight"><pre><span></span><span class="cm">/* Copyright (c) 2005, 2010, Oracle and/or its affiliates. All rights reserved.</span>

<span class="cm">  This program is free software; you can redistribute it and/or modify</span>
<span class="cm">  it under the terms of the GNU General Public License as published by</span>
<span class="cm">  the Free Software Foundation; version 2 of the License.</span>

<span class="cm">  This program is distributed in the hope that it will be useful,</span>
<span class="cm">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">  GNU General Public License for more details.</span>

<span class="cm">  You should have received a copy of the GNU General Public License</span>
<span class="cm">  along with this program; if not, write to the Free Software</span>
<span class="cm">  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1335  USA */</span>

<span class="cp">#ifdef USE_PRAGMA_INTERFACE</span>
<span class="cp">#pragma interface </span><span class="cm">/* gcc class implementation */</span>
<span class="cp">#endif</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;thr_lock.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;handler.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;table.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;sql_const.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;memory&gt;</span>
</pre></div>
<p>Next we'll define structs for our in-memory storage.</p>
<div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="w"> </span><span class="n">MememRow</span><span class="p">;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">MememTable</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">MememRow</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">rows</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">MememDatabase</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">MememTable</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">tables</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
<p>Within <code>ha_memem.cc</code> we'll implement a global (not thread-safe)
<code>static MememDatabase*</code> that all <code>handler</code> instances will query when
requested. We need the definitions in the header file though because
we'll store the table currently being queried in the <code>handler</code>
subclass.</p>
<p>This is so that every call to <code>write_row</code> to write a single row or
call to <code>rnd_next</code> to read a single row does not need to look up the
in-memory table object N times within the same query.</p>
<p>And finally we'll define the subclass of <code>handler</code> and implementations
of trivial methods.</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ha_memem</span><span class="w"> </span><span class="k">final</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">handler</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">uint</span><span class="w"> </span><span class="n">current_position</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">MememTable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">memem_table</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="n">ha_memem</span><span class="p">(</span><span class="n">handlerton</span><span class="w"> </span><span class="o">*</span><span class="n">hton</span><span class="p">,</span><span class="w"> </span><span class="n">TABLE_SHARE</span><span class="w"> </span><span class="o">*</span><span class="n">table_arg</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">handler</span><span class="p">(</span><span class="n">hton</span><span class="p">,</span><span class="w"> </span><span class="n">table_arg</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="o">~</span><span class="n">ha_memem</span><span class="p">()</span><span class="o">=</span><span class="w"> </span><span class="k">default</span><span class="p">;</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="nf">index_type</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">key_number</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="n">ulonglong</span><span class="w"> </span><span class="nf">table_flags</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="n">ulong</span><span class="w"> </span><span class="nf">index_flags</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">inx</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">part</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">all_parts</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="cm">/* The following defines can be increased if necessary */</span>
<span class="cp">#define MEMEM_MAX_KEY MAX_KEY     </span><span class="cm">/* Max allowed keys */</span>
<span class="cp">#define MEMEM_MAX_KEY_SEG 16      </span><span class="cm">/* Max segments for key */</span>
<span class="cp">#define MEMEM_MAX_KEY_LENGTH 3500 </span><span class="cm">/* Like in InnoDB */</span>
<span class="w">  </span><span class="n">uint</span><span class="w"> </span><span class="nf">max_supported_keys</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">MEMEM_MAX_KEY</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="n">uint</span><span class="w"> </span><span class="nf">max_supported_key_length</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">MEMEM_MAX_KEY_LENGTH</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="n">uint</span><span class="w"> </span><span class="nf">max_supported_key_part_length</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">MEMEM_MAX_KEY_LENGTH</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">open</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">test_if_locked</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">truncate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">rnd_init</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">scan</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">rnd_next</span><span class="p">(</span><span class="n">uchar</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">rnd_pos</span><span class="p">(</span><span class="n">uchar</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">uchar</span><span class="w"> </span><span class="o">*</span><span class="n">pos</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">index_read_map</span><span class="p">(</span><span class="n">uchar</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">uchar</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">key_part_map</span><span class="w"> </span><span class="n">keypart_map</span><span class="p">,</span>
<span class="w">                     </span><span class="k">enum</span><span class="w"> </span><span class="nc">ha_rkey_function</span><span class="w"> </span><span class="n">find_flag</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">HA_ERR_END_OF_FILE</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">index_read_idx_map</span><span class="p">(</span><span class="n">uchar</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">uchar</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">,</span>
<span class="w">                         </span><span class="n">key_part_map</span><span class="w"> </span><span class="n">keypart_map</span><span class="p">,</span>
<span class="w">                         </span><span class="k">enum</span><span class="w"> </span><span class="nc">ha_rkey_function</span><span class="w"> </span><span class="n">find_flag</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">HA_ERR_END_OF_FILE</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">index_read_last_map</span><span class="p">(</span><span class="n">uchar</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">uchar</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">,</span>
<span class="w">                          </span><span class="n">key_part_map</span><span class="w"> </span><span class="n">keypart_map</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">HA_ERR_END_OF_FILE</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">index_next</span><span class="p">(</span><span class="n">uchar</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">HA_ERR_END_OF_FILE</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">index_prev</span><span class="p">(</span><span class="n">uchar</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">HA_ERR_END_OF_FILE</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">index_first</span><span class="p">(</span><span class="n">uchar</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">HA_ERR_END_OF_FILE</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">index_last</span><span class="p">(</span><span class="n">uchar</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">HA_ERR_END_OF_FILE</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">position</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">uchar</span><span class="w"> </span><span class="o">*</span><span class="n">record</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">info</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">flag</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">external_lock</span><span class="p">(</span><span class="n">THD</span><span class="w"> </span><span class="o">*</span><span class="n">thd</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">lock_type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">TABLE</span><span class="w"> </span><span class="o">*</span><span class="n">table_arg</span><span class="p">,</span><span class="w"> </span><span class="n">HA_CREATE_INFO</span><span class="w"> </span><span class="o">*</span><span class="n">create_info</span><span class="p">);</span>
<span class="w">  </span><span class="n">THR_LOCK_DATA</span><span class="w"> </span><span class="o">**</span><span class="nf">store_lock</span><span class="p">(</span><span class="n">THD</span><span class="w"> </span><span class="o">*</span><span class="n">thd</span><span class="p">,</span><span class="w"> </span><span class="n">THR_LOCK_DATA</span><span class="w"> </span><span class="o">**</span><span class="n">to</span><span class="p">,</span>
<span class="w">                             </span><span class="k">enum</span><span class="w"> </span><span class="nc">thr_lock_type</span><span class="w"> </span><span class="n">lock_type</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">to</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">delete_table</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">reset_memem_table</span><span class="p">();</span>
<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">write_row</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">uchar</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">update_row</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">uchar</span><span class="w"> </span><span class="o">*</span><span class="n">old_data</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">uchar</span><span class="w"> </span><span class="o">*</span><span class="n">new_data</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">HA_ERR_WRONG_COMMAND</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">delete_row</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">uchar</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">HA_ERR_WRONG_COMMAND</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="p">};</span>
</pre></div>
<p>A complete storage engine might seriously implement all of these
methods. But we'll only seriously implement 7 of them.</p>
<p>To finish up the boilerplate, we'll switch over to <code>ha_memem.cc</code> and
set up the includes.</p>
<div class="highlight"><pre><span></span><span class="cm">/* Copyright (c) 2005, 2012, Oracle and/or its affiliates. All rights reserved.</span>

<span class="cm">  This program is free software; you can redistribute it and/or modify</span>
<span class="cm">  it under the terms of the GNU General Public License as published by</span>
<span class="cm">  the Free Software Foundation; version 2 of the License.</span>

<span class="cm">  This program is distributed in the hope that it will be useful,</span>
<span class="cm">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">  GNU General Public License for more details.</span>

<span class="cm">  You should have received a copy of the GNU General Public License</span>
<span class="cm">  along with this program; if not, write to the Free Software</span>
<span class="cm">  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1335  USA */</span>

<span class="cp">#ifdef USE_PRAGMA_IMPLEMENTATION</span>
<span class="cp">#pragma implementation </span><span class="c1">// gcc: Class implementation</span>
<span class="cp">#endif</span>

<span class="cp">#define MYSQL_SERVER 1</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;my_global.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;sql_priv.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;unireg.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;sql_class.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ha_memem.h&quot;</span>
</pre></div>
<p>Ok! Let's dig into the implementation.</p>
<h3 id="implementation">Implementation</h3><h4 id="the-global-database">The global database</h4><p>First up, we need to declare a global <code>MememDatabase*</code> instance. We'll
also implement a helper function for finding the index of a table by
name within the database.</p>
<div class="highlight"><pre><span></span><span class="c1">// WARNING! All accesses of `database` in this code are thread</span>
<span class="c1">// unsafe. Since this was written during a hack week, I didn&#39;t have</span>
<span class="c1">// time to figure out MySQL/MariaDB&#39;s runtime well enough to do the</span>
<span class="c1">// thread-safe version of this.</span>
<span class="k">static</span><span class="w"> </span><span class="n">MememDatabase</span><span class="w"> </span><span class="o">*</span><span class="n">database</span><span class="p">;</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">memem_table_index</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">database</span><span class="o">-&gt;</span><span class="n">tables</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">INT_MAX</span><span class="p">);</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="n">database</span><span class="o">-&gt;</span><span class="n">tables</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">database</span><span class="o">-&gt;</span><span class="n">tables</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p class="note">
  As I wrote this post I noticed that this code also assumes there's
  only a single database. That isn't how MySQL works. Everytime you
  call <code>USE ...</code> in MySQL you are switching between
  databases. You can query tables across databases. A real in-memory
  backend would need to be aware of the different databases, not just
  different tables. But to keep the code succinct we won't implement
  that in this post.
</p><p>Next we'll implement plugin initialization and cleanup.</p>
<h4 id="plugin-lifecycle">Plugin lifecycle</h4><p>Before we register the plugin with MariaDB, we need to set up
initialization and cleanup methods for it.</p>
<p>The initialization method will take care of initializing the global
<code>MememDatabase* database</code> object. It will set up a handler for
creating new instances of our <code>handler</code> subclass. And it will set up a
handler for deleting tables.</p>
<div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="o">*</span><span class="nf">memem_create_handler</span><span class="p">(</span><span class="n">handlerton</span><span class="w"> </span><span class="o">*</span><span class="n">hton</span><span class="p">,</span><span class="w"> </span><span class="n">TABLE_SHARE</span><span class="w"> </span><span class="o">*</span><span class="n">table</span><span class="p">,</span>
<span class="w">                                     </span><span class="n">MEM_ROOT</span><span class="w"> </span><span class="o">*</span><span class="n">mem_root</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="p">(</span><span class="n">mem_root</span><span class="p">)</span><span class="w"> </span><span class="n">ha_memem</span><span class="p">(</span><span class="n">hton</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">memem_init</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">handlerton</span><span class="w"> </span><span class="o">*</span><span class="n">memem_hton</span><span class="p">;</span>

<span class="w">  </span><span class="n">memem_hton</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">handlerton</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<span class="w">  </span><span class="n">memem_hton</span><span class="o">-&gt;</span><span class="n">db_type</span><span class="o">=</span><span class="w"> </span><span class="n">DB_TYPE_AUTOASSIGN</span><span class="p">;</span>
<span class="w">  </span><span class="n">memem_hton</span><span class="o">-&gt;</span><span class="n">create</span><span class="o">=</span><span class="w"> </span><span class="n">memem_create_handler</span><span class="p">;</span>
<span class="w">  </span><span class="n">memem_hton</span><span class="o">-&gt;</span><span class="n">drop_table</span><span class="o">=</span><span class="w"> </span><span class="p">[](</span><span class="n">handlerton</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="o">=</span><span class="w"> </span><span class="n">memem_table_index</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">HA_ERR_NO_SUCH_TABLE</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">database</span><span class="o">-&gt;</span><span class="n">tables</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">database</span><span class="o">-&gt;</span><span class="n">tables</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">index</span><span class="p">);</span>
<span class="w">    </span><span class="n">DBUG_PRINT</span><span class="p">(</span><span class="s">&quot;info&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;[MEMEM] Deleted table &#39;%s&#39;.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">));</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>
<span class="w">  </span><span class="n">memem_hton</span><span class="o">-&gt;</span><span class="n">flags</span><span class="o">=</span><span class="w"> </span><span class="n">HTON_CAN_RECREATE</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Initialize global in-memory database.</span>
<span class="w">  </span><span class="n">database</span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MememDatabase</span><span class="p">;</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p class="note">
  The <code>DBUG_PRINT</code> macro is a debug helper MySQL/MariaDB gives us. As
  noted above, the output is directed to a file specified by the
  <code>--debug</code> flag. Unfortunately I couldn't figure out how to flush the
  stream this macro writes to. It seemed like occasionally when there
  was a segfault logs I expected to be there weren't there. And the
  file would often contain what looked like partially written
  logs. Anyway, as long as there wasn't a segfault the debug file will
  eventually contain the <code>DBUG_PRINT</code> logs.
</p><p>The only thing the plugin cleanup function must do is delete the
global database.</p>
<div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">memem_fini</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">delete</span><span class="w"> </span><span class="n">database</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>Now we can register the plugin!</p>
<h4 id="plugin-registration">Plugin registration</h4><p>The <code>maria_declare_plugin</code> and <code>maria_declare_plugin_end</code> register the
plugin's metadata (name, version, etc.) and callbacks.</p>
<div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">st_mysql_storage_engine</span><span class="w"> </span><span class="n">memem_storage_engine</span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">MYSQL_HANDLERTON_INTERFACE_VERSION</span><span class="p">};</span>

<span class="n">maria_declare_plugin</span><span class="p">(</span><span class="n">memem</span><span class="p">){</span>
<span class="w">    </span><span class="n">MYSQL_STORAGE_ENGINE_PLUGIN</span><span class="p">,</span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">memem_storage_engine</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;MEMEM&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;MySQL AB&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;In-memory database.&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">PLUGIN_LICENSE_GPL</span><span class="p">,</span>
<span class="w">    </span><span class="n">memem_init</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Plugin Init */</span>
<span class="w">    </span><span class="n">memem_fini</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Plugin Deinit */</span>
<span class="w">    </span><span class="mh">0x0100</span><span class="w"> </span><span class="cm">/* 1.0 */</span><span class="p">,</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* status variables                */</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w">                          </span><span class="cm">/* system variables                */</span>
<span class="w">    </span><span class="s">&quot;1.0&quot;</span><span class="p">,</span><span class="w">                         </span><span class="cm">/* string version */</span>
<span class="w">    </span><span class="n">MariaDB_PLUGIN_MATURITY_STABLE</span><span class="w"> </span><span class="cm">/* maturity */</span>
<span class="p">}</span><span class="w"> </span><span class="n">maria_declare_plugin_end</span><span class="p">;</span>
</pre></div>
<p>That's it! Now we need to implement methods for writing rows, reading
rows, and creating a new table.</p>
<h4 id="create-table">Create table</h4><p>To create a table, we make sure one by this name doesn't already
exist, make sure it only has <code>INTEGER</code> fields, allocate memory for the
table, and append it to the global database.</p>
<div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">ha_memem::create</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">TABLE</span><span class="w"> </span><span class="o">*</span><span class="n">table_arg</span><span class="p">,</span>
<span class="w">                     </span><span class="n">HA_CREATE_INFO</span><span class="w"> </span><span class="o">*</span><span class="n">create_info</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">memem_table_index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// We only support INTEGER fields for now.</span>
<span class="w">  </span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">table_arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">table_arg</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">MYSQL_TYPE_LONG</span><span class="p">)</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">    </span><span class="n">DBUG_PRINT</span><span class="p">(</span><span class="s">&quot;info&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Unsupported field type.&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">    </span><span class="n">i</span><span class="o">++</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">t</span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">MememTable</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">  </span><span class="n">t</span><span class="o">-&gt;</span><span class="n">name</span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<span class="w">  </span><span class="n">database</span><span class="o">-&gt;</span><span class="n">tables</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
<span class="w">  </span><span class="n">DBUG_PRINT</span><span class="p">(</span><span class="s">&quot;info&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;[MEMEM] Created table &#39;%s&#39;.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">));</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>Not very complicated. Let's handle <code>INSERT</code>-ing rows next.</p>
<h4 id="insert-row">Insert row</h4><p>There is no method called when an <code>INSERT</code> starts. There is a <code>table</code>
field on the <code>handler</code> parent class that is updated though when a
<code>SELECT</code> or <code>INSERT</code> is going. So we can fetch the current table from
that field.</p>
<p>Since we have a slot for a <code>std::shared_ptr&lt;MememTable&gt; memem_table</code>
on the <code>ha_memem</code> class, we can check if it is <code>NULL</code> when we insert a
row. If it is, we look up the current table and set
<code>this-&gt;memem_table</code> to its <code>MememTable</code>.</p>
<p>But there's a bit more to it than just the table name. The <code>const
char* name</code> passed to the <code>create()</code> method above seems to be a sort
of fully qualified name for the table. By observation, when creating a
table <code>y</code> in a database <code>test</code>, the <code>const char* name</code> value is
<code>./test/y</code>. The <code>.</code> prefix probably means that the database is local,
but I'm not sure.</p>
<p>So we'll write a helper method that will reconstruct the fully
qualified table name before looking up that fully qualified table name
in the global database.</p>
<div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">ha_memem::reset_memem_table</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// Reset table cursor.</span>
<span class="w">  </span><span class="n">current_position</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">full_name</span><span class="o">=</span><span class="w"> </span><span class="s">&quot;./&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">.</span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                         </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">table_name</span><span class="p">.</span><span class="n">str</span><span class="p">);</span>
<span class="w">  </span><span class="n">DBUG_PRINT</span><span class="p">(</span><span class="s">&quot;info&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;[MEMEM] Resetting to &#39;%s&#39;.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">full_name</span><span class="p">.</span><span class="n">c_str</span><span class="p">()));</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">database</span><span class="o">-&gt;</span><span class="n">tables</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="o">=</span><span class="w"> </span><span class="n">memem_table_index</span><span class="p">(</span><span class="n">full_name</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="n">database</span><span class="o">-&gt;</span><span class="n">tables</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>

<span class="w">  </span><span class="n">memem_table</span><span class="o">=</span><span class="w"> </span><span class="n">database</span><span class="o">-&gt;</span><span class="n">tables</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
<p>Then we can use this within <code>write_row</code> to figure out the current
<code>MememTable</code> being queried.</p>
<p>But first, let's digress into how MySQL stores rows.</p>
<h4 id="the-mysql-row-api">The MySQL row API</h4><p>When you <a href="https://notes.eatonphil.com/2023-11-01-postgres-table-access-methods.html">write a Postgres custom storage
API</a>,
you are expected to basically read from or write to an array of
<code>Datum</code>.</p>
<p>Totally sensible.</p>
<p>In MySQL, you read from and write to an array of bytes. That's pretty
weird to me. Of course you can build your own higher level
serialization/deserialization on top of it. But it's just strange to
me everyone has to know this basically opaque API.</p>
<p>Certainly <a href="https://github.com/MariaDB/server/blob/11.4/sql/handler.h#L3152">it's documented</a>.</p>
<div class="highlight"><pre><span></span>The handler class is the interface for dynamically loadable
storage engines. Do not add ifdefs and take care when adding or
changing virtual functions to avoid vtable confusion

Functions in this class accept and return table columns data. Two data
representation formats are used:
1. TableRecordFormat - Used to pass [partial] table records to/from
   storage engine

2. KeyTupleFormat - used to pass index search tuples (aka &quot;keys&quot;) to
   storage engine. See opt_range.cc for description of this format.

TableRecordFormat
=================
[Warning: this description is work in progress and may be incomplete]
The table record is stored in a fixed-size buffer:

  record: null_bytes, column1_data, column2_data, ...

The offsets of the parts of the buffer are also fixed: every column has 
an offset to its column{i}_data, and if it is nullable it also has its own
bit in null_bytes.
</pre></div>
<p>In our implementation, we'll skip the support for <code>NULL</code> values. We'll
only support <code>INTEGER</code> fields. But we still need to be aware that the
first byte will be taken up. We'll also assume there won't be more
than one byte of a NULL bitmap.</p>
<p>It is this opaque byte array that we'll read from in <code>write_row(const uchar*
buf)</code> and write to in <code>read_row(uchar* buf)</code>.</p>
<h4 id="insert-row-(take-two)">Insert row (take two)</h4><p>To keep things simple we're going to store the row in <code>MememTable</code> the
same way MySQL passes it around.</p>
<div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">ha_memem::write_row</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">uchar</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">memem_table</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">reset_memem_table</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Assume there are no NULLs.</span>
<span class="w">  </span><span class="n">buf</span><span class="o">++</span><span class="p">;</span>

<span class="w">  </span><span class="n">uint</span><span class="w"> </span><span class="n">field_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="n">field_count</span><span class="p">])</span><span class="w"> </span><span class="n">field_count</span><span class="o">++</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Store the row in the same format MariaDB gives us.</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">row</span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;&gt;</span><span class="p">(</span>
<span class="w">      </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">field_count</span><span class="p">);</span>
<span class="w">  </span><span class="n">memem_table</span><span class="o">-&gt;</span><span class="n">rows</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">row</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>Which makes reading the row quite simple too!</p>
<h4 id="read-row">Read row</h4><p>The only slight difference between reading and writing a row is that
MySQL/MariaDB will tell us when the <code>SELECT</code> scan for a table starts.</p>
<p>We'll use that opportunity to reset the <code>current_row</code> cursor and reset
the <code>memem_table</code> field. Since, again, <code>handler</code> classes are only used
once per query but they are reused for queries running at other times.</p>
<div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">ha_memem::rnd_init</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">scan</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">reset_memem_table</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">ha_memem::rnd_next</span><span class="p">(</span><span class="n">uchar</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current_position</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">memem_table</span><span class="o">-&gt;</span><span class="n">rows</span><span class="p">.</span><span class="n">size</span><span class="p">())</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Reset the in-memory table to make logic errors more obvious.</span>
<span class="w">    </span><span class="n">memem_table</span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">HA_ERR_END_OF_FILE</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">current_position</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">memem_table</span><span class="o">-&gt;</span><span class="n">rows</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>

<span class="w">  </span><span class="n">uchar</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="o">=</span><span class="w"> </span><span class="n">buf</span><span class="p">;</span>
<span class="w">  </span><span class="o">*</span><span class="n">ptr</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="n">ptr</span><span class="o">++</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Rows internally are stored in the same format that MariaDB</span>
<span class="w">  </span><span class="c1">// wants. So we can just copy them over.</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">row</span><span class="o">=</span><span class="w"> </span><span class="n">memem_table</span><span class="o">-&gt;</span><span class="n">rows</span><span class="p">[</span><span class="n">current_position</span><span class="p">];</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">copy</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">row</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">ptr</span><span class="p">);</span>

<span class="w">  </span><span class="n">current_position</span><span class="o">++</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>And we're done!</p>
<h3 id="build-and-test">Build and test</h3><p>Go back into the <code>build</code> directory we created within the source tree
root and rerun <code>make -j8</code>.</p>
<p>Kill the server (you'll need to do something like <code>killall mariadbd</code>
since the server doesn't respond to Ctrl-c). And restart it.</p>
<p>For some reason this plugin doesn't need to be loaded. We can run
<code>SHOW PLUGINS;</code> in the MariaDB CLI and we'll see it.</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>./build/client/mariadb<span class="w"> </span>--defaults-extra-file<span class="o">=</span>/home/phil/vendor/mariadb/my.cnf<span class="w"> </span>--database<span class="o">=</span><span class="nb">test</span>
<span class="go">Reading table information for completion of table and column names</span>
<span class="go">You can turn off this feature to get a quicker startup with -A</span>

<span class="go">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span>
<span class="go">Your MariaDB connection id is 5</span>
<span class="go">Server version: 11.4.0-MariaDB-debug Source distribution</span>

<span class="go">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span>

<span class="go">Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.</span>

<span class="go">MariaDB [test]&gt; SHOW PLUGINS;</span>
<span class="go">+-------------------------------+----------+--------------------+-----------------+---------+</span>
<span class="go">| Name                          | Status   | Type               | Library         | License |</span>
<span class="go">+-------------------------------+----------+--------------------+-----------------+---------+</span>
<span class="go">| binlog                        | ACTIVE   | STORAGE ENGINE     | NULL            | GPL     |</span>
<span class="go">...</span>
<span class="go">| MEMEM                         | ACTIVE   | STORAGE ENGINE     | NULL            | GPL     |</span>
<span class="go">...</span>
<span class="go">| BLACKHOLE                     | ACTIVE   | STORAGE ENGINE     | ha_blackhole.so | GPL     |</span>
<span class="go">+-------------------------------+----------+--------------------+-----------------+---------+</span>
<span class="go">73 rows in set (0.012 sec)</span>
</pre></div>
<p>There we go! To create a table with it we need to set <code>ENGINE =
MEMEM</code>. For example, <code>CREATE TABLE x (i INT) ENGINE = MEMEM</code>.</p>
<p>Let's create a script to try out the <code>memem</code> engine, in
<code>storage/memem/test.sql</code>.</p>
<div class="highlight"><pre><span></span><span class="k">drop</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="k">drop</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>

<span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">y</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="nb">int</span><span class="p">)</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MEMEM</span><span class="p">;</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1029</span><span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="mi">92</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>

<span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">z</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="nb">int</span><span class="p">)</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MEMEM</span><span class="p">;</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="mi">322</span><span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span>
</pre></div>
<p>And run it.</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>./build/client/mariadb<span class="w"> </span>--defaults-extra-file<span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/my.cnf<span class="w"> </span>--database<span class="o">=</span><span class="nb">test</span><span class="w"> </span>--table<span class="w"> </span>--verbose<span class="w"> </span>&lt;<span class="w"> </span>storage/memem/test.sql
<span class="go">--------------</span>
<span class="go">drop table if exists y</span>
<span class="go">--------------</span>

<span class="go">--------------</span>
<span class="go">drop table if exists z</span>
<span class="go">--------------</span>

<span class="go">--------------</span>
<span class="go">create table y(i int, j int) engine = MEMEM</span>
<span class="go">--------------</span>

<span class="go">--------------</span>
<span class="go">insert into y values (2, 1029)</span>
<span class="go">--------------</span>

<span class="go">--------------</span>
<span class="go">insert into y values (92, 8)</span>
<span class="go">--------------</span>

<span class="go">--------------</span>
<span class="go">select * from y where i + 8 = 10</span>
<span class="go">--------------</span>

<span class="go">+------+------+</span>
<span class="go">| i    | j    |</span>
<span class="go">+------+------+</span>
<span class="go">|    2 | 1029 |</span>
<span class="go">+------+------+</span>
<span class="go">--------------</span>
<span class="go">create table z(a int) engine = MEMEM</span>
<span class="go">--------------</span>

<span class="go">--------------</span>
<span class="go">insert into z values (322)</span>
<span class="go">--------------</span>

<span class="go">--------------</span>
<span class="go">insert into z values (8)</span>
<span class="go">--------------</span>

<span class="go">--------------</span>
<span class="go">select * from z where a &gt; 20</span>
<span class="go">--------------</span>

<span class="go">+------+</span>
<span class="go">| a    |</span>
<span class="go">+------+</span>
<span class="go">|  322 |</span>
<span class="go">+------+</span>
</pre></div>
<p>What you see there is the power of storage engines! It supports the
full SQL language even while we implemented storage somewhere
completely different than the default.</p>
<h3 id="in-memory-is-boring">In-memory is boring</h3><p>Certainly, I'm getting bored doing the same project over and over
again on different databases. However, it's minimal projects like this
that make it super easy to then go and port the storage engine to
something else.</p>
<p>The goal here is to be minimal but meaningful. And I've accomplished
that for myself at least!</p>
<h3 id="on-chatgpt">On ChatGPT</h3><p>As I've <a href="https://notes.eatonphil.com/2023-11-19-exploring-a-postgres-query-plan.html#postscript:-on-chatgpt">written
before</a>,
this sort of exploration wouldn't be possible within the time frame I
gave myself if it weren't for ChatGPT. Specifically, the paid tier
GPT4.</p>
<p>Neither the MySQL nor the MariaDB docs were so helpful that I could
immediately figure out things like how to get the current table name
within a scan (the <code>table</code> member of the <code>handler</code> class).</p>
<p>With ChatGPT you can ask questions like: "In a MySQL C++ plugin, how
do I get the name of the table from a <code>handler</code> class as a C
string?". Sometimes it's right and sometime's it's not. But you can
try out the code and if it builds it is at least somewhat correct!</p>
<p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">Wrote a post walking you through building a super minimal in-memory storage engine for MySQL/MariaDB in 218 lines of C++.<br><br>And took time again to reflect on the limitations of custom storage engines and how MySQL compares to Postgres internally here.<a href="https://t.co/nImUC36DPs">https://t.co/nImUC36DPs</a> <a href="https://t.co/1Oj2Lcua8O">pic.twitter.com/1Oj2Lcua8O</a></p>&mdash; Phil Eaton (@eatonphil) <a href="https://twitter.com/eatonphil/status/1744822526088282587?ref_src=twsrc%5Etfw">January 9, 2024</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<style>.feedback{display:initial;}</style>
	<div class="feedback">
	  <h4>Feedback</h4>
	  <p>As always,
	      please <a href="mailto:phil@eatonphil.com">email</a>
	      or <a href="https://twitter.com/eatonphil">tweet me</a>
	      with questions, corrections, or ideas!</p>

	</div>
      </div>
    </div>
    <footer>
      <div class="container">
	<div>
	  <div class="row">
	    <div class="feedback">
	      <h4>Frequent Topics</h4>
	      <div class="tags"><a href="/tags/javascript.html" class="tag">javascript (24)</a><a href="/tags/go.html" class="tag">go (24)</a><a href="/tags/databases.html" class="tag">databases (24)</a><a href="/tags/parsing.html" class="tag">parsing (21)</a><a href="/tags/postgres.html" class="tag">postgres (18)</a><a href="/tags/compilers.html" class="tag">compilers (14)</a><a href="/tags/sql.html" class="tag">sql (11)</a><a href="/tags/interpreters.html" class="tag">interpreters (11)</a><a href="/tags/zig.html" class="tag">zig (9)</a><a href="/tags/lisp.html" class="tag">lisp (9)</a><a href="/tags/books.html" class="tag">books (9)</a><a href="/tags/python.html" class="tag">python (8)</a><a href="/tags/linux.html" class="tag">linux (7)</a><a href="/tags/learning.html" class="tag">learning (7)</a><a href="/tags/json.html" class="tag">json (7)</a><a href="/tags/x86-amd64.html" class="tag">x86/amd64 (6)</a><a href="/tags/scheme.html" class="tag">scheme (6)</a><a href="/tags/c.html" class="tag">c (6)</a><a href="/tags/typescript.html" class="tag">typescript (5)</a><a href="/tags/mysql.html" class="tag">mysql (5)</a></div>
	    </div>
	  </div>
	  <div class="row" id="subscribe">
	    <style type="text/css">
  /* LOADER */
  .ml-form-embedSubmitLoad {
      display: inline-block;
      width: 20px;
      height: 20px;
  }
  .g-recaptcha {
      transform: scale(1);
      -webkit-transform: scale(1);
      transform-origin: 0 0;
      -webkit-transform-origin: 0 0;
      height: ;
  }
  .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      border: 0;
  }
  .ml-form-embedSubmitLoad:after {
      content: " ";
      display: block;
      width: 11px;
      height: 11px;
      margin: 1px;
      border-radius: 50%;
      border: 4px solid #fff;
      border-color: #ffffff #ffffff #ffffff transparent;
      animation: ml-form-embedSubmitLoad 1.2s linear infinite;
  }
  @keyframes ml-form-embedSubmitLoad {
      0% {
          transform: rotate(0deg);
      }
      100% {
          transform: rotate(360deg);
      }
  }
  #mlb2-3175296.ml-form-embedContainer {
      box-sizing: border-box;
      display: table;
      margin: 0 auto;
      position: static;
      width: 100% !important;
  }
  #mlb2-3175296.ml-form-embedContainer h3,
  #mlb2-3175296.ml-form-embedContainer p,
  #mlb2-3175296.ml-form-embedContainer span,
  #mlb2-3175296.ml-form-embedContainer button {
      text-transform: none !important;
      letter-spacing: normal !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper {
      border-width: 0px;
      border-color: transparent;
  border-radius: 4px;
  border-style: solid;
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  position: relative;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-align-left { text-align: left; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-align-center {
  text-align: center;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-align-default { display: table-cell !important; vertical-align: middle !important; text-align: center !important; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-align-right { text-align: right; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedHeader img {
  border-top-left-radius: 4px;
  border-top-right-radius: 4px;
  height: auto;
  margin: 0 auto !important;
  max-width: 100%;
  width: undefinedpx;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody.ml-form-embedBodyHorizontal {
  padding-bottom: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent {
  text-align: left;
  margin: 0 0 20px 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent p,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent p {
  color: #000000;
  font-size: 14px;
  font-weight: 400;
  line-height: 20px;
  margin: 0 0 10px 0;
  text-align: left;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent ul,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent ol,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent ul,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent ol {
  color: #000000;
  font-size: 14px;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent ol ol,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent ol ol {
  list-style-type: lower-alpha;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent ol ol ol,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent ol ol ol {
  list-style-type: lower-roman;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent p a,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent p a {
  color: #000000;
  text-decoration: underline;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-block-form .ml-field-group {
  text-align: left!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-block-form .ml-field-group label {
  margin-bottom: 5px;
  color: #333333;
  font-size: 14px;
  font-weight: bold; font-style: normal; text-decoration: none;;
  display: inline-block;
  line-height: 20px;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent p:last-child,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent p:last-child {
  margin: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody form {
  margin: 0;
  width: 100%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-formContent,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow {
  margin: 0 0 20px 0;
  width: 100%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow {
  float: left;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-formContent.horozintalForm {
  margin: 0;
  padding: 0 0 20px 0;
  width: 100%;
  height: auto;
  float: left;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow {
  margin: 0 0 10px 0;
  width: 100%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow.ml-last-item {
  margin: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow.ml-formfieldHorizintal {
  margin: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input {
  background-color: #ffffff !important;
  color: #333333 !important;
  border-color: #cccccc;
  border-radius: 4px !important;
  border-style: solid !important;
  border-width: 1px !important;
  font-size: 14px !important;
  height: auto;
  line-height: 21px !important;
  margin-bottom: 0;
  margin-top: 0;
  margin-left: 0;
  margin-right: 0;
  padding: 10px 10px !important;
  width: 100% !important;
  box-sizing: border-box !important;
  max-width: 100% !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input::-webkit-input-placeholder,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input::-webkit-input-placeholder { color: #333333; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input::-moz-placeholder,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input::-moz-placeholder { color: #333333; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input:-ms-input-placeholder,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input:-ms-input-placeholder { color: #333333; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input:-moz-placeholder,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input:-moz-placeholder { color: #333333; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow textarea, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow textarea {
  background-color: #ffffff !important;
  color: #333333 !important;
  border-color: #cccccc;
  border-radius: 4px !important;
  border-style: solid !important;
  border-width: 1px !important;
  font-size: 14px !important;
  height: auto;
  line-height: 21px !important;
  margin-bottom: 0;
  margin-top: 0;
  padding: 10px 10px !important;
  width: 100% !important;
  box-sizing: border-box !important;
  max-width: 100% !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before {
  border-color: #cccccc!important;
  background-color: #ffffff!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input.custom-control-input[type="checkbox"]{
  box-sizing: border-box;
  padding: 0;
  position: absolute;
  z-index: -1;
  opacity: 0;
  margin-top: 5px;
  margin-left: -1.5rem;
  overflow: visible;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before {
  border-radius: 4px!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow input[type=checkbox]:checked~.label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox input[type=checkbox]:checked~.label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-input:checked~.custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-input:checked~.custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox input[type=checkbox]:checked~.label-description::after {
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23fff' d='M6.564.75l-3.59 3.612-1.538-1.55L0 4.26 2.974 7.25 8 2.193z'/%3e%3c/svg%3e");
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-input:checked~.custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-input:checked~.custom-control-label::after {
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e");
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-input:checked~.custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-input:checked~.custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-input:checked~.custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-input:checked~.custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox input[type=checkbox]:checked~.label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox input[type=checkbox]:checked~.label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow input[type=checkbox]:checked~.label-description::before  {
  border-color: #000000!important;
  background-color: #000000!important;
  color: #ffffff!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label::after {
  top: 2px;
  box-sizing: border-box;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::after {
  top: 0px!important;
  box-sizing: border-box!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::after {
  top: 0px!important;
  box-sizing: border-box!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::after {
  top: 0px!important;
  box-sizing: border-box!important;
  position: absolute;
  left: -1.5rem;
  display: block;
  width: 1rem;
  height: 1rem;
  content: "";
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::before {
  top: 0px!important;
  box-sizing: border-box!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .custom-control-label::before {
  position: absolute;
  top: 4px;
  left: -1.5rem;
  display: block;
  width: 16px;
  height: 16px;
  pointer-events: none;
  content: "";
  background-color: #ffffff;
  border: #adb5bd solid 1px;
  border-radius: 50%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .custom-control-label::after {
  position: absolute;
  top: 2px!important;
  left: -1.5rem;
  display: block;
  width: 1rem;
  height: 1rem;
  content: "";
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before {
  position: absolute;
  top: 4px;
  left: -1.5rem;
  display: block;
  width: 16px;
  height: 16px;
  pointer-events: none;
  content: "";
  background-color: #ffffff;
  border: #adb5bd solid 1px;
  border-radius: 50%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::after {
  position: absolute;
  top: 0px!important;
  left: -1.5rem;
  display: block;
  width: 1rem;
  height: 1rem;
  content: "";
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::after {
  position: absolute;
  top: 0px!important;
  left: -1.5rem;
  display: block;
  width: 1rem;
  height: 1rem;
  content: "";
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .custom-radio .custom-control-label::after {
  background: no-repeat 50%/50% 50%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .custom-checkbox .custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::after {
  background: no-repeat 50%/50% 50%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-control, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-control {
  position: relative;
  display: block;
  min-height: 1.5rem;
  padding-left: 1.5rem;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-input, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-input, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-input, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-input {
  position: absolute;
  z-index: -1;
  opacity: 0;
  box-sizing: border-box;
  padding: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-label, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-label, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label {
  color: #000000;
  font-size: 12px!important;
  line-height: 22px;
  margin-bottom: 0;
  position: relative;
  vertical-align: top;
  font-style: normal;
  font-weight: 700;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-select, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-select {
  background-color: #ffffff !important;
  color: #333333 !important;
  border-color: #cccccc;
  border-radius: 4px !important;
  border-style: solid !important;
  border-width: 1px !important;
  font-size: 14px !important;
  line-height: 20px !important;
  margin-bottom: 0;
  margin-top: 0;
  padding: 10px 28px 10px 12px !important;
  width: 100% !important;
  box-sizing: border-box !important;
  max-width: 100% !important;
  height: auto;
  display: inline-block;
  vertical-align: middle;
  background: url('https://assets.mlcdn.com/ml/images/default/dropdown.svg') no-repeat right .75rem center/8px 10px;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow {
  height: auto;
  width: 100%;
  float: left;
  }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-input-horizontal { width: 70%; float: left; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-button-horizontal { width: 30%; float: left; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-button-horizontal.labelsOn { padding-top: 25px;  }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .horizontal-fields { box-sizing: border-box; float: left; padding-right: 10px;  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input {
  background-color: #ffffff;
  color: #333333;
  border-color: #cccccc;
  border-radius: 4px;
  border-style: solid;
  border-width: 1px;
  font-size: 14px;
  line-height: 20px;
  margin-bottom: 0;
  margin-top: 0;
  padding: 10px 10px;
  width: 100%;
  box-sizing: border-box;
  overflow-y: initial;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow button {
  background-color: #000000 !important;
  border-color: #000000;
  border-style: solid;
  border-width: 1px;
  border-radius: 4px;
  box-shadow: none;
  color: #ffffff !important;
  cursor: pointer;
  font-size: 14px !important;
  font-weight: 700;
  line-height: 20px;
  margin: 0 !important;
  padding: 10px !important;
  width: 100%;
  height: auto;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow button:hover {
  background-color: #333333 !important;
  border-color: #333333 !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow input[type="checkbox"] {
  box-sizing: border-box;
  padding: 0;
  position: absolute;
  z-index: -1;
  opacity: 0;
  margin-top: 5px;
  margin-left: -1.5rem;
  overflow: visible;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description {
  color: #000000;
  display: block;
  font-size: 12px;
  text-align: left;
  margin-bottom: 0;
  position: relative;
  vertical-align: top;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow label {
  font-weight: normal;
  margin: 0;
  padding: 0;
  position: relative;
  display: block;
  min-height: 24px;
  padding-left: 24px;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow label a {
  color: #000000;
  text-decoration: underline;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow label p {
  color: #000000 !important;
  font-size: 12px !important;
  font-weight: normal !important;
  line-height: 18px !important;
  padding: 0 !important;
  margin: 0 5px 0 0 !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow label p:last-child {
  margin: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedSubmit {
  margin: 0 0 20px 0;
  float: left;
  width: 100%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedSubmit button {
  background-color: #000000 !important;
  border: none !important;
  border-radius: 4px !important;
  box-shadow: none !important;
  color: #ffffff !important;
  cursor: pointer;
  font-size: 14px !important;
  font-weight: 700 !important;
  line-height: 21px !important;
  height: auto;
  padding: 10px !important;
  width: 100% !important;
  box-sizing: border-box !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedSubmit button.loading {
  display: none;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedSubmit button:hover {
  background-color: #333333 !important;
  }
  .ml-subscribe-close {
  width: 30px;
  height: 30px;
  background: url('https://assets.mlcdn.com/ml/images/default/modal_close.png') no-repeat;
  background-size: 30px;
  cursor: pointer;
  margin-top: -10px;
  margin-right: -10px;
  position: absolute;
  top: 0;
  right: 0;
  }
  .ml-error input, .ml-error textarea, .ml-error select {
  border-color: red!important;
  }
  .ml-error .custom-checkbox-radio-list {
  border: 1px solid red !important;
  border-radius: 4px;
  padding: 10px;
  }
  .ml-error .label-description,
  .ml-error .label-description p,
  .ml-error .label-description p a,
  .ml-error label:first-child {
  color: #ff0000 !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow.ml-error .label-description p,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow.ml-error .label-description p:first-letter {
  color: #ff0000 !important;
  }
  @media only screen and (max-width: 400px){
  .ml-form-embedWrapper.embedDefault, .ml-form-embedWrapper.embedPopup { width: 100%!important; }
  .ml-form-formContent.horozintalForm { float: left!important; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow { height: auto!important; width: 100%!important; float: left!important; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-input-horizontal { width: 100%!important; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-input-horizontal > div { padding-right: 0px!important; padding-bottom: 10px; }
    .ml-form-formContent.horozintalForm .ml-button-horizontal { width: 100%!important; }
    .ml-form-formContent.horozintalForm .ml-button-horizontal.labelsOn { padding-top: 0px!important; }
    }
</style>
<div id="mlb2-3175296" class="ml-form-embedContainer ml-subscribe-form ml-subscribe-form-3175296">
  <hr />
  <div class="ml-form-align-center ">
    <div class="ml-form-embedWrapper embedForm">
      <div class="ml-form-embedBody ml-form-embedBodyDefault row-form">
        <div class="ml-form-embedContent" style=" ">
          <h4>Subscribe</h4>
          <p>Enter your email if you'd like to be kept in the loop about future articles!<br><br>You can expect 2 to 4 messages per month depending on how motivated I'm feeling. :)</p>
	  <p></p>
	  <p>Cheers,<br>Phil</p>
        </div>
        <form class="ml-block-form" action="https://assets.mailerlite.com/jsonp/303114/forms/78235486326359572/subscribe" data-code="" method="post" target="_blank">
          <div class="ml-form-formContent">
            <div class="ml-form-fieldRow ml-last-item">
              <div class="ml-field-group ml-field-email ml-validate-email ml-validate-required">
                <!-- input -->
                <input aria-label="email" aria-required="true" type="email" class="form-control" data-inputmask="" name="fields[email]" placeholder="Email" autocomplete="email">
                <!-- /input -->
                <!-- textarea -->
                <!-- /textarea -->
                <!-- select -->
                <!-- /select -->
                <!-- checkboxes -->
		<!-- /checkboxes -->
                <!-- radio -->
                <!-- /radio -->
                <!-- countries -->
                <!-- /countries -->
              </div>
            </div>
          </div>
          <!-- Privacy policy -->
          <!-- /Privacy policy -->
	  <div class="ml-form-recaptcha ml-validate-required" style="float: left;">
            <style type="text/css">
	      .ml-form-recaptcha {
		  margin-bottom: 20px;
	      }
	      .ml-form-recaptcha.ml-error iframe {
		  border: solid 1px #ff0000;
	      }
	      @media screen and (max-width: 480px) {
		  .ml-form-recaptcha {
		      width: 220px!important
		  }
		  .g-recaptcha {
		      transform: scale(0.78);
		      -webkit-transform: scale(0.78);
		      transform-origin: 0 0;
		      -webkit-transform-origin: 0 0;
		  }
	      }
	    </style>
	    <script src="https://www.google.com/recaptcha/api.js"></script>
	    <div class="g-recaptcha" data-sitekey="6Lf1KHQUAAAAAFNKEX1hdSWCS3mRMv4FlFaNslaD"></div>
	  </div>
          <input type="hidden" name="ml-submit" value="1">
          <div class="ml-form-embedSubmit">
            <button type="submit" class="primary">Subscribe</button>
            <button disabled="disabled" style="display: none;" type="button" class="loading">
              <div class="ml-form-embedSubmitLoad"></div>
              <span class="sr-only">Loading...</span>
            </button>
          </div>
          <input type="hidden" name="anticsrf" value="true">
        </form>
      </div>
      <div class="ml-form-successBody row-success" style="display: none">
        <div class="ml-form-successContent">
          <h3>Thanks :)</h3>
          <p>You're in.</p>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  function ml_webform_success_3175296() {
      var $ = ml_jQuery || jQuery;
      $('.ml-subscribe-form-3175296 .row-success').show();
      $('.ml-subscribe-form-3175296 .row-form').hide();
  }
</script>
<script src="https://groot.mailerlite.com/js/w/webforms.min.js?v300817f630ad0e957914d0b28a2b6d78" type="text/javascript"></script>

	  </div>
	  <div class="row" style="margin-bottom: 25px">
	    <p>
	      Having trouble subscribing?&nbsp;<a href="mailto:phil@eatonphil.com">Let me know</a>.
	    </p>
	  </div>
	</div>
      </div>
    </footer>
    <script async onload="loadGA()" src="https://www.googletagmanager.com/gtag/js?id=UA-58109156-2"></script>
    <script>
      function loadGA() {
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());
	  gtag('config', 'UA-58109156-2');
      }
    </script>
    <script defer src="https://cdn.usefathom.com/script.js" data-site="CEPUOLOQ"></script>
  </body>
</html>
