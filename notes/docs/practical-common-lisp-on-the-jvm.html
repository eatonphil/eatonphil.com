<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="canonical" href="https://notes.eatonphil.com/practical-common-lisp-on-the-jvm.html">
    <title>Practical? Common Lisp on the JVM: A quick intro to ABCL for modern web apps | notes.eatonphil.com</title>
    <meta name="description" content="Practical? Common Lisp on the JVM: A quick intro to ABCL for modern web apps" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" href="/rss.xml" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono">
  </head>
  <body>
    <header>
      <div class="lfw">
	<div class="container">
	  <div class="row">
	    <a href="https://eatonphil.com/2025-holiday-fundraiser.html">2025 holiday fundraiser</a>
	  </div>
	</div>
      </div>
      <div class="container">
        <div>
          <div class="row">
	    <div>
	      <a href="https://eatonphil.com" class="sm-link">
		Home
              </a>
	      <a href="/" class="sm-link">
		Blog
              </a>
	      <a href="/rss.xml" class="sm-link">
		RSS
              </a>
	    </div>

	    <div class="subscribe">
	      <!-- <a href="https://eatonphil.com/hire-me.html">Hire me</a> -->
	      <!--
		  Hardcode link to home page because some pages don't
		  have a subscribe box. Some pages hide the subscribe.
		-->
	      <a href="https://eatonphil.com/subscribe.html">
		Subscribe
	      </a>
            </div>
	  </div>
	  <hr />
	  <div class="">
            <h2>August 5, 2021</h2>
            <h1>Practical? Common Lisp on the JVM: A quick intro to ABCL for modern web apps</h1>
	    
            <div class="row" style="padding-bottom: 5px">
              <div class="tags"><a href="/tags/common-lisp.html" class="tag">common lisp</a><a href="/tags/lisp.html" class="tag">lisp</a><a href="/tags/armed-bear-common-lisp.html" class="tag">armed bear common lisp</a><a href="/tags/java.html" class="tag">java</a><a href="/tags/jvm.html" class="tag">jvm</a></div>
            </div>
	  </div>
	</div>
      </div>
    </header>
    <div class="container">
      <div class="col-6">
	<div class="post">
          <p>In a ridiculous attempt to <a href="https://news.ycombinator.com/item?id=28036679">prove an internet
wrong</a> about the
practicality of Lisp (Common Lisp specifically), I tried to get a
simple (but realistic) web app running. After four days and <a href="https://github.com/armedbear/abcl/pull/379">a patch
to ABCL</a> I got something
working.</p>
<p>The code I had in mind would look something like this:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nv">port</span><span class="w"> </span><span class="mi">8080</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="nv">server</span><span class="w"> </span><span class="p">(</span><span class="nv">make-server</span><span class="w"> </span><span class="nv">port</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="nv">route</span><span class="w"> </span><span class="nv">server</span><span class="w"> </span><span class="s">&quot;GET&quot;</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nv">ctx</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;My index!&quot;</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nv">route</span><span class="w"> </span><span class="nv">server</span><span class="w"> </span><span class="s">&quot;GET&quot;</span><span class="w"> </span><span class="s">&quot;/search&quot;</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nv">ctx</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nv">template</span><span class="w"> </span><span class="s">&quot;search.tmpl&quot;</span><span class="w"> </span><span class="o">&#39;</span><span class="p">((</span><span class="s">&quot;version&quot;</span><span class="w"> </span><span class="s">&quot;0.1.0&quot;</span><span class="p">)</span>
<span class="w">                                </span><span class="p">(</span><span class="s">&quot;results&quot;</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;cat&quot;</span><span class="w"> </span><span class="s">&quot;dog&quot;</span><span class="w"> </span><span class="s">&quot;mouse&quot;</span><span class="p">)))))))</span>
</pre></div>
<p>And <code>search.tmpl</code> would be some Jinja-like text file:</p>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Version {{ version }}<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
  {% for item in results %}
    <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>{{ item }}<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
  {% endfor %}
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
<p>The source code for this post can be found <a href="https://github.com/eatonphil/jvm-lisp-examples">on Github</a>.</p>
<h3 id="picking-a-language,-libraries">Picking a language, libraries</h3><p><a href="https://abcl.org">Armed Bear Common Lisp</a> (ABCL) is the only Common Lisp
implementation I'm aware of that can hook into a major ecosystem of
libraries like the JVM or CLR has. In theory, this makes it a safe
suggestion for folks who want the stability and resources of the
ecosystem even if they aren't using its flagship language.</p>
<p>I wanted to use some micro web framework like
<a href="https://sparkjava.com/">Spark</a> or <a href="https://micronaut.io/">Micronaut</a>.</p>
<p>The problem with libraries like Micronaut (and
<a href="https://eclipse-ee4j.github.io/jersey/">Jersey</a>) is that they do a
lot of dynamic inspection to figure out how to register controllers
and whatnot. This is certainly convenient for developers using the
library in Java. But it becomes an ordeal when you're trying to use
the library through a foreign function interface (FFI) in another
language. An example of this is if a framework scans all files in a
directory for a <code> @GET</code> annotation.</p>
<p>On the other hand, Spark had a seeming hard-requirement about bringing
in a Websocket library which caused some issues during
configuration. So I ended up going with <a href="https://jooby.io/">Jooby</a> and
<a href="https://netty.io/">Netty</a> (as the underlying server).</p>
<p>Finally, I looked into a few Jinja-like template libraries and settled
on <a href="https://pebbletemplates.io/">Pebble</a> since
<a href="https://github.com/HubSpot/jinjava">Jinjava</a> <a href="https://github.com/HubSpot/jinjava/issues/317">wouldn't load for
me</a>.</p>
<h3 id="3rd-party-jars-and-foreign-function-calls">3rd-party jars and foreign function calls</h3><p>So you've got your maven dependencies and ran <code>mvn
install</code>. Your <code>pom.xml</code> looks like this:</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;project&gt;</span>
<span class="w">  </span><span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

<span class="w">  </span><span class="nt">&lt;groupId&gt;</span>com.github.eatonphil<span class="nt">&lt;/groupId&gt;</span>
<span class="w">  </span><span class="nt">&lt;artifactId&gt;</span>abcl-rest-api-hello-world<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">  </span><span class="nt">&lt;version&gt;</span>1<span class="nt">&lt;/version&gt;</span>

<span class="w">  </span><span class="nt">&lt;dependencies&gt;</span>
<span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
<span class="w">      </span><span class="nt">&lt;groupId&gt;</span>io.jooby<span class="nt">&lt;/groupId&gt;</span>
<span class="w">      </span><span class="nt">&lt;artifactId&gt;</span>jooby<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">      </span><span class="nt">&lt;version&gt;</span>2.10.0<span class="nt">&lt;/version&gt;</span>
<span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>

<span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
<span class="w">      </span><span class="nt">&lt;groupId&gt;</span>io.jooby<span class="nt">&lt;/groupId&gt;</span>
<span class="w">      </span><span class="nt">&lt;artifactId&gt;</span>jooby-netty<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">      </span><span class="nt">&lt;version&gt;</span>2.10.0<span class="nt">&lt;/version&gt;</span>
<span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>

<span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
<span class="w">      </span><span class="nt">&lt;groupId&gt;</span>io.pebbletemplates<span class="nt">&lt;/groupId&gt;</span>
<span class="w">      </span><span class="nt">&lt;artifactId&gt;</span>pebble<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">      </span><span class="nt">&lt;version&gt;</span>3.1.5<span class="nt">&lt;/version&gt;</span>
<span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
<span class="w">  </span><span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;/project&gt;</span>
</pre></div>
<p>ABCL has a package called <code>abcl-asdf</code> that helps you resolve dependencies through Maven and your filesystem. We'll import it and a package it depends on (<code>abcl-contrib</code>):</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">require</span><span class="w"> </span><span class="ss">:abcl-contrib</span><span class="p">)</span>
<span class="p">(</span><span class="nb">require</span><span class="w"> </span><span class="ss">:abcl-asdf</span><span class="p">)</span>
</pre></div>
<p>All our code will go into a single <code>main.lisp</code> file.</p>
<p>To import a specific package from Maven you
call <code>abcl-asdf:resolve</code> with a colon-separated string
containing the Maven package group id and artifact id. Then you pass
that result to <code>abcl-asdf:as-classpath</code> and pass that
result to <code>java:add-to-classpath</code>.</p>
<p>It will look like this:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="nv">imports</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;io.jooby:jooby&quot;</span>
<span class="w">                </span><span class="s">&quot;io.jooby:jooby-netty&quot;</span>
<span class="w">                </span><span class="s">&quot;io.pebbletemplates:pebble&quot;</span><span class="p">))</span>
<span class="p">(</span><span class="nb">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nb">import</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">imports</span>
<span class="w">      </span><span class="nb">do</span><span class="w"> </span><span class="p">(</span><span class="nv">java:add-to-classpath</span>
<span class="w">          </span><span class="p">(</span><span class="nv">abcl-asdf:as-classpath</span><span class="w"> </span><span class="p">(</span><span class="nv">abcl-asdf:resolve</span><span class="w"> </span><span class="nb">import</span><span class="p">))))</span>
</pre></div>
<p>Now you can call functions within these packages. If you want to call
a Java method using only builtins it looks like <code>(jcall "method"
"com.organization.package.Class" object arg1 arg2 ... argN)</code>. If
you want to call a static Java method you use <code>(jstatic
...)</code> instead of <code>(jcall ...)</code>.</p>
<p>It seems that ABCL will automatically convert simple types from their
Lisp representation to Java but it will not turn a list into an
array. If a Java function requires an array you'll have to do that
explicitly with a function like <code>(java:jnew-array-from-list
"java.lang.String" my-string-list)</code>.</p>
<p>When using the builtin Java FFI you always need to use the fully
qualified name for classes like <code>java.lang.Object</code>
for <code>Object</code> or <code>java.util.Array</code>
for <code>Array</code>.</p>
<p>Alternatively you can <code>(require :jss)</code> to get access to a
simpler syntax for making Java calls. A method call looks
like <code>(#"method" object arg1 arg2 ... argN)</code>. Creating a
new instance of an object is calling <code>(jss:jnew
'className)</code>. When you use JSS you don't need to fully qualify a
class name unless there are more than one class with the same
name. For example to create a new Jooby application instance we can
call <code>(jss:jnew 'Jooby)</code>. As long as the class can be found
in the class path JSS will resolve it.</p>
<h3 id="some-real-code">Some real code</h3><p>The real code will look similar to the pseudo-code at the top of this
article. We'll stub out the library-specific wrappers for rendering a
template and for registering a route.</p>
<p>Fumbling around the <a href="https://github.com/jooby-project/jooby/blob/2.x/jooby/src/main/java/io/jooby/Server.java#L35">Jooby source code</a> we see this snippet of Java:</p>
<div class="highlight"><pre><span></span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Netty</span><span class="p">();</span><span class="w"> </span><span class="c1">// or Jetty or Utow</span>
<span class="w"> </span><span class="o">*</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">App</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">App</span><span class="p">();</span>
<span class="w"> </span><span class="o">*</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">server</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="n">app</span><span class="p">);</span>
<span class="w"> </span><span class="o">*</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">...</span>
<span class="w"> </span><span class="o">*</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">server</span><span class="p">.</span><span class="na">stop</span><span class="p">();</span>
</pre></div>
<p><code>Netty</code> comes from the <code>jooby-netty</code> artifact in
the <code>io.jooby</code> group on Maven. And <code>App</code> is some
object that extends <code>io.jooby.Jooby</code>. Since we're not using
an OOP language though we're going to try avoiding classes as much as
possible. So we'll just create a new instance
of <code>io.jooby.Jooby</code> and add routes directly to it.</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">template</span><span class="w"> </span><span class="p">(</span><span class="nv">filename</span><span class="w"> </span><span class="nv">context</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;&quot;</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">route</span><span class="w"> </span><span class="p">(</span><span class="nv">app</span><span class="w"> </span><span class="nc">method</span><span class="w"> </span><span class="nv">path</span><span class="w"> </span><span class="nv">handler</span><span class="p">)</span>
<span class="w">  </span><span class="no">nil</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">register-endpoints</span><span class="w"> </span><span class="p">(</span><span class="nv">app</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">route</span><span class="w"> </span><span class="nv">app</span><span class="w"> </span><span class="s">&quot;GET&quot;</span><span class="w"> </span><span class="s">&quot;/&quot;</span>
<span class="w">         </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nv">ctx</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;An index!&quot;</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nv">route</span><span class="w"> </span><span class="nv">app</span><span class="w"> </span><span class="s">&quot;GET&quot;</span><span class="w"> </span><span class="s">&quot;/search&quot;</span>
<span class="w">         </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nv">ctx</span><span class="p">)</span>
<span class="w">             </span><span class="p">(</span><span class="nv">template</span><span class="w"> </span><span class="s">&quot;search.tmpl&quot;</span><span class="w"> </span><span class="o">`</span><span class="p">((</span><span class="s">&quot;version&quot;</span><span class="w"> </span><span class="s">&quot;1.0.0&quot;</span><span class="p">)</span>
<span class="w">                                       </span><span class="p">(</span><span class="s">&quot;results&quot;</span><span class="w"> </span><span class="o">,</span><span class="p">(</span><span class="nv">java:jarray-from-list</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;cat&quot;</span><span class="w"> </span><span class="s">&quot;dog&quot;</span><span class="w"> </span><span class="s">&quot;mouse&quot;</span><span class="p">)))))))</span>
<span class="w">  </span><span class="p">(</span><span class="nv">route</span><span class="w"> </span><span class="nv">app</span><span class="w"> </span><span class="s">&quot;GET&quot;</span><span class="w"> </span><span class="s">&quot;/hello-world&quot;</span>
<span class="w">         </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nv">ctx</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;Hello world!&quot;</span><span class="p">)))</span>

<span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nv">port</span><span class="w"> </span><span class="mi">8080</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="nv">server</span><span class="w"> </span><span class="p">(</span><span class="nv">jss:new</span><span class="w"> </span><span class="ss">&#39;Netty</span><span class="p">))</span>
<span class="w">       </span><span class="p">(</span><span class="nv">app</span><span class="w"> </span><span class="p">(</span><span class="nv">jss:new</span><span class="w"> </span><span class="ss">&#39;Jooby</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="nv">register-endpoints</span><span class="w"> </span><span class="nv">app</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="l l-Other">#&quot;setOptions&quot;</span><span class="w"> </span><span class="nv">server</span><span class="w"> </span><span class="p">(</span><span class="l l-Other">#&quot;setPort&quot;</span><span class="w"> </span><span class="p">(</span><span class="nv">jss:new</span><span class="w"> </span><span class="ss">&#39;ServerOptions</span><span class="p">)</span><span class="w"> </span><span class="nv">port</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="l l-Other">#&quot;start&quot;</span><span class="w"> </span><span class="nv">server</span><span class="w"> </span><span class="nv">app</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="l l-Other">#&quot;join&quot;</span><span class="w"> </span><span class="nv">server</span><span class="p">))</span>
</pre></div>
<p>Easy enough. Now we just need to implement <code>route</code>
and <code>template</code>.</p>
<h3 id="implementing-java-classes-in-abcl">Implementing Java classes in ABCL</h3><p>We are again not going the happy path with fancy Java syntax (which is
fine if you're using Java) like the Jooby documentation
suggests. Scouring the <a href="https://github.com/jooby-project/jooby/blob/2.x/jooby/src/main/java/io/jooby/Jooby.java#L546">Jooby source code
again</a>
it looks like we can call <code>route</code> on the <code>Jooby</code>
class with a method string, a path string, and an instance of an
object implementing the <code>io.jooby.Route.Handler</code> interface.</p>
<p>Since this handler argument is an interface, we cannot cheat again by
creating an instance of it we'll have to actually create a new class
in Lisp that extends it. Thankfully there's only one method we need to
implement to satisfy this interface,
<a href="https://github.com/jooby-project/jooby/blob/2.x/jooby/src/main/java/io/jooby/Route.java#L256">apply</a>. It
accepts a <code>io.jooby.Context</code> object and returns
a <code>java.lang.Object</code>. The framework then does introspection
to figure out what exactly the object is and if it needs to transform
it into a string to be returned as an HTTP response body.</p>
<p>To create a new class in ABCL we call <code>(java:jnew-runtime-class
"classname" :interfaces '("an interface name") :methods '(("method
name 1" "return type" ("first parameter type" ...) (lambda (this arg1
  ...) body))))</code>:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">route</span><span class="w"> </span><span class="p">(</span><span class="nv">app</span><span class="w"> </span><span class="nc">method</span><span class="w"> </span><span class="nv">path</span><span class="w"> </span><span class="nv">handler</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="l l-Other">#&quot;route&quot;</span>
<span class="w">   </span><span class="nv">app</span>
<span class="w">   </span><span class="nc">method</span>
<span class="w">   </span><span class="nv">path</span>
<span class="w">   </span><span class="p">(</span><span class="nv">jss:new</span><span class="w"> </span><span class="p">(</span><span class="nv">java:jnew-runtime-class</span>
<span class="w">             </span><span class="p">(</span><span class="nb">substitute</span><span class="w"> </span><span class="sc">#\$</span><span class="w"> </span><span class="sc">#\/</span><span class="w"> </span><span class="p">(</span><span class="nb">substitute</span><span class="w"> </span><span class="sc">#\$</span><span class="w"> </span><span class="sc">#\-</span><span class="w"> </span><span class="nv">path</span><span class="p">))</span>
<span class="w">             </span><span class="ss">:interfaces</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;io.jooby.Route$Handler&quot;</span><span class="p">)</span>
<span class="w">             </span><span class="ss">:methods</span><span class="w"> </span><span class="o">`</span><span class="p">(</span>
<span class="w">                       </span><span class="p">(</span><span class="s">&quot;apply&quot;</span><span class="w"> </span><span class="s">&quot;java.lang.Object&quot;</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;io.jooby.Context&quot;</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nv">this</span><span class="w"> </span><span class="nv">ctx</span><span class="p">)</span>
<span class="w">                          </span><span class="p">(</span><span class="nb">funcall</span><span class="w"> </span><span class="o">,</span><span class="nv">handler</span><span class="w"> </span><span class="nv">ctx</span><span class="p">))))))))</span>
</pre></div>
<p>One thing to note is that when referring to a subclass within a file
we need to address it with the <code>io.jooby.Route$Handler</code>
syntax rather than as you might refer to it in Java
as <code>io.jooby.Route.Handler</code>. In the latter case ABCL
thinks <code>Route</code> is a package when in fact it's just a class.</p>
<p>If you run this now with <code>abcl --load main.lisp</code>. It will
work until you hit an endpoint. The problem is how Jooby tries to
figure out the real type of the returned object.</p>
<p>The app will crash somewhere around
<a href="https://github.com/jooby-project/jooby/blob/2.x/jooby/src/main/java/io/jooby/internal/RouterImpl.java#L560">here</a>
calling <code>analyzer.returnType(route.getHandle())</code>.</p>
<p>In this case it tries to <a href="https://github.com/jooby-project/jooby/blob/f47eda4500bc4b76b23d24d4d77aa2ab3cc19e95/jooby/src/main/java/io/jooby/internal/RouteAnalyzer.java#L44">open and parse the (Java) source
code</a>
of our application to try to find the return type for
this <code>apply</code> function.</p>
<p>That's a problem since our code isn't Java. Through trial and error I
realized we can trick Jooby/Java/somebody into figuring out the
correct return type by adding another implementation
of <code>apply</code> that returns a <code>String</code> to our class.</p>
<p>The full <code>route</code> code now looks like this:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">route</span><span class="w"> </span><span class="p">(</span><span class="nv">app</span><span class="w"> </span><span class="nc">method</span><span class="w"> </span><span class="nv">path</span><span class="w"> </span><span class="nv">handler</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="l l-Other">#&quot;route&quot;</span>
<span class="w">   </span><span class="nv">app</span>
<span class="w">   </span><span class="nc">method</span>
<span class="w">   </span><span class="nv">path</span>
<span class="w">   </span><span class="p">(</span><span class="nv">jss:new</span><span class="w"> </span><span class="p">(</span><span class="nv">java:jnew-runtime-class</span>
<span class="w">             </span><span class="p">(</span><span class="nb">substitute</span><span class="w"> </span><span class="sc">#\$</span><span class="w"> </span><span class="sc">#\/</span><span class="w"> </span><span class="p">(</span><span class="nb">substitute</span><span class="w"> </span><span class="sc">#\$</span><span class="w"> </span><span class="sc">#\-</span><span class="w"> </span><span class="nv">path</span><span class="p">))</span>
<span class="w">             </span><span class="ss">:interfaces</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;io.jooby.Route$Handler&quot;</span><span class="p">)</span>
<span class="w">             </span><span class="ss">:methods</span><span class="w"> </span><span class="o">`</span><span class="p">(</span>
<span class="w">                       </span><span class="c1">;; Need to define this one to make Jooby figure out the return type</span>
<span class="w">                       </span><span class="c1">;; Otherwise it tries to read &quot;this file&quot; which isn&#39;t a Java file so cannot be parsed</span>
<span class="w">                       </span><span class="p">(</span><span class="s">&quot;apply&quot;</span><span class="w"> </span><span class="s">&quot;java.lang.String&quot;</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;io.jooby.Context&quot;</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nv">this</span><span class="w"> </span><span class="nv">ctx</span><span class="p">)</span><span class="w"> </span><span class="no">nil</span><span class="p">))</span>
<span class="w">                       </span><span class="c1">;; This one actually gets called</span>
<span class="w">                       </span><span class="p">(</span><span class="s">&quot;apply&quot;</span><span class="w"> </span><span class="s">&quot;java.lang.Object&quot;</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;io.jooby.Context&quot;</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nv">this</span><span class="w"> </span><span class="nv">ctx</span><span class="p">)</span>
<span class="w">                          </span><span class="p">(</span><span class="nb">funcall</span><span class="w"> </span><span class="o">,</span><span class="nv">handler</span><span class="w"> </span><span class="nv">ctx</span><span class="p">))))))))</span>
</pre></div>
<p>You may wonder, why keep the original method around? Well it's because
during reflection, ABCL says no such method that
returns <code>String</code> exists in the <code>Handler</code>
interface. That's fair I guess.</p>
<h3 id="implementing-the-template">Implementing the template</h3><p>The Java example on the <a href="https://pebbletemplates.io/">Pebble homepage</a>
is perfect:</p>
<div class="highlight"><pre><span></span><span class="n">PebbleEngine</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PebbleEngine</span><span class="p">.</span><span class="na">Builder</span><span class="p">().</span><span class="na">build</span><span class="p">();</span>
<span class="n">PebbleTemplate</span><span class="w"> </span><span class="n">compiledTemplate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">engine</span><span class="p">.</span><span class="na">getTemplate</span><span class="p">(</span><span class="s">&quot;home.html&quot;</span><span class="p">);</span>

<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="n">context</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Mitchell&quot;</span><span class="p">);</span>

<span class="n">Writer</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StringWriter</span><span class="p">();</span>
<span class="n">compiledTemplate</span><span class="p">.</span><span class="na">evaluate</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">);</span>

<span class="n">String</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">writer</span><span class="p">.</span><span class="na">toString</span><span class="p">();</span>
</pre></div>
<p>We can easily translate this into Lisp:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">hashmap</span><span class="w"> </span><span class="p">(</span><span class="nv">alist</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nb">map</span><span class="w"> </span><span class="p">(</span><span class="nv">jss:new</span><span class="w"> </span><span class="ss">&#39;HashMap</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nb">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">el</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">alist</span>
<span class="w">         </span><span class="nb">do</span><span class="w"> </span><span class="p">(</span><span class="l l-Other">#&quot;put&quot;</span><span class="w"> </span><span class="nb">map</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">el</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cadr</span><span class="w"> </span><span class="nv">el</span><span class="p">)))</span>
<span class="w">    </span><span class="nb">map</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">template</span><span class="w"> </span><span class="p">(</span><span class="nv">filename</span><span class="w"> </span><span class="nv">context-alist</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nv">ctx</span><span class="w"> </span><span class="p">(</span><span class="nv">hashmap</span><span class="w"> </span><span class="nv">context-alist</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="nv">path</span><span class="w"> </span><span class="p">(</span><span class="nv">java:jstatic</span><span class="w"> </span><span class="s">&quot;of&quot;</span><span class="w"> </span><span class="s">&quot;java.nio.file.Path&quot;</span><span class="w"> </span><span class="nv">filename</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="nv">file</span><span class="w"> </span><span class="p">(</span><span class="l l-Other">#&quot;readString&quot;</span><span class="w"> </span><span class="ss">&#39;java.nio.file.Files</span><span class="w"> </span><span class="nv">path</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="nv">engine</span><span class="w"> </span><span class="p">(</span><span class="l l-Other">#&quot;build&quot;</span><span class="w"> </span><span class="p">(</span><span class="nv">jss:new</span><span class="w"> </span><span class="ss">&#39;PebbleEngine$Builder</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="nv">compiledTmpl</span><span class="w"> </span><span class="p">(</span><span class="l l-Other">#&quot;getTemplate&quot;</span><span class="w"> </span><span class="nv">engine</span><span class="w"> </span><span class="nv">filename</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="nv">writer</span><span class="w"> </span><span class="p">(</span><span class="nv">jss:new</span><span class="w"> </span><span class="ss">&#39;java.io.StringWriter</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="l l-Other">#&quot;evaluate&quot;</span><span class="w"> </span><span class="nv">compiledTmpl</span><span class="w"> </span><span class="nv">writer</span><span class="w"> </span><span class="nv">ctx</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="l l-Other">#&quot;toString&quot;</span><span class="w"> </span><span class="nv">writer</span><span class="p">)))</span>
</pre></div>
<p>But if you run this <code>abcl --load main.lisp</code> and hit this
<code>/search</code> endpoint, it will blow up saying "no such method"
exists at the call to <code>Path.of(filename)</code>.</p>
<p>After digging around I saw it was because
<a href="https://docs.oracle.com/en/java/javase/16/docs/api/java.base/java/nio/file/Path.html#of(java.lang.String,java.lang.String...%29">Path.of</a>
is a variadic function.</p>
<p>And while there are <a href="https://abcl.org/trac/changeset/15234">examples
of</a> using variadic functions
when the function only has a single parameter like
<code>java.util.Arrays.asList(T ...)</code>, employing that same
technique here continued to result in "no such method":</p>
<div class="highlight"><pre><span></span>         (path (java:jstatic &quot;of&quot; &quot;java.nio.file.Path&quot; filename (jnew-array &quot;java.lang.String&quot; 0)))
</pre></div>
<p>Eventually I found an <a href="https://stackoverflow.com/questions/20440839/cant-invoke-method-with-varargs-parameters-with-reflection-nosuchmethodexcept">example of someone doing reflect/invoke on this
kind of a function
call</a>
and tried this logic on a local copy of the ABCL source code.</p>
<p>It worked. So I opened a <a href="https://github.com/armedbear/abcl/pull/379">pull request</a>.</p>
<p>So the full working code for <code>template</code> is:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">template</span><span class="w"> </span><span class="p">(</span><span class="nv">filename</span><span class="w"> </span><span class="nv">context-alist</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nv">ctx</span><span class="w"> </span><span class="p">(</span><span class="nv">hashmap</span><span class="w"> </span><span class="nv">context-alist</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="nv">path</span><span class="w"> </span><span class="p">(</span><span class="nv">java:jstatic</span><span class="w"> </span><span class="s">&quot;of&quot;</span><span class="w"> </span><span class="s">&quot;java.nio.file.Path&quot;</span><span class="w"> </span><span class="nv">filename</span><span class="w"> </span><span class="p">(</span><span class="nv">java:jnew-array</span><span class="w"> </span><span class="s">&quot;java.lang.String&quot;</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="nv">file</span><span class="w"> </span><span class="p">(</span><span class="l l-Other">#&quot;readString&quot;</span><span class="w"> </span><span class="ss">&#39;java.nio.file.Files</span><span class="w"> </span><span class="nv">path</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="nv">engine</span><span class="w"> </span><span class="p">(</span><span class="l l-Other">#&quot;build&quot;</span><span class="w"> </span><span class="p">(</span><span class="nv">jss:new</span><span class="w"> </span><span class="ss">&#39;PebbleEngine$Builder</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="nv">compiledTmpl</span><span class="w"> </span><span class="p">(</span><span class="l l-Other">#&quot;getTemplate&quot;</span><span class="w"> </span><span class="nv">engine</span><span class="w"> </span><span class="nv">filename</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="nv">writer</span><span class="w"> </span><span class="p">(</span><span class="nv">jss:new</span><span class="w"> </span><span class="ss">&#39;java.io.StringWriter</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="l l-Other">#&quot;evaluate&quot;</span><span class="w"> </span><span class="nv">compiledTmpl</span><span class="w"> </span><span class="nv">writer</span><span class="w"> </span><span class="nv">ctx</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="l l-Other">#&quot;toString&quot;</span><span class="w"> </span><span class="nv">writer</span><span class="p">)))</span>
</pre></div>
<p>And to get this diff running locally:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>mkdir<span class="w"> </span>~/vendor
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>~/vendor
$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/eatonphil/abcl
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>abcl
$<span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span>pe/more-variadic
$<span class="w"> </span>sudo<span class="w"> </span><span class="o">{</span>dnf/brew/apt<span class="o">}</span><span class="w"> </span>install<span class="w"> </span>ant<span class="w"> </span>maven
$<span class="w"> </span>ant<span class="w"> </span>-f<span class="w"> </span>build.xml
</pre></div>
<p>And to run <code>main.lisp</code> using this diff:</p>
<div class="highlight"><pre><span></span><span class="o">$</span><span class="w"> </span><span class="o">~/</span><span class="n">vendor</span><span class="o">/</span><span class="n">abcl</span><span class="o">/</span><span class="n">abcl</span><span class="w"> </span><span class="o">--</span><span class="nb">load</span><span class="w"> </span><span class="n">main</span><span class="o">.</span><span class="n">lisp</span>
</pre></div>
<p>And to hit the API:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>curl<span class="w"> </span>localhost:8080/search
&lt;html&gt;
&lt;title&gt;Version<span class="w"> </span><span class="m">1</span>.0.0&lt;/title&gt;
<span class="w">  </span>&lt;h2&gt;cat&lt;/h2&gt;
<span class="w">  </span>&lt;h2&gt;dog&lt;/h2&gt;
<span class="w">  </span>&lt;h2&gt;mouse&lt;/h2&gt;
&lt;/html&gt;
$<span class="w"> </span>curl<span class="w"> </span>localhost:8080/hello-world
Hello<span class="w"> </span>world!%
</pre></div>
<p>Phew! Easy peasy.</p>
<h3 id="next-up">Next up</h3><p>I'm porting this example to Kawa to see how it fares. Blog post to come.</p>
<p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">In a ridiculous attempt to prove an internet wrong about the practicality of Lisp (Common Lisp specifically), I tried to get a simple (but realistic) web app running. After four days and a patch to ABCL I got something working.<a href="https://t.co/5UUWNR8Wnn">https://t.co/5UUWNR8Wnn</a> <a href="https://t.co/cZsx32IlKD">pic.twitter.com/cZsx32IlKD</a></p>&mdash; Phil Eaton (@phil_eaton) <a href="https://twitter.com/phil_eaton/status/1423345414279942150?ref_src=twsrc%5Etfw">August 5, 2021</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<style>.feedback{display:initial;}</style>
	</div>
	<div class="feedback">
	  <h4>Feedback</h4>
	  <p>As always,
	      please <a href="mailto:phil@eatonphil.com">email</a>
	      or <a href="https://twitter.com/eatonphil">tweet me</a>
	      with questions, corrections, or ideas!</p>

	</div>
      </div>
    </div>
    <footer>
      <div class="container">
	<div>
	  <div id="subscribe">
	    <iframe frameBorder="0" src="https://cdn.forms-content-1.sg-form.com/e8ed4c3b-dd46-11f0-b6e6-ce075f2c5f80"/>

	  </div>
	</div>
      </div>
    </footer>
    <script async onload="loadGA()" src="https://www.googletagmanager.com/gtag/js?id=UA-58109156-2"></script>
    <script>
      function loadGA() {
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());
	  gtag('config', 'UA-58109156-2');
      }
    </script>
    <script defer src="https://cdn.usefathom.com/script.js" data-site="CEPUOLOQ"></script>
  </body>
</html>
