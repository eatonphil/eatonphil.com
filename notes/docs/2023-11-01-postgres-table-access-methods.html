<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="canonical" href="https://notes.eatonphil.com/2023-11-01-postgres-table-access-methods.html">
    <title>Writing a storage engine for Postgres: an in-memory Table Access Method | notes.eatonphil.com</title>
    <meta name="description" content="Writing a storage engine for Postgres: an in-memory Table Access Method" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" href="/rss.xml" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono">
  </head>
  <body>
    <header>
      <!-- <div class="lfw"> -->
      <!-- 	<div class="container"> -->
      <!-- 	  <div class="row"> -->
      <!-- 	    <a href="https://eatonphil.com/hire-me.html">Hire me!</a> -->
      <!-- 	  </div> -->
      <!-- 	</div> -->
      <!-- </div> -->
      <div class="container">
        <div>
          <div class="row">
	    <div>
	      <a href="https://eatonphil.com" class="sm-link">
		Home
              </a>
	      <a href="/" class="sm-link">
		Notes
              </a>
	      <a href="/favorites.html" class="sm-link hide-mobile">
		Popular
              </a>
	      <a href="/rss.xml" class="sm-link">
		RSS
              </a>
	    </div>

	    <div class="subscribe">
	      <!-- <a href="https://eatonphil.com/hire-me.html">Hire me</a> -->
	      <!--
		  Hardcode link to home page because some pages don't
		  have a subscribe box. Some pages hide the subscribe.
		-->
	      <a class="fancy" href="https://eatonphil.com/subscribe.html">
		Subscribe
	      </a>
            </div>
	  </div>
	  <hr />
	  <div class="">
            <h2>November 1, 2023</h2>
            <h1>Writing a storage engine for Postgres: an in-memory Table Access Method</h1>
	    
            <div class="row" style="padding-bottom: 5px">
              <div class="tags"><a href="/tags/c.html" class="tag">c</a><a href="/tags/postgres.html" class="tag">postgres</a><a href="/tags/databases.html" class="tag">databases</a></div>
            </div>
	  </div>
	</div>
      </div>
    </header>
    <div class="container">
      <div class="col-6">
        <p>With <a href="https://www.postgresql.org/docs/release/12.0/">Postgres 12</a>,
released in 2019, it became possible to <a href="https://www.pgcon.org/2019/schedule/attachments/536_pgcon2019_pluggable_table_AM_V1.3.pdf">swap out Postgres's storage
engine</a>.</p>
<p>This is a feature MySQL has supported for a long time. There are at
least <a href="https://github.com/eatonphil/pgtam">8 different</a> <em>built-in</em>
engines you can pick from. <a href="https://myrocks.io/">MyRocks</a>, MySQL on
RocksDB, is another popular third-party distribution.</p>
<p>I assume there will be a renaissance of Postgres storage engines. To
date, the efforts are
nascent. <a href="https://github.com/orioledb/orioledb">OrioleDB</a> and <a href="https://github.com/citusdata/citus/blob/main/src/backend/columnar/README.md">Citus
Columnar</a>
are two promising third-party table access methods being actively
developed.</p>
<h3 id="why-alternative-storage-engines?">Why alternative storage engines?</h3><p>The ability to swap storage engines is useful because different
workloads sometimes benefit from different storage
approaches. Analytics workloads and columnar storage layouts <a href="https://docs.aws.amazon.com/redshift/latest/dg/c_columnar_storage_disk_mem_mgmnt.html">go well
together</a>. Write-heavy
workloads and LSM trees <a href="https://github.com/wiredtiger/wiredtiger/wiki/Btree-vs-LSM">go well
together</a>. And
some people like in-memory storage for running integration tests.</p>
<p>By swapping out only the storage engine, you get the benefit of the
rest of the Postgres or MySQL infrastructure. The query language, the
wire protocol, the ecosystem, etc.</p>
<h3 id="why-not-foreign-data-wrappers?">Why not foreign data wrappers?</h3><p>Very little has been written about the difference between foreign data
wrappers (FDWs) and table access methods. Table access methods seems
to be the lower-level layer where presumably you get better
performance and cleaner integration. But there is clearly overlap
between these two extension options.</p>
<p>For example there is a <a href="https://github.com/ildus/clickhouse_fdw">FDW for
ClickHouse</a> so when you
create tables and rows and query the tables you are really creating
and querying rows in a ClickHouse server. Similarly there's a <a href="https://github.com/vidardb/pgrocks-fdw">FDW for
RocksDB</a>. And Citus's columnar
engine works
<a href="https://www.citusdata.com/blog/2021/03/06/citus-10-columnar-compression-for-postgres/#:~:text=What%20About%20cstore_fdw%3F">either</a>
as a foreign data wrapper or a table access method.</p>
<p>The Citus page draws the clearest distinction between FDWs and table
access methods, but even that page is vague. Performance doesn't seem
to be the main difference. Closer integration, and thus the ability to
look more like vanilla Postgres from the outside, seems to be the
gist.</p>
<p>In any case, I wanted to explore the table access method API.</p>
<h3 id="digging-in">Digging in</h3><p>I haven't written Postgres extensions before and I've never written C
professionally. If you're familiar with Postgres internals or C and
notice something funky, please <a href="mailto:me@eatonphil.com">let me know</a>!</p>
<p>It turns out that almost no one has written how to implement the
minimal table access methods for various storage engine operations. So
after quite a bit of stumbling to get the basics of an in-memory
storage engine working, I'm going to walk you through my approach.</p>
<p>This is prototype-quality code which hopefully will be a useful base
for further exploration.</p>
<p>All code for this post is <a href="https://github.com/eatonphil/pgtam">available on
GitHub</a>.</p>
<h3 id="a-debug-postgres-build">A debug Postgres build</h3><p>First off, let's make a <a href="https://wiki.postgresql.org/wiki/Developer_FAQ#Compile-time">debug
build</a> of
Postgres.</p>
<div class="highlight"><pre><span></span><span class="n">$</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="k">clone</span><span class="w"> </span><span class="n">https</span><span class="o">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">postgres</span><span class="o">/</span><span class="n">postgres</span>
<span class="n">$</span><span class="w"> </span><span class="c1"># An arbitrary commit from `master` after Postgres 16 I am on</span>
<span class="n">$</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="n">checkout</span><span class="w"> </span><span class="n">849172ff4883d44168f96f39d3fde96d0aa34c99</span>
<span class="n">$</span><span class="w"> </span><span class="n">cd</span><span class="w"> </span><span class="n">postgres</span>
<span class="n">$</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">configure</span><span class="w"> </span><span class="o">--</span><span class="k">enable</span><span class="o">-</span><span class="n">cassert</span><span class="w"> </span><span class="o">--</span><span class="k">enable</span><span class="o">-</span><span class="n">debug</span><span class="w"> </span><span class="n">CFLAGS</span><span class="o">=</span><span class="s2">&quot;-ggdb -Og -g3 -fno-omit-frame-pointer&quot;</span>
<span class="n">$</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="o">-</span><span class="n">j8</span>
<span class="n">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="k">install</span>
</pre></div>
<p>This will install Postgres binaries (e.g. <code>psql</code>, <code>pg_ctl</code>, <code>initdb</code>,
<code>pg_config</code>) into <code>/usr/local/pgsql/bin</code>.</p>
<p>I'm going to reference those absolute paths throughout this post
because you might have a system (package manager) install of Postgres
already.</p>
<p>Let's create a database and start up this debug build:</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>/usr/local/pgsql/bin/initdb<span class="w"> </span>test-db
<span class="gp">$ </span>/usr/local/pgsql/bin/pg_ctl<span class="w"> </span>-D<span class="w"> </span>test-db<span class="w"> </span>-l<span class="w"> </span>logfile<span class="w"> </span>start
</pre></div>
<h3 id="extension-infrastructure">Extension infrastructure</h3><p>Since we installed Postgres from scratch,
<code>/usr/local/pgsql/bin/pg_config</code> will supply all of the infrastructure
we need.</p>
<p>The "infrastructure" is basically just
<a href="https://www.postgresql.org/docs/current/extend-pgxs.html">PGXS</a>:
Postgres Makefile utilities.</p>
<p>It's convention-heavy. So in a new <code>Makefile</code> for this project we'll
specify:</p>
<ol>
<li><code>MODULES</code>: Any C sources to build, without the <code>.c</code> file extension</li>
<li><code>EXTENSION</code>: Extension metadata file, without the <code>.control</code> file extension</li>
<li><code>DATA</code>: A SQL file that is executed when the extension is loaded, this time with the <code>.sql</code> extension</li>
</ol>
<div class="highlight"><pre><span></span><span class="nv">MODULES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>pgtam
<span class="nv">EXTENSION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>pgtam
<span class="nv">DATA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>pgtam--0.0.1.sql

<span class="nv">PG_CONFIG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>/usr/local/pgsql/bin/pg_config
<span class="nv">PGXS</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">$(</span>shell<span class="w"> </span><span class="k">$(</span>PG_CONFIG<span class="k">)</span><span class="w"> </span>--pgxs<span class="k">)</span>
<span class="cp">include $(PGXS)</span>
</pre></div>
<p>The final three lines set up the PGXS Makefile library based on the
particular installed Postgres build we want to build the extension
against and install the extension to.</p>
<p>PGXS gives us a few important targets like <code>make distclean</code>, <code>make</code>,
and <code>make install</code> we'll use later on.</p>
<h4 id="<code>pgtam.c</code>"><code>pgtam.c</code></h4><p>A minimal C file that registers a function capable of serving as a
table access method is:</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;postgres.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;fmgr.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;access/tableam.h&quot;</span>

<span class="n">PG_MODULE_MAGIC</span><span class="p">;</span>

<span class="k">const</span><span class="w"> </span><span class="n">TableAmRoutine</span><span class="w"> </span><span class="n">memam_methods</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T_TableAmRoutine</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">PG_FUNCTION_INFO_V1</span><span class="p">(</span><span class="n">mem_tableam_handler</span><span class="p">);</span>
<span class="n">Datum</span><span class="w"> </span><span class="nf">mem_tableam_handler</span><span class="p">(</span><span class="n">PG_FUNCTION_ARGS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">PG_RETURN_POINTER</span><span class="p">(</span><span class="o">&amp;</span><span class="n">memam_methods</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p class="note">
  If you want to read about extension basics without the complexity of
  table access methods, you can find a complete, minimal Postgres
  extension I wrote to validate the
  infrastructure <a href="https://github.com/eatonphil/pgext-101">here</a>. Or
  you can follow a
  <a href="https://github.com/IshaanAdarsh/Postgres-extension-tutorial/blob/main/SGML/intro_and_toc.md">larger
    tutorial</a>.
</p><p>The workflow for registering a table access method is to first run
<code>CREATE EXTENSION pgtam</code>. This assumes <code>pgtam</code> is an extension that
has a function that returns a <code>TableAmRoutine</code> struct instance, a
table of table access methods.</p>
<p>Then you must run <code>CREATE ACCESS METHOD mem TYPE TABLE HANDLER
mem_tableam_handler</code>. And finally you can use the access method when
creating a table with <code>USING mem</code>: <code>CREATE TABLE x(a INT) USING mem</code>.</p>
<h4 id="<code>pgtam.control</code>"><code>pgtam.control</code></h4><p>This file contains extension metadata. At a minimum, the version of
the extension and the filename for the extension where it should be
installed.</p>
<div class="highlight"><pre><span></span>default_version = &#39;0.0.1&#39;
module_pathname = &#39;$libdir/pgtam&#39;
</pre></div>
<h4 id="<code>pgtam--0.0.1.sql</code>"><code>pgtam--0.0.1.sql</code></h4><p>Finally, in <code>pgtam--0.0.1.sql</code> (which is executed when we call <code>CREATE
EXTENSION pgtam</code>), we register the handler function as a foreign
function, and then we register the function as an access method.</p>
<div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">mem_tableam_handler</span><span class="p">(</span><span class="n">internal</span><span class="p">)</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="n">table_am_handler</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s1">&#39;pgtam&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;mem_tableam_handler&#39;</span>
<span class="k">LANGUAGE</span><span class="w"> </span><span class="k">C</span><span class="w"> </span><span class="k">STRICT</span><span class="p">;</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">ACCESS</span><span class="w"> </span><span class="k">METHOD</span><span class="w"> </span><span class="n">mem</span><span class="w"> </span><span class="k">TYPE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">HANDLER</span><span class="w"> </span><span class="n">mem_tableam_handler</span><span class="p">;</span>
</pre></div>
<h4 id="build">Build</h4><p>Now that we've got all the pieces in place, we can build and install
the extension.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>make
$<span class="w"> </span>sudo<span class="w"> </span>make<span class="w"> </span>install
</pre></div>
<p>Let's add a <code>test.sql</code> script to exercise the extension:</p>
<div class="highlight"><pre><span></span><span class="k">DROP</span><span class="w"> </span><span class="n">EXTENSION</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">pgtam</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">;</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">EXTENSION</span><span class="w"> </span><span class="n">pgtam</span><span class="p">;</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">x</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="nb">INT</span><span class="p">)</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">mem</span><span class="p">;</span>
</pre></div>
<p>And run it:</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>/usr/local/pgsql/bin/psql<span class="w"> </span>postgres<span class="w"> </span>-f<span class="w"> </span>test.sql
<span class="go">DROP EXTENSION</span>
<span class="go">CREATE EXTENSION</span>
<span class="go">psql:test.sql:3: server closed the connection unexpectedly</span>
<span class="go">        This probably means the server terminated abnormally</span>
<span class="go">        before or while processing the request.</span>
<span class="go">psql:test.sql:3: error: connection to server was lost</span>
</pre></div>
<p>Ok, so <code>psql</code> crashed! Let's look at the server logs. When we started
Postgres with <code>pg_ctl</code> we specified the log file as <code>logfile</code> in the
directory where we ran <code>pg_ctl</code>.</p>
<p>If we look through it we'll spot an assertion failure:</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>grep<span class="w"> </span>Assert<span class="w"> </span>logfile
<span class="go">TRAP: failed Assert(&quot;routine-&gt;scan_begin != NULL&quot;), File: &quot;tableamapi.c&quot;, Line: 52, PID: 2906922</span>
</pre></div>
<p>That's a great sign! This is Postgres's debug infrastructure helping
to make sure the table access method is correctly implemented.</p>
<h3 id="table-access-method-stubs">Table access method stubs</h3><p>The next step is to add function stubs for all the non-optional
methods of the <a href="https://github.com/postgres/postgres/blob/849172ff4883d44168f96f39d3fde96d0aa34c99/src/include/access/tableam.h#L282"><code>TableAmRoutine</code>
struct</a>.</p>
<p>I've done all the work for you already so you can just copy this over
the existing <code>pgtam.c</code>. It's a big file, but don't worry. There's
nothing to explain. Just a bunch of blank functions returning default
values when required.</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;postgres.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;fmgr.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;access/tableam.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;access/heapam.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;nodes/execnodes.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;catalog/index.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;commands/vacuum.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;utils/builtins.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;executor/tuptable.h&quot;</span>

<span class="n">PG_MODULE_MAGIC</span><span class="p">;</span>

<span class="k">const</span><span class="w"> </span><span class="n">TableAmRoutine</span><span class="w"> </span><span class="n">memam_methods</span><span class="p">;</span>

<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">TupleTableSlotOps</span><span class="o">*</span><span class="w"> </span><span class="nf">memam_slot_callbacks</span><span class="p">(</span>
<span class="w">  </span><span class="n">Relation</span><span class="w"> </span><span class="n">relation</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">TableScanDesc</span><span class="w"> </span><span class="nf">memam_beginscan</span><span class="p">(</span>
<span class="w">  </span><span class="n">Relation</span><span class="w"> </span><span class="n">relation</span><span class="p">,</span>
<span class="w">  </span><span class="n">Snapshot</span><span class="w"> </span><span class="n">snapshot</span><span class="p">,</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">nkeys</span><span class="p">,</span>
<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">ScanKeyData</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">,</span>
<span class="w">  </span><span class="n">ParallelTableScanDesc</span><span class="w"> </span><span class="n">parallel_scan</span><span class="p">,</span>
<span class="w">  </span><span class="n">uint32</span><span class="w"> </span><span class="n">flags</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">memam_rescan</span><span class="p">(</span>
<span class="w">  </span><span class="n">TableScanDesc</span><span class="w"> </span><span class="n">sscan</span><span class="p">,</span>
<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">ScanKeyData</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">,</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">set_params</span><span class="p">,</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">allow_strat</span><span class="p">,</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">allow_sync</span><span class="p">,</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">allow_pagemode</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">memam_endscan</span><span class="p">(</span><span class="n">TableScanDesc</span><span class="w"> </span><span class="n">sscan</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">memam_getnextslot</span><span class="p">(</span>
<span class="w">  </span><span class="n">TableScanDesc</span><span class="w"> </span><span class="n">sscan</span><span class="p">,</span>
<span class="w">  </span><span class="n">ScanDirection</span><span class="w"> </span><span class="n">direction</span><span class="p">,</span>
<span class="w">  </span><span class="n">TupleTableSlot</span><span class="w"> </span><span class="o">*</span><span class="n">slot</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">IndexFetchTableData</span><span class="o">*</span><span class="w"> </span><span class="nf">memam_index_fetch_begin</span><span class="p">(</span><span class="n">Relation</span><span class="w"> </span><span class="n">rel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">memam_index_fetch_reset</span><span class="p">(</span><span class="n">IndexFetchTableData</span><span class="w"> </span><span class="o">*</span><span class="n">scan</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">memam_index_fetch_end</span><span class="p">(</span><span class="n">IndexFetchTableData</span><span class="w"> </span><span class="o">*</span><span class="n">scan</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">memam_index_fetch_tuple</span><span class="p">(</span>
<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">IndexFetchTableData</span><span class="w"> </span><span class="o">*</span><span class="n">scan</span><span class="p">,</span>
<span class="w">  </span><span class="n">ItemPointer</span><span class="w"> </span><span class="n">tid</span><span class="p">,</span>
<span class="w">  </span><span class="n">Snapshot</span><span class="w"> </span><span class="n">snapshot</span><span class="p">,</span>
<span class="w">  </span><span class="n">TupleTableSlot</span><span class="w"> </span><span class="o">*</span><span class="n">slot</span><span class="p">,</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="o">*</span><span class="n">call_again</span><span class="p">,</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="o">*</span><span class="n">all_dead</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">memam_tuple_insert</span><span class="p">(</span>
<span class="w">  </span><span class="n">Relation</span><span class="w"> </span><span class="n">relation</span><span class="p">,</span>
<span class="w">  </span><span class="n">TupleTableSlot</span><span class="w"> </span><span class="o">*</span><span class="n">slot</span><span class="p">,</span>
<span class="w">  </span><span class="n">CommandId</span><span class="w"> </span><span class="n">cid</span><span class="p">,</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">options</span><span class="p">,</span>
<span class="w">  </span><span class="n">BulkInsertState</span><span class="w"> </span><span class="n">bistate</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">memam_tuple_insert_speculative</span><span class="p">(</span>
<span class="w">  </span><span class="n">Relation</span><span class="w"> </span><span class="n">relation</span><span class="p">,</span>
<span class="w">  </span><span class="n">TupleTableSlot</span><span class="w"> </span><span class="o">*</span><span class="n">slot</span><span class="p">,</span>
<span class="w">  </span><span class="n">CommandId</span><span class="w"> </span><span class="n">cid</span><span class="p">,</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">options</span><span class="p">,</span>
<span class="w">  </span><span class="n">BulkInsertState</span><span class="w"> </span><span class="n">bistate</span><span class="p">,</span>
<span class="w">  </span><span class="n">uint32</span><span class="w"> </span><span class="n">specToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">memam_tuple_complete_speculative</span><span class="p">(</span>
<span class="w">  </span><span class="n">Relation</span><span class="w"> </span><span class="n">relation</span><span class="p">,</span>
<span class="w">  </span><span class="n">TupleTableSlot</span><span class="w"> </span><span class="o">*</span><span class="n">slot</span><span class="p">,</span>
<span class="w">  </span><span class="n">uint32</span><span class="w"> </span><span class="n">specToken</span><span class="p">,</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">succeeded</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">memam_multi_insert</span><span class="p">(</span>
<span class="w">  </span><span class="n">Relation</span><span class="w"> </span><span class="n">relation</span><span class="p">,</span>
<span class="w">  </span><span class="n">TupleTableSlot</span><span class="w"> </span><span class="o">**</span><span class="n">slots</span><span class="p">,</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ntuples</span><span class="p">,</span>
<span class="w">  </span><span class="n">CommandId</span><span class="w"> </span><span class="n">cid</span><span class="p">,</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">options</span><span class="p">,</span>
<span class="w">  </span><span class="n">BulkInsertState</span><span class="w"> </span><span class="n">bistate</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">TM_Result</span><span class="w"> </span><span class="nf">memam_tuple_delete</span><span class="p">(</span>
<span class="w">  </span><span class="n">Relation</span><span class="w"> </span><span class="n">relation</span><span class="p">,</span>
<span class="w">  </span><span class="n">ItemPointer</span><span class="w"> </span><span class="n">tid</span><span class="p">,</span>
<span class="w">  </span><span class="n">CommandId</span><span class="w"> </span><span class="n">cid</span><span class="p">,</span>
<span class="w">  </span><span class="n">Snapshot</span><span class="w"> </span><span class="n">snapshot</span><span class="p">,</span>
<span class="w">  </span><span class="n">Snapshot</span><span class="w"> </span><span class="n">crosscheck</span><span class="p">,</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">wait</span><span class="p">,</span>
<span class="w">  </span><span class="n">TM_FailureData</span><span class="w"> </span><span class="o">*</span><span class="n">tmfd</span><span class="p">,</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">changingPart</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">TM_Result</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">TM_Result</span><span class="w"> </span><span class="nf">memam_tuple_update</span><span class="p">(</span>
<span class="w">  </span><span class="n">Relation</span><span class="w"> </span><span class="n">relation</span><span class="p">,</span>
<span class="w">  </span><span class="n">ItemPointer</span><span class="w"> </span><span class="n">otid</span><span class="p">,</span>
<span class="w">  </span><span class="n">TupleTableSlot</span><span class="w"> </span><span class="o">*</span><span class="n">slot</span><span class="p">,</span>
<span class="w">  </span><span class="n">CommandId</span><span class="w"> </span><span class="n">cid</span><span class="p">,</span>
<span class="w">  </span><span class="n">Snapshot</span><span class="w"> </span><span class="n">snapshot</span><span class="p">,</span>
<span class="w">  </span><span class="n">Snapshot</span><span class="w"> </span><span class="n">crosscheck</span><span class="p">,</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">wait</span><span class="p">,</span>
<span class="w">  </span><span class="n">TM_FailureData</span><span class="w"> </span><span class="o">*</span><span class="n">tmfd</span><span class="p">,</span>
<span class="w">  </span><span class="n">LockTupleMode</span><span class="w"> </span><span class="o">*</span><span class="n">lockmode</span><span class="p">,</span>
<span class="w">  </span><span class="n">TU_UpdateIndexes</span><span class="w"> </span><span class="o">*</span><span class="n">update_indexes</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">TM_Result</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">TM_Result</span><span class="w"> </span><span class="nf">memam_tuple_lock</span><span class="p">(</span>
<span class="w">  </span><span class="n">Relation</span><span class="w"> </span><span class="n">relation</span><span class="p">,</span>
<span class="w">  </span><span class="n">ItemPointer</span><span class="w"> </span><span class="n">tid</span><span class="p">,</span>
<span class="w">  </span><span class="n">Snapshot</span><span class="w"> </span><span class="n">snapshot</span><span class="p">,</span>
<span class="w">  </span><span class="n">TupleTableSlot</span><span class="w"> </span><span class="o">*</span><span class="n">slot</span><span class="p">,</span>
<span class="w">  </span><span class="n">CommandId</span><span class="w"> </span><span class="n">cid</span><span class="p">,</span>
<span class="w">  </span><span class="n">LockTupleMode</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span>
<span class="w">  </span><span class="n">LockWaitPolicy</span><span class="w"> </span><span class="n">wait_policy</span><span class="p">,</span>
<span class="w">  </span><span class="n">uint8</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span>
<span class="w">  </span><span class="n">TM_FailureData</span><span class="w"> </span><span class="o">*</span><span class="n">tmfd</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">TM_Result</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">memam_fetch_row_version</span><span class="p">(</span>
<span class="w">  </span><span class="n">Relation</span><span class="w"> </span><span class="n">relation</span><span class="p">,</span>
<span class="w">  </span><span class="n">ItemPointer</span><span class="w"> </span><span class="n">tid</span><span class="p">,</span>
<span class="w">  </span><span class="n">Snapshot</span><span class="w"> </span><span class="n">snapshot</span><span class="p">,</span>
<span class="w">  </span><span class="n">TupleTableSlot</span><span class="w"> </span><span class="o">*</span><span class="n">slot</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">memam_get_latest_tid</span><span class="p">(</span>
<span class="w">  </span><span class="n">TableScanDesc</span><span class="w"> </span><span class="n">sscan</span><span class="p">,</span>
<span class="w">  </span><span class="n">ItemPointer</span><span class="w"> </span><span class="n">tid</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">memam_tuple_tid_valid</span><span class="p">(</span><span class="n">TableScanDesc</span><span class="w"> </span><span class="n">scan</span><span class="p">,</span><span class="w"> </span><span class="n">ItemPointer</span><span class="w"> </span><span class="n">tid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">memam_tuple_satisfies_snapshot</span><span class="p">(</span>
<span class="w">  </span><span class="n">Relation</span><span class="w"> </span><span class="n">rel</span><span class="p">,</span>
<span class="w">  </span><span class="n">TupleTableSlot</span><span class="w"> </span><span class="o">*</span><span class="n">slot</span><span class="p">,</span>
<span class="w">  </span><span class="n">Snapshot</span><span class="w"> </span><span class="n">snapshot</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">TransactionId</span><span class="w"> </span><span class="nf">memam_index_delete_tuples</span><span class="p">(</span>
<span class="w">  </span><span class="n">Relation</span><span class="w"> </span><span class="n">rel</span><span class="p">,</span>
<span class="w">  </span><span class="n">TM_IndexDeleteOp</span><span class="w"> </span><span class="o">*</span><span class="n">delstate</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">TransactionId</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">memam_relation_set_new_filelocator</span><span class="p">(</span>
<span class="w">  </span><span class="n">Relation</span><span class="w"> </span><span class="n">rel</span><span class="p">,</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">RelFileLocator</span><span class="w"> </span><span class="o">*</span><span class="n">newrlocator</span><span class="p">,</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">persistence</span><span class="p">,</span>
<span class="w">  </span><span class="n">TransactionId</span><span class="w"> </span><span class="o">*</span><span class="n">freezeXid</span><span class="p">,</span>
<span class="w">  </span><span class="n">MultiXactId</span><span class="w"> </span><span class="o">*</span><span class="n">minmulti</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">memam_relation_nontransactional_truncate</span><span class="p">(</span>
<span class="w">  </span><span class="n">Relation</span><span class="w"> </span><span class="n">rel</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">memam_relation_copy_data</span><span class="p">(</span>
<span class="w">  </span><span class="n">Relation</span><span class="w"> </span><span class="n">rel</span><span class="p">,</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">RelFileLocator</span><span class="w"> </span><span class="o">*</span><span class="n">newrlocator</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">memam_relation_copy_for_cluster</span><span class="p">(</span>
<span class="w">  </span><span class="n">Relation</span><span class="w"> </span><span class="n">OldHeap</span><span class="p">,</span>
<span class="w">  </span><span class="n">Relation</span><span class="w"> </span><span class="n">NewHeap</span><span class="p">,</span>
<span class="w">  </span><span class="n">Relation</span><span class="w"> </span><span class="n">OldIndex</span><span class="p">,</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">use_sort</span><span class="p">,</span>
<span class="w">  </span><span class="n">TransactionId</span><span class="w"> </span><span class="n">OldestXmin</span><span class="p">,</span>
<span class="w">  </span><span class="n">TransactionId</span><span class="w"> </span><span class="o">*</span><span class="n">xid_cutoff</span><span class="p">,</span>
<span class="w">  </span><span class="n">MultiXactId</span><span class="w"> </span><span class="o">*</span><span class="n">multi_cutoff</span><span class="p">,</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">num_tuples</span><span class="p">,</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">tups_vacuumed</span><span class="p">,</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">tups_recently_dead</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">memam_vacuum_rel</span><span class="p">(</span>
<span class="w">  </span><span class="n">Relation</span><span class="w"> </span><span class="n">rel</span><span class="p">,</span>
<span class="w">  </span><span class="n">VacuumParams</span><span class="w"> </span><span class="o">*</span><span class="n">params</span><span class="p">,</span>
<span class="w">  </span><span class="n">BufferAccessStrategy</span><span class="w"> </span><span class="n">bstrategy</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">memam_scan_analyze_next_block</span><span class="p">(</span>
<span class="w">  </span><span class="n">TableScanDesc</span><span class="w"> </span><span class="n">scan</span><span class="p">,</span>
<span class="w">  </span><span class="n">BlockNumber</span><span class="w"> </span><span class="n">blockno</span><span class="p">,</span>
<span class="w">  </span><span class="n">BufferAccessStrategy</span><span class="w"> </span><span class="n">bstrategy</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">memam_scan_analyze_next_tuple</span><span class="p">(</span>
<span class="w">  </span><span class="n">TableScanDesc</span><span class="w"> </span><span class="n">scan</span><span class="p">,</span>
<span class="w">  </span><span class="n">TransactionId</span><span class="w"> </span><span class="n">OldestXmin</span><span class="p">,</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">liverows</span><span class="p">,</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">deadrows</span><span class="p">,</span>
<span class="w">  </span><span class="n">TupleTableSlot</span><span class="w"> </span><span class="o">*</span><span class="n">slot</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nf">memam_index_build_range_scan</span><span class="p">(</span>
<span class="w">  </span><span class="n">Relation</span><span class="w"> </span><span class="n">heapRelation</span><span class="p">,</span>
<span class="w">  </span><span class="n">Relation</span><span class="w"> </span><span class="n">indexRelation</span><span class="p">,</span>
<span class="w">  </span><span class="n">IndexInfo</span><span class="w"> </span><span class="o">*</span><span class="n">indexInfo</span><span class="p">,</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">allow_sync</span><span class="p">,</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">anyvisible</span><span class="p">,</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">progress</span><span class="p">,</span>
<span class="w">  </span><span class="n">BlockNumber</span><span class="w"> </span><span class="n">start_blockno</span><span class="p">,</span>
<span class="w">  </span><span class="n">BlockNumber</span><span class="w"> </span><span class="n">numblocks</span><span class="p">,</span>
<span class="w">  </span><span class="n">IndexBuildCallback</span><span class="w"> </span><span class="n">callback</span><span class="p">,</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">callback_state</span><span class="p">,</span>
<span class="w">  </span><span class="n">TableScanDesc</span><span class="w"> </span><span class="n">scan</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">memam_index_validate_scan</span><span class="p">(</span>
<span class="w">  </span><span class="n">Relation</span><span class="w"> </span><span class="n">heapRelation</span><span class="p">,</span>
<span class="w">  </span><span class="n">Relation</span><span class="w"> </span><span class="n">indexRelation</span><span class="p">,</span>
<span class="w">  </span><span class="n">IndexInfo</span><span class="w"> </span><span class="o">*</span><span class="n">indexInfo</span><span class="p">,</span>
<span class="w">  </span><span class="n">Snapshot</span><span class="w"> </span><span class="n">snapshot</span><span class="p">,</span>
<span class="w">  </span><span class="n">ValidateIndexState</span><span class="w"> </span><span class="o">*</span><span class="n">state</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">memam_relation_needs_toast_table</span><span class="p">(</span><span class="n">Relation</span><span class="w"> </span><span class="n">rel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">Oid</span><span class="w"> </span><span class="nf">memam_relation_toast_am</span><span class="p">(</span><span class="n">Relation</span><span class="w"> </span><span class="n">rel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Oid</span><span class="w"> </span><span class="n">oid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">oid</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">memam_fetch_toast_slice</span><span class="p">(</span>
<span class="w">  </span><span class="n">Relation</span><span class="w"> </span><span class="n">toastrel</span><span class="p">,</span>
<span class="w">  </span><span class="n">Oid</span><span class="w"> </span><span class="n">valueid</span><span class="p">,</span>
<span class="w">  </span><span class="n">int32</span><span class="w"> </span><span class="n">attrsize</span><span class="p">,</span>
<span class="w">  </span><span class="n">int32</span><span class="w"> </span><span class="n">sliceoffset</span><span class="p">,</span>
<span class="w">  </span><span class="n">int32</span><span class="w"> </span><span class="n">slicelength</span><span class="p">,</span>
<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">varlena</span><span class="w"> </span><span class="o">*</span><span class="n">result</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">memam_estimate_rel_size</span><span class="p">(</span>
<span class="w">  </span><span class="n">Relation</span><span class="w"> </span><span class="n">rel</span><span class="p">,</span>
<span class="w">  </span><span class="n">int32</span><span class="w"> </span><span class="o">*</span><span class="n">attr_widths</span><span class="p">,</span>
<span class="w">  </span><span class="n">BlockNumber</span><span class="w"> </span><span class="o">*</span><span class="n">pages</span><span class="p">,</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">tuples</span><span class="p">,</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">allvisfrac</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">memam_scan_sample_next_block</span><span class="p">(</span>
<span class="w">  </span><span class="n">TableScanDesc</span><span class="w"> </span><span class="n">scan</span><span class="p">,</span><span class="w"> </span><span class="n">SampleScanState</span><span class="w"> </span><span class="o">*</span><span class="n">scanstate</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">memam_scan_sample_next_tuple</span><span class="p">(</span>
<span class="w">  </span><span class="n">TableScanDesc</span><span class="w"> </span><span class="n">scan</span><span class="p">,</span>
<span class="w">  </span><span class="n">SampleScanState</span><span class="w"> </span><span class="o">*</span><span class="n">scanstate</span><span class="p">,</span>
<span class="w">  </span><span class="n">TupleTableSlot</span><span class="w"> </span><span class="o">*</span><span class="n">slot</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span><span class="w"> </span><span class="n">TableAmRoutine</span><span class="w"> </span><span class="n">memam_methods</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T_TableAmRoutine</span><span class="p">,</span>

<span class="w">  </span><span class="p">.</span><span class="n">slot_callbacks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_slot_callbacks</span><span class="p">,</span>

<span class="w">  </span><span class="p">.</span><span class="n">scan_begin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_beginscan</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">scan_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_endscan</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">scan_rescan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_rescan</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">scan_getnextslot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_getnextslot</span><span class="p">,</span>

<span class="w">  </span><span class="p">.</span><span class="n">parallelscan_estimate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">table_block_parallelscan_estimate</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">parallelscan_initialize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">table_block_parallelscan_initialize</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">parallelscan_reinitialize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">table_block_parallelscan_reinitialize</span><span class="p">,</span>

<span class="w">  </span><span class="p">.</span><span class="n">index_fetch_begin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_index_fetch_begin</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">index_fetch_reset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_index_fetch_reset</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">index_fetch_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_index_fetch_end</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">index_fetch_tuple</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_index_fetch_tuple</span><span class="p">,</span>

<span class="w">  </span><span class="p">.</span><span class="n">tuple_insert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_tuple_insert</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">tuple_insert_speculative</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_tuple_insert_speculative</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">tuple_complete_speculative</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_tuple_complete_speculative</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">multi_insert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_multi_insert</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">tuple_delete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_tuple_delete</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">tuple_update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_tuple_update</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">tuple_lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_tuple_lock</span><span class="p">,</span>

<span class="w">  </span><span class="p">.</span><span class="n">tuple_fetch_row_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_fetch_row_version</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">tuple_get_latest_tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_get_latest_tid</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">tuple_tid_valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_tuple_tid_valid</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">tuple_satisfies_snapshot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_tuple_satisfies_snapshot</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">index_delete_tuples</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_index_delete_tuples</span><span class="p">,</span>

<span class="w">  </span><span class="p">.</span><span class="n">relation_set_new_filelocator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_relation_set_new_filelocator</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">relation_nontransactional_truncate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_relation_nontransactional_truncate</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">relation_copy_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_relation_copy_data</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">relation_copy_for_cluster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_relation_copy_for_cluster</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">relation_vacuum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_vacuum_rel</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">scan_analyze_next_block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_scan_analyze_next_block</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">scan_analyze_next_tuple</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_scan_analyze_next_tuple</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">index_build_range_scan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_index_build_range_scan</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">index_validate_scan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_index_validate_scan</span><span class="p">,</span>

<span class="w">  </span><span class="p">.</span><span class="n">relation_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">table_block_relation_size</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">relation_needs_toast_table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_relation_needs_toast_table</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">relation_toast_am</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_relation_toast_am</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">relation_fetch_toast_slice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_fetch_toast_slice</span><span class="p">,</span>

<span class="w">  </span><span class="p">.</span><span class="n">relation_estimate_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_estimate_rel_size</span><span class="p">,</span>

<span class="w">  </span><span class="p">.</span><span class="n">scan_sample_next_block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_scan_sample_next_block</span><span class="p">,</span>
<span class="w">  </span><span class="p">.</span><span class="n">scan_sample_next_tuple</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memam_scan_sample_next_tuple</span>
<span class="p">};</span>

<span class="n">PG_FUNCTION_INFO_V1</span><span class="p">(</span><span class="n">mem_tableam_handler</span><span class="p">);</span>

<span class="n">Datum</span><span class="w"> </span><span class="nf">mem_tableam_handler</span><span class="p">(</span><span class="n">PG_FUNCTION_ARGS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">PG_RETURN_POINTER</span><span class="p">(</span><span class="o">&amp;</span><span class="n">memam_methods</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>Let's build and test it!</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>make<span class="w"> </span>install
<span class="gp">$ </span>/usr/local/pgsql/bin/psql<span class="w"> </span>postgres<span class="w"> </span>-f<span class="w"> </span>test.sql
<span class="go">psql:test.sql:1: NOTICE:  drop cascades to table x</span>
<span class="go">DROP EXTENSION</span>
<span class="go">CREATE EXTENSION</span>
<span class="go">CREATE TABLE</span>
</pre></div>
<p>Hey we're getting somewhere! It successfully created the table with
our custom table access method.</p>
<h3 id="querying-rows">Querying rows</h3><p>Next, let's try querying the table by adding a <code>SELECT a FROM x</code> to
<code>test.sql</code> and running it:</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>/usr/local/pgsql/bin/psql<span class="w"> </span>postgres<span class="w"> </span>-f<span class="w"> </span>test.sql
<span class="go">psql:test.sql:1: NOTICE:  drop cascades to table x</span>
<span class="go">DROP EXTENSION</span>
<span class="go">CREATE EXTENSION</span>
<span class="go">CREATE TABLE</span>
<span class="go">psql:test.sql:6: server closed the connection unexpectedly</span>
<span class="go">        This probably means the server terminated abnormally</span>
<span class="go">        before or while processing the request.</span>
<span class="go">psql:test.sql:6: error: connection to server was lost</span>
</pre></div>
<p>This time there's nothing in <code>logfile</code> that helps:</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>tail<span class="w"> </span>-n15<span class="w"> </span>logfile
<span class="go">2023-11-01 18:43:32.449 UTC [2906199] LOG:  database system is ready to accept connections</span>
<span class="go">2023-11-01 18:58:32.572 UTC [2907997] LOG:  checkpoint starting: time</span>
<span class="go">2023-11-01 18:58:35.305 UTC [2907997] LOG:  checkpoint complete: wrote 28 buffers (0.2%); 0 WAL file(s) added, 0 removed, 0 recycled; write=2.712 s, sync=0.015 s, total=2.733 s; sync files=23, longest=0.004 s, average=0.001 s; distance=128 kB, estimate=150 kB; lsn=0/15F88E0, redo lsn=0/15F8888</span>
<span class="go">2023-11-01 19:08:14.485 UTC [2906199] LOG:  server process (PID 2908242) was terminated by signal 11: Segmentation fault</span>
<span class="go">2023-11-01 19:08:14.485 UTC [2906199] DETAIL:  Failed process was running: SELECT a FROM x;</span>
<span class="go">2023-11-01 19:08:14.485 UTC [2906199] LOG:  terminating any other active server processes</span>
<span class="go">2023-11-01 19:08:14.486 UTC [2906199] LOG:  all server processes terminated; reinitializing</span>
<span class="go">2023-11-01 19:08:14.508 UTC [2908253] LOG:  database system was interrupted; last known up at 2023-11-01 18:58:35 UTC</span>
<span class="go">2023-11-01 19:08:14.518 UTC [2908253] LOG:  database system was not properly shut down; automatic recovery in progress</span>
<span class="go">2023-11-01 19:08:14.519 UTC [2908253] LOG:  redo starts at 0/15F8888</span>
<span class="go">2023-11-01 19:08:14.520 UTC [2908253] LOG:  invalid record length at 0/161DE70: expected at least 24, got 0</span>
<span class="go">2023-11-01 19:08:14.520 UTC [2908253] LOG:  redo done at 0/161DE38 system usage: CPU: user: 0.00 s, system: 0.00 s, elapsed: 0.00 s</span>
<span class="go">2023-11-01 19:08:14.521 UTC [2908254] LOG:  checkpoint starting: end-of-recovery immediate wait</span>
<span class="go">2023-11-01 19:08:14.532 UTC [2908254] LOG:  checkpoint complete: wrote 35 buffers (0.2%); 0 WAL file(s) added, 0 removed, 0 recycled; write=0.001 s, sync=0.010 s, total=0.012 s; sync files=27, longest=0.003 s, average=0.001 s; distance=149 kB, estimate=149 kB; lsn=0/161DE70, redo lsn=0/161DE70</span>
<span class="go">2023-11-01 19:08:14.533 UTC [2906199] LOG:  database system is ready to accept connections</span>
</pre></div>
<p>This was the first place I got stuck. How on earth do I figure out
what methods to implement? I mean, it's clearly one or more of these
methods from the struct. But there are so many methods.</p>
<p>I tried setting a breakpoint in <code>gdb</code> on the process returned by
<code>SELECT pg_backend_pid()</code> for a <code>psql</code> session, but the breakpoint
never seemed to be hit for any of my methods.</p>
<p>So I did the low-tech solution and opened a file, <code>/tmp/pgtam.log</code>,
turned off buffering on it, and added a log to every method on the
<code>TableAmRoutine</code> struct:</p>
<div class="highlight"><pre><span></span><span class="gu">@@ -12,9 +12,13 @@</span>

<span class="w"> </span>const TableAmRoutine memam_methods;

<span class="gi">+FILE* fd;</span>
<span class="gi">+#define DEBUG_FUNC() fprintf(fd, &quot;in %s\n&quot;, __func__);</span>
<span class="gi">+</span>
<span class="w"> </span>static const TupleTableSlotOps* memam_slot_callbacks(
<span class="w"> </span>  Relation relation
<span class="w"> </span>) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>  return NULL;
<span class="w"> </span>}

<span class="gu">@@ -26,6 +30,7 @@</span>
<span class="w"> </span>  ParallelTableScanDesc parallel_scan,
<span class="w"> </span>  uint32 flags
<span class="w"> </span>) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>  return NULL;
<span class="w"> </span>}

<span class="gu">@@ -37,9 +42,11 @@</span>
<span class="w"> </span>  bool allow_sync,
<span class="w"> </span>  bool allow_pagemode
<span class="w"> </span>) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>}

<span class="w"> </span>static void memam_endscan(TableScanDesc sscan) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>}

<span class="w"> </span>static bool memam_getnextslot(
<span class="gu">@@ -47,17 +54,21 @@</span>
<span class="w"> </span>  ScanDirection direction,
<span class="w"> </span>  TupleTableSlot *slot
<span class="w"> </span>) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>  return false;
<span class="w"> </span>}

<span class="w"> </span>static IndexFetchTableData* memam_index_fetch_begin(Relation rel) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>  return NULL;
<span class="w"> </span>}

<span class="w"> </span>static void memam_index_fetch_reset(IndexFetchTableData *scan) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>}

<span class="w"> </span>static void memam_index_fetch_end(IndexFetchTableData *scan) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>}

<span class="w"> </span>static bool memam_index_fetch_tuple(
<span class="gu">@@ -68,6 +79,7 @@</span>
<span class="w"> </span>  bool *call_again,
<span class="w"> </span>  bool *all_dead
<span class="w"> </span>) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>  return false;
<span class="w"> </span>}

<span class="gu">@@ -78,6 +90,7 @@</span>
<span class="w"> </span>  int options,
<span class="w"> </span>  BulkInsertState bistate
<span class="w"> </span>) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>}

<span class="w"> </span>static void memam_tuple_insert_speculative(
<span class="gu">@@ -87,6 +100,7 @@</span>
<span class="w"> </span>  int options,
<span class="w"> </span>  BulkInsertState bistate,
<span class="w"> </span>  uint32 specToken) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>}

<span class="w"> </span>static void memam_tuple_complete_speculative(
<span class="gu">@@ -94,6 +108,7 @@</span>
<span class="w"> </span>  TupleTableSlot *slot,
<span class="w"> </span>  uint32 specToken,
<span class="w"> </span>  bool succeeded) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>}

<span class="w"> </span>static void memam_multi_insert(
<span class="gu">@@ -104,6 +119,7 @@</span>
<span class="w"> </span>  int options,
<span class="w"> </span>  BulkInsertState bistate
<span class="w"> </span>) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>}

<span class="w"> </span>static TM_Result memam_tuple_delete(
<span class="gu">@@ -117,6 +133,7 @@</span>
<span class="w"> </span>  bool changingPart
<span class="w"> </span>) {
<span class="w"> </span>  TM_Result result = {};
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>  return result;
<span class="w"> </span>}

<span class="gu">@@ -133,6 +150,7 @@</span>
<span class="w"> </span>  TU_UpdateIndexes *update_indexes
<span class="w"> </span>) {
<span class="w"> </span>  TM_Result result = {};
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>  return result;
<span class="w"> </span>}

<span class="gu">@@ -148,6 +166,7 @@</span>
<span class="w"> </span>  TM_FailureData *tmfd)
<span class="w"> </span>{
<span class="w"> </span>  TM_Result result = {};
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>  return result;
<span class="w"> </span>}

<span class="gu">@@ -157,6 +176,7 @@</span>
<span class="w"> </span>  Snapshot snapshot,
<span class="w"> </span>  TupleTableSlot *slot
<span class="w"> </span>) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>  return false;
<span class="w"> </span>}

<span class="gu">@@ -164,9 +184,11 @@</span>
<span class="w"> </span>  TableScanDesc sscan,
<span class="w"> </span>  ItemPointer tid
<span class="w"> </span>) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>}

<span class="w"> </span>static bool memam_tuple_tid_valid(TableScanDesc scan, ItemPointer tid) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>  return false;
<span class="w"> </span>}

<span class="gu">@@ -175,6 +197,7 @@</span>
<span class="w"> </span>  TupleTableSlot *slot,
<span class="w"> </span>  Snapshot snapshot
<span class="w"> </span>) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>  return false;
<span class="w"> </span>}

<span class="gu">@@ -183,6 +206,7 @@</span>
<span class="w"> </span>  TM_IndexDeleteOp *delstate
<span class="w"> </span>) {
<span class="w"> </span>  TransactionId id = {};
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>  return id;
<span class="w"> </span>}

<span class="gu">@@ -193,17 +217,20 @@</span>
<span class="w"> </span>  TransactionId *freezeXid,
<span class="w"> </span>  MultiXactId *minmulti
<span class="w"> </span>) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>}

<span class="w"> </span>static void memam_relation_nontransactional_truncate(
<span class="w"> </span>  Relation rel
<span class="w"> </span>) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>}

<span class="w"> </span>static void memam_relation_copy_data(
<span class="w"> </span>  Relation rel,
<span class="w"> </span>  const RelFileLocator *newrlocator
<span class="w"> </span>) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>}

<span class="w"> </span>static void memam_relation_copy_for_cluster(
<span class="gu">@@ -218,6 +245,7 @@</span>
<span class="w"> </span>  double *tups_vacuumed,
<span class="w"> </span>  double *tups_recently_dead
<span class="w"> </span>) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>}

<span class="w"> </span>static void memam_vacuum_rel(
<span class="gu">@@ -225,6 +253,7 @@</span>
<span class="w"> </span>  VacuumParams *params,
<span class="w"> </span>  BufferAccessStrategy bstrategy
<span class="w"> </span>) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>}

<span class="w"> </span>static bool memam_scan_analyze_next_block(
<span class="gu">@@ -232,6 +261,7 @@</span>
<span class="w"> </span>  BlockNumber blockno,
<span class="w"> </span>  BufferAccessStrategy bstrategy
<span class="w"> </span>) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>  return false;
<span class="w"> </span>}

<span class="gu">@@ -242,6 +272,7 @@</span>
<span class="w"> </span>  double *deadrows,
<span class="w"> </span>  TupleTableSlot *slot
<span class="w"> </span>) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>  return false;
<span class="w"> </span>}

<span class="gu">@@ -258,6 +289,7 @@</span>
<span class="w"> </span>  void *callback_state,
<span class="w"> </span>  TableScanDesc scan
<span class="w"> </span>) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>  return 0;
<span class="w"> </span>}

<span class="gu">@@ -268,14 +300,17 @@</span>
<span class="w"> </span>  Snapshot snapshot,
<span class="w"> </span>  ValidateIndexState *state
<span class="w"> </span>) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>}

<span class="w"> </span>static bool memam_relation_needs_toast_table(Relation rel) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>  return false;
<span class="w"> </span>}

<span class="w"> </span>static Oid memam_relation_toast_am(Relation rel) {
<span class="w"> </span>  Oid oid = {};
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>  return oid;
<span class="w"> </span>}

<span class="gu">@@ -287,6 +322,7 @@</span>
<span class="w"> </span>  int32 slicelength,
<span class="w"> </span>  struct varlena *result
<span class="w"> </span>) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>}

<span class="w"> </span>static void memam_estimate_rel_size(
<span class="gu">@@ -296,11 +332,13 @@</span>
<span class="w"> </span>  double *tuples,
<span class="w"> </span>  double *allvisfrac
<span class="w"> </span>) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>}

<span class="w"> </span>static bool memam_scan_sample_next_block(
<span class="w"> </span>  TableScanDesc scan, SampleScanState *scanstate
<span class="w"> </span>) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>  return false;
<span class="w"> </span>}

<span class="gu">@@ -309,6 +347,7 @@</span>
<span class="w"> </span>  SampleScanState *scanstate,
<span class="w"> </span>  TupleTableSlot *slot
<span class="w"> </span>) {
<span class="gi">+  DEBUG_FUNC();</span>
<span class="w"> </span>  return false;
<span class="w"> </span>}
</pre></div>
<p>And then in the entrypoint, initialize the file for logging.</p>
<div class="highlight"><pre><span></span><span class="gu">@@ -369,5 +408,9 @@</span>
<span class="w"> </span>PG_FUNCTION_INFO_V1(mem_tableam_handler);

<span class="w"> </span>Datum mem_tableam_handler(PG_FUNCTION_ARGS) {
<span class="gi">+  fd = fopen(&quot;/tmp/pgtam.log&quot;, &quot;a&quot;);</span>
<span class="gi">+  setvbuf(fd, NULL, _IONBF, 0); // Prevent buffering</span>
<span class="gi">+  fprintf(fd, &quot;\n\nmem_tableam handler loaded\n&quot;);</span>
<span class="gi">+</span>
<span class="w"> </span>  PG_RETURN_POINTER(&amp;memam_methods);
<span class="w"> </span>}
</pre></div>
<p>Let's give it a shot!</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>make<span class="w"> </span>install
<span class="gp">$ </span>/usr/local/pgsql/bin/psql<span class="w"> </span>postgres<span class="w"> </span>-f<span class="w"> </span>test.sql
<span class="go">psql:test.sql:1: NOTICE:  drop cascades to table x</span>
<span class="go">DROP EXTENSION</span>
<span class="go">CREATE EXTENSION</span>
<span class="go">CREATE TABLE</span>
<span class="go">psql:test.sql:6: server closed the connection unexpectedly</span>
<span class="go">        This probably means the server terminated abnormally</span>
<span class="go">        before or while processing the request.</span>
<span class="go">psql:test.sql:6: error: connection to server was lost</span>
</pre></div>
<p>And let's check our log file:</p>
<div class="highlight"><pre><span></span><span class="o">$</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">pgtam</span><span class="o">.</span><span class="n">log</span>


<span class="n">mem_tableam</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="n">loaded</span>


<span class="n">mem_tableam</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="n">loaded</span>
<span class="ow">in</span><span class="w"> </span><span class="n">memam_relation_set_new_filelocator</span>


<span class="n">mem_tableam</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="n">loaded</span>
<span class="ow">in</span><span class="w"> </span><span class="n">memam_relation_needs_toast_table</span>


<span class="n">mem_tableam</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="n">loaded</span>
<span class="ow">in</span><span class="w"> </span><span class="n">memam_estimate_rel_size</span>
<span class="ow">in</span><span class="w"> </span><span class="n">memam_slot_callbacks</span>
</pre></div>
<p>Now we're getting somewhere!</p>
<p class="note">
  I later realized <code>elog()</code> is the way most people log
  within Postgres/within extensions. I didn't know that when I was
  getting started though. This separate logging was a simple way to
  get the info out.
</p><h4 id="<code>slot_callbacks</code>"><code>slot_callbacks</code></h4><p>Since the request crashes and the last logged function is
<code>memam_slot_callbacks</code>, it seems like that is where we should
concentrate. The <a href="https://www.postgresql.org/docs/current/tableam.html">table access method
docs</a> suggest
looking at the default <code>heap</code> access method for inspiration.</p>
<p>Its
<a href="https://github.com/postgres/postgres/blob/849172ff4883d44168f96f39d3fde96d0aa34c99/src/backend/access/heap/heapam_handler.c#L67">version</a>
of <code>slot_callbacks</code> returns <code>&amp;TTSOpsBufferHeapTuple</code>:</p>
<div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">TupleTableSlotOps</span><span class="w"> </span><span class="o">*</span>
<span class="nf">heapam_slot_callbacks</span><span class="p">(</span><span class="n">Relation</span><span class="w"> </span><span class="n">relation</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="n">TTSOpsBufferHeapTuple</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>I have no idea what that means, but since it is defined in
<a href="https://github.com/postgres/postgres/blob/849172ff4883d44168f96f39d3fde96d0aa34c99/src/backend/executor/execTuples.c#L1080"><code>src/backend/executor/execTuples.c</code></a>
it doesn't seem to be tied to the <code>heap</code> access method
implementation. Let's try it.</p>
<p class="note">
  While it works initially, I noticed later on that
  <code>TTSOpsBufferHeapTuple</code> turns out not to be the right
  choice here. <code>TTSOpsVirtual</code> seems to be the right
  implementation.
</p><div class="highlight"><pre><span></span><span class="gu">@@ -19,7 +19,7 @@</span>
<span class="w"> </span>  Relation relation
<span class="w"> </span>) {
<span class="w"> </span>  DEBUG_FUNC();
<span class="gd">-  return NULL;</span>
<span class="gi">+  return &amp;TTSOpsVirtual;</span>
<span class="w"> </span>}

<span class="w"> </span>static TableScanDesc memam_beginscan(
</pre></div>
<p>Build and run:</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>make<span class="w"> </span>install
<span class="gp">$ </span>/usr/local/pgsql/bin/psql<span class="w"> </span>postgres<span class="w"> </span>-f<span class="w"> </span>test.sql
<span class="go">psql:test.sql:1: NOTICE:  drop cascades to table x</span>
<span class="go">DROP EXTENSION</span>
<span class="go">CREATE EXTENSION</span>
<span class="go">CREATE TABLE</span>
<span class="go">psql:test.sql:6: server closed the connection unexpectedly</span>
<span class="go">        This probably means the server terminated abnormally</span>
<span class="go">        before or while processing the request.</span>
<span class="go">psql:test.sql:6: error: connection to server was lost</span>
</pre></div>
<p>It still crashes. But this time in <code>/tmp/pgtam.log</code> we made it into a
new method!</p>
<div class="highlight"><pre><span></span><span class="n">$</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">pgtam</span><span class="p">.</span><span class="n">log</span>


<span class="n">mem_tableam</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="n">loaded</span>


<span class="n">mem_tableam</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="n">loaded</span>
<span class="n">in</span><span class="w"> </span><span class="n">memam_relation_set_new_filelocator</span>


<span class="n">mem_tableam</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="n">loaded</span>
<span class="n">in</span><span class="w"> </span><span class="n">memam_relation_needs_toast_table</span>


<span class="n">mem_tableam</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="n">loaded</span>
<span class="n">in</span><span class="w"> </span><span class="n">memam_estimate_rel_size</span>
<span class="n">in</span><span class="w"> </span><span class="n">memam_slot_callbacks</span>
<span class="n">in</span><span class="w"> </span><span class="n">memam_beginscan</span>
</pre></div>
<h4 id="<code>scan_begin</code>"><code>scan_begin</code></h4><p>The function signature is:</p>
<div class="highlight"><pre><span></span><span class="n">TableScanDesc</span><span class="w"> </span><span class="nf">heap_beginscan</span><span class="p">(</span>
<span class="w">  </span><span class="n">Relation</span><span class="w"> </span><span class="n">relation</span><span class="p">,</span>
<span class="w">  </span><span class="n">Snapshot</span><span class="w"> </span><span class="n">snapshot</span><span class="p">,</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">nkeys</span><span class="p">,</span>
<span class="w">  </span><span class="n">ScanKey</span><span class="w"> </span><span class="n">key</span><span class="p">,</span>
<span class="w">  </span><span class="n">ParallelTableScanDesc</span><span class="w"> </span><span class="n">parallel_scan</span><span class="p">,</span>
<span class="w">  </span><span class="n">uint32</span><span class="w"> </span><span class="n">flags</span>
<span class="p">);</span>
</pre></div>
<p>Since we just implemented stub versions of all the methods, we've been
returning <code>NULL</code>. Since we're failing in this function, maybe we
should try returning something that isn't <code>NULL</code>.</p>
<p>By looking at the definition of <code>TableScanDesc</code>, we can see it is a
pointer to the <code>TableScanDescData</code> struct defined in
<a href="https://github.com/postgres/postgres/blob/849172ff4883d44168f96f39d3fde96d0aa34c99/src/include/access/relscan.h#L52"><code>src/include/access/relscan.h</code></a>.</p>
<p>Let's <code>malloc</code> a <code>TableScanDescData</code>, free it in <code>endscan</code>, and return
the <code>TableScanDescData</code> instance in <code>beginscan</code>:</p>
<div class="highlight"><pre><span></span><span class="gu">@@ -30,8 +30,12 @@</span>
<span class="w"> </span>  ParallelTableScanDesc parallel_scan,
<span class="w"> </span>  uint32 flags
<span class="w"> </span>) {
<span class="gi">+  TableScanDescData* scan = {};</span>
<span class="w"> </span>  DEBUG_FUNC();
<span class="gd">-  return NULL;</span>
<span class="gi">+</span>
<span class="gi">+  scan = (TableScanDescData*)malloc(sizeof(TableScanDescData));</span>
<span class="gi">+</span>
<span class="gi">+  return (TableScanDesc)scan;</span>
<span class="w"> </span>}

<span class="w"> </span>static void memam_rescan(
<span class="gu">@@ -87,6 +87,7 @@</span>

<span class="w"> </span>static void memam_endscan(TableScanDesc sscan) {
<span class="w"> </span>  DEBUG_FUNC();
<span class="gi">+  free(sscan);</span>
<span class="w"> </span>}
</pre></div>
<p>Build and run (you can do it on your own). No difference.</p>
<p>I got stuck for a while here too. Clearly something must be filled out
in this struct but it could be anything. Through trial and error I
realized the one field that must be filled out is <code>scan-&gt;rs_rd</code>.</p>
<div class="highlight"><pre><span></span><span class="gu">@@ -34,6 +34,7 @@</span>
<span class="w"> </span>  DEBUG_FUNC();

<span class="w"> </span>  scan = (TableScanDescData*)malloc(sizeof(TableScanDescData));
<span class="gi">+  scan-&gt;rs_rd = relation;</span>

<span class="w"> </span>  return (TableScanDesc)scan;
<span class="w"> </span>}
</pre></div>
<p>We build and run:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>make<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>make<span class="w"> </span>install
$<span class="w"> </span>/usr/local/pgsql/bin/psql<span class="w"> </span>postgres<span class="w"> </span>-f<span class="w"> </span>test.sql
psql:test.sql:1:<span class="w"> </span>NOTICE:<span class="w">  </span>drop<span class="w"> </span>cascades<span class="w"> </span>to<span class="w"> </span>table<span class="w"> </span>x
DROP<span class="w"> </span>EXTENSION
CREATE<span class="w"> </span>EXTENSION
CREATE<span class="w"> </span>TABLE
<span class="w"> </span>a
---
<span class="o">(</span><span class="m">0</span><span class="w"> </span>rows<span class="o">)</span>
</pre></div>
<p>And it works! It doesn't return anything but that's correct. There's
nothing to return.</p>
<p>So what if we actually want to return something? Let's check our logs
in <code>/tmp/pgtam.log</code>.</p>
<div class="highlight"><pre><span></span><span class="o">$</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">pgtam</span><span class="o">.</span><span class="n">log</span>


<span class="n">mem_tableam</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="n">loaded</span>


<span class="n">mem_tableam</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="n">loaded</span>
<span class="ow">in</span><span class="w"> </span><span class="n">memam_relation_set_new_filelocator</span>


<span class="n">mem_tableam</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="n">loaded</span>
<span class="ow">in</span><span class="w"> </span><span class="n">memam_relation_needs_toast_table</span>


<span class="n">mem_tableam</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="n">loaded</span>
<span class="ow">in</span><span class="w"> </span><span class="n">memam_estimate_rel_size</span>
<span class="ow">in</span><span class="w"> </span><span class="n">memam_slot_callbacks</span>
<span class="ow">in</span><span class="w"> </span><span class="n">memam_beginscan</span>
<span class="ow">in</span><span class="w"> </span><span class="n">memam_getnextslot</span>
<span class="ow">in</span><span class="w"> </span><span class="n">memam_endscan</span>
</pre></div>
<p>Ok, I'm getting the gist of the API. A full table scan (which this is,
because there are no indexes at play) starts with an initialization
for a slot, then the scan begins, then <code>getnextslot</code> is called for
each row, and then <code>endscan</code> is called to allow for cleanup.</p>
<p>So let's try returning a row in <code>getnextslot</code>.</p>
<h4 id="<code>getnextslot</code>"><code>getnextslot</code></h4><p>The <code>getnextslot</code> signature is:</p>
<div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="nf">memam_getnextslot</span><span class="p">(</span>
<span class="w">  </span><span class="n">TableScanDesc</span><span class="w"> </span><span class="n">sscan</span><span class="p">,</span>
<span class="w">  </span><span class="n">ScanDirection</span><span class="w"> </span><span class="n">direction</span><span class="p">,</span>
<span class="w">  </span><span class="n">TupleTableSlot</span><span class="w"> </span><span class="o">*</span><span class="n">slot</span>
<span class="p">);</span>
</pre></div>
<p>So the <code>sscan</code> should be what we returned from <code>beginscan</code> and the
<a href="https://github.com/postgres/postgres/blob/849172ff4883d44168f96f39d3fde96d0aa34c99/src/include/access/tableam.h#L341">interface
docs</a>
say the current row gets stored in <code>slot</code>.</p>
<p class="note">
  The return value seems to indicate whether or not we've reached the
  end of the scan. However, the scan will still end even if you
  <code>return true</code> if the <code>slot</code> is not filled out correctly. If the
  <code>slot</code> is filled out correctly and you unconditionally <code>return
  true</code>, you will crash the process.
</p><p>Let's take a look at the
<a href="https://github.com/postgres/postgres/blob/849172ff4883d44168f96f39d3fde96d0aa34c99/src/include/executor/tuptable.h#L114">definition</a>
of <code>TupleTableSlot</code>:</p>
<div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">TupleTableSlot</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">NodeTag</span><span class="w">     </span><span class="n">type</span><span class="p">;</span>
<span class="cp">#define FIELDNO_TUPLETABLESLOT_FLAGS 1</span>
<span class="w">    </span><span class="n">uint16</span><span class="w">      </span><span class="n">tts_flags</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Boolean states */</span>
<span class="cp">#define FIELDNO_TUPLETABLESLOT_NVALID 2</span>
<span class="w">    </span><span class="n">AttrNumber</span><span class="w">  </span><span class="n">tts_nvalid</span><span class="p">;</span><span class="w">     </span><span class="cm">/* # of valid values in tts_values */</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">TupleTableSlotOps</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">tts_ops</span><span class="p">;</span><span class="w"> </span><span class="cm">/* implementation of slot */</span>
<span class="cp">#define FIELDNO_TUPLETABLESLOT_TUPLEDESCRIPTOR 4</span>
<span class="w">    </span><span class="n">TupleDesc</span><span class="w">   </span><span class="n">tts_tupleDescriptor</span><span class="p">;</span><span class="w">    </span><span class="cm">/* slot&#39;s tuple descriptor */</span>
<span class="cp">#define FIELDNO_TUPLETABLESLOT_VALUES 5</span>
<span class="w">    </span><span class="n">Datum</span><span class="w">      </span><span class="o">*</span><span class="n">tts_values</span><span class="p">;</span><span class="w">     </span><span class="cm">/* current per-attribute values */</span>
<span class="cp">#define FIELDNO_TUPLETABLESLOT_ISNULL 6</span>
<span class="w">    </span><span class="kt">bool</span><span class="w">       </span><span class="o">*</span><span class="n">tts_isnull</span><span class="p">;</span><span class="w">     </span><span class="cm">/* current per-attribute isnull flags */</span>
<span class="w">    </span><span class="n">MemoryContext</span><span class="w"> </span><span class="n">tts_mcxt</span><span class="p">;</span><span class="w">     </span><span class="cm">/* slot itself is in this context */</span>
<span class="w">    </span><span class="n">ItemPointerData</span><span class="w"> </span><span class="n">tts_tid</span><span class="p">;</span><span class="w">    </span><span class="cm">/* stored tuple&#39;s tid */</span>
<span class="w">    </span><span class="n">Oid</span><span class="w">         </span><span class="n">tts_tableOid</span><span class="p">;</span><span class="w">   </span><span class="cm">/* table oid of tuple */</span>
<span class="p">}</span><span class="w"> </span><span class="n">TupleTableSlot</span><span class="p">;</span>
</pre></div>
<p><code>tts_values</code> is an array of <code>Datum</code> (which is a Postgres value). So
that sounds like the actual values of the row. The <code>tts_isnull</code> field
also looks important since that seems to be whether each value in the
row is null or not. And <code>tts_nvalid</code> sounds important too since
presumably it's the length of the <code>tts_isnull</code> and <code>tts_values</code>
arrays.</p>
<p>The rest of it may or may not be important. Let's try filling out
these three fields though and see what happens.</p>
<h4 id="datum">Datum</h4><p>Back in the <a href="https://www.postgresql.org/docs/current/xfunc-c.html">Postgres C extension
documentation</a>,
we can see some simple examples of converting between C types and
Postgres's Datum type.</p>
<p>For example:</p>
<div class="highlight"><pre><span></span><span class="n">Datum</span>
<span class="nf">add_one</span><span class="p">(</span><span class="n">PG_FUNCTION_ARGS</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">int32</span><span class="w">   </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PG_GETARG_INT32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="n">PG_RETURN_INT32</span><span class="p">(</span><span class="n">arg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>If we look at the definition of <code>PG_RETURN_INT32</code> in
<a href="https://github.com/postgres/postgres/blob/849172ff4883d44168f96f39d3fde96d0aa34c99/src/include/fmgr.h#L354"><code>src/include/fmgr.h</code></a>,
we see:</p>
<div class="highlight"><pre><span></span><span class="cp">#define PG_RETURN_INT32(x)   return Int32GetDatum(x)</span>
</pre></div>
<p>So <code>Int32GetDatum()</code> is the function we'll use to set a <code>Datum</code> for a
cell in a row.</p>
<div class="highlight"><pre><span></span><span class="gu">@@ -54,13 +54,26 @@</span>
<span class="w"> </span>  DEBUG_FUNC();
<span class="w"> </span>}

<span class="gi">+static bool done = false;</span>
<span class="w"> </span>static bool memam_getnextslot(
<span class="w"> </span>  TableScanDesc sscan,
<span class="w"> </span>  ScanDirection direction,
<span class="w"> </span>  TupleTableSlot *slot
<span class="w"> </span>) {
<span class="w"> </span>  DEBUG_FUNC();
<span class="gd">-  return false;</span>
<span class="gi">+</span>
<span class="gi">+  if (done) {</span>
<span class="gi">+    return false;</span>
<span class="gi">+  }</span>
<span class="gi">+</span>
<span class="gi">+  slot-&gt;tts_nvalid = 1;</span>
<span class="gi">+  slot-&gt;tts_values = (Datum*)malloc(sizeof(Datum) * slot-&gt;tts_nvalid);</span>
<span class="gi">+  slot-&gt;tts_values[0] = Int32GetDatum(314 /* Some unique-looking value */);</span>
<span class="gi">+  slot-&gt;tts_isnull = (bool*)malloc(sizeof(bool) * slot-&gt;tts_nvalid);</span>
<span class="gi">+  slot-&gt;tts_isnull[0] = false;</span>
<span class="gi">+  done = true;</span>
<span class="gi">+</span>
<span class="gi">+  return true;</span>
<span class="w"> </span>}

<span class="w"> </span>static IndexFetchTableData* memam_index_fetch_begin(Relation rel) {
</pre></div>
<p>The goal is that we return a single row and then exit the scan. It
will have one 32-bit integer cell (remember we created the table
<code>CREATE TABLE x (a INT)</code>; <code>INT</code> is shorthand for <code>INT4</code> which is a
32-bit integer) that will have the value <code>314</code>.</p>
<p>But if we build and run this, we get no rows.</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>make<span class="w"> </span>install
<span class="gp">$ </span>/usr/local/pgsql/bin/psql<span class="w"> </span>postgres<span class="w"> </span>-f<span class="w"> </span>test.sql
<span class="go">psql:test.sql:1: NOTICE:  drop cascades to table x</span>
<span class="go">DROP EXTENSION</span>
<span class="go">CREATE EXTENSION</span>
<span class="go">CREATE TABLE</span>
<span class="go"> a</span>
<span class="go">---</span>
<span class="gp gp-VirtualEnv">(0 rows)</span>
</pre></div>
<p>I got stuck for a while here. Plugging my <code>getnextslot</code> code into
ChatGPT helped. One thing it gave me to try was calling
<code>ExecStoreVirtualTuple</code> on the <code>slot</code>. I noticed that the built-in
<code>heap</code> access method <a href="https://github.com/postgres/postgres/blob/849172ff4883d44168f96f39d3fde96d0aa34c99/src/backend/access/heap/heapam.c#L1159">also called a function like
this</a>
in <code>getnextslot</code>.</p>
<p>And I realized that <code>tts_nvalid</code> is already set up and the memory for
<code>tts_values</code> and <code>tts_isnull</code> is already allocated. So the code became
a little simpler.</p>
<div class="highlight"><pre><span></span><span class="gu">@@ -66,11 +66,9 @@</span>
<span class="w"> </span>    return false;
<span class="w"> </span>  }

<span class="gd">-  slot-&gt;tts_nvalid = 1;</span>
<span class="gd">-  slot-&gt;tts_values = (Datum*)malloc(sizeof(Datum) * slot-&gt;tts_nvalid);</span>
<span class="w"> </span>  slot-&gt;tts_values[0] = Int32GetDatum(314 /* Some unique-looking value */);
<span class="gd">-  slot-&gt;tts_isnull = (bool*)malloc(sizeof(bool) * slot-&gt;tts_nvalid);</span>
<span class="w"> </span>  slot-&gt;tts_isnull[0] = false;
<span class="gi">+  ExecStoreVirtualTuple(slot);</span>
<span class="w"> </span>  done = true;

<span class="w"> </span>  return true;
</pre></div>
<p>Build and run:</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>make<span class="w"> </span>install
<span class="gp">$ </span>/usr/local/pgsql/bin/psql<span class="w"> </span>postgres<span class="w"> </span>-f<span class="w"> </span>test.sql
<span class="go">psql:test.sql:1: NOTICE:  drop cascades to table x</span>
<span class="go">DROP EXTENSION</span>
<span class="go">CREATE EXTENSION</span>
<span class="go">CREATE TABLE</span>
<span class="go">  a</span>
<span class="go">-----</span>
<span class="go"> 314</span>
<span class="gp gp-VirtualEnv">(1 row)</span>
</pre></div>
<p>Fantastic!</p>
<h3 id="creating-a-table">Creating a table</h3><p>Now that we've proven we can return random data, let's set up
infrastructure for storing tables in memory.</p>
<div class="highlight"><pre><span></span><span class="gu">@@ -15,6 +15,41 @@</span>
<span class="w"> </span>FILE* fd;
<span class="w"> </span>#define DEBUG_FUNC() fprintf(fd, &quot;in %s\n&quot;, __func__);

<span class="gi">+</span>
<span class="gi">+struct Column {</span>
<span class="gi">+  int value;</span>
<span class="gi">+};</span>
<span class="gi">+</span>
<span class="gi">+struct Row {</span>
<span class="gi">+  struct Column* columns;</span>
<span class="gi">+  size_t ncolumns;</span>
<span class="gi">+};</span>
<span class="gi">+</span>
<span class="gi">+#define MAX_ROWS 100</span>
<span class="gi">+struct Table {</span>
<span class="gi">+  char* name;</span>
<span class="gi">+  struct Row* rows;</span>
<span class="gi">+  size_t nrows;</span>
<span class="gi">+};</span>
<span class="gi">+</span>
<span class="gi">+#define MAX_TABLES 100</span>
<span class="gi">+struct Database {</span>
<span class="gi">+  struct Table* tables;</span>
<span class="gi">+  size_t ntables;</span>
<span class="gi">+};</span>
<span class="gi">+</span>
<span class="gi">+struct Database* database;</span>
<span class="gi">+</span>
<span class="gi">+static void get_table(struct Table** table, Relation relation) {</span>
<span class="gi">+  char* this_name = NameStr(relation-&gt;rd_rel-&gt;relname);</span>
<span class="gi">+  for (size_t i = 0; i &lt; database-&gt;ntables; i++) {</span>
<span class="gi">+    if (strcmp(database-&gt;tables[i].name, this_name) == 0) {</span>
<span class="gi">+      *table = &amp;database-&gt;tables[i];</span>
<span class="gi">+      return;</span>
<span class="gi">+    }</span>
<span class="gi">+  }</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="w"> </span>static const TupleTableSlotOps* memam_slot_callbacks(
<span class="w"> </span>  Relation relation
<span class="w"> </span>) {
</pre></div>
<p>Based on what we logged in <code>/tmp/pgtam.log</code> it seems like
<code>memam_relation_set_new_filelocator</code> is called when a new table is
created. So let's handle adding a new table there.</p>
<div class="highlight"><pre><span></span><span class="gu">@@ -233,7 +268,16 @@</span>
<span class="w"> </span>  TransactionId *freezeXid,
<span class="w"> </span>  MultiXactId *minmulti
<span class="w"> </span>) {
<span class="gi">+  struct Table table = {};</span>
<span class="w"> </span>  DEBUG_FUNC();
<span class="gi">+</span>
<span class="gi">+  table.name = strdup(NameStr(rel-&gt;rd_rel-&gt;relname));</span>
<span class="gi">+  fprintf(fd, &quot;Created table: [%s]\n&quot;, table.name);</span>
<span class="gi">+  table.rows = (struct Row*)malloc(sizeof(struct Row) * MAX_ROWS);</span>
<span class="gi">+  table.nrows = 0;</span>
<span class="gi">+</span>
<span class="gi">+  database-&gt;tables[database-&gt;ntables] = table;</span>
<span class="gi">+  database-&gt;ntables++;</span>
<span class="w"> </span>}

<span class="w"> </span>static void memam_relation_nontransactional_truncate(
</pre></div>
<p>Finally, we'll initialize the in-memory <code>Database*</code> when the handler is
loaded.</p>
<div class="highlight"><pre><span></span><span class="gu">@@ -428,5 +472,11 @@</span>
<span class="w"> </span>  setvbuf(fd, NULL, _IONBF, 0); // Prevent buffering
<span class="w"> </span>  fprintf(fd, &quot;\n\nmem_tableam handler loaded\n&quot;);

<span class="gi">+  if (database == NULL) {</span>
<span class="gi">+    database = (struct Database*)malloc(sizeof(struct Database));</span>
<span class="gi">+    database-&gt;ntables = 0;</span>
<span class="gi">+    database-&gt;tables = (struct Table*)malloc(sizeof(struct Table) * MAX_TABLES);</span>
<span class="gi">+  }</span>
<span class="gi">+</span>
<span class="w"> </span>  PG_RETURN_POINTER(&amp;memam_methods);
<span class="w"> </span>}
</pre></div>
<p>If we build and run, we won't notice anything new.</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>make<span class="w"> </span>install
<span class="gp">$ </span>/usr/local/pgsql/bin/psql<span class="w"> </span>postgres<span class="w"> </span>-f<span class="w"> </span>test.sql
<span class="go">psql:test.sql:1: NOTICE:  drop cascades to table x</span>
<span class="go">DROP EXTENSION</span>
<span class="go">CREATE EXTENSION</span>
<span class="go">CREATE TABLE</span>
<span class="go">  a</span>
<span class="go">-----</span>
<span class="go"> 314</span>
<span class="gp gp-VirtualEnv">(1 row)</span>
</pre></div>
<p>But we should see a message in <code>/tmp/pgtam.log</code> about the new table
being created.</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>/tmp/pgtam.log


<span class="go">mem_tableam handler loaded</span>


<span class="go">mem_tableam handler loaded</span>
<span class="go">in memam_relation_set_new_filelocator</span>
<span class="go">Created table: [x]</span>


<span class="go">mem_tableam handler loaded</span>
<span class="go">in memam_relation_needs_toast_table</span>


<span class="go">mem_tableam handler loaded</span>
<span class="go">in memam_estimate_rel_size</span>
<span class="go">in memam_slot_callbacks</span>
<span class="go">in memam_beginscan</span>
<span class="go">in memam_getnextslot</span>
<span class="go">in memam_getnextslot</span>
<span class="go">in memam_endscan</span>
</pre></div>
<p>And there it is! Creation looks good.</p>
<h3 id="inserting-rows">Inserting rows</h3><p>Let's add <code>INSERT INTO x VALUES (23), (101);</code> to <code>test.sql</code> and run
the SQL script.</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>/usr/local/pgsql/bin/psql<span class="w"> </span>postgres<span class="w"> </span>-f<span class="w"> </span>test.sql
<span class="go">psql:test.sql:1: NOTICE:  drop cascades to table x</span>
<span class="go">DROP EXTENSION</span>
<span class="go">CREATE EXTENSION</span>
<span class="go">CREATE TABLE</span>
<span class="go">INSERT 0 2</span>
<span class="go">  a</span>
<span class="go">-----</span>
<span class="go"> 314</span>
<span class="gp gp-VirtualEnv">(1 row)</span>
</pre></div>
<p>And let's check the log to see what method is called when we try to
<code>INSERT</code>.</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>/tmp/pgtam.log


<span class="go">mem_tableam handler loaded</span>


<span class="go">mem_tableam handler loaded</span>
<span class="go">in memam_relation_set_new_filelocator</span>
<span class="go">Created table: [x]</span>


<span class="go">mem_tableam handler loaded</span>
<span class="go">in memam_relation_needs_toast_table</span>


<span class="go">mem_tableam handler loaded</span>
<span class="go">in memam_slot_callbacks</span>
<span class="go">in memam_tuple_insert</span>
<span class="go">in memam_tuple_insert</span>
<span class="go">in memam_estimate_rel_size</span>
<span class="go">in memam_slot_callbacks</span>
<span class="go">in memam_beginscan</span>
<span class="go">in memam_getnextslot</span>
<span class="go">in memam_getnextslot</span>
<span class="go">in memam_endscan</span>
</pre></div>
<p><code>tuple_insert</code> seems to be the method! Looks like it gets called once
for each row to insert. Perfect.</p>
<p>The signature for <code>tuple_insert</code> is:</p>
<div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">memam_tuple_insert</span><span class="p">(</span>
<span class="w">  </span><span class="n">Relation</span><span class="w"> </span><span class="n">relation</span><span class="p">,</span>
<span class="w">  </span><span class="n">TupleTableSlot</span><span class="w"> </span><span class="o">*</span><span class="n">slot</span><span class="p">,</span>
<span class="w">  </span><span class="n">CommandId</span><span class="w"> </span><span class="n">cid</span><span class="p">,</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">options</span><span class="p">,</span>
<span class="w">  </span><span class="n">BulkInsertState</span><span class="w"> </span><span class="n">bistate</span>
<span class="p">);</span>
</pre></div>
<p>We can get the table name from <code>relation</code>, and instead of writing to
<code>slot</code> we can read from <code>slot-&gt;tts_values</code> instead.</p>
<div class="highlight"><pre><span></span><span class="gu">@@ -141,7 +141,38 @@</span>
<span class="w"> </span>  int options,
<span class="w"> </span>  BulkInsertState bistate
<span class="w"> </span>) {
<span class="gi">+  TupleDesc desc = RelationGetDescr(relation);</span>
<span class="gi">+  struct Table* table = NULL;</span>
<span class="gi">+  struct Column column = {};</span>
<span class="gi">+  struct Row row = {};</span>
<span class="gi">+</span>
<span class="w"> </span>  DEBUG_FUNC();
<span class="gi">+</span>
<span class="gi">+  get_table(&amp;table, relation);</span>
<span class="gi">+  if (table == NULL) {</span>
<span class="gi">+    elog(ERROR, &quot;table not found&quot;);</span>
<span class="gi">+    return;</span>
<span class="gi">+  }</span>
<span class="gi">+</span>
<span class="gi">+  if (table-&gt;nrows == MAX_ROWS) {</span>
<span class="gi">+    elog(ERROR, &quot;cannot insert more rows&quot;);</span>
<span class="gi">+    return;</span>
<span class="gi">+  }</span>
<span class="gi">+</span>
<span class="gi">+  row.ncolumns = desc-&gt;natts;</span>
<span class="gi">+  Assert(slot-&gt;tts_nvalid == row.ncolumns);</span>
<span class="gi">+  Assert(row.ncolumns &gt; 0);</span>
<span class="gi">+</span>
<span class="gi">+  row.columns = (struct Column*)malloc(sizeof(struct Column) * row.ncolumns);</span>
<span class="gi">+  for (size_t i = 0; i &lt; row.ncolumns; i++) {</span>
<span class="gi">+    Assert(desc-&gt;attrs[i].atttypid == INT4OID);</span>
<span class="gi">+    column.value = DatumGetInt32(slot-&gt;tts_values[i]);</span>
<span class="gi">+    row.columns[i] = column;</span>
<span class="gi">+    fprintf(fd, &quot;Got value: %d\n&quot;, column.value);</span>
<span class="gi">+  }</span>
<span class="gi">+</span>
<span class="gi">+  table-&gt;rows[table-&gt;nrows] = row;</span>
<span class="gi">+  table-&gt;nrows++;</span>
<span class="w"> </span>}

<span class="w"> </span>static void memam_tuple_insert_speculative(
</pre></div>
<p>Build and run and again we won't notice anything new.</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>make<span class="w"> </span>install
<span class="gp">$ </span>/usr/local/pgsql/bin/psql<span class="w"> </span>postgres<span class="w"> </span>-f<span class="w"> </span>test.sql
<span class="go">psql:test.sql:1: NOTICE:  drop cascades to table x</span>
<span class="go">DROP EXTENSION</span>
<span class="go">CREATE EXTENSION</span>
<span class="go">CREATE TABLE</span>
<span class="go">INSERT 0 2</span>
<span class="go">  a</span>
<span class="go">-----</span>
<span class="go"> 314</span>
<span class="gp gp-VirtualEnv">(1 row)</span>
</pre></div>
<p>But if we check the logs, we should see the two column values we
inserted, one for each row.</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>/tmp/pgtam.log


<span class="go">mem_tableam handler loaded</span>


<span class="go">mem_tableam handler loaded</span>
<span class="go">in memam_relation_set_new_filelocator</span>
<span class="go">Created table: [x]</span>


<span class="go">mem_tableam handler loaded</span>
<span class="go">in memam_relation_needs_toast_table</span>


<span class="go">mem_tableam handler loaded</span>
<span class="go">in memam_slot_callbacks</span>
<span class="go">in memam_tuple_insert</span>
<span class="go">Got value: 23</span>
<span class="go">in memam_tuple_insert</span>
<span class="go">Got value: 101</span>
<span class="go">in memam_estimate_rel_size</span>
<span class="go">in memam_slot_callbacks</span>
<span class="go">in memam_beginscan</span>
<span class="go">in memam_getnextslot</span>
<span class="go">in memam_getnextslot</span>
<span class="go">in memam_endscan</span>
</pre></div>
<p>Woohoo!</p>
<h3 id="un-hardcoding-the-scan">Un-hardcoding the scan</h3><p>The final thing we need to do is drop the hardcoded <code>314</code> we returned
from <code>getnextslot</code> and instead we need to look up the current table
and return rows from it. This also means we need to keep track of
which row we're on. So <code>beginscan</code> will also need to change slightly.</p>
<div class="highlight"><pre><span></span><span class="gu">@@ -57,6 +56,14 @@</span>
<span class="w"> </span>  return &amp;TTSOpsVirtual;
<span class="w"> </span>}

<span class="gi">+</span>
<span class="gi">+struct MemScanDesc {</span>
<span class="gi">+  TableScanDescData rs_base; // Base class from access/relscan.h.</span>
<span class="gi">+</span>
<span class="gi">+  // Custom data.</span>
<span class="gi">+  uint32 cursor;</span>
<span class="gi">+};</span>
<span class="gi">+</span>
<span class="w"> </span>static TableScanDesc memam_beginscan(
<span class="w"> </span>  Relation relation,
<span class="w"> </span>  Snapshot snapshot,
<span class="gu">@@ -65,11 +72,13 @@</span>
<span class="w"> </span>  ParallelTableScanDesc parallel_scan,
<span class="w"> </span>  uint32 flags
<span class="w"> </span>) {
<span class="gd">-  TableScanDescData* scan = {};</span>
<span class="gd">-  DEBUG_FUNC();</span>
<span class="gi">+  struct MemScanDesc* scan;</span>

<span class="gd">-  scan = (TableScanDescData*)malloc(sizeof(TableScanDescData));</span>
<span class="gd">-  scan-&gt;rs_rd = relation;</span>
<span class="gi">+  DEBUG_FUNC();</span>
<span class="gi">+</span>
<span class="gi">+  scan = (struct MemScanDesc*)malloc(sizeof(struct MemScanDesc));</span>
<span class="gi">+  scan-&gt;rs_base.rs_rd = relation;</span>
<span class="gi">+  scan-&gt;cursor = 0;</span>

<span class="w"> </span>  return (TableScanDesc)scan;
<span class="w"> </span>}
<span class="gu">@@ -89,23 +97,26 @@</span>
<span class="w"> </span>  DEBUG_FUNC();
<span class="w"> </span>}

<span class="gd">-static bool done = false;</span>
<span class="w"> </span>static bool memam_getnextslot(
<span class="w"> </span>  TableScanDesc sscan,
<span class="w"> </span>  ScanDirection direction,
<span class="w"> </span>  TupleTableSlot *slot
<span class="w"> </span>) {
<span class="gi">+  struct MemScanDesc* mscan = (struct MemScanDesc*)sscan;</span>
<span class="gi">+  struct Table* table = NULL;</span>
<span class="w"> </span>  DEBUG_FUNC();

<span class="gd">-  if (done) {</span>
<span class="gi">+  ExecClearTuple(slot);</span>
<span class="gi">+</span>
<span class="gi">+  get_table(&amp;table, mscan-&gt;rs_base.rs_rd);</span>
<span class="gi">+  if (table == NULL || mscan-&gt;cursor == table-&gt;nrows) {</span>
<span class="w"> </span>    return false;
<span class="w"> </span>  }

<span class="gd">-  slot-&gt;tts_values[0] = Int32GetDatum(314 /* Some unique-looking value */);</span>
<span class="gi">+  slot-&gt;tts_values[0] = Int32GetDatum(table-&gt;rows[mscan-&gt;cursor].columns[0].value);</span>
<span class="w"> </span>  slot-&gt;tts_isnull[0] = false;
<span class="w"> </span>  ExecStoreVirtualTuple(slot);
<span class="gd">-  done = true;</span>
<span class="gd">-</span>
<span class="gi">+  mscan-&gt;cursor++;</span>
<span class="w"> </span>  return true;
<span class="w"> </span>}
</pre></div>
<p>Let's try it out.</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>make<span class="w"> </span>install
<span class="gp">$ </span>/usr/local/pgsql/bin/psql<span class="w"> </span>postgres<span class="w"> </span>-f<span class="w"> </span>test.sql
<span class="go">psql:test.sql:1: NOTICE:  drop cascades to table x</span>
<span class="go">DROP EXTENSION</span>
<span class="go">CREATE EXTENSION</span>
<span class="go">CREATE TABLE</span>
<span class="go">INSERT 0 2</span>
<span class="go">  a</span>
<span class="go">-----</span>
<span class="go">  23</span>
<span class="go"> 101</span>
<span class="gp gp-VirtualEnv">(2 rows)</span>
</pre></div>
<p>And there we have it. :)</p>
<h3 id="awesome-sql-power">Awesome SQL power</h3><p>So we tried one table and we tried a <code>SELECT</code> without anything else.</p>
<p>What happens if we use more of SQL? Let's create another table
and try some more complex queries. Edit <code>test.sql</code>:</p>
<div class="highlight"><pre><span></span><span class="k">DROP</span><span class="w"> </span><span class="n">EXTENSION</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">pgtam</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">;</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">EXTENSION</span><span class="w"> </span><span class="n">pgtam</span><span class="p">;</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">x</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="nb">INT</span><span class="p">)</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">mem</span><span class="p">;</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">y</span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="nb">INT</span><span class="p">)</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">mem</span><span class="p">;</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">23</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">101</span><span class="p">);</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">23</span><span class="p">;</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
</pre></div>
<p>Run it:</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>/usr/local/pgsql/bin/psql<span class="w"> </span>postgres<span class="w"> </span>-f<span class="w"> </span>test.sql
<span class="go">psql:test.sql:1: NOTICE:  drop cascades to 2 other objects</span>
<span class="go">DETAIL:  drop cascades to table x</span>
<span class="go">drop cascades to table y</span>
<span class="go">DROP EXTENSION</span>
<span class="go">CREATE EXTENSION</span>
<span class="go">CREATE TABLE</span>
<span class="go">CREATE TABLE</span>
<span class="go">INSERT 0 2</span>
<span class="go">  a</span>
<span class="go">-----</span>
<span class="go">  23</span>
<span class="go"> 101</span>
<span class="gp gp-VirtualEnv">(2 rows)</span>

<span class="go"> ?column?</span>
<span class="go">----------</span>
<span class="go">      123</span>
<span class="gp gp-VirtualEnv">(1 row)</span>

<span class="go">  a  | count</span>
<span class="go">-----+-------</span>
<span class="go">  23 |     1</span>
<span class="go"> 101 |     1</span>
<span class="gp gp-VirtualEnv">(2 rows)</span>

<span class="go"> b</span>
<span class="go">---</span>
<span class="gp gp-VirtualEnv">(0 rows)</span>
</pre></div>
<p>Pretty sweet!</p>
<h3 id="next-steps">Next steps</h3><p>It would be neat to build a storage engine that reads from and writes
to a CSV a la MySQL's CSV storage engine. Or a storage engine that
uses RocksDB.</p>
<p>It would also be good to figure out how indexes work, how deletions
work, how updates and DDL beyond <code>CREATE</code> works.</p>
<p>And I should probably contribute some of this to the <a href="https://www.postgresql.org/docs/current/tableam.html">table access
method</a> docs
which are pretty sparse at the moment.</p>
<p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">I&#39;ve been working this week to understand Postgres Table Access Methods for alternative storage engines.<br><br>Especially challenging because the documentation is pretty sparse and few minimal implementations exist.<br><br>I wrote up my approach!<a href="https://t.co/LQGglRkev5">https://t.co/LQGglRkev5</a> <a href="https://t.co/v0MeOu4Hbr">pic.twitter.com/v0MeOu4Hbr</a></p>&mdash; Phil Eaton (@eatonphil) <a href="https://twitter.com/eatonphil/status/1719873793693221157?ref_src=twsrc%5Etfw">November 2, 2023</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<style>.feedback{display:initial;}</style>
	<div class="feedback">
	  <h4>Feedback</h4>
	  <p>As always,
	      please <a href="mailto:phil@eatonphil.com">email</a>
	      or <a href="https://twitter.com/eatonphil">tweet me</a>
	      with questions, corrections, or ideas!</p>

	</div>
      </div>
    </div>
    <footer>
      <div class="container">
	<div>
	  <div class="row">
	    <div class="feedback">
	      <h4>Frequent Topics</h4>
	      <div class="tags"><a href="/tags/javascript.html" class="tag">javascript (24)</a><a href="/tags/go.html" class="tag">go (24)</a><a href="/tags/databases.html" class="tag">databases (24)</a><a href="/tags/parsing.html" class="tag">parsing (21)</a><a href="/tags/postgres.html" class="tag">postgres (18)</a><a href="/tags/compilers.html" class="tag">compilers (14)</a><a href="/tags/sql.html" class="tag">sql (11)</a><a href="/tags/interpreters.html" class="tag">interpreters (11)</a><a href="/tags/zig.html" class="tag">zig (9)</a><a href="/tags/lisp.html" class="tag">lisp (9)</a><a href="/tags/books.html" class="tag">books (9)</a><a href="/tags/python.html" class="tag">python (8)</a><a href="/tags/linux.html" class="tag">linux (7)</a><a href="/tags/learning.html" class="tag">learning (7)</a><a href="/tags/json.html" class="tag">json (7)</a><a href="/tags/x86-amd64.html" class="tag">x86/amd64 (6)</a><a href="/tags/scheme.html" class="tag">scheme (6)</a><a href="/tags/c.html" class="tag">c (6)</a><a href="/tags/typescript.html" class="tag">typescript (5)</a><a href="/tags/mysql.html" class="tag">mysql (5)</a></div>
	    </div>
	  </div>
	  <div id="subscribe">
	    <style type="text/css">
  /* LOADER */
  .ml-form-embedSubmitLoad {
      display: inline-block;
      width: 20px;
      height: 20px;
  }
  .g-recaptcha {
      transform: scale(1);
      -webkit-transform: scale(1);
      transform-origin: 0 0;
      -webkit-transform-origin: 0 0;
      height: ;
  }
  .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      border: 0;
  }
  .ml-form-embedSubmitLoad:after {
      content: " ";
      display: block;
      width: 11px;
      height: 11px;
      margin: 1px;
      border-radius: 50%;
      border: 4px solid #fff;
      border-color: #ffffff #ffffff #ffffff transparent;
      animation: ml-form-embedSubmitLoad 1.2s linear infinite;
  }
  @keyframes ml-form-embedSubmitLoad {
      0% {
          transform: rotate(0deg);
      }
      100% {
          transform: rotate(360deg);
      }
  }
  #mlb2-3175296.ml-form-embedContainer {
      box-sizing: border-box;
      display: table;
      margin: 0 auto;
      position: static;
      width: 100% !important;
  }
  #mlb2-3175296.ml-form-embedContainer h3,
  #mlb2-3175296.ml-form-embedContainer p,
  #mlb2-3175296.ml-form-embedContainer span,
  #mlb2-3175296.ml-form-embedContainer button {
      text-transform: none !important;
      letter-spacing: normal !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper {
      border-width: 0px;
      border-color: transparent;
  border-radius: 4px;
  border-style: solid;
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  position: relative;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-align-left { text-align: left; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-align-center {
  text-align: center;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-align-default { display: table-cell !important; vertical-align: middle !important; text-align: center !important; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-align-right { text-align: right; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedHeader img {
  border-top-left-radius: 4px;
  border-top-right-radius: 4px;
  height: auto;
  margin: 0 auto !important;
  max-width: 100%;
  width: undefinedpx;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody.ml-form-embedBodyHorizontal {
  padding-bottom: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent {
  text-align: left;
  margin: 0 0 20px 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent p,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent p {
  color: #000000;
  font-size: 14px;
  font-weight: 400;
  line-height: 20px;
  margin: 0 0 10px 0;
  text-align: left;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent ul,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent ol,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent ul,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent ol {
  color: #000000;
  font-size: 14px;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent ol ol,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent ol ol {
  list-style-type: lower-alpha;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent ol ol ol,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent ol ol ol {
  list-style-type: lower-roman;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent p a,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent p a {
  color: #000000;
  text-decoration: underline;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-block-form .ml-field-group {
  text-align: left!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-block-form .ml-field-group label {
  margin-bottom: 5px;
  color: #333333;
  font-size: 14px;
  font-weight: bold; font-style: normal; text-decoration: none;;
  display: inline-block;
  line-height: 20px;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent p:last-child,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent p:last-child {
  margin: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody form {
  margin: 0;
  width: 100%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-formContent,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow {
  margin: 0 0 20px 0;
  width: 100%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow {
  float: left;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-formContent.horozintalForm {
  margin: 0;
  padding: 0 0 20px 0;
  width: 100%;
  height: auto;
  float: left;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow {
  margin: 0 0 10px 0;
  width: 100%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow.ml-last-item {
  margin: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow.ml-formfieldHorizintal {
  margin: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input {
  background-color: #ffffff !important;
  color: #333333 !important;
  border-color: #cccccc;
  border-radius: 4px !important;
  border-style: solid !important;
  border-width: 1px !important;
  font-size: 14px !important;
  height: auto;
  line-height: 21px !important;
  margin-bottom: 0;
  margin-top: 0;
  margin-left: 0;
  margin-right: 0;
  padding: 10px 10px !important;
  width: 100% !important;
  box-sizing: border-box !important;
  max-width: 100% !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input::-webkit-input-placeholder,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input::-webkit-input-placeholder { color: #333333; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input::-moz-placeholder,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input::-moz-placeholder { color: #333333; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input:-ms-input-placeholder,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input:-ms-input-placeholder { color: #333333; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input:-moz-placeholder,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input:-moz-placeholder { color: #333333; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow textarea, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow textarea {
  background-color: #ffffff !important;
  color: #333333 !important;
  border-color: #cccccc;
  border-radius: 4px !important;
  border-style: solid !important;
  border-width: 1px !important;
  font-size: 14px !important;
  height: auto;
  line-height: 21px !important;
  margin-bottom: 0;
  margin-top: 0;
  padding: 10px 10px !important;
  width: 100% !important;
  box-sizing: border-box !important;
  max-width: 100% !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before {
  border-color: #cccccc!important;
  background-color: #ffffff!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input.custom-control-input[type="checkbox"]{
  box-sizing: border-box;
  padding: 0;
  position: absolute;
  z-index: -1;
  opacity: 0;
  margin-top: 5px;
  margin-left: -1.5rem;
  overflow: visible;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before {
  border-radius: 4px!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow input[type=checkbox]:checked~.label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox input[type=checkbox]:checked~.label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-input:checked~.custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-input:checked~.custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox input[type=checkbox]:checked~.label-description::after {
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23fff' d='M6.564.75l-3.59 3.612-1.538-1.55L0 4.26 2.974 7.25 8 2.193z'/%3e%3c/svg%3e");
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-input:checked~.custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-input:checked~.custom-control-label::after {
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e");
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-input:checked~.custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-input:checked~.custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-input:checked~.custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-input:checked~.custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox input[type=checkbox]:checked~.label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox input[type=checkbox]:checked~.label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow input[type=checkbox]:checked~.label-description::before  {
  border-color: #000000!important;
  background-color: #000000!important;
  color: #ffffff!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label::after {
  top: 2px;
  box-sizing: border-box;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::after {
  top: 0px!important;
  box-sizing: border-box!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::after {
  top: 0px!important;
  box-sizing: border-box!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::after {
  top: 0px!important;
  box-sizing: border-box!important;
  position: absolute;
  left: -1.5rem;
  display: block;
  width: 1rem;
  height: 1rem;
  content: "";
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::before {
  top: 0px!important;
  box-sizing: border-box!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .custom-control-label::before {
  position: absolute;
  top: 4px;
  left: -1.5rem;
  display: block;
  width: 16px;
  height: 16px;
  pointer-events: none;
  content: "";
  background-color: #ffffff;
  border: #adb5bd solid 1px;
  border-radius: 50%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .custom-control-label::after {
  position: absolute;
  top: 2px!important;
  left: -1.5rem;
  display: block;
  width: 1rem;
  height: 1rem;
  content: "";
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before {
  position: absolute;
  top: 4px;
  left: -1.5rem;
  display: block;
  width: 16px;
  height: 16px;
  pointer-events: none;
  content: "";
  background-color: #ffffff;
  border: #adb5bd solid 1px;
  border-radius: 50%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::after {
  position: absolute;
  top: 0px!important;
  left: -1.5rem;
  display: block;
  width: 1rem;
  height: 1rem;
  content: "";
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::after {
  position: absolute;
  top: 0px!important;
  left: -1.5rem;
  display: block;
  width: 1rem;
  height: 1rem;
  content: "";
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .custom-radio .custom-control-label::after {
  background: no-repeat 50%/50% 50%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .custom-checkbox .custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::after {
  background: no-repeat 50%/50% 50%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-control, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-control {
  position: relative;
  display: block;
  min-height: 1.5rem;
  padding-left: 1.5rem;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-input, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-input, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-input, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-input {
  position: absolute;
  z-index: -1;
  opacity: 0;
  box-sizing: border-box;
  padding: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-label, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-label, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label {
  color: #000000;
  font-size: 12px!important;
  line-height: 22px;
  margin-bottom: 0;
  position: relative;
  vertical-align: top;
  font-style: normal;
  font-weight: 700;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-select, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-select {
  background-color: #ffffff !important;
  color: #333333 !important;
  border-color: #cccccc;
  border-radius: 4px !important;
  border-style: solid !important;
  border-width: 1px !important;
  font-size: 14px !important;
  line-height: 20px !important;
  margin-bottom: 0;
  margin-top: 0;
  padding: 10px 28px 10px 12px !important;
  width: 100% !important;
  box-sizing: border-box !important;
  max-width: 100% !important;
  height: auto;
  display: inline-block;
  vertical-align: middle;
  background: url('https://assets.mlcdn.com/ml/images/default/dropdown.svg') no-repeat right .75rem center/8px 10px;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow {
  height: auto;
  width: 100%;
  float: left;
  }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-input-horizontal { width: 70%; float: left; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-button-horizontal { width: 30%; float: left; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-button-horizontal.labelsOn { padding-top: 25px;  }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .horizontal-fields { box-sizing: border-box; float: left; padding-right: 10px;  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input {
  background-color: #ffffff;
  color: #333333;
  border-color: #cccccc;
  border-radius: 4px;
  border-style: solid;
  border-width: 1px;
  font-size: 14px;
  line-height: 20px;
  margin-bottom: 0;
  margin-top: 0;
  padding: 10px 10px;
  width: 100%;
  box-sizing: border-box;
  overflow-y: initial;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow button {
  background-color: #000000 !important;
  border-color: #000000;
  border-style: solid;
  border-width: 1px;
  border-radius: 4px;
  box-shadow: none;
  color: #ffffff !important;
  cursor: pointer;
  font-size: 14px !important;
  font-weight: 700;
  line-height: 20px;
  margin: 0 !important;
  padding: 10px !important;
  width: 100%;
  height: auto;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow button:hover {
  background-color: #333333 !important;
  border-color: #333333 !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow input[type="checkbox"] {
  box-sizing: border-box;
  padding: 0;
  position: absolute;
  z-index: -1;
  opacity: 0;
  margin-top: 5px;
  margin-left: -1.5rem;
  overflow: visible;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description {
  color: #000000;
  display: block;
  font-size: 12px;
  text-align: left;
  margin-bottom: 0;
  position: relative;
  vertical-align: top;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow label {
  font-weight: normal;
  margin: 0;
  padding: 0;
  position: relative;
  display: block;
  min-height: 24px;
  padding-left: 24px;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow label a {
  color: #000000;
  text-decoration: underline;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow label p {
  color: #000000 !important;
  font-size: 12px !important;
  font-weight: normal !important;
  line-height: 18px !important;
  padding: 0 !important;
  margin: 0 5px 0 0 !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow label p:last-child {
  margin: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedSubmit {
  margin: 0 0 20px 0;
  float: left;
  width: 100%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedSubmit button {
  background-color: #000000 !important;
  border: none !important;
  border-radius: 4px !important;
  box-shadow: none !important;
  color: #ffffff !important;
  cursor: pointer;
  font-size: 14px !important;
  font-weight: 700 !important;
  line-height: 21px !important;
  height: auto;
  padding: 10px !important;
  width: 100% !important;
  box-sizing: border-box !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedSubmit button.loading {
  display: none;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedSubmit button:hover {
  background-color: #333333 !important;
  }
  .ml-subscribe-close {
  width: 30px;
  height: 30px;
  background: url('https://assets.mlcdn.com/ml/images/default/modal_close.png') no-repeat;
  background-size: 30px;
  cursor: pointer;
  margin-top: -10px;
  margin-right: -10px;
  position: absolute;
  top: 0;
  right: 0;
  }
  .ml-error input, .ml-error textarea, .ml-error select {
  border-color: red!important;
  }
  .ml-error .custom-checkbox-radio-list {
  border: 1px solid red !important;
  border-radius: 4px;
  padding: 10px;
  }
  .ml-error .label-description,
  .ml-error .label-description p,
  .ml-error .label-description p a,
  .ml-error label:first-child {
  color: #ff0000 !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow.ml-error .label-description p,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow.ml-error .label-description p:first-letter {
  color: #ff0000 !important;
  }
  @media only screen and (max-width: 400px){
  .ml-form-embedWrapper.embedDefault, .ml-form-embedWrapper.embedPopup { width: 100%!important; }
  .ml-form-formContent.horozintalForm { float: left!important; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow { height: auto!important; width: 100%!important; float: left!important; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-input-horizontal { width: 100%!important; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-input-horizontal > div { padding-right: 0px!important; padding-bottom: 10px; }
    .ml-form-formContent.horozintalForm .ml-button-horizontal { width: 100%!important; }
    .ml-form-formContent.horozintalForm .ml-button-horizontal.labelsOn { padding-top: 0px!important; }
    }
</style>
<div id="mlb2-3175296" class="ml-form-embedContainer ml-subscribe-form ml-subscribe-form-3175296">
  <hr />
  <div class="ml-form-align-center ">
    <div class="ml-form-embedWrapper embedForm">
      <div class="ml-form-embedBody ml-form-embedBodyDefault row-form">
        <div class="ml-form-embedContent" style=" ">
          <h4>Subscribe</h4>
          <p>Enter your email if you'd like to be kept in the loop about future articles!<br><br>You can expect 2 to 4 messages per month depending on how motivated I'm feeling. :)</p>
	  <p></p>
	  <p>Cheers,<br>Phil</p>
        </div>
        <form class="ml-block-form" action="https://assets.mailerlite.com/jsonp/303114/forms/78235486326359572/subscribe" data-code="" method="post" target="_blank">
          <div class="ml-form-formContent">
            <div class="ml-form-fieldRow ml-last-item">
              <div class="ml-field-group ml-field-email ml-validate-email ml-validate-required">
                <!-- input -->
                <input aria-label="email" aria-required="true" type="email" class="form-control" data-inputmask="" name="fields[email]" placeholder="Email" autocomplete="email">
                <!-- /input -->
                <!-- textarea -->
                <!-- /textarea -->
                <!-- select -->
                <!-- /select -->
                <!-- checkboxes -->
		<!-- /checkboxes -->
                <!-- radio -->
                <!-- /radio -->
                <!-- countries -->
                <!-- /countries -->
              </div>
            </div>
          </div>
          <!-- Privacy policy -->
          <!-- /Privacy policy -->
	  <div class="ml-form-recaptcha ml-validate-required" style="float: left;">
            <style type="text/css">
	      .ml-form-recaptcha {
		  margin-bottom: 20px;
	      }
	      .ml-form-recaptcha.ml-error iframe {
		  border: solid 1px #ff0000;
	      }
	      @media screen and (max-width: 480px) {
		  .ml-form-recaptcha {
		      width: 220px!important
		  }
		  .g-recaptcha {
		      transform: scale(0.78);
		      -webkit-transform: scale(0.78);
		      transform-origin: 0 0;
		      -webkit-transform-origin: 0 0;
		  }
	      }
	    </style>
	    <script src="https://www.google.com/recaptcha/api.js"></script>
	    <div class="g-recaptcha" data-sitekey="6Lf1KHQUAAAAAFNKEX1hdSWCS3mRMv4FlFaNslaD"></div>
	  </div>
          <input type="hidden" name="ml-submit" value="1">
          <div class="ml-form-embedSubmit">
            <button type="submit" class="primary">Subscribe</button>
            <button disabled="disabled" style="display: none;" type="button" class="loading">
              <div class="ml-form-embedSubmitLoad"></div>
              <span class="sr-only">Loading...</span>
            </button>
          </div>
          <input type="hidden" name="anticsrf" value="true">
        </form>
      </div>
      <div class="ml-form-successBody row-success" style="display: none">
        <div class="ml-form-successContent">
          <h3>Thanks :)</h3>
          <p>You're in.</p>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  function ml_webform_success_3175296() {
      var $ = ml_jQuery || jQuery;
      $('.ml-subscribe-form-3175296 .row-success').show();
      $('.ml-subscribe-form-3175296 .row-form').hide();
  }
</script>
<script src="https://groot.mailerlite.com/js/w/webforms.min.js?v300817f630ad0e957914d0b28a2b6d78" type="text/javascript"></script>

	  </div>
	</div>
      </div>
    </footer>
    <script async onload="loadGA()" src="https://www.googletagmanager.com/gtag/js?id=UA-58109156-2"></script>
    <script>
      function loadGA() {
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());
	  gtag('config', 'UA-58109156-2');
      }
    </script>
    <script defer src="https://cdn.usefathom.com/script.js" data-site="CEPUOLOQ"></script>
  </body>
</html>
