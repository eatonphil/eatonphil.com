<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="canonical" href="https://notes.eatonphil.com/btest-a-language-agnostic-test-runner.html">
    <title>btest: a language agnostic test runner | notes.eatonphil.com</title>
    <meta name="description" content="btest: a language agnostic test runner" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" href="/rss.xml" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono">
  </head>
  <body>
    <header>
      <div class="lfw">
	<div class="container">
	  <div class="row">
	    <a href="https://eatonphil.com/2025-holiday-fundraiser.html">2025 holiday fundraiser</a>
	  </div>
	</div>
      </div>
      <div class="container">
        <div>
          <div class="row">
	    <div>
	      <a href="https://eatonphil.com" class="sm-link">
		Home
              </a>
	      <a href="/" class="sm-link">
		Blog
              </a>
	      <a href="/rss.xml" class="sm-link">
		RSS
              </a>
	    </div>

	    <div class="subscribe">
	      <!-- <a href="https://eatonphil.com/hire-me.html">Hire me</a> -->
	      <!--
		  Hardcode link to home page because some pages don't
		  have a subscribe box. Some pages hide the subscribe.
		-->
	      <a href="https://eatonphil.com/subscribe.html">
		Subscribe
	      </a>
            </div>
	  </div>
	  <hr />
	  <div class="">
            <h2>August 4, 2018</h2>
            <h1>btest: a language agnostic test runner</h1>
	    
            <div class="row" style="padding-bottom: 5px">
              <div class="tags"><a href="/tags/d.html" class="tag">d</a><a href="/tags/testing.html" class="tag">testing</a></div>
            </div>
	  </div>
	</div>
      </div>
    </header>
    <div class="container">
      <div class="col-6">
	<div class="post">
          <p><a href="https://github.com/briansteffens/btest">btest</a> is a minimal,
language-agnostic test runner originally written for testing
compilers. Brian, an ex- co-worker from Linode, wrote the first
implementation in <a href="https://crystal-lang.org/">Crystal</a> (a compiled
language clone of Ruby) for testing
<a href="https://github.com/briansteffens/bshift">bshift</a>, a compiler
project. The tool accomplished exactly what I needed for my own
language project, <a href="https://github.com/eatonphil/bsdscheme">BSDScheme</a>,
and had very few dependencies. After some issues with Crystal support
in containerized CI environments, and despite some incredible
<a href="https://github.com/briansteffens/btest/pull/5">assistance from</a> <a href="https://github.com/briansteffens/btest/pull/4">the
Crystal community</a>, we
rewrote btest in D to simplify downstream use.</p>
<h3 id="how-it-works">How it works</h3><p>btest registers a command (or commands) to run and verifies the
command output and status for different inputs. btest iterates over
files in a directory to discover test groups and individual tests
within. It supports a limited template language for easily adjusting a
more-or-less similar set of tests. And it supports running test groups
and individual tests themselves in parallel. All of this is managed
via a simple YAML config.</p>
<h3 id="btest.yaml">btest.yaml</h3><p>btest requires a project-level configuration file to declare the test
directory, the command(s) to run per test, etc. Let's say we want to
run tests against a python program. We create
a <code>btest.yaml</code> file with the following:</p>
<div class="highlight"><pre><span></span><span class="nt">test_path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tests</span>

<span class="nt">runners</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run tests with cpython</span>
<span class="w">    </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python test.py</span>
</pre></div>
<p><code>test_path</code> is the directory in which tests are located.
<code>runners</code> is an array of commands to run per test. We
hard-code a file to run <code>test.py</code> as a project-level
standard file that will get written to disk in an appropriate path for
each test-case.</p>
<h4 id="on-multiple-runners">On multiple runners</h4><p>Using multiple runners is helpful when we want to run all tests with
different test commands or test command settings. For instance, we
could run tests against cpython and pypy by adding another runner to
the runners section.</p>
<div class="highlight"><pre><span></span><span class="nt">test_path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tests</span>

<span class="nt">runners</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run tests with cpython</span>
<span class="w">    </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python test.py</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run tests with pypy</span>
<span class="w">    </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pypy test.py</span>
</pre></div>
<h3 id="an-example-test-config">An example test config</h3><p>Let's create a <code>divide-by-zero.yaml</code> file in
the <code>tests</code> directory and add the following:</p>
<div class="highlight"><pre><span></span><span class="nt">cases</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Should exit on divide by zero</span>
<span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">    </span><span class="nt">stdout</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">      </span><span class="no">Traceback (most recent call last):</span>
<span class="w">        </span><span class="no">File &quot;test.py&quot;, line 1, in &lt;module&gt;</span>
<span class="w">          </span><span class="no">4 / 0</span>
<span class="w">      </span><span class="no">ZeroDivisionError: division by zero</span>
<span class="w">    </span><span class="nt">denominator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="nt">templates</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">test.py</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">      </span><span class="no">4 / {{ denominator }}</span>
</pre></div>
<p>In this example, <code>name</code> will be printed out when the test
is run. <code>status</code> is the expected integer returned by
running the program. <code>stdout</code> is the entire expected output
written by the program during execution. None of these three fields
are required. If <code>status</code> or <case>stdout</case> are not
provided, btest will skip checking them.</p>
<p>Any additional key-value pairs are treated as template variable values
and will be substituted if/where it is referenced in the templates
section when the case is run. <code>denominator</code> is the only
such variable we use in this example. When this first (and only) case
is run, <code>test.py</code> will be written to disk
containing <code>4 / 0</code>.</p>
<h4 id="templates-section">templates section</h4><p>The <code>templates</code> section is a dictionary allowing us to
specify files to be created with variable substitution. All files are
created in the same directory per test case, so if we want to import
code we can do so with relative paths.</p>
<p><a href="https://github.com/eatonphil/bsdscheme/blob/master/tests/include.yaml">Here</a>
is a simple example of a BSDScheme test that uses this feature.</p>
<h3 id="running-btest">Running btest</h3><p>Run btest from the root directory (the directory
above <code>tests</code>) and we'll see all the grouped test cases
that btest registers and the result of each test:</p>
<div class="highlight"><pre><span></span><span class="err">$</span><span class="w"> </span><span class="n">btest</span>
<span class="n">tests</span><span class="o">/</span><span class="n">divide</span><span class="o">-</span><span class="k">by</span><span class="o">-</span><span class="n">zero</span><span class="p">.</span><span class="n">yaml</span>
<span class="o">[</span><span class="n">PASS</span><span class="o">]</span><span class="w"> </span><span class="n">Should</span><span class="w"> </span><span class="k">exit</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">divide</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">zero</span>

<span class="mi">1</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">tests</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nl">runner</span><span class="p">:</span><span class="w"> </span><span class="n">Run</span><span class="w"> </span><span class="n">tests</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">cpython</span>
</pre></div>
<h3 id="use-in-ci-environments">Use in CI environments</h3><p>In the future we may provide pre-built release binaries. But in the
meantime, the CI step involves downloading git and ldc and
building/installing btest before calling it.</p>
<h4 id="circle-ci">Circle CI</h4><p>This is the
<a href="https://github.com/eatonphil/bsdscheme/blob/master/.circleci/config.yml">config</a>
file I use for testing BSDScheme:</p>
<div class="highlight"><pre><span></span><span class="n">version</span><span class="o">:</span><span class="w"> </span><span class="mi">2</span>
<span class="n">jobs</span><span class="o">:</span>
<span class="w">  </span><span class="n">build</span><span class="o">:</span>
<span class="w">    </span><span class="n">docker</span><span class="o">:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">image</span><span class="o">:</span><span class="w"> </span><span class="n">dlanguage</span><span class="o">/</span><span class="n">ldc</span>
<span class="w">    </span><span class="n">steps</span><span class="o">:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">checkout</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">run</span><span class="o">:</span>
<span class="w">          </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">Install</span><span class="w"> </span><span class="n">debian</span><span class="o">-</span><span class="n">packaged</span><span class="w"> </span><span class="n">dependencies</span>
<span class="w">          </span><span class="n">command</span><span class="o">:</span><span class="w"> </span><span class="o">|</span>
<span class="w">            </span><span class="n">apt</span><span class="w"> </span><span class="n">update</span>
<span class="w">            </span><span class="n">apt</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">-</span><span class="n">y</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="n">build</span><span class="o">-</span><span class="n">essential</span>
<span class="w">            </span><span class="n">ln</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="n">$</span><span class="o">(</span><span class="n">which</span><span class="w"> </span><span class="n">ldc2</span><span class="o">)</span><span class="w"> </span><span class="sr">/usr/local/bin/</span><span class="n">ldc</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">run</span><span class="o">:</span>
<span class="w">          </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">Install</span><span class="w"> </span><span class="n">btest</span>
<span class="w">          </span><span class="n">command</span><span class="o">:</span><span class="w"> </span><span class="o">|</span>
<span class="w">            </span><span class="n">git</span><span class="w"> </span><span class="n">clone</span><span class="w"> </span><span class="n">https</span><span class="o">://</span><span class="n">github</span><span class="o">.</span><span class="na">com</span><span class="sr">/briansteffens/</span><span class="n">btest</span>
<span class="w">            </span><span class="n">cd</span><span class="w"> </span><span class="n">btest</span>
<span class="w">            </span><span class="n">make</span>
<span class="w">            </span><span class="n">make</span><span class="w"> </span><span class="n">install</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">run</span><span class="o">:</span>
<span class="w">          </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">Install</span><span class="w"> </span><span class="n">bsdscheme</span>
<span class="w">          </span><span class="n">command</span><span class="o">:</span><span class="w"> </span><span class="o">|</span>
<span class="w">            </span><span class="n">make</span>
<span class="w">            </span><span class="n">make</span><span class="w"> </span><span class="n">install</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">run</span><span class="o">:</span>
<span class="w">          </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">Run</span><span class="w"> </span><span class="n">bsdscheme</span><span class="w"> </span><span class="n">tests</span>
<span class="w">          </span><span class="n">command</span><span class="o">:</span><span class="w"> </span><span class="n">btest</span>
</pre></div>
<h4 id="travis-ci">Travis CI</h4><p>This is the
<a href="https://github.com/briansteffens/bshift/blob/master/.travis.yml">config</a>
Brian uses for testing BShift:</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span><span class="o">:</span><span class="w"> </span><span class="n">required</span>

<span class="n">language</span><span class="o">:</span><span class="w"> </span><span class="n">d</span>

<span class="n">d</span><span class="o">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">ldc</span>

<span class="n">script</span><span class="o">:</span>
<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">ldc</span><span class="w"> </span><span class="n">gets</span><span class="w"> </span><span class="n">installed</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="n">names</span><span class="w"> </span><span class="n">sometimes</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">ln</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="err">`</span><span class="n">which</span><span class="w"> </span><span class="n">$DC</span><span class="err">`</span><span class="w"> </span><span class="sr">/usr/local/bin/</span><span class="n">ldc</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">bshift</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">make</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">ln</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="n">$PWD</span><span class="sr">/bin/bshift /usr/local/bin/</span><span class="n">bshift</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">ln</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="n">$PWD</span><span class="sr">/lib /usr/local/lib/</span><span class="n">bshift</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">nasm</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">apt</span><span class="o">-</span><span class="kd">get</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">-</span><span class="n">y</span><span class="w"> </span><span class="n">nasm</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">basm</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="n">clone</span><span class="w"> </span><span class="n">https</span><span class="o">://</span><span class="n">github</span><span class="o">.</span><span class="na">com</span><span class="sr">/briansteffens/</span><span class="n">basm</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">cd</span><span class="w"> </span><span class="n">basm</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cabal</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cd</span><span class="w"> </span><span class="o">..</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">ln</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="n">$PWD</span><span class="sr">/basm/dist/build/basm/basm /usr/local/bin/</span><span class="n">basm</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">btest</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="n">clone</span><span class="w"> </span><span class="n">https</span><span class="o">://</span><span class="n">github</span><span class="o">.</span><span class="na">com</span><span class="sr">/briansteffens/</span><span class="n">btest</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">cd</span><span class="w"> </span><span class="n">btest</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cd</span><span class="w"> </span><span class="o">..</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">tests</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">btest</span>
</pre></div>
<style>.feedback{display:initial;}</style>
	</div>
	<div class="feedback">
	  <h4>Feedback</h4>
	  <p>As always,
	      please <a href="mailto:phil@eatonphil.com">email</a>
	      or <a href="https://twitter.com/eatonphil">tweet me</a>
	      with questions, corrections, or ideas!</p>

	</div>
      </div>
    </div>
    <footer>
      <div class="container">
	<div>
	  <div id="subscribe">
	    <iframe frameBorder="0" src="https://cdn.forms-content-1.sg-form.com/e8ed4c3b-dd46-11f0-b6e6-ce075f2c5f80"/>

	  </div>
	</div>
      </div>
    </footer>
    <script async onload="loadGA()" src="https://www.googletagmanager.com/gtag/js?id=UA-58109156-2"></script>
    <script>
      function loadGA() {
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());
	  gtag('config', 'UA-58109156-2');
      }
    </script>
    <script defer src="https://cdn.usefathom.com/script.js" data-site="CEPUOLOQ"></script>
  </body>
</html>
