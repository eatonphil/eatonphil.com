<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="canonical" href="https://notes.eatonphil.com/2023-05-25-raft.html">
    <title>Implementing the Raft distributed consensus protocol in Go | notes.eatonphil.com</title>
    <meta name="description" content="Implementing the Raft distributed consensus protocol in Go" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" href="/rss.xml" />
  </head>
  <body>
    <header>
      <div class="lfw">
	<div class="container">
	  <div class="row">
	    <a href="https://eatonphil.com/hire-me.html">Hire me!</a>
	  </div>
	</div>
      </div>
      <div class="container">
        <div>
          <div class="row">
	    <div>
	      <a href="https://eatonphil.com" class="sm-link">
		Home
              </a>
	      <a href="/" class="sm-link">
		Notes
              </a>
	      <a href="/favorites.html" class="sm-link">
		Popular
              </a>
	      <a href="/rss.xml" class="sm-link">
		RSS
              </a>
	    </div>
	    	      
	    <div class="subscribe">                                     
	      <a href="https://notes.eatonphil.com/2023-05-25-raft.html#subscribe">       
		Subscribe          
	      </a>
            </div>
	  </div>
	  <hr />
          <h2>May 25, 2023</h2>
          <h1>Implementing the Raft distributed consensus protocol in Go</h1>
          <div class="row" style="padding-bottom: 5px">
            <div class="tags"><a href="/tags/go.html" class="tag">go</a><a href="/tags/raft.html" class="tag">raft</a></div>
          </div>
	</div>
      </div>
    </header>
    <div class="container">
      <div class="col-6">
        <p>As part of bringing myself up-to-speed after joining <a href="https://tigerbeetle.com/">TigerBeetle</a>, I
wanted some background on how distributed consensus and replicated state
machines protocols work. TigerBeetle uses <a href="https://pmg.csail.mit.edu/papers/vr-revisited.pdf">Viewstamped
Replication</a>. But I
wanted to understand all popular protocols and I decided to start with
<a href="https://raft.github.io/">Raft</a>.</p>
<p>We'll implement two key components of Raft in this post (leader
election and log replication). Around 1k lines of Go. It took me
around 7 months of sporadic studying to come to (what I hope is) an
understanding of the basics.</p>
<p><strong>Disclaimer</strong>: I'm not an expert. My implementation isn't yet hooked
up to <a href="https://github.com/jepsen-io/jepsen">Jepsen</a>. I've run it
through a mix of
<a href="https://github.com/eatonphil/goraft/tree/main#distributed-key-value-store-api">manual</a> and
<a href="https://github.com/eatonphil/goraft/tree/main/cmd/stress">automated
tests</a> and
it seems generally correct. This is not intended to be used in
production. It's just for my education.</p>
<p>All code for this project is <a href="https://github.com/eatonphil/goraft">available on GitHub</a>.</p>
<p>Let's dig in!</p>
<h3 id="the-algorithm">The algorithm</h3><p><a href="https://raft.github.io/raft.pdf">The Raft paper</a> itself is quite
readable. Give it a read and you'll get the basic idea.</p>
<p>The gist is that nodes in a cluster conduct elections to pick
a leader. Users of the Raft cluster send messages to the leader. The
leader passes the message to followers and waits for a majority to
store the message. Once the message is committed (majority consensus
has been reached), the message is applied to a state machine the user
supplies. Followers learn about the latest committed message from the
leader and apply each new committed message to their local
user-supplied state machine.</p>
<p>There's more to it including reconfiguration and snapshotting, which I
won't get into in this post. But you can get the gist of Raft by
thinking about 1) leader election and 2) replicated logs powering
replicated state machines.</p>
<h3 id="modeling-with-state-machines-and-key-value-stores">Modeling with state machines and key-value stores</h3><p>I've written before about how you can <a href="https://notes.eatonphil.com/minimal-key-value-store-with-hashicorp-raft.html">build a key-value store on top
of
Raft</a>. How
you can <a href="https://notes.eatonphil.com/zigrocks-sql.html">build a SQL database on top of a key-value
store</a>. And how you can
build a <a href="https://notes.eatonphil.com/distributed-postgres.html">distributed SQL database on top of
Raft</a>.</p>
<p>This post will start quite similarly to that first post except for
that we won't stop at the Raft layer.</p>
<h3 id="a-distributed-key-value-store">A distributed key-value store</h3><p>To build on top of the Raft library we'll build, we need to create a
state machine and commands that are sent to the state machine.</p>
<p>Our state machine will have two operations: get a value from a key,
and set a key to a value.</p>
<p>This will go in <code>cmd/kvapi/main.go</code>.</p>
<div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;bytes&quot;</span>
<span class="w">    </span><span class="nx">crypto</span><span class="w"> </span><span class="s">&quot;crypto/rand&quot;</span>
<span class="w">    </span><span class="s">&quot;encoding/binary&quot;</span>
<span class="w">    </span><span class="s">&quot;fmt&quot;</span>
<span class="w">    </span><span class="s">&quot;log&quot;</span>
<span class="w">    </span><span class="s">&quot;math/rand&quot;</span>
<span class="w">    </span><span class="s">&quot;net/http&quot;</span>
<span class="w">    </span><span class="s">&quot;os&quot;</span>
<span class="w">    </span><span class="s">&quot;strconv&quot;</span>
<span class="w">    </span><span class="s">&quot;strings&quot;</span>
<span class="w">    </span><span class="s">&quot;sync&quot;</span>

<span class="w">    </span><span class="s">&quot;github.com/eatonphil/goraft&quot;</span>
<span class="p">)</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">statemachine</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">db</span><span class="w">     </span><span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">Map</span>
<span class="w">    </span><span class="nx">server</span><span class="w"> </span><span class="kt">int</span>
<span class="p">}</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">commandKind</span><span class="w"> </span><span class="kt">uint8</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="nx">setCommand</span><span class="w"> </span><span class="nx">commandKind</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">iota</span>
<span class="w">    </span><span class="nx">getCommand</span>
<span class="p">)</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">command</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">kind</span><span class="w">  </span><span class="nx">commandKind</span>
<span class="w">    </span><span class="nx">key</span><span class="w">   </span><span class="kt">string</span>
<span class="w">    </span><span class="nx">value</span><span class="w"> </span><span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">statemachine</span><span class="p">)</span><span class="w"> </span><span class="nx">Apply</span><span class="p">(</span><span class="nx">cmd</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">decodeCommand</span><span class="p">(</span><span class="nx">cmd</span><span class="p">)</span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">kind</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">setCommand</span><span class="p">:</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">Store</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">getCommand</span><span class="p">:</span>
<span class="w">        </span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">Load</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">key</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;Key not found&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">value</span><span class="p">.(</span><span class="kt">string</span><span class="p">)),</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="k">default</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;Unknown command: %x&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">cmd</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</pre></div>
<p>But the Raft library we'll build needs to deal with various state
machines. So commands passed from the user into the Raft cluster must
be serialized to bytes.</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">encodeCommand</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="nx">command</span><span class="p">)</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">bytes</span><span class="p">.</span><span class="nx">NewBuffer</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
<span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">WriteByte</span><span class="p">(</span><span class="nb">uint8</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">kind</span><span class="p">))</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">binary</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span><span class="w"> </span><span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">,</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">key</span><span class="p">)))</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">msg</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">key</span><span class="p">)</span>

<span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">binary</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span><span class="w"> </span><span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">,</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">value</span><span class="p">)))</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">msg</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">Bytes</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
<p>And the <code>Apply()</code> function from above needs to be able to decode the
bytes:</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">decodeCommand</span><span class="p">(</span><span class="nx">msg</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="nx">command</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="nx">command</span>
<span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">kind</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">commandKind</span><span class="p">(</span><span class="nx">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="w">    </span><span class="nx">keyLen</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nx">Uint64</span><span class="p">(</span><span class="nx">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">9</span><span class="p">])</span>
<span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">key</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">msg</span><span class="p">[</span><span class="mi">9</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">9</span><span class="o">+</span><span class="nx">keyLen</span><span class="p">])</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">setCommand</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">valLen</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nx">Uint64</span><span class="p">(</span><span class="nx">msg</span><span class="p">[</span><span class="mi">9</span><span class="o">+</span><span class="nx">keyLen</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">9</span><span class="o">+</span><span class="nx">keyLen</span><span class="o">+</span><span class="mi">8</span><span class="p">])</span>
<span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">msg</span><span class="p">[</span><span class="mi">9</span><span class="o">+</span><span class="nx">keyLen</span><span class="o">+</span><span class="mi">8</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">9</span><span class="o">+</span><span class="nx">keyLen</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="nx">valLen</span><span class="p">])</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">c</span>
<span class="p">}</span>
</pre></div>
<h4 id="http-api">HTTP API</h4><p>Now that we've modeled the key-value store as a state machine. Let's
build the HTTP endpoints that allow the user to operate the state
machine through the Raft cluster.</p>
<p>First, let's implement the <code>set</code> operation. We need to grab the key
and value the user passes in and call <code>Apply()</code> on the Raft
cluster. Calling <code>Apply()</code> on the Raft cluster will eventually call
the <code>Apply()</code> function we just wrote, but not until the message sent
to the Raft cluster is actually replicated.</p>
<div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">httpServer</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">raft</span><span class="w"> </span><span class="o">*</span><span class="nx">goraft</span><span class="p">.</span><span class="nx">Server</span>
<span class="w">    </span><span class="nx">db</span><span class="w">   </span><span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">Map</span>
<span class="p">}</span>

<span class="c1">// Example:</span>
<span class="c1">//</span>
<span class="c1">//  curl http://localhost:2020/set?key=x&amp;value=1</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">hs</span><span class="w"> </span><span class="nx">httpServer</span><span class="p">)</span><span class="w"> </span><span class="nx">setHandler</span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="nx">command</span>
<span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">kind</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">setCommand</span>
<span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">key</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Query</span><span class="p">().</span><span class="nx">Get</span><span class="p">(</span><span class="s">&quot;key&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Query</span><span class="p">().</span><span class="nx">Get</span><span class="p">(</span><span class="s">&quot;value&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">hs</span><span class="p">.</span><span class="nx">raft</span><span class="p">.</span><span class="nx">Apply</span><span class="p">([][]</span><span class="kt">byte</span><span class="p">{</span><span class="nx">encodeCommand</span><span class="p">(</span><span class="nx">c</span><span class="p">)})</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Could not write key-value: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">        </span><span class="nx">http</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusText</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">),</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>To reiterate, we tell the Raft cluster we want this message
replicated. The message contains the operation type (<code>set</code>) and the
operation details (<code>key</code> and <code>value</code>). These messages are custom to
the state machine we wrote. And they will be interpreted by the state
machine we wrote, on each node in the cluster.</p>
<p>Next we handle <code>get</code>-ing values from the cluster. There are two ways
to do this. We already embed a local copy of the distributed key-value
map. We could just read from that map in the current process. But it
might not be up-to-date or correct. It would be fast to read
though. And convenient for debugging.</p>
<p>But the only <a href="https://github.com/etcd-io/etcd/issues/741"><em>correct</em> way to read from a Raft
cluster</a> is to pass the
read through the log replication too.</p>
<p>So we'll support both.</p>
<div class="highlight"><pre><span></span><span class="c1">// Example:</span>
<span class="c1">//</span>
<span class="c1">//  curl http://localhost:2020/get?key=x</span>
<span class="c1">//  1</span>
<span class="c1">//  curl http://localhost:2020/get?key=x&amp;relaxed=true # Skips consensus for the read.</span>
<span class="c1">//  1</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">hs</span><span class="w"> </span><span class="nx">httpServer</span><span class="p">)</span><span class="w"> </span><span class="nx">getHandler</span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="nx">command</span>
<span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">kind</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">getCommand</span>
<span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">key</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Query</span><span class="p">().</span><span class="nx">Get</span><span class="p">(</span><span class="s">&quot;key&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="kt">error</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Query</span><span class="p">().</span><span class="nx">Get</span><span class="p">(</span><span class="s">&quot;relaxed&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">v</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">hs</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">Load</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">key</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;Key not found&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">value</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">v</span><span class="p">.(</span><span class="kt">string</span><span class="p">))</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="p">[]</span><span class="nx">goraft</span><span class="p">.</span><span class="nx">ApplyResult</span>
<span class="w">        </span><span class="nx">results</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">hs</span><span class="p">.</span><span class="nx">raft</span><span class="p">.</span><span class="nx">Apply</span><span class="p">([][]</span><span class="kt">byte</span><span class="p">{</span><span class="nx">encodeCommand</span><span class="p">(</span><span class="nx">c</span><span class="p">)})</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">results</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;Expected single response from Raft, got: %d.&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">results</span><span class="p">))</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Error</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">value</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Result</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Could not encode key-value in http response: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">        </span><span class="nx">http</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusText</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">),</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">written</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">written</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">n</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="nx">value</span><span class="p">[</span><span class="nx">written</span><span class="p">:])</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Could not encode key-value in http response: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">            </span><span class="nx">http</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusText</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">),</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">written</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">n</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<h4 id="main">Main</h4><p>Now that we've set up our custom state machine and our HTTP API for
interacting with the Raft cluster, we'll tie it together with reading
configuration from the command-line and actually starting the Raft
node and the HTTP API.</p>
<div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">cluster</span><span class="w"> </span><span class="p">[]</span><span class="nx">goraft</span><span class="p">.</span><span class="nx">ClusterMember</span>
<span class="w">    </span><span class="nx">index</span><span class="w">   </span><span class="kt">int</span>
<span class="w">    </span><span class="nx">id</span><span class="w">      </span><span class="kt">string</span>
<span class="w">    </span><span class="nx">address</span><span class="w"> </span><span class="kt">string</span>
<span class="w">    </span><span class="nx">http</span><span class="w">    </span><span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">getConfig</span><span class="p">()</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">cfg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">config</span><span class="p">{}</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">node</span><span class="w"> </span><span class="kt">string</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">arg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">arg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;--node&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="kt">error</span>
<span class="w">            </span><span class="nx">node</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
<span class="w">            </span><span class="nx">cfg</span><span class="p">.</span><span class="nx">index</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">strconv</span><span class="p">.</span><span class="nx">Atoi</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">&quot;Expected $value to be a valid integer in `--node $value`, got: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">node</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nx">i</span><span class="o">++</span>
<span class="w">            </span><span class="k">continue</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">arg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;--http&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">cfg</span><span class="p">.</span><span class="nx">http</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
<span class="w">            </span><span class="nx">i</span><span class="o">++</span>
<span class="w">            </span><span class="k">continue</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">arg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;--cluster&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">cluster</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">clusterEntry</span><span class="w"> </span><span class="nx">goraft</span><span class="p">.</span><span class="nx">ClusterMember</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">part</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">Split</span><span class="p">(</span><span class="nx">cluster</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;;&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">idAddress</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">Split</span><span class="p">(</span><span class="nx">part</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="kd">var</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="kt">error</span>
<span class="w">                </span><span class="nx">clusterEntry</span><span class="p">.</span><span class="nx">Id</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">strconv</span><span class="p">.</span><span class="nx">ParseUint</span><span class="p">(</span><span class="nx">idAddress</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">)</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">&quot;Expected $id to be a valid integer in `--cluster $id,$ip`, got: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">idAddress</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="nx">clusterEntry</span><span class="p">.</span><span class="nx">Address</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">idAddress</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="w">                </span><span class="nx">cfg</span><span class="p">.</span><span class="nx">cluster</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">cluster</span><span class="p">,</span><span class="w"> </span><span class="nx">clusterEntry</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="nx">i</span><span class="o">++</span>
<span class="w">            </span><span class="k">continue</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">node</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">&quot;Missing required parameter: --node $index&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">cfg</span><span class="p">.</span><span class="nx">http</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">&quot;Missing required parameter: --http $address&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">cluster</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">&quot;Missing required parameter: --cluster $node1Id,$node1Address;...;$nodeNId,$nodeNAddress&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">cfg</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="kt">byte</span>
<span class="w">    </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">crypto</span><span class="p">.</span><span class="nx">Read</span><span class="p">(</span><span class="nx">b</span><span class="p">[:])</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="s">&quot;cannot seed math/rand package with cryptographically secure random number generator&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">rand</span><span class="p">.</span><span class="nx">Seed</span><span class="p">(</span><span class="nb">int64</span><span class="p">(</span><span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nx">Uint64</span><span class="p">(</span><span class="nx">b</span><span class="p">[:])))</span>

<span class="w">    </span><span class="nx">cfg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">getConfig</span><span class="p">()</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Map</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">sm</span><span class="w"> </span><span class="nx">statemachine</span>
<span class="w">    </span><span class="nx">sm</span><span class="p">.</span><span class="nx">db</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">db</span>
<span class="w">    </span><span class="nx">sm</span><span class="p">.</span><span class="nx">server</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">cfg</span><span class="p">.</span><span class="nx">index</span>

<span class="w">    </span><span class="nx">s</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">goraft</span><span class="p">.</span><span class="nx">NewServer</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">cluster</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">sm</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;.&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">cfg</span><span class="p">.</span><span class="nx">index</span><span class="p">)</span>
<span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">Start</span><span class="p">()</span>

<span class="w">    </span><span class="nx">hs</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">httpServer</span><span class="p">{</span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">db</span><span class="p">}</span>

<span class="w">    </span><span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/set&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">hs</span><span class="p">.</span><span class="nx">setHandler</span><span class="p">)</span>
<span class="w">    </span><span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/get&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">hs</span><span class="p">.</span><span class="nx">getHandler</span><span class="p">)</span>
<span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">http</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>And that's it for the easy part: a distributed key-value store on top
of a Raft cluster.</p>
<p>Next we need to implement Raft.</p>
<h3 id="a-raft-server">A Raft server</h3><p>If we take a look at Figure 2 in the Raft paper, we get an idea for
all the state we need to model.</p>
<p><img src="/assets/raft-figure-2.png" alt="Raft Figure 2"></p>
<p>We'll dig into the details as we go. But for now let's turn that model
into a few Go types. This goes in <code>raft.go</code> in the base directory,
not <code>cmd/kvapi</code>.</p>
<div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nx">goraft</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;bufio&quot;</span>
<span class="w">        </span><span class="s">&quot;context&quot;</span>
<span class="w">    </span><span class="s">&quot;encoding/binary&quot;</span>
<span class="w">    </span><span class="s">&quot;errors&quot;</span>
<span class="w">    </span><span class="s">&quot;fmt&quot;</span>
<span class="w">    </span><span class="s">&quot;io&quot;</span>
<span class="w">    </span><span class="s">&quot;math/rand&quot;</span>
<span class="w">    </span><span class="s">&quot;net&quot;</span>
<span class="w">    </span><span class="s">&quot;net/http&quot;</span>
<span class="w">    </span><span class="s">&quot;net/rpc&quot;</span>
<span class="w">    </span><span class="s">&quot;os&quot;</span>
<span class="w">    </span><span class="s">&quot;path&quot;</span>
<span class="w">    </span><span class="s">&quot;sync&quot;</span>
<span class="w">    </span><span class="s">&quot;time&quot;</span>
<span class="p">)</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">StateMachine</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Apply</span><span class="p">(</span><span class="nx">cmd</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">ApplyResult</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Result</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span>
<span class="w">    </span><span class="nx">Error</span><span class="w">  </span><span class="kt">error</span>
<span class="p">}</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Entry</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Command</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span>
<span class="w">    </span><span class="nx">Term</span><span class="w">    </span><span class="kt">uint64</span>

<span class="w">    </span><span class="c1">// Set by the primary so it can learn about the result of</span>
<span class="w">    </span><span class="c1">// applying this command to the state machine</span>
<span class="w">    </span><span class="nx">result</span><span class="w">  </span><span class="kd">chan</span><span class="w"> </span><span class="nx">ApplyResult</span>
<span class="p">}</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">ClusterMember</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Id</span><span class="w">      </span><span class="kt">uint64</span>
<span class="w">    </span><span class="nx">Address</span><span class="w"> </span><span class="kt">string</span>

<span class="w">    </span><span class="c1">// Index of the next log entry to send</span>
<span class="w">    </span><span class="nx">nextIndex</span><span class="w"> </span><span class="kt">uint64</span>
<span class="w">    </span><span class="c1">// Highest log entry known to be replicated</span>
<span class="w">    </span><span class="nx">matchIndex</span><span class="w"> </span><span class="kt">uint64</span>

<span class="w">    </span><span class="c1">// Who was voted for in the most recent term</span>
<span class="w">    </span><span class="nx">votedFor</span><span class="w"> </span><span class="kt">uint64</span>

<span class="w">    </span><span class="c1">// TCP connection</span>
<span class="w">    </span><span class="nx">rpcClient</span><span class="w"> </span><span class="o">*</span><span class="nx">rpc</span><span class="p">.</span><span class="nx">Client</span>
<span class="p">}</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">ServerState</span><span class="w"> </span><span class="kt">string</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="nx">leaderState</span><span class="w">    </span><span class="nx">ServerState</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;leader&quot;</span>
<span class="w">    </span><span class="nx">followerState</span><span class="w">              </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;follower&quot;</span>
<span class="w">    </span><span class="nx">candidateState</span><span class="w">             </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;candidate&quot;</span>
<span class="p">)</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">Server</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// These variables for shutting down.</span>
<span class="w">    </span><span class="nx">done</span><span class="w"> </span><span class="kt">bool</span>
<span class="w">        </span><span class="nx">server</span><span class="w"> </span><span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Server</span>

<span class="w">    </span><span class="nx">Debug</span><span class="w"> </span><span class="kt">bool</span>

<span class="w">    </span><span class="nx">mu</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
<span class="w">    </span><span class="c1">// ----------- PERSISTENT STATE -----------</span>

<span class="w">    </span><span class="c1">// The current term</span>
<span class="w">    </span><span class="nx">currentTerm</span><span class="w"> </span><span class="kt">uint64</span>

<span class="w">    </span><span class="nx">log</span><span class="w"> </span><span class="p">[]</span><span class="nx">Entry</span>

<span class="w">    </span><span class="c1">// votedFor is stored in `cluster []ClusterMember` below,</span>
<span class="w">    </span><span class="c1">// mapped by `clusterIndex` below</span>

<span class="w">    </span><span class="c1">// ----------- READONLY STATE -----------</span>

<span class="w">    </span><span class="c1">// Unique identifier for this Server</span>
<span class="w">    </span><span class="nx">id</span><span class="w"> </span><span class="kt">uint64</span>

<span class="w">    </span><span class="c1">// The TCP address for RPC</span>
<span class="w">    </span><span class="nx">address</span><span class="w"> </span><span class="kt">string</span>

<span class="w">    </span><span class="c1">// When to start elections after no append entry messages</span>
<span class="w">    </span><span class="nx">electionTimeout</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>

<span class="w">    </span><span class="c1">// How often to send empty messages</span>
<span class="w">    </span><span class="nx">heartbeatMs</span><span class="w"> </span><span class="kt">int</span>

<span class="w">    </span><span class="c1">// When to next send empty message</span>
<span class="w">    </span><span class="nx">heartbeatTimeout</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>

<span class="w">    </span><span class="c1">// User-provided state machine</span>
<span class="w">    </span><span class="nx">statemachine</span><span class="w"> </span><span class="nx">StateMachine</span>

<span class="w">    </span><span class="c1">// Metadata directory</span>
<span class="w">    </span><span class="nx">metadataDir</span><span class="w"> </span><span class="kt">string</span>

<span class="w">    </span><span class="c1">// Metadata store</span>
<span class="w">    </span><span class="nx">fd</span><span class="w"> </span><span class="o">*</span><span class="nx">os</span><span class="p">.</span><span class="nx">File</span>

<span class="w">    </span><span class="c1">// ----------- VOLATILE STATE -----------</span>

<span class="w">    </span><span class="c1">// Index of highest log entry known to be committed</span>
<span class="w">    </span><span class="nx">commitIndex</span><span class="w"> </span><span class="kt">uint64</span>

<span class="w">    </span><span class="c1">// Index of highest log entry applied to state machine</span>
<span class="w">    </span><span class="nx">lastApplied</span><span class="w"> </span><span class="kt">uint64</span>

<span class="w">    </span><span class="c1">// Candidate, follower, or leader</span>
<span class="w">    </span><span class="nx">state</span><span class="w"> </span><span class="nx">ServerState</span>

<span class="w">    </span><span class="c1">// Servers in the cluster, including this one</span>
<span class="w">    </span><span class="nx">cluster</span><span class="w"> </span><span class="p">[]</span><span class="nx">ClusterMember</span>

<span class="w">    </span><span class="c1">// Index of this server</span>
<span class="w">    </span><span class="nx">clusterIndex</span><span class="w"> </span><span class="kt">int</span>
<span class="p">}</span>
</pre></div>
<p>And let's build a constructor to initialize the state for all servers
in the cluster, as well as local server state.</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">NewServer</span><span class="p">(</span>
<span class="w">    </span><span class="nx">clusterConfig</span><span class="w"> </span><span class="p">[]</span><span class="nx">ClusterMember</span><span class="p">,</span>
<span class="w">    </span><span class="nx">statemachine</span><span class="w"> </span><span class="nx">StateMachine</span><span class="p">,</span>
<span class="w">    </span><span class="nx">metadataDir</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">clusterIndex</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Explicitly make a copy of the cluster because we&#39;ll be</span>
<span class="w">    </span><span class="c1">// modifying it in this server.</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">cluster</span><span class="w"> </span><span class="p">[]</span><span class="nx">ClusterMember</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">clusterConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">Id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">panic</span><span class="p">(</span><span class="s">&quot;Id must not be 0.&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nx">cluster</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">cluster</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">Server</span><span class="p">{</span>
<span class="w">        </span><span class="nx">id</span><span class="p">:</span><span class="w">           </span><span class="nx">cluster</span><span class="p">[</span><span class="nx">clusterIndex</span><span class="p">].</span><span class="nx">Id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">address</span><span class="p">:</span><span class="w">      </span><span class="nx">cluster</span><span class="p">[</span><span class="nx">clusterIndex</span><span class="p">].</span><span class="nx">Address</span><span class="p">,</span>
<span class="w">        </span><span class="nx">cluster</span><span class="p">:</span><span class="w">      </span><span class="nx">cluster</span><span class="p">,</span>
<span class="w">        </span><span class="nx">statemachine</span><span class="p">:</span><span class="w"> </span><span class="nx">statemachine</span><span class="p">,</span>
<span class="w">        </span><span class="nx">metadataDir</span><span class="p">:</span><span class="w">  </span><span class="nx">metadataDir</span><span class="p">,</span>
<span class="w">        </span><span class="nx">clusterIndex</span><span class="p">:</span><span class="w"> </span><span class="nx">clusterIndex</span><span class="p">,</span>
<span class="w">        </span><span class="nx">heartbeatMs</span><span class="p">:</span><span class="w">  </span><span class="mi">300</span><span class="p">,</span>
<span class="w">        </span><span class="nx">mu</span><span class="p">:</span><span class="w">           </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span><span class="p">{},</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>And add a few debugging and assertion helpers.</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span><span class="w"> </span><span class="nx">debugmsg</span><span class="p">(</span><span class="nx">msg</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;%s [Id: %d, Term: %d] %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Format</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">RFC3339Nano</span><span class="p">),</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span><span class="w"> </span><span class="nx">debug</span><span class="p">(</span><span class="nx">msg</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">s</span><span class="p">.</span><span class="nx">Debug</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">debugmsg</span><span class="p">(</span><span class="nx">msg</span><span class="p">))</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span><span class="w"> </span><span class="nx">debugf</span><span class="p">(</span><span class="nx">msg</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="w"> </span><span class="o">...</span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">s</span><span class="p">.</span><span class="nx">Debug</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="o">...</span><span class="p">))</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span><span class="w"> </span><span class="nx">warn</span><span class="p">(</span><span class="nx">msg</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;[WARN] &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">debugmsg</span><span class="p">(</span><span class="nx">msg</span><span class="p">))</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span><span class="w"> </span><span class="nx">warnf</span><span class="p">(</span><span class="nx">msg</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="w"> </span><span class="o">...</span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="o">...</span><span class="p">))</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">Assert</span><span class="p">[</span><span class="nx">T</span><span class="w"> </span><span class="kt">comparable</span><span class="p">](</span><span class="nx">msg</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;%s. Got a = %#v, b = %#v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">,</span><span class="w"> </span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">Server_assert</span><span class="p">[</span><span class="nx">T</span><span class="w"> </span><span class="kt">comparable</span><span class="p">](</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Assert</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">debugmsg</span><span class="p">(</span><span class="nx">msg</span><span class="p">),</span><span class="w"> </span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
<h3 id="persistent-state">Persistent state</h3><p>As Figure 2 says, <code>currentTerm</code>, <code>log</code>, and <code>votedFor</code> must be
persisted to disk as they're edited.</p>
<p>I like to initially doing the stupidest thing possible. So in the
first version of this project I used <code>encoding/gob</code> to write these
three fields to disk every time <code>s.persist()</code> was called.</p>
<p>Here is what this first version looked like:</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span><span class="w"> </span><span class="nx">persist</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">fd</span><span class="p">.</span><span class="nx">Truncate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">fd</span><span class="p">.</span><span class="nx">Seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="nx">enc</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">gob</span><span class="p">.</span><span class="nx">NewEncoder</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">fd</span><span class="p">)</span>
<span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">enc</span><span class="p">.</span><span class="nx">Encode</span><span class="p">(</span><span class="nx">PersistentState</span><span class="p">{</span>
<span class="w">        </span><span class="nx">CurrentTerm</span><span class="p">:</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span>
<span class="w">        </span><span class="nx">Log</span><span class="p">:</span><span class="w">         </span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">,</span>
<span class="w">        </span><span class="nx">VotedFor</span><span class="p">:</span><span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">votedFor</span><span class="p">,</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">fd</span><span class="p">.</span><span class="nx">Sync</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Persisted. Term: %d. Log Len: %d. Voted For: %s.&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">),</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">votedFor</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
<p>But doing so means this implementation is a function of the size of
the log. And that was horrible for throughput.</p>
<p>I also noticed that <code>encoding/gob</code> is pretty inefficient.</p>
<p>For a simple struct like:</p>
<div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">X</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">A</span><span class="w"> </span><span class="kt">uint64</span>
<span class="w">    </span><span class="nx">B</span><span class="w"> </span><span class="p">[]</span><span class="kt">uint64</span>
<span class="w">    </span><span class="nx">C</span><span class="w"> </span><span class="kt">bool</span>
<span class="p">}</span>
</pre></div>
<p><code>encoding/gob</code> uses <a href="https://play.golang.com/p/TUe9TDgaZOw">68 bytes to store that data for when B has two
entries</a>. If we wrote the
encoder/decoder ourselves we could store that struct in 33 bytes (<code>8
(sizeof(A)) + 8 (sizeof(len(B))) + 16 (len(B) * sizeof(B)) + 1
(sizeof(C))</code>).</p>
<p>It's not that <code>encoding/gob</code> is bad. It just likely has different
constraints than we are party to.</p>
<p>So I decided to swap out <code>encoding/gob</code> for simply binary encoding the
fields and also, importantly, keeping track of exactly how many
entries in the log must be written and only writing that many.</p>
<h4 id="<code>s.persist()</code>"><code>s.persist()</code></h4><p>Here's what that looks like.</p>
<div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">PAGE_SIZE</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">4096</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">ENTRY_HEADER</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">16</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">ENTRY_SIZE</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">128</span>

<span class="c1">// Must be called within s.mu.Lock()</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span><span class="w"> </span><span class="nx">persist</span><span class="p">(</span><span class="nx">writeLog</span><span class="w"> </span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="nx">nNewEntries</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">t</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">()</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">nNewEntries</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">writeLog</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">nNewEntries</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">fd</span><span class="p">.</span><span class="nx">Seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="p">[</span><span class="nx">PAGE_SIZE</span><span class="p">]</span><span class="kt">byte</span>
<span class="w">    </span><span class="c1">// Bytes 0  - 8:   Current term</span>
<span class="w">    </span><span class="c1">// Bytes 8  - 16:  Voted for</span>
<span class="w">    </span><span class="c1">// Bytes 16 - 24:  Log length</span>
<span class="w">    </span><span class="c1">// Bytes 4096 - N: Log</span>

<span class="w">    </span><span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nx">PutUint64</span><span class="p">(</span><span class="nx">page</span><span class="p">[:</span><span class="mi">8</span><span class="p">],</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">)</span>
<span class="w">    </span><span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nx">PutUint64</span><span class="p">(</span><span class="nx">page</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">16</span><span class="p">],</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">getVotedFor</span><span class="p">())</span>
<span class="w">    </span><span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nx">PutUint64</span><span class="p">(</span><span class="nx">page</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">24</span><span class="p">],</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">)))</span>
<span class="w">    </span><span class="nx">n</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">fd</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="nx">page</span><span class="p">[:])</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">Server_assert</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Wrote full page&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">n</span><span class="p">,</span><span class="w"> </span><span class="nx">PAGE_SIZE</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">writeLog</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">nNewEntries</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">newLogOffset</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span><span class="o">-</span><span class="nx">nNewEntries</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>

<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">fd</span><span class="p">.</span><span class="nx">Seek</span><span class="p">(</span><span class="nb">int64</span><span class="p">(</span><span class="nx">PAGE_SIZE</span><span class="o">+</span><span class="nx">ENTRY_SIZE</span><span class="o">*</span><span class="nx">newLogOffset</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="nx">bw</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">bufio</span><span class="p">.</span><span class="nx">NewWriter</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">fd</span><span class="p">)</span>

<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">entryBytes</span><span class="w"> </span><span class="p">[</span><span class="nx">ENTRY_SIZE</span><span class="p">]</span><span class="kt">byte</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">newLogOffset</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">);</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Bytes 0 - 8:    Entry term</span>
<span class="w">            </span><span class="c1">// Bytes 8 - 16:   Entry command length</span>
<span class="w">            </span><span class="c1">// Bytes 16 - ENTRY_SIZE: Entry command</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Command</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nx">ENTRY_SIZE</span><span class="o">-</span><span class="nx">ENTRY_HEADER</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Command is too large (%d). Must be at most %d bytes.&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Command</span><span class="p">),</span><span class="w"> </span><span class="nx">ENTRY_SIZE</span><span class="o">-</span><span class="nx">ENTRY_HEADER</span><span class="p">))</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nx">PutUint64</span><span class="p">(</span><span class="nx">entryBytes</span><span class="p">[:</span><span class="mi">8</span><span class="p">],</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Term</span><span class="p">)</span>
<span class="w">            </span><span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nx">PutUint64</span><span class="p">(</span><span class="nx">entryBytes</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">16</span><span class="p">],</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Command</span><span class="p">)))</span>
<span class="w">            </span><span class="nb">copy</span><span class="p">(</span><span class="nx">entryBytes</span><span class="p">[</span><span class="mi">16</span><span class="p">:],</span><span class="w"> </span><span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Command</span><span class="p">))</span>

<span class="w">            </span><span class="nx">n</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">bw</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="nx">entryBytes</span><span class="p">[:])</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nx">Server_assert</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Wrote full page&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">n</span><span class="p">,</span><span class="w"> </span><span class="nx">ENTRY_SIZE</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">bw</span><span class="p">.</span><span class="nx">Flush</span><span class="p">()</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">fd</span><span class="p">.</span><span class="nx">Sync</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">debugf</span><span class="p">(</span><span class="s">&quot;Persisted in %s. Term: %d. Log Len: %d (%d new). Voted For: %d.&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Sub</span><span class="p">(</span><span class="nx">t</span><span class="p">),</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">),</span><span class="w"> </span><span class="nx">nNewEntries</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">getVotedFor</span><span class="p">())</span>
<span class="p">}</span>
</pre></div>
<p>Again the important thing is that only the entries that <em>need</em> to be
written are written. We do that by <code>seek</code>-ing to the offset of the
first entry that needs to be written.</p>
<p>And we collect writes of entries in a <code>bufio.Writer</code> so we don't waste
write syscalls. Don't forget to flush the buffered writer!</p>
<p>And don't forget to flush all writes to disk with <code>fd.Sync()</code>.</p>
<p class="note">
  <code>ENTRY_SIZE</code> is something that I could see being configurable based
  on the workload. Some workloads truly need only 128 bytes. But a
  key-value store probably wants much more than that. This
  implementation doesn't try to handle the case of completely
  arbitrary sized keys and values.
</p><p>Lastly, a few helpers used in there:</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">min</span><span class="p">[</span><span class="nx">T</span><span class="w"> </span><span class="o">~</span><span class="kt">int</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">~</span><span class="kt">uint64</span><span class="p">](</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="nx">T</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">a</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">b</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">max</span><span class="p">[</span><span class="nx">T</span><span class="w"> </span><span class="o">~</span><span class="kt">int</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">~</span><span class="kt">uint64</span><span class="p">](</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="nx">T</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">a</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">b</span>
<span class="p">}</span>

<span class="c1">// Must be called within s.mu.Lock()</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span><span class="w"> </span><span class="nx">getVotedFor</span><span class="p">()</span><span class="w"> </span><span class="kt">uint64</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">clusterIndex</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">votedFor</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">Server_assert</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Invalid cluster&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span>
<span class="p">}</span>
</pre></div>
<h4 id="<code>s.restore()</code>"><code>s.restore()</code></h4><p>Now let's do the reverse operation, restoring from disk. This will
only be called once on startup.</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span><span class="w"> </span><span class="nx">restore</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">fd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="kt">error</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">fd</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">OpenFile</span><span class="p">(</span>
<span class="w">            </span><span class="nx">path</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">metadataDir</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;md_%d.dat&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">id</span><span class="p">)),</span>
<span class="w">            </span><span class="nx">os</span><span class="p">.</span><span class="nx">O_SYNC</span><span class="o">|</span><span class="nx">os</span><span class="p">.</span><span class="nx">O_CREATE</span><span class="o">|</span><span class="nx">os</span><span class="p">.</span><span class="nx">O_RDWR</span><span class="p">,</span>
<span class="w">            </span><span class="mo">0755</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">fd</span><span class="p">.</span><span class="nx">Seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Bytes 0  - 8:   Current term</span>
<span class="w">    </span><span class="c1">// Bytes 8  - 16:  Voted for</span>
<span class="w">    </span><span class="c1">// Bytes 16 - 24:  Log length</span>
<span class="w">    </span><span class="c1">// Bytes 4096 - N: Log</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="p">[</span><span class="nx">PAGE_SIZE</span><span class="p">]</span><span class="kt">byte</span>
<span class="w">    </span><span class="nx">n</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">fd</span><span class="p">.</span><span class="nx">Read</span><span class="p">(</span><span class="nx">page</span><span class="p">[:])</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">ensureLog</span><span class="p">()</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">Server_assert</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Read full page&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">n</span><span class="p">,</span><span class="w"> </span><span class="nx">PAGE_SIZE</span><span class="p">)</span>

<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">currentTerm</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nx">Uint64</span><span class="p">(</span><span class="nx">page</span><span class="p">[:</span><span class="mi">8</span><span class="p">])</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">setVotedFor</span><span class="p">(</span><span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nx">Uint64</span><span class="p">(</span><span class="nx">page</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">16</span><span class="p">]))</span>
<span class="w">    </span><span class="nx">lenLog</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nx">Uint64</span><span class="p">(</span><span class="nx">page</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">24</span><span class="p">])</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">nil</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">lenLog</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">fd</span><span class="p">.</span><span class="nx">Seek</span><span class="p">(</span><span class="nb">int64</span><span class="p">(</span><span class="nx">PAGE_SIZE</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>

<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">e</span><span class="w"> </span><span class="nx">Entry</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">lenLog</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">entryBytes</span><span class="w"> </span><span class="p">[</span><span class="nx">ENTRY_SIZE</span><span class="p">]</span><span class="kt">byte</span>
<span class="w">            </span><span class="nx">n</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">fd</span><span class="p">.</span><span class="nx">Read</span><span class="p">(</span><span class="nx">entryBytes</span><span class="p">[:])</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nx">Server_assert</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Read full entry&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">n</span><span class="p">,</span><span class="w"> </span><span class="nx">ENTRY_SIZE</span><span class="p">)</span>

<span class="w">            </span><span class="c1">// Bytes 0 - 8:    Entry term</span>
<span class="w">            </span><span class="c1">// Bytes 8 - 16:   Entry command length</span>
<span class="w">            </span><span class="c1">// Bytes 16 - ENTRY_SIZE: Entry command</span>
<span class="w">            </span><span class="nx">e</span><span class="p">.</span><span class="nx">Term</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nx">Uint64</span><span class="p">(</span><span class="nx">entryBytes</span><span class="p">[:</span><span class="mi">8</span><span class="p">])</span>
<span class="w">            </span><span class="nx">lenValue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nx">Uint64</span><span class="p">(</span><span class="nx">entryBytes</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">16</span><span class="p">])</span>
<span class="w">            </span><span class="nx">e</span><span class="p">.</span><span class="nx">Command</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">entryBytes</span><span class="p">[</span><span class="mi">16</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="o">+</span><span class="nx">lenValue</span><span class="p">]</span>
<span class="w">            </span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">ensureLog</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
<p>And a few helpers it calls:</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span><span class="w"> </span><span class="nx">ensureLog</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Always has at least one log entry.</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">,</span><span class="w"> </span><span class="nx">Entry</span><span class="p">{})</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Must be called within s.mu.Lock()</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span><span class="w"> </span><span class="nx">setVotedFor</span><span class="p">(</span><span class="nx">id</span><span class="w"> </span><span class="kt">uint64</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">clusterIndex</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">votedFor</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">id</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">Server_assert</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Invalid cluster&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
<h3 id="the-main-loop">The main loop</h3><p>Now let's think about the main loop. Before starting the loop we need
to 1) restore persistent state from disk and 2) kick off an RPC
server so servers in the cluster can send and receive messages to and
from eachother.</p>
<div class="highlight"><pre><span></span><span class="c1">// Make sure rand is seeded</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span><span class="w"> </span><span class="nx">Start</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">state</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">followerState</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">done</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">restore</span><span class="p">()</span>

<span class="w">    </span><span class="nx">rpcServer</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">rpc</span><span class="p">.</span><span class="nx">NewServer</span><span class="p">()</span>
<span class="w">    </span><span class="nx">rpcServer</span><span class="p">.</span><span class="nx">Register</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
<span class="w">    </span><span class="nx">l</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">net</span><span class="p">.</span><span class="nx">Listen</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">address</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">mux</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">NewServeMux</span><span class="p">()</span>
<span class="w">    </span><span class="nx">mux</span><span class="p">.</span><span class="nx">Handle</span><span class="p">(</span><span class="nx">rpc</span><span class="p">.</span><span class="nx">DefaultRPCPath</span><span class="p">,</span><span class="w"> </span><span class="nx">rpcServer</span><span class="p">)</span>

<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">server</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Server</span><span class="p">{</span><span class="nx">Handler</span><span class="p">:</span><span class="w"> </span><span class="nx">mux</span><span class="p">}</span>
<span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">Serve</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span>

<span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">resetElectionTimeout</span><span class="p">()</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">done</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
<span class="w">                </span><span class="k">return</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nx">state</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">state</span>
<span class="w">            </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
</pre></div>
<p>In the main loop we are either in the leader state, follower state or
candidate state.</p>
<p>All states will potentially receive RPC messages from other servers in
the cluster but that won't be modeled in this main loop.</p>
<p>The only thing going on in the main loop is that:</p>
<ul>
<li>We send heartbeat RPCs (leader state)</li>
<li>We try to advance the commit index (leader state only) and apply commands to the state machine (leader and follower states)</li>
<li>We trigger a new election if we haven't received a message in some time (candidate and follower states)</li>
<li>Or we become the leader (candidate state)</li>
</ul>
<div class="highlight"><pre><span></span><span class="w">            </span><span class="k">switch</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="nx">leaderState</span><span class="p">:</span>
<span class="w">                </span><span class="nx">s</span><span class="p">.</span><span class="nx">heartbeat</span><span class="p">()</span>
<span class="w">                </span><span class="nx">s</span><span class="p">.</span><span class="nx">advanceCommitIndex</span><span class="p">()</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="nx">followerState</span><span class="p">:</span>
<span class="w">                </span><span class="nx">s</span><span class="p">.</span><span class="nx">timeout</span><span class="p">()</span>
<span class="w">                </span><span class="nx">s</span><span class="p">.</span><span class="nx">advanceCommitIndex</span><span class="p">()</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="nx">candidateState</span><span class="p">:</span>
<span class="w">                </span><span class="nx">s</span><span class="p">.</span><span class="nx">timeout</span><span class="p">()</span>
<span class="w">                </span><span class="nx">s</span><span class="p">.</span><span class="nx">becomeLeader</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}()</span>
<span class="p">}</span>
</pre></div>
<p>Let's deal with leader election first.</p>
<h3 id="leader-election">Leader election</h3><p>Leader election happens every time nodes haven't received a message
from a valid leader in some time.</p>
<p>I'll break this up into four major pieces:</p>
<ol>
<li>Timing out and becoming a candidate after a random (but bounded)
period of time of not hearing a message from a valid leader:
<code>s.timeout()</code>.</li>
<li>The candidate requests votes from all other servers: <code>s.requestVote()</code>.</li>
<li>All servers handle vote requests: <code>s.HandleRequestVoteRequest()</code>.</li>
<li>A candidate with a quorum of vote requests becomes the leader: <code>s.becomeLeader()</code>.</li>
</ol>
<p>You increment <code>currentTerm</code>, vote for yourself and send RPC vote
requests to other nodes in the server.</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span><span class="w"> </span><span class="nx">resetElectionTimeout</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">interval</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Intn</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">heartbeatMs</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">heartbeatMs</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">debugf</span><span class="p">(</span><span class="s">&quot;New interval: %s.&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">interval</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">electionTimeout</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Add</span><span class="p">(</span><span class="nx">interval</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span><span class="w"> </span><span class="nx">timeout</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="w">    </span><span class="nx">hasTimedOut</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">After</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">electionTimeout</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">hasTimedOut</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s">&quot;Timed out, starting new election.&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">state</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">candidateState</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">currentTerm</span><span class="o">++</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">clusterIndex</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">votedFor</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">id</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">votedFor</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">resetElectionTimeout</span><span class="p">()</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">persist</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">requestVote</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Everything in there is implemented already except for
<code>s.requestVote()</code>. Let's dig into that.</p>
<h4 id="<code>s.requestvote()</code>"><code>s.requestVote()</code></h4><p>By referring back to Figure 2 from the Raft paper we can see how to
model the request vote request and response. Let's turn that into some Go types.</p>
<div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">RPCMessage</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Term</span><span class="w"> </span><span class="kt">uint64</span>
<span class="p">}</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">RequestVoteRequest</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">RPCMessage</span>

<span class="w">    </span><span class="c1">// Candidate requesting vote</span>
<span class="w">    </span><span class="nx">CandidateId</span><span class="w"> </span><span class="kt">uint64</span>

<span class="w">    </span><span class="c1">// Index of candidate&#39;s last log entry</span>
<span class="w">    </span><span class="nx">LastLogIndex</span><span class="w"> </span><span class="kt">uint64</span>

<span class="w">    </span><span class="c1">// Term of candidate&#39;s last log entry</span>
<span class="w">    </span><span class="nx">LastLogTerm</span><span class="w"> </span><span class="kt">uint64</span>
<span class="p">}</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">RequestVoteResponse</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">RPCMessage</span>

<span class="w">    </span><span class="c1">// True means candidate received vote</span>
<span class="w">    </span><span class="nx">VoteGranted</span><span class="w"> </span><span class="kt">bool</span>
<span class="p">}</span>
</pre></div>
<p>Now we just need to fill the <code>RequestVoteRequest</code> struct out and send
it to each other node in the cluster in parallel. As we iterate
through nodes in the cluster, we skip ourselves (we always immediately
vote for ourselves).</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span><span class="w"> </span><span class="nx">requestVote</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">clusterIndex</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">continue</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>

<span class="w">            </span><span class="nx">s</span><span class="p">.</span><span class="nx">debugf</span><span class="p">(</span><span class="s">&quot;Requesting vote from %d.&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Id</span><span class="p">)</span>

<span class="w">            </span><span class="nx">lastLogIndex</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="nx">lastLogTerm</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">Term</span>

<span class="w">            </span><span class="nx">req</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">RequestVoteRequest</span><span class="p">{</span>
<span class="w">                </span><span class="nx">RPCMessage</span><span class="p">:</span><span class="w"> </span><span class="nx">RPCMessage</span><span class="p">{</span>
<span class="w">                    </span><span class="nx">Term</span><span class="p">:</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">                </span><span class="nx">CandidateId</span><span class="p">:</span><span class="w">  </span><span class="nx">s</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">                </span><span class="nx">LastLogIndex</span><span class="p">:</span><span class="w"> </span><span class="nx">lastLogIndex</span><span class="p">,</span>
<span class="w">                </span><span class="nx">LastLogTerm</span><span class="p">:</span><span class="w">  </span><span class="nx">lastLogTerm</span><span class="p">,</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">rsp</span><span class="w"> </span><span class="nx">RequestVoteResponse</span>
<span class="w">            </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">rpcCall</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Server.HandleRequestVoteRequest&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">rsp</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// Will retry later</span>
<span class="w">                </span><span class="k">return</span>
<span class="w">            </span><span class="p">}</span>
</pre></div>
<p>Now remember from Figure 2 in the Raft paper that we must always check
that the RPC request and response is still valid. If the term of the
response is greater than our own term, we must immediately stop
processing and revert to follower state.</p>
<p>Otherwise only if the response is still relevant to us at the moment
(the response term is the same as the request term) <em>and</em> the request
has succeeded do we count the vote.</p>
<div class="highlight"><pre><span></span><span class="w">            </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">            </span><span class="k">defer</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">updateTerm</span><span class="p">(</span><span class="nx">rsp</span><span class="p">.</span><span class="nx">RPCMessage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="nx">dropStaleResponse</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">rsp</span><span class="p">.</span><span class="nx">Term</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">Term</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">dropStaleResponse</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">rsp</span><span class="p">.</span><span class="nx">VoteGranted</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">s</span><span class="p">.</span><span class="nx">debugf</span><span class="p">(</span><span class="s">&quot;Vote granted by %d.&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Id</span><span class="p">)</span>
<span class="w">                </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">votedFor</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">id</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}(</span><span class="nx">i</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>And that's it for the candidate side of requesting a vote.</p>
<p>The implementation of <code>s.updateTerm()</code> is simple. It just takes care
of transitioning to follower state if the term of an RPC message is
greater than the node's current term.</p>
<div class="highlight"><pre><span></span><span class="c1">// Must be called within a s.mu.Lock()</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span><span class="w"> </span><span class="nx">updateTerm</span><span class="p">(</span><span class="nx">msg</span><span class="w"> </span><span class="nx">RPCMessage</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">transitioned</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">Term</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">currentTerm</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">currentTerm</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">Term</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">state</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">followerState</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">setVotedFor</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="nx">transitioned</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s">&quot;Transitioned to follower&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">resetElectionTimeout</span><span class="p">()</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">persist</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">transitioned</span>
<span class="p">}</span>
</pre></div>
<p>And the implementation of <code>s.rpcCall()</code> is a wrapper around <code>net/rpc</code>
to lazily connect.</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span><span class="w"> </span><span class="nx">rpcCall</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">rsp</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="nx">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="kt">error</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">rpcClient</span><span class="w"> </span><span class="o">*</span><span class="nx">rpc</span><span class="p">.</span><span class="nx">Client</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">rpcClient</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">rpcClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">rpcClient</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">rpc</span><span class="p">.</span><span class="nx">DialHTTP</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">Address</span><span class="p">)</span>
<span class="w">        </span><span class="nx">rpcClient</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">rpcClient</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// TODO: where/how to reconnect if the connection must be reestablished?</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">rpcClient</span><span class="p">.</span><span class="nx">Call</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">rsp</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">warnf</span><span class="p">(</span><span class="s">&quot;Error calling %s on %d: %s.&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">Id</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</pre></div>
<p>Let's dig into the other side of request vote, what happens when a
node receives a vote request?</p>
<h4 id="<code>s.handlevoterequest()</code>"><code>s.HandleVoteRequest()</code></h4><p>First off, as discussed above, we must always check the RPC term
versus our own and revert to follower if the term is greater than our
own. (Remember that since this is an RPC request it could come to a
server in any state: leader, candidate, or follower.)</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span><span class="w"> </span><span class="nx">HandleRequestVoteRequest</span><span class="p">(</span><span class="nx">req</span><span class="w"> </span><span class="nx">RequestVoteRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">rsp</span><span class="w"> </span><span class="o">*</span><span class="nx">RequestVoteResponse</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">updateTerm</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">RPCMessage</span><span class="p">)</span>

<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">debugf</span><span class="p">(</span><span class="s">&quot;Received vote request from %d.&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">CandidateId</span><span class="p">)</span>
</pre></div>
<p>Then we can return immediately if the request term is lower than our
own (that means it's an old request).</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="nx">rsp</span><span class="p">.</span><span class="nx">VoteGranted</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="nx">rsp</span><span class="p">.</span><span class="nx">Term</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">currentTerm</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">Term</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">currentTerm</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">debugf</span><span class="p">(</span><span class="s">&quot;Not granting vote request from %d.&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">CandidateId</span><span class="p">)</span>
<span class="w">        </span><span class="nx">Server_assert</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;VoteGranted = false&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">rsp</span><span class="p">.</span><span class="nx">VoteGranted</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
<p>And finally, we check to make sure the requester's log is at least as
up-to-date as our own and that we haven't already voted for
ourselves.</p>
<p>The first condition (up-to-date log) was not described in
the Raft paper that I could find. But the author of the paper
published a Raft TLA+ spec that does <a href="https://github.com/ongardie/raft.tla/blob/master/raft.tla#L284">have it
defined</a>.</p>
<p>And the second condition you might think could never happen since we
already wrote the code that said when we trigger an election we vote
for ourselves. But since each server has a random election timeout,
the one who starts the election will differ in timing sufficiently
enough to catch other servers and allow them to vote for it.</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="nx">lastLogTerm</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">Term</span>
<span class="w">    </span><span class="nx">logLen</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="nx">logOk</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">LastLogTerm</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nx">lastLogTerm</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">LastLogTerm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">lastLogTerm</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">LastLogIndex</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">logLen</span><span class="p">)</span>
<span class="w">    </span><span class="nx">grant</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">Term</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">currentTerm</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="nx">logOk</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">getVotedFor</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">getVotedFor</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">CandidateId</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">grant</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">debugf</span><span class="p">(</span><span class="s">&quot;Voted for %d.&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">CandidateId</span><span class="p">)</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">setVotedFor</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">CandidateId</span><span class="p">)</span>
<span class="w">        </span><span class="nx">rsp</span><span class="p">.</span><span class="nx">VoteGranted</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">resetElectionTimeout</span><span class="p">()</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">persist</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">debugf</span><span class="p">(</span><span class="s">&quot;Not granting vote request from %d.&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">+</span><span class="nx">req</span><span class="p">.</span><span class="nx">CandidateId</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</pre></div>
<p>Lastly, we need to address how the candidate who sent out vote
requests actually becomes the leader.</p>
<h4 id="<code>s.becomeleader()</code>"><code>s.becomeLeader()</code></h4><p>This is a relatively simple method. If we have a quorum of votes, we
become the leader!</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span><span class="w"> </span><span class="nx">becomeLeader</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="w">    </span><span class="nx">quorum</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">votedFor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">quorum</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">quorum</span><span class="o">--</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
<p>There is a bit of bookkeeping we need to do like resetting <code>nextIndex</code>
and <code>matchIndex</code> for each server (noted in Figure 2). And we also need
to append a blank entry for the new term.</p>
<p class="note">
  Despite the section quoted below in code, I still don't understand
  why this blank entry is necessary.
</p><div class="highlight"><pre><span></span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">quorum</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Reset all cluster state</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">nextIndex</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="c1">// Yes, even matchIndex is reset. Figure 2</span>
<span class="w">            </span><span class="c1">// from Raft shows both nextIndex and</span>
<span class="w">            </span><span class="c1">// matchIndex are reset after every election.</span>
<span class="w">            </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">matchIndex</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s">&quot;New leader.&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">state</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">leaderState</span>

<span class="w">        </span><span class="c1">// From Section 8 Client Interaction:</span>
<span class="w">        </span><span class="c1">// &gt; First, a leader must have the latest information on</span>
<span class="w">        </span><span class="c1">// &gt; which entries are committed. The Leader</span>
<span class="w">        </span><span class="c1">// &gt; Completeness Property guarantees that a leader has</span>
<span class="w">        </span><span class="c1">// &gt; all committed entries, but at the start of its</span>
<span class="w">        </span><span class="c1">// &gt; term, it may not know which those are. To find out,</span>
<span class="w">        </span><span class="c1">// &gt; it needs to commit an entry from its term. Raft</span>
<span class="w">        </span><span class="c1">// &gt; handles this by having each leader commit a blank</span>
<span class="w">        </span><span class="c1">// &gt; no-op entry into the log at the start of its term.</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">,</span><span class="w"> </span><span class="nx">Entry</span><span class="p">{</span><span class="nx">Term</span><span class="p">:</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span><span class="w"> </span><span class="nx">Command</span><span class="p">:</span><span class="w"> </span><span class="kc">nil</span><span class="p">})</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">persist</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// Triggers s.appendEntries() in the next tick of the</span>
<span class="w">        </span><span class="c1">// main state loop.</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">heartbeatTimeout</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>And we're done with elections!</p>
<p>When I was working on this for the first time, I just stopped here and
made sure I could get to a stable leader quickly. If it takes more
than 1 term to establish a leader when you run three servers in the
cluster on localhost, you've probably got a bug.</p>
<p>In an ideal environment (which three processes on one machine most
likely is), leadership should be established quite quickly and without
many term changes. As the environment gets more adversarial
(e.g. processes crash frequently or network latency is high and
variable), leadership (and log replication) will take longer.</p>
<p class="note">
    But just because we have leader election working when there are no
    logs does not mean we'll have it working when we introduce log
    replication since parts of voting depend on log analysis.
    <br />
    I had leader election working at one time but then it broke when I
    got log replication working until I found some more bugs in leader
    election and fixed them. Of course, there may still be bugs even
    now.
</p><h3 id="log-replication">Log replication</h3><p>I'll break up log replication into four major pieces:</p>
<ol>
<li>User submits a message to the leader to be replicated: <code>s.Apply()</code>.</li>
<li>The leader sends uncommitted messages (messages from
<code>nextIndex</code>) to all followers: <code>s.appendEntries()</code>.</li>
<li>A follower receives a <code>AppendEntriesRequest</code> and stores new
messages if appropriate, letting the leader know when it does store
the messages: <code>s.HandleAppendEntriesRequest()</code>.</li>
<li>The leader tries to update <code>commitIndex</code> for the last uncommitted
message by seeing if it's been replicated on a quorum of servers:
<code>s.advanceCommitIndex()</code>.</li>
</ol>
<p>Let's dig in in that order.</p>
<h4 id="<code>s.apply()</code>"><code>s.Apply()</code></h4><p>This is the entry point for a user of the cluster to attempt to get
messages replicated into the cluster.</p>
<p>It must be called on the current leader of the cluster. In the future
the failure response might include the current leader. Or the user
could submit messages in parallel to all nodes in the cluster and
ignore <code>ErrApplyToLeader</code>. In the meantime we just assume the user can
figure out which server in the cluster is the leader.</p>
<div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">ErrApplyToLeader</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;Cannot apply message to follower, apply to leader.&quot;</span><span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span><span class="w"> </span><span class="nx">Apply</span><span class="p">(</span><span class="nx">commands</span><span class="w"> </span><span class="p">[][]</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">([]</span><span class="nx">ApplyResult</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">state</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">leaderState</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">ErrApplyToLeader</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">debugf</span><span class="p">(</span><span class="s">&quot;Processing %d new entry!&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">commands</span><span class="p">))</span>
</pre></div>
<p>Next we'll store the message in the leader's log along with a
Go channel that we must block on for the result of applying
the message in the state machine after the message has been committed
to the cluster.</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="nx">resultChans</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">([]</span><span class="kd">chan</span><span class="w"> </span><span class="nx">ApplyResult</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">commands</span><span class="p">))</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">command</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">commands</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">resultChans</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="nx">ApplyResult</span><span class="p">)</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">,</span><span class="w"> </span><span class="nx">Entry</span><span class="p">{</span>
<span class="w">            </span><span class="nx">Term</span><span class="p">:</span><span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span>
<span class="w">            </span><span class="nx">Command</span><span class="p">:</span><span class="w"> </span><span class="nx">command</span><span class="p">,</span>
<span class="w">            </span><span class="nx">result</span><span class="p">:</span><span class="w">  </span><span class="nx">resultChans</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">persist</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">commands</span><span class="p">))</span>
</pre></div>
<p>Then we kick off the replication process (this will not block).</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s">&quot;Waiting to be applied!&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">appendEntries</span><span class="p">()</span>
</pre></div>
<p>And then we block until we receive results from each of the channels we created.</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="c1">// TODO: What happens if this takes too long?</span>
<span class="w">    </span><span class="nx">results</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">([]</span><span class="nx">ApplyResult</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">commands</span><span class="p">))</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">wg</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
<span class="w">    </span><span class="nx">wg</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">commands</span><span class="p">))</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">ch</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">resultChans</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="kd">chan</span><span class="w"> </span><span class="nx">ApplyResult</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">c</span>
<span class="w">            </span><span class="nx">wg</span><span class="p">.</span><span class="nx">Done</span><span class="p">()</span>
<span class="w">        </span><span class="p">}(</span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">ch</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">wg</span><span class="p">.</span><span class="nx">Wait</span><span class="p">()</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">results</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</pre></div>
<p>The interesting thing here is that appending entries is detached from
the messages we just received. <code>s.appendEntries()</code> will probably
include at least the messages we just appended to our log, but it
might include more too if some servers are not very up-to-date. It may
even include less than the messages we append to our log since we'll
restrict the number of entries to send at one time so we keep latency
down.</p>
<h4 id="<code>s.appendentries()</code>"><code>s.appendEntries()</code></h4><p>This is the meat of log replication on the leader side. We send
unreplicated messages to each other server in the cluster.</p>
<p>By again referring back to Figure 2 from the Raft paper we can see how
to model the request vote request and response. Let's turn that into
some Go types too.</p>
<div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">AppendEntriesRequest</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">RPCMessage</span>

<span class="w">    </span><span class="c1">// So follower can redirect clients</span>
<span class="w">    </span><span class="nx">LeaderId</span><span class="w"> </span><span class="kt">uint64</span>

<span class="w">    </span><span class="c1">// Index of log entry immediately preceding new ones</span>
<span class="w">    </span><span class="nx">PrevLogIndex</span><span class="w"> </span><span class="kt">uint64</span>

<span class="w">    </span><span class="c1">// Term of prevLogIndex entry</span>
<span class="w">    </span><span class="nx">PrevLogTerm</span><span class="w"> </span><span class="kt">uint64</span>

<span class="w">    </span><span class="c1">// Log entries to store. Empty for heartbeat.</span>
<span class="w">    </span><span class="nx">Entries</span><span class="w"> </span><span class="p">[]</span><span class="nx">Entry</span>

<span class="w">    </span><span class="c1">// Leader&#39;s commitIndex</span>
<span class="w">    </span><span class="nx">LeaderCommit</span><span class="w"> </span><span class="kt">uint64</span>
<span class="p">}</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">AppendEntriesResponse</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">RPCMessage</span>

<span class="w">    </span><span class="c1">// true if follower contained entry matching prevLogIndex and</span>
<span class="w">    </span><span class="c1">// prevLogTerm</span>
<span class="w">    </span><span class="nx">Success</span><span class="w"> </span><span class="kt">bool</span>
<span class="p">}</span>
</pre></div>
<p>For the method itself, we start optimistically sending no entries and
decrement <code>nextIndex</code> for each server as the server fails to replicate
messages. This means that we might eventually end up sending the
entire log to one or all servers.</p>
<p>We'll set a max number of entries to send per request so we avoid
unbounded latency as followers store entries to disk. But we still
want to send a large batch so that we amortize the cost of <code>fsync</code>.</p>
<div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">MAX_APPEND_ENTRIES_BATCH</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">8</span><span class="nx">_000</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span><span class="w"> </span><span class="nx">appendEntries</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Don&#39;t need to send message to self</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">clusterIndex</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">continue</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>

<span class="w">            </span><span class="nx">next</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">nextIndex</span>
<span class="w">            </span><span class="nx">prevLogIndex</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">next</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">            </span><span class="nx">prevLogTerm</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">prevLogIndex</span><span class="p">].</span><span class="nx">Term</span>

<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">entries</span><span class="w"> </span><span class="p">[]</span><span class="nx">Entry</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">nextIndex</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">s</span><span class="p">.</span><span class="nx">debugf</span><span class="p">(</span><span class="s">&quot;len: %d, next: %d, server: %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">),</span><span class="w"> </span><span class="nx">next</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Id</span><span class="p">)</span>
<span class="w">                </span><span class="nx">entries</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">next</span><span class="p">:]</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// Keep latency down by only applying N at a time.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">entries</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nx">MAX_APPEND_ENTRIES_BATCH</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">entries</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">entries</span><span class="p">[:</span><span class="nx">MAX_APPEND_ENTRIES_BATCH</span><span class="p">]</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="nx">lenEntries</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">entries</span><span class="p">))</span>
<span class="w">            </span><span class="nx">req</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">AppendEntriesRequest</span><span class="p">{</span>
<span class="w">                </span><span class="nx">RPCMessage</span><span class="p">:</span><span class="w"> </span><span class="nx">RPCMessage</span><span class="p">{</span>
<span class="w">                    </span><span class="nx">Term</span><span class="p">:</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">                </span><span class="nx">LeaderId</span><span class="p">:</span><span class="w">     </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">[</span><span class="nx">s</span><span class="p">.</span><span class="nx">clusterIndex</span><span class="p">].</span><span class="nx">Id</span><span class="p">,</span>
<span class="w">                </span><span class="nx">PrevLogIndex</span><span class="p">:</span><span class="w"> </span><span class="nx">prevLogIndex</span><span class="p">,</span>
<span class="w">                </span><span class="nx">PrevLogTerm</span><span class="p">:</span><span class="w">  </span><span class="nx">prevLogTerm</span><span class="p">,</span>
<span class="w">                </span><span class="nx">Entries</span><span class="p">:</span><span class="w">      </span><span class="nx">entries</span><span class="p">,</span>
<span class="w">                </span><span class="nx">LeaderCommit</span><span class="p">:</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">commitIndex</span><span class="p">,</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">rsp</span><span class="w"> </span><span class="nx">AppendEntriesResponse</span>
<span class="w">            </span><span class="nx">s</span><span class="p">.</span><span class="nx">debugf</span><span class="p">(</span><span class="s">&quot;Sending %d entries to %d for term %d.&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">entries</span><span class="p">),</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Id</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">Term</span><span class="p">)</span>
<span class="w">            </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">rpcCall</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Server.HandleAppendEntriesRequest&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">rsp</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// Will retry next tick</span>
<span class="w">                </span><span class="k">return</span>
<span class="w">            </span><span class="p">}</span>
</pre></div>
<p>Now, as with every RPC request and response, we must check terms and
potentially drop the message if it's outdated.</p>
<div class="highlight"><pre><span></span><span class="w">            </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">            </span><span class="k">defer</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">updateTerm</span><span class="p">(</span><span class="nx">rsp</span><span class="p">.</span><span class="nx">RPCMessage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="nx">dropStaleResponse</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">rsp</span><span class="p">.</span><span class="nx">Term</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">Term</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">leaderState</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">dropStaleResponse</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span>
<span class="w">            </span><span class="p">}</span>
</pre></div>
<p>Otherwise, if the message was successful, we'll update <code>matchIndex</code>
(the last confirmed message stored on the follower) and <code>nextIndex</code>
(the next likely message to send to the follower).</p>
<p>If the message was not successful, we decrement <code>nextIndex</code>. Next time
<code>s.appendEntries()</code> is called it will include one more previous
message for this replica.</p>
<div class="highlight"><pre><span></span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">rsp</span><span class="p">.</span><span class="nx">Success</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">prev</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">nextIndex</span>
<span class="w">                </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">nextIndex</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">max</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">PrevLogIndex</span><span class="o">+</span><span class="nx">lenEntries</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">                </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">matchIndex</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">nextIndex</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                </span><span class="nx">s</span><span class="p">.</span><span class="nx">debugf</span><span class="p">(</span><span class="s">&quot;Message accepted for %d. Prev Index: %d, Next Index: %d, Match Index: %d.&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Id</span><span class="p">,</span><span class="w"> </span><span class="nx">prev</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">nextIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">matchIndex</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">nextIndex</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">max</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">nextIndex</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">                </span><span class="nx">s</span><span class="p">.</span><span class="nx">debugf</span><span class="p">(</span><span class="s">&quot;Forced to go back to %d for: %d.&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">nextIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Id</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}(</span><span class="nx">i</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>And we're done the leader side of append entries!</p>
<h4 id="<code>s.handleappendentriesrequest()</code>"><code>s.HandleAppendEntriesRequest()</code></h4><p>Now for the follower side of log replication. This is, again, an RPC
handler that could be called at any moment. So we need to potentially
update the <code>term</code> (and transition to follower).</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span><span class="w"> </span><span class="nx">HandleAppendEntriesRequest</span><span class="p">(</span><span class="nx">req</span><span class="w"> </span><span class="nx">AppendEntriesRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">rsp</span><span class="w"> </span><span class="o">*</span><span class="nx">AppendEntriesResponse</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">updateTerm</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">RPCMessage</span><span class="p">)</span>
</pre></div>
<p>"Hidden" in the "Candidates (5.2):" section of Figure 2 is an additional rule about:</p>
<blockquote><p>If AppendEntries RPC received from new leader: convert to follower</p>
</blockquote>
<p>So we also need to handle that here. And if we're still not a
follower, we'll return immediately.</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="c1">// From Candidates (5.2) in Figure 2</span>
<span class="w">    </span><span class="c1">// If AppendEntries RPC received from new leader: convert to follower</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">Term</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">currentTerm</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">candidateState</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">state</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">followerState</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">rsp</span><span class="p">.</span><span class="nx">Term</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">currentTerm</span>
<span class="w">    </span><span class="nx">rsp</span><span class="p">.</span><span class="nx">Success</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">false</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">state</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">followerState</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">debugf</span><span class="p">(</span><span class="s">&quot;Non-follower cannot append entries.&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
<p>Next, we also return early if the request term is less than our
own. This would represent an old request.</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">Term</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">currentTerm</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">debugf</span><span class="p">(</span><span class="s">&quot;Dropping request from old leader %d: term %d.&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">LeaderId</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">Term</span><span class="p">)</span>
<span class="w">        </span><span class="c1">// Not a valid leader.</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
<p>Now, finally, we know we're receiving a request from a valid
leader. So we need to immediately bump the election timeout.</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="c1">// Valid leader so reset election.</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">resetElectionTimeout</span><span class="p">()</span>
</pre></div>
<p>Then we do the log comparison to see if we can add the entries sent
from this request. Specifically, we make sure that our log at
<code>req.PrevLogIndex</code> exists and has the same term as <code>req.PrevLogTerm</code>.</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="nx">logLen</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">))</span>
<span class="w">    </span><span class="nx">validPreviousLog</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">PrevLogIndex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="cm">/* This is the induction step */</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">PrevLogIndex</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">logLen</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">            </span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">req</span><span class="p">.</span><span class="nx">PrevLogIndex</span><span class="p">].</span><span class="nx">Term</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">PrevLogTerm</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">validPreviousLog</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s">&quot;Not a valid log.&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
<p>Next, we've got valid entries that we need to add to our log. This
implementation is a little more complex because we'll make use of Go
slice capacity so that <code>append()</code> never allocates.</p>
<p>Importantly, we must truncate the log if a new entry ever conflicts
with an existing one:</p>
<blockquote><p>If an existing entry conflicts with a new one (same index
but different terms), delete the existing entry and all that
follow it (5.3)</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="nx">next</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">PrevLogIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="nx">nNewEntries</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">next</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">next</span><span class="o">+</span><span class="nb">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Entries</span><span class="p">));</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">e</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">Entries</span><span class="p">[</span><span class="nx">i</span><span class="o">-</span><span class="nx">next</span><span class="p">]</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nb">cap</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">newTotal</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">next</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Entries</span><span class="p">))</span>
<span class="w">            </span><span class="c1">// Second argument must actually be `i`</span>
<span class="w">            </span><span class="c1">// not `0` otherwise the copy after this</span>
<span class="w">            </span><span class="c1">// doesn&#39;t work.</span>
<span class="w">            </span><span class="c1">// Only copy until `i`, not `newTotal` since</span>
<span class="w">            </span><span class="c1">// we&#39;ll continue appending after this.</span>
<span class="w">            </span><span class="nx">newLog</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">([]</span><span class="nx">Entry</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">newTotal</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
<span class="w">            </span><span class="nb">copy</span><span class="p">(</span><span class="nx">newLog</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span>
<span class="w">            </span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">newLog</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Term</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Term</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">prevCap</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">cap</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span>
<span class="w">            </span><span class="c1">// If an existing entry conflicts with a new</span>
<span class="w">            </span><span class="c1">// one (same index but different terms),</span>
<span class="w">            </span><span class="c1">// delete the existing entry and all that</span>
<span class="w">            </span><span class="c1">// follow it (5.3)</span>
<span class="w">            </span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">[:</span><span class="nx">i</span><span class="p">]</span>
<span class="w">            </span><span class="nx">Server_assert</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Capacity remains the same while we truncated.&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">cap</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">),</span><span class="w"> </span><span class="nx">prevCap</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">debugf</span><span class="p">(</span><span class="s">&quot;Appending entry: %s. At index: %d.&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">Command</span><span class="p">),</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">))</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">Server_assert</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Existing log is the same as new log&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Term</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Term</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="p">)</span>
<span class="w">            </span><span class="nx">Server_assert</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Length is directly related to the index.&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">)),</span><span class="w"> </span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="nx">nNewEntries</span><span class="o">++</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
<p>Finally, we update the server's local <code>commitIndex</code> to the min of
<code>req.LeaderCommit</code> and our own log length.</p>
<p>And finally we persist all these changes and mark the response as
successful.</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">LeaderCommit</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">commitIndex</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">commitIndex</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">min</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">LeaderCommit</span><span class="p">,</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">persist</span><span class="p">(</span><span class="nx">nNewEntries</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">nNewEntries</span><span class="p">)</span>

<span class="w">    </span><span class="nx">rsp</span><span class="p">.</span><span class="nx">Success</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</pre></div>
<p>So the combined behavior of the leader and follower when replicating
is that a follower not in sync with the leader may eventually go down
to the beginning of the log so the leader and follower have some first
N messages of the log that match.</p>
<h4 id="<code>s.advancecommitindex()</code>"><code>s.advanceCommitIndex()</code></h4><p>Now when not just one follower but a quorum of followers all have a
matching first N messages, the leader can advance the cluster's
<code>commitIndex</code>.</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span><span class="w"> </span><span class="nx">advanceCommitIndex</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// Leader can update commitIndex on quorum.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">leaderState</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">lastLogIndex</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">lastLogIndex</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">commitIndex</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">--</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">quorum</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">quorum</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">break</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="nx">isLeader</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">clusterIndex</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">cluster</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">matchIndex</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">isLeader</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">quorum</span><span class="o">--</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">quorum</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">s</span><span class="p">.</span><span class="nx">commitIndex</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">i</span>
<span class="w">                </span><span class="nx">s</span><span class="p">.</span><span class="nx">debugf</span><span class="p">(</span><span class="s">&quot;New commit index: %d.&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">)</span>
<span class="w">                </span><span class="k">break</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
<p>And for every state a server might be in, if there are messages
committed but not applied, we'll apply one here. And importantly,
we'll pass the result back to the message's result channel if it
exists, so that <code>s.Apply()</code> can learn about the result.</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">lastApplied</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">commitIndex</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">log</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">s</span><span class="p">.</span><span class="nx">lastApplied</span><span class="p">]</span>

<span class="w">        </span><span class="c1">// len(log.Command) == 0 is a noop committed by the leader.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">log</span><span class="p">.</span><span class="nx">Command</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">s</span><span class="p">.</span><span class="nx">debugf</span><span class="p">(</span><span class="s">&quot;Entry applied: %d.&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">lastApplied</span><span class="p">)</span>
<span class="w">            </span><span class="c1">// TODO: what if Apply() takes too long?</span>
<span class="w">            </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">statemachine</span><span class="p">.</span><span class="nx">Apply</span><span class="p">(</span><span class="nx">log</span><span class="p">.</span><span class="nx">Command</span><span class="p">)</span>

<span class="w">            </span><span class="c1">// Will be nil for follower entries and for no-op entries.</span>
<span class="w">            </span><span class="c1">// Not nil for all user submitted messages.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">log</span><span class="p">.</span><span class="nx">result</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">log</span><span class="p">.</span><span class="nx">result</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">ApplyResult</span><span class="p">{</span>
<span class="w">                    </span><span class="nx">Result</span><span class="p">:</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">Error</span><span class="p">:</span><span class="w">  </span><span class="nx">err</span><span class="p">,</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">lastApplied</span><span class="o">++</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<h3 id="heartbeats">Heartbeats</h3><p>Heartbeats combine log replication and leader election. Heartbeats
stave off leader election (follower timeouts). And heartbeats also
bring followers up-to-date if they are behind.</p>
<p>And it's a simple method. If it's time to heartbeat, we call
<code>s.appendEntries()</code>. That's it.</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span><span class="w"> </span><span class="nx">heartbeat</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="w">    </span><span class="nx">timeForHeartbeat</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">After</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">heartbeatTimeout</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">timeForHeartbeat</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">heartbeatTimeout</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Add</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">heartbeatMs</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s">&quot;Sending heartbeat&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">appendEntries</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>The reason this staves off leader election is because any number of
entries (0 or N) will come from a valid leader and will thus cause the
followers to reset their election timeout.</p>
<p>And that's the entirety of (the basics of) Raft.</p>
<p>There are probably bugs.</p>
<h3 id="running-kvapi">Running kvapi</h3><p>Now let's run the key-value API.</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>cmd/kvapi<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>go<span class="w"> </span>build
<span class="gp">$ </span>rm<span class="w"> </span>*.dat
</pre></div>
<h4 id="terminal-1">Terminal 1</h4><div class="highlight"><pre><span></span><span class="gp">$ </span>./kvapi<span class="w"> </span>--node<span class="w"> </span><span class="m">0</span><span class="w"> </span>--http<span class="w"> </span>:2020<span class="w"> </span>--cluster<span class="w"> </span><span class="s2">&quot;0,:3030;1,:3031;2,:3032&quot;</span>
</pre></div>
<h4 id="terminal-2">Terminal 2</h4><div class="highlight"><pre><span></span><span class="gp">$ </span>./kvapi<span class="w"> </span>--node<span class="w"> </span><span class="m">1</span><span class="w"> </span>--http<span class="w"> </span>:2021<span class="w"> </span>--cluster<span class="w"> </span><span class="s2">&quot;0,:3030;1,:3031;2,:3032&quot;</span>
</pre></div>
<h4 id="terminal-3">Terminal 3</h4><div class="highlight"><pre><span></span><span class="gp">$ </span>./kvapi<span class="w"> </span>--node<span class="w"> </span><span class="m">2</span><span class="w"> </span>--http<span class="w"> </span>:2022<span class="w"> </span>--cluster<span class="w"> </span><span class="s2">&quot;0,:3030;1,:3031;2,:3032&quot;</span>
</pre></div>
<h4 id="terminal-4">Terminal 4</h4><p>Remember that requests will go through the leader (except for if we
turn that off in the <code>/get</code> request). So you'll have to try sending a
message to each server until you find the leader.</p>
<p>To set a key:</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>curl<span class="w"> </span>http://localhost:2020/set?key<span class="o">=</span>y<span class="p">&amp;</span><span class="nv">value</span><span class="o">=</span>hello
</pre></div>
<p>To get a key:</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>curl<span class="w"> </span>http://localhost:2020/get<span class="se">\?</span>key<span class="se">\=</span>y
</pre></div>
<p>And that's that! Try killing a server and restarting it. A new leader
will be elected so you'll need to find the right one to send requests
to again. But all existing entries should still be there.</p>
<h3 id="a-test-rig">A test rig</h3><p>I won't cover the <a href="https://github.com/eatonphil/goraft/blob/main/cmd/sim/main.go">implementation of my test
rig</a> in
this post but I will describe it.</p>
<p>It's nowhere near Jepsen but it does have a specific focus:</p>
<ol>
<li>Can the cluster elect a leader?</li>
<li>Can the cluster store logs correctly?</li>
<li>Can the cluster of three nodes tolerate one node down?</li>
<li>How fast can it store N messages?</li>
<li>Are messages recovered correctly when the nodes shut down and start back up?</li>
<li>If a node's logs are deleted, is the log for that node recovered after it is restarted?</li>
</ol>
<p>This implementation passes these tests and handles around 20k-40k entries/second.</p>
<h3 id="considerations">Considerations</h3><p>This was quite a challenging project. Normally when I hack on stuff
like this I have TV (The Simpsons) on in the background. It's sort of
dumb but this was the first project where I absolutely could not focus
with that background noise.</p>
<p>There are a tedious number of conditions and I am not sure I got them
all (right). Numerous ways for subtle bugs.</p>
<h4 id="race-conditions-and-deadlocks">Race conditions and deadlocks</h4><p>It's very easy to program in race conditions. Thankfully Go has the
<code>-race</code> flag that detects this. This makes sure that you are locking
read and write access to shared variables when necessary.</p>
<p>On the other side of race conditions, Go does not help you out with:
deadlocks. Once you've got locks in place for shared variables, you
need to make sure you're releasing the locks appropriately too.</p>
<p>Thankfully someone wrote a swap-in replacement for the Go <code>sync</code>
package called
<a href="https://github.com/sasha-s/go-deadlock">go-deadlock</a>. When you import
this package instead of the default <code>sync</code> package, it will panic and
give you a stacktrace when it thinks you hit a deadlock.</p>
<p>Sometimes it thinks you hit a deadlock because a method that needs a
lock takes too long. Sometimes that time it takes is legitimate (or
something you haven't optimized yet). But actually its default of
<code>30s</code> is not really aggressive at all.</p>
<p>So I normally set the deadlock timeout to <code>2s</code> and eventually would
like to make that more like <code>100ms</code>:</p>
<div class="highlight"><pre><span></span>sync.Opts.DeadlockTimeout = 2000 * time.Millisecond
</pre></div>
<p>It's mostly the <code>persist()</code> function that causes <code>go-deadlock</code> to
think there's a deadlock because it tries to synchronously write a
bunch of data to disk.</p>
<h5 id="<code>go-deadlock</code>-is-slow"><code>go-deadlock</code> is slow</h5><p>The <code>go-deadlock</code> package is incredibly useful. But don't forget to
turn it off for benchmarks. With it on I get around 4-8k
entries/second. With it off I get around 20k-40k entries/second.</p>
<h4 id="unbounded-memory">Unbounded memory</h4><p>Another issue in this implementation is that the log keeps growing
indefinitely <em>and</em> the entire log is duplicated in memory.</p>
<p>There are two ways to deal with that:</p>
<ol>
<li>Implement Raft snapshotting so the log can be truncated safely.</li>
<li>Keep only some number of entries in memory (say, 1 million) and
read from disk as needed when logs need to be verified. In ideal
operation this would never happen since ideally all servers are
always on, never miss entries, and just keep appending. But "ideal"
won't always happen.</li>
</ol>
<p>Similarly, there is unbounded and unreused channel creation for
notifying <code>s.Apply()</code> when the user-submitted message(s) finish.</p>
<h4 id="net/rpc-and-encoding/gob">net/rpc and encoding/gob</h4><p>In the <code>persist()</code> section above I already mentioned how I prototyped
this using Go's builtin gob encoding. And I mentioned how inefficient
it was. It's also pretty slow and I learned that because <code>net/rpc</code>
uses it and after everything I did <code>net/rpc</code> started to be the
bottleneck in my benchmarks. This isn't incredibly surprising.</p>
<p>So a future version of this code might implement its own protocol and
own encoding (like we did for disk) on top of TCP rather than use
<code>net/rpc</code>.</p>
<h4 id="jepsen">Jepsen</h4><p>Everyone wants to know how a distributed algorithm does against
<a href="https://github.com/jepsen-io/jepsen">Jepsen</a>, which tests
linearizability of distributed systems in the face of network and
process faults.</p>
<p>But the setup is not trivial so I haven't hooked it up to this project
yet. This would be a good area for future work.</p>
<h4 id="election-timeout-and-the-environment">Election timeout and the environment</h4><p>One thing I noticed as I was trying out alternatives to <code>net/rpc</code>
(alternatives that injected latency to simulate a bad environment) is
that election timeouts should probably be tuned with latency of the
cluster in mind.</p>
<p>If the election timeout is every <code>300ms</code> but the latency of the
cluster is near <code>1s</code>, you're going to have non-stop leader election.</p>
<p>When I adjusted the election timeout to be every <code>2s</code> when the latency
of the cluster is near <code>1s</code>, everything was fine. Maybe this means
there's a bug in my code but I don't think so.</p>
<h4 id="client-request-serial-identifier">Client request serial identifier</h4><p>One major part of the Raft protocol I did not cover is that the client
is supposed to send a serial identifier for each message sent to the
cluster. This is to ensure that messages are not accidentally
duplicated at any level of the entire software stack.</p>
<p><a href="https://web.stanford.edu/~ouster/cgi-bin/papers/OngaroPhD.pdf">Diego Ongaro's
thesis</a>
goes into more detail about this than the Raft paper. Search in that
PDF for "session".</p>
<p>Again I just completely ignored the possibility of duplicate messages
in this implementation so far.</p>
<h3 id="references">References</h3><p>Finally, I could not have done this without a bunch of internet
help. This project took me about 7 months in total. The first 5 months
I was trying to figure it out mostly on my own, just looking at the
Raft paper.</p>
<p>The biggest breakthrough came from discovering the author of Raft's
TLA+ spec for Raft. Formal methods sound scary but it was truly not
too bad! This was the first "implementation" of Raft that was in a
single file of code. And under 500 lines.</p>
<p>Jack Vanlightly's guide to reading TLA+ helped a bunch.</p>
<p>Finally, I had to peer at other implementations, especially to figure
out locking and avoiding deadlocks.</p>
<p>Here's everything that helped me out.</p>
<ul>
<li><a href="https://raft.github.io/raft.pdf">In Search of an Understandable Consensus Algorithm</a>: The Raft paper.</li>
<li><a href="https://github.com/ongardie/raft.tla/blob/master/raft.tla">raft.tla</a>: Diego Ongaro's TLA+ spec for Raft.</li>
<li>Jon Gjengset's <a href="https://thesquareplanet.com/blog/students-guide-to-raft/">Students' Guide to Raft</a></li>
<li>Jack Vanlightly's <a href="https://medium.com/splunk-maas/detecting-bugs-in-data-infrastructure-using-formal-methods-704fde527c58">Detecting Bugs in Data Infrastructure using Formal Methods (TLA+ Series Part 1)</a>: An intro to TLA+.</li>
</ul>
<p>And useful implementations I looked at for inspiration and clarity.</p>
<ul>
<li>Hashicorp's <a href="https://github.com/hashicorp/raft">Raft implementation</a> in Go: Although it's often quite complicated to learn from since it actually is intended for production.</li>
<li>Eli Bendersky's <a href="https://github.com/eliben/raft">Raft implementation</a> in Go: Although I got confused following it since it used signed integers and <code>-1</code> to represent base cases. Signed integers is a fair choice as far as I can tell, I just wanted to only use unsigned integers.</li>
<li>Jing Yang's <a href="https://github.com/ditsing/ruaft">Raft implementation</a> in Rust: Although I find Rust hard to read.</li>
</ul>
<p>And I haven't tried these but they look cool:</p>
<ul>
<li><a href="https://jepsen.io/services#training">Raft course taught by Jepsen</a></li>
<li><a href="https://www.dabeaz.com/raft.html">Raft course taught by David Beazley</a></li>
</ul>
<p>Cheers!</p>
<p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">I wrote about implementing Raft in Go. By far the most challenging project I&#39;ve worked on in spare time. About 7 months sporadically.<br><br>I&#39;m not an expert, and this is not intended to be used in production. I wanted a better background on the subject!<a href="https://t.co/EhyBuQ4pD3">https://t.co/EhyBuQ4pD3</a> <a href="https://t.co/vGhBbV1shf">pic.twitter.com/vGhBbV1shf</a></p>&mdash; Phil Eaton (@eatonphil) <a href="https://twitter.com/eatonphil/status/1661720451616210944?ref_src=twsrc%5Etfw">May 25, 2023</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<style>.feedback{display:initial;}</style>
	<div class="feedback">
	  <h4>Feedback</h4>
	  <p><small>As always,
	      please <a href="mailto:phil@eatonphil.com">email</a>
	      or <a href="https://twitter.com/eatonphil">tweet me</a>
	      with questions, corrections, or ideas!</small></p>

	</div>
      </div>
    </div>
    <footer>
      <div class="container">
	<div>
	  <div class="row">
	    <div class="feedback">
	      <h4>Frequent Topics</h4>
	      <div class="tags"><a href="/tags/javascript.html" class="tag">javascript (24)</a><a href="/tags/parsing.html" class="tag">parsing (21)</a><a href="/tags/databases.html" class="tag">databases (20)</a><a href="/tags/postgres.html" class="tag">postgres (14)</a><a href="/tags/golang.html" class="tag">golang (14)</a><a href="/tags/compilers.html" class="tag">compilers (14)</a><a href="/tags/sql.html" class="tag">sql (11)</a><a href="/tags/interpreters.html" class="tag">interpreters (11)</a><a href="/tags/lisp.html" class="tag">lisp (9)</a><a href="/tags/books.html" class="tag">books (9)</a><a href="/tags/python.html" class="tag">python (8)</a><a href="/tags/go.html" class="tag">go (8)</a><a href="/tags/zig.html" class="tag">zig (7)</a><a href="/tags/management.html" class="tag">management (7)</a><a href="/tags/json.html" class="tag">json (7)</a><a href="/tags/scheme.html" class="tag">scheme (6)</a><a href="/tags/linux.html" class="tag">linux (6)</a><a href="/tags/learning.html" class="tag">learning (6)</a><a href="/tags/x86-amd64.html" class="tag">x86/amd64 (5)</a><a href="/tags/typescript.html" class="tag">typescript (5)</a></div>
	    </div>
	  </div>
	  <div class="row" id="subscribe">
	    <style type="text/css">
  /* LOADER */
  .ml-form-embedSubmitLoad {
      display: inline-block;
      width: 20px;
      height: 20px;
  }
  .g-recaptcha {
      transform: scale(1);
      -webkit-transform: scale(1);
      transform-origin: 0 0;
      -webkit-transform-origin: 0 0;
      height: ;
  }
  .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      border: 0;
  }
  .ml-form-embedSubmitLoad:after {
      content: " ";
      display: block;
      width: 11px;
      height: 11px;
      margin: 1px;
      border-radius: 50%;
      border: 4px solid #fff;
      border-color: #ffffff #ffffff #ffffff transparent;
      animation: ml-form-embedSubmitLoad 1.2s linear infinite;
  }
  @keyframes ml-form-embedSubmitLoad {
      0% {
          transform: rotate(0deg);
      }
      100% {
          transform: rotate(360deg);
      }
  }
  #mlb2-3175296.ml-form-embedContainer {
      box-sizing: border-box;
      display: table;
      margin: 0 auto;
      position: static;
      width: 100% !important;
  }
  #mlb2-3175296.ml-form-embedContainer h3,
  #mlb2-3175296.ml-form-embedContainer p,
  #mlb2-3175296.ml-form-embedContainer span,
  #mlb2-3175296.ml-form-embedContainer button {
      text-transform: none !important;
      letter-spacing: normal !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper {
      border-width: 0px;
      border-color: transparent;
  border-radius: 4px;
  border-style: solid;
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  position: relative;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-align-left { text-align: left; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-align-center {
  text-align: center;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-align-default { display: table-cell !important; vertical-align: middle !important; text-align: center !important; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-align-right { text-align: right; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedHeader img {
  border-top-left-radius: 4px;
  border-top-right-radius: 4px;
  height: auto;
  margin: 0 auto !important;
  max-width: 100%;
  width: undefinedpx;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody.ml-form-embedBodyHorizontal {
  padding-bottom: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent {
  text-align: left;
  margin: 0 0 20px 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent p,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent p {
  color: #000000;
  font-size: 14px;
  font-weight: 400;
  line-height: 20px;
  margin: 0 0 10px 0;
  text-align: left;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent ul,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent ol,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent ul,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent ol {
  color: #000000;
  font-size: 14px;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent ol ol,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent ol ol {
  list-style-type: lower-alpha;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent ol ol ol,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent ol ol ol {
  list-style-type: lower-roman;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent p a,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent p a {
  color: #000000;
  text-decoration: underline;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-block-form .ml-field-group {
  text-align: left!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-block-form .ml-field-group label {
  margin-bottom: 5px;
  color: #333333;
  font-size: 14px;
  font-weight: bold; font-style: normal; text-decoration: none;;
  display: inline-block;
  line-height: 20px;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent p:last-child,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent p:last-child {
  margin: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody form {
  margin: 0;
  width: 100%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-formContent,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow {
  margin: 0 0 20px 0;
  width: 100%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow {
  float: left;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-formContent.horozintalForm {
  margin: 0;
  padding: 0 0 20px 0;
  width: 100%;
  height: auto;
  float: left;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow {
  margin: 0 0 10px 0;
  width: 100%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow.ml-last-item {
  margin: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow.ml-formfieldHorizintal {
  margin: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input {
  background-color: #ffffff !important;
  color: #333333 !important;
  border-color: #cccccc;
  border-radius: 4px !important;
  border-style: solid !important;
  border-width: 1px !important;
  font-size: 14px !important;
  height: auto;
  line-height: 21px !important;
  margin-bottom: 0;
  margin-top: 0;
  margin-left: 0;
  margin-right: 0;
  padding: 10px 10px !important;
  width: 100% !important;
  box-sizing: border-box !important;
  max-width: 100% !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input::-webkit-input-placeholder,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input::-webkit-input-placeholder { color: #333333; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input::-moz-placeholder,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input::-moz-placeholder { color: #333333; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input:-ms-input-placeholder,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input:-ms-input-placeholder { color: #333333; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input:-moz-placeholder,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input:-moz-placeholder { color: #333333; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow textarea, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow textarea {
  background-color: #ffffff !important;
  color: #333333 !important;
  border-color: #cccccc;
  border-radius: 4px !important;
  border-style: solid !important;
  border-width: 1px !important;
  font-size: 14px !important;
  height: auto;
  line-height: 21px !important;
  margin-bottom: 0;
  margin-top: 0;
  padding: 10px 10px !important;
  width: 100% !important;
  box-sizing: border-box !important;
  max-width: 100% !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before {
  border-color: #cccccc!important;
  background-color: #ffffff!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input.custom-control-input[type="checkbox"]{
  box-sizing: border-box;
  padding: 0;
  position: absolute;
  z-index: -1;
  opacity: 0;
  margin-top: 5px;
  margin-left: -1.5rem;
  overflow: visible;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before {
  border-radius: 4px!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow input[type=checkbox]:checked~.label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox input[type=checkbox]:checked~.label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-input:checked~.custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-input:checked~.custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox input[type=checkbox]:checked~.label-description::after {
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23fff' d='M6.564.75l-3.59 3.612-1.538-1.55L0 4.26 2.974 7.25 8 2.193z'/%3e%3c/svg%3e");
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-input:checked~.custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-input:checked~.custom-control-label::after {
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e");
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-input:checked~.custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-input:checked~.custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-input:checked~.custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-input:checked~.custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox input[type=checkbox]:checked~.label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox input[type=checkbox]:checked~.label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow input[type=checkbox]:checked~.label-description::before  {
  border-color: #000000!important;
  background-color: #000000!important;
  color: #ffffff!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label::after {
  top: 2px;
  box-sizing: border-box;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::after {
  top: 0px!important;
  box-sizing: border-box!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::after {
  top: 0px!important;
  box-sizing: border-box!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::after {
  top: 0px!important;
  box-sizing: border-box!important;
  position: absolute;
  left: -1.5rem;
  display: block;
  width: 1rem;
  height: 1rem;
  content: "";
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::before {
  top: 0px!important;
  box-sizing: border-box!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .custom-control-label::before {
  position: absolute;
  top: 4px;
  left: -1.5rem;
  display: block;
  width: 16px;
  height: 16px;
  pointer-events: none;
  content: "";
  background-color: #ffffff;
  border: #adb5bd solid 1px;
  border-radius: 50%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .custom-control-label::after {
  position: absolute;
  top: 2px!important;
  left: -1.5rem;
  display: block;
  width: 1rem;
  height: 1rem;
  content: "";
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before {
  position: absolute;
  top: 4px;
  left: -1.5rem;
  display: block;
  width: 16px;
  height: 16px;
  pointer-events: none;
  content: "";
  background-color: #ffffff;
  border: #adb5bd solid 1px;
  border-radius: 50%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::after {
  position: absolute;
  top: 0px!important;
  left: -1.5rem;
  display: block;
  width: 1rem;
  height: 1rem;
  content: "";
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::after {
  position: absolute;
  top: 0px!important;
  left: -1.5rem;
  display: block;
  width: 1rem;
  height: 1rem;
  content: "";
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .custom-radio .custom-control-label::after {
  background: no-repeat 50%/50% 50%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .custom-checkbox .custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::after {
  background: no-repeat 50%/50% 50%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-control, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-control {
  position: relative;
  display: block;
  min-height: 1.5rem;
  padding-left: 1.5rem;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-input, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-input, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-input, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-input {
  position: absolute;
  z-index: -1;
  opacity: 0;
  box-sizing: border-box;
  padding: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-label, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-label, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label {
  color: #000000;
  font-size: 12px!important;
  line-height: 22px;
  margin-bottom: 0;
  position: relative;
  vertical-align: top;
  font-style: normal;
  font-weight: 700;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-select, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-select {
  background-color: #ffffff !important;
  color: #333333 !important;
  border-color: #cccccc;
  border-radius: 4px !important;
  border-style: solid !important;
  border-width: 1px !important;
  font-size: 14px !important;
  line-height: 20px !important;
  margin-bottom: 0;
  margin-top: 0;
  padding: 10px 28px 10px 12px !important;
  width: 100% !important;
  box-sizing: border-box !important;
  max-width: 100% !important;
  height: auto;
  display: inline-block;
  vertical-align: middle;
  background: url('https://assets.mlcdn.com/ml/images/default/dropdown.svg') no-repeat right .75rem center/8px 10px;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow {
  height: auto;
  width: 100%;
  float: left;
  }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-input-horizontal { width: 70%; float: left; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-button-horizontal { width: 30%; float: left; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-button-horizontal.labelsOn { padding-top: 25px;  }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .horizontal-fields { box-sizing: border-box; float: left; padding-right: 10px;  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input {
  background-color: #ffffff;
  color: #333333;
  border-color: #cccccc;
  border-radius: 4px;
  border-style: solid;
  border-width: 1px;
  font-size: 14px;
  line-height: 20px;
  margin-bottom: 0;
  margin-top: 0;
  padding: 10px 10px;
  width: 100%;
  box-sizing: border-box;
  overflow-y: initial;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow button {
  background-color: #000000 !important;
  border-color: #000000;
  border-style: solid;
  border-width: 1px;
  border-radius: 4px;
  box-shadow: none;
  color: #ffffff !important;
  cursor: pointer;
  font-size: 14px !important;
  font-weight: 700;
  line-height: 20px;
  margin: 0 !important;
  padding: 10px !important;
  width: 100%;
  height: auto;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow button:hover {
  background-color: #333333 !important;
  border-color: #333333 !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow input[type="checkbox"] {
  box-sizing: border-box;
  padding: 0;
  position: absolute;
  z-index: -1;
  opacity: 0;
  margin-top: 5px;
  margin-left: -1.5rem;
  overflow: visible;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description {
  color: #000000;
  display: block;
  font-size: 12px;
  text-align: left;
  margin-bottom: 0;
  position: relative;
  vertical-align: top;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow label {
  font-weight: normal;
  margin: 0;
  padding: 0;
  position: relative;
  display: block;
  min-height: 24px;
  padding-left: 24px;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow label a {
  color: #000000;
  text-decoration: underline;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow label p {
  color: #000000 !important;
  font-size: 12px !important;
  font-weight: normal !important;
  line-height: 18px !important;
  padding: 0 !important;
  margin: 0 5px 0 0 !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow label p:last-child {
  margin: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedSubmit {
  margin: 0 0 20px 0;
  float: left;
  width: 100%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedSubmit button {
  background-color: #000000 !important;
  border: none !important;
  border-radius: 4px !important;
  box-shadow: none !important;
  color: #ffffff !important;
  cursor: pointer;
  font-size: 14px !important;
  font-weight: 700 !important;
  line-height: 21px !important;
  height: auto;
  padding: 10px !important;
  width: 100% !important;
  box-sizing: border-box !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedSubmit button.loading {
  display: none;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedSubmit button:hover {
  background-color: #333333 !important;
  }
  .ml-subscribe-close {
  width: 30px;
  height: 30px;
  background: url('https://assets.mlcdn.com/ml/images/default/modal_close.png') no-repeat;
  background-size: 30px;
  cursor: pointer;
  margin-top: -10px;
  margin-right: -10px;
  position: absolute;
  top: 0;
  right: 0;
  }
  .ml-error input, .ml-error textarea, .ml-error select {
  border-color: red!important;
  }
  .ml-error .custom-checkbox-radio-list {
  border: 1px solid red !important;
  border-radius: 4px;
  padding: 10px;
  }
  .ml-error .label-description,
  .ml-error .label-description p,
  .ml-error .label-description p a,
  .ml-error label:first-child {
  color: #ff0000 !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow.ml-error .label-description p,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow.ml-error .label-description p:first-letter {
  color: #ff0000 !important;
  }
  @media only screen and (max-width: 400px){
  .ml-form-embedWrapper.embedDefault, .ml-form-embedWrapper.embedPopup { width: 100%!important; }
  .ml-form-formContent.horozintalForm { float: left!important; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow { height: auto!important; width: 100%!important; float: left!important; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-input-horizontal { width: 100%!important; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-input-horizontal > div { padding-right: 0px!important; padding-bottom: 10px; }
    .ml-form-formContent.horozintalForm .ml-button-horizontal { width: 100%!important; }
    .ml-form-formContent.horozintalForm .ml-button-horizontal.labelsOn { padding-top: 0px!important; }
    }
</style>
<div id="mlb2-3175296" class="ml-form-embedContainer ml-subscribe-form ml-subscribe-form-3175296">
  <hr />
  <div class="ml-form-align-center ">
    <div class="ml-form-embedWrapper embedForm">
      <div class="ml-form-embedBody ml-form-embedBodyDefault row-form">
        <div class="ml-form-embedContent" style=" ">
          <h4>Subscribe</h4>
          <p>Enter your email if you'd like to be kept in the loop about future articles!<br><br>You can expect 2 to 4 messages per month depending on how motivated I'm feeling. :)</p>
	  <p></p>
	  <p>Cheers,<br>Phil</p>
        </div>
        <form class="ml-block-form" action="https://assets.mailerlite.com/jsonp/303114/forms/78235486326359572/subscribe" data-code="" method="post" target="_blank">
          <div class="ml-form-formContent">
            <div class="ml-form-fieldRow ml-last-item">
              <div class="ml-field-group ml-field-email ml-validate-email ml-validate-required">
                <!-- input -->
                <input aria-label="email" aria-required="true" type="email" class="form-control" data-inputmask="" name="fields[email]" placeholder="Email" autocomplete="email">
                <!-- /input -->
                <!-- textarea -->
                <!-- /textarea -->
                <!-- select -->
                <!-- /select -->
                <!-- checkboxes -->
		<!-- /checkboxes -->
                <!-- radio -->
                <!-- /radio -->
                <!-- countries -->
                <!-- /countries -->
              </div>
            </div>
          </div>
          <!-- Privacy policy -->
          <!-- /Privacy policy -->
	  <div class="ml-form-recaptcha ml-validate-required" style="float: left;">
            <style type="text/css">
	      .ml-form-recaptcha {
		  margin-bottom: 20px;
	      }
	      .ml-form-recaptcha.ml-error iframe {
		  border: solid 1px #ff0000;
	      }
	      @media screen and (max-width: 480px) {
		  .ml-form-recaptcha {
		      width: 220px!important
		  }
		  .g-recaptcha {
		      transform: scale(0.78);
		      -webkit-transform: scale(0.78);
		      transform-origin: 0 0;
		      -webkit-transform-origin: 0 0;
		  }
	      }
	    </style>
	    <script src="https://www.google.com/recaptcha/api.js"></script>
	    <div class="g-recaptcha" data-sitekey="6Lf1KHQUAAAAAFNKEX1hdSWCS3mRMv4FlFaNslaD"></div>
	  </div>
          <input type="hidden" name="ml-submit" value="1">
          <div class="ml-form-embedSubmit">
            <button type="submit" class="primary">Subscribe</button>
            <button disabled="disabled" style="display: none;" type="button" class="loading">
              <div class="ml-form-embedSubmitLoad"></div>
              <span class="sr-only">Loading...</span>
            </button>
          </div>
          <input type="hidden" name="anticsrf" value="true">
        </form>
      </div>
      <div class="ml-form-successBody row-success" style="display: none">
        <div class="ml-form-successContent">
          <h3>Thanks :)</h3>
          <p>You're in.</p>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  function ml_webform_success_3175296() {
      var $ = ml_jQuery || jQuery;
      $('.ml-subscribe-form-3175296 .row-success').show();
      $('.ml-subscribe-form-3175296 .row-form').hide();
  }
</script>
<script src="https://groot.mailerlite.com/js/w/webforms.min.js?v300817f630ad0e957914d0b28a2b6d78" type="text/javascript"></script>

	  </div>
	  <div class="row" style="margin-bottom: 25px">
	    <small>Having trouble subscribing? <a href="mailto:phil@eatonphil.com">Let me know</a>.</small>
	  </div>
	</div>
      </div>
    </footer>
    <script async onload="loadGA()" src="https://www.googletagmanager.com/gtag/js?id=UA-58109156-2"></script>
    <script>
      function loadGA() {
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());
	  gtag('config', 'UA-58109156-2');
      }
    </script>
    <script defer src="https://cdn.usefathom.com/script.js" data-site="CEPUOLOQ"></script>
  </body>
</html>
