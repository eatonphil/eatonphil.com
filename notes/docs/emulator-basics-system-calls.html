<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="canonical" href="https://notes.eatonphil.com/emulator-basics-system-calls.html">
    <title>Writing an x86 emulator from scratch in JavaScript: 2. system calls | notes.eatonphil.com</title>
    <meta name="description" content="Writing an x86 emulator from scratch in JavaScript: 2. system calls" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" href="/rss.xml" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono">

    <script async onload="loadGA()" src="https://www.googletagmanager.com/gtag/js?id=UA-58109156-2"></script>
    <script>
      function loadGA() {
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());
	  gtag('config', 'UA-58109156-2');
      }
    </script>
    <script defer src="https://cdn.usefathom.com/script.js" data-site="CEPUOLOQ"></script>
  </head>
  <body>
    <header>
      <div class="lfw">
	<div class="container">
	  <div class="row">
	    <a href="https://eatonphil.com/2025-holiday-fundraiser.html">2025 Holiday Fundraiser</a>
	  </div>
	</div>
      </div>
      <div class="container">
        <div>
          <div class="row">
	    <div>
	      <a href="https://eatonphil.com" class="sm-link">
		Home
              </a>
	      <a href="/" class="sm-link">
		Blog
              </a>
	      <a href="/rss.xml" class="sm-link">
		RSS
              </a>
	    </div>

	    <div class="subscribe">
	      <!-- <a href="https://eatonphil.com/hire-me.html">Hire me</a> -->
	      <!--
		  Hardcode link to home page because some pages don't
		  have a subscribe box. Some pages hide the subscribe.
		-->
	      <a href="https://eatonphil.com/subscribe.html">
		Subscribe
	      </a>
            </div>
	  </div>
	  <hr />
	  <div class="">
            <h2>July 20, 2019</h2>
            <h1>Writing an x86 emulator from scratch in JavaScript: 2. system calls</h1>
	    
            <div class="row" style="padding-bottom: 5px">
              <div class="tags"><a href="/tags/emulators.html" class="tag">emulators</a><a href="/tags/javascript.html" class="tag">javascript</a><a href="/tags/x86-amd64.html" class="tag">x86/amd64</a><a href="/tags/syscalls.html" class="tag">syscalls</a></div>
            </div>
	  </div>
	</div>
      </div>
    </header>
    <div class="container">
      <div class="col-6">
	<div class="post">
          <p class="note">
  Previously in emulator basics:
  <! forgive me, for I have sinned >
  <br />
  <a href="/emulator-basics-a-stack-and-register-machine.html">1. a stack and register machine</a>
</p><p>In this post we'll extend <a href="https://github.com/eatonphil/x86e">x86e</a> to
support the exit and write Linux system calls, or syscalls. A syscall
is a function handled by the kernel that allows the process to
interact with data outside of its memory. The <code>SYSCALL</code>
instruction takes arguments in the same order that the
regular <code>CALL</code> instruction does.  But <code>SYSCALL</code>
additionally requires the <code>RAX</code> register to contain the
integer number of the syscall.</p>
<p>Historically, there have been a number of different ways to make
syscalls. All methods perform variations on a software interrupt.
Before AMD64, on x86 processors, there was the <code>SYSENTER</code>
instruction. And before that there was only <code>INT 80h</code>
to trigger the interrupt with the syscall handler (since interrupts
can be used for more than just syscalls).  The various instructions
around interrupts have been added for efficiency as the processors and
use by operating systems evolved.</p>
<p>Since this is a general need and AMD64 processors are among the most
common today, you'll see similar code in every modern operating system
such as FreeBSD, OpenBSD, NetBSD, macOS, and Linux. (I have no
background in Windows.) The calling convention may differ (e.g. which
arguments are in which registers) and the syscall numbers differ.
Even within Linux both the calling convention and the syscall numbers
differ between x86 (32-bit) and AMD64/x86_64 (64-bit) versions.</p>
<p>See this <a href="https://stackoverflow.com/a/15169141/1507139">StackOverflow
post</a> for some more
detail.</p>
<p><a href="https://gist.github.com/eatonphil/2d16bc3dae33bff8a8d7f2a9d13025c3">Code for this post in full is available as a
Gist.</a></p>
<h4 id="exit">Exit</h4><p>The exit syscall is how a child process communicates with the process
that spawned it (its parent) when the child is finished running. Exit
takes one argument, called the exit code or status code. It is an
arbitrary signed 8-bit integer. If the high bit is set (i.e. the
number is negative), this is interpreted to mean the process exited
abnormally such as due to a segfault. Shells additionally
interpret any non-zero exit code as a "failure". Otherwise, and
ignoring these two common conventions, it can be used to mean anything
the programmer wants.</p>
<p class="note">
  The wait syscall is how the parent process can block until exit is
  called by the child and receive its exit code.
</p><p>On AMD64 Linux the syscall number is 60. For example:</p>
<div class="highlight"><pre><span></span><span class="w">  </span><span class="nf">MOV</span><span class="w"> </span><span class="nb">RDI</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="nf">MOV</span><span class="w"> </span><span class="nb">RAX</span><span class="p">,</span><span class="w"> </span><span class="mi">60</span>
<span class="w">  </span><span class="nf">SYSCALL</span>
</pre></div>
<p>This calls exit with a status code of 0.</p>
<h4 id="write">Write</h4><p>The write syscall is how a process can send data to file descriptors,
which are integers representing some file-like object. By default, a
Linux process is given access to three file descriptors with
consistent integer values: stdin is 0, stdout is 1, and stderr is 2.
Write takes three arguments: the file descriptor integer to write
to, a starting address to memory that is interpreted as a byte array,
and the number of bytes to write to the file descriptor beginning at
the start address.</p>
<p>On AMD64 Linux the syscall number is 1. For example:</p>
<div class="highlight"><pre><span></span><span class="w">  </span><span class="nf">MOV</span><span class="w"> </span><span class="nb">RDI</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w">   </span><span class="c1">; stdout</span>
<span class="w">  </span><span class="nf">MOV</span><span class="w"> </span><span class="nb">RSI</span><span class="p">,</span><span class="w"> </span><span class="nb">R12</span><span class="w"> </span><span class="c1">; address of string</span>
<span class="w">  </span><span class="nf">MOV</span><span class="w"> </span><span class="nb">RDX</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w">   </span><span class="c1">; 8 bytes to write</span>
<span class="w">  </span><span class="nf">MOV</span><span class="w"> </span><span class="nb">RAX</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w">   </span><span class="c1">; write</span>
<span class="w">  </span><span class="nf">SYSCALL</span>
</pre></div>
<p>This writes 8 bytes to stdout starting from the string whose address
is in R12.</p>
<h3 id="implementing-syscalls">Implementing syscalls</h3><p>Our emulator is simplistic and is currently only implementing process
emulation, not full CPU emulation. So the syscalls themselves will be
handled in JavaScript. First we'll write out stubs for the two
syscalls we are adding. And we'll provide a map from syscall id to the
syscall.</p>
<div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">SYSCALLS_BY_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="mf">1</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">sys_write</span><span class="p">(</span><span class="nx">process</span><span class="p">)</span><span class="w"> </span><span class="p">{},</span>
<span class="w">  </span><span class="mf">60</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">sys_exit</span><span class="p">(</span><span class="nx">process</span><span class="p">)</span><span class="w"> </span><span class="p">{},</span>
<span class="p">};</span>
</pre></div>
<p>We need to add an instruction handler to our instruction switch. In
doing so we must convert the value in <code>RAX</code> from a BigInt
to a regular Number so we can look it up in the syscall map.</p>
<div class="highlight"><pre><span></span><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;syscall&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">idNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">registers</span><span class="p">.</span><span class="nx">RAX</span><span class="p">);</span>
<span class="w">        </span><span class="nx">SYSCALLS_BY_ID</span><span class="p">[</span><span class="nx">idNumber</span><span class="p">](</span><span class="nx">process</span><span class="p">);</span>
<span class="w">        </span><span class="nx">process</span><span class="p">.</span><span class="nx">registers</span><span class="p">.</span><span class="nx">RIP</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
</pre></div>
<h4 id="exit">Exit</h4><p>Exit is really simple. It will be implemented by calling Node's
<code>global.process.exit()</code>. Again we'll need to convert the
register's BigInt value to a Number.</p>
<div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">SYSCALLS_BY_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="mf">1</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">sys_write</span><span class="p">(</span><span class="nx">process</span><span class="p">)</span><span class="w"> </span><span class="p">{},</span>
<span class="w">  </span><span class="mf">60</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">sys_exit</span><span class="p">(</span><span class="nx">process</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">global</span><span class="p">.</span><span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">registers</span><span class="p">.</span><span class="nx">RDI</span><span class="p">));</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">};</span>
</pre></div>
<h4 id="write">Write</h4><p>Write will be implemented by iterating over the process memory as
bytes and by calling <code>write()</code> on the relevant file
descriptor. We'll store a map of these on the process object and
supply stdout, stderr, and stdin proxies on startup.</p>
<div class="highlight"><pre><span></span><span class="kd">function</span><span class="w"> </span><span class="nx">main</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">...</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">registers</span><span class="p">,</span>
<span class="w">    </span><span class="nx">memory</span><span class="p">,</span>
<span class="w">    </span><span class="nx">instructions</span><span class="p">,</span>
<span class="w">    </span><span class="nx">labels</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fd</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// stdout</span>
<span class="w">      </span><span class="mf">1</span><span class="o">:</span><span class="w"> </span><span class="nb">global</span><span class="p">.</span><span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
<p>The base address is stored in <code>RSI</code>, the number of bytes to
write are stored in <code>RDX</code>. And the file descriptor to write
to is stored in <code>RDI</code>.</p>
<div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">SYSCALLS_BY_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="mf">1</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">sys_write</span><span class="p">(</span><span class="nx">process</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">BigInt</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">registers</span><span class="p">.</span><span class="nx">RSI</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">registers</span><span class="p">.</span><span class="nx">RDX</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">bytes</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="kr">byte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">readMemoryBytes</span><span class="p">(</span><span class="nx">process</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">BigInt</span><span class="p">(</span><span class="nx">i</span><span class="p">),</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="kr">char</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="kr">byte</span><span class="p">));</span>
<span class="w">      </span><span class="nx">process</span><span class="p">.</span><span class="nx">fd</span><span class="p">[</span><span class="nb">Number</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">registers</span><span class="p">.</span><span class="nx">RDI</span><span class="p">)].</span><span class="nx">write</span><span class="p">(</span><span class="kr">char</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">...</span>
</pre></div>
<h3 id="all-together">All together</h3><div class="highlight"><pre><span></span>$<span class="w"> </span>cat<span class="w"> </span>exit3.asm
main:
<span class="w">  </span>MOV<span class="w"> </span>RDI,<span class="w"> </span><span class="m">1</span>
<span class="w">  </span>MOV<span class="w"> </span>RSI,<span class="w"> </span><span class="m">2</span>
<span class="w">  </span>ADD<span class="w"> </span>RDI,<span class="w"> </span>RSI

<span class="w">  </span>MOV<span class="w"> </span>RAX,<span class="w"> </span><span class="m">60</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="nb">exit</span>
<span class="w">  </span>SYSCALL
$<span class="w"> </span>node<span class="w"> </span>emulator.js<span class="w"> </span>exit3.asm
$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$?</span>
<span class="m">3</span>
</pre></div>
<div class="highlight"><pre><span></span>$<span class="w"> </span>cat<span class="w"> </span>hello.asm
main:
<span class="w">  </span>PUSH<span class="w"> </span><span class="m">10</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="se">\n</span>
<span class="w">  </span>PUSH<span class="w"> </span><span class="m">33</span><span class="w">  </span><span class="p">;</span><span class="w"> </span>!
<span class="w">  </span>PUSH<span class="w"> </span><span class="m">111</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>o
<span class="w">  </span>PUSH<span class="w"> </span><span class="m">108</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>l
<span class="w">  </span>PUSH<span class="w"> </span><span class="m">108</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>l
<span class="w">  </span>PUSH<span class="w"> </span><span class="m">101</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>e
<span class="w">  </span>PUSH<span class="w"> </span><span class="m">72</span><span class="w">  </span><span class="p">;</span><span class="w"> </span>H

<span class="w">  </span>MOV<span class="w"> </span>RDI,<span class="w"> </span><span class="m">1</span><span class="w">   </span><span class="p">;</span><span class="w"> </span>stdout
<span class="w">  </span>MOV<span class="w"> </span>RSI,<span class="w"> </span>RSP<span class="w"> </span><span class="p">;</span><span class="w"> </span>address<span class="w"> </span>of<span class="w"> </span>string
<span class="w">  </span>MOV<span class="w"> </span>RDX,<span class="w"> </span><span class="m">56</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="m">8</span>-bit<span class="w"> </span>characters<span class="w"> </span><span class="k">in</span><span class="w"> </span>the<span class="w"> </span>string<span class="w"> </span>but<span class="w"> </span>PUSH<span class="w"> </span>acts<span class="w"> </span>on<span class="w"> </span><span class="m">64</span>-bit<span class="w"> </span>integers
<span class="w">  </span>MOV<span class="w"> </span>RAX,<span class="w"> </span><span class="m">1</span><span class="w">   </span><span class="p">;</span><span class="w"> </span>write
<span class="w">  </span>SYSCALL

<span class="w">  </span>MOV<span class="w"> </span>RDI,<span class="w"> </span><span class="m">0</span>
<span class="w">  </span>MOV<span class="w"> </span>RAX,<span class="w"> </span><span class="m">60</span>
<span class="w">  </span>SYSCALL
$<span class="w"> </span>node<span class="w"> </span>emulator.js<span class="w"> </span>hello.asm
Hello!
$
</pre></div>
<h3 id="next-steps">Next steps</h3><p>We still aren't setting flags appropriately to support conditionals,
so that's low-hanging fruit. There are some other fun syscalls to
implement that would also give us access to an emulated VGA card so we
could render graphics. Syntactic support for string constants would
also be convenient and more efficient.</p>
<p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">Latest post in the emulator basics series up: implementing some syscalls starting with sys_exit and sys_write so we can print a nice hello message. <a href="https://t.co/NEfId0lnJx">https://t.co/NEfId0lnJx</a> <a href="https://twitter.com/hashtag/javascript?src=hash&amp;ref_src=twsrc%5Etfw">#javascript</a> <a href="https://twitter.com/hashtag/x86?src=hash&amp;ref_src=twsrc%5Etfw">#x86</a></p>&mdash; Phil Eaton (@phil_eaton) <a href="https://twitter.com/phil_eaton/status/1152689255900176386?ref_src=twsrc%5Etfw">July 20, 2019</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<style>.feedback{display:initial;}</style>
	</div>
	<div class="feedback">
	  <h4>Feedback</h4>
	  <p>As always,
	      please <a href="mailto:phil@eatonphil.com">email</a>
	      or <a href="https://twitter.com/eatonphil">tweet me</a>
	      with questions, corrections, or ideas!</p>

	</div>
      </div>
    </div>
    <footer>
      <div class="container">
	<div>
	  <div id="subscribe">
	    <iframe frameBorder="0" src="https://cdn.forms-content-1.sg-form.com/e8ed4c3b-dd46-11f0-b6e6-ce075f2c5f80"/>

	  </div>
	</div>
      </div>
    </footer>
  </body>
</html>
