<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="canonical" href="https://notes.eatonphil.com/implementing-zip-in-go-unzipping.html">
    <title>Implementing zip archiving in Golang: unzipping | notes.eatonphil.com</title>
    <meta name="description" content="Implementing zip archiving in Golang: unzipping" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" href="/rss.xml" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono">
  </head>
  <body>
    <header>
      <div class="lfw">
	<div class="container">
	  <div class="row">
	    <a href="https://eatonphil.com/2025-holiday-fundraiser.html">2025 holiday fundraiser</a>
	  </div>
	</div>
      </div>
      <div class="container">
        <div>
          <div class="row">
	    <div>
	      <a href="https://eatonphil.com" class="sm-link">
		Home
              </a>
	      <a href="/" class="sm-link">
		Blog
              </a>
	      <a href="/rss.xml" class="sm-link">
		RSS
              </a>
	    </div>

	    <div class="subscribe">
	      <!-- <a href="https://eatonphil.com/hire-me.html">Hire me</a> -->
	      <!--
		  Hardcode link to home page because some pages don't
		  have a subscribe box. Some pages hide the subscribe.
		-->
	      <a href="https://eatonphil.com/subscribe.html">
		Subscribe
	      </a>
            </div>
	  </div>
	  <hr />
	  <div class="">
            <h2>November 23, 2021</h2>
            <h1>Implementing zip archiving in Golang: unzipping</h1>
	    
            <div class="row" style="padding-bottom: 5px">
              <div class="tags"><a href="/tags/go.html" class="tag">go</a><a href="/tags/zip.html" class="tag">zip</a></div>
            </div>
	  </div>
	</div>
      </div>
    </header>
    <div class="container">
      <div class="col-6">
	<div class="post">
          <p><small>All code for this post is <a href="https://github.com/eatonphil/gozip">available on Github</a>.</small></p>
<p>Let's take a look at how zip files work. Take a small file for example:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>cat<span class="w"> </span>hello.text
Hello!
</pre></div>
<p>Let's zip it up.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>zip<span class="w"> </span>test.zip<span class="w"> </span>hello.text
adding:<span class="w"> </span>hello.text<span class="w"> </span><span class="o">(</span>stored<span class="w"> </span><span class="m">0</span>%<span class="o">)</span>
$<span class="w"> </span>ls<span class="w"> </span>-lah<span class="w"> </span>test.zip
-rw-r--r--<span class="w"> </span><span class="m">1</span><span class="w"> </span>phil<span class="w"> </span>phil<span class="w"> </span><span class="m">177</span><span class="w"> </span>Nov<span class="w"> </span><span class="m">23</span><span class="w"> </span><span class="m">23</span>:04<span class="w"> </span>test.zip
</pre></div>
<p>So a 6 byte text file becomes a 177 byte zip file. That is pretty
small! Parsing 177 bytes sounds like it can't possibly be too
complicated!</p>
<p>Let's hexdump the zip file.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>hexdump<span class="w"> </span>-C<span class="w"> </span>test.zip
<span class="m">00000000</span><span class="w">  </span><span class="m">50</span><span class="w"> </span>4b<span class="w"> </span><span class="m">03</span><span class="w"> </span><span class="m">04</span><span class="w"> </span>0a<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span>8a<span class="w"> </span>b8<span class="w"> </span><span class="m">77</span><span class="w"> </span><span class="m">53</span><span class="w"> </span>9e<span class="w"> </span>d8<span class="w">  </span><span class="p">|</span>PK..........wS..<span class="p">|</span>
<span class="m">00000010</span><span class="w">  </span><span class="m">42</span><span class="w"> </span>b0<span class="w"> </span><span class="m">07</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">07</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span>0a<span class="w"> </span><span class="m">00</span><span class="w"> </span>1c<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">68</span><span class="w"> </span><span class="m">65</span><span class="w">  </span><span class="p">|</span>B.............he<span class="p">|</span>
<span class="m">00000020</span><span class="w">  </span>6c<span class="w"> </span>6c<span class="w"> </span>6f<span class="w"> </span>2e<span class="w"> </span><span class="m">74</span><span class="w"> </span><span class="m">65</span><span class="w"> </span><span class="m">78</span><span class="w"> </span><span class="m">74</span><span class="w">  </span><span class="m">55</span><span class="w"> </span><span class="m">54</span><span class="w"> </span><span class="m">09</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">03</span><span class="w"> </span><span class="m">74</span><span class="w"> </span><span class="m">73</span><span class="w"> </span>9d<span class="w">  </span><span class="p">|</span>llo.textUT...ts.<span class="p">|</span>
<span class="m">00000030</span><span class="w">  </span><span class="m">61</span><span class="w"> </span><span class="m">74</span><span class="w"> </span><span class="m">73</span><span class="w"> </span>9d<span class="w"> </span><span class="m">61</span><span class="w"> </span><span class="m">75</span><span class="w"> </span><span class="m">78</span><span class="w"> </span>0b<span class="w">  </span><span class="m">00</span><span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">04</span><span class="w"> </span>eb<span class="w"> </span><span class="m">03</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">04</span><span class="w">  </span><span class="p">|</span>ats.aux.........<span class="p">|</span>
<span class="m">00000040</span><span class="w">  </span>eb<span class="w"> </span><span class="m">03</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">48</span><span class="w"> </span><span class="m">65</span><span class="w"> </span>6c<span class="w"> </span>6c<span class="w">  </span>6f<span class="w"> </span><span class="m">21</span><span class="w"> </span>0a<span class="w"> </span><span class="m">50</span><span class="w"> </span>4b<span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">02</span><span class="w"> </span>1e<span class="w">  </span><span class="p">|</span>....Hello!.PK...<span class="p">|</span>
<span class="m">00000050</span><span class="w">  </span><span class="m">03</span><span class="w"> </span>0a<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span>8a<span class="w">  </span>b8<span class="w"> </span><span class="m">77</span><span class="w"> </span><span class="m">53</span><span class="w"> </span>9e<span class="w"> </span>d8<span class="w"> </span><span class="m">42</span><span class="w"> </span>b0<span class="w"> </span><span class="m">07</span><span class="w">  </span><span class="p">|</span>.........wS..B..<span class="p">|</span>
<span class="m">00000060</span><span class="w">  </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">07</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span>0a<span class="w">  </span><span class="m">00</span><span class="w"> </span><span class="m">18</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">01</span><span class="w">  </span><span class="p">|</span>................<span class="p">|</span>
<span class="m">00000070</span><span class="w">  </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span>a4<span class="w"> </span><span class="m">81</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="m">00</span><span class="w"> </span><span class="m">68</span><span class="w"> </span><span class="m">65</span><span class="w"> </span>6c<span class="w"> </span>6c<span class="w"> </span>6f<span class="w"> </span>2e<span class="w"> </span><span class="m">74</span><span class="w">  </span><span class="p">|</span>.........hello.t<span class="p">|</span>
<span class="m">00000080</span><span class="w">  </span><span class="m">65</span><span class="w"> </span><span class="m">78</span><span class="w"> </span><span class="m">74</span><span class="w"> </span><span class="m">55</span><span class="w"> </span><span class="m">54</span><span class="w"> </span><span class="m">05</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">03</span><span class="w">  </span><span class="m">74</span><span class="w"> </span><span class="m">73</span><span class="w"> </span>9d<span class="w"> </span><span class="m">61</span><span class="w"> </span><span class="m">75</span><span class="w"> </span><span class="m">78</span><span class="w"> </span>0b<span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>extUT...ts.aux..<span class="p">|</span>
<span class="m">00000090</span><span class="w">  </span><span class="m">01</span><span class="w"> </span><span class="m">04</span><span class="w"> </span>eb<span class="w"> </span><span class="m">03</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">04</span><span class="w"> </span>eb<span class="w">  </span><span class="m">03</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">50</span><span class="w"> </span>4b<span class="w"> </span><span class="m">05</span><span class="w"> </span><span class="m">06</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>...........PK...<span class="p">|</span>
000000a0<span class="w">  </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">50</span><span class="w">  </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span>4b<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>.......P...K....<span class="p">|</span>
000000b0<span class="w">  </span><span class="m">00</span><span class="w">                                                </span><span class="p">|</span>.<span class="p">|</span>
000000b1
</pre></div>
<p>We can see both the file name and the file contents in there.</p>
<h3 id="structure">Structure</h3><p>Let's take a look at the zip structure defined
<a href="https://pkware.cachefly.net/webdocs/casestudies/APPNOTE.TXT">here</a>. Based
on section 4.3.6 it looks like file metadata followed by the file
contents are stored one after another with a final chunk of "central
directory" metadata.</p>
<div style="text-align:center">
  <img src="https://www.codeproject.com/KB/cs/remotezip/diagram1.png" style="height:400px; width: auto" />
  <div>
    <small><a href="https://www.codeproject.com/Articles/8688/Extracting-files-from-a-remote-ZIP-archive">Image Credit</a></small>
  </div>
</div><p>The local header metadata looks like this:</p>
<table>
<thead><tr>
<th>Field</th>
<th>Size</th>
</tr>
</thead>
<tbody>
<tr>
<td>local file header signature</td>
<td>4 bytes</td>
</tr>
<tr>
<td>version needed to extract</td>
<td>2 bytes</td>
</tr>
<tr>
<td>general purpose bit flag</td>
<td>2 bytes</td>
</tr>
<tr>
<td>compression method</td>
<td>2 bytes</td>
</tr>
<tr>
<td>last mod file time</td>
<td>2 bytes</td>
</tr>
<tr>
<td>last mod file date</td>
<td>2 bytes</td>
</tr>
<tr>
<td>crc-32</td>
<td>4 bytes</td>
</tr>
<tr>
<td>compressed size</td>
<td>4 bytes</td>
</tr>
<tr>
<td>uncompressed size</td>
<td>4 bytes</td>
</tr>
<tr>
<td>file name length</td>
<td>2 bytes</td>
</tr>
<tr>
<td>extra field length</td>
<td>2 bytes</td>
</tr>
<tr>
<td>file name</td>
<td>variable</td>
</tr>
<tr>
<td>extra field</td>
<td>variable</td>
</tr>
</tbody>
</table>
<p>The header signature is a single integer (<code>0x04034b50</code>) in
a valid zip file. We'll ignore version, the general purpose flag, and
the checksum. Compression is either <code>0</code> for no compression
or <code>8</code> for DEFLATE compression/decompression.</p>
<p>Last modified time and date is MSDOS-style date/time format which is
<a href="https://groups.google.com/g/comp.os.msdos.programmer/c/ffAVUFN2NbA">pretty
funky</a>.</p>
<p>Let's translate this roughly to Go with some high level flourishes.</p>
<div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;os&quot;</span>
<span class="w">    </span><span class="s">&quot;bytes&quot;</span>
<span class="w">    </span><span class="s">&quot;compress/flate&quot;</span>
<span class="w">    </span><span class="s">&quot;io/ioutil&quot;</span>
<span class="w">    </span><span class="s">&quot;encoding/binary&quot;</span>
<span class="w">    </span><span class="s">&quot;time&quot;</span>
<span class="w">    </span><span class="s">&quot;fmt&quot;</span>
<span class="p">)</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">compression</span><span class="w"> </span><span class="kt">uint8</span>
<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="nx">noCompression</span><span class="w"> </span><span class="nx">compression</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">iota</span>
<span class="w">    </span><span class="nx">deflateCompression</span>
<span class="p">)</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">localFileHeader</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">signature</span><span class="w"> </span><span class="kt">uint32</span>
<span class="w">    </span><span class="nx">version</span><span class="w"> </span><span class="kt">uint16</span>
<span class="w">    </span><span class="nx">bitFlag</span><span class="w"> </span><span class="kt">uint16</span>
<span class="w">    </span><span class="nx">compression</span><span class="w"> </span><span class="nx">compression</span>
<span class="w">    </span><span class="nx">lastModified</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
<span class="w">    </span><span class="nx">crc32</span><span class="w"> </span><span class="kt">uint32</span>
<span class="w">    </span><span class="nx">compressedSize</span><span class="w"> </span><span class="kt">uint32</span>
<span class="w">    </span><span class="nx">uncompressedSize</span><span class="w"> </span><span class="kt">uint32</span>
<span class="w">    </span><span class="nx">fileName</span><span class="w"> </span><span class="kt">string</span>
<span class="w">    </span><span class="nx">extraField</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span>
<span class="w">    </span><span class="nx">fileContents</span><span class="w"> </span><span class="kt">string</span>
<span class="p">}</span>
</pre></div>
<h3 id="main">main</h3><p>Our entrypoint will read a zip file and keep walking through the file
until we stop being able to parse zip file entries.</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">f</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ioutil</span><span class="p">.</span><span class="nx">ReadFile</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">end</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="kt">error</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">lfh</span><span class="w"> </span><span class="o">*</span><span class="nx">localFileHeader</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">next</span><span class="w"> </span><span class="kt">int</span>
<span class="w">        </span><span class="nx">lfh</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">parseLocalFileHeader</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span><span class="w"> </span><span class="nx">end</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">errNotZip</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">break</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">end</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">next</span>

<span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">lfh</span><span class="p">.</span><span class="nx">lastModified</span><span class="p">,</span><span class="w"> </span><span class="nx">lfh</span><span class="p">.</span><span class="nx">fileName</span><span class="p">,</span><span class="w"> </span><span class="nx">lfh</span><span class="p">.</span><span class="nx">fileContents</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<h3 id="files">Files</h3><p>For each file we'll fail early if the first four bytes are not the magic zip signature.</p>
<div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">errNotZip</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;Not a zip file&quot;</span><span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">parseLocalFileHeader</span><span class="p">(</span><span class="nx">bs</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">localFileHeader</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">signature</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">readUint32</span><span class="p">(</span><span class="nx">bs</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">signature</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x04034b50</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">errNotZip</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
<p>The basic pattern is that one of these read helpers will take an
offset and return a Go value and a new offset. The read helper will do
bounds checking. We'll define the read helpers further down.</p>
<p>Let's follow the same pattern to the end of the struct:</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="nv">version</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">,</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">readUint16</span><span class="p">(</span><span class="nv">bs</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nv">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nv">return</span><span class="w"> </span><span class="nv">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nv">bitFlag</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">,</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">readUint16</span><span class="p">(</span><span class="nv">bs</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nv">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nv">return</span><span class="w"> </span><span class="nv">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nv">compression</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nv">noCompression</span>
<span class="w">    </span><span class="nv">compressionRaw</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">,</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">readUint16</span><span class="p">(</span><span class="nv">bs</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nv">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nv">return</span><span class="w"> </span><span class="nv">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">err</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nv">compressionRaw</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nv">compression</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">deflateCompression</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nv">lmTime</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">,</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">readUint16</span><span class="p">(</span><span class="nv">bs</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nv">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nv">return</span><span class="w"> </span><span class="nv">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nv">lmDate</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">,</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">readUint16</span><span class="p">(</span><span class="nv">bs</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nv">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nv">return</span><span class="w"> </span><span class="nv">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">err</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nv">lastModified</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">msdosTimeToGoTime</span><span class="p">(</span><span class="nv">lmDate</span><span class="p">,</span><span class="w"> </span><span class="nv">lmTime</span><span class="p">)</span>

<span class="w">    </span><span class="nv">crc32</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">,</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">readUint32</span><span class="p">(</span><span class="nv">bs</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nv">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nv">return</span><span class="w"> </span><span class="nv">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nv">compressedSize</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">,</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">readUint32</span><span class="p">(</span><span class="nv">bs</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nv">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nv">return</span><span class="w"> </span><span class="nv">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nv">uncompressedSize</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">,</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">readUint32</span><span class="p">(</span><span class="nv">bs</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nv">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nv">return</span><span class="w"> </span><span class="nv">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nv">fileNameLength</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">,</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">readUint16</span><span class="p">(</span><span class="nv">bs</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nv">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nv">return</span><span class="w"> </span><span class="nv">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nv">extraFieldLength</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">,</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">readUint16</span><span class="p">(</span><span class="nv">bs</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nv">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nv">return</span><span class="w"> </span><span class="nv">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nv">fileName</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">,</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">readString</span><span class="p">(</span><span class="nv">bs</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">,</span><span class="w"> </span><span class="nf">int</span><span class="p">(</span><span class="nv">fileNameLength</span><span class="p">))</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nv">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nv">return</span><span class="w"> </span><span class="nv">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nv">extraField</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">,</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">readBytes</span><span class="p">(</span><span class="nv">bs</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">,</span><span class="w"> </span><span class="nf">int</span><span class="p">(</span><span class="nv">extraFieldLength</span><span class="p">))</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nv">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nv">return</span><span class="w"> </span><span class="nv">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">err</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
<p>Now if the file contents are uncompressed we can just copy bytes after
the file header. If the file contents are compressed though we'll use
Go's builtin DEFLATE support to decompress the bytes after the file
header.</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">fileContents</span><span class="w"> </span><span class="kt">string</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">compression</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">noCompression</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">fileContents</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">readString</span><span class="p">(</span><span class="nx">bs</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="nx">uncompressedSize</span><span class="p">))</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">end</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="nx">compressedSize</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">bs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">errOverranBuffer</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nx">flateReader</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">flate</span><span class="p">.</span><span class="nx">NewReader</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">NewReader</span><span class="p">(</span><span class="nx">bs</span><span class="p">[</span><span class="nx">i</span><span class="p">:</span><span class="nx">end</span><span class="p">]))</span>

<span class="w">        </span><span class="k">defer</span><span class="w"> </span><span class="nx">flateReader</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
<span class="w">        </span><span class="nx">read</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ioutil</span><span class="p">.</span><span class="nx">ReadAll</span><span class="p">(</span><span class="nx">flateReader</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">fileContents</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">read</span><span class="p">)</span>

<span class="w">        </span><span class="nx">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">end</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
<p>And return the filled out representation:</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">localFileHeader</span><span class="p">{</span>
<span class="w">        </span><span class="nx">signature</span><span class="p">:</span><span class="w"> </span><span class="nx">signature</span><span class="p">,</span>
<span class="w">        </span><span class="nx">version</span><span class="p">:</span><span class="w"> </span><span class="nx">version</span><span class="p">,</span>
<span class="w">        </span><span class="nx">bitFlag</span><span class="p">:</span><span class="w"> </span><span class="nx">bitFlag</span><span class="p">,</span>
<span class="w">        </span><span class="nx">compression</span><span class="p">:</span><span class="w"> </span><span class="nx">compression</span><span class="p">,</span>
<span class="w">        </span><span class="nx">lastModified</span><span class="p">:</span><span class="w"> </span><span class="nx">lastModified</span><span class="p">,</span>
<span class="w">        </span><span class="nx">crc32</span><span class="p">:</span><span class="w"> </span><span class="nx">crc32</span><span class="p">,</span>
<span class="w">        </span><span class="nx">compressedSize</span><span class="p">:</span><span class="w"> </span><span class="nx">compressedSize</span><span class="p">,</span>
<span class="w">        </span><span class="nx">uncompressedSize</span><span class="p">:</span><span class="w"> </span><span class="nx">uncompressedSize</span><span class="p">,</span>
<span class="w">        </span><span class="nx">fileName</span><span class="p">:</span><span class="w"> </span><span class="nx">fileName</span><span class="p">,</span>
<span class="w">        </span><span class="nx">extraField</span><span class="p">:</span><span class="w"> </span><span class="nx">extraField</span><span class="p">,</span>
<span class="w">        </span><span class="nx">fileContents</span><span class="p">:</span><span class="w"> </span><span class="nx">fileContents</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</pre></div>
<h3 id="read-helpers">Read helpers</h3><p>Now we just define those read helpers with bounds checking, using Go's
builtin libraries for dealing with binary encodings.</p>
<div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">errOverranBuffer</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;Overran buffer&quot;</span><span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">readUint32</span><span class="p">(</span><span class="nx">bs</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">end</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">bs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">errOverranBuffer</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nx">Uint32</span><span class="p">(</span><span class="nx">bs</span><span class="p">[</span><span class="nx">offset</span><span class="p">:</span><span class="nx">end</span><span class="p">]),</span><span class="w"> </span><span class="nx">end</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">readUint16</span><span class="p">(</span><span class="nx">bs</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">uint16</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">end</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">offset</span><span class="o">+</span><span class="mi">2</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">bs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">errOverranBuffer</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nx">Uint16</span><span class="p">(</span><span class="nx">bs</span><span class="p">[</span><span class="nx">offset</span><span class="p">:</span><span class="nx">end</span><span class="p">]),</span><span class="w"> </span><span class="nx">end</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</pre></div>
<p>And basically only bounds checking for grabbing bytes and strings.</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">readBytes</span><span class="p">(</span><span class="nx">bs</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">end</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">n</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">bs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">errOverranBuffer</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">bs</span><span class="p">[</span><span class="nx">offset</span><span class="p">:</span><span class="nx">offset</span><span class="o">+</span><span class="nx">n</span><span class="p">],</span><span class="w"> </span><span class="nx">end</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">readString</span><span class="p">(</span><span class="nx">bs</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">read</span><span class="p">,</span><span class="w"> </span><span class="nx">end</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">readBytes</span><span class="p">(</span><span class="nx">bs</span><span class="p">,</span><span class="w"> </span><span class="nx">offset</span><span class="p">,</span><span class="w"> </span><span class="nx">n</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">read</span><span class="p">),</span><span class="w"> </span><span class="nx">end</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="p">}</span>
</pre></div>
<h3 id="msdos-time">MSDOS time</h3><p>At the time zip was created, MSDOS time format was popular, I
guess. But it's not popular today so it took a bit of work to finally
find <a href="https://groups.google.com/g/comp.os.msdos.programmer/c/ffAVUFN2NbA">an explanation of the
format</a>
with some code (in C).</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">msdosTimeToGoTime</span><span class="p">(</span><span class="nx">d</span><span class="w"> </span><span class="kt">uint16</span><span class="p">,</span><span class="w"> </span><span class="nx">t</span><span class="w"> </span><span class="kt">uint16</span><span class="p">)</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">seconds</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">int</span><span class="p">((</span><span class="nx">t</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1F</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="nx">minutes</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">int</span><span class="p">((</span><span class="nx">t</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x3F</span><span class="p">)</span>
<span class="w">    </span><span class="nx">hours</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">11</span><span class="p">)</span>

<span class="w">    </span><span class="nx">day</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="nx">d</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1F</span><span class="p">)</span>
<span class="w">    </span><span class="nx">month</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Month</span><span class="p">((</span><span class="nx">d</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0F</span><span class="p">)</span>
<span class="w">    </span><span class="nx">year</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">int</span><span class="p">((</span><span class="nx">d</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">9</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x7F</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1980</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Date</span><span class="p">(</span><span class="nx">year</span><span class="p">,</span><span class="w"> </span><span class="nx">month</span><span class="p">,</span><span class="w"> </span><span class="nx">day</span><span class="p">,</span><span class="w"> </span><span class="nx">hours</span><span class="p">,</span><span class="w"> </span><span class="nx">minutes</span><span class="p">,</span><span class="w"> </span><span class="nx">seconds</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Local</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
<h3 id="tout-ensemble">Tout ensemble</h3><p>Running it we get:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>go<span class="w"> </span>build
$<span class="w"> </span>./gozip<span class="w"> </span>test.zip
<span class="m">2021</span>-11-23<span class="w"> </span><span class="m">23</span>:04:20<span class="w"> </span>+0000<span class="w"> </span>UTC<span class="w"> </span>hello.text<span class="w"> </span>Hello!
</pre></div>
<p>That looks good! Now let's try zipping more than one file.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>cat<span class="w"> </span>bye.text
Au<span class="w"> </span>revoir!
$<span class="w"> </span>rm<span class="w"> </span>test.zip
$<span class="w"> </span>zip<span class="w"> </span>test.zip<span class="w"> </span>*.text
<span class="w">  </span>adding:<span class="w"> </span>bye.text<span class="w"> </span><span class="o">(</span>stored<span class="w"> </span><span class="m">0</span>%<span class="o">)</span>
<span class="w">  </span>adding:<span class="w"> </span>hello.text<span class="w"> </span><span class="o">(</span>stored<span class="w"> </span><span class="m">0</span>%<span class="o">)</span>
$<span class="w"> </span>./gozip<span class="w"> </span>test.zip
<span class="m">2021</span>-11-24<span class="w"> </span><span class="m">03</span>:40:00<span class="w"> </span>+0000<span class="w"> </span>UTC<span class="w"> </span>bye.text<span class="w"> </span>Au<span class="w"> </span>revoir!

<span class="m">2021</span>-11-23<span class="w"> </span><span class="m">23</span>:04:20<span class="w"> </span>+0000<span class="w"> </span>UTC<span class="w"> </span>hello.text<span class="w"> </span>Hello!
</pre></div>
<p>Fab.</p>
<h3 id="notes">Notes</h3><p>There are many parts of the standard to deal with (e.g. directories)
and many common extensions. I'm ignoring them.</p>
<p>There's some space left at the end of the file which is probably the
"central directory" metadata but I haven't dug into
that. Understanding those last remaining bits are probably necessary
if I want to be able to <em>create</em> zip archives.</p>
<p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">I wrote a new post on building a zip archive reader in Go!<a href="https://t.co/U0Yg2powlP">https://t.co/U0Yg2powlP</a> <a href="https://t.co/ns5dF3mjIx">pic.twitter.com/ns5dF3mjIx</a></p>&mdash; Phil Eaton (@phil_eaton) <a href="https://twitter.com/phil_eaton/status/1463354752675323904?ref_src=twsrc%5Etfw">November 24, 2021</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<style>.feedback{display:initial;}</style>
	</div>
	<div class="feedback">
	  <h4>Feedback</h4>
	  <p>As always,
	      please <a href="mailto:phil@eatonphil.com">email</a>
	      or <a href="https://twitter.com/eatonphil">tweet me</a>
	      with questions, corrections, or ideas!</p>

	</div>
      </div>
    </div>
    <footer>
      <div class="container">
	<div>
	  <div id="subscribe">
	    <iframe frameBorder="0" src="https://cdn.forms-content-1.sg-form.com/e8ed4c3b-dd46-11f0-b6e6-ce075f2c5f80"/>

	  </div>
	</div>
      </div>
    </footer>
    <script async onload="loadGA()" src="https://www.googletagmanager.com/gtag/js?id=UA-58109156-2"></script>
    <script>
      function loadGA() {
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());
	  gtag('config', 'UA-58109156-2');
      }
    </script>
    <script defer src="https://cdn.usefathom.com/script.js" data-site="CEPUOLOQ"></script>
  </body>
</html>
