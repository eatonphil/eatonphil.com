<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="canonical" href="https://notes.eatonphil.com/zigrocks.html">
    <title>A minimal RocksDB example with Zig | notes.eatonphil.com</title>
    <meta name="description" content="A minimal RocksDB example with Zig" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" href="/rss.xml" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono">
  </head>
  <body>
    <header>
      <div class="lfw">
	<div class="container">
	  <div class="row">
	    <a href="https://eatonphil.com/2025-holiday-fundraiser.html">2025 Holiday Fundraiser</a>
	  </div>
	</div>
      </div>
      <div class="container">
        <div>
          <div class="row">
	    <div>
	      <a href="https://eatonphil.com" class="sm-link">
		Home
              </a>
	      <a href="/" class="sm-link">
		Blog
              </a>
	      <a href="/rss.xml" class="sm-link">
		RSS
              </a>
	    </div>

	    <div class="subscribe">
	      <!-- <a href="https://eatonphil.com/hire-me.html">Hire me</a> -->
	      <!--
		  Hardcode link to home page because some pages don't
		  have a subscribe box. Some pages hide the subscribe.
		-->
	      <a href="https://eatonphil.com/subscribe.html">
		Subscribe
	      </a>
            </div>
	  </div>
	  <hr />
	  <div class="">
            <h2>October 30, 2022</h2>
            <h1>A minimal RocksDB example with Zig</h1>
	    
            <div class="row" style="padding-bottom: 5px">
              <div class="tags"><a href="/tags/rocksdb.html" class="tag">rocksdb</a><a href="/tags/databases.html" class="tag">databases</a><a href="/tags/zig.html" class="tag">zig</a><a href="/tags/c.html" class="tag">c</a></div>
            </div>
	  </div>
	</div>
      </div>
    </header>
    <div class="container">
      <div class="col-6">
	<div class="post">
          <p>I mostly programmed in Go the last few years. So every time I
wanted an embedded key-value database, I reached for Cockroach's
<a href="https://github.com/cockroachdb/pebble">Pebble</a>.</p>
<p>Pebble is great for Go programming but Go does not embed well into
other languages. Pebble was inspired by
<a href="https://github.com/facebook/rocksdb">RocksDB</a> (and its predecessor,
<a href="https://github.com/google/leveldb">LevelDB</a>). Both were written in
C++ which can more easily be embedded into any language with a C
foreign function interface. Pebble also has some interesting
limitations that RocksDB does not,
<a href="https://github.com/facebook/rocksdb/wiki/Transactions">transactions</a>
for example.</p>
<p>So I've been wanting to get familiar with RocksDB. And I've been
learning Zig, so I set out to write a simple Zig program that embeds
RocksDB.  (If you see weird things in my Zig code and have
suggestions, <a href="mailto:phil@eatonphil.com">send me a note</a>!)</p>
<p>This post is going to be a mix of RocksDB explanations and Zig
explanations. By the end we'll have a simple CLI over a durable store
that is able to set keys, get keys, and list all key-value pairs
(optionally filtered on a key prefix).</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>./kv<span class="w"> </span><span class="nb">set</span><span class="w"> </span>x<span class="w"> </span><span class="m">1</span>
$<span class="w"> </span>./kv<span class="w"> </span>get<span class="w"> </span>x
<span class="m">1</span>
$<span class="w"> </span>./kv<span class="w"> </span><span class="nb">set</span><span class="w"> </span>y<span class="w"> </span><span class="m">22</span>
$<span class="w"> </span>./kv<span class="w"> </span>list<span class="w"> </span>x
<span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
$<span class="w"> </span>./kv<span class="w"> </span>list<span class="w"> </span>y
<span class="nv">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">22</span>
$<span class="w"> </span>./kv<span class="w"> </span>list
<span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<span class="nv">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">22</span>
</pre></div>
<p>Basic stuff!</p>
<p>You can find the code for this post in the <a href="https://github.com/eatonphil/zigrocks">rocksdb.zig file on
Github</a>. To simplify things,
this code is only going to work on Linux. And it will require Zig
0.10.x.</p>
<h3 id="rocksdb">RocksDB</h3><p>RocksDB is written in C++. But most languages cannot interface with
C++. (Zig cannot either, as far as I understand). So most C++
libraries expose a C API that is easier for other programming
languages to interact with. RocksDB does this. Great!</p>
<p>Now RocksDB's <a href="https://github.com/facebook/rocksdb/wiki">C++
documentation</a> is
phenomenal, especially among C++ libraries. But if there is
documentation for the C API, I couldn't find it. Instead you must
trawl through the <a href="https://github.com/facebook/rocksdb/blob/main/include/rocksdb/c.h">C header
file</a>,
the <a href="https://github.com/facebook/rocksdb/blob/main/db/c.cc">C wrapper
implementation</a>,
and the <a href="https://github.com/facebook/rocksdb/blob/main/db/c_test.c">C
tests</a>.</p>
<p>There was also a <a href="https://gist.github.com/nitingupta910/4640638be7e7ad39c41e">great gist showing a minimal RocksDB C
example</a>. But
it didn't cover the iterator API for fetching a range of keys with a
prefix. But with the C tests file I was able to figure it out, I
think.</p>
<p>Let's dig in!</p>
<h3 id="creating,-opening-and-closing-a-rocksdb-database">Creating, opening and closing a RocksDB database</h3><p>First we need to import the C header so that Zig can compile-time
verify the foreign functions we call. We'll also import the standard
library that we'll use later.</p>
<p>Aside from <code>build.zig</code> below, all code should be in <code>main.zig</code>.</p>
<div class="highlight"><pre><span></span><span class="kr">const</span><span class="w"> </span><span class="n">std</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">@import</span><span class="p">(</span><span class="s">&quot;std&quot;</span><span class="p">);</span>

<span class="kr">const</span><span class="w"> </span><span class="n">rdb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">@cImport</span><span class="p">(</span><span class="nb">@cInclude</span><span class="p">(</span><span class="s">&quot;rocksdb/c.h&quot;</span><span class="p">));</span>
</pre></div>
<p class="note">
  Don't read anything into the `@` other than that this is a compiler
  builtin. It's used for imports, casting, and other metaprogramming.
</p><p>Now we can build our wrapper. It will be a Zig struct that contains a
pointer to the RocksDB instance.</p>
<div class="highlight"><pre><span></span><span class="kr">const</span><span class="w"> </span><span class="n">RocksDB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">db</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">rdb</span><span class="p">.</span><span class="n">rocksdb_t</span><span class="p">,</span>
</pre></div>
<p>To open a database we'll call <code>rocksdb_open()</code> with a directory name
for RocksDB to store data. And we'll tell RocksDB to create the
database if it doesn't already exist.</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="n">dir</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">val</span><span class="o">:</span><span class="w"> </span><span class="o">?</span><span class="n">RocksDB</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="o">:</span><span class="w"> </span><span class="o">?</span><span class="p">[]</span><span class="kt">u8</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">var</span><span class="w"> </span><span class="n">options</span><span class="o">:</span><span class="w"> </span><span class="o">?*</span><span class="n">rdb</span><span class="p">.</span><span class="n">rocksdb_options_t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rdb</span><span class="p">.</span><span class="n">rocksdb_options_create</span><span class="p">();</span>
<span class="w">        </span><span class="n">rdb</span><span class="p">.</span><span class="n">rocksdb_options_set_create_if_missing</span><span class="p">(</span><span class="n">options</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="kr">var</span><span class="w"> </span><span class="n">err</span><span class="o">:</span><span class="w"> </span><span class="o">?</span><span class="p">[</span><span class="o">*:</span><span class="mi">0</span><span class="p">]</span><span class="kt">u8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">        </span><span class="kr">var</span><span class="w"> </span><span class="n">db</span><span class="o">:</span><span class="w"> </span><span class="o">?*</span><span class="n">rdb</span><span class="p">.</span><span class="n">rocksdb_t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rdb</span><span class="p">.</span><span class="n">rocksdb_open</span><span class="p">(</span><span class="n">options</span><span class="p">,</span><span class="w"> </span><span class="n">dir</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="p">.{</span><span class="w"> </span><span class="p">.</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">span</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">.{</span><span class="w"> </span><span class="p">.</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RocksDB</span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">db</span><span class="p">.</span><span class="o">?</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">.</span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
<p>Finally, we close with <code>rocksdb_close()</code>:</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="n">close</span><span class="p">(</span><span class="n">self</span><span class="o">:</span><span class="w"> </span><span class="n">RocksDB</span><span class="p">)</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">rdb</span><span class="p">.</span><span class="n">rocksdb_close</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">db</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
<p>The RocksDB aspect of this is easy. But there's a bunch of
Zig-specific details I should (try to) explain.</p>
<h4 id="return-types">Return types</h4><p>Zig has a cool
<a href="https://ziglang.org/documentation/master/#Errors"><code>error</code></a>
type. <code>try</code>/<code>catch</code> in Zig work only with this <code>error</code> type and
subsets of it you can create. <code>error</code> is an enum. But Zig <code>error</code>s are not
ML-style tagged unions (yet?). That is, you cannot both return an
error and some dynamic information about the error. So the usefulness
of <code>error</code> is limited. It mostly only works if the errors are a finite
set without dynamic aspects.</p>
<p>Zig also doesn't have multiple return values. But it does have
optional types (denoted with <code>?</code>) and it has anonymous structs.</p>
<p>So we can do a slightly less safe, but more informational, error type
by returning a struct with an optional success value and an optional
error.</p>
<p>That's how we get the return type <code>struct { val: ?RocksDB, err: ?[]u8 }</code>.</p>
<p>This is not very different from Go, certainly no less safe, and I'm
probably biased to use this as a Go programmer.</p>
<p class="note">
  Felix Quei√üner points out to me that there are tagged unions in Zig
  that would be more safe here. Instead of <code>struct { val:
  ?RocksDB, err: ?[]u8 }</code> I could do <code>union(enum) { val:
  RocksDB, err: []u8 }</code>. When I get a chance to play with that
  syntax I'll modify this post.
</p><h4 id="optional-pointers">Optional pointers</h4><p>The next thing you may notice is <code>?*rdb.rocksdb_options_t</code> and
<code>?*rdb.rocksdb_t</code>. This is to work with Zig's type system. Zig expects
that pointers are not null. By adding <code>?</code> we are telling Zig that this
value can be null. That way the Zig type system will force us to
handle the null condition if we try to access fields on the value.</p>
<p>In the options case, it doesn't really matter if the result is <code>null</code>
or not. In the database case, we handle null-ness it by checking the
error value <code>if (err) |errStr|</code>. If this condition is <em>not</em> met, we
know the database is not null. So we use <code>db.?</code> to assert and return a
value that, in the type system, is not null.</p>
<h4 id="zig-strings,-c-strings">Zig strings, C strings</h4><p>Another thing you may notice is <code>var err:
?[*:0]u8 = null;</code>. Zig strings are expressed as byte arrays or byte
slices. <code>[]u8</code> and <code>[]const u8</code> are slices that keep track of the
number of items. <code>[*:0]u8</code> is <em>not</em> a byte slice. It has no length and
is only null-delimited. To go from the null-delimited array that the C
API returns to the <code>[]u8</code> (slice that contains length) in our
function's return signature we use
<a href="https://github.com/ziglang/zig/blob/30b8b29f88362d18ea6523a859b29f7bc6dec622/lib/std/mem.zig"><code>std.mem.span</code></a>.</p>
<p><a href="https://stackoverflow.com/questions/72736997/how-to-pass-a-c-string-into-a-zig-function-expecting-a-zig-string">This StackOverflow
post</a>
was useful for understanding this.</p>
<h4 id="structs">Structs</h4><p>Anonymous structs in Zig are prefixed with a <code>.</code>. And all struct
fields, anonymous or not, are prefixed with <code>.</code>.</p>
<p>So <code>.{.x = 1}</code> instantiates an anonymous struct that has one field
<code>x</code>.</p>
<p>Struct fields in Zig cannot <em>not</em> be instantiated, even if they are
nullable. And when you initialize a nullable value you don't need to
wrap it in a <code>Some()</code> like you might do in an ML.</p>
<p>One thing I found surprising about Zig anonymous structs is that
instances of the anonymous <em>type</em> are created per function and two
anonymous structs that are structurally identical but referenced in
different functions are not actually type-equal.</p>
<p>So this doesn't compile:</p>
<div class="highlight"><pre><span></span><span class="err">$</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="k">test</span><span class="p">.</span><span class="n">zig</span>
<span class="k">fn</span><span class="w"> </span><span class="n">doA</span><span class="p">()</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">y</span><span class="o">:</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">.{.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">};</span>
<span class="p">}</span>

<span class="k">fn</span><span class="w"> </span><span class="n">doB</span><span class="p">()</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">y</span><span class="o">:</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">doA</span><span class="p">();</span>
<span class="p">}</span>

<span class="kr">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="o">!</span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">doB</span><span class="p">();</span>
<span class="p">}</span>
<span class="err">$</span><span class="w"> </span><span class="n">zig</span><span class="w"> </span><span class="n">build</span><span class="o">-</span><span class="n">exe</span><span class="w"> </span><span class="k">test</span><span class="p">.</span><span class="n">zig</span>
<span class="k">test</span><span class="p">.</span><span class="n">zig</span><span class="o">:</span><span class="mi">5</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="w"> </span><span class="k">error</span><span class="o">:</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="kt">type</span><span class="w"> </span><span class="err">&#39;</span><span class="k">test</span><span class="p">.</span><span class="n">doB__struct_2890</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="err">&#39;</span><span class="k">test</span><span class="p">.</span><span class="n">doA__struct_3878</span><span class="err">&#39;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">doA</span><span class="p">();</span>
<span class="w">           </span><span class="o">~~~^~</span>
<span class="k">test</span><span class="p">.</span><span class="n">zig</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="w"> </span><span class="n">note</span><span class="o">:</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="n">declared</span><span class="w"> </span><span class="n">here</span>
<span class="k">fn</span><span class="w"> </span><span class="n">doA</span><span class="p">()</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">y</span><span class="o">:</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="o">^~~~~~~~~~~~~~~~</span>
<span class="k">test</span><span class="p">.</span><span class="n">zig</span><span class="o">:</span><span class="mi">4</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="w"> </span><span class="n">note</span><span class="o">:</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="n">declared</span><span class="w"> </span><span class="n">here</span>
<span class="k">fn</span><span class="w"> </span><span class="n">doB</span><span class="p">()</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">y</span><span class="o">:</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="o">^~~~~~~~~~~~~~~~</span>
<span class="k">test</span><span class="p">.</span><span class="n">zig</span><span class="o">:</span><span class="mi">4</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="w"> </span><span class="n">note</span><span class="o">:</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kt">type</span><span class="w"> </span><span class="n">declared</span><span class="w"> </span><span class="n">here</span>
<span class="k">fn</span><span class="w"> </span><span class="n">doB</span><span class="p">()</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">y</span><span class="o">:</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="o">^~~~~~~~~~~~~~~~</span>
<span class="n">referenced</span><span class="w"> </span><span class="n">by</span><span class="o">:</span>
<span class="w">    </span><span class="n">main</span><span class="o">:</span><span class="w"> </span><span class="k">test</span><span class="p">.</span><span class="n">zig</span><span class="o">:</span><span class="mi">8</span><span class="o">:</span><span class="mi">9</span>
<span class="w">    </span><span class="n">callMain</span><span class="o">:</span><span class="w"> </span><span class="o">/</span><span class="n">whatever</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">start</span><span class="p">.</span><span class="n">zig</span><span class="o">:</span><span class="mi">606</span><span class="o">:</span><span class="mi">32</span>
<span class="w">    </span><span class="n">remaining</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="n">traces</span><span class="w"> </span><span class="n">hidden</span><span class="p">;</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="err">&#39;</span><span class="o">-</span><span class="n">freference</span><span class="o">-</span><span class="n">trace</span><span class="err">&#39;</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">see</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="n">traces</span>
</pre></div>
<p>You would need to instantiate a new anonymous struct in the second function.</p>
<div class="highlight"><pre><span></span><span class="err">$</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="k">test</span><span class="p">.</span><span class="n">zig</span>
<span class="k">fn</span><span class="w"> </span><span class="n">doA</span><span class="p">()</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">y</span><span class="o">:</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">.{.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">};</span>
<span class="p">}</span>

<span class="k">fn</span><span class="w"> </span><span class="n">doB</span><span class="p">()</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">y</span><span class="o">:</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">.{</span><span class="w"> </span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">doA</span><span class="p">().</span><span class="n">y</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="kr">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="o">!</span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">doB</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
<h4 id="uniform-function-call-syntax">Uniform function call syntax</h4><p>Zig seems to support something like <a href="https://en.wikipedia.org/wiki/Uniform_Function_Call_Syntax">uniform function call
syntax</a>
where you can either call a function with arguments or you can omit
the first argument by prefixing the function call with
<code>firstargument.</code>. I.e. <code>x.add(y)</code> and <code>add(x, y)</code>.</p>
<p>In the case of this code it would be <code>RocksDB.close(db)</code> vs
<code>db.close()</code> assuming <code>db</code> is an instance of the <code>RocksDB</code> struct.</p>
<p>Like Python, the use of <code>self</code> as the name of this first parameter of
a struct's methods is purely convention. You can call it whatever.</p>
<p>The point is that we always expect the user to <code>var db = RocksDB.open()</code> for
<code>open()</code> and allow the user to do <code>db.close()</code> for <code>close()</code>.</p>
<p>Let's move on!</p>
<h3 id="setting-a-key-value-pair">Setting a key-value pair</h3><p>We set a pair by calling <code>rocksdb_put</code> with the database instance,
some options (we'll leave to defaults), and the key and value strings
as C strings.</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="n">set</span><span class="p">(</span><span class="n">self</span><span class="o">:</span><span class="w"> </span><span class="n">RocksDB</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="p">[]</span><span class="kt">u8</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">var</span><span class="w"> </span><span class="n">writeOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rdb</span><span class="p">.</span><span class="n">rocksdb_writeoptions_create</span><span class="p">();</span>
<span class="w">        </span><span class="kr">var</span><span class="w"> </span><span class="n">err</span><span class="o">:</span><span class="w"> </span><span class="o">?</span><span class="p">[</span><span class="o">*:</span><span class="mi">0</span><span class="p">]</span><span class="kt">u8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">        </span><span class="n">rdb</span><span class="p">.</span><span class="n">rocksdb_put</span><span class="p">(</span>
<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">db</span><span class="p">,</span>
<span class="w">            </span><span class="n">writeOptions</span><span class="p">,</span>
<span class="w">            </span><span class="n">key</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span>
<span class="w">            </span><span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">,</span>
<span class="w">            </span><span class="n">value</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span>
<span class="w">            </span><span class="n">value</span><span class="p">.</span><span class="n">len</span><span class="p">,</span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">err</span><span class="p">,</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="n">errStr</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">span</span><span class="p">(</span><span class="n">errStr</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
<p>The only special Zig thing is there is <code>key.ptr</code> to satisfy the Zig /
C type system. The type signature <code>key: [:0]const u8</code> and <code>value:
[:0]const u8</code> makes sure that the user passes in a null-delimited
byte slice, which is what the RocksDB API expects.</p>
<h3 id="getting-a-value-from-a-key">Getting a value from a key</h3><p>We set a pair by calling <code>rocksdb_get</code> with the database instance,
some options (we'll again leave to defaults), and the key as a C
string.</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="n">get</span><span class="p">(</span><span class="n">self</span><span class="o">:</span><span class="w"> </span><span class="n">RocksDB</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">val</span><span class="o">:</span><span class="w"> </span><span class="o">?</span><span class="p">[]</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="o">:</span><span class="w"> </span><span class="o">?</span><span class="p">[]</span><span class="kt">u8</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">var</span><span class="w"> </span><span class="n">readOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rdb</span><span class="p">.</span><span class="n">rocksdb_readoptions_create</span><span class="p">();</span>
<span class="w">        </span><span class="kr">var</span><span class="w"> </span><span class="n">valueLength</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="kr">var</span><span class="w"> </span><span class="n">err</span><span class="o">:</span><span class="w"> </span><span class="o">?</span><span class="p">[</span><span class="o">*:</span><span class="mi">0</span><span class="p">]</span><span class="kt">u8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">        </span><span class="kr">var</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rdb</span><span class="p">.</span><span class="n">rocksdb_get</span><span class="p">(</span>
<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">db</span><span class="p">,</span>
<span class="w">            </span><span class="n">readOptions</span><span class="p">,</span>
<span class="w">            </span><span class="n">key</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span>
<span class="w">            </span><span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">,</span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">valueLength</span><span class="p">,</span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">err</span><span class="p">,</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="n">errStr</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="p">.{</span><span class="w"> </span><span class="p">.</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">span</span><span class="p">(</span><span class="n">errStr</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="p">.{</span><span class="w"> </span><span class="p">.</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">.{</span><span class="w"> </span><span class="p">.</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="n">valueLength</span><span class="p">],</span><span class="w"> </span><span class="p">.</span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
<p>One thing in there to call out is that we can go from a null-delimited
value <code>v</code> to a standard Zig slice <code>[]u8</code> by slicing from <code>0</code> to the
length of the value returned by the C API.</p>
<p>Also, <code>rocksdb_get</code> is only used for getting a single key-value
pair. We'll handle key-value pair iteration next.</p>
<h3 id="iterating-over-key-value-pairs">Iterating over key-value pairs</h3><p>The basic structure of RocksDB's iterator API is that you first create
an iterator instance with <code>rocksdb_create_iterator()</code>. Then you either
<code>rocksdb_iter_seek_to_first()</code> or <code>rocksdb_iter_seek()</code> (with a
prefix) to get the iterator ready. Then you get the current iterator
entry's key with <code>rocksdb_iter_key()</code> and value with
<code>rocksdb_iter_value()</code>. You move on to the next entry in the iterator
with <code>rocksdb_iter_next()</code> and check that the current iterator value
is valid with <code>rocksdb_iter_valid()</code>. When the iterator is no longer
valid, or if you want to stop iterating early, you call
<code>rocksdb_iter_destroy()</code>.</p>
<p>But we'd like to present a Zig-only interface to users of the
<code>RocksDB</code> Zig struct. So we'll create a <code>RocksDB.iter()</code> function that
returns a <code>RocksDB.Iter</code> with an <code>RocksDB.Iter.next()</code> function that
will return an optional <code>RocksDB.IterEntry</code>.</p>
<p>We'll start backwards with that <code>RocksDB.Iter</code> struct.</p>
<h4 id="<code>rocksdb.iter</code>"><code>RocksDB.Iter</code></h4><p>Each iterator instance will store a pointer to a RocksDB iterator
instance. It will store the prefix requested (which is allowed to be
an empty string). If the prefix is set though, we'll only iterate
while the iterator key has the requested prefix.</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">IterEntry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="k">const</span><span class="w"> </span><span class="n">u8</span><span class="p">,</span>
<span class="w">        </span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="k">const</span><span class="w"> </span><span class="n">u8</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">Iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">iter</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">rdb</span><span class="o">.</span><span class="n">rocksdb_iterator_t</span><span class="p">,</span>
<span class="w">        </span><span class="n">first</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">bool</span><span class="p">,</span>
<span class="w">        </span><span class="n">prefix</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="k">const</span><span class="w"> </span><span class="n">u8</span><span class="p">,</span>

<span class="w">        </span><span class="n">fn</span><span class="w"> </span><span class="n">next</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">Iter</span><span class="p">)</span><span class="w"> </span><span class="err">?</span><span class="n">IterEntry</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="bp">self</span><span class="o">.</span><span class="n">first</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">rdb</span><span class="o">.</span><span class="n">rocksdb_iter_next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">false</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rdb</span><span class="o">.</span><span class="n">rocksdb_iter_valid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">var</span><span class="w"> </span><span class="n">keySize</span><span class="p">:</span><span class="w"> </span><span class="n">usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">var</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rdb</span><span class="o">.</span><span class="n">rocksdb_iter_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">keySize</span><span class="p">);</span>

<span class="w">            </span><span class="o">//</span><span class="w"> </span><span class="n">Make</span><span class="w"> </span><span class="n">sure</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">still</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">prefix</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">keySize</span><span class="w"> </span><span class="ow">or</span>
<span class="w">                    </span><span class="o">!</span><span class="n">std</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">eql</span><span class="p">(</span><span class="n">u8</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">len</span><span class="p">],</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">))</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">var</span><span class="w"> </span><span class="n">valueSize</span><span class="p">:</span><span class="w"> </span><span class="n">usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">var</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rdb</span><span class="o">.</span><span class="n">rocksdb_iter_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">valueSize</span><span class="p">);</span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">IterEntry</span><span class="p">{</span>
<span class="w">                </span><span class="o">.</span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">key</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">keySize</span><span class="p">],</span>
<span class="w">                </span><span class="o">.</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">valueSize</span><span class="p">],</span>
<span class="w">            </span><span class="p">};</span>
<span class="w">        </span><span class="p">}</span>
</pre></div>
<p>Finally we'll wrap the <code>rocksdb_iter_destroy()</code> method:</p>
<div class="highlight"><pre><span></span><span class="w">        </span><span class="k">fn</span><span class="w"> </span><span class="n">close</span><span class="p">(</span><span class="n">self</span><span class="o">:</span><span class="w"> </span><span class="n">Iter</span><span class="p">)</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">rdb</span><span class="p">.</span><span class="n">rocksdb_iter_destroy</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">iter</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>
</pre></div>
<h4 id="<code>rocksdb.iter()</code>"><code>RocksDB.iter()</code></h4><p>Now we can write the function that creates the <code>RocksDB.Iter</code>. As
previously mentioned we must first instantiate the RocksDB iterator
and then <code>seek</code> to either the first entry if the user doesn't request
a prefix. Or if the user requests a prefix, we <code>seek</code> until that
prefix.</p>
<div class="highlight"><pre><span></span><span class="k">fn</span><span class="w"> </span><span class="n">iter</span><span class="p">(</span><span class="n">self</span><span class="o">:</span><span class="w"> </span><span class="n">RocksDB</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">val</span><span class="o">:</span><span class="w"> </span><span class="o">?</span><span class="n">Iter</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="o">:</span><span class="w"> </span><span class="o">?</span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">var</span><span class="w"> </span><span class="n">readOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rdb</span><span class="p">.</span><span class="n">rocksdb_readoptions_create</span><span class="p">();</span>
<span class="w">        </span><span class="kr">var</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Iter</span><span class="p">{</span>
<span class="w">            </span><span class="p">.</span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rdb</span><span class="p">.</span><span class="n">rocksdb_create_iterator</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">db</span><span class="p">,</span><span class="w"> </span><span class="n">readOptions</span><span class="p">))</span><span class="w"> </span><span class="o">|</span><span class="n">i</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">it</span><span class="p">.</span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="p">.{</span><span class="w"> </span><span class="p">.</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Could not create iterator&quot;</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prefix</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">rdb</span><span class="p">.</span><span class="n">rocksdb_iter_seek</span><span class="p">(</span>
<span class="w">                </span><span class="n">it</span><span class="p">.</span><span class="n">iter</span><span class="p">,</span>
<span class="w">                </span><span class="n">prefix</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span>
<span class="w">                </span><span class="n">prefix</span><span class="p">.</span><span class="n">len</span><span class="p">,</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">rdb</span><span class="p">.</span><span class="n">rocksdb_iter_seek_to_first</span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">iter</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">.{</span><span class="w"> </span><span class="p">.</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</pre></div>
<p>And now we're done a basic Zig wrapper for the RocksDB API!</p>
<h3 id="<code>main</code>"><code>main</code></h3><p>Next we write a simple command-line entrypoint that uses the RocksDB
wrapper we built. This is not the prettiest code but it gets the job
done.</p>
<div class="highlight"><pre><span></span><span class="kr">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="o">!</span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">openRes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RocksDB</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;/tmp/db&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">openRes</span><span class="p">.</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="n">err</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Failed to open: {s}.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span><span class="n">err</span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">openRes</span><span class="p">.</span><span class="n">val</span><span class="p">.</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="n">db</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>

<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">process</span><span class="p">.</span><span class="n">args</span><span class="p">();</span>
<span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="n">next</span><span class="p">();</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">key</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">value</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;get&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">next</span><span class="p">())</span><span class="w"> </span><span class="o">|</span><span class="n">arg</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">eql</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;set&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;set&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="n">next</span><span class="p">().</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="n">next</span><span class="p">().</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">eql</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;get&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;get&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="n">next</span><span class="p">().</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">eql</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;list&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;lst&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">next</span><span class="p">())</span><span class="w"> </span><span class="o">|</span><span class="n">argNext</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argNext</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Must specify command (get, set, or list). Got: &#39;{s}&#39;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span><span class="n">arg</span><span class="p">});</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">eql</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">command</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;set&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">var</span><span class="w"> </span><span class="n">setErr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">db</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">setErr</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="n">err</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Error setting key: {s}.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span><span class="n">err</span><span class="p">});</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">eql</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">command</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;get&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">var</span><span class="w"> </span><span class="n">getRes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">db</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getRes</span><span class="p">.</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="n">err</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Error getting key: {s}.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span><span class="n">err</span><span class="p">});</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getRes</span><span class="p">.</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="n">v</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;{s}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span><span class="n">v</span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Key not found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{});</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">var</span><span class="w"> </span><span class="n">prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">key</span><span class="p">;</span>
<span class="w">        </span><span class="kr">var</span><span class="w"> </span><span class="n">iterRes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">db</span><span class="p">.</span><span class="n">iter</span><span class="p">(</span><span class="n">prefix</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iterRes</span><span class="p">.</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="n">err</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Error getting iterator: {s}.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span><span class="n">err</span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kr">var</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iterRes</span><span class="p">.</span><span class="n">val</span><span class="p">.</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="k">defer</span><span class="w"> </span><span class="n">iter</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">iter</span><span class="p">.</span><span class="n">next</span><span class="p">())</span><span class="w"> </span><span class="o">|</span><span class="n">entry</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;{s} = {s}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Notably, the <code>main</code> function must be marked <code>pub</code>. The struct and
struct methods we wrote would need to be marked <code>pub</code> if we wanted
them accessible from other files. But since this is a single file,
<code>pub</code> doesn't matter. Except for <code>main</code>.</p>
<p>Now we can get into building.</p>
<h3 id="building">Building</h3><p>First we need to compile the RocksDB library. To do this we simply
<code>git clone</code> RocksDB and run <code>make shared_libs</code>.</p>
<h4 id="compiling-rocksdb">Compiling RocksDB</h4><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/facebook/rocksdb
$<span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>rocksdb<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>make<span class="w"> </span>shared_lib<span class="w"> </span>-j8<span class="w"> </span><span class="o">)</span>
</pre></div>
<p>This may take a while, sorry.</p>
<h4 id="<code>build.zig</code>"><code>build.zig</code></h4><p>Next we need to write a <code>build.zig</code> script that tells Zig about this
external library. This was one of the harder parts of the process, but
building and linking against foreign libraries is almost always hard.</p>
<div class="highlight"><pre><span></span><span class="err">$</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="n">build</span><span class="p">.</span><span class="n">zig</span>
<span class="kr">const</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">@import</span><span class="p">(</span><span class="s">&quot;builtin&quot;</span><span class="p">).</span><span class="n">zig_version</span><span class="p">;</span>
<span class="kr">const</span><span class="w"> </span><span class="n">std</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">@import</span><span class="p">(</span><span class="s">&quot;std&quot;</span><span class="p">);</span>

<span class="kr">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">build</span><span class="p">(</span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">std</span><span class="p">.</span><span class="n">build</span><span class="p">.</span><span class="n">Builder</span><span class="p">)</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">exe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">addExecutable</span><span class="p">(</span><span class="s">&quot;main&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;main.zig&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">exe</span><span class="p">.</span><span class="n">linkLibC</span><span class="p">();</span>
<span class="w">    </span><span class="n">exe</span><span class="p">.</span><span class="n">linkSystemLibraryName</span><span class="p">(</span><span class="s">&quot;rocksdb&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="n">exe</span><span class="p">.</span><span class="n">addLibraryPath</span><span class="p">(</span><span class="s">&quot;./rocksdb&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">exe</span><span class="p">.</span><span class="n">addIncludePath</span><span class="p">(</span><span class="s">&quot;./rocksdb/include&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="n">exe</span><span class="p">.</span><span class="n">setOutputDir</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">exe</span><span class="p">.</span><span class="n">install</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
<p>Felix Quei√üner's <a href="https://zig.news/xq/zig-build-explained-part-3-1ima">zig build
explained</a> series
was quite helpful.</p>
<p>Now we just:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>zig<span class="w"> </span>build
</pre></div>
<p>And run!</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>./main<span class="w"> </span>list
$<span class="w"> </span>./main<span class="w"> </span><span class="nb">set</span><span class="w"> </span>x<span class="w"> </span><span class="m">12</span>
$<span class="w"> </span>./main<span class="w"> </span><span class="nb">set</span><span class="w"> </span>xy<span class="w"> </span><span class="m">300</span>
$<span class="w"> </span>./main<span class="w"> </span>list
<span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span>
<span class="nv">xy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">300</span>
$<span class="w"> </span>./main<span class="w"> </span>get<span class="w"> </span>xy
<span class="m">300</span>
$<span class="w"> </span>./main<span class="w"> </span>list<span class="w"> </span>xy
<span class="nv">xy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">300</span>
</pre></div>
<p>Not bad!</p>
<p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">I wrote a new post on using RocksDB with Zig! There weren&#39;t a lot of good examples of the C API and it was good practice for learning Zig.<br><br>Also sets me up for integrating it in a (WIP) port of my toy SQL database from Go to Zig. (This time with storage!)<a href="https://t.co/zquojV974G">https://t.co/zquojV974G</a> <a href="https://t.co/gtAsB6Wrhi">pic.twitter.com/gtAsB6Wrhi</a></p>&mdash; Phil Eaton (@phil_eaton) <a href="https://twitter.com/phil_eaton/status/1586908890960117760?ref_src=twsrc%5Etfw">October 31, 2022</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<style>.feedback{display:initial;}</style>
	</div>
	<div class="feedback">
	  <h4>Feedback</h4>
	  <p>As always,
	      please <a href="mailto:phil@eatonphil.com">email</a>
	      or <a href="https://twitter.com/eatonphil">tweet me</a>
	      with questions, corrections, or ideas!</p>

	</div>
      </div>
    </div>
    <footer>
      <div class="container">
	<div>
	  <div id="subscribe">
	    <iframe frameBorder="0" src="https://cdn.forms-content-1.sg-form.com/e8ed4c3b-dd46-11f0-b6e6-ce075f2c5f80"/>

	  </div>
	</div>
      </div>
    </footer>
    <script async onload="loadGA()" src="https://www.googletagmanager.com/gtag/js?id=UA-58109156-2"></script>
    <script>
      function loadGA() {
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());
	  gtag('config', 'UA-58109156-2');
      }
    </script>
    <script defer src="https://cdn.usefathom.com/script.js" data-site="CEPUOLOQ"></script>
  </body>
</html>
