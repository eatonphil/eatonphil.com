<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="canonical" href="https://notes.eatonphil.com/emulating-amd64-starting-with-elf.html">
    <title>Emulating linux/AMD64 userland: interpreting an ELF binary | notes.eatonphil.com</title>
    <meta name="description" content="Emulating linux/AMD64 userland: interpreting an ELF binary" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" href="/rss.xml" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono">
  </head>
  <body>
    <header>
      <!-- <div class="lfw"> -->
      <!-- 	<div class="container"> -->
      <!-- 	  <div class="row"> -->
      <!-- 	    <a href="https://eatonphil.com/hire-me.html">Hire me!</a> -->
      <!-- 	  </div> -->
      <!-- 	</div> -->
      <!-- </div> -->
      <div class="container">
        <div>
          <div class="row">
	    <div>
	      <a href="https://eatonphil.com" class="sm-link">
		Home
              </a>
	      <a href="/" class="sm-link">
		Notes
              </a>
	      <a href="/favorites.html" class="sm-link hide-mobile">
		Popular
              </a>
	      <a href="/rss.xml" class="sm-link">
		RSS
              </a>
	    </div>
	    	      
	    <div class="subscribe">
	      <a href="https://eatonphil.com/hire-me.html">Hire me</a>
	      <a class="fancy" href="https://notes.eatonphil.com/emulating-amd64-starting-with-elf.html#subscribe">       
		Subscribe          
	      </a>
            </div>
	  </div>
	  <hr />
	  <div class="">
            <h2>November 26, 2020</h2>
            <h1>Emulating linux/AMD64 userland: interpreting an ELF binary</h1>
            <div class="row" style="padding-bottom: 5px">
              <div class="tags"><a href="/tags/emulators.html" class="tag">emulators</a><a href="/tags/assembly.html" class="tag">assembly</a><a href="/tags/linux.html" class="tag">linux</a><a href="/tags/x86-amd64.html" class="tag">x86/amd64</a><a href="/tags/go.html" class="tag">go</a></div>
            </div>
	  </div>
	</div>
      </div>
    </header>
    <div class="container">
      <div class="col-6">
        <p>In this post we'll stumble toward a working emulator for a barebones C
program compiled for linux/AMD64. The approach will be slightly more
so based on observation than by following a spec; a great way
to quickly become familiar with a topic, and a bad way to guarantee
correctness.</p>
<p>The goal:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>cat<span class="w"> </span>tests/simple.c
int<span class="w"> </span>main<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="m">4</span><span class="p">;</span>
<span class="o">}</span>
$<span class="w"> </span>gcc<span class="w"> </span>tests/simple.c
$<span class="w"> </span>go<span class="w"> </span>build<span class="w"> </span>-o<span class="w"> </span>main
$<span class="w"> </span>./main<span class="w"> </span>a.out<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$?</span>
<span class="m">4</span>
</pre></div>
<p>This may look ridiculously simple but when you don't know how to deal
with a binary or how instructions are encoded, it will take a few
hours to write an emulator that can generally handle this program!</p>
<p>Code for this project is <a href="https://github.com/eatonphil/go-amd64-emulator">available on Github</a>.</p>
<h3 id="background">Background</h3><p>AMD64, x86_64 or x64 are different names for AMD's widely adopted
64-bit extension to Intel's x86 instruction set (i.e. the encoding and
semantics of x86 binaries). AMD64 is a superset of x86 (introducing
64-bit registers and operations) and thus backwards compatible with
x86 programs.</p>
<p class="note">
  A year and a half ago I first got into emulation with
  an <a href="https://notes.eatonphil.com/emulator-basics-a-stack-and-register-machine.html">AMD64
  emulator in JavaScript</a>. The JavaScript emulator interpreted the
  textual representation of AMD64 programs (e.g. <code>MOV RBP,
  RSP</code>, Intel's assembly syntax). A C program had to be compiled
  with <code>-S</code> to produce an assembly file that the JavaScript
  emulator could read (i.e. <code>gcc -S tests/simple.c</code>) This
  was a great way to get started with emulation by ignoring the
  complexity of encoded instructions and executable formats.
</p><p>If we dig into the binary file produced by gcc on Linux we learn that
it is an <a href="https://en.wikipedia.org/wiki/Executable_and_Linkable_Format">ELF
file</a>.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>gcc<span class="w"> </span>test/simple.c
$<span class="w"> </span>file<span class="w"> </span>a.out
a.out:<span class="w"> </span>ELF<span class="w"> </span><span class="m">64</span>-bit<span class="w"> </span>LSB<span class="w"> </span>executable,<span class="w"> </span>x86-64,<span class="w"> </span>version<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">(</span>SYSV<span class="o">)</span>,<span class="w"> </span>dynamically<span class="w"> </span>linked,<span class="w"> </span>interpreter<span class="w"> </span>/lib64/ld-linux-x86-64.so.2,<span class="w"> </span>BuildID<span class="o">[</span>sha1<span class="o">]=</span>d0b5c742b9fbcbcca4dfa9438a8437a8478a51bb,<span class="w"> </span><span class="k">for</span><span class="w"> </span>GNU/Linux<span class="w"> </span><span class="m">3</span>.2.0,<span class="w"> </span>not<span class="w"> </span>stripped
</pre></div>
<p>ELF is responsible for surrounding the actual binary-encoded program
instructions with metadata on exported and imported C identifiers and
program entrypoint. But for simple programs like this initial
emulator, we can ignore export/imports. We'll only use the ELF
metadata to find out where the instructions for our <code>main</code>
function start.</p>
<h3 id="where-is-main?">Where is main?</h3><p>If we use an ELF reader+disassembler on the binary generated by gcc
and search for <code>main</code> we can find its address.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>objdump<span class="w"> </span>-d<span class="w"> </span>a.out<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-A10<span class="w"> </span><span class="s1">&#39;&lt;main&gt;&#39;</span>
<span class="m">0000000000401106</span><span class="w"> </span>&lt;main&gt;:
<span class="w">  </span><span class="m">401106</span>:<span class="w">       </span><span class="m">55</span><span class="w">                      </span>push<span class="w">   </span>%rbp
<span class="w">  </span><span class="m">401107</span>:<span class="w">       </span><span class="m">48</span><span class="w"> </span><span class="m">89</span><span class="w"> </span>e5<span class="w">                </span>mov<span class="w">    </span>%rsp,%rbp
<span class="w">  </span>40110a:<span class="w">       </span>b8<span class="w"> </span>fe<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">          </span>mov<span class="w">    </span><span class="nv">$0</span>xfe,%eax
<span class="w">  </span>40110f:<span class="w">       </span>5d<span class="w">                      </span>pop<span class="w">    </span>%rbp
<span class="w">  </span><span class="m">401110</span>:<span class="w">       </span>c3<span class="w">                      </span>retq
<span class="w">  </span><span class="m">401111</span>:<span class="w">       </span><span class="m">66</span><span class="w"> </span>2e<span class="w"> </span>0f<span class="w"> </span>1f<span class="w"> </span><span class="m">84</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">    </span>nopw<span class="w">   </span>%cs:0x0<span class="o">(</span>%rax,%rax,1<span class="o">)</span>
<span class="w">  </span><span class="m">401118</span>:<span class="w">       </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span>
<span class="w">  </span>40111b:<span class="w">       </span>0f<span class="w"> </span>1f<span class="w"> </span><span class="m">44</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">          </span>nopl<span class="w">   </span>0x0<span class="o">(</span>%rax,%rax,1<span class="o">)</span>

<span class="m">0000000000401120</span><span class="w"> </span>&lt;__libc_csu_init&gt;:
</pre></div>
<p>This means that the function, <code>main</code>, starts at
address <code>0x401106</code> in memory. Furthermore, this implies
that the binary must be loaded into CPU memory such that the CPU can
jump here to execute our program.</p>
<p>In truth, <code>main</code> is not this program's entrypoint. If we
run <code>objdump -x a.out</code> we can see that the ELF entrypoint
is <code>0x401020</code>.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>objdump<span class="w"> </span>-x<span class="w"> </span>a.out
a.out:<span class="w">     </span>file<span class="w"> </span>format<span class="w"> </span>elf64-x86-64
a.out
architecture:<span class="w"> </span>i386:x86-64,<span class="w"> </span>flags<span class="w"> </span>0x00000112:
EXEC_P,<span class="w"> </span>HAS_SYMS,<span class="w"> </span>D_PAGED
start<span class="w"> </span>address<span class="w"> </span>0x0000000000401020

Program<span class="w"> </span>Header:
<span class="w">    </span>PHDR<span class="w"> </span>off<span class="w">    </span>0x0000000000000040<span class="w"> </span>vaddr<span class="w"> </span>0x0000000000400040<span class="w"> </span>paddr<span class="w"> </span>0x0000000000400040<span class="w"> </span>align<span class="w"> </span><span class="m">2</span>**3
<span class="w">             </span>filesz<span class="w"> </span>0x00000000000002d8<span class="w"> </span>memsz<span class="w"> </span>0x00000000000002d8<span class="w"> </span>flags<span class="w"> </span>r--
</pre></div>
<p>This is because the actual entrypoint gcc sets up is a function called
<code>_start</code>. The libc prelude beginning
with <code>_start</code> is responsible for initializing the libc
runtime, calling our <code>main</code> function and executing the exit
syscall with the return value of <code>main</code>.</p>
<div class="highlight"><pre><span></span>objdump<span class="w"> </span>-d<span class="w"> </span>a.out<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-A10<span class="w"> </span><span class="s1">&#39;&lt;_start&gt;&#39;</span>
<span class="m">0000000000401020</span><span class="w"> </span>&lt;_start&gt;:
<span class="w">  </span><span class="m">401020</span>:<span class="w">       </span>f3<span class="w"> </span>0f<span class="w"> </span>1e<span class="w"> </span>fa<span class="w">             </span>endbr64
<span class="w">  </span><span class="m">401024</span>:<span class="w">       </span><span class="m">31</span><span class="w"> </span>ed<span class="w">                   </span>xor<span class="w">    </span>%ebp,%ebp
<span class="w">  </span><span class="m">401026</span>:<span class="w">       </span><span class="m">49</span><span class="w"> </span><span class="m">89</span><span class="w"> </span>d1<span class="w">                </span>mov<span class="w">    </span>%rdx,%r9
<span class="w">  </span><span class="m">401029</span>:<span class="w">       </span>5e<span class="w">                      </span>pop<span class="w">    </span>%rsi
<span class="w">  </span>40102a:<span class="w">       </span><span class="m">48</span><span class="w"> </span><span class="m">89</span><span class="w"> </span>e2<span class="w">                </span>mov<span class="w">    </span>%rsp,%rdx
<span class="w">  </span>40102d:<span class="w">       </span><span class="m">48</span><span class="w"> </span><span class="m">83</span><span class="w"> </span>e4<span class="w"> </span>f0<span class="w">             </span>and<span class="w">    </span><span class="nv">$0</span>xfffffffffffffff0,%rsp
<span class="w">  </span><span class="m">401031</span>:<span class="w">       </span><span class="m">50</span><span class="w">                      </span>push<span class="w">   </span>%rax
<span class="w">  </span><span class="m">401032</span>:<span class="w">       </span><span class="m">54</span><span class="w">                      </span>push<span class="w">   </span>%rsp
<span class="w">  </span><span class="m">401033</span>:<span class="w">       </span><span class="m">49</span><span class="w"> </span>c7<span class="w"> </span>c0<span class="w"> </span><span class="m">90</span><span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="m">40</span><span class="w"> </span><span class="m">00</span><span class="w">    </span>mov<span class="w">    </span><span class="nv">$0</span>x401190,%r8
<span class="w">  </span>40103a:<span class="w">       </span><span class="m">48</span><span class="w"> </span>c7<span class="w"> </span>c1<span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="m">40</span><span class="w"> </span><span class="m">00</span><span class="w">    </span>mov<span class="w">    </span><span class="nv">$0</span>x401120,%rcx
</pre></div>
<p>But because all this libc initialization is relatively complicated
we're just going to skip the actual ELF entrypoint for now. Our
emulator will locate <code>main</code>, load the binary into memory,
jump to the start of <code>main</code>, and set the exit code of the
emulator to the result of main.</p>
<p class="note">
  As you can see, this ELF binary has its own hard-coded view of where
  it will be in memory. What if our CPU were to run multiple process
  at once? We might give each process its own virtual memory space
  and map back to a real memory space so each process (and by
  extension, compilers) doesn't have to think about how they fit into
  memory relative to other processes.
</p><p>The last question to figure out is where to load the ELF binary into
emulator memory so that addresses in memory are where the program
expects.</p>
<p>As it turns out, there is a piece of metadata called section
headers that contain an address and a offset from the start of the ELF
file. By subtracting this we can get the location the file expects to
be in memory.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>objdump<span class="w"> </span>-x<span class="w"> </span>a.out
a.out:<span class="w">     </span>file<span class="w"> </span>format<span class="w"> </span>elf64-x86-64
a.out
architecture:<span class="w"> </span>i386:x86-64,<span class="w"> </span>flags<span class="w"> </span>0x00000112:
EXEC_P,<span class="w"> </span>HAS_SYMS,<span class="w"> </span>D_PAGED
start<span class="w"> </span>address<span class="w"> </span>0x0000000000401020

Program<span class="w"> </span>Header:
<span class="w">    </span>PHDR<span class="w"> </span>off<span class="w">    </span>0x0000000000000040<span class="w"> </span>vaddr<span class="w"> </span>0x0000000000400040<span class="w"> </span>paddr<span class="w"> </span>0x0000000000400040<span class="w"> </span>align<span class="w"> </span><span class="m">2</span>**3
<span class="w">             </span>filesz<span class="w"> </span>0x00000000000002d8<span class="w"> </span>memsz<span class="w"> </span>0x00000000000002d8<span class="w"> </span>flags<span class="w"> </span>r--
</pre></div>
<p>That is: <code>0x400040 (vaddr) - 0x40 (off) = 0x400000</code>.
Judging from a Google search this seems to be a pretty common address
where ELF binaries are loaded into memory.</p>
<h3 id="elf-and-go">ELF and Go</h3><p>Binary file formats tend to be a pain to work with because, to enable
greater compression, everything ends up being a pointer to something
else. So you end up jumping all around the file just to stitch
information back together.</p>
<p>So the one third-party-ish library we'll use is Go's builtin
<code>debug/elf</code> package. With this library we can load an ELF
binary and iterate over symbols and sections to discover the location
of <code>main</code> and the start address for the binary in memory.</p>
<p>Editing in <code>main.go</code>:</p>
<div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;bytes&quot;</span>
<span class="w">    </span><span class="s">&quot;debug/elf&quot;</span>
<span class="w">    </span><span class="s">&quot;fmt&quot;</span>
<span class="w">    </span><span class="s">&quot;io/ioutil&quot;</span>
<span class="w">    </span><span class="s">&quot;log&quot;</span>
<span class="w">    </span><span class="s">&quot;os&quot;</span>
<span class="p">)</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">process</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">startAddress</span><span class="w"> </span><span class="kt">uint64</span>
<span class="w">    </span><span class="nx">entryPoint</span><span class="w">   </span><span class="kt">uint64</span>
<span class="w">    </span><span class="nx">bin</span><span class="w">          </span><span class="p">[]</span><span class="kt">byte</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">readELF</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">entrySymbol</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">process</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">bin</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ioutil</span><span class="p">.</span><span class="nx">ReadFile</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">elffile</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">elf</span><span class="p">.</span><span class="nx">NewFile</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">NewReader</span><span class="p">(</span><span class="nx">bin</span><span class="p">))</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">symbols</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">elffile</span><span class="p">.</span><span class="nx">Symbols</span><span class="p">()</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">entryPoint</span><span class="w"> </span><span class="kt">uint64</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">sym</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">symbols</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">sym</span><span class="p">.</span><span class="nx">Name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">entrySymbol</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">elf</span><span class="p">.</span><span class="nx">STT_FUNC</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">elf</span><span class="p">.</span><span class="nx">ST_TYPE</span><span class="p">(</span><span class="nx">sym</span><span class="p">.</span><span class="nx">Info</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">elf</span><span class="p">.</span><span class="nx">STB_GLOBAL</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">elf</span><span class="p">.</span><span class="nx">ST_BIND</span><span class="p">(</span><span class="nx">sym</span><span class="p">.</span><span class="nx">Info</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">entryPoint</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">sym</span><span class="p">.</span><span class="nx">Value</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">entryPoint</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;Could not find entrypoint symbol: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">entrySymbol</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">startAddress</span><span class="w"> </span><span class="kt">uint64</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">sec</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">elffile</span><span class="p">.</span><span class="nx">Sections</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">sec</span><span class="p">.</span><span class="nx">Type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">elf</span><span class="p">.</span><span class="nx">SHT_NULL</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">startAddress</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">sec</span><span class="p">.</span><span class="nx">Addr</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">sec</span><span class="p">.</span><span class="nx">Offset</span>
<span class="w">            </span><span class="k">break</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">startAddress</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;Could not determine start address&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">process</span><span class="p">{</span>
<span class="w">        </span><span class="nx">startAddress</span><span class="p">:</span><span class="w"> </span><span class="nx">startAddress</span><span class="p">,</span>
<span class="w">        </span><span class="nx">entryPoint</span><span class="p">:</span><span class="w">   </span><span class="nx">entryPoint</span><span class="p">,</span>
<span class="w">        </span><span class="nx">bin</span><span class="p">:</span><span class="w">          </span><span class="nx">bin</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">)</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">&quot;Binary not provided&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">proc</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">readELF</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;main&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Start: 0x%x\nEntry: 0x%x\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">proc</span><span class="p">.</span><span class="nx">startAddress</span><span class="p">,</span><span class="w"> </span><span class="nx">proc</span><span class="p">.</span><span class="nx">entryPoint</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
<p>We can test on a basic compiled C program:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>cat<span class="w"> </span>tests/simple.c
int<span class="w"> </span>main<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="m">4</span><span class="p">;</span>
<span class="o">}</span>
$<span class="w"> </span>gcc<span class="w"> </span>tests/simple.c
$<span class="w"> </span>go<span class="w"> </span>build<span class="w"> </span>-o<span class="w"> </span>main
$<span class="w"> </span>./main<span class="w"> </span>a.out
Start:<span class="w"> </span>0x400000
Entry:<span class="w"> </span>0x401106
</pre></div>
<p>And verify against <code>objdump</code>:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>objdump<span class="w"> </span>-d<span class="w"> </span>a.out<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-A10<span class="w"> </span><span class="s1">&#39;&lt;main&gt;&#39;</span>
<span class="m">0000000000401106</span><span class="w"> </span>&lt;main&gt;:
<span class="w">  </span><span class="m">401106</span>:<span class="w">       </span><span class="m">55</span><span class="w">                      </span>push<span class="w">   </span>%rbp<span class="s1">&#39;&gt;&#39;</span>
</pre></div>
<p>And that's it for dealing with ELF. Now we can sketch out a virtual
CPU and how we deal with interpreting instructions starting at this
address.</p>
<h3 id="the-cpu">The CPU</h3><p>AMD64 counts on being able to store values in registers and memory,
sometimes through direct addressing and sometimes indirectly using
stack operations (push and pop). And userland processes count on being
loaded into CPU memory so the CPU can jump to the process entrypoint
and process.</p>
<div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">cpu</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">proc</span><span class="w">    </span><span class="o">*</span><span class="nx">process</span>
<span class="w">    </span><span class="nx">mem</span><span class="w">     </span><span class="p">[]</span><span class="kt">byte</span>
<span class="w">    </span><span class="nx">regfile</span><span class="w"> </span><span class="o">*</span><span class="nx">registerFile</span>
<span class="w">    </span><span class="nx">tick</span><span class="w">    </span><span class="kd">chan</span><span class="w"> </span><span class="kt">bool</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">newCPU</span><span class="p">(</span><span class="nx">memory</span><span class="w"> </span><span class="kt">uint64</span><span class="p">)</span><span class="w"> </span><span class="nx">cpu</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">cpu</span><span class="p">{</span>
<span class="w">        </span><span class="nx">mem</span><span class="p">:</span><span class="w">     </span><span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="nx">memory</span><span class="p">),</span>
<span class="w">        </span><span class="nx">regfile</span><span class="p">:</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">registerFile</span><span class="p">{},</span>
<span class="w">        </span><span class="nx">tick</span><span class="p">:</span><span class="w">    </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>The <code>tick</code> channel is so that later on we can wrap the
emulator in a terminal debugger. But by default we'll just set up a
goroutine to tick forever.</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">repl</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">cpu</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// TODO</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">)</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">&quot;Binary not provided&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">proc</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">readELF</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;main&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">debug</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">arg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="nx">arg</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;--debug&quot;</span><span class="p">:</span>
<span class="w">            </span><span class="k">fallthrough</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;-d&quot;</span><span class="p">:</span>
<span class="w">            </span><span class="nx">debug</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 10 MB</span>
<span class="w">    </span><span class="nx">cpu</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">newCPU</span><span class="p">(</span><span class="mh">0x400000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>

<span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="nx">cpu</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="nx">proc</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">debug</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">repl</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">cpu</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">cpu</span><span class="p">.</span><span class="nx">tick</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">true</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<h3 id="registers">Registers</h3><p>To emulate a simple program like our <code>tests/simple.c</code>,
we'll only need to support a few common registers. The order is
important so that we can use the Go identifiers when we want to refer
to the <a href="https://wiki.osdev.org/X86-64_Instruction_Encoding#Registers">encoded integer value of the
register</a>.</p>
<div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">register</span><span class="w"> </span><span class="kt">int</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="c1">// These are in order of encoding value (i.e. rbp is 5)</span>
<span class="w">    </span><span class="nx">rax</span><span class="w"> </span><span class="nx">register</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">iota</span>
<span class="w">    </span><span class="nx">rcx</span>
<span class="w">    </span><span class="nx">rdx</span>
<span class="w">    </span><span class="nx">rbx</span>
<span class="w">    </span><span class="nx">rsp</span>
<span class="w">    </span><span class="nx">rbp</span>
<span class="w">    </span><span class="nx">rsi</span>
<span class="w">    </span><span class="nx">rdi</span>
<span class="w">    </span><span class="nx">r8</span>
<span class="w">    </span><span class="nx">r9</span>
<span class="w">    </span><span class="nx">r10</span>
<span class="w">    </span><span class="nx">r11</span>
<span class="w">    </span><span class="nx">r12</span>
<span class="w">    </span><span class="nx">r13</span>
<span class="w">    </span><span class="nx">r14</span>
<span class="w">    </span><span class="nx">r15</span>
<span class="w">    </span><span class="nx">rip</span>
<span class="w">    </span><span class="nx">rflags</span>
<span class="p">)</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">registerMap</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="nx">register</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
<span class="w">    </span><span class="nx">rax</span><span class="p">:</span><span class="w">    </span><span class="s">&quot;rax&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">rcx</span><span class="p">:</span><span class="w">    </span><span class="s">&quot;rcx&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">rdx</span><span class="p">:</span><span class="w">    </span><span class="s">&quot;rdx&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">rbx</span><span class="p">:</span><span class="w">    </span><span class="s">&quot;rbx&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">rsp</span><span class="p">:</span><span class="w">    </span><span class="s">&quot;rsp&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">rbp</span><span class="p">:</span><span class="w">    </span><span class="s">&quot;rbp&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">rsi</span><span class="p">:</span><span class="w">    </span><span class="s">&quot;rsi&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">rdi</span><span class="p">:</span><span class="w">    </span><span class="s">&quot;rdi&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">r8</span><span class="p">:</span><span class="w">     </span><span class="s">&quot;r8&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">r9</span><span class="p">:</span><span class="w">     </span><span class="s">&quot;r9&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">r10</span><span class="p">:</span><span class="w">    </span><span class="s">&quot;r10&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">r11</span><span class="p">:</span><span class="w">    </span><span class="s">&quot;r11&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">r12</span><span class="p">:</span><span class="w">    </span><span class="s">&quot;r12&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">r13</span><span class="p">:</span><span class="w">    </span><span class="s">&quot;r13&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">r14</span><span class="p">:</span><span class="w">    </span><span class="s">&quot;r14&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">r15</span><span class="p">:</span><span class="w">    </span><span class="s">&quot;r15&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">rip</span><span class="p">:</span><span class="w">    </span><span class="s">&quot;rip&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">rflags</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;rflags&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">registerFile</span><span class="w"> </span><span class="p">[</span><span class="mi">18</span><span class="p">]</span><span class="kt">uint64</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">regfile</span><span class="w"> </span><span class="o">*</span><span class="nx">registerFile</span><span class="p">)</span><span class="w"> </span><span class="nx">get</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="nx">register</span><span class="p">)</span><span class="w"> </span><span class="kt">uint64</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">regfile</span><span class="p">[</span><span class="nx">r</span><span class="p">]</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">regfile</span><span class="w"> </span><span class="o">*</span><span class="nx">registerFile</span><span class="p">)</span><span class="w"> </span><span class="nx">set</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="nx">register</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="kt">uint64</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">regfile</span><span class="p">[</span><span class="nx">r</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">v</span>
<span class="p">}</span>
</pre></div>
<p>Of immediate importance will be <code>rip</code>, <code>rsp</code>,
and <code>rax</code> registers. <code>rip</code> is used to track the
current instruction to process. It will generally be incremented
except for when dealing with function calls and
returns. <code>rsp</code> is used as a pointer to the top of a stack
in memory. It is incremented and decremented as values are pushed and
popped on this stack. Finally, <code>rax</code> is used to pass
function return values.</p>
<h3 id="loading-a-program">Loading a program</h3><p>Running a program is a matter of loading the program into memory,
setting the stack pointer to the last address of memory (in x86 the
stack grows down), pointing <code>rip</code> at the entrypoint, and
looping until the entrypoint function returns.</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">writeBytes</span><span class="p">(</span><span class="nx">to</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="kt">uint64</span><span class="p">,</span><span class="w"> </span><span class="nx">bytes</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">val</span><span class="w"> </span><span class="kt">uint64</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">bytes</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">to</span><span class="p">[</span><span class="nx">start</span><span class="o">+</span><span class="nb">uint64</span><span class="p">(</span><span class="nx">i</span><span class="p">)]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">byte</span><span class="p">(</span><span class="nx">val</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">cpu</span><span class="p">)</span><span class="w"> </span><span class="nx">loop</span><span class="p">(</span><span class="nx">entryReturnAddress</span><span class="w"> </span><span class="kt">uint64</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">&lt;-</span><span class="nx">c</span><span class="p">.</span><span class="nx">tick</span>

<span class="w">        </span><span class="nx">ip</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">regfile</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">rip</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">ip</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">entryReturnAddress</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">break</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">inb1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">mem</span><span class="p">[</span><span class="nx">ip</span><span class="p">]</span>

<span class="w">        </span><span class="c1">// TODO: deal with instructions</span>

<span class="w">        </span><span class="c1">// move to next instruction</span>
<span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">regfile</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">rip</span><span class="p">,</span><span class="w"> </span><span class="nx">ip</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">cpu</span><span class="p">)</span><span class="w"> </span><span class="nx">run</span><span class="p">(</span><span class="nx">proc</span><span class="w"> </span><span class="o">*</span><span class="nx">process</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">copy</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">mem</span><span class="p">[</span><span class="nx">proc</span><span class="p">.</span><span class="nx">startAddress</span><span class="p">:</span><span class="nx">proc</span><span class="p">.</span><span class="nx">startAddress</span><span class="o">+</span><span class="nb">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">proc</span><span class="p">.</span><span class="nx">bin</span><span class="p">))],</span><span class="w"> </span><span class="nx">proc</span><span class="p">.</span><span class="nx">bin</span><span class="p">)</span>
<span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">regfile</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">rip</span><span class="p">,</span><span class="w"> </span><span class="nx">proc</span><span class="p">.</span><span class="nx">entryPoint</span><span class="p">)</span>
<span class="w">    </span><span class="nx">initialStackPointer</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">mem</span><span class="p">)</span><span class="o">-</span><span class="mi">8</span><span class="p">)</span>
<span class="w">    </span><span class="nx">writeBytes</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">mem</span><span class="p">,</span><span class="w"> </span><span class="nx">initialStackPointer</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="nx">initialStackPointer</span><span class="p">)</span>
<span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">regfile</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">rsp</span><span class="p">,</span><span class="w"> </span><span class="nx">initialStackPointer</span><span class="p">)</span>
<span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">loop</span><span class="p">(</span><span class="nx">initialStackPointer</span><span class="p">)</span>
<span class="w">    </span><span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">regfile</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">rax</span><span class="p">)))</span>
<span class="p">}</span>
</pre></div>
<p>We write the initial stack pointer address into the stack so that when
the program final returns, it will return to this address at which
pointer we can exit the program.</p>
<p>And now we're ready to start interpreting instructions.</p>
<h3 id="instruction-decoding">Instruction decoding</h3><p>Using <code>objdump</code> we get a sense for what the program decodes
to.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>objdump<span class="w"> </span>-d<span class="w"> </span>a.out<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-A10<span class="w"> </span><span class="s1">&#39;&lt;main&gt;&#39;</span>
<span class="m">0000000000401106</span><span class="w"> </span>&lt;main&gt;:
<span class="w">  </span><span class="m">401106</span>:<span class="w">       </span><span class="m">55</span><span class="w">                      </span>push<span class="w">   </span>%rbp
<span class="w">  </span><span class="m">401107</span>:<span class="w">       </span><span class="m">48</span><span class="w"> </span><span class="m">89</span><span class="w"> </span>e5<span class="w">                </span>mov<span class="w">    </span>%rsp,%rbp
<span class="w">  </span>40110a:<span class="w">       </span>b8<span class="w"> </span>fe<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">          </span>mov<span class="w">    </span><span class="nv">$0</span>xfe,%eax
<span class="w">  </span>40110f:<span class="w">       </span>5d<span class="w">                      </span>pop<span class="w">    </span>%rbp
<span class="w">  </span><span class="m">401110</span>:<span class="w">       </span>c3<span class="w">                      </span>retq
<span class="w">  </span><span class="m">401111</span>:<span class="w">       </span><span class="m">66</span><span class="w"> </span>2e<span class="w"> </span>0f<span class="w"> </span>1f<span class="w"> </span><span class="m">84</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">    </span>nopw<span class="w">   </span>%cs:0x0<span class="o">(</span>%rax,%rax,1<span class="o">)</span>
<span class="w">  </span><span class="m">401118</span>:<span class="w">       </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span>
<span class="w">  </span>40111b:<span class="w">       </span>0f<span class="w"> </span>1f<span class="w"> </span><span class="m">44</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">          </span>nopl<span class="w">   </span>0x0<span class="o">(</span>%rax,%rax,1<span class="o">)</span>

<span class="m">0000000000401120</span><span class="w"> </span>&lt;__libc_csu_init&gt;:
</pre></div>
<p>We see that <code>0x55</code> means <code>push
%rbp</code>. And we also see that instructions aren't a fixed number
of bytes. Some are one byte, some are seven. Some (not shown) are <a href="https://stackoverflow.com/questions/14698350/x86-64-asm-maximum-bytes-for-an-instruction">even
longer</a>.</p>
<p>Thankfully instructions follow some fairly simple patterns. There are
a set of prefix instructions and a set of real instructions. So far we
should be able to tell on the first byte whether the instruction is a
prefix instruction and, if not, how many bytes the instruction will
take up on the whole.</p>
<h4 id="push">push</h4><p>To support a new instruction, we'll look up <code>0x55</code> in an
opcode table like <a href="http://ref.x86asm.net/coder64.html">this</a>. Clicking
on <a href="http://ref.x86asm.net/coder64.html#x50">55</a> in the opcode index we
see that this is indeed a push instruction. <code>50+r</code> means
that we have to subtract <code>0x50</code> from the opcode to
determine the register we should push.</p>
<p>The register will be <code>0x55 - 0x50 = 5</code> which if we look up
in a <a href="https://wiki.osdev.org/X86-64_Instruction_Encoding#Registers">register
table</a>
is <code>rbp</code>. Since we set up our register enum in code in this
order, we'll be able to just use the constant <code>rbp</code> in Go
code.</p>
<p>Finally, since the next instruction numerically is <code>0x58</code>
we know that this instruction is identified by being between
<code>0x50</code> and <code>0x57</code> inclusive. This is all the
info we need to handle this instruction.</p>
<div class="highlight"><pre><span></span><span class="c1">// helper for dumping byte arrays as hex</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">hbdebug</span><span class="p">(</span><span class="nx">msg</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">bs</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">str</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;%s:&quot;</span>
<span class="w">    </span><span class="nx">args</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="kd">interface</span><span class="p">{}{</span><span class="nx">msg</span><span class="p">}</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">bs</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">str</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">str</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; %x&quot;</span>
<span class="w">        </span><span class="nx">args</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="nx">str</span><span class="o">+</span><span class="s">&quot;\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">cpu</span><span class="p">)</span><span class="w"> </span><span class="nx">loop</span><span class="p">(</span><span class="nx">entryReturnAddress</span><span class="w"> </span><span class="kt">uint64</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">&lt;-</span><span class="nx">c</span><span class="p">.</span><span class="nx">tick</span>

<span class="w">        </span><span class="nx">ip</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">regfile</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">rip</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">ip</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">entryReturnAddress</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">break</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">inb1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">mem</span><span class="p">[</span><span class="nx">ip</span><span class="p">]</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">inb1</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x50</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">inb1</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mh">0x58</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// push</span>
<span class="w">            </span><span class="nx">regvalue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">regfile</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">register</span><span class="p">(</span><span class="nx">inb1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0x50</span><span class="p">))</span>
<span class="w">            </span><span class="nx">sp</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">regfile</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">rsp</span><span class="p">)</span>
<span class="w">            </span><span class="nx">writeBytes</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">mem</span><span class="p">,</span><span class="w"> </span><span class="nx">sp</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="nx">regvalue</span><span class="p">)</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">regfile</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">rsp</span><span class="p">,</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nx">sp</span><span class="o">-</span><span class="mi">8</span><span class="p">))</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">hbdebug</span><span class="p">(</span><span class="s">&quot;prog&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">mem</span><span class="p">[</span><span class="nx">ip</span><span class="p">:</span><span class="nx">ip</span><span class="o">+</span><span class="mi">10</span><span class="p">])</span>
<span class="w">            </span><span class="nb">panic</span><span class="p">(</span><span class="s">&quot;Unknown instruction&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">regfile</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">rip</span><span class="p">,</span><span class="w"> </span><span class="nx">ip</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>If we try this out now we should expect it to panic on the second
byte, <code>0x48</code>.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>go<span class="w"> </span>build<span class="w"> </span>-o<span class="w"> </span>main
$<span class="w"> </span>./main<span class="w"> </span>a.out
prog:<span class="w"> </span><span class="m">48</span><span class="w"> </span><span class="m">89</span><span class="w"> </span>e5<span class="w"> </span>b8<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>5d<span class="w"> </span>c3
panic:<span class="w"> </span>Unknown<span class="w"> </span>instruction

goroutine<span class="w"> </span><span class="m">19</span><span class="w"> </span><span class="o">[</span>running<span class="o">]</span>:
main.<span class="o">(</span>*cpu<span class="o">)</span>.loop<span class="o">(</span>0xc000086c30,<span class="w"> </span>0x2800000<span class="o">)</span>
<span class="w">        </span>/home/phil/tmp/goamd/main.go:168<span class="w"> </span>+0x16d
main.<span class="o">(</span>*cpu<span class="o">)</span>.run<span class="o">(</span>0xc000086c30,<span class="w"> </span>0xc000086c00<span class="o">)</span>
<span class="w">        </span>/home/phil/tmp/goamd/main.go:180<span class="w"> </span>+0xac
created<span class="w"> </span>by<span class="w"> </span>main.main
<span class="w">        </span>/home/phil/tmp/goamd/main.go:211<span class="w"> </span>+0x286
</pre></div>
<p>Looking good.</p>
<h4 id="mov">mov</h4><p>Taking a look at the next two instructions with <code>objdump</code>
we see <code>mov</code> encoded two different ways.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>objdump<span class="w"> </span>-d<span class="w"> </span>a.out<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-A4<span class="w"> </span><span class="s1">&#39;&lt;main&gt;&#39;</span>
<span class="m">0000000000401106</span><span class="w"> </span>&lt;main&gt;:
<span class="w">  </span><span class="m">401106</span>:<span class="w">       </span><span class="m">55</span><span class="w">                      </span>push<span class="w">   </span>%rbp
<span class="w">  </span><span class="m">401107</span>:<span class="w">       </span><span class="m">48</span><span class="w"> </span><span class="m">89</span><span class="w"> </span>e5<span class="w">                </span>mov<span class="w">    </span>%rsp,%rbp
<span class="w">  </span>40110a:<span class="w">       </span>b8<span class="w"> </span>fe<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">          </span>mov<span class="w">    </span><span class="nv">$0</span>xfe,%eax
</pre></div>
<p>Looking up <a href="http://ref.x86asm.net/coder64.html#x48">0x48</a> we see that
this is a prefix instruction that turns on 64-bit mode for the
instruction. Some instructions like <code>pop</code> and
<code>push</code> don't need this prefix to be in 64-bit mode. In any
case, this just means we'll have to have a size flag that switches
from 32-bit to 64-bit mode on seeing this instruction. This flag will
be reset each time we start reading an instruction.</p>
<p>To deal with prefixes in general we'll loop through bytes when
processing an instruction until we no longer see a prefix bytes. As we
see prefix bytes we'll handle them accordingly.</p>
<div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">prefixBytes</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">{</span><span class="mh">0x48</span><span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">cpu</span><span class="p">)</span><span class="w"> </span><span class="nx">loop</span><span class="p">(</span><span class="nx">entryReturnAddress</span><span class="w"> </span><span class="kt">uint64</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">&lt;-</span><span class="nx">c</span><span class="p">.</span><span class="nx">tick</span>

<span class="w">        </span><span class="nx">ip</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">regfile</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">rip</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">ip</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">entryReturnAddress</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">break</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">inb1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">mem</span><span class="p">[</span><span class="nx">ip</span><span class="p">]</span>

<span class="w">        </span><span class="nx">widthPrefix</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">32</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">isPrefixByte</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">prefixByte</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">prefixBytes</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">prefixByte</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">inb1</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">isPrefixByte</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">                    </span><span class="k">break</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">isPrefixByte</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">break</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// 64 bit prefix signifier</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">inb1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x48</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">widthPrefix</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">64</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">hbdebug</span><span class="p">(</span><span class="s">&quot;prog&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">mem</span><span class="p">[</span><span class="nx">ip</span><span class="p">:</span><span class="nx">ip</span><span class="o">+</span><span class="mi">10</span><span class="p">])</span>
<span class="w">                </span><span class="nb">panic</span><span class="p">(</span><span class="s">&quot;Unknown prefix instruction&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="nx">ip</span><span class="o">++</span>
<span class="w">            </span><span class="nx">inb1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">mem</span><span class="p">[</span><span class="nx">ip</span><span class="p">]</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">inb1</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x50</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">inb1</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mh">0x58</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// push</span>

<span class="o">...</span>
</pre></div>
<p>Moving past this prefix we get to
<a href="http://ref.x86asm.net/coder64.html#x89">0x89</a>. This instruction is
for copying one register into another. The register operands are
<a href="http://www.c-jump.com/CIS77/CPU/x86/X77_0270_modrm_byte.htm">encoded in the second
byte</a>,
<code>0xe5</code>, called the ModR/M byte. Pulling out the two
registers is just a matter of shifting and bitmasking the right 3 bits
for each.</p>
<p>With this knowledge we can expand the instruction handling code.</p>
<div class="highlight"><pre><span></span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">inb1</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x50</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">inb1</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mh">0x58</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// push</span>
<span class="w">            </span><span class="nx">regvalue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">regfile</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">register</span><span class="p">(</span><span class="nx">inb1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0x50</span><span class="p">))</span>
<span class="w">            </span><span class="nx">sp</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">regfile</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">rsp</span><span class="p">)</span>
<span class="w">            </span><span class="nx">writeBytes</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">mem</span><span class="p">,</span><span class="w"> </span><span class="nx">sp</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="nx">regvalue</span><span class="p">)</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">regfile</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">rsp</span><span class="p">,</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nx">sp</span><span class="o">-</span><span class="mi">8</span><span class="p">))</span>
<span class="w">        </span><span class="p">}</span><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">inb1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x89</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// mov r/m16/32/64, r/m16/32/64</span>
<span class="w">            </span><span class="nx">ip</span><span class="o">++</span>
<span class="w">            </span><span class="nx">inb2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">mem</span><span class="p">[</span><span class="nx">ip</span><span class="p">]</span>
<span class="w">            </span><span class="nx">rhs</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">register</span><span class="p">((</span><span class="nx">inb2</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">0</span><span class="nx">b00111000</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span>
<span class="w">            </span><span class="nx">lhs</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">register</span><span class="p">(</span><span class="nx">inb2</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">0</span><span class="nx">b111</span><span class="p">)</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">regfile</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">lhs</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">regfile</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">rhs</span><span class="p">))</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">hbdebug</span><span class="p">(</span><span class="s">&quot;prog&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">mem</span><span class="p">[</span><span class="nx">ip</span><span class="p">:</span><span class="nx">ip</span><span class="o">+</span><span class="mi">10</span><span class="p">])</span>
<span class="w">            </span><span class="nb">panic</span><span class="p">(</span><span class="s">&quot;Unknown instruction&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
</pre></div>
<p>Try emulating <code>a.out</code> again now. It will panic on the next
unknown instruction, <code>0xb8</code>. From <code>objdump</code>
disassembly we see this is another <code>mov</code> instruction.</p>
<p>Hurray! There are apparently multiple ways the same instruction can be
encoded. Looking it up in the opcode table, we see
<a href="http://ref.x86asm.net/coder64.html#xB8">0xB8</a> is for when the value
to be copied is a literal number. The operand will be 32-bits, or four
bytes, presumably because it doesn't have the <code>0x48</code>
prefix.</p>
<div class="highlight"><pre><span></span><span class="c1">// helper for converting up to 8 bytes into a single integer</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">readBytes</span><span class="p">(</span><span class="nx">from</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="kt">uint64</span><span class="p">,</span><span class="w"> </span><span class="nx">bytes</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="kt">uint64</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">val</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">bytes</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">val</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nx">from</span><span class="p">[</span><span class="nx">start</span><span class="o">+</span><span class="nb">uint64</span><span class="p">(</span><span class="nx">i</span><span class="p">)])</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">i</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">val</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">cpu</span><span class="p">)</span><span class="w"> </span><span class="nx">loop</span><span class="p">(</span><span class="nx">entryReturnAddress</span><span class="w"> </span><span class="kt">uint64</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="o">...</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="o">...</span>

<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">inb1</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0xB8</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">inb1</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mh">0xC0</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// mov r16/32/64, imm16/32/64</span>
<span class="w">            </span><span class="nx">lreg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">register</span><span class="p">(</span><span class="nx">inb1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0xB8</span><span class="p">)</span>
<span class="w">            </span><span class="nx">val</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">readBytes</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">mem</span><span class="p">,</span><span class="w"> </span><span class="nx">ip</span><span class="o">+</span><span class="nb">uint64</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="nx">widthPrefix</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span>
<span class="w">            </span><span class="nx">ip</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nx">widthPrefix</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">regfile</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">lreg</span><span class="p">,</span><span class="w"> </span><span class="nx">val</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="o">...</span>
</pre></div>
<p>Two more instructions to go: <code>pop</code> and <code>ret</code>.</p>
<h3 id="a-terminal-debugger">A terminal debugger</h3><p>Taking a break for a moment, our system is already too complex to
understand. It would be helpful to have a REPL so we can step through
instructions and print register and memory values.</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">cpu</span><span class="p">)</span><span class="w"> </span><span class="nx">resolveDebuggerValue</span><span class="p">(</span><span class="nx">dval</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">uint64</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">reg</span><span class="p">,</span><span class="w"> </span><span class="nx">val</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">registerMap</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">val</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">dval</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">regfile</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">reg</span><span class="p">),</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">dval</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">dval</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;0x&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">dval</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;0X&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">strconv</span><span class="p">.</span><span class="nx">ParseUint</span><span class="p">(</span><span class="nx">dval</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">strconv</span><span class="p">.</span><span class="nx">ParseUint</span><span class="p">(</span><span class="nx">dval</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">repl</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">cpu</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;go-amd64-emulator REPL&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nx">help</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">`commands:</span>
<span class="s">    s/step:             continue to next instruction</span>
<span class="s">    r/registers [$reg]:     print all register values or just $reg</span>
<span class="s">    d/decimal:          toggle hex/decimal printing</span>
<span class="s">    m/memory $from $count:      print memory values starting at $from until $from+$count</span>
<span class="s">    h/help:             print this`</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">help</span><span class="p">)</span>
<span class="w">    </span><span class="nx">scanner</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">bufio</span><span class="p">.</span><span class="nx">NewScanner</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">)</span>

<span class="w">    </span><span class="nx">intFormat</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;%d&quot;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;&gt; &quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">scanner</span><span class="p">.</span><span class="nx">Scan</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">break</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nx">input</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">scanner</span><span class="p">.</span><span class="nx">Text</span><span class="p">()</span>
<span class="w">        </span><span class="nx">parts</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">Split</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">)</span>

<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;h&quot;</span><span class="p">:</span>
<span class="w">            </span><span class="k">fallthrough</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;help&quot;</span><span class="p">:</span>
<span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">help</span><span class="p">)</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;m&quot;</span><span class="p">:</span>
<span class="w">            </span><span class="k">fallthrough</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;memory&quot;</span><span class="p">:</span>
<span class="w">            </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;Invalid arguments: m/memory $from $to; use hex (0x10), decimal (10), or register name (rsp)&quot;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">parts</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
<span class="w">                </span><span class="k">continue</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="nx">from</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">resolveDebuggerValue</span><span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
<span class="w">                </span><span class="k">continue</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="nx">to</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">resolveDebuggerValue</span><span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
<span class="w">                </span><span class="k">continue</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="nx">hbdebug</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;memory[&quot;</span><span class="o">+</span><span class="nx">intFormat</span><span class="o">+</span><span class="s">&quot;:&quot;</span><span class="o">+</span><span class="nx">intFormat</span><span class="o">+</span><span class="s">&quot;]&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">from</span><span class="p">,</span><span class="w"> </span><span class="nx">from</span><span class="o">+</span><span class="nx">to</span><span class="p">),</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">mem</span><span class="p">[</span><span class="nx">from</span><span class="p">:</span><span class="nx">from</span><span class="o">+</span><span class="nx">to</span><span class="p">])</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;d&quot;</span><span class="p">:</span>
<span class="w">            </span><span class="k">fallthrough</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;decimal&quot;</span><span class="p">:</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">intFormat</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;%d&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">intFormat</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;0x%x&quot;</span>
<span class="w">                </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Numbers displayed as hex&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">intFormat</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;%d&quot;</span>
<span class="w">                </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Numbers displayed as decimal&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">:</span>
<span class="w">            </span><span class="k">fallthrough</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;registers&quot;</span><span class="p">:</span>
<span class="w">            </span><span class="nx">filter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">parts</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">filter</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">registerMap</span><span class="p">);</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">reg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">register</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
<span class="w">                </span><span class="nx">name</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">registerMap</span><span class="p">[</span><span class="nx">reg</span><span class="p">]</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">filter</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">filter</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">continue</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%s:\t&quot;</span><span class="o">+</span><span class="nx">intFormat</span><span class="o">+</span><span class="s">&quot;\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">regfile</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">reg</span><span class="p">))</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;s&quot;</span><span class="p">:</span>
<span class="w">            </span><span class="k">fallthrough</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;step&quot;</span><span class="p">:</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">tick</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">true</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Let's try it out:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>go<span class="w"> </span>build<span class="w"> </span>-o<span class="w"> </span>main
$<span class="w"> </span>./main<span class="w"> </span>a.out<span class="w"> </span>--debug
go-amd64-emulator<span class="w"> </span>REPL
commands:
<span class="w">        </span>s/step:<span class="w">                         </span><span class="k">continue</span><span class="w"> </span>to<span class="w"> </span>next<span class="w"> </span>instruction
<span class="w">        </span>r/registers<span class="w"> </span><span class="o">[</span><span class="nv">$reg</span><span class="o">]</span>:<span class="w">             </span>print<span class="w"> </span>all<span class="w"> </span>register<span class="w"> </span>values<span class="w"> </span>or<span class="w"> </span>just<span class="w"> </span><span class="nv">$reg</span>
<span class="w">        </span>d/decimal:<span class="w">                      </span>toggle<span class="w"> </span>hex/decimal<span class="w"> </span>printing
<span class="w">        </span>m/memory<span class="w"> </span><span class="nv">$from</span><span class="w"> </span><span class="nv">$count</span>:<span class="w">          </span>print<span class="w"> </span>memory<span class="w"> </span>values<span class="w"> </span>starting<span class="w"> </span>at<span class="w"> </span><span class="nv">$from</span><span class="w"> </span><span class="k">until</span><span class="w"> </span><span class="nv">$from</span>+<span class="nv">$count</span>
<span class="w">        </span>h/help:<span class="w">                         </span>print<span class="w"> </span>this
&gt;<span class="w"> </span>r
rax:<span class="w">    </span><span class="m">0</span>
rcx:<span class="w">    </span><span class="m">0</span>
rdx:<span class="w">    </span><span class="m">0</span>
rbx:<span class="w">    </span><span class="m">0</span>
rsp:<span class="w">    </span><span class="m">41943040</span>
rbp:<span class="w">    </span><span class="m">0</span>
rsi:<span class="w">    </span><span class="m">0</span>
rdi:<span class="w">    </span><span class="m">0</span>
r8:<span class="w">     </span><span class="m">0</span>
r9:<span class="w">     </span><span class="m">0</span>
r10:<span class="w">    </span><span class="m">0</span>
r11:<span class="w">    </span><span class="m">0</span>
r12:<span class="w">    </span><span class="m">0</span>
r13:<span class="w">    </span><span class="m">0</span>
r14:<span class="w">    </span><span class="m">0</span>
r15:<span class="w">    </span><span class="m">0</span>
rip:<span class="w">    </span><span class="m">4198662</span>
rflags:<span class="w"> </span><span class="m">0</span>
&gt;<span class="w"> </span>m<span class="w"> </span>rip<span class="w"> </span><span class="m">10</span>
memory<span class="o">[</span><span class="m">4198662</span>:4198672<span class="o">]</span>:<span class="w"> </span><span class="m">55</span><span class="w"> </span><span class="m">48</span><span class="w"> </span><span class="m">89</span><span class="w"> </span>e5<span class="w"> </span>b8<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>5d
&gt;<span class="w"> </span>s
&gt;<span class="w"> </span>m<span class="w"> </span>rip<span class="w"> </span><span class="m">10</span>
memory<span class="o">[</span><span class="m">4198663</span>:4198673<span class="o">]</span>:<span class="w"> </span><span class="m">48</span><span class="w"> </span><span class="m">89</span><span class="w"> </span>e5<span class="w"> </span>b8<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>5d<span class="w"> </span>c3
&gt;<span class="w"> </span>r
rax:<span class="w">    </span><span class="m">0</span>
rcx:<span class="w">    </span><span class="m">0</span>
rdx:<span class="w">    </span><span class="m">0</span>
rbx:<span class="w">    </span><span class="m">0</span>
rsp:<span class="w">    </span><span class="m">41943032</span>
rbp:<span class="w">    </span><span class="m">0</span>
rsi:<span class="w">    </span><span class="m">0</span>
rdi:<span class="w">    </span><span class="m">0</span>
r8:<span class="w">     </span><span class="m">0</span>
r9:<span class="w">     </span><span class="m">0</span>
r10:<span class="w">    </span><span class="m">0</span>
r11:<span class="w">    </span><span class="m">0</span>
r12:<span class="w">    </span><span class="m">0</span>
r13:<span class="w">    </span><span class="m">0</span>
r14:<span class="w">    </span><span class="m">0</span>
r15:<span class="w">    </span><span class="m">0</span>
rip:<span class="w">    </span><span class="m">4198663</span>
rflags:<span class="w"> </span><span class="m">0</span>
&gt;<span class="w"> </span>^D
</pre></div>
<p>Now we can inspect the system interactively.</p>
<h3 id="pop">pop</h3><p>Reemersing in the state of things, we now panic on <code>0x5D</code>.</p>
<div class="highlight"><pre><span></span>./main<span class="w"> </span>a.out
prog:<span class="w"> </span>5d<span class="w"> </span>c3<span class="w"> </span><span class="m">66</span><span class="w"> </span>2e<span class="w"> </span>f<span class="w"> </span>1f<span class="w"> </span><span class="m">84</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span>
panic:<span class="w"> </span>Unknown<span class="w"> </span>instruction

goroutine<span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="o">[</span>running<span class="o">]</span>:
main.<span class="o">(</span>*cpu<span class="o">)</span>.loop<span class="o">(</span>0xc000098ae0,<span class="w"> </span>0x2800000<span class="o">)</span>
<span class="w">        </span>/home/phil/tmp/goamd/main.go:219<span class="w"> </span>+0x2c5
main.<span class="o">(</span>*cpu<span class="o">)</span>.run<span class="o">(</span>0xc000098ae0,<span class="w"> </span>0xc000098ab0<span class="o">)</span>
<span class="w">        </span>/home/phil/tmp/goamd/main.go:231<span class="w"> </span>+0xac
created<span class="w"> </span>by<span class="w"> </span>main.main
<span class="w">        </span>/home/phil/tmp/goamd/main.go:358<span class="w"> </span>+0x286
</pre></div>
<p>Looking <a href="http://ref.x86asm.net/coder64.html#x5D">this up</a> we see this
is part of <code>58+r</code>, <code>pop</code>. Similar to
<code>push</code> we subtract <code>0x58</code> from the byte to get
the register to pop onto. The stack operation is the reverse of
<code>push</code>.</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">cpu</span><span class="p">)</span><span class="w"> </span><span class="nx">loop</span><span class="p">(</span><span class="nx">entryReturnAddress</span><span class="w"> </span><span class="kt">uint64</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="o">...</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="o">...</span>

<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">inb1</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x58</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">inb1</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mh">0x60</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// pop</span>
<span class="w">            </span><span class="nx">lhs</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">register</span><span class="p">(</span><span class="nx">inb1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0x58</span><span class="p">)</span>
<span class="w">            </span><span class="nx">sp</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">regfile</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">rsp</span><span class="p">)</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">regfile</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">lhs</span><span class="p">,</span><span class="w"> </span><span class="nx">readBytes</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">mem</span><span class="p">,</span><span class="w"> </span><span class="nx">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">))</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">regfile</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">rsp</span><span class="p">,</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nx">sp</span><span class="o">+</span><span class="mi">8</span><span class="p">))</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="o">...</span>
</pre></div>
<p>Build and run for the final panic:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>go<span class="w"> </span>build<span class="w"> </span>-o<span class="w"> </span>main
$<span class="w"> </span>./main<span class="w"> </span>a.out
prog:<span class="w"> </span>c3<span class="w"> </span><span class="m">66</span><span class="w"> </span>2e<span class="w"> </span>f<span class="w"> </span>1f<span class="w"> </span><span class="m">84</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span>
panic:<span class="w"> </span>Unknown<span class="w"> </span>instruction

goroutine<span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="o">[</span>running<span class="o">]</span>:
main.<span class="o">(</span>*cpu<span class="o">)</span>.loop<span class="o">(</span>0xc000060c30,<span class="w"> </span>0x2800000<span class="o">)</span>
<span class="w">        </span>/home/phil/tmp/goamd/main.go:224<span class="w"> </span>+0x345
main.<span class="o">(</span>*cpu<span class="o">)</span>.run<span class="o">(</span>0xc000060c30,<span class="w"> </span>0xc000060c00<span class="o">)</span>
<span class="w">        </span>/home/phil/tmp/goamd/main.go:236<span class="w"> </span>+0xac
created<span class="w"> </span>by<span class="w"> </span>main.main
<span class="w">        </span>/home/phil/tmp/goamd/main.go:363<span class="w"> </span>+0x286
</pre></div>
<h3 id="ret">ret</h3><p>Looking up <a href="http://ref.x86asm.net/coder64.html#xC3">0xC3</a> we see that
it is indeed <code>ret</code>. This function's responsibilty is to pop
the stack onto rip, jumping back to caller.</p>
<div class="highlight"><pre><span></span><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">inb1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0xC3</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// ret</span>
<span class="w">            </span><span class="nx">sp</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">regfile</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">rsp</span><span class="p">)</span>
<span class="w">            </span><span class="nx">retAddress</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">readBytes</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">mem</span><span class="p">,</span><span class="w"> </span><span class="nx">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">regfile</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">rsp</span><span class="p">,</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nx">sp</span><span class="o">+</span><span class="mi">8</span><span class="p">))</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">regfile</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">rip</span><span class="p">,</span><span class="w"> </span><span class="nx">retAddress</span><span class="p">)</span>
<span class="w">            </span><span class="k">continue</span>
<span class="w">        </span><span class="p">}</span>
</pre></div>
<p>Build and run:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>go<span class="w"> </span>build<span class="w"> </span>-o<span class="w"> </span>main
$<span class="w"> </span>./main<span class="w"> </span>a.out
$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$?</span>
<span class="m">4</span>
</pre></div>
<p>If we modify <code>tests/simple.c</code>?</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>cat<span class="w"> </span>tests/simple.c
int<span class="w"> </span>main<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="m">254</span><span class="p">;</span>
<span class="o">}</span>
$<span class="w"> </span>gcc<span class="w"> </span>tests/simple.c
$<span class="w"> </span>./main<span class="w"> </span>a.out<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$?</span>
<span class="m">254</span>
</pre></div>
<p>Not bad!</p>
<h3 id="process-and-next-steps">Process and next steps</h3><p>Getting this far took a lot of trial and error, much of it hidden in
this post. Setting up the REPL was critical to debugging mistakes. But
aggressively unit testing would probably have been similarly
fruitful. In the end, the most bug-prone aspects are basic arithmetic
(off by one errors and converting bytes to/from integers). The part
that's not terribly hard is actually interpreting instructions! But
it's made easier by greatly simplifying the problem and ignoring
legion cases.</p>
<p>Along the way it would have been helpful to also disassemble so that
instead of just dumping memory at the instruction pointer we print the
instructions we thought we were going to process. That may be a next
goal.</p>
<p>Otherwise the typical goals are around getting syscall support,
function call support, and porting these simple examples to Windows
and macOS for the experience.</p>
<p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">Here&#39;s take two on writing an emulator for linux/amd64 in Go.  This time we&#39;re starting with ELF binaries, but still ignoring libc and jumping straight to main.<a href="https://t.co/A87r2RY21c">https://t.co/A87r2RY21c</a></p>&mdash; Phil Eaton (@phil_eaton) <a href="https://twitter.com/phil_eaton/status/1332111601814691840?ref_src=twsrc%5Etfw">November 26, 2020</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<style>.feedback{display:initial;}</style>
	<div class="feedback">
	  <h4>Feedback</h4>
	  <p>As always,
	      please <a href="mailto:phil@eatonphil.com">email</a>
	      or <a href="https://twitter.com/eatonphil">tweet me</a>
	      with questions, corrections, or ideas!</p>

	</div>
      </div>
    </div>
    <footer>
      <div class="container">
	<div>
	  <div class="row">
	    <div class="feedback">
	      <h4>Frequent Topics</h4>
	      <div class="tags"><a href="/tags/javascript.html" class="tag">javascript (24)</a><a href="/tags/go.html" class="tag">go (24)</a><a href="/tags/databases.html" class="tag">databases (24)</a><a href="/tags/parsing.html" class="tag">parsing (21)</a><a href="/tags/postgres.html" class="tag">postgres (18)</a><a href="/tags/compilers.html" class="tag">compilers (14)</a><a href="/tags/sql.html" class="tag">sql (11)</a><a href="/tags/interpreters.html" class="tag">interpreters (11)</a><a href="/tags/zig.html" class="tag">zig (9)</a><a href="/tags/lisp.html" class="tag">lisp (9)</a><a href="/tags/books.html" class="tag">books (9)</a><a href="/tags/python.html" class="tag">python (8)</a><a href="/tags/linux.html" class="tag">linux (7)</a><a href="/tags/learning.html" class="tag">learning (7)</a><a href="/tags/json.html" class="tag">json (7)</a><a href="/tags/x86-amd64.html" class="tag">x86/amd64 (6)</a><a href="/tags/scheme.html" class="tag">scheme (6)</a><a href="/tags/c.html" class="tag">c (6)</a><a href="/tags/typescript.html" class="tag">typescript (5)</a><a href="/tags/mysql.html" class="tag">mysql (5)</a></div>
	    </div>
	  </div>
	  <div class="row" id="subscribe">
	    <style type="text/css">
  /* LOADER */
  .ml-form-embedSubmitLoad {
      display: inline-block;
      width: 20px;
      height: 20px;
  }
  .g-recaptcha {
      transform: scale(1);
      -webkit-transform: scale(1);
      transform-origin: 0 0;
      -webkit-transform-origin: 0 0;
      height: ;
  }
  .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      border: 0;
  }
  .ml-form-embedSubmitLoad:after {
      content: " ";
      display: block;
      width: 11px;
      height: 11px;
      margin: 1px;
      border-radius: 50%;
      border: 4px solid #fff;
      border-color: #ffffff #ffffff #ffffff transparent;
      animation: ml-form-embedSubmitLoad 1.2s linear infinite;
  }
  @keyframes ml-form-embedSubmitLoad {
      0% {
          transform: rotate(0deg);
      }
      100% {
          transform: rotate(360deg);
      }
  }
  #mlb2-3175296.ml-form-embedContainer {
      box-sizing: border-box;
      display: table;
      margin: 0 auto;
      position: static;
      width: 100% !important;
  }
  #mlb2-3175296.ml-form-embedContainer h3,
  #mlb2-3175296.ml-form-embedContainer p,
  #mlb2-3175296.ml-form-embedContainer span,
  #mlb2-3175296.ml-form-embedContainer button {
      text-transform: none !important;
      letter-spacing: normal !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper {
      border-width: 0px;
      border-color: transparent;
  border-radius: 4px;
  border-style: solid;
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  position: relative;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-align-left { text-align: left; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-align-center {
  text-align: center;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-align-default { display: table-cell !important; vertical-align: middle !important; text-align: center !important; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-align-right { text-align: right; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedHeader img {
  border-top-left-radius: 4px;
  border-top-right-radius: 4px;
  height: auto;
  margin: 0 auto !important;
  max-width: 100%;
  width: undefinedpx;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody.ml-form-embedBodyHorizontal {
  padding-bottom: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent {
  text-align: left;
  margin: 0 0 20px 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent p,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent p {
  color: #000000;
  font-size: 14px;
  font-weight: 400;
  line-height: 20px;
  margin: 0 0 10px 0;
  text-align: left;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent ul,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent ol,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent ul,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent ol {
  color: #000000;
  font-size: 14px;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent ol ol,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent ol ol {
  list-style-type: lower-alpha;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent ol ol ol,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent ol ol ol {
  list-style-type: lower-roman;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent p a,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent p a {
  color: #000000;
  text-decoration: underline;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-block-form .ml-field-group {
  text-align: left!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-block-form .ml-field-group label {
  margin-bottom: 5px;
  color: #333333;
  font-size: 14px;
  font-weight: bold; font-style: normal; text-decoration: none;;
  display: inline-block;
  line-height: 20px;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent p:last-child,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent p:last-child {
  margin: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody form {
  margin: 0;
  width: 100%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-formContent,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow {
  margin: 0 0 20px 0;
  width: 100%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow {
  float: left;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-formContent.horozintalForm {
  margin: 0;
  padding: 0 0 20px 0;
  width: 100%;
  height: auto;
  float: left;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow {
  margin: 0 0 10px 0;
  width: 100%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow.ml-last-item {
  margin: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow.ml-formfieldHorizintal {
  margin: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input {
  background-color: #ffffff !important;
  color: #333333 !important;
  border-color: #cccccc;
  border-radius: 4px !important;
  border-style: solid !important;
  border-width: 1px !important;
  font-size: 14px !important;
  height: auto;
  line-height: 21px !important;
  margin-bottom: 0;
  margin-top: 0;
  margin-left: 0;
  margin-right: 0;
  padding: 10px 10px !important;
  width: 100% !important;
  box-sizing: border-box !important;
  max-width: 100% !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input::-webkit-input-placeholder,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input::-webkit-input-placeholder { color: #333333; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input::-moz-placeholder,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input::-moz-placeholder { color: #333333; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input:-ms-input-placeholder,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input:-ms-input-placeholder { color: #333333; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input:-moz-placeholder,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input:-moz-placeholder { color: #333333; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow textarea, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow textarea {
  background-color: #ffffff !important;
  color: #333333 !important;
  border-color: #cccccc;
  border-radius: 4px !important;
  border-style: solid !important;
  border-width: 1px !important;
  font-size: 14px !important;
  height: auto;
  line-height: 21px !important;
  margin-bottom: 0;
  margin-top: 0;
  padding: 10px 10px !important;
  width: 100% !important;
  box-sizing: border-box !important;
  max-width: 100% !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before {
  border-color: #cccccc!important;
  background-color: #ffffff!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input.custom-control-input[type="checkbox"]{
  box-sizing: border-box;
  padding: 0;
  position: absolute;
  z-index: -1;
  opacity: 0;
  margin-top: 5px;
  margin-left: -1.5rem;
  overflow: visible;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before {
  border-radius: 4px!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow input[type=checkbox]:checked~.label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox input[type=checkbox]:checked~.label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-input:checked~.custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-input:checked~.custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox input[type=checkbox]:checked~.label-description::after {
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23fff' d='M6.564.75l-3.59 3.612-1.538-1.55L0 4.26 2.974 7.25 8 2.193z'/%3e%3c/svg%3e");
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-input:checked~.custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-input:checked~.custom-control-label::after {
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e");
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-input:checked~.custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-input:checked~.custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-input:checked~.custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-input:checked~.custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox input[type=checkbox]:checked~.label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox input[type=checkbox]:checked~.label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow input[type=checkbox]:checked~.label-description::before  {
  border-color: #000000!important;
  background-color: #000000!important;
  color: #ffffff!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label::after {
  top: 2px;
  box-sizing: border-box;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::after {
  top: 0px!important;
  box-sizing: border-box!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::after {
  top: 0px!important;
  box-sizing: border-box!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::after {
  top: 0px!important;
  box-sizing: border-box!important;
  position: absolute;
  left: -1.5rem;
  display: block;
  width: 1rem;
  height: 1rem;
  content: "";
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::before {
  top: 0px!important;
  box-sizing: border-box!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .custom-control-label::before {
  position: absolute;
  top: 4px;
  left: -1.5rem;
  display: block;
  width: 16px;
  height: 16px;
  pointer-events: none;
  content: "";
  background-color: #ffffff;
  border: #adb5bd solid 1px;
  border-radius: 50%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .custom-control-label::after {
  position: absolute;
  top: 2px!important;
  left: -1.5rem;
  display: block;
  width: 1rem;
  height: 1rem;
  content: "";
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before {
  position: absolute;
  top: 4px;
  left: -1.5rem;
  display: block;
  width: 16px;
  height: 16px;
  pointer-events: none;
  content: "";
  background-color: #ffffff;
  border: #adb5bd solid 1px;
  border-radius: 50%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::after {
  position: absolute;
  top: 0px!important;
  left: -1.5rem;
  display: block;
  width: 1rem;
  height: 1rem;
  content: "";
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::after {
  position: absolute;
  top: 0px!important;
  left: -1.5rem;
  display: block;
  width: 1rem;
  height: 1rem;
  content: "";
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .custom-radio .custom-control-label::after {
  background: no-repeat 50%/50% 50%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .custom-checkbox .custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::after {
  background: no-repeat 50%/50% 50%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-control, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-control {
  position: relative;
  display: block;
  min-height: 1.5rem;
  padding-left: 1.5rem;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-input, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-input, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-input, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-input {
  position: absolute;
  z-index: -1;
  opacity: 0;
  box-sizing: border-box;
  padding: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-label, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-label, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label {
  color: #000000;
  font-size: 12px!important;
  line-height: 22px;
  margin-bottom: 0;
  position: relative;
  vertical-align: top;
  font-style: normal;
  font-weight: 700;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-select, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-select {
  background-color: #ffffff !important;
  color: #333333 !important;
  border-color: #cccccc;
  border-radius: 4px !important;
  border-style: solid !important;
  border-width: 1px !important;
  font-size: 14px !important;
  line-height: 20px !important;
  margin-bottom: 0;
  margin-top: 0;
  padding: 10px 28px 10px 12px !important;
  width: 100% !important;
  box-sizing: border-box !important;
  max-width: 100% !important;
  height: auto;
  display: inline-block;
  vertical-align: middle;
  background: url('https://assets.mlcdn.com/ml/images/default/dropdown.svg') no-repeat right .75rem center/8px 10px;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow {
  height: auto;
  width: 100%;
  float: left;
  }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-input-horizontal { width: 70%; float: left; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-button-horizontal { width: 30%; float: left; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-button-horizontal.labelsOn { padding-top: 25px;  }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .horizontal-fields { box-sizing: border-box; float: left; padding-right: 10px;  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input {
  background-color: #ffffff;
  color: #333333;
  border-color: #cccccc;
  border-radius: 4px;
  border-style: solid;
  border-width: 1px;
  font-size: 14px;
  line-height: 20px;
  margin-bottom: 0;
  margin-top: 0;
  padding: 10px 10px;
  width: 100%;
  box-sizing: border-box;
  overflow-y: initial;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow button {
  background-color: #000000 !important;
  border-color: #000000;
  border-style: solid;
  border-width: 1px;
  border-radius: 4px;
  box-shadow: none;
  color: #ffffff !important;
  cursor: pointer;
  font-size: 14px !important;
  font-weight: 700;
  line-height: 20px;
  margin: 0 !important;
  padding: 10px !important;
  width: 100%;
  height: auto;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow button:hover {
  background-color: #333333 !important;
  border-color: #333333 !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow input[type="checkbox"] {
  box-sizing: border-box;
  padding: 0;
  position: absolute;
  z-index: -1;
  opacity: 0;
  margin-top: 5px;
  margin-left: -1.5rem;
  overflow: visible;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description {
  color: #000000;
  display: block;
  font-size: 12px;
  text-align: left;
  margin-bottom: 0;
  position: relative;
  vertical-align: top;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow label {
  font-weight: normal;
  margin: 0;
  padding: 0;
  position: relative;
  display: block;
  min-height: 24px;
  padding-left: 24px;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow label a {
  color: #000000;
  text-decoration: underline;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow label p {
  color: #000000 !important;
  font-size: 12px !important;
  font-weight: normal !important;
  line-height: 18px !important;
  padding: 0 !important;
  margin: 0 5px 0 0 !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow label p:last-child {
  margin: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedSubmit {
  margin: 0 0 20px 0;
  float: left;
  width: 100%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedSubmit button {
  background-color: #000000 !important;
  border: none !important;
  border-radius: 4px !important;
  box-shadow: none !important;
  color: #ffffff !important;
  cursor: pointer;
  font-size: 14px !important;
  font-weight: 700 !important;
  line-height: 21px !important;
  height: auto;
  padding: 10px !important;
  width: 100% !important;
  box-sizing: border-box !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedSubmit button.loading {
  display: none;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedSubmit button:hover {
  background-color: #333333 !important;
  }
  .ml-subscribe-close {
  width: 30px;
  height: 30px;
  background: url('https://assets.mlcdn.com/ml/images/default/modal_close.png') no-repeat;
  background-size: 30px;
  cursor: pointer;
  margin-top: -10px;
  margin-right: -10px;
  position: absolute;
  top: 0;
  right: 0;
  }
  .ml-error input, .ml-error textarea, .ml-error select {
  border-color: red!important;
  }
  .ml-error .custom-checkbox-radio-list {
  border: 1px solid red !important;
  border-radius: 4px;
  padding: 10px;
  }
  .ml-error .label-description,
  .ml-error .label-description p,
  .ml-error .label-description p a,
  .ml-error label:first-child {
  color: #ff0000 !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow.ml-error .label-description p,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow.ml-error .label-description p:first-letter {
  color: #ff0000 !important;
  }
  @media only screen and (max-width: 400px){
  .ml-form-embedWrapper.embedDefault, .ml-form-embedWrapper.embedPopup { width: 100%!important; }
  .ml-form-formContent.horozintalForm { float: left!important; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow { height: auto!important; width: 100%!important; float: left!important; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-input-horizontal { width: 100%!important; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-input-horizontal > div { padding-right: 0px!important; padding-bottom: 10px; }
    .ml-form-formContent.horozintalForm .ml-button-horizontal { width: 100%!important; }
    .ml-form-formContent.horozintalForm .ml-button-horizontal.labelsOn { padding-top: 0px!important; }
    }
</style>
<div id="mlb2-3175296" class="ml-form-embedContainer ml-subscribe-form ml-subscribe-form-3175296">
  <hr />
  <div class="ml-form-align-center ">
    <div class="ml-form-embedWrapper embedForm">
      <div class="ml-form-embedBody ml-form-embedBodyDefault row-form">
        <div class="ml-form-embedContent" style=" ">
          <h4>Subscribe</h4>
          <p>Enter your email if you'd like to be kept in the loop about future articles!<br><br>You can expect 2 to 4 messages per month depending on how motivated I'm feeling. :)</p>
	  <p></p>
	  <p>Cheers,<br>Phil</p>
        </div>
        <form class="ml-block-form" action="https://assets.mailerlite.com/jsonp/303114/forms/78235486326359572/subscribe" data-code="" method="post" target="_blank">
          <div class="ml-form-formContent">
            <div class="ml-form-fieldRow ml-last-item">
              <div class="ml-field-group ml-field-email ml-validate-email ml-validate-required">
                <!-- input -->
                <input aria-label="email" aria-required="true" type="email" class="form-control" data-inputmask="" name="fields[email]" placeholder="Email" autocomplete="email">
                <!-- /input -->
                <!-- textarea -->
                <!-- /textarea -->
                <!-- select -->
                <!-- /select -->
                <!-- checkboxes -->
		<!-- /checkboxes -->
                <!-- radio -->
                <!-- /radio -->
                <!-- countries -->
                <!-- /countries -->
              </div>
            </div>
          </div>
          <!-- Privacy policy -->
          <!-- /Privacy policy -->
	  <div class="ml-form-recaptcha ml-validate-required" style="float: left;">
            <style type="text/css">
	      .ml-form-recaptcha {
		  margin-bottom: 20px;
	      }
	      .ml-form-recaptcha.ml-error iframe {
		  border: solid 1px #ff0000;
	      }
	      @media screen and (max-width: 480px) {
		  .ml-form-recaptcha {
		      width: 220px!important
		  }
		  .g-recaptcha {
		      transform: scale(0.78);
		      -webkit-transform: scale(0.78);
		      transform-origin: 0 0;
		      -webkit-transform-origin: 0 0;
		  }
	      }
	    </style>
	    <script src="https://www.google.com/recaptcha/api.js"></script>
	    <div class="g-recaptcha" data-sitekey="6Lf1KHQUAAAAAFNKEX1hdSWCS3mRMv4FlFaNslaD"></div>
	  </div>
          <input type="hidden" name="ml-submit" value="1">
          <div class="ml-form-embedSubmit">
            <button type="submit" class="primary">Subscribe</button>
            <button disabled="disabled" style="display: none;" type="button" class="loading">
              <div class="ml-form-embedSubmitLoad"></div>
              <span class="sr-only">Loading...</span>
            </button>
          </div>
          <input type="hidden" name="anticsrf" value="true">
        </form>
      </div>
      <div class="ml-form-successBody row-success" style="display: none">
        <div class="ml-form-successContent">
          <h3>Thanks :)</h3>
          <p>You're in.</p>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  function ml_webform_success_3175296() {
      var $ = ml_jQuery || jQuery;
      $('.ml-subscribe-form-3175296 .row-success').show();
      $('.ml-subscribe-form-3175296 .row-form').hide();
  }
</script>
<script src="https://groot.mailerlite.com/js/w/webforms.min.js?v300817f630ad0e957914d0b28a2b6d78" type="text/javascript"></script>

	  </div>
	  <div class="row" style="margin-bottom: 25px">
	    <p>
	      Having trouble subscribing?&nbsp;<a href="mailto:phil@eatonphil.com">Let me know</a>.
	    </p>
	  </div>
	</div>
      </div>
    </footer>
    <script async onload="loadGA()" src="https://www.googletagmanager.com/gtag/js?id=UA-58109156-2"></script>
    <script>
      function loadGA() {
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());
	  gtag('config', 'UA-58109156-2');
      }
    </script>
    <script defer src="https://cdn.usefathom.com/script.js" data-site="CEPUOLOQ"></script>
  </body>
</html>
