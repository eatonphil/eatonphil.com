<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="canonical" href="https://notes.eatonphil.com/bootloader-basics.html">
    <title>Bootloader basics | notes.eatonphil.com</title>
    <meta name="description" content="Bootloader basics" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" href="/rss.xml" />
  </head>
  <body>
    <header>
      <div class="container">
        <div>
          <div class="row">
	    <div>
	      <a href="https://eatonphil.com" class="sm-link">
		Home
              </a>
	      <a href="/" class="sm-link">
		Notes
              </a>
	      <a href="/favorites.html" class="sm-link">
		Popular
              </a>
	      <a href="/rss.xml" class="sm-link">
		RSS
              </a>
	    </div>
	    	      
	    <div class="subscribe">                                     
	      <a href="https://notes.eatonphil.com/bootloader-basics.html#subscribe">       
		Subscribe          
	      </a>
            </div>
	  </div>
	  <hr />
          <h2>January 23, 2022</h2>
          <h1>Bootloader basics</h1>
          <div class="row" style="padding-bottom: 5px">
            <div class="tags"><a href="/tags/assembly.html" class="tag">assembly</a><a href="/tags/bootloaders.html" class="tag">bootloaders</a></div>
          </div>
	</div>
      </div>
    </header>
    <div class="container">
      <div class="col-6">
        <p>I spent a few days playing around with bootloaders for the first
time. This post builds up to a text editor with a few keyboard
shortcuts. I'll be giving a virtual talk based on this work at <a href="https://www.meetup.com/hackernights/">Hacker
Nights on Jan 27</a>.</p>
<p>There are a definitely bugs. But it's hard to find intermediate
resources for bootloader programming so maybe parts of this will be
useful.</p>
<p>If you already know the basics and the intermediates and just want a
fantastic intermediate+ tutorial, maybe try
<a href="https://0x00sec.org/t/realmode-assembly-writing-bootable-stuff-part-5/3667">this</a>. It
is very good.</p>
<p>The code on this post is available on
<a href="https://github.com/eatonphil/bootloaders">Github</a>, but it's more of a
mess than my usual project.</p>
<h3 id="motivation:-snake">Motivation: Snake</h3><p>You remember <a href="https://www.quaxio.com/bootloader_retro_game_tweet/">snake bootloader in a
tweet</a> from a few
years ago?</p>
<p>Install qemu (on macOS or Linux), nasm, and copy the <code>snake.asm</code>
source code to disk from that blog post.</p>
<div class="highlight"><pre><span></span><span class="nf">$</span><span class="w"> </span><span class="nv">cat</span><span class="w"> </span><span class="nv">snake.asm</span>
<span class="w">          </span><span class="err">[</span><span class="k">bits</span><span class="w"> </span><span class="mi">16</span><span class="p">]</span><span class="w">                    </span><span class="c1">; Pragma, tells the assembler that we</span>
<span class="w">                                       </span><span class="c1">; are in 16 bit mode (which is the state</span>
<span class="w">                                       </span><span class="c1">; of x86 when booting from a floppy).</span>
<span class="w">          </span><span class="err">[</span><span class="k">org</span><span class="w"> </span><span class="mh">0x7C00</span><span class="p">]</span><span class="w">                 </span><span class="c1">; Pragma, tell the assembler where the</span>
<span class="w">                                       </span><span class="c1">; code will be loaded.</span>

<span class="w">          </span><span class="nf">mov</span><span class="w"> </span><span class="nb">bl</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w">                    </span><span class="c1">; Starting direction for the worm.</span>
<span class="w">          </span><span class="nf">push</span><span class="w"> </span><span class="mh">0xa000</span><span class="w">                  </span><span class="c1">; Load address of VRAM into es.</span>
<span class="w">          </span><span class="nf">pop</span><span class="w"> </span><span class="nb">es</span>

<span class="nl">restart_game:</span>
<span class="w">          </span><span class="nf">mov</span><span class="w">       </span><span class="nb">si</span><span class="p">,</span><span class="w"> </span><span class="mi">320</span><span class="o">*</span><span class="mi">100</span><span class="o">+</span><span class="mi">160</span><span class="w">    </span><span class="c1">; worm&#39;s starting position, center of</span>
<span class="w">                                       </span><span class="c1">; screen</span>

<span class="w">          </span><span class="c1">; Set video mode. Mode 13h is VGA (1 byte per pixel with the actual</span>
<span class="w">          </span><span class="c1">; color stored in a palette), 320x200 total size. When restarting,</span>
<span class="w">          </span><span class="c1">; this also clears the screen.</span>
<span class="w">          </span><span class="nf">mov</span><span class="w">       </span><span class="nb">ax</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0013</span>
<span class="w">          </span><span class="nf">int</span><span class="w">       </span><span class="mh">0x10</span>

<span class="w">          </span><span class="c1">; Draw borders. We assume the default palette will work for us.</span>
<span class="w">          </span><span class="c1">; We also assume that starting at the bottom and drawing 2176 pixels</span>
<span class="w">          </span><span class="c1">; wraps around and ends up drawing the top + bottom borders.</span>
<span class="w">          </span><span class="nf">mov</span><span class="w">       </span><span class="nb">di</span><span class="p">,</span><span class="w"> </span><span class="mi">320</span><span class="o">*</span><span class="mi">199</span>
<span class="w">          </span><span class="nf">mov</span><span class="w">       </span><span class="nb">cx</span><span class="p">,</span><span class="w"> </span><span class="mi">2176</span>
<span class="w">          </span><span class="nf">rep</span>
<span class="nl">draw_loop:</span>
<span class="w">          </span><span class="nf">stosb</span><span class="w">                        </span><span class="c1">; draw right border</span>
<span class="w">          </span><span class="nf">stosb</span><span class="w">                        </span><span class="c1">; draw left border</span>
<span class="w">          </span><span class="nf">add</span><span class="w">       </span><span class="nb">di</span><span class="p">,</span><span class="w"> </span><span class="mi">318</span>
<span class="w">          </span><span class="nf">jnc</span><span class="w">       </span><span class="nv">draw_loop</span><span class="w">          </span><span class="c1">; notice the jump in the middle of the</span>
<span class="w">                                       </span><span class="c1">; rep stosb instruction.</span>

<span class="nl">game_loop:</span>
<span class="w">          </span><span class="c1">; We read the keyboard input from port 0x60. This also reads bytes from</span>
<span class="w">          </span><span class="c1">; the mouse, so we need to only handle [up (0x48), left (0x4b),</span>
<span class="w">          </span><span class="c1">; right (0x4d), down (0x50)]</span>
<span class="w">          </span><span class="nf">in</span><span class="w">        </span><span class="nb">al</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span>
<span class="w">          </span><span class="nf">cmp</span><span class="w">       </span><span class="nb">al</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span>
<span class="w">          </span><span class="nf">jb</span><span class="w">        </span><span class="nv">kb_handle_end</span>
<span class="w">          </span><span class="nf">cmp</span><span class="w">       </span><span class="nb">al</span><span class="p">,</span><span class="w"> </span><span class="mh">0x50</span>
<span class="w">          </span><span class="nf">ja</span><span class="w">        </span><span class="nv">kb_handle_end</span>

<span class="w">          </span><span class="c1">; At the end bx contains offset displacement (+1, -1, +320, -320)</span>
<span class="w">          </span><span class="c1">; based on pressed/released keypad key. I bet there are a few bytes</span>
<span class="w">          </span><span class="c1">; to shave around here given the bounds check above.</span>
<span class="w">          </span><span class="nf">aaa</span>
<span class="w">          </span><span class="nf">cbw</span>
<span class="w">          </span><span class="nf">dec</span><span class="w">       </span><span class="nb">ax</span>
<span class="w">          </span><span class="nf">dec</span><span class="w">       </span><span class="nb">ax</span>
<span class="w">          </span><span class="nf">jc</span><span class="w">        </span><span class="nv">kb_handle</span>
<span class="w">          </span><span class="nf">sub</span><span class="w">       </span><span class="nb">al</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span>
<span class="w">          </span><span class="nf">imul</span><span class="w">      </span><span class="nb">ax</span><span class="p">,</span><span class="w"> </span><span class="nb">ax</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="w"> </span><span class="o">-</span><span class="mh">0x50</span>
<span class="nl">kb_handle:</span>
<span class="w">          </span><span class="nf">mov</span><span class="w">       </span><span class="nb">bx</span><span class="p">,</span><span class="w"> </span><span class="nb">ax</span>

<span class="nl">kb_handle_end:</span>
<span class="w">          </span><span class="nf">add</span><span class="w">       </span><span class="nb">si</span><span class="p">,</span><span class="w"> </span><span class="nb">bx</span>

<span class="w">          </span><span class="c1">; The original code used set pallete command (10h/0bh) to wait for</span>
<span class="w">          </span><span class="c1">; the vertical retrace. Today&#39;s computers are however too fast, so</span>
<span class="w">          </span><span class="c1">; we use int 15h 86h instead. This also shaves a few bytes.</span>

<span class="w">          </span><span class="c1">; Note: you&#39;ll have to tweak cx+dx if you are running this on a virtual</span>
<span class="w">          </span><span class="c1">; machine vs real hardware. Casual testing seems to show that virtual machines</span>
<span class="w">          </span><span class="c1">; wait ~3-4x longer than physical hardware.</span>
<span class="w">          </span><span class="nf">mov</span><span class="w">       </span><span class="nb">ah</span><span class="p">,</span><span class="w"> </span><span class="mh">0x86</span>
<span class="w">          </span><span class="nf">mov</span><span class="w">       </span><span class="nb">dh</span><span class="p">,</span><span class="w"> </span><span class="mh">0xef</span>
<span class="w">          </span><span class="nf">int</span><span class="w">       </span><span class="mh">0x15</span>

<span class="w">          </span><span class="c1">; Draw worm and check for collision with parity</span>
<span class="w">          </span><span class="c1">; (even parity=collision).</span>
<span class="w">          </span><span class="nf">mov</span><span class="w"> </span><span class="nb">ah</span><span class="p">,</span><span class="w"> </span><span class="mh">0x45</span>
<span class="w">          </span><span class="nf">xor</span><span class="w"> </span><span class="p">[</span><span class="nb">es</span><span class="p">:</span><span class="nb">si</span><span class="p">],</span><span class="w"> </span><span class="nb">ah</span>

<span class="w">          </span><span class="c1">; Go back to the main game loop.</span>
<span class="w">          </span><span class="nf">jpo</span><span class="w">       </span><span class="nv">game_loop</span>

<span class="w">          </span><span class="c1">; We hit a wall or the worm. Restart the game.</span>
<span class="w">          </span><span class="nf">jmp</span><span class="w">       </span><span class="nv">restart_game</span>

<span class="kd">TIMES</span><span class="w"> </span><span class="mi">510</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="kc">$</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="kc">$$</span><span class="p">)</span><span class="w"> </span><span class="nv">db</span><span class="w"> </span><span class="mi">0</span><span class="w">              </span><span class="c1">; Fill the rest of sector with 0</span>
<span class="kd">dw</span><span class="w"> </span><span class="mh">0xaa55</span><span class="w">                              </span><span class="c1">; Boot signature at the end of bootloader</span>
</pre></div>
<p>Now run:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>nasm<span class="w"> </span>-f<span class="w"> </span>bin<span class="w"> </span>snake.asm<span class="w"> </span>-o<span class="w"> </span>snake.bin
$<span class="w"> </span>qemu-system-x86_64<span class="w"> </span>-fda<span class="w"> </span>snake.bin
</pre></div>
<p><img src="bootloader-basics-snake.gif" alt="Recording of snake bootloader"></p>
<p>What a phenomenal hack.</p>
<p>I'm not going to get anywhere near that level of sophistication in
this post but I think it's great motivation.</p>
<h3 id="hello-world">Hello world</h3><p>Bootloaders are a mix of assembly programming and BIOS APIs for
I/O. Since you're thinking about bootloaders you already know assembly
basics. Now all you have to do is learn the APIs.</p>
<p>The hello world bootloader has been explained in detail (see
<a href="https://github.com/briansteffens/briansteffens.github.io/blob/master/blog/hello-world-from-a-bootloader/post.md">here</a>,
<a href="https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/writing-a-custom-bootloader">here</a>,
and <a href="http://3zanders.co.uk/2017/10/13/writing-a-bootloader/">here</a>) so
I won't go into too much line-by-line depth.</p>
<p>In fact, let's just pull the code from the latter blog post.</p>
<div class="highlight"><pre><span></span><span class="nf">$</span><span class="w"> </span><span class="nv">cat</span><span class="w"> </span><span class="nv">hello.asm</span>
<span class="k">bits</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="c1">; tell NASM this is 16 bit code</span>
<span class="k">org</span><span class="w"> </span><span class="mh">0x7c00</span><span class="w"> </span><span class="c1">; tell NASM to start outputting stuff at offset 0x7c00</span>
<span class="nl">boot:</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">si</span><span class="p">,</span><span class="nv">hello</span><span class="w"> </span><span class="c1">; point si register to hello label memory location</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">ah</span><span class="p">,</span><span class="mh">0x0e</span><span class="w"> </span><span class="c1">; 0x0e means &#39;Write Character in TTY mode&#39;</span>
<span class="nl">.loop:</span>
<span class="w">    </span><span class="nf">lodsb</span>
<span class="w">    </span><span class="nf">or</span><span class="w"> </span><span class="nb">al</span><span class="p">,</span><span class="nb">al</span><span class="w"> </span><span class="c1">; is al == 0 ?</span>
<span class="w">    </span><span class="nf">jz</span><span class="w"> </span><span class="nv">halt</span><span class="w">  </span><span class="c1">; if (al == 0) jump to halt label</span>
<span class="w">    </span><span class="nf">int</span><span class="w"> </span><span class="mh">0x10</span><span class="w"> </span><span class="c1">; runs BIOS interrupt 0x10 - Video Services</span>
<span class="w">    </span><span class="nf">jmp</span><span class="w"> </span><span class="nv">.loop</span>
<span class="nl">halt:</span>
<span class="w">    </span><span class="nf">cli</span><span class="w"> </span><span class="c1">; clear interrupt flag</span>
<span class="w">    </span><span class="nf">hlt</span><span class="w"> </span><span class="c1">; halt execution</span>
<span class="nl">hello:</span><span class="w"> </span><span class="kd">db</span><span class="w"> </span><span class="s">&quot;Hello world!&quot;</span><span class="p">,</span><span class="mi">0</span>

<span class="kd">times</span><span class="w"> </span><span class="mi">510</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="kc">$</span><span class="o">-</span><span class="kc">$$</span><span class="p">)</span><span class="w"> </span><span class="nv">db</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="c1">; pad remaining 510 bytes with zeroes</span>
<span class="kd">dw</span><span class="w"> </span><span class="mh">0xaa55</span><span class="w"> </span><span class="c1">; magic bootloader magic - marks this 512 byte sector bootable!</span>
</pre></div>
<p>The computer boots, prints "Hello world!" and hangs.</p>
<p>But aside from clerical settings (16-bit assembly, where the program
exists in memory, padding to 512 bytes) the only real bootloader-y
magic in there is <code>int 0x10</code>, a BIOS interrupt.</p>
<h4 id="bios-interrupts-=-api-calls-for-i/o">BIOS interrupts = API calls for I/O</h4><p>BIOS interrupts are API calls. Just like syscalls in userland programs
they have a specific register convention and number to call for the
family of APIs.</p>
<p>When you write bootloader programs you'll spend most of your time at
first trying to understand the behavior of the various BIOS APIs.</p>
<p>The two families we'll deal with in this post are the keyboard family
(documentation <a href="https://stanislavs.org/helppc/int_16.html">here</a>) and
the display family (documentation
<a href="https://stanislavs.org/helppc/int_10.html">here</a>).</p>
<h4 id="run-hello-world">Run hello world</h4><p>Anyway, back to the hello world. Assemble it with nasm and run it with
qemu.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>nasm<span class="w"> </span>-f<span class="w"> </span>bin<span class="w"> </span>hello.asm<span class="w"> </span>-o<span class="w"> </span>hello.bin
$<span class="w"> </span>qemu-system-x86_64<span class="w"> </span>-fda<span class="w"> </span>hello.bin
</pre></div>
<p><img src="bootloader-basics-hello.gif" alt="Printing hello world"></p>
<p>Getting the hang of it?</p>
<h3 id="io-loop">IO Loop</h3><p>The specific function we called above to write a character to the
display is <a href="https://stanislavs.org/helppc/int_10-e.html">INT
10,E</a>. The <code>0x10</code>
is the argument that you call the <code>int</code> keyword with
(e.g. <code>int 0x10</code>). And the <code>E</code> is the specific
function within the <code>0x10</code> family. The <code>E</code> is
written into the <code>AH</code> register before
calling <code>int</code>. The ASCII code to be written is placed in
the <code>AL</code> register.</p>
<p>Now that output makes some sense, let's do input. In the <a href="https://stanislavs.org/helppc/int_16.html">keyboard services
documentation</a> you may
notice that <a href="https://stanislavs.org/helppc/int_16-0.html">INT 16,0</a>
provides a way to block for user input. According to that page the
ASCII character will be in <code>AL</code> when the interrupt returns.</p>
<h4 id="clearing-the-screen">Clearing the screen</h4><p>You may have noticed some text gets displayed before our program
runs. We can use <a href="https://stanislavs.org/helppc/int_10-0.html">INT
0x10,0</a> to clear the
screen.</p>
<div class="highlight"><pre><span></span>        ;; Clear screen
        mov ah, 0x00
        mov al, 0x03
        int 0x10
</pre></div>
<h4 id="all-together">All together</h4><p>Since the display function reads from the same register the input
function outputs to, we can just call both interrupts after each
other. Wrap this in a loop and we have the world's worst editor.</p>
<div class="highlight"><pre><span></span><span class="o">$</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="n">ioloop</span><span class="o">.</span><span class="n">asm</span>
<span class="n">bits</span><span class="w"> </span><span class="mi">16</span>
<span class="n">org</span><span class="w"> </span><span class="mh">0x7c00</span>

<span class="n">main</span><span class="p">:</span>
<span class="w">        </span><span class="p">;;</span><span class="w"> </span><span class="n">Clear</span><span class="w"> </span><span class="n">screen</span>
<span class="w">        </span><span class="n">mov</span><span class="w"> </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span>
<span class="w">        </span><span class="n">mov</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="mh">0x03</span>
<span class="w">        </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="mh">0x10</span>

<span class="o">.</span><span class="n">loop</span><span class="p">:</span>
<span class="w">        </span><span class="p">;;</span><span class="w"> </span><span class="n">Read</span><span class="w"> </span><span class="n">character</span>
<span class="w">        </span><span class="n">mov</span><span class="w"> </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="mh">0x16</span>

<span class="w">        </span><span class="p">;;</span><span class="w"> </span><span class="n">Print</span><span class="w"> </span><span class="n">character</span>
<span class="w">        </span><span class="n">mov</span><span class="w"> </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0e</span>
<span class="w">        </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="mh">0x10</span>

<span class="w">        </span><span class="n">jmp</span><span class="w"> </span><span class="o">.</span><span class="n">loop</span>

<span class="n">times</span><span class="w"> </span><span class="mi">510</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="o">$-$$</span><span class="p">)</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">pad</span><span class="w"> </span><span class="n">remaining</span><span class="w"> </span><span class="mi">510</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">zeroes</span>
<span class="n">dw</span><span class="w"> </span><span class="mh">0xaa55</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">magic</span><span class="w"> </span><span class="n">bootloader</span><span class="w"> </span><span class="n">magic</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">marks</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="mi">512</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="n">sector</span><span class="w"> </span><span class="n">bootable</span><span class="o">!</span>
</pre></div>
<p class="note">
  By the way, the <code>main</code> label here (like
  the <code>boot</code> label above in <code>hello.asm</code>) is only
  to help the reader. It is not something the BIOS uses.
</p><p>Now that we've got the code, let's run it!</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>nasm<span class="w"> </span>-f<span class="w"> </span>bin<span class="w"> </span>ioloop.asm<span class="w"> </span>-o<span class="w"> </span>ioloop.bin
$<span class="w"> </span>qemu-system-x86_64<span class="w"> </span>-fda<span class="w"> </span>ioloop.bin
</pre></div>
<p><img src="bootloader-basics-ioloop.gif" alt="Recording of ioloop bootloader"></p>
<h3 id="digression-on-abstraction">Digression on abstraction</h3><p>There are two ways to build abstractions: assembly functions and nasm
macros.</p>
<p>We could build a clear screen function like this:</p>
<div class="highlight"><pre><span></span><span class="nl">clear_screen:</span>
<span class="w">        </span><span class="c1">;; Clear screen</span>
<span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">ah</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span>
<span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">al</span><span class="p">,</span><span class="w"> </span><span class="mh">0x03</span>
<span class="w">        </span><span class="nf">int</span><span class="w"> </span><span class="mh">0x10</span>
<span class="w">        </span><span class="nf">ret</span>
</pre></div>
<p>And then we can call this in the ioloop program like so:</p>
<div class="highlight"><pre><span></span><span class="k">bits</span><span class="w"> </span><span class="mi">16</span>
<span class="k">org</span><span class="w"> </span><span class="mh">0x7c00</span>

<span class="nf">jmp</span><span class="w"> </span><span class="nv">main</span>

<span class="nl">clear_screen:</span>
<span class="w">        </span><span class="c1">;; Clear screen</span>
<span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">ah</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span>
<span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">al</span><span class="p">,</span><span class="w"> </span><span class="mh">0x03</span>
<span class="w">        </span><span class="nf">int</span><span class="w"> </span><span class="mh">0x10</span>
<span class="w">        </span><span class="nf">ret</span>

<span class="nl">main:</span>
<span class="w">        </span><span class="nf">call</span><span class="w"> </span><span class="nv">clear_screen</span>

<span class="nl">.loop:</span>
<span class="w">        </span><span class="c1">;; Read character</span>
<span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">ah</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="nf">int</span><span class="w"> </span><span class="mh">0x16</span>

<span class="w">        </span><span class="c1">;; Print character</span>
<span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">ah</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0e</span>
<span class="w">        </span><span class="nf">int</span><span class="w"> </span><span class="mh">0x10</span>

<span class="w">        </span><span class="nf">jmp</span><span class="w"> </span><span class="nv">.loop</span>

<span class="kd">times</span><span class="w"> </span><span class="mi">510</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="kc">$</span><span class="o">-</span><span class="kc">$$</span><span class="p">)</span><span class="w"> </span><span class="nv">db</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="c1">; pad remaining 510 bytes with zeroes</span>
<span class="kd">dw</span><span class="w"> </span><span class="mh">0xaa55</span><span class="w"> </span><span class="c1">; magic bootloader magic - marks this 512 byte sector bootable!</span>
</pre></div>
<p>On the other hand if you do it in a macro:</p>
<div class="highlight"><pre><span></span><span class="k">bits</span><span class="w"> </span><span class="mi">16</span>
<span class="k">org</span><span class="w"> </span><span class="mh">0x7c00</span>

<span class="nf">jmp</span><span class="w"> </span><span class="nv">main</span>

<span class="cp">%macro cls 0 </span><span class="c1">; Zero is the number of arguments</span>
<span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">ah</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span>
<span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">al</span><span class="p">,</span><span class="w"> </span><span class="mh">0x03</span>
<span class="w">        </span><span class="nf">int</span><span class="w"> </span><span class="mh">0x10</span>
<span class="cp">%endmacro</span>

<span class="nl">main:</span>
<span class="w">        </span><span class="nf">cls</span>

<span class="nl">.loop:</span>
<span class="w">        </span><span class="c1">;; Read character</span>
<span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">ah</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="nf">int</span><span class="w"> </span><span class="mh">0x16</span>

<span class="w">        </span><span class="c1">;; Print character</span>
<span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="nb">ah</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0e</span>
<span class="w">        </span><span class="nf">int</span><span class="w"> </span><span class="mh">0x10</span>

<span class="w">        </span><span class="nf">jmp</span><span class="w"> </span><span class="nv">.loop</span>

<span class="kd">times</span><span class="w"> </span><span class="mi">510</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="kc">$</span><span class="o">-</span><span class="kc">$$</span><span class="p">)</span><span class="w"> </span><span class="nv">db</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="c1">; pad remaining 510 bytes with zeroes</span>
<span class="kd">dw</span><span class="w"> </span><span class="mh">0xaa55</span><span class="w"> </span><span class="c1">; magic bootloader magic - marks this 512 byte sector bootable!</span>
</pre></div>
<p>And nasm macros even have a way to write macro-safe labels by
prefixing them with <code>%%</code> which is useful if you have
conditions or loops within a macro.</p>
<p>The benefit of a macro I guess is that you're not using up the
stack. The benefit of a function call is that you're not duplicating
code every place you use a macro. The amount of generated code
eventually becomes important in bootloaders because the code must
fit into 512 bytes.</p>
<p>I lean more toward using macros in this code.</p>
<h3 id="complex-input">Complex input</h3><p>Reading ASCII characters is not complicated as we saw above. But what
if we want to build Readline style shortcuts like ctrl-a for jumping
to the start of the line?</p>
<p>Using INT 16,0 as we do above is fine. But rather than solely reading
from the result of that function call, there is a section of memory
that contains both the character pressed and control characters
pressed.</p>
<p>Based on documentation for this memory area (found
<a href="http://www.techhelpmanual.com/93-rom_bios_variables.html">here</a> or
<a href="https://www.tau.ac.il/~flaxer/edu/course/processcontrol/BiosDataArea.pdf">here</a>),
we can build a macro for reading the pressed character:</p>
<div class="highlight"><pre><span></span><span class="cp">%macro mov_read_character_into 1</span>
<span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="nb">eax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mh">0x041a</span><span class="p">]</span>
<span class="w">  </span><span class="nf">add</span><span class="w"> </span><span class="nb">eax</span><span class="p">,</span><span class="w"> </span><span class="mh">0x03fe</span><span class="w">   </span><span class="c1">; Offset from 0x0400 - sizeof(uint16) (since head points to next free slot, not last/current slot)</span>
<span class="w">  </span><span class="nf">and</span><span class="w"> </span><span class="nb">eax</span><span class="p">,</span><span class="w"> </span><span class="mh">0xFFFF</span>

<span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="o">%</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nb">eax</span><span class="p">]</span>
<span class="w">  </span><span class="nf">and</span><span class="w"> </span><span class="o">%</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mh">0xFF</span>
<span class="cp">%endmacro</span>
</pre></div>
<p>And another macro for reading the pressed control character (if any):</p>
<div class="highlight"><pre><span></span><span class="cp">%macro mov_read_ctrl_flag_into 1</span>
<span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="o">%</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mh">0x0417</span><span class="p">]</span>
<span class="w">  </span><span class="nf">and</span><span class="w"> </span><span class="o">%</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x04</span><span class="w">    </span><span class="c1">; Grab 3rd bit: %1 &amp; 0b0100</span>
<span class="cp">%endmacro</span>
</pre></div>
<h3 id="cursor-location">Cursor location</h3><p>Lastly we'll use some cursor APIs that that allow us to handle
newlines, backspace on the first column of a line, and ctrl-a (jump to
beginning of line).</p>
<div class="highlight"><pre><span></span><span class="cp">%macro get_position 0</span>
<span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="nb">ah</span><span class="p">,</span><span class="w"> </span><span class="mh">0x03</span>
<span class="w">  </span><span class="nf">int</span><span class="w"> </span><span class="mh">0x10</span>
<span class="cp">%endmacro</span>

<span class="cp">%macro set_position 0</span>
<span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="nb">ah</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span>
<span class="w">  </span><span class="nf">int</span><span class="w"> </span><span class="mh">0x10</span>
<span class="cp">%endmacro</span>
</pre></div>
<p>But there's something buggy about my <code>goto_end_of_line</code>
function. Sometimes it works and sometimes it just jumps all over the
screen in an infinite loop. Part of the problem is that the editor
memory is the video card. The cursor location is only stored there and
not in some program state like you might do in a high-level
environment/language.</p>
<div class="highlight"><pre><span></span><span class="nl">goto_end_of_line:</span>
<span class="c1">;; Get current character</span>
<span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="nb">ah</span><span class="p">,</span><span class="w"> </span><span class="mh">0x08</span>
<span class="w">  </span><span class="nf">int</span><span class="w"> </span><span class="mh">0x10</span>

<span class="c1">;; Iterate until the character is null</span>
<span class="w">  </span><span class="nf">cmp</span><span class="w"> </span><span class="nb">al</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="nf">jz</span><span class="w"> </span><span class="nv">.done</span>

<span class="w">  </span><span class="nf">inc</span><span class="w"> </span><span class="nb">dl</span>
<span class="w">  </span><span class="nf">set_position</span>
<span class="w">  </span><span class="nf">jmp</span><span class="w"> </span><span class="nv">goto_end_of_line</span>

<span class="nl">.done:</span>
<span class="w">  </span><span class="nf">ret</span>
</pre></div>
<p>Alright, let's put all these pieces together.</p>
<h3 id="editor-with-keyboard-shortcuts">Editor with keyboard shortcuts</h3><p>Start with the basics in <code>editor.asm</code>.</p>
<div class="highlight"><pre><span></span><span class="c1">; -*- mode: nasm;-*-</span>

<span class="k">bits</span><span class="w"> </span><span class="mi">16</span>
<span class="k">org</span><span class="w"> </span><span class="mh">0x7c00</span>

<span class="w">  </span><span class="nf">jmp</span><span class="w"> </span><span class="nv">main</span>
</pre></div>
<p>Then add a clear screen macro.</p>
<div class="highlight"><pre><span></span><span class="cp">%macro cls 0</span>
<span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="nb">ah</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span>
<span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="nb">al</span><span class="p">,</span><span class="w"> </span><span class="mh">0x03</span>
<span class="w">  </span><span class="nf">int</span><span class="w"> </span><span class="mh">0x10</span>
<span class="cp">%endmacro</span>
</pre></div>
<p>Add macros for reading and printing.</p>
<div class="highlight"><pre><span></span><span class="cp">%macro read_character 0</span>
<span class="w">  </span><span class="c1">;; Read character</span>
<span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="nb">ah</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="nf">int</span><span class="w"> </span><span class="mh">0x16</span>
<span class="cp">%endmacro</span>

<span class="cp">%macro print_character 1</span>
<span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="nb">ax</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="mi">1</span>
<span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="nb">ah</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0e</span>
<span class="w">  </span><span class="nf">int</span><span class="w"> </span><span class="mh">0x10</span>
<span class="cp">%endmacro</span>
</pre></div>
<p>Add cursor utilities.</p>
<div class="highlight"><pre><span></span><span class="cp">%macro get_position 0</span>
<span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="nb">ah</span><span class="p">,</span><span class="w"> </span><span class="mh">0x03</span>
<span class="w">  </span><span class="nf">int</span><span class="w"> </span><span class="mh">0x10</span>
<span class="cp">%endmacro</span>

<span class="cp">%macro set_position 0</span>
<span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="nb">ah</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span>
<span class="w">  </span><span class="nf">int</span><span class="w"> </span><span class="mh">0x10</span>
<span class="cp">%endmacro</span>

<span class="nl">goto_end_of_line:</span>
<span class="c1">;; Get current character</span>
<span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="nb">ah</span><span class="p">,</span><span class="w"> </span><span class="mh">0x08</span>
<span class="w">  </span><span class="nf">int</span><span class="w"> </span><span class="mh">0x10</span>

<span class="c1">;; Iterate until the character is null</span>
<span class="w">  </span><span class="nf">cmp</span><span class="w"> </span><span class="nb">al</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="nf">jz</span><span class="w"> </span><span class="nv">.done</span>

<span class="w">  </span><span class="nf">inc</span><span class="w"> </span><span class="nb">dl</span>
<span class="w">  </span><span class="nf">set_position</span>
<span class="w">  </span><span class="nf">jmp</span><span class="w"> </span><span class="nv">goto_end_of_line</span>

<span class="nl">.done:</span>
<span class="w">  </span><span class="nf">ret</span>
</pre></div>
<p>And keyboard utilities.</p>
<div class="highlight"><pre><span></span><span class="cp">%macro mov_read_ctrl_flag_into 1</span>
<span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="o">%</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mh">0x0417</span><span class="p">]</span>
<span class="w">  </span><span class="nf">and</span><span class="w"> </span><span class="o">%</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x04</span><span class="w">    </span><span class="c1">; Grab 3rd bit: %1 &amp; 0b0100</span>
<span class="cp">%endmacro</span>

<span class="cp">%macro mov_read_character_into 1</span>
<span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="nb">eax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mh">0x041a</span><span class="p">]</span>
<span class="w">  </span><span class="nf">add</span><span class="w"> </span><span class="nb">eax</span><span class="p">,</span><span class="w"> </span><span class="mh">0x03fe</span><span class="w">   </span><span class="c1">; Offset from 0x0400 - sizeof(uint16) (since head points to next free slot, not last/current slot)</span>
<span class="w">  </span><span class="nf">and</span><span class="w"> </span><span class="nb">eax</span><span class="p">,</span><span class="w"> </span><span class="mh">0xFFFF</span>

<span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="o">%</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nb">eax</span><span class="p">]</span>
<span class="w">  </span><span class="nf">and</span><span class="w"> </span><span class="o">%</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mh">0xFF</span>
<span class="cp">%endmacro</span>
</pre></div>
<p>Now we can start the editor loop where we wait for a keypress and
handle it.</p>
<div class="highlight"><pre><span></span><span class="nl">editor_action:</span>
<span class="w">  </span><span class="nf">read_character</span>
</pre></div>
<p>Don't print ASCII garbage if the key pressed is an arrow key. Just do
nothing. (This isn't good editor behavior in general but ours is a
limited one.)</p>
<div class="highlight"><pre><span></span><span class="c1">;; Ignore arrow keys</span>
<span class="w">  </span><span class="nf">cmp</span><span class="w"> </span><span class="nb">ah</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4b</span><span class="w">    </span><span class="c1">; Left</span>
<span class="w">  </span><span class="nf">jz</span><span class="w"> </span><span class="nv">.done</span>
<span class="w">  </span><span class="nf">cmp</span><span class="w"> </span><span class="nb">ah</span><span class="p">,</span><span class="w"> </span><span class="mh">0x50</span><span class="w">    </span><span class="c1">; Down</span>
<span class="w">  </span><span class="nf">jz</span><span class="w"> </span><span class="nv">.done</span>
<span class="w">  </span><span class="nf">cmp</span><span class="w"> </span><span class="nb">ah</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4d</span><span class="w">    </span><span class="c1">; Right</span>
<span class="w">  </span><span class="nf">jz</span><span class="w"> </span><span class="nv">.done</span>
<span class="w">  </span><span class="nf">cmp</span><span class="w"> </span><span class="nb">ah</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span><span class="w">    </span><span class="c1">; Up</span>
<span class="w">  </span><span class="nf">jz</span><span class="w"> </span><span class="nv">.done</span>
</pre></div>
<p>Next handle backspace.</p>
<div class="highlight"><pre><span></span><span class="c1">;; Handle backspace</span>
<span class="w">  </span><span class="nf">cmp</span><span class="w"> </span><span class="nb">al</span><span class="p">,</span><span class="w"> </span><span class="mh">0x08</span>
<span class="w">  </span><span class="nf">jz</span><span class="w"> </span><span class="nv">.is_backspace</span>

<span class="w">  </span><span class="nf">cmp</span><span class="w"> </span><span class="nb">al</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7F</span><span class="w">    </span><span class="c1">; For mac keyboards</span>
<span class="w">  </span><span class="nf">jnz</span><span class="w"> </span><span class="nv">.done_backspace</span>

<span class="nl">.is_backspace:</span>

<span class="w">  </span><span class="nf">get_position</span>
</pre></div>
<p>If this key is pressed at the first line and the first column, do
nothing.</p>
<div class="highlight"><pre><span></span><span class="c1">;; Handle 0,0 coordinate (do nothing)</span>
<span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="nb">al</span><span class="p">,</span><span class="w"> </span><span class="nb">dh</span>
<span class="w">  </span><span class="nf">add</span><span class="w"> </span><span class="nb">al</span><span class="p">,</span><span class="w"> </span><span class="nb">dl</span>
<span class="w">  </span><span class="nf">jz</span><span class="w"> </span><span class="nv">.overwrite_character</span>
</pre></div>
<p>Otherwise if backspace is pressed not at the beginning of the line,
just overwrite the last character with the ASCII 0 (the code 0 not the
digit 0).</p>
<div class="highlight"><pre><span></span><span class="w">  </span><span class="nf">cmp</span><span class="w"> </span><span class="nb">dl</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="nf">jz</span><span class="w"> </span><span class="nv">.backspace_at_start_of_line</span>
<span class="w">  </span><span class="nf">dec</span><span class="w"> </span><span class="nb">dl</span><span class="w">      </span><span class="c1">; Decrement column</span>
<span class="w">  </span><span class="nf">set_position</span>
<span class="w">  </span><span class="nf">jmp</span><span class="w"> </span><span class="nv">.overwrite_character</span>
</pre></div>
<p>Otherwise you're at the beginning of the line and you need to jump to
the end of the previous line.</p>
<div class="highlight"><pre><span></span><span class="nl">.backspace_at_start_of_line:</span>
<span class="w">  </span><span class="nf">dec</span><span class="w"> </span><span class="nb">dh</span><span class="w">      </span><span class="c1">; Decrement row</span>
<span class="w">  </span><span class="nf">set_position</span>

<span class="w">  </span><span class="nf">call</span><span class="w"> </span><span class="nv">goto_end_of_line</span>

<span class="nl">.overwrite_character:</span>
<span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="nb">al</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="nb">ah</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0a</span>
<span class="w">  </span><span class="nf">int</span><span class="w"> </span><span class="mh">0x10</span>

<span class="w">  </span><span class="nf">jmp</span><span class="w"> </span><span class="nv">.done</span>

<span class="nl">.done_backspace:</span>
</pre></div>
<p>Next we handle the Enter key. This should move the cursor onto the
next line and set the column back to zero.</p>
<div class="highlight"><pre><span></span><span class="c1">;; Handle enter</span>
<span class="w">  </span><span class="nf">mov_read_character_into</span><span class="w"> </span><span class="nb">ax</span>
<span class="w">  </span><span class="nf">cmp</span><span class="w"> </span><span class="nb">al</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0d</span>
<span class="w">  </span><span class="nf">jnz</span><span class="w"> </span><span class="nv">.done_enter</span>

<span class="w">  </span><span class="nf">get_position</span>
<span class="w">  </span><span class="nf">inc</span><span class="w"> </span><span class="nb">dh</span><span class="w">      </span><span class="c1">; Increment line</span>
<span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="nb">dl</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="c1">; Reset column</span>
<span class="w">  </span><span class="nf">set_position</span>

<span class="w">  </span><span class="nf">jmp</span><span class="w"> </span><span class="nv">.done</span>

<span class="nl">.done_enter:</span>
</pre></div>
<p>Next we handle ctrl-a, jump to start of line.</p>
<div class="highlight"><pre><span></span><span class="c1">;; Handle ctrl- shortcuts</span>

<span class="c1">;; Check ctrl key</span>
<span class="w">  </span><span class="nf">mov_read_ctrl_flag_into</span><span class="w"> </span><span class="nb">ax</span>
<span class="w">    </span><span class="nf">jz</span><span class="w"> </span><span class="nv">.ctrl_not_set</span>

<span class="c1">;; Handle ctrl-a shortcut</span>
<span class="w">  </span><span class="nf">mov_read_character_into</span><span class="w"> </span><span class="nb">ax</span>
<span class="w">  </span><span class="nf">cmp</span><span class="w"> </span><span class="nb">al</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w">     </span><span class="c1">; For some reason with ctlr, these are offset from a-z</span>
<span class="w">  </span><span class="nf">jnz</span><span class="w"> </span><span class="nv">.not_ctrl_a</span>

<span class="c1">;; Reset column</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="nb">dl</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="nf">set_position</span>

<span class="w">    </span><span class="nf">jmp</span><span class="w"> </span><span class="nv">.done</span>

<span class="nl">.not_ctrl_a:</span>
</pre></div>
<p>For ctrl-e, jump to the end of the line.</p>
<div class="highlight"><pre><span></span><span class="c1">;; Handle ctrl-e shortcut</span>
<span class="w">  </span><span class="nf">mov_read_character_into</span><span class="w"> </span><span class="nb">ax</span>
<span class="w">  </span><span class="nf">cmp</span><span class="w"> </span><span class="nb">al</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span>
<span class="w">  </span><span class="nf">jnz</span><span class="w"> </span><span class="nv">.not_ctrl_e</span>

<span class="w">  </span><span class="nf">call</span><span class="w"> </span><span class="nv">goto_end_of_line</span>
<span class="w">  </span><span class="nf">jmp</span><span class="w"> </span><span class="nv">.done</span>

<span class="nl">.not_ctrl_e:</span>
<span class="w">  </span><span class="nf">jmp</span><span class="w"> </span><span class="nv">.done</span>

<span class="nl">.ctrl_not_set:</span>
</pre></div>
<p>Finally if none of these cases are met, just print the pressed character and return.</p>
<div class="highlight"><pre><span></span><span class="w">  </span><span class="nf">mov_read_character_into</span><span class="w"> </span><span class="nb">ax</span>
<span class="w">  </span><span class="nf">print_character</span><span class="w"> </span><span class="nb">ax</span>

<span class="nl">.done:</span>
<span class="w">  </span><span class="nf">ret</span>
</pre></div>
<p>Finally, create the main function that calls this editor code in a loop.</p>
<div class="highlight"><pre><span></span><span class="nl">main:</span>
<span class="w">  </span><span class="nf">cls</span>

<span class="nl">.loop:</span>
<span class="w">  </span><span class="nf">call</span><span class="w"> </span><span class="nv">editor_action</span>
<span class="w">  </span><span class="nf">jmp</span><span class="w"> </span><span class="nv">.loop</span>

<span class="kd">times</span><span class="w"> </span><span class="mi">510</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="kc">$</span><span class="o">-</span><span class="kc">$$</span><span class="p">)</span><span class="w"> </span><span class="nv">db</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="c1">; pad remaining 510 bytes with zeroes</span>
<span class="kd">dw</span><span class="w"> </span><span class="mh">0xaa55</span><span class="w"> </span><span class="c1">; magic bootloader magic - marks this 512 byte sector bootable!</span>
</pre></div>
<p>And we're done! Try it out:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>nasm<span class="w"> </span>-f<span class="w"> </span>bin<span class="w"> </span>editor.asm<span class="w"> </span>-o<span class="w"> </span>editor.bin
$<span class="w"> </span>qemu-system-x86_64<span class="w"> </span>-fda<span class="w"> </span>editor.bin
</pre></div>
<p><img src="bootloader-basics-editor.gif" alt="Recording of a bad editor"></p>
<p>Tedious and buggy! But I learned something, I think.</p>
<p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">I wrote a new post on my first time exploring bootloader basics! Neat to discover the BIOS APIs and spend some time actually coding in assembly versus just generating or emulating it.<a href="https://t.co/7iP6Nib620">https://t.co/7iP6Nib620</a> <a href="https://t.co/xSyG1IXgEB">pic.twitter.com/xSyG1IXgEB</a></p>&mdash; Phil Eaton (@phil_eaton) <a href="https://twitter.com/phil_eaton/status/1485398216124346371?ref_src=twsrc%5Etfw">January 23, 2022</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<style>.feedback{display:initial;}</style>
	<div class="feedback">
	  <h4>Feedback</h4>
	  <p><small>As always,
	      please <a href="mailto:phil@eatonphil.com">email</a>
	      or <a href="https://twitter.com/eatonphil">tweet me</a>
	      with questions, corrections, or ideas!</small></p>

	</div>
      </div>
    </div>
    <footer>
      <div class="container">
	<div>
	  <div class="row">
	    <div class="feedback">
	      <h4>Frequent Topics</h4>
	      <div class="tags"><a href="/tags/javascript.html" class="tag">javascript (24)</a><a href="/tags/parsing.html" class="tag">parsing (21)</a><a href="/tags/databases.html" class="tag">databases (19)</a><a href="/tags/golang.html" class="tag">golang (14)</a><a href="/tags/compilers.html" class="tag">compilers (14)</a><a href="/tags/postgres.html" class="tag">postgres (13)</a><a href="/tags/sql.html" class="tag">sql (10)</a><a href="/tags/interpreters.html" class="tag">interpreters (10)</a><a href="/tags/lisp.html" class="tag">lisp (9)</a><a href="/tags/books.html" class="tag">books (9)</a><a href="/tags/python.html" class="tag">python (8)</a><a href="/tags/go.html" class="tag">go (8)</a><a href="/tags/zig.html" class="tag">zig (7)</a><a href="/tags/management.html" class="tag">management (7)</a><a href="/tags/json.html" class="tag">json (7)</a><a href="/tags/scheme.html" class="tag">scheme (6)</a><a href="/tags/linux.html" class="tag">linux (6)</a><a href="/tags/x86-amd64.html" class="tag">x86/amd64 (5)</a><a href="/tags/typescript.html" class="tag">typescript (5)</a><a href="/tags/learning.html" class="tag">learning (5)</a></div>
	    </div>
	  </div>
	  <div class="row" id="subscribe">
	    <style type="text/css">
  /* LOADER */
  .ml-form-embedSubmitLoad {
      display: inline-block;
      width: 20px;
      height: 20px;
  }
  .g-recaptcha {
      transform: scale(1);
      -webkit-transform: scale(1);
      transform-origin: 0 0;
      -webkit-transform-origin: 0 0;
      height: ;
  }
  .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      border: 0;
  }
  .ml-form-embedSubmitLoad:after {
      content: " ";
      display: block;
      width: 11px;
      height: 11px;
      margin: 1px;
      border-radius: 50%;
      border: 4px solid #fff;
      border-color: #ffffff #ffffff #ffffff transparent;
      animation: ml-form-embedSubmitLoad 1.2s linear infinite;
  }
  @keyframes ml-form-embedSubmitLoad {
      0% {
          transform: rotate(0deg);
      }
      100% {
          transform: rotate(360deg);
      }
  }
  #mlb2-3175296.ml-form-embedContainer {
      box-sizing: border-box;
      display: table;
      margin: 0 auto;
      position: static;
      width: 100% !important;
  }
  #mlb2-3175296.ml-form-embedContainer h3,
  #mlb2-3175296.ml-form-embedContainer p,
  #mlb2-3175296.ml-form-embedContainer span,
  #mlb2-3175296.ml-form-embedContainer button {
      text-transform: none !important;
      letter-spacing: normal !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper {
      border-width: 0px;
      border-color: transparent;
  border-radius: 4px;
  border-style: solid;
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  position: relative;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-align-left { text-align: left; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-align-center {
  text-align: center;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-align-default { display: table-cell !important; vertical-align: middle !important; text-align: center !important; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-align-right { text-align: right; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedHeader img {
  border-top-left-radius: 4px;
  border-top-right-radius: 4px;
  height: auto;
  margin: 0 auto !important;
  max-width: 100%;
  width: undefinedpx;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody.ml-form-embedBodyHorizontal {
  padding-bottom: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent {
  text-align: left;
  margin: 0 0 20px 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent p,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent p {
  color: #000000;
  font-size: 14px;
  font-weight: 400;
  line-height: 20px;
  margin: 0 0 10px 0;
  text-align: left;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent ul,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent ol,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent ul,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent ol {
  color: #000000;
  font-size: 14px;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent ol ol,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent ol ol {
  list-style-type: lower-alpha;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent ol ol ol,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent ol ol ol {
  list-style-type: lower-roman;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent p a,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent p a {
  color: #000000;
  text-decoration: underline;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-block-form .ml-field-group {
  text-align: left!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-block-form .ml-field-group label {
  margin-bottom: 5px;
  color: #333333;
  font-size: 14px;
  font-weight: bold; font-style: normal; text-decoration: none;;
  display: inline-block;
  line-height: 20px;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent p:last-child,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent p:last-child {
  margin: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody form {
  margin: 0;
  width: 100%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-formContent,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow {
  margin: 0 0 20px 0;
  width: 100%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow {
  float: left;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-formContent.horozintalForm {
  margin: 0;
  padding: 0 0 20px 0;
  width: 100%;
  height: auto;
  float: left;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow {
  margin: 0 0 10px 0;
  width: 100%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow.ml-last-item {
  margin: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow.ml-formfieldHorizintal {
  margin: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input {
  background-color: #ffffff !important;
  color: #333333 !important;
  border-color: #cccccc;
  border-radius: 4px !important;
  border-style: solid !important;
  border-width: 1px !important;
  font-size: 14px !important;
  height: auto;
  line-height: 21px !important;
  margin-bottom: 0;
  margin-top: 0;
  margin-left: 0;
  margin-right: 0;
  padding: 10px 10px !important;
  width: 100% !important;
  box-sizing: border-box !important;
  max-width: 100% !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input::-webkit-input-placeholder,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input::-webkit-input-placeholder { color: #333333; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input::-moz-placeholder,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input::-moz-placeholder { color: #333333; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input:-ms-input-placeholder,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input:-ms-input-placeholder { color: #333333; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input:-moz-placeholder,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input:-moz-placeholder { color: #333333; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow textarea, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow textarea {
  background-color: #ffffff !important;
  color: #333333 !important;
  border-color: #cccccc;
  border-radius: 4px !important;
  border-style: solid !important;
  border-width: 1px !important;
  font-size: 14px !important;
  height: auto;
  line-height: 21px !important;
  margin-bottom: 0;
  margin-top: 0;
  padding: 10px 10px !important;
  width: 100% !important;
  box-sizing: border-box !important;
  max-width: 100% !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before {
  border-color: #cccccc!important;
  background-color: #ffffff!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input.custom-control-input[type="checkbox"]{
  box-sizing: border-box;
  padding: 0;
  position: absolute;
  z-index: -1;
  opacity: 0;
  margin-top: 5px;
  margin-left: -1.5rem;
  overflow: visible;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before {
  border-radius: 4px!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow input[type=checkbox]:checked~.label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox input[type=checkbox]:checked~.label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-input:checked~.custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-input:checked~.custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox input[type=checkbox]:checked~.label-description::after {
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23fff' d='M6.564.75l-3.59 3.612-1.538-1.55L0 4.26 2.974 7.25 8 2.193z'/%3e%3c/svg%3e");
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-input:checked~.custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-input:checked~.custom-control-label::after {
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e");
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-input:checked~.custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-input:checked~.custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-input:checked~.custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-input:checked~.custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox input[type=checkbox]:checked~.label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox input[type=checkbox]:checked~.label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow input[type=checkbox]:checked~.label-description::before  {
  border-color: #000000!important;
  background-color: #000000!important;
  color: #ffffff!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label::after {
  top: 2px;
  box-sizing: border-box;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::after {
  top: 0px!important;
  box-sizing: border-box!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::after {
  top: 0px!important;
  box-sizing: border-box!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::after {
  top: 0px!important;
  box-sizing: border-box!important;
  position: absolute;
  left: -1.5rem;
  display: block;
  width: 1rem;
  height: 1rem;
  content: "";
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::before {
  top: 0px!important;
  box-sizing: border-box!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .custom-control-label::before {
  position: absolute;
  top: 4px;
  left: -1.5rem;
  display: block;
  width: 16px;
  height: 16px;
  pointer-events: none;
  content: "";
  background-color: #ffffff;
  border: #adb5bd solid 1px;
  border-radius: 50%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .custom-control-label::after {
  position: absolute;
  top: 2px!important;
  left: -1.5rem;
  display: block;
  width: 1rem;
  height: 1rem;
  content: "";
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before {
  position: absolute;
  top: 4px;
  left: -1.5rem;
  display: block;
  width: 16px;
  height: 16px;
  pointer-events: none;
  content: "";
  background-color: #ffffff;
  border: #adb5bd solid 1px;
  border-radius: 50%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::after {
  position: absolute;
  top: 0px!important;
  left: -1.5rem;
  display: block;
  width: 1rem;
  height: 1rem;
  content: "";
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::after {
  position: absolute;
  top: 0px!important;
  left: -1.5rem;
  display: block;
  width: 1rem;
  height: 1rem;
  content: "";
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .custom-radio .custom-control-label::after {
  background: no-repeat 50%/50% 50%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .custom-checkbox .custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::after {
  background: no-repeat 50%/50% 50%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-control, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-control {
  position: relative;
  display: block;
  min-height: 1.5rem;
  padding-left: 1.5rem;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-input, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-input, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-input, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-input {
  position: absolute;
  z-index: -1;
  opacity: 0;
  box-sizing: border-box;
  padding: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-label, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-label, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label {
  color: #000000;
  font-size: 12px!important;
  line-height: 22px;
  margin-bottom: 0;
  position: relative;
  vertical-align: top;
  font-style: normal;
  font-weight: 700;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-select, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-select {
  background-color: #ffffff !important;
  color: #333333 !important;
  border-color: #cccccc;
  border-radius: 4px !important;
  border-style: solid !important;
  border-width: 1px !important;
  font-size: 14px !important;
  line-height: 20px !important;
  margin-bottom: 0;
  margin-top: 0;
  padding: 10px 28px 10px 12px !important;
  width: 100% !important;
  box-sizing: border-box !important;
  max-width: 100% !important;
  height: auto;
  display: inline-block;
  vertical-align: middle;
  background: url('https://assets.mlcdn.com/ml/images/default/dropdown.svg') no-repeat right .75rem center/8px 10px;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow {
  height: auto;
  width: 100%;
  float: left;
  }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-input-horizontal { width: 70%; float: left; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-button-horizontal { width: 30%; float: left; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-button-horizontal.labelsOn { padding-top: 25px;  }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .horizontal-fields { box-sizing: border-box; float: left; padding-right: 10px;  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input {
  background-color: #ffffff;
  color: #333333;
  border-color: #cccccc;
  border-radius: 4px;
  border-style: solid;
  border-width: 1px;
  font-size: 14px;
  line-height: 20px;
  margin-bottom: 0;
  margin-top: 0;
  padding: 10px 10px;
  width: 100%;
  box-sizing: border-box;
  overflow-y: initial;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow button {
  background-color: #000000 !important;
  border-color: #000000;
  border-style: solid;
  border-width: 1px;
  border-radius: 4px;
  box-shadow: none;
  color: #ffffff !important;
  cursor: pointer;
  font-size: 14px !important;
  font-weight: 700;
  line-height: 20px;
  margin: 0 !important;
  padding: 10px !important;
  width: 100%;
  height: auto;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow button:hover {
  background-color: #333333 !important;
  border-color: #333333 !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow input[type="checkbox"] {
  box-sizing: border-box;
  padding: 0;
  position: absolute;
  z-index: -1;
  opacity: 0;
  margin-top: 5px;
  margin-left: -1.5rem;
  overflow: visible;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description {
  color: #000000;
  display: block;
  font-size: 12px;
  text-align: left;
  margin-bottom: 0;
  position: relative;
  vertical-align: top;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow label {
  font-weight: normal;
  margin: 0;
  padding: 0;
  position: relative;
  display: block;
  min-height: 24px;
  padding-left: 24px;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow label a {
  color: #000000;
  text-decoration: underline;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow label p {
  color: #000000 !important;
  font-size: 12px !important;
  font-weight: normal !important;
  line-height: 18px !important;
  padding: 0 !important;
  margin: 0 5px 0 0 !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow label p:last-child {
  margin: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedSubmit {
  margin: 0 0 20px 0;
  float: left;
  width: 100%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedSubmit button {
  background-color: #000000 !important;
  border: none !important;
  border-radius: 4px !important;
  box-shadow: none !important;
  color: #ffffff !important;
  cursor: pointer;
  font-size: 14px !important;
  font-weight: 700 !important;
  line-height: 21px !important;
  height: auto;
  padding: 10px !important;
  width: 100% !important;
  box-sizing: border-box !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedSubmit button.loading {
  display: none;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedSubmit button:hover {
  background-color: #333333 !important;
  }
  .ml-subscribe-close {
  width: 30px;
  height: 30px;
  background: url('https://assets.mlcdn.com/ml/images/default/modal_close.png') no-repeat;
  background-size: 30px;
  cursor: pointer;
  margin-top: -10px;
  margin-right: -10px;
  position: absolute;
  top: 0;
  right: 0;
  }
  .ml-error input, .ml-error textarea, .ml-error select {
  border-color: red!important;
  }
  .ml-error .custom-checkbox-radio-list {
  border: 1px solid red !important;
  border-radius: 4px;
  padding: 10px;
  }
  .ml-error .label-description,
  .ml-error .label-description p,
  .ml-error .label-description p a,
  .ml-error label:first-child {
  color: #ff0000 !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow.ml-error .label-description p,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow.ml-error .label-description p:first-letter {
  color: #ff0000 !important;
  }
  @media only screen and (max-width: 400px){
  .ml-form-embedWrapper.embedDefault, .ml-form-embedWrapper.embedPopup { width: 100%!important; }
  .ml-form-formContent.horozintalForm { float: left!important; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow { height: auto!important; width: 100%!important; float: left!important; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-input-horizontal { width: 100%!important; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-input-horizontal > div { padding-right: 0px!important; padding-bottom: 10px; }
    .ml-form-formContent.horozintalForm .ml-button-horizontal { width: 100%!important; }
    .ml-form-formContent.horozintalForm .ml-button-horizontal.labelsOn { padding-top: 0px!important; }
    }
</style>
<div id="mlb2-3175296" class="ml-form-embedContainer ml-subscribe-form ml-subscribe-form-3175296">
  <hr />
  <div class="ml-form-align-center ">
    <div class="ml-form-embedWrapper embedForm">
      <div class="ml-form-embedBody ml-form-embedBodyDefault row-form">
        <div class="ml-form-embedContent" style=" ">
          <h4>Subscribe</h4>
          <p>Enter your email if you'd like to be kept in the loop about future articles!<br><br>You can expect 2 to 4 messages per month depending on how motivated I'm feeling. :)</p>
	  <p></p>
	  <p>Cheers,<br>Phil</p>
        </div>
        <form class="ml-block-form" action="https://assets.mailerlite.com/jsonp/303114/forms/78235486326359572/subscribe" data-code="" method="post" target="_blank">
          <div class="ml-form-formContent">
            <div class="ml-form-fieldRow ml-last-item">
              <div class="ml-field-group ml-field-email ml-validate-email ml-validate-required">
                <!-- input -->
                <input aria-label="email" aria-required="true" type="email" class="form-control" data-inputmask="" name="fields[email]" placeholder="Email" autocomplete="email">
                <!-- /input -->
                <!-- textarea -->
                <!-- /textarea -->
                <!-- select -->
                <!-- /select -->
                <!-- checkboxes -->
		<!-- /checkboxes -->
                <!-- radio -->
                <!-- /radio -->
                <!-- countries -->
                <!-- /countries -->
              </div>
            </div>
          </div>
          <!-- Privacy policy -->
          <!-- /Privacy policy -->
	  <div class="ml-form-recaptcha ml-validate-required" style="float: left;">
            <style type="text/css">
	      .ml-form-recaptcha {
		  margin-bottom: 20px;
	      }
	      .ml-form-recaptcha.ml-error iframe {
		  border: solid 1px #ff0000;
	      }
	      @media screen and (max-width: 480px) {
		  .ml-form-recaptcha {
		      width: 220px!important
		  }
		  .g-recaptcha {
		      transform: scale(0.78);
		      -webkit-transform: scale(0.78);
		      transform-origin: 0 0;
		      -webkit-transform-origin: 0 0;
		  }
	      }
	    </style>
	    <script src="https://www.google.com/recaptcha/api.js"></script>
	    <div class="g-recaptcha" data-sitekey="6Lf1KHQUAAAAAFNKEX1hdSWCS3mRMv4FlFaNslaD"></div>
	  </div>
          <input type="hidden" name="ml-submit" value="1">
          <div class="ml-form-embedSubmit">
            <button type="submit" class="primary">Subscribe</button>
            <button disabled="disabled" style="display: none;" type="button" class="loading">
              <div class="ml-form-embedSubmitLoad"></div>
              <span class="sr-only">Loading...</span>
            </button>
          </div>
          <input type="hidden" name="anticsrf" value="true">
        </form>
      </div>
      <div class="ml-form-successBody row-success" style="display: none">
        <div class="ml-form-successContent">
          <h3>Thanks :)</h3>
          <p>You're in.</p>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  function ml_webform_success_3175296() {
      var $ = ml_jQuery || jQuery;
      $('.ml-subscribe-form-3175296 .row-success').show();
      $('.ml-subscribe-form-3175296 .row-form').hide();
  }
</script>
<script src="https://groot.mailerlite.com/js/w/webforms.min.js?v300817f630ad0e957914d0b28a2b6d78" type="text/javascript"></script>

	  </div>
	  <div class="row" style="margin-bottom: 25px">
	    <small>Having trouble subscribing? <a href="mailto:phil@eatonphil.com">Let me know</a>.</small>
	  </div>
	</div>
      </div>
    </footer>
    <script async onload="loadGA()" src="https://www.googletagmanager.com/gtag/js?id=UA-58109156-2"></script>
    <script>
      function loadGA() {
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());
	  gtag('config', 'UA-58109156-2');
      }
    </script>
    <script defer src="https://cdn.usefathom.com/script.js" data-site="CEPUOLOQ"></script>
  </body>
</html>
