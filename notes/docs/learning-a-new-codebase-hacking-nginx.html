<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="canonical" href="https://notes.eatonphil.com/learning-a-new-codebase-hacking-nginx.html">
    <title>Learning a new codebase: hacking on nginx | notes.eatonphil.com</title>
    <meta name="description" content="Learning a new codebase: hacking on nginx" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" href="/rss.xml" />
  </head>
  <body>
    <header>
      <!-- <div class="lfw"> -->
      <!-- 	<div class="container"> -->
      <!-- 	  <div class="row"> -->
      <!-- 	    <a href="https://eatonphil.com/hire-me.html">Hire me!</a> -->
      <!-- 	  </div> -->
      <!-- 	</div> -->
      <!-- </div> -->
      <div class="container">
        <div>
          <div class="row">
	    <div>
	      <a href="https://eatonphil.com" class="sm-link">
		Home
              </a>
	      <a href="/" class="sm-link">
		Notes
              </a>
	      <a href="/favorites.html" class="sm-link hide-mobile">
		Popular
              </a>
	      <a href="/rss.xml" class="sm-link">
		RSS
              </a>
	    </div>
	    	      
	    <div class="subscribe">
	      <a href="https://eatonphil.com/hire-me.html">Hire me</a>
	      <a class="fancy" href="https://notes.eatonphil.com/learning-a-new-codebase-hacking-nginx.html#subscribe">       
		Subscribe          
	      </a>
            </div>
	  </div>
	  <hr />
	  <div class="">
            <h2>April 4, 2021</h2>
            <h1>Learning a new codebase: hacking on nginx</h1>
            <div class="row" style="padding-bottom: 5px">
              <div class="tags"><a href="/tags/hacking.html" class="tag">hacking</a><a href="/tags/nginx.html" class="tag">nginx</a><a href="/tags/c.html" class="tag">c</a></div>
            </div>
	  </div>
	</div>
      </div>
    </header>
    <div class="container">
      <div class="col-6">
        <p>I have never contributed to nginx. My C skills are 1/10. But
downloading the source, hacking it up, compiling it, and running it
doesn't scare me. This post is to help you overcome your own fears
about doing so. Not necessarily because you should be running
out-of-tree diffs in production but because I see a lot of developers
never even consider looking at the source of a big tool or dependency
they use.</p>
<p>Most of all, studying mature software projects is one of the best ways
to grow as a programmer.</p>
<h3 id="source-and-build">Source and build</h3><p>At a high-level, the steps for hacking on software projects are always
the same:</p>
<ol>
<li>Find/download the source code</li>
<li>Install necessary dependency libraries/compilers</li>
<li>Start grepping around based on something you see in the output or capabilities you know exist</li>
<li>Make a change</li>
<li>Run some variation of <code>./configure && make</code> to build</li>
<li>Run the program</li>
<li>Go back to step 4 until you're happy</li>
</ol>
<h3 id="nginx">nginx</h3><p>Let's follow these steps for nginx. We google <code>nginx github</code>
to learn that there's a read-only copy of the source on
<a href="https://github.com/nginx/nginx">Github</a>.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>mkdir<span class="w"> </span>~/vendor
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>~/vendor
$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/nginx/nginx
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>nginx
</pre></div>
<p>There's no readme, bummer. We google <code>nginx build from
source</code> and find
<a href="http://nginx.org/en/docs/configure.html">this</a>. We see it's a typical
C project that builds exactly as guessed: <code>./configure &&
make</code>. And it doesn't look like it has any third-party
dependencies besides my C compiler.</p>
<p>Install autoconf, gmake, and a C compiler. There's no <code>./configure</code>
file in this directory but notice there is a <code>configure</code> file in
<code>auto</code>. Trying <code>cd auto &amp;&amp; ./configure</code> crashes so let's try
<code>./auto/configure</code>. That seems to do it except for the warning:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>./auto/configure
...
./auto/configure:<span class="w"> </span>error:<span class="w"> </span>the<span class="w"> </span>HTTP<span class="w"> </span>rewrite<span class="w"> </span>module<span class="w"> </span>requires<span class="w"> </span>the<span class="w"> </span>PCRE<span class="w"> </span>library.
You<span class="w"> </span>can<span class="w"> </span>either<span class="w"> </span>disable<span class="w"> </span>the<span class="w"> </span>module<span class="w"> </span>by<span class="w"> </span>using<span class="w"> </span>--without-http_rewrite_module
option,<span class="w"> </span>or<span class="w"> </span>install<span class="w"> </span>the<span class="w"> </span>PCRE<span class="w"> </span>library<span class="w"> </span>into<span class="w"> </span>the<span class="w"> </span>system,<span class="w"> </span>or<span class="w"> </span>build<span class="w"> </span>the<span class="w"> </span>PCRE<span class="w"> </span>library
statically<span class="w"> </span>from<span class="w"> </span>the<span class="w"> </span><span class="nb">source</span><span class="w"> </span>with<span class="w"> </span>nginx<span class="w"> </span>by<span class="w"> </span>using<span class="w"> </span>--with-pcre<span class="o">=</span>&lt;path&gt;<span class="w"> </span>option.
</pre></div>
<p>Run <code>./auto/configure --without-http_rewrite_module</code>. And then again
when that fails but also omitting <code>http_gzip_module</code>.</p>
<p>Ok autoconfigure is done. Now we've got a Makefile. Run <code>make -j</code> to
compile using all cores.</p>
<p>Run <code>git status</code> to see where the binary was placed. Run <code>ls objs</code> and
there it is, great:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>ls<span class="w"> </span>objs
autoconf.err<span class="w">  </span>nginx<span class="w">    </span>ngx_auto_config.h<span class="w">   </span>ngx_modules.c<span class="w">  </span>src
Makefile<span class="w">      </span>nginx.8<span class="w">  </span>ngx_auto_headers.h<span class="w">  </span>ngx_modules.o
</pre></div>
<h3 id="the-hack">The hack</h3><p>We want a simple <code>dump</code> command that will return a literal string in a
<code>location</code> block. So something like this:</p>
<div class="highlight"><pre><span></span>$ diff --git a/conf/nginx.conf b/conf/nginx.conf
<span class="gh">index 29bc085f..e96e817f 100644</span>
<span class="gd">--- a/conf/nginx.conf</span>
<span class="gi">+++ b/conf/nginx.conf</span>

<span class="gu">@@ -41,8 +41,7 @@ http {</span>
#access_log  logs/host.access.log  main;

location / {
<span class="gd">-            root   html;</span>
<span class="gd">-            index  index.html index.htm;</span>
<span class="gi">+            dump &#39;It was a good Thursday.&#39;;</span>
<span class="w"> </span>        }

<span class="w"> </span>        #error_page  404              /404.html;
}
</pre></div>
<p>Now that we've built nginx we can use the <code>-t</code> flag to test the
validity of this config:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>./objs/nginx<span class="w"> </span>-t<span class="w"> </span>-c<span class="w"> </span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/conf/nginx.conf
nginx:<span class="w"> </span><span class="o">[</span>alert<span class="o">]</span><span class="w"> </span>could<span class="w"> </span>not<span class="w"> </span>open<span class="w"> </span>error<span class="w"> </span>log<span class="w"> </span>file:<span class="w"> </span>open<span class="o">()</span><span class="w"> </span><span class="s2">&quot;/usr/local/nginx/logs/error.log&quot;</span><span class="w"> </span>failed<span class="w"> </span><span class="o">(</span><span class="m">2</span>:<span class="w"> </span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory<span class="o">)</span>
<span class="m">2021</span>/04/04<span class="w"> </span><span class="m">21</span>:24:09<span class="w"> </span><span class="o">[</span>emerg<span class="o">]</span><span class="w"> </span><span class="m">1030951</span><span class="c1">#0: unknown directive &quot;dump&quot; in /home/phil/vendor/nginx/conf/nginx.conf:44</span>
nginx:<span class="w"> </span>configuration<span class="w"> </span>file<span class="w"> </span>/home/phil/vendor/nginx/conf/nginx.conf<span class="w"> </span><span class="nb">test</span><span class="w"> </span>failed
</pre></div>
<p>And now we've got something to go on! Clearly we have to register this
directive and the log gives us enough info to start grepping:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>--no-pager<span class="w"> </span>grep<span class="w"> </span><span class="s1">&#39;unknown directive&#39;</span>
src/core/ngx_conf_file.c:<span class="w">                       </span><span class="s2">&quot;unknown directive \&quot;%s\&quot;&quot;</span>,<span class="w"> </span>name-&gt;data<span class="o">)</span><span class="p">;</span>
</pre></div>
<p>The case that has this failing comes from line 463: <code>rv = cmd-&gt;set(cf, cmd, conf)</code>. So let's see what this <code>set</code> does. <code>git grep set</code> is useless. Let's try finding out what <code>cmd</code> is so we can locate the struct that has <code>set</code> on it. Ah it's an <code>ngx_command_t</code>. Since it doesn't have <code>struct</code> behind it it means it's typedef-ed and will likely have a <code>;</code> after it. So <code>git grep ngx_command_t\;</code> finds us:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>--no-pager<span class="w"> </span>grep<span class="w"> </span>ngx_command_t<span class="se">\;</span>
src/core/ngx_core.h:typedef<span class="w"> </span>struct<span class="w"> </span>ngx_command_s<span class="w">         </span>ngx_command_t<span class="p">;</span>
</pre></div>
<p>Which means the implementation is hidden, so grep for ngx_command_s:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>--no-pager<span class="w"> </span>grep<span class="w"> </span>ngx_command_s
src/core/ngx_conf_file.h:struct<span class="w"> </span>ngx_command_s<span class="w"> </span><span class="o">{</span>
src/core/ngx_core.h:typedef<span class="w"> </span>struct<span class="w"> </span>ngx_command_s<span class="w">         </span>ngx_command_t<span class="p">;</span>
</pre></div>
<p>Ok this is going nowhere. Different approach. What command did we remove?</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>--no-pager<span class="w"> </span>diff
diff<span class="w"> </span>--git<span class="w"> </span>a/conf/nginx.conf<span class="w"> </span>b/conf/nginx.conf
index<span class="w"> </span>29bc085f..e96e817f<span class="w"> </span><span class="m">100644</span>
---<span class="w"> </span>a/conf/nginx.conf
+++<span class="w"> </span>b/conf/nginx.conf
@@<span class="w"> </span>-41,8<span class="w"> </span>+41,7<span class="w"> </span>@@<span class="w"> </span>http<span class="w"> </span><span class="o">{</span>
<span class="w">         </span><span class="c1">#access_log  logs/host.access.log  main;</span>

<span class="w">         </span>location<span class="w"> </span>/<span class="w"> </span><span class="o">{</span>
-<span class="w">            </span>root<span class="w">   </span>html<span class="p">;</span>
-<span class="w">            </span>index<span class="w">  </span>index.html<span class="w"> </span>index.htm<span class="p">;</span>
+<span class="w">            </span>dump<span class="w"> </span><span class="s1">&#39;It was a good Thursday.&#39;</span><span class="p">;</span>
<span class="w">         </span><span class="o">}</span>

<span class="w">         </span><span class="c1">#error_page  404              /404.html;</span>
</pre></div>
<p><code>root</code> is a command. Maybe we can copy that.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>--no-pager<span class="w"> </span>grep<span class="w"> </span><span class="se">\&quot;</span>root<span class="se">\&quot;</span>
docs/xml/nginx/changes.xml:in<span class="w"> </span>the<span class="w"> </span><span class="s2">&quot;root&quot;</span><span class="w"> </span>or<span class="w"> </span><span class="s2">&quot;auth_basic_user_file&quot;</span><span class="w"> </span>directives.
docs/xml/nginx/changes.xml:a<span class="w"> </span>request<span class="w"> </span>was<span class="w"> </span>handled<span class="w"> </span>incorrectly,<span class="w"> </span><span class="k">if</span><span class="w"> </span>a<span class="w"> </span><span class="s2">&quot;root&quot;</span><span class="w"> </span>directive<span class="w"> </span>used<span class="w"> </span>variables<span class="p">;</span>
docs/xml/nginx/changes.xml:the<span class="w"> </span><span class="nv">$document_root</span><span class="w"> </span>variable<span class="w"> </span>usage<span class="w"> </span><span class="k">in</span><span class="w"> </span>the<span class="w"> </span><span class="s2">&quot;root&quot;</span><span class="w"> </span>and<span class="w"> </span><span class="s2">&quot;alias&quot;</span><span class="w"> </span>directives
docs/xml/nginx/changes.xml:the<span class="w"> </span><span class="nv">$document_root</span><span class="w"> </span>variable<span class="w"> </span>did<span class="w"> </span>not<span class="w"> </span>support<span class="w"> </span>the<span class="w"> </span>variables<span class="w"> </span><span class="k">in</span><span class="w"> </span>the<span class="w"> </span><span class="s2">&quot;root&quot;</span>
docs/xml/nginx/changes.xml:if<span class="w"> </span>a<span class="w"> </span><span class="s2">&quot;root&quot;</span><span class="w"> </span>was<span class="w"> </span>specified<span class="w"> </span>by<span class="w"> </span>variable<span class="w"> </span>only,<span class="w"> </span><span class="k">then</span><span class="w"> </span>the<span class="w"> </span>root<span class="w"> </span>was<span class="w"> </span>relative
src/http/ngx_http_core_module.c:<span class="w">    </span><span class="o">{</span><span class="w"> </span>ngx_string<span class="o">(</span><span class="s2">&quot;root&quot;</span><span class="o">)</span>,
src/http/ngx_http_core_module.c:<span class="w">                           </span><span class="p">&amp;</span>cmd-&gt;name,<span class="w"> </span>clcf-&gt;alias<span class="w"> </span>?<span class="w"> </span><span class="s2">&quot;alias&quot;</span><span class="w"> </span>:<span class="w"> </span><span class="s2">&quot;root&quot;</span><span class="o">)</span><span class="p">;</span>
</pre></div>
<p>That looks more promising. Let's copy that:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>--no-pager<span class="w"> </span>diff<span class="w"> </span>src/http/
diff<span class="w"> </span>--git<span class="w"> </span>a/src/http/ngx_http_core_module.c<span class="w"> </span>b/src/http/ngx_http_core_module.c<span class="w">             </span>index<span class="w"> </span>9b94b328..17a64e80<span class="w"> </span><span class="m">100644</span><span class="w">                                                            </span>---<span class="w"> </span>a/src/http/ngx_http_core_module.c<span class="w">                                                      </span>+++<span class="w"> </span>b/src/http/ngx_http_core_module.c<span class="w">                                                      </span>@@<span class="w"> </span>-331,6<span class="w"> </span>+331,14<span class="w"> </span>@@<span class="w"> </span>static<span class="w"> </span>ngx_command_t<span class="w">  </span>ngx_http_core_commands<span class="o">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">       </span><span class="m">0</span>,
<span class="w">       </span>NULL<span class="w"> </span><span class="o">}</span>,
+<span class="w">    </span><span class="o">{</span><span class="w"> </span>ngx_string<span class="o">(</span><span class="s2">&quot;dump&quot;</span><span class="o">)</span>,
+<span class="w">      </span>NGX_HTTP_MAIN_CONF<span class="p">|</span>NGX_HTTP_SRV_CONF<span class="p">|</span>NGX_HTTP_LOC_CONF<span class="p">|</span>NGX_HTTP_LIF_CONF
+<span class="w">                        </span><span class="p">|</span>NGX_CONF_TAKE1,
+<span class="w">      </span>ngx_http_core_dump,
+<span class="w">      </span>NGX_HTTP_LOC_CONF_OFFSET,
+<span class="w">      </span><span class="m">0</span>,
+<span class="w">      </span>NULL<span class="w"> </span><span class="o">}</span>,
+
<span class="w">     </span><span class="o">{</span><span class="w"> </span>ngx_string<span class="o">(</span><span class="s2">&quot;alias&quot;</span><span class="o">)</span>,
<span class="w">       </span>NGX_HTTP_LOC_CONF<span class="p">|</span>NGX_CONF_TAKE1,
<span class="w">       </span>ngx_http_core_root,
</pre></div>
<p>Ok so this is how a command is registered. It obviously won't build without <code>ngx_http_core_dump</code> so let's implement that by copying/renaming <code>ngx_http_core_root</code>:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>--no-pager<span class="w"> </span>diff<span class="w"> </span>src
diff<span class="w"> </span>--git<span class="w"> </span>a/src/http/ngx_http_core_module.c<span class="w"> </span>b/src/http/ngx_http_core_module.c
index<span class="w"> </span>9b94b328..c184dab5<span class="w"> </span><span class="m">100644</span>
---<span class="w"> </span>a/src/http/ngx_http_core_module.c
+++<span class="w"> </span>b/src/http/ngx_http_core_module.c
@@<span class="w"> </span>-4402,6<span class="w"> </span>+4410,16<span class="w"> </span>@@<span class="w"> </span>ngx_http_core_root<span class="o">(</span>ngx_conf_t<span class="w"> </span>*cf,<span class="w"> </span>ngx_command_t<span class="w"> </span>*cmd,<span class="w"> </span>void<span class="w"> </span>*conf<span class="o">)</span>
<span class="o">}</span>


+static<span class="w"> </span>char<span class="w"> </span>*
+ngx_http_core_dump<span class="o">(</span>ngx_conf_t<span class="w"> </span>*cf,<span class="w"> </span>ngx_command_t<span class="w"> </span>*cmd,<span class="w"> </span>void<span class="w"> </span>*conf<span class="o">)</span>
+<span class="o">{</span>
+<span class="w">    </span>ngx_http_core_loc_conf_t<span class="w"> </span>*clcf<span class="w"> </span><span class="o">=</span><span class="w"> </span>conf<span class="p">;</span>
+<span class="w">    </span>ngx_str_t<span class="w"> </span>*value<span class="w"> </span><span class="o">=</span><span class="w"> </span>cf-&gt;args-&gt;elts<span class="p">;</span>
+<span class="w">    </span>clcf-&gt;dump<span class="w"> </span><span class="o">=</span><span class="w"> </span>value<span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="p">;</span>
+<span class="w">    </span><span class="k">return</span><span class="w"> </span>NGX_CONF_OK<span class="p">;</span>
+<span class="o">}</span>
+
+
static<span class="w"> </span>ngx_http_method_name_t<span class="w">  </span>ngx_methods_names<span class="o">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">     </span><span class="o">{</span><span class="w"> </span><span class="o">(</span>u_char<span class="w"> </span>*<span class="o">)</span><span class="w"> </span><span class="s2">&quot;GET&quot;</span>,<span class="w">       </span><span class="o">(</span>uint32_t<span class="o">)</span><span class="w"> </span>~NGX_HTTP_GET<span class="w"> </span><span class="o">}</span>,
<span class="w">     </span><span class="o">{</span><span class="w"> </span><span class="o">(</span>u_char<span class="w"> </span>*<span class="o">)</span><span class="w"> </span><span class="s2">&quot;HEAD&quot;</span>,<span class="w">      </span><span class="o">(</span>uint32_t<span class="o">)</span><span class="w"> </span>~NGX_HTTP_HEAD<span class="w"> </span><span class="o">}</span>,
</pre></div>
<p>The goal here is to just store the dump string on this conf
object. Then while serving the request we can check if this is set and
if so, respond to the request with this string.</p>
<p>This still clearly won't build because we didn't modify this conf
object. But let's run <code>make</code> anyway.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>make<span class="w"> </span>-f<span class="w"> </span>objs/Makefile
make<span class="o">[</span><span class="m">1</span><span class="o">]</span>:<span class="w"> </span>Entering<span class="w"> </span>directory<span class="w"> </span><span class="s1">&#39;/home/phil/vendor/nginx&#39;</span>
cc<span class="w"> </span>-c<span class="w"> </span>-pipe<span class="w">  </span>-O<span class="w"> </span>-W<span class="w"> </span>-Wall<span class="w"> </span>-Wpointer-arith<span class="w"> </span>-Wno-unused-parameter<span class="w"> </span>-Werror<span class="w"> </span>-g<span class="w">  </span>-I<span class="w"> </span>src/core<span class="w"> </span>-I<span class="w"> </span>src/event<span class="w"> </span>-I<span class="w"> </span>src/event/modules<span class="w"> </span>-I<span class="w"> </span>src/os/unix<span class="w"> </span>-I<span class="w"> </span>objs<span class="w"> </span>-I<span class="w"> </span>src/http<span class="w"> </span>-I<span class="w"> </span>src/http/modules<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-o<span class="w"> </span>objs/src/http/ngx_http_core_module.o<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>src/http/ngx_http_core_module.c
src/http/ngx_http_core_module.c:337:7:<span class="w"> </span>error:<span class="w"> </span>ngx_http_core_dump<span class="w"> </span>undeclared<span class="w"> </span>here<span class="w"> </span><span class="o">(</span>not<span class="w"> </span><span class="k">in</span><span class="w"> </span>a<span class="w"> </span><span class="k">function</span><span class="o">)</span><span class="p">;</span><span class="w"> </span>did<span class="w"> </span>you<span class="w"> </span>mean<span class="w"> </span>ngx_http_core_type?
<span class="m">337</span><span class="w"> </span><span class="p">|</span><span class="w">       </span>ngx_http_core_dump,
<span class="w">    </span><span class="p">|</span><span class="w">       </span>^~~~~~~~~~~~~~~~~~~~~
<span class="w">    </span><span class="p">|</span><span class="w">       </span>ngx_http_core_type
src/http/ngx_http_core_module.c:<span class="w"> </span>In<span class="w"> </span><span class="k">function</span><span class="w"> </span>ngx_http_core_dump:
src/http/ngx_http_core_module.c:4418:9:<span class="w"> </span>error:<span class="w"> </span>ngx_http_core_loc_conf_t<span class="w"> </span><span class="o">{</span>aka<span class="w"> </span>struct<span class="w"> </span>ngx_http_core_loc_conf_s<span class="o">}</span><span class="w"> </span>has<span class="w"> </span>no<span class="w"> </span>member<span class="w"> </span>named<span class="w"> </span>dump
<span class="m">4418</span><span class="w"> </span><span class="p">|</span><span class="w">     </span>clcf-&gt;dump<span class="w"> </span><span class="o">=</span><span class="w"> </span>value<span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="p">;</span>
<span class="w">     </span><span class="p">|</span><span class="w">         </span>^~
src/http/ngx_http_core_module.c:4418:5:<span class="w"> </span>error:<span class="w"> </span>statement<span class="w"> </span>with<span class="w"> </span>no<span class="w"> </span>effect<span class="w"> </span><span class="o">[</span>-Werror<span class="o">=</span>unused-value<span class="o">]</span>
<span class="m">4418</span><span class="w"> </span><span class="p">|</span><span class="w">     </span>clcf-&gt;dump<span class="w"> </span><span class="o">=</span><span class="w"> </span>value<span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="p">;</span>
<span class="w">     </span><span class="p">|</span><span class="w">     </span>^~~~
At<span class="w"> </span>top<span class="w"> </span>level:
src/http/ngx_http_core_module.c:4414:1:<span class="w"> </span>error:<span class="w"> </span>ngx_http_core_dump<span class="w"> </span>defined<span class="w"> </span>but<span class="w"> </span>not<span class="w"> </span>used<span class="w"> </span><span class="o">[</span>-Werror<span class="o">=</span>unused-function<span class="o">]</span>
<span class="m">4414</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>ngx_http_core_dump<span class="o">(</span>ngx_conf_t<span class="w"> </span>*cf,<span class="w"> </span>ngx_command_t<span class="w"> </span>*cmd,<span class="w"> </span>void<span class="w"> </span>*conf<span class="o">)</span>
<span class="w">     </span><span class="p">|</span><span class="w"> </span>^~~~~~~~~~~~~~~~~~~~~
cc1:<span class="w"> </span>all<span class="w"> </span>warnings<span class="w"> </span>being<span class="w"> </span>treated<span class="w"> </span>as<span class="w"> </span>errors
make<span class="o">[</span><span class="m">1</span><span class="o">]</span>:<span class="w"> </span>***<span class="w"> </span><span class="o">[</span>objs/Makefile:834:<span class="w"> </span>objs/src/http/ngx_http_core_module.o<span class="o">]</span><span class="w"> </span>Error<span class="w"> </span><span class="m">1</span>
make<span class="o">[</span><span class="m">1</span><span class="o">]</span>:<span class="w"> </span>Leaving<span class="w"> </span>directory<span class="w"> </span><span class="s1">&#39;/home/phil/vendor/nginx&#39;</span>
make:<span class="w"> </span>***<span class="w"> </span><span class="o">[</span>Makefile:10:<span class="w"> </span>build<span class="o">]</span><span class="w"> </span>Error<span class="w"> </span><span class="m">2</span>
</pre></div>
<p>The dump handler is undeclared. While copying <code>ngx_http_core_root</code> earlier I saw that there was a forward declaration toward the top. Let's copy that as well and see if that fixes anything.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>--no-pager<span class="w"> </span>diff
diff<span class="w"> </span>--git<span class="w"> </span>a/src/http/ngx_http_core_module.c<span class="w"> </span>b/src/http/ngx_http_core_module.c
index<span class="w"> </span>9b94b328..430e1256<span class="w"> </span><span class="m">100644</span>
---<span class="w"> </span>a/src/http/ngx_http_core_module.c
+++<span class="w"> </span>b/src/http/ngx_http_core_module.c
@@<span class="w"> </span>-56,6<span class="w"> </span>+56,7<span class="w"> </span>@@<span class="w"> </span>static<span class="w"> </span>char<span class="w"> </span>*ngx_http_core_listen<span class="o">(</span>ngx_conf_t<span class="w"> </span>*cf,<span class="w"> </span>ngx_command_t<span class="w"> </span>*cmd,
static<span class="w"> </span>char<span class="w"> </span>*ngx_http_core_server_name<span class="o">(</span>ngx_conf_t<span class="w"> </span>*cf,<span class="w"> </span>ngx_command_t<span class="w"> </span>*cmd,
<span class="w">    </span>void<span class="w"> </span>*conf<span class="o">)</span><span class="p">;</span>
static<span class="w"> </span>char<span class="w"> </span>*ngx_http_core_root<span class="o">(</span>ngx_conf_t<span class="w"> </span>*cf,<span class="w"> </span>ngx_command_t<span class="w"> </span>*cmd,<span class="w"> </span>void<span class="w"> </span>*conf<span class="o">)</span><span class="p">;</span>
+static<span class="w"> </span>char<span class="w"> </span>*ngx_http_core_dump<span class="o">(</span>ngx_conf_t<span class="w"> </span>*cf,<span class="w"> </span>ngx_command_t<span class="w"> </span>*cmd,<span class="w"> </span>void<span class="w"> </span>*conf<span class="o">)</span><span class="p">;</span>
<span class="w"> </span>static<span class="w"> </span>char<span class="w"> </span>*ngx_http_core_limit_except<span class="o">(</span>ngx_conf_t<span class="w"> </span>*cf,<span class="w"> </span>ngx_command_t<span class="w"> </span>*cmd,
<span class="w">    </span>void<span class="w"> </span>*conf<span class="o">)</span><span class="p">;</span>
<span class="w"> </span>static<span class="w"> </span>char<span class="w"> </span>*ngx_http_core_set_aio<span class="o">(</span>ngx_conf_t<span class="w"> </span>*cf,<span class="w"> </span>ngx_command_t<span class="w"> </span>*cmd,
</pre></div>
<p>And build:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>make
make<span class="w"> </span>-f<span class="w"> </span>objs/Makefile
make<span class="o">[</span><span class="m">1</span><span class="o">]</span>:<span class="w"> </span>Entering<span class="w"> </span>directory<span class="w"> </span><span class="s1">&#39;/home/phil/vendor/nginx&#39;</span>
cc<span class="w"> </span>-c<span class="w"> </span>-pipe<span class="w">  </span>-O<span class="w"> </span>-W<span class="w"> </span>-Wall<span class="w"> </span>-Wpointer-arith<span class="w"> </span>-Wno-unused-parameter<span class="w"> </span>-Werror<span class="w"> </span>-g<span class="w">  </span>-I<span class="w"> </span>src/core<span class="w"> </span>-I<span class="w"> </span>src/event<span class="w"> </span>-I<span class="w"> </span>src/event/modules<span class="w"> </span>-I<span class="w"> </span>src/os/unix<span class="w"> </span>-I<span class="w"> </span>objs<span class="w"> </span>-I<span class="w"> </span>src/http<span class="w"> </span>-I<span class="w"> </span>src/http/modules<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-o<span class="w"> </span>objs/src/http/ngx_http_core_module.o<span class="w"> </span><span class="se">\</span>
src/http/ngx_http_core_module.c
src/http/ngx_http_core_module.c:<span class="w"> </span>In<span class="w"> </span><span class="k">function</span><span class="w"> </span>ngx_http_core_dump:
src/http/ngx_http_core_module.c:4419:9:<span class="w"> </span>error:<span class="w"> </span>ngx_http_core_loc_conf_t<span class="w"> </span><span class="o">{</span>aka<span class="w"> </span>struct<span class="w"> </span>ngx_http_core_loc_conf_s<span class="o">}</span><span class="w"> </span>has<span class="w"> </span>no<span class="w"> </span>member<span class="w"> </span>named<span class="w"> </span>dump
<span class="m">4419</span><span class="w"> </span><span class="p">|</span><span class="w">     </span>clcf-&gt;dump<span class="w"> </span><span class="o">=</span><span class="w"> </span>value<span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="p">;</span>
<span class="w">     </span><span class="p">|</span><span class="w">         </span>^~
make<span class="o">[</span><span class="m">1</span><span class="o">]</span>:<span class="w"> </span>***<span class="w"> </span><span class="o">[</span>objs/Makefile:834:<span class="w"> </span>objs/src/http/ngx_http_core_module.o<span class="o">]</span><span class="w"> </span>Error<span class="w"> </span><span class="m">1</span>
make<span class="o">[</span><span class="m">1</span><span class="o">]</span>:<span class="w"> </span>Leaving<span class="w"> </span>directory<span class="w"> </span><span class="s1">&#39;/home/phil/vendor/nginx&#39;</span>
make:<span class="w"> </span>***<span class="w"> </span><span class="o">[</span>Makefile:10:<span class="w"> </span>build<span class="o">]</span><span class="w"> </span>Error<span class="w"> </span><span class="m">2</span>
</pre></div>
<p>Perfect. Now let's add <code>dump</code> as a member to this conf object.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>--no-pager<span class="w"> </span>grep<span class="w"> </span>ngx_http_core_loc_conf_t<span class="se">\;</span>
src/http/ngx_http_core_module.h:typedef<span class="w"> </span>struct<span class="w"> </span>ngx_http_core_loc_conf_s<span class="w">  </span>ngx_http_core_loc_conf_t<span class="p">;</span>
</pre></div>
<p>Let's just clone the <code>root</code> member:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>diff<span class="w"> </span>--git<span class="w"> </span>a/src/http/ngx_http_core_module.h<span class="w"> </span>b/src/http/ngx_http_core_module.h
index<span class="w"> </span>2aadae7f..6b1b178b<span class="w"> </span><span class="m">100644</span>
---<span class="w"> </span>a/src/http/ngx_http_core_module.h
+++<span class="w"> </span>b/src/http/ngx_http_core_module.h
@@<span class="w"> </span>-333,6<span class="w"> </span>+333,7<span class="w"> </span>@@<span class="w"> </span>struct<span class="w"> </span>ngx_http_core_loc_conf_s<span class="w"> </span><span class="o">{</span>
/*<span class="w"> </span>location<span class="w"> </span>name<span class="w"> </span>length<span class="w"> </span><span class="k">for</span><span class="w"> </span>inclusive<span class="w"> </span>location<span class="w"> </span>with<span class="w"> </span>inherited<span class="w"> </span><span class="nb">alias</span><span class="w"> </span>*/
<span class="w">     </span>size_t<span class="w">        </span>alias<span class="p">;</span>
<span class="w">     </span>ngx_str_t<span class="w">     </span>root<span class="p">;</span><span class="w">                    </span>/*<span class="w"> </span>root,<span class="w"> </span><span class="nb">alias</span><span class="w"> </span>*/
+<span class="w">    </span>ngx_str_t<span class="w">     </span>dump<span class="p">;</span>
<span class="w">     </span>ngx_str_t<span class="w">     </span>post_action<span class="p">;</span>

<span class="w">     </span>ngx_array_t<span class="w">  </span>*root_lengths<span class="p">;</span>
</pre></div>
<p>Run <code>make</code> and it succeeds!</p>
<p>Now we spend a few hours looking around for a good place to add a hook
during a request. Ultimately, <code>ngx_http_core_find_config_phase</code> seems
like a good place since only then will we be dealing with the struct
we added <code>dump</code> to.</p>
<p>Next step is figuring out how to send a response. Grepping for
<code>response</code> isn't super useful, neither is <code>write</code>. But <code>send</code> has some
pretty low-level but obvious behavior.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>--no-pager<span class="w"> </span>grep<span class="w"> </span>send<span class="se">\(</span>
src/mail/ngx_mail.h:void<span class="w"> </span>ngx_mail_send<span class="o">(</span>ngx_event_t<span class="w"> </span>*wev<span class="o">)</span><span class="p">;</span>
src/mail/ngx_mail_auth_http_module.c:<span class="w">    </span><span class="nv">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ngx_send<span class="o">(</span>c,<span class="w"> </span>ctx-&gt;request-&gt;pos,<span class="w"> </span>size<span class="o">)</span><span class="p">;</span><span class="o">)</span>
...
</pre></div>
<p>That second result looks promising. Looking at that file it looks like
we need an object that has a <code>-&gt;data</code> member. In
<code>src/http/ngx_http_core_module.c</code> I noticed that the request object
has a member that looks interesting: <code>r-&gt;connection-&gt;write-&gt;data</code>. And
if we look up the signature we just need to also send <code>ngx_send</code> a
string and a length.</p>
<p>Thankfully we already have that from our <code>dump</code> member. So let's try something simple:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>--no-pager<span class="w"> </span>diff
diff<span class="w"> </span>--git<span class="w"> </span>a/src/http/ngx_http_core_module.c<span class="w"> </span>b/src/http/ngx_http_core_module.c
index<span class="w"> </span>9b94b328..bd58788b<span class="w"> </span><span class="m">100644</span>
---<span class="w"> </span>a/src/http/ngx_http_core_module.c
+++<span class="w"> </span>b/src/http/ngx_http_core_module.c
@@<span class="w"> </span>-989,6<span class="w"> </span>+996,11<span class="w"> </span>@@<span class="w"> </span>ngx_http_core_find_config_phase<span class="o">(</span>ngx_http_request_t<span class="w"> </span>*r,
<span class="w">         </span>ngx_http_finalize_request<span class="o">(</span>r,<span class="w"> </span>NGX_HTTP_REQUEST_ENTITY_TOO_LARGE<span class="o">)</span><span class="p">;</span>
<span class="w">         </span><span class="k">return</span><span class="w"> </span>NGX_OK<span class="p">;</span>
<span class="o">}</span>
+
+<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">(</span>clcf-&gt;dump.len<span class="o">)</span><span class="w"> </span><span class="o">{</span>
+<span class="w">      </span>ngx_send<span class="o">(</span>r-&gt;connection-&gt;write-&gt;data,<span class="w"> </span>clcf-&gt;dump.data,<span class="w"> </span>clcf-&gt;dump.len<span class="o">)</span><span class="p">;</span>
+<span class="w">      </span><span class="k">return</span><span class="w"> </span>NGX_OK<span class="p">;</span>
+<span class="w">    </span><span class="o">}</span>
</pre></div>
<p>Run <code>make</code> and it's good! Let's turn off the nginx daemon and worker processes so it's easier to quit as we're iterating.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>--no-pager<span class="w"> </span>diff<span class="w"> </span>conf/
diff<span class="w"> </span>--git<span class="w"> </span>a/conf/nginx.conf<span class="w"> </span>b/conf/nginx.conf
index<span class="w"> </span>29bc085f..7cce7d65<span class="w"> </span><span class="m">100644</span>
---<span class="w"> </span>a/conf/nginx.conf
+++<span class="w"> </span>b/conf/nginx.conf
@@<span class="w"> </span>-1,4<span class="w"> </span>+1,5<span class="w"> </span>@@
-
+daemon<span class="w"> </span>off<span class="p">;</span>
+master_process<span class="w"> </span>off<span class="p">;</span>
<span class="w"> </span><span class="c1">#user  nobody;</span>
<span class="w"> </span>worker_processes<span class="w">  </span><span class="m">1</span><span class="p">;</span>
</pre></div>
<p>Now run <code>./objs/nginx -c $(pwd)/conf/nginx.conf</code>. Try to curl:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>curl<span class="w"> </span>localhost:2020
curl:<span class="w"> </span><span class="o">(</span><span class="m">1</span><span class="o">)</span><span class="w"> </span>Received<span class="w"> </span>HTTP/0.9<span class="w"> </span>when<span class="w"> </span>not<span class="w"> </span>allowed
</pre></div>
<p>Huh, that's unexpected. Let's try using telnet to get the whole raw
response:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>telnet<span class="w"> </span>localhost<span class="w"> </span><span class="m">2020</span>
Trying<span class="w"> </span>::1...
telnet:<span class="w"> </span>connect<span class="w"> </span>to<span class="w"> </span>address<span class="w"> </span>::1:<span class="w"> </span>Connection<span class="w"> </span>refused
Trying<span class="w"> </span><span class="m">127</span>.0.0.1...
Connected<span class="w"> </span>to<span class="w"> </span>localhost.
Escape<span class="w"> </span>character<span class="w"> </span>is<span class="w"> </span><span class="s1">&#39;^]&#39;</span>.
GET<span class="w"> </span>/
It<span class="w"> </span>was<span class="w"> </span>a<span class="w"> </span>good<span class="w"> </span>Thursday.
</pre></div>
<p>Oh man. That's super cool. Unfortunately it's also not valid HTTP. It
seems like if we're using <code>ngx_send</code> we'll have to set the HTTP
response headers manually.</p>
<p>If we're going to pass a literal string to <code>ngx_send</code> we'll have to
convert it to an <code>ngx_str_t</code>. Judging from <code>src/core/ngx_string.h</code> the
<code>ngx_string</code> macro should be able to do this.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>--no-pager<span class="w"> </span>diff<span class="w"> </span>src
diff<span class="w"> </span>--git<span class="w"> </span>a/src/http/ngx_http_core_module.c<span class="w"> </span>b/src/http/ngx_http_core_module.c
index<span class="w"> </span>9b94b328..1a1baccd<span class="w"> </span><span class="m">100644</span>
---<span class="w"> </span>a/src/http/ngx_http_core_module.c
+++<span class="w"> </span>b/src/http/ngx_http_core_module.c
@@<span class="w"> </span>-989,6<span class="w"> </span>+996,13<span class="w"> </span>@@<span class="w"> </span>ngx_http_core_find_config_phase<span class="o">(</span>ngx_http_request_t<span class="w"> </span>*r,
<span class="w">         </span>ngx_http_finalize_request<span class="o">(</span>r,<span class="w"> </span>NGX_HTTP_REQUEST_ENTITY_TOO_LARGE<span class="o">)</span><span class="p">;</span>
<span class="w">         </span><span class="k">return</span><span class="w"> </span>NGX_OK<span class="p">;</span>
<span class="w">     </span><span class="o">}</span>
+
+<span class="w">    </span>static<span class="w"> </span>ngx_str_t<span class="w"> </span><span class="nv">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ngx_string<span class="o">(</span><span class="s2">&quot;HTTP/1.0 200 OK\r\n\r\n&quot;</span><span class="o">)</span><span class="p">;</span>
+<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">(</span>clcf-&gt;dump.len<span class="o">)</span><span class="w"> </span><span class="o">{</span>
+<span class="w">      </span>ngx_send<span class="o">(</span>r-&gt;connection-&gt;write-&gt;data,<span class="w"> </span>header.data,<span class="w"> </span>header.len<span class="o">)</span><span class="p">;</span>
+<span class="w">      </span>ngx_send<span class="o">(</span>r-&gt;connection-&gt;write-&gt;data,<span class="w"> </span>clcf-&gt;dump.data,<span class="w"> </span>clcf-&gt;dump.len<span class="o">)</span><span class="p">;</span>
+<span class="w">      </span><span class="k">return</span><span class="w"> </span>NGX_OK<span class="p">;</span>
+<span class="w">    </span><span class="o">}</span>

<span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="o">(</span><span class="nv">rc</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>NGX_DONE<span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">         </span>ngx_http_clear_location<span class="o">(</span>r<span class="o">)</span><span class="p">;</span>
<span class="o">}</span>
</pre></div>
<p>Compile, run and curl:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>curl<span class="w"> </span>localhost:2020
</pre></div>
<p>Huh. It's no longer complaining about HTTP/0.9 but it's now
hanging. Let's try verbose curling.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>curl<span class="w"> </span>-vvv<span class="w"> </span>localhost:2020
*<span class="w">   </span>Trying<span class="w"> </span>::1:2020...
*<span class="w"> </span>connect<span class="w"> </span>to<span class="w"> </span>::1<span class="w"> </span>port<span class="w"> </span><span class="m">2020</span><span class="w"> </span>failed:<span class="w"> </span>Connection<span class="w"> </span>refused
*<span class="w">   </span>Trying<span class="w"> </span><span class="m">127</span>.0.0.1:2020...
*<span class="w"> </span>Connected<span class="w"> </span>to<span class="w"> </span>localhost<span class="w"> </span><span class="o">(</span><span class="m">127</span>.0.0.1<span class="o">)</span><span class="w"> </span>port<span class="w"> </span><span class="m">2020</span><span class="w"> </span><span class="o">(</span><span class="c1">#0)</span>
&gt;<span class="w"> </span>GET<span class="w"> </span>/<span class="w"> </span>HTTP/1.1
&gt;<span class="w"> </span>Host:<span class="w"> </span>localhost:2020
&gt;<span class="w"> </span>User-Agent:<span class="w"> </span>curl/7.71.1
&gt;<span class="w"> </span>Accept:<span class="w"> </span>*/*
&gt;
*<span class="w"> </span>Mark<span class="w"> </span>bundle<span class="w"> </span>as<span class="w"> </span>not<span class="w"> </span>supporting<span class="w"> </span>multiuse
*<span class="w"> </span>HTTP<span class="w"> </span><span class="m">1</span>.0,<span class="w"> </span>assume<span class="w"> </span>close<span class="w"> </span>after<span class="w"> </span>body
&lt;<span class="w"> </span>HTTP/1.0<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK
</pre></div>
<p>That's really weird. But I noticed there was a
<code>ngx_http_request_finalize</code> function that other parts of the code were
calling. Let's try adding that.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>--no-pager<span class="w"> </span>diff<span class="w"> </span>src
diff<span class="w"> </span>--git<span class="w"> </span>a/src/http/ngx_http_core_module.c<span class="w"> </span>b/src/http/ngx_http_core_module.c
index<span class="w"> </span>9b94b328..1a1baccd<span class="w"> </span><span class="m">100644</span>
---<span class="w"> </span>a/src/http/ngx_http_core_module.c
+++<span class="w"> </span>b/src/http/ngx_http_core_module.c
@@<span class="w"> </span>-989,6<span class="w"> </span>+996,14<span class="w"> </span>@@<span class="w"> </span>ngx_http_core_find_config_phase<span class="o">(</span>ngx_http_request_t<span class="w"> </span>*r,
<span class="w">         </span>ngx_http_finalize_request<span class="o">(</span>r,<span class="w"> </span>NGX_HTTP_REQUEST_ENTITY_TOO_LARGE<span class="o">)</span><span class="p">;</span>
<span class="w">         </span><span class="k">return</span><span class="w"> </span>NGX_OK<span class="p">;</span>
<span class="w">     </span><span class="o">}</span>
+
+<span class="w">    </span>static<span class="w"> </span>ngx_str_t<span class="w"> </span><span class="nv">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ngx_string<span class="o">(</span><span class="s2">&quot;HTTP/1.0 200 OK\r\n\r\n&quot;</span><span class="o">)</span><span class="p">;</span>
+<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">(</span>clcf-&gt;dump.len<span class="o">)</span><span class="w"> </span><span class="o">{</span>
+<span class="w">      </span>ngx_send<span class="o">(</span>r-&gt;connection-&gt;write-&gt;data,<span class="w"> </span>header.data,<span class="w"> </span>header.len<span class="o">)</span><span class="p">;</span>
+<span class="w">      </span>ngx_send<span class="o">(</span>r-&gt;connection-&gt;write-&gt;data,<span class="w"> </span>clcf-&gt;dump.data,<span class="w"> </span>clcf-&gt;dump.len<span class="o">)</span><span class="p">;</span>
+<span class="w">      </span>ngx_http_finalize_request<span class="o">(</span>r,<span class="w"> </span>NGX_DONE<span class="o">)</span><span class="p">;</span>
+<span class="w">      </span><span class="k">return</span><span class="w"> </span>NGX_OK<span class="p">;</span>
+<span class="w">    </span><span class="o">}</span>
</pre></div>
<p>Build, run, curl. Still hanging. Looking into the source code of
<code>ngx_http_finalize_request</code> it seems like there's a case where the
connection is completely closed if you pass in <code>NGX_HTTP_CLOSE</code>. Let's
try that.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>curl<span class="w"> </span>localhost:2020
It<span class="w"> </span>was<span class="w"> </span>a<span class="w"> </span>good<span class="w"> </span>Thursday.
</pre></div>
<p>Well hot dog, it works.</p>
<h3 id="reflection">Reflection</h3><p>Is this a good way to implement commands in nginx? No. While I knew a
bit about nginx modules as a user it's clear that as a developer this
command could have been implemented much more cleanly as a module too.</p>
<p>There also has to be higher-level tooling for returning constructing
responses rather than writing out headers manually.</p>
<p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">Been wanting to write some posts like this for a long time showing some techniques for hacking on an unfamiliar project using very basic programming/Linux tools. In this post it&#39;s nginx<a href="https://t.co/t7Y43Zmxhk">https://t.co/t7Y43Zmxhk</a> <a href="https://t.co/EOatURm5wx">pic.twitter.com/EOatURm5wx</a></p>&mdash; Phil Eaton (@phil_eaton) <a href="https://twitter.com/phil_eaton/status/1378906317004361732?ref_src=twsrc%5Etfw">April 5, 2021</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<style>.feedback{display:initial;}</style>
	<div class="feedback">
	  <h4>Feedback</h4>
	  <p>As always,
	      please <a href="mailto:phil@eatonphil.com">email</a>
	      or <a href="https://twitter.com/eatonphil">tweet me</a>
	      with questions, corrections, or ideas!</p>

	</div>
      </div>
    </div>
    <footer>
      <div class="container">
	<div>
	  <div class="row">
	    <div class="feedback">
	      <h4>Frequent Topics</h4>
	      <div class="tags"><a href="/tags/javascript.html" class="tag">javascript (24)</a><a href="/tags/parsing.html" class="tag">parsing (21)</a><a href="/tags/databases.html" class="tag">databases (21)</a><a href="/tags/postgres.html" class="tag">postgres (16)</a><a href="/tags/golang.html" class="tag">golang (14)</a><a href="/tags/compilers.html" class="tag">compilers (14)</a><a href="/tags/sql.html" class="tag">sql (11)</a><a href="/tags/interpreters.html" class="tag">interpreters (11)</a><a href="/tags/go.html" class="tag">go (10)</a><a href="/tags/zig.html" class="tag">zig (9)</a><a href="/tags/lisp.html" class="tag">lisp (9)</a><a href="/tags/books.html" class="tag">books (9)</a><a href="/tags/python.html" class="tag">python (8)</a><a href="/tags/management.html" class="tag">management (7)</a><a href="/tags/linux.html" class="tag">linux (7)</a><a href="/tags/json.html" class="tag">json (7)</a><a href="/tags/x86-amd64.html" class="tag">x86/amd64 (6)</a><a href="/tags/scheme.html" class="tag">scheme (6)</a><a href="/tags/learning.html" class="tag">learning (6)</a><a href="/tags/typescript.html" class="tag">typescript (5)</a></div>
	    </div>
	  </div>
	  <div class="row" id="subscribe">
	    <style type="text/css">
  /* LOADER */
  .ml-form-embedSubmitLoad {
      display: inline-block;
      width: 20px;
      height: 20px;
  }
  .g-recaptcha {
      transform: scale(1);
      -webkit-transform: scale(1);
      transform-origin: 0 0;
      -webkit-transform-origin: 0 0;
      height: ;
  }
  .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      border: 0;
  }
  .ml-form-embedSubmitLoad:after {
      content: " ";
      display: block;
      width: 11px;
      height: 11px;
      margin: 1px;
      border-radius: 50%;
      border: 4px solid #fff;
      border-color: #ffffff #ffffff #ffffff transparent;
      animation: ml-form-embedSubmitLoad 1.2s linear infinite;
  }
  @keyframes ml-form-embedSubmitLoad {
      0% {
          transform: rotate(0deg);
      }
      100% {
          transform: rotate(360deg);
      }
  }
  #mlb2-3175296.ml-form-embedContainer {
      box-sizing: border-box;
      display: table;
      margin: 0 auto;
      position: static;
      width: 100% !important;
  }
  #mlb2-3175296.ml-form-embedContainer h3,
  #mlb2-3175296.ml-form-embedContainer p,
  #mlb2-3175296.ml-form-embedContainer span,
  #mlb2-3175296.ml-form-embedContainer button {
      text-transform: none !important;
      letter-spacing: normal !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper {
      border-width: 0px;
      border-color: transparent;
  border-radius: 4px;
  border-style: solid;
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  position: relative;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-align-left { text-align: left; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-align-center {
  text-align: center;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-align-default { display: table-cell !important; vertical-align: middle !important; text-align: center !important; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-align-right { text-align: right; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedHeader img {
  border-top-left-radius: 4px;
  border-top-right-radius: 4px;
  height: auto;
  margin: 0 auto !important;
  max-width: 100%;
  width: undefinedpx;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody.ml-form-embedBodyHorizontal {
  padding-bottom: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent {
  text-align: left;
  margin: 0 0 20px 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent p,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent p {
  color: #000000;
  font-size: 14px;
  font-weight: 400;
  line-height: 20px;
  margin: 0 0 10px 0;
  text-align: left;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent ul,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent ol,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent ul,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent ol {
  color: #000000;
  font-size: 14px;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent ol ol,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent ol ol {
  list-style-type: lower-alpha;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent ol ol ol,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent ol ol ol {
  list-style-type: lower-roman;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent p a,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent p a {
  color: #000000;
  text-decoration: underline;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-block-form .ml-field-group {
  text-align: left!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-block-form .ml-field-group label {
  margin-bottom: 5px;
  color: #333333;
  font-size: 14px;
  font-weight: bold; font-style: normal; text-decoration: none;;
  display: inline-block;
  line-height: 20px;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent p:last-child,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent p:last-child {
  margin: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody form {
  margin: 0;
  width: 100%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-formContent,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow {
  margin: 0 0 20px 0;
  width: 100%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow {
  float: left;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-formContent.horozintalForm {
  margin: 0;
  padding: 0 0 20px 0;
  width: 100%;
  height: auto;
  float: left;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow {
  margin: 0 0 10px 0;
  width: 100%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow.ml-last-item {
  margin: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow.ml-formfieldHorizintal {
  margin: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input {
  background-color: #ffffff !important;
  color: #333333 !important;
  border-color: #cccccc;
  border-radius: 4px !important;
  border-style: solid !important;
  border-width: 1px !important;
  font-size: 14px !important;
  height: auto;
  line-height: 21px !important;
  margin-bottom: 0;
  margin-top: 0;
  margin-left: 0;
  margin-right: 0;
  padding: 10px 10px !important;
  width: 100% !important;
  box-sizing: border-box !important;
  max-width: 100% !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input::-webkit-input-placeholder,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input::-webkit-input-placeholder { color: #333333; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input::-moz-placeholder,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input::-moz-placeholder { color: #333333; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input:-ms-input-placeholder,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input:-ms-input-placeholder { color: #333333; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input:-moz-placeholder,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input:-moz-placeholder { color: #333333; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow textarea, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow textarea {
  background-color: #ffffff !important;
  color: #333333 !important;
  border-color: #cccccc;
  border-radius: 4px !important;
  border-style: solid !important;
  border-width: 1px !important;
  font-size: 14px !important;
  height: auto;
  line-height: 21px !important;
  margin-bottom: 0;
  margin-top: 0;
  padding: 10px 10px !important;
  width: 100% !important;
  box-sizing: border-box !important;
  max-width: 100% !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before {
  border-color: #cccccc!important;
  background-color: #ffffff!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input.custom-control-input[type="checkbox"]{
  box-sizing: border-box;
  padding: 0;
  position: absolute;
  z-index: -1;
  opacity: 0;
  margin-top: 5px;
  margin-left: -1.5rem;
  overflow: visible;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before {
  border-radius: 4px!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow input[type=checkbox]:checked~.label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox input[type=checkbox]:checked~.label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-input:checked~.custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-input:checked~.custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox input[type=checkbox]:checked~.label-description::after {
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23fff' d='M6.564.75l-3.59 3.612-1.538-1.55L0 4.26 2.974 7.25 8 2.193z'/%3e%3c/svg%3e");
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-input:checked~.custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-input:checked~.custom-control-label::after {
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e");
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-input:checked~.custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-input:checked~.custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-input:checked~.custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-input:checked~.custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox input[type=checkbox]:checked~.label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox input[type=checkbox]:checked~.label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow input[type=checkbox]:checked~.label-description::before  {
  border-color: #000000!important;
  background-color: #000000!important;
  color: #ffffff!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label::after {
  top: 2px;
  box-sizing: border-box;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::after {
  top: 0px!important;
  box-sizing: border-box!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::after {
  top: 0px!important;
  box-sizing: border-box!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::after {
  top: 0px!important;
  box-sizing: border-box!important;
  position: absolute;
  left: -1.5rem;
  display: block;
  width: 1rem;
  height: 1rem;
  content: "";
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::before {
  top: 0px!important;
  box-sizing: border-box!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .custom-control-label::before {
  position: absolute;
  top: 4px;
  left: -1.5rem;
  display: block;
  width: 16px;
  height: 16px;
  pointer-events: none;
  content: "";
  background-color: #ffffff;
  border: #adb5bd solid 1px;
  border-radius: 50%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .custom-control-label::after {
  position: absolute;
  top: 2px!important;
  left: -1.5rem;
  display: block;
  width: 1rem;
  height: 1rem;
  content: "";
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before {
  position: absolute;
  top: 4px;
  left: -1.5rem;
  display: block;
  width: 16px;
  height: 16px;
  pointer-events: none;
  content: "";
  background-color: #ffffff;
  border: #adb5bd solid 1px;
  border-radius: 50%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::after {
  position: absolute;
  top: 0px!important;
  left: -1.5rem;
  display: block;
  width: 1rem;
  height: 1rem;
  content: "";
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::after {
  position: absolute;
  top: 0px!important;
  left: -1.5rem;
  display: block;
  width: 1rem;
  height: 1rem;
  content: "";
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .custom-radio .custom-control-label::after {
  background: no-repeat 50%/50% 50%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .custom-checkbox .custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::after {
  background: no-repeat 50%/50% 50%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-control, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-control {
  position: relative;
  display: block;
  min-height: 1.5rem;
  padding-left: 1.5rem;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-input, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-input, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-input, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-input {
  position: absolute;
  z-index: -1;
  opacity: 0;
  box-sizing: border-box;
  padding: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-label, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-label, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label {
  color: #000000;
  font-size: 12px!important;
  line-height: 22px;
  margin-bottom: 0;
  position: relative;
  vertical-align: top;
  font-style: normal;
  font-weight: 700;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-select, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-select {
  background-color: #ffffff !important;
  color: #333333 !important;
  border-color: #cccccc;
  border-radius: 4px !important;
  border-style: solid !important;
  border-width: 1px !important;
  font-size: 14px !important;
  line-height: 20px !important;
  margin-bottom: 0;
  margin-top: 0;
  padding: 10px 28px 10px 12px !important;
  width: 100% !important;
  box-sizing: border-box !important;
  max-width: 100% !important;
  height: auto;
  display: inline-block;
  vertical-align: middle;
  background: url('https://assets.mlcdn.com/ml/images/default/dropdown.svg') no-repeat right .75rem center/8px 10px;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow {
  height: auto;
  width: 100%;
  float: left;
  }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-input-horizontal { width: 70%; float: left; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-button-horizontal { width: 30%; float: left; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-button-horizontal.labelsOn { padding-top: 25px;  }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .horizontal-fields { box-sizing: border-box; float: left; padding-right: 10px;  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input {
  background-color: #ffffff;
  color: #333333;
  border-color: #cccccc;
  border-radius: 4px;
  border-style: solid;
  border-width: 1px;
  font-size: 14px;
  line-height: 20px;
  margin-bottom: 0;
  margin-top: 0;
  padding: 10px 10px;
  width: 100%;
  box-sizing: border-box;
  overflow-y: initial;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow button {
  background-color: #000000 !important;
  border-color: #000000;
  border-style: solid;
  border-width: 1px;
  border-radius: 4px;
  box-shadow: none;
  color: #ffffff !important;
  cursor: pointer;
  font-size: 14px !important;
  font-weight: 700;
  line-height: 20px;
  margin: 0 !important;
  padding: 10px !important;
  width: 100%;
  height: auto;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow button:hover {
  background-color: #333333 !important;
  border-color: #333333 !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow input[type="checkbox"] {
  box-sizing: border-box;
  padding: 0;
  position: absolute;
  z-index: -1;
  opacity: 0;
  margin-top: 5px;
  margin-left: -1.5rem;
  overflow: visible;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description {
  color: #000000;
  display: block;
  font-size: 12px;
  text-align: left;
  margin-bottom: 0;
  position: relative;
  vertical-align: top;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow label {
  font-weight: normal;
  margin: 0;
  padding: 0;
  position: relative;
  display: block;
  min-height: 24px;
  padding-left: 24px;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow label a {
  color: #000000;
  text-decoration: underline;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow label p {
  color: #000000 !important;
  font-size: 12px !important;
  font-weight: normal !important;
  line-height: 18px !important;
  padding: 0 !important;
  margin: 0 5px 0 0 !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow label p:last-child {
  margin: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedSubmit {
  margin: 0 0 20px 0;
  float: left;
  width: 100%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedSubmit button {
  background-color: #000000 !important;
  border: none !important;
  border-radius: 4px !important;
  box-shadow: none !important;
  color: #ffffff !important;
  cursor: pointer;
  font-size: 14px !important;
  font-weight: 700 !important;
  line-height: 21px !important;
  height: auto;
  padding: 10px !important;
  width: 100% !important;
  box-sizing: border-box !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedSubmit button.loading {
  display: none;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedSubmit button:hover {
  background-color: #333333 !important;
  }
  .ml-subscribe-close {
  width: 30px;
  height: 30px;
  background: url('https://assets.mlcdn.com/ml/images/default/modal_close.png') no-repeat;
  background-size: 30px;
  cursor: pointer;
  margin-top: -10px;
  margin-right: -10px;
  position: absolute;
  top: 0;
  right: 0;
  }
  .ml-error input, .ml-error textarea, .ml-error select {
  border-color: red!important;
  }
  .ml-error .custom-checkbox-radio-list {
  border: 1px solid red !important;
  border-radius: 4px;
  padding: 10px;
  }
  .ml-error .label-description,
  .ml-error .label-description p,
  .ml-error .label-description p a,
  .ml-error label:first-child {
  color: #ff0000 !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow.ml-error .label-description p,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow.ml-error .label-description p:first-letter {
  color: #ff0000 !important;
  }
  @media only screen and (max-width: 400px){
  .ml-form-embedWrapper.embedDefault, .ml-form-embedWrapper.embedPopup { width: 100%!important; }
  .ml-form-formContent.horozintalForm { float: left!important; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow { height: auto!important; width: 100%!important; float: left!important; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-input-horizontal { width: 100%!important; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-input-horizontal > div { padding-right: 0px!important; padding-bottom: 10px; }
    .ml-form-formContent.horozintalForm .ml-button-horizontal { width: 100%!important; }
    .ml-form-formContent.horozintalForm .ml-button-horizontal.labelsOn { padding-top: 0px!important; }
    }
</style>
<div id="mlb2-3175296" class="ml-form-embedContainer ml-subscribe-form ml-subscribe-form-3175296">
  <hr />
  <div class="ml-form-align-center ">
    <div class="ml-form-embedWrapper embedForm">
      <div class="ml-form-embedBody ml-form-embedBodyDefault row-form">
        <div class="ml-form-embedContent" style=" ">
          <h4>Subscribe</h4>
          <p>Enter your email if you'd like to be kept in the loop about future articles!<br><br>You can expect 2 to 4 messages per month depending on how motivated I'm feeling. :)</p>
	  <p></p>
	  <p>Cheers,<br>Phil</p>
        </div>
        <form class="ml-block-form" action="https://assets.mailerlite.com/jsonp/303114/forms/78235486326359572/subscribe" data-code="" method="post" target="_blank">
          <div class="ml-form-formContent">
            <div class="ml-form-fieldRow ml-last-item">
              <div class="ml-field-group ml-field-email ml-validate-email ml-validate-required">
                <!-- input -->
                <input aria-label="email" aria-required="true" type="email" class="form-control" data-inputmask="" name="fields[email]" placeholder="Email" autocomplete="email">
                <!-- /input -->
                <!-- textarea -->
                <!-- /textarea -->
                <!-- select -->
                <!-- /select -->
                <!-- checkboxes -->
		<!-- /checkboxes -->
                <!-- radio -->
                <!-- /radio -->
                <!-- countries -->
                <!-- /countries -->
              </div>
            </div>
          </div>
          <!-- Privacy policy -->
          <!-- /Privacy policy -->
	  <div class="ml-form-recaptcha ml-validate-required" style="float: left;">
            <style type="text/css">
	      .ml-form-recaptcha {
		  margin-bottom: 20px;
	      }
	      .ml-form-recaptcha.ml-error iframe {
		  border: solid 1px #ff0000;
	      }
	      @media screen and (max-width: 480px) {
		  .ml-form-recaptcha {
		      width: 220px!important
		  }
		  .g-recaptcha {
		      transform: scale(0.78);
		      -webkit-transform: scale(0.78);
		      transform-origin: 0 0;
		      -webkit-transform-origin: 0 0;
		  }
	      }
	    </style>
	    <script src="https://www.google.com/recaptcha/api.js"></script>
	    <div class="g-recaptcha" data-sitekey="6Lf1KHQUAAAAAFNKEX1hdSWCS3mRMv4FlFaNslaD"></div>
	  </div>
          <input type="hidden" name="ml-submit" value="1">
          <div class="ml-form-embedSubmit">
            <button type="submit" class="primary">Subscribe</button>
            <button disabled="disabled" style="display: none;" type="button" class="loading">
              <div class="ml-form-embedSubmitLoad"></div>
              <span class="sr-only">Loading...</span>
            </button>
          </div>
          <input type="hidden" name="anticsrf" value="true">
        </form>
      </div>
      <div class="ml-form-successBody row-success" style="display: none">
        <div class="ml-form-successContent">
          <h3>Thanks :)</h3>
          <p>You're in.</p>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  function ml_webform_success_3175296() {
      var $ = ml_jQuery || jQuery;
      $('.ml-subscribe-form-3175296 .row-success').show();
      $('.ml-subscribe-form-3175296 .row-form').hide();
  }
</script>
<script src="https://groot.mailerlite.com/js/w/webforms.min.js?v300817f630ad0e957914d0b28a2b6d78" type="text/javascript"></script>

	  </div>
	  <div class="row" style="margin-bottom: 25px">
	    <p>
	      Having trouble subscribing?&nbsp;<a href="mailto:phil@eatonphil.com">Let me know</a>.
	    </p>
	  </div>
	</div>
      </div>
    </footer>
    <script async onload="loadGA()" src="https://www.googletagmanager.com/gtag/js?id=UA-58109156-2"></script>
    <script>
      function loadGA() {
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());
	  gtag('config', 'UA-58109156-2');
      }
    </script>
    <script defer src="https://cdn.usefathom.com/script.js" data-site="CEPUOLOQ"></script>
  </body>
</html>
