<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="canonical" href="https://notes.eatonphil.com/2023-06-19-metaprogramming-in-zig-and-parsing-css.html">
    <title>Metaprogramming in Zig and parsing CSS | notes.eatonphil.com</title>
    <meta name="description" content="Metaprogramming in Zig and parsing CSS" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" href="/rss.xml" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono">

    <script async onload="loadGA()" src="https://www.googletagmanager.com/gtag/js?id=UA-58109156-2"></script>
    <script>
      function loadGA() {
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());
	  gtag('config', 'UA-58109156-2');
      }
    </script>
    <script defer src="https://cdn.usefathom.com/script.js" data-site="CEPUOLOQ"></script>
  </head>
  <body>
    <header>
      <div class="lfw">
	<div class="container">
	  <div class="row">
	    <a href="https://eatonphil.com/2025-holiday-fundraiser.html">2025 Holiday Fundraiser</a>
	  </div>
	</div>
      </div>
      <div class="container">
        <div>
          <div class="row">
	    <div>
	      <a href="https://eatonphil.com" class="sm-link">
		Home
              </a>
	      <a href="/" class="sm-link">
		Blog
              </a>
	      <a href="/rss.xml" class="sm-link">
		RSS
              </a>
	    </div>

	    <div class="subscribe">
	      <!-- <a href="https://eatonphil.com/hire-me.html">Hire me</a> -->
	      <!--
		  Hardcode link to home page because some pages don't
		  have a subscribe box. Some pages hide the subscribe.
		-->
	      <a href="https://eatonphil.com/subscribe.html">
		Subscribe
	      </a>
            </div>
	  </div>
	  <hr />
	  <div class="">
            <h2>June 19, 2023</h2>
            <h1>Metaprogramming in Zig and parsing CSS</h1>
	    
            <div class="row" style="padding-bottom: 5px">
              <div class="tags"><a href="/tags/zig.html" class="tag">zig</a><a href="/tags/parsing.html" class="tag">parsing</a><a href="/tags/css.html" class="tag">css</a></div>
            </div>
	  </div>
	</div>
      </div>
    </header>
    <div class="container">
      <div class="col-6">
	<div class="post">
          <p>I knew Zig supported some sort of reflection on types. But I had been
confused about how to use it. What's the difference between
<code>@typeInfo</code> and <code>@TypeOf</code>? I ignored this aspect of Zig until a
problem came up at <a href="https://tigerbeetle.com">work</a> where reflection
made sense.</p>
<p>The situation was parsing and storing parsed fields in a struct. Each
field name that is parsed should match up to a struct field.</p>
<p>This is a fairly common problem. So this post walks through how to use
Zig's metaprogramming features in a simpler but related domain:
parsing CSS into typed objects, and pretty-printing these typed CSS
objects.</p>
<p>I live-streamed the implementation of this project yesterday on
<a href="https://www.twitch.tv/eatonphil">Twitch</a>. The video is <a href="https://youtube.com/@eatonphil">available on
YouTube</a>. And the source is <a href="https://github.com/eatonphil/zig-metaprogramming-css-parser">available
on GitHub</a>.</p>
<p>If you want to skip the parsing steps and just see the
metaprogramming, jump to the implementation of
<a href="#&lt;code&gt;match_property&lt;/code&gt;">match_property</a>.</p>
<h3 id="parsing-css">Parsing CSS</h3><p>Let's imagine a CSS that only has alphabetical selectors, property
names and values.</p>
<p>The following would be valid:</p>
<div class="highlight"><pre><span></span><span class="nt">div</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">background</span><span class="p">:</span><span class="w"> </span><span class="kc">black</span><span class="p">;</span>
<span class="w">  </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="kc">white</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">a</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="kc">blue</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>Thinking about the structure of this stripped down CSS we've got:</p>
<ol>
<li>CSS properties that consist of property names and values (in our case the property names are limited to <code>background</code> and <code>color</code>)</li>
<li>CSS rules that have a selector and a list of rules</li>
<li>CSS sheets that have a list of rules</li>
</ol>
<p>Turning that into Zig in <code>main.zig</code>:</p>
<div class="highlight"><pre><span></span><span class="kr">const</span><span class="w"> </span><span class="n">std</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">@import</span><span class="p">(</span><span class="s">&quot;std&quot;</span><span class="p">);</span>

<span class="kr">const</span><span class="w"> </span><span class="n">CSSProperty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">union</span><span class="p">(</span><span class="k">enum</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">unknown</span><span class="o">:</span><span class="w"> </span><span class="kt">void</span><span class="p">,</span>
<span class="w">    </span><span class="n">color</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="n">background</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="p">};</span>

<span class="kr">const</span><span class="w"> </span><span class="n">CSSRule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">selector</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="n">properties</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="n">CSSProperty</span><span class="p">,</span>
<span class="p">};</span>

<span class="kr">const</span><span class="w"> </span><span class="n">CSSSheet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">rules</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="n">CSSRule</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
<p>The parser is going to look for CSS rules which contain a selector and
a list of CSS rules. The entrypoint is that simple:</p>
<div class="highlight"><pre><span></span><span class="k">fn</span><span class="w"> </span><span class="n">parse</span><span class="p">(</span>
<span class="w">    </span><span class="n">arena</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">std</span><span class="p">.</span><span class="n">heap</span><span class="p">.</span><span class="n">ArenaAllocator</span><span class="p">,</span>
<span class="w">    </span><span class="n">css</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="o">!</span><span class="n">CSSSheet</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">index</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">ArrayList</span><span class="p">(</span><span class="n">CSSRule</span><span class="p">).</span><span class="n">init</span><span class="p">(</span><span class="n">arena</span><span class="p">.</span><span class="n">allocator</span><span class="p">());</span>

<span class="w">    </span><span class="c1">// Parse rules until EOF.</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">css</span><span class="p">.</span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">var</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">parse_rule</span><span class="p">(</span><span class="n">arena</span><span class="p">,</span><span class="w"> </span><span class="n">css</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">);</span>
<span class="w">        </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="n">rules</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">rule</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// In case there is trailing whitespace before the EOF,</span>
<span class="w">        </span><span class="c1">// eating whitespace here makes sure we exit the loop</span>
<span class="w">        </span><span class="c1">// immediately before trying to parse more rules.</span>
<span class="w">        </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eat_whitespace</span><span class="p">(</span><span class="n">css</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">CSSSheet</span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rules</span><span class="p">.</span><span class="n">items</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="p">}</span>
</pre></div>
<p>Let's implement the <code>eat_whitespace</code> helper we've referenced. It
increments a cursor into the css file while it sees whitespace.</p>
<div class="highlight"><pre><span></span><span class="k">fn</span><span class="w"> </span><span class="n">eat_whitespace</span><span class="p">(</span>
<span class="w">    </span><span class="n">css</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="n">initial_index</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">initial_index</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">css</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">ascii</span><span class="p">.</span><span class="n">isWhitespace</span><span class="p">(</span><span class="n">css</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">index</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">index</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>In our stripped-down version of CSS all we have to think about is
ASCII. So the builtin <code>std.ascii.isWhitespace()</code> function is perfect.</p>
<p>Next, parsing CSS rules.</p>
<h4 id="<code>parse_rule()</code>"><code>parse_rule()</code></h4><p>A rule consists of a selector, opening curly braces, any number of
properties, and closing curly braces. We need to remember to eat
whitespace between each piece of syntax.</p>
<p>And we'll reference a few more parsing helpers we'll talk about next
for the selector, braces, and properties.</p>
<div class="highlight"><pre><span></span><span class="kr">const</span><span class="w"> </span><span class="n">ParseRuleResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">rule</span><span class="o">:</span><span class="w"> </span><span class="n">CSSRule</span><span class="p">,</span>
<span class="w">    </span><span class="n">index</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">fn</span><span class="w"> </span><span class="n">parse_rule</span><span class="p">(</span>
<span class="w">    </span><span class="n">arena</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">std</span><span class="p">.</span><span class="n">heap</span><span class="p">.</span><span class="n">ArenaAllocator</span><span class="p">,</span>
<span class="w">    </span><span class="n">css</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="n">initial_index</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="o">!</span><span class="n">ParseRuleResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eat_whitespace</span><span class="p">(</span><span class="n">css</span><span class="p">,</span><span class="w"> </span><span class="n">initial_index</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// First parse selector(s).</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">selector_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">parse_identifier</span><span class="p">(</span><span class="n">css</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">);</span>
<span class="w">    </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">selector_res</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>

<span class="w">    </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eat_whitespace</span><span class="p">(</span><span class="n">css</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Then parse opening curly brace: {.</span>
<span class="w">    </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">parse_syntax</span><span class="p">(</span><span class="n">css</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;{&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eat_whitespace</span><span class="p">(</span><span class="n">css</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">);</span>

<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">properties</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">ArrayList</span><span class="p">(</span><span class="n">CSSProperty</span><span class="p">).</span><span class="n">init</span><span class="p">(</span><span class="n">arena</span><span class="p">.</span><span class="n">allocator</span><span class="p">());</span>
<span class="w">    </span><span class="c1">// Then parse any number of properties.</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">css</span><span class="p">.</span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eat_whitespace</span><span class="p">(</span><span class="n">css</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">css</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">css</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&#39;}&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kr">var</span><span class="w"> </span><span class="n">attr_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">parse_property</span><span class="p">(</span><span class="n">css</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">);</span>
<span class="w">        </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">attr_res</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>

<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="n">properties</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr_res</span><span class="p">.</span><span class="n">property</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eat_whitespace</span><span class="p">(</span><span class="n">css</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Then parse closing curly brace: }.</span>
<span class="w">    </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">parse_syntax</span><span class="p">(</span><span class="n">css</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;}&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ParseRuleResult</span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CSSRule</span><span class="p">{</span>
<span class="w">            </span><span class="p">.</span><span class="n">selector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">selector_res</span><span class="p">.</span><span class="n">identifier</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">properties</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">properties</span><span class="p">.</span><span class="n">items</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">.</span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">index</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="p">}</span>
</pre></div>
<p>The <code>parse_syntax</code> helper is pretty simple, it does a bounds check and
increments the cursor if the current character matches the one you
pass in.</p>
<div class="highlight"><pre><span></span><span class="k">fn</span><span class="w"> </span><span class="n">parse_syntax</span><span class="p">(</span>
<span class="w">    </span><span class="n">css</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="n">initial_index</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">    </span><span class="n">syntax</span><span class="o">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="o">!</span><span class="kt">usize</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">initial_index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">css</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">css</span><span class="p">[</span><span class="n">initial_index</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">syntax</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">initial_index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">debug_at</span><span class="p">(</span><span class="n">css</span><span class="p">,</span><span class="w"> </span><span class="n">initial_index</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Expected syntax: &#39;{c}&#39;.&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span><span class="n">syntax</span><span class="p">});</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">error</span><span class="p">.</span><span class="n">NoSuchSyntax</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>This calls attention to debugging messages on failure. When we
fail to parse a syntax, we want to give a useful error message and
point at the exact line and column of code where the error happens.</p>
<p>So let's implement <code>debug_at</code>.</p>
<h4 id="<code>debug_at</code>"><code>debug_at</code></h4><p>First, we iterate over the entire CSS source code until we find the
entire line that contains the index where the parser failed. We also
want to identify the exact line and column corresponding to that
index.</p>
<div class="highlight"><pre><span></span><span class="k">fn</span><span class="w"> </span><span class="n">debug_at</span><span class="p">(</span>
<span class="w">    </span><span class="n">css</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="n">index</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">    </span><span class="kr">comptime</span><span class="w"> </span><span class="n">msg</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="n">args</span><span class="o">:</span><span class="w"> </span><span class="n">anytype</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">line_no</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">col_no</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">i</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">line_beginning</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">found_line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">css</span><span class="p">.</span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">css</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="se">&#39;\n&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">found_line</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">col_no</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">                </span><span class="n">line_beginning</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">                </span><span class="n">line_no</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">found_line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">found_line</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">col_no</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
<p>Then we print it all out in a nice format for users (which will likely
just be ourselves).</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Error at line {}, column {}. &quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span><span class="w"> </span><span class="n">line_no</span><span class="p">,</span><span class="w"> </span><span class="n">col_no</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">msg</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span>
<span class="w">    </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;{s}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span><span class="n">css</span><span class="p">[</span><span class="n">line_beginning</span><span class="p">..</span><span class="n">i</span><span class="p">]});</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">col_no</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">col_no</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{});</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;^ Near here.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{});</span>
<span class="p">}</span>
</pre></div>
<p>Ok, popping our mental stack, if we look back at <code>parse_rule</code> we still
need to implement <code>parse_identifier</code> and <code>parse_property</code>.</p>
<h4 id="<code>parse_identifier</code>"><code>parse_identifier</code></h4><p>An "identifier" for us here is just going to be an ASCII alphabetical
string (i.e. <code>[a-zA-Z]+</code>).  We're going to <em>really</em> simplify CSS
because we're going to use this method for parsing not just selectors
but property names and even property values.</p>
<p>Zig again has a nice builtin <code>std.ascii.isAlphabetical</code> we can use.</p>
<div class="highlight"><pre><span></span><span class="kr">const</span><span class="w"> </span><span class="n">ParseIdentifierResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">identifier</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="n">index</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">fn</span><span class="w"> </span><span class="n">parse_identifier</span><span class="p">(</span>
<span class="w">    </span><span class="n">css</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="n">initial_index</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="o">!</span><span class="n">ParseIdentifierResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">initial_index</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">css</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">ascii</span><span class="p">.</span><span class="n">isAlphabetic</span><span class="p">(</span><span class="n">css</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">index</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">initial_index</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">debug_at</span><span class="p">(</span><span class="n">css</span><span class="p">,</span><span class="w"> </span><span class="n">initial_index</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Expected valid identifier.&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{});</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">error</span><span class="p">.</span><span class="n">InvalidIdentifier</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ParseIdentifierResult</span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">identifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">css</span><span class="p">[</span><span class="n">initial_index</span><span class="p">..</span><span class="n">index</span><span class="p">],</span>
<span class="w">        </span><span class="p">.</span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">index</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="p">}</span>
</pre></div>
<p>In reality, CSS properties are <a href="https://www.w3schools.com/cssref/css_selectors.php">highly
complex</a>. Parsing
CSS correctly isn't the main aim of this post though. :)</p>
<h4 id="<code>parse_property</code>"><code>parse_property</code></h4><p>The final piece of CSS we need to parse is properties. These consist
of a property name, then a colon, then a property value, and finally a
semicolon. And within each piece we eat whitespace.</p>
<div class="highlight"><pre><span></span><span class="kr">const</span><span class="w"> </span><span class="n">ParsePropertyResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">property</span><span class="o">:</span><span class="w"> </span><span class="n">CSSProperty</span><span class="p">,</span>
<span class="w">    </span><span class="n">index</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">fn</span><span class="w"> </span><span class="n">parse_property</span><span class="p">(</span>
<span class="w">    </span><span class="n">css</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="n">initial_index</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="o">!</span><span class="n">ParsePropertyResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eat_whitespace</span><span class="p">(</span><span class="n">css</span><span class="p">,</span><span class="w"> </span><span class="n">initial_index</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// First parse property name.</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">name_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse_identifier</span><span class="p">(</span><span class="n">css</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="o">|</span><span class="n">e</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Could not parse property name.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{});</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name_res</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>

<span class="w">    </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eat_whitespace</span><span class="p">(</span><span class="n">css</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Then parse colon: :.</span>
<span class="w">    </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">parse_syntax</span><span class="p">(</span><span class="n">css</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;:&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eat_whitespace</span><span class="p">(</span><span class="n">css</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Then parse property value.</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">value_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse_identifier</span><span class="p">(</span><span class="n">css</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="o">|</span><span class="n">e</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Could not parse property value.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{});</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value_res</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Finally parse semi-colon: ;.</span>
<span class="w">    </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">parse_syntax</span><span class="p">(</span><span class="n">css</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;;&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">property</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">match_property</span><span class="p">(</span><span class="n">name_res</span><span class="p">.</span><span class="n">identifier</span><span class="p">,</span><span class="w"> </span><span class="n">value_res</span><span class="p">.</span><span class="n">identifier</span><span class="p">)</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="o">|</span><span class="n">e</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">debug_at</span><span class="p">(</span><span class="n">css</span><span class="p">,</span><span class="w"> </span><span class="n">initial_index</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Unknown property: &#39;{s}&#39;.&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span><span class="n">name_res</span><span class="p">.</span><span class="n">identifier</span><span class="p">});</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ParsePropertyResult</span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">property</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">property</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">index</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="p">}</span>
</pre></div>
<p>Finally we get to the first bit of metaprogramming. Once we have a
property name and value, we need to turn that into a Zig union.</p>
<p>That's what <code>match_property()</code> is going to be responsible for doing.</p>
<h3 id="<code>match_property</code>"><code>match_property</code></h3><p>This function needs to take a property name and value and return a
<code>CSSProperty</code> with the correct field (matching up to the property name
passed in) and assigned to the value passed in.</p>
<p>If we didn't have metaprogramming or reflection, the implementation
might look like this:</p>
<div class="highlight"><pre><span></span><span class="n">fn</span><span class="w"> </span><span class="n">match_property</span><span class="p">(</span>
<span class="w">    </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="k">const</span><span class="w"> </span><span class="n">u8</span><span class="p">,</span>
<span class="w">    </span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="k">const</span><span class="w"> </span><span class="n">u8</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="o">!</span><span class="n">CSSProperty</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">eql</span><span class="p">(</span><span class="n">u8</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;color&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">CSSProperty</span><span class="p">{</span><span class="o">.</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">eql</span><span class="p">(</span><span class="n">u8</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;background&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">CSSProperty</span><span class="p">{</span><span class="o">.</span><span class="n">background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">error</span><span class="o">.</span><span class="n">UnknownProperty</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>And that is not necessarily bad. In fact it may be how a lot of
production code looks over time as product needs evolve. You can keep
the internal field name unrelated to the external field name.</p>
<p>However for the sake of learning, we'll try to implement the same
thing with Zig metaprogramming.</p>
<p>And specifically, we can take a look at
<a href="https://github.com/ziglang/zig/blob/32cb9462ffa0a9df7a080d67eaf3a5762173f742/lib/std/json/static.zig">lib/std/json/static.zig</a>
to understand the reflection APIs.</p>
<p>Specifically, if we look at line 210-226 of that file, we can see them
iterating over fields of a <code>Union</code>:</p>
<div class="highlight"><pre><span></span><span class="w">        </span><span class="p">.</span><span class="n">Union</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">|</span><span class="n">unionInfo</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="kr">comptime</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">meta</span><span class="p">.</span><span class="n">trait</span><span class="p">.</span><span class="n">hasFn</span><span class="p">(</span><span class="s">&quot;jsonParse&quot;</span><span class="p">)(</span><span class="n">T</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">jsonParse</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span><span class="w"> </span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unionInfo</span><span class="p">.</span><span class="n">tag_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="nb">@compileError</span><span class="p">(</span><span class="s">&quot;Unable to parse into untagged union &#39;&quot;</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="nb">@typeName</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="s">&quot;&#39;&quot;</span><span class="p">);</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="n">object_begin</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">source</span><span class="p">.</span><span class="n">next</span><span class="p">())</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">error</span><span class="p">.</span><span class="n">UnexpectedToken</span><span class="p">;</span>

<span class="w">            </span><span class="kr">var</span><span class="w"> </span><span class="n">result</span><span class="o">:</span><span class="w"> </span><span class="o">?</span><span class="n">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">            </span><span class="kr">var</span><span class="w"> </span><span class="n">name_token</span><span class="o">:</span><span class="w"> </span><span class="o">?</span><span class="n">Token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">source</span><span class="p">.</span><span class="n">nextAllocMax</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">alloc_if_needed</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">max_value_len</span><span class="p">.</span><span class="o">?</span><span class="p">);</span>
<span class="w">            </span><span class="kr">const</span><span class="w"> </span><span class="n">field_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">name_token</span><span class="p">.</span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kr">inline</span><span class="w"> </span><span class="p">.</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">allocated_string</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">|</span><span class="n">slice</span><span class="o">|</span><span class="w"> </span><span class="n">slice</span><span class="p">,</span>
<span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">error</span><span class="p">.</span><span class="n">UnexpectedToken</span><span class="p">,</span>
<span class="w">            </span><span class="p">};</span>

<span class="w">            </span><span class="kr">inline</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">unionInfo</span><span class="p">.</span><span class="n">fields</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="n">u_field</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
</pre></div>
<p>Then right after that (lines 226-243) we see them conditionally
modifying the result object:</p>
<div class="highlight"><pre><span></span><span class="w">            </span><span class="kr">inline</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">unionInfo</span><span class="p">.</span><span class="n">fields</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="n">u_field</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">eql</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">u_field</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">field_name</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// Free the name token now in case we&#39;re using an allocator that optimizes freeing the last allocated object.</span>
<span class="w">                    </span><span class="c1">// (Recursing into parseInternal() might trigger more allocations.)</span>
<span class="w">                    </span><span class="n">freeAllocated</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span><span class="w"> </span><span class="n">name_token</span><span class="p">.</span><span class="o">?</span><span class="p">);</span>
<span class="w">                    </span><span class="n">name_token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>

<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">u_field</span><span class="p">.</span><span class="kt">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="c1">// void isn&#39;t really a json type, but we can support void payload union tags with {} as a value.</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="n">object_begin</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">source</span><span class="p">.</span><span class="n">next</span><span class="p">())</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">error</span><span class="p">.</span><span class="n">UnexpectedToken</span><span class="p">;</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="n">object_end</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">source</span><span class="p">.</span><span class="n">next</span><span class="p">())</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">error</span><span class="p">.</span><span class="n">UnexpectedToken</span><span class="p">;</span>
<span class="w">                        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">@unionInit</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">u_field</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="p">{});</span>
<span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="c1">// Recurse.</span>
<span class="w">                        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">@unionInit</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">u_field</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">parseInternal</span><span class="p">(</span><span class="n">u_field</span><span class="p">.</span><span class="kt">type</span><span class="p">,</span><span class="w"> </span><span class="n">allocator</span><span class="p">,</span><span class="w"> </span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">));</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
</pre></div>
<p>We can see that the <code>.Union =&gt; |unionInfo|</code> condition is entered by
switching on <code>@typeInfo(T)</code> (<a href="https://github.com/ziglang/zig/blob/32cb9462ffa0a9df7a080d67eaf3a5762173f742/lib/std/json/static.zig#L149">line
149</a>)
and that <code>T</code> is a type (<a href="https://github.com/ziglang/zig/blob/32cb9462ffa0a9df7a080d67eaf3a5762173f742/lib/std/json/static.zig#L144">line
144</a>).</p>
<p>We don't have a generic type though. We know we are working with a
<code>CSSProperty</code>. And we know <code>CSSProperty</code> is a union so we don't need
the <code>switch</code> either.</p>
<p>So let's apply that to our <code>match_property</code> implementation.</p>
<div class="highlight"><pre><span></span><span class="k">fn</span><span class="w"> </span><span class="n">match_property</span><span class="p">(</span>
<span class="w">    </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="n">value</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="o">!</span><span class="n">CSSProperty</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">cssPropertyInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">@typeInfo</span><span class="p">(</span><span class="n">CSSProperty</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">cssPropertyInfo</span><span class="p">.</span><span class="n">Union</span><span class="p">.</span><span class="n">fields</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="n">u_field</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">eql</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">u_field</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">@unionInit</span><span class="p">(</span><span class="n">CSSProperty</span><span class="p">,</span><span class="w"> </span><span class="n">u_field</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">error</span><span class="p">.</span><span class="n">UnknownProperty</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>And if we try to build that we'll get an error like this:</p>
<div class="highlight"><pre><span></span><span class="n">main</span><span class="p">.</span><span class="n">zig</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mi">31</span><span class="o">:</span><span class="w"> </span><span class="k">error</span><span class="o">:</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="kt">type</span><span class="w"> </span><span class="err">&#39;</span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="n">builtin</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">UnionField</span><span class="err">&#39;</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="kr">comptime</span><span class="o">-</span><span class="n">known</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">runtime</span><span class="o">-</span><span class="n">known</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">cssPropertyInfo</span><span class="p">.</span><span class="n">Union</span><span class="p">.</span><span class="n">fields</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="n">u_field</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
</pre></div>
<p>Zig's "reflection" abilities here are comptime only. So we can't use a
runtime <code>for</code> loop, we must use a comptime <code>inline for</code> loop.</p>
<div class="highlight"><pre><span></span><span class="k">fn</span><span class="w"> </span><span class="n">match_property</span><span class="p">(</span>
<span class="w">    </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="n">value</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="o">!</span><span class="n">CSSProperty</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">cssPropertyInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">@typeInfo</span><span class="p">(</span><span class="n">CSSProperty</span><span class="p">);</span>

<span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">cssPropertyInfo</span><span class="p">.</span><span class="n">Union</span><span class="p">.</span><span class="n">fields</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="n">u_field</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">eql</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">u_field</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">@unionInit</span><span class="p">(</span><span class="n">CSSProperty</span><span class="p">,</span><span class="w"> </span><span class="n">u_field</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">error</span><span class="p">.</span><span class="n">UnknownProperty</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>As far as I understand it, this loop is basically unrolled and the
generated code would look a lot like our hard-coded initial version.</p>
<p>i.e. it would probably look like this:</p>
<div class="highlight"><pre><span></span><span class="k">fn</span><span class="w"> </span><span class="n">match_property</span><span class="p">(</span>
<span class="w">    </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="n">value</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="o">!</span><span class="n">CSSProperty</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">cssPropertyInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">@typeInfo</span><span class="p">(</span><span class="n">CSSProperty</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">eql</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;background&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">@unionInit</span><span class="p">(</span><span class="n">CSSProperty</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;background&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">eql</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;color&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">@unionInit</span><span class="p">(</span><span class="n">CSSProperty</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;color&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">eql</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;unknown&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">@unionInit</span><span class="p">(</span><span class="n">CSSProperty</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;unknown&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">error</span><span class="p">.</span><span class="n">UnknownProperty</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>Again that's just how I imagine the compiler to generate code from the
Union field reflection and <code>inline for</code> over the fields.</p>
<p>Try compiling that code. I get this:</p>
<div class="highlight"><pre><span></span><span class="go">main.zig:17:58: error: expected type &#39;void&#39;, found &#39;[]const u8&#39;</span>
<span class="go">            return @unionInit(CSSProperty, u_field.name, value);</span>
</pre></div>
<p>Thinking about the generated code makes it especially clear what's
happening. We have an <code>unknown</code> field in there that has a <code>void</code>
type. You can't assign a string to void.</p>
<p>We know at runtime that the condition where that happens should be
impossible because the user shouldn't enter <code>unknown</code> as a property
name. (Though now that I write this, I see they actually could. But
let's pretend they wouldn't.)</p>
<p>So the problem isn't a runtime failure but a comptime type-checking
failure.</p>
<p>Thankfully we can work around this with comptime conditionals.</p>
<p>If we wrap our current condition in an additional conditional that is
evaluated at comptime and filters out the <code>unknown</code> pass of the
<code>inline for</code> loop, the compiler shouldn't generate any code trying to
assign to the <code>unknown</code> field.</p>
<div class="highlight"><pre><span></span><span class="k">fn</span><span class="w"> </span><span class="n">match_property</span><span class="p">(</span>
<span class="w">    </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="n">value</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="o">!</span><span class="n">CSSProperty</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">cssPropertyInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">@typeInfo</span><span class="p">(</span><span class="n">CSSProperty</span><span class="p">);</span>

<span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">cssPropertyInfo</span><span class="p">.</span><span class="n">Union</span><span class="p">.</span><span class="n">fields</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="n">u_field</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="kr">comptime</span><span class="w"> </span><span class="o">!</span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">eql</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">u_field</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;unknown&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">eql</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">u_field</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">@unionInit</span><span class="p">(</span><span class="n">CSSProperty</span><span class="p">,</span><span class="w"> </span><span class="n">u_field</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">error</span><span class="p">.</span><span class="n">UnknownProperty</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>And indeed, if you try to compile it, this works. Since the
conditional is evaluated at compile time, we can imagine the code the
compiler generates is this:</p>
<div class="highlight"><pre><span></span><span class="k">fn</span><span class="w"> </span><span class="n">match_property</span><span class="p">(</span>
<span class="w">    </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="n">value</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="o">!</span><span class="n">CSSProperty</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">cssPropertyInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">@typeInfo</span><span class="p">(</span><span class="n">CSSProperty</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">eql</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;background&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">@unionInit</span><span class="p">(</span><span class="n">CSSProperty</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;background&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">eql</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;color&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">@unionInit</span><span class="p">(</span><span class="n">CSSProperty</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;color&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">error</span><span class="p">.</span><span class="n">UnknownProperty</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>The <code>unknown</code> field has been skipped.</p>
<p>In retrospect, I realize that the <code>unknown</code> field probably isn't
even needed. We could eliminate it from the <code>CSSProperty</code> union and
get rid of that comptime conditional. However, sometimes there are in
fact private fields you want to skip. And I wanted to show how to
deal with that case.</p>
<p>For the last bit of metaprogramming, let's talk about displaying
the resulting <code>CSSSheet</code> we'd get after parsing.</p>
<h3 id="<code>sheet.display()</code>"><code>sheet.display()</code></h3><p>If we didn't have metaprogramming and wanted to display the sheet,
we'd have to switch on every possible union field.</p>
<p>Like so (I've modified the <code>CSSSheet</code> struct definition so it includes this method):</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="n">display</span><span class="p">(</span><span class="n">sheet</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">CSSSheet</span><span class="p">)</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">sheet</span><span class="p">.</span><span class="n">rules</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="n">rule</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;selector: {s}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span><span class="n">rule</span><span class="p">.</span><span class="n">selector</span><span class="p">});</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">rule</span><span class="p">.</span><span class="n">properties</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="n">property</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">property</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="p">.</span><span class="n">unknown</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">unreachable</span><span class="p">,</span>
<span class="w">                    </span><span class="p">.</span><span class="n">color</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">|</span><span class="n">color_value</span><span class="o">|</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;  color: {s}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span><span class="n">color_value</span><span class="p">}),</span>
<span class="w">                    </span><span class="p">.</span><span class="n">background</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">|</span><span class="n">background_value</span><span class="o">|</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;  background: {s}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span><span class="n">background_value</span><span class="p">}),</span>
<span class="w">                </span><span class="p">};</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{});</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
<p>This is already a little annoying and could get unwieldy as we add
fields to the <code>CSSProperty</code> union.</p>
<p>Instead we can use the <code>inline for
(@typeInfo(CSSProperty).Union.fields) |u_field|</code> method to iterate
over all fields, skip the <code>unknown</code> field at comptime, and print out
the field name and value by matching on the current value of the
<code>property</code> enum by using the <code>@tagName</code> builtin.</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="n">display</span><span class="p">(</span><span class="n">sheet</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">CSSSheet</span><span class="p">)</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">sheet</span><span class="p">.</span><span class="n">rules</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="n">rule</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;selector: {s}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span><span class="n">rule</span><span class="p">.</span><span class="n">selector</span><span class="p">});</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">rule</span><span class="p">.</span><span class="n">properties</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="n">property</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kr">inline</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nb">@typeInfo</span><span class="p">(</span><span class="n">CSSProperty</span><span class="p">).</span><span class="n">Union</span><span class="p">.</span><span class="n">fields</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="n">u_field</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="kr">comptime</span><span class="w"> </span><span class="o">!</span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">eql</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">u_field</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;unknown&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">eql</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">u_field</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="nb">@tagName</span><span class="p">(</span><span class="n">property</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;  {s}: {s}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span>
<span class="w">                                </span><span class="nb">@tagName</span><span class="p">(</span><span class="n">property</span><span class="p">),</span>
<span class="w">                                </span><span class="nb">@field</span><span class="p">(</span><span class="n">property</span><span class="p">,</span><span class="w"> </span><span class="n">u_field</span><span class="p">.</span><span class="n">name</span><span class="p">),</span>
<span class="w">                            </span><span class="p">});</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{});</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
<h3 id="<code>main</code>"><code>main</code></h3><p>Finally, we pull it all together with a little <code>main</code> function.</p>
<div class="highlight"><pre><span></span><span class="kr">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="o">!</span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">arena</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">heap</span><span class="p">.</span><span class="n">ArenaAllocator</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">std</span><span class="p">.</span><span class="n">heap</span><span class="p">.</span><span class="n">page_allocator</span><span class="p">);</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="n">arena</span><span class="p">.</span><span class="n">deinit</span><span class="p">();</span>

<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">allocator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arena</span><span class="p">.</span><span class="n">allocator</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Let&#39;s read in a CSS file.</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">process</span><span class="p">.</span><span class="n">args</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Skips the program name.</span>
<span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="n">next</span><span class="p">();</span>

<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">file_name</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">next</span><span class="p">())</span><span class="w"> </span><span class="o">|</span><span class="n">f</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">file_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">fs</span><span class="p">.</span><span class="n">cwd</span><span class="p">().</span><span class="n">openFile</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span><span class="w"> </span><span class="p">.{});</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="n">file</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>

<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">file_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">file</span><span class="p">.</span><span class="n">getEndPos</span><span class="p">();</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">css_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">allocator</span><span class="p">.</span><span class="n">alloc</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">file_size</span><span class="p">);</span>
<span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">file</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">css_file</span><span class="p">);</span>

<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">sheet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arena</span><span class="p">,</span><span class="w"> </span><span class="n">css_file</span><span class="p">)</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="n">sheet</span><span class="p">.</span><span class="n">display</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
<p>And try it against some tests.</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>zig<span class="w"> </span>build-exe<span class="w"> </span>main.zig
<span class="gp">$ </span>cat<span class="w"> </span>tests/basic.css
<span class="go">div {</span>
<span class="go">    background: white;</span>
<span class="go">}</span>
<span class="gp">$ </span>./main<span class="w"> </span>tests/basic.css
<span class="go">selector: div</span>
<span class="go">  background: white</span>
</pre></div>
<p>Nice! Let's try it against a more complex test.</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>tests/multiple-blocks.css
<span class="go">div {</span>
<span class="go">    background: black;</span>
<span class="go">    color: white;</span>
<span class="go">}</span>

<span class="go">a {</span>
<span class="go">    color: blue;</span>
<span class="go">}</span>
<span class="gp">$ </span>./main<span class="w"> </span>tests/multiple-blocks.css
<span class="go">selector: div</span>
<span class="go">  background: black</span>
<span class="go">  color: white</span>

<span class="go">selector: a</span>
<span class="go">  color: blue</span>
</pre></div>
<p>Awesome. And against a bad CSS sheet:</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>tests/bad-property.css
<span class="go">a {</span>
<span class="go">    big: pink;</span>
<span class="go">}</span>
<span class="gp">$ </span>./main<span class="w"> </span>cat<span class="w"> </span>tests/bad-property.css
<span class="go">Error at line 2, column 4. Unknown property: &#39;big&#39;.</span>


<span class="go">    big: pink;</span>
<span class="go">    ^ Near here.</span>
</pre></div>
<p>We've got it!</p>
<h3 id="addendum:-<code>@field</code>">Addendum: <code>@field</code></h3><p>The docs were quite clear about using <code>@field(object, fieldName)</code> to
access the value of an <code>object</code> of type <code>@TypeOf(object)</code> at field
<code>fieldName</code>.</p>
<p>And the docs do mention <code>@field()</code> can be used as LHS but that only
really struct me when I was browsing the Zig JSON code like at <a href="https://github.com/ziglang/zig/blob/master/lib/std/json/static.zig#L307">line
307</a>.</p>
<p>I didn't use that in this little project but I've used it elsewhere,
so it I wanted to call this LHS behavior out.</p>
<p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">Wrote a short post on parsing CSS as a way to motivate some basic exploration of metaprogramming in Zig.<br><br>I heavily referenced Zig&#39;s builtin JSON parser when learning this. And it is referenced multiple times in the post as well.<a href="https://t.co/CX6jXSLGiR">https://t.co/CX6jXSLGiR</a> <a href="https://t.co/jAJJZ0pONQ">pic.twitter.com/jAJJZ0pONQ</a></p>&mdash; Phil Eaton (@eatonphil) <a href="https://twitter.com/eatonphil/status/1670868544953647129?ref_src=twsrc%5Etfw">June 19, 2023</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<style>.feedback{display:initial;}</style>
	</div>
	<div class="feedback">
	  <h4>Feedback</h4>
	  <p>As always,
	      please <a href="mailto:phil@eatonphil.com">email</a>
	      or <a href="https://twitter.com/eatonphil">tweet me</a>
	      with questions, corrections, or ideas!</p>

	</div>
      </div>
    </div>
    <footer>
      <div class="container">
	<div>
	  <div id="subscribe">
	    <iframe frameBorder="0" src="https://cdn.forms-content-1.sg-form.com/e8ed4c3b-dd46-11f0-b6e6-ce075f2c5f80"/>

	  </div>
	</div>
      </div>
    </footer>
  </body>
</html>
