<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="canonical" href="https://notes.eatonphil.com/aot-compilation-of-javascript-with-v8.html">
    <title>AOT-compilation of Javascript with V8 | notes.eatonphil.com</title>
    <meta name="description" content="AOT-compilation of Javascript with V8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" href="/rss.xml" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono">
  </head>
  <body>
    <header>
      <div class="lfw">
	<div class="container">
	  <div class="row">
	    <a href="https://eatonphil.com/2025-holiday-fundraiser.html">2025 Holiday Fundraiser</a>
	  </div>
	</div>
      </div>
      <div class="container">
        <div>
          <div class="row">
	    <div>
	      <a href="https://eatonphil.com" class="sm-link">
		Home
              </a>
	      <a href="/" class="sm-link">
		Blog
              </a>
	      <a href="/rss.xml" class="sm-link">
		RSS
              </a>
	    </div>

	    <div class="subscribe">
	      <!-- <a href="https://eatonphil.com/hire-me.html">Hire me</a> -->
	      <!--
		  Hardcode link to home page because some pages don't
		  have a subscribe box. Some pages hide the subscribe.
		-->
	      <a href="https://eatonphil.com/subscribe.html">
		Subscribe
	      </a>
            </div>
	  </div>
	  <hr />
	  <div class="">
            <h2>February 26, 2019</h2>
            <h1>AOT-compilation of Javascript with V8</h1>
	    
            <div class="row" style="padding-bottom: 5px">
              <div class="tags"><a href="/tags/javascript.html" class="tag">javascript</a><a href="/tags/c++.html" class="tag">c++</a><a href="/tags/compilers.html" class="tag">compilers</a><a href="/tags/rust.html" class="tag">rust</a><a href="/tags/typescript.html" class="tag">typescript</a><a href="/tags/v8.html" class="tag">v8</a></div>
            </div>
	  </div>
	</div>
      </div>
    </header>
    <div class="container">
      <div class="col-6">
	<div class="post">
          <p>tldr; I'm working on a AOT-compiled Javascript implementation called
<a href="https://github.com/eatonphil/jsc">jsc</a>.</p>
<p>Many dynamically typed programming languages have implementations that
compile to native binaries:</p>
<ul>
<li>Python: <a href="https://cython.org/">Cython</a></li>
<li>Common Lisp: <a href="http://www.sbcl.org/">SBCL</a></li>
<li>Scheme: <a href="https://www.call-cc.org/">Chicken Scheme</a></li>
</ul>
<p>The benefits of compiling dynamically typed languages are similar to
those of compiling statically typed languages:</p>
<ul>
<li>Simplified deployment via a single binary</li>
<li>Simplified foreign-function interfaces<ul>
<li>e.g. <a href="https://wiki.call-cc.org/An%20extended%20FFI%20example">Embedded C/C++ strings</a></li>
</ul>
</li>
<li>Predictable performance compared to JIT compiling interpreters</li>
<li>Performance gains compared to non-JIT compiling interpreters</li>
</ul>
<p>I (re)discovered a common technique for compiling dynamic languages
while developing <a href="https://github.com/eatonphil/bsdscheme">BSDScheme</a>,
an interpreter and compiler for Scheme. In this technique, you use
core parts of the runtime code as a library that is imported and
referenced by compiled code.</p>
<p>You save time building object-memory representations, memory
management, operations, interacting with existing libraries, etc. when
an interpreter already exists. The runtime as a library (plus existing
parser frontends) allows you to focus solely on code generation of
control flow.</p>
<h3 id="the-first-pass">The first pass</h3><p>I wrote the initial version of <a href="https://github.com/eatonphil/jsc">jsc</a>
in Rust using Dave Herman's
<a href="https://github.com/dherman/esprit">esprit</a> parser (supports a subset
of ES6 that includes all of ES5).</p>
<p>The interesting parts of the runtime are taken care of by V8, e.g.:</p>
<ul>
<li><code>V8::String</code> - a Javascript string object<ul>
<li><code>V8::String::NewFromUtf8(isolate, "hello world!")</code> - C++ string to Javascript string object</li>
</ul>
</li>
<li><code>V8::Number</code> - a Javascript number object<ul>
<li><code>V8::Number::New(isolate, 10)</code> - C++ double to Javascript number object</li>
</ul>
</li>
<li>Heap allocations</li>
<li>Calling convention</li>
</ul>
<p>And so on.</p>
<h4 id="an-example">An example</h4><p>This first version of jsc could take the following Javascript:</p>
<div class="highlight"><pre><span></span><span class="kd">function</span><span class="w"> </span><span class="nx">fib</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span><span class="w"> </span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">a</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">b</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">fib</span><span class="p">(</span><span class="nx">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">fib</span><span class="p">(</span><span class="mf">50</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
<p>And produce the following C++:</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;node.h&gt;</span>

<span class="k">using</span><span class="w"> </span><span class="n">v8</span><span class="o">::</span><span class="n">Array</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">v8</span><span class="o">::</span><span class="n">Boolean</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">v8</span><span class="o">::</span><span class="n">Context</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">v8</span><span class="o">::</span><span class="n">Exception</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">v8</span><span class="o">::</span><span class="n">Function</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">v8</span><span class="o">::</span><span class="n">FunctionTemplate</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">v8</span><span class="o">::</span><span class="n">FunctionCallbackInfo</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">v8</span><span class="o">::</span><span class="n">Isolate</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">v8</span><span class="o">::</span><span class="n">Local</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">v8</span><span class="o">::</span><span class="n">Null</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">v8</span><span class="o">::</span><span class="n">Number</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">v8</span><span class="o">::</span><span class="n">Object</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">v8</span><span class="o">::</span><span class="n">String</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">v8</span><span class="o">::</span><span class="n">False</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">v8</span><span class="o">::</span><span class="n">True</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">v8</span><span class="o">::</span><span class="n">Value</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">fib_0</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FunctionCallbackInfo</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Isolate</span><span class="o">*</span><span class="w"> </span><span class="n">isolate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="n">GetIsolate</span><span class="p">();</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">n_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">a_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">b_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="nl">tail_recurse_4</span><span class="p">:</span>

<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Context</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ctx_5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isolate</span><span class="o">-&gt;</span><span class="n">GetCurrentContext</span><span class="p">();</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">global_6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx_5</span><span class="o">-&gt;</span><span class="n">Global</span><span class="p">();</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Boolean_7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;::</span><span class="n">Cast</span><span class="p">(</span><span class="n">global_6</span><span class="o">-&gt;</span><span class="n">Get</span><span class="p">(</span><span class="n">String</span><span class="o">::</span><span class="n">NewFromUtf8</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Boolean&quot;</span><span class="p">)));</span>
<span class="w">  </span><span class="n">String</span><span class="o">::</span><span class="n">Utf8Value</span><span class="w"> </span><span class="n">utf8value_tmp_8</span><span class="p">(</span><span class="n">n_1</span><span class="p">);</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">string_tmp_9</span><span class="p">(</span><span class="o">*</span><span class="n">utf8value_tmp_8</span><span class="p">);</span>
<span class="w">  </span><span class="n">String</span><span class="o">::</span><span class="n">Utf8Value</span><span class="w"> </span><span class="n">utf8value_tmp_10</span><span class="p">(</span><span class="n">Number</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">string_tmp_11</span><span class="p">(</span><span class="o">*</span><span class="n">utf8value_tmp_10</span><span class="p">);</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">argv_12</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">(</span><span class="n">n_1</span><span class="o">-&gt;</span><span class="n">IsBoolean</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">Number</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">IsBoolean</span><span class="p">())</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Boolean</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="n">n_1</span><span class="o">-&gt;</span><span class="n">ToBoolean</span><span class="p">(</span><span class="n">isolate</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Value</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Number</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ToBoolean</span><span class="p">(</span><span class="n">isolate</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Value</span><span class="p">())</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">((</span><span class="n">n_1</span><span class="o">-&gt;</span><span class="n">IsNumber</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">Number</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">IsNumber</span><span class="p">())</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Boolean</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="n">n_1</span><span class="o">-&gt;</span><span class="n">ToNumber</span><span class="p">(</span><span class="n">isolate</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Value</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Number</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ToNumber</span><span class="p">(</span><span class="n">isolate</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Value</span><span class="p">())</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">((</span><span class="n">n_1</span><span class="o">-&gt;</span><span class="n">IsString</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">Number</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">IsString</span><span class="p">())</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Boolean</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="n">string_tmp_9</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">string_tmp_11</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">False</span><span class="p">(</span><span class="n">isolate</span><span class="p">))))</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result_13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Boolean_7</span><span class="o">-&gt;</span><span class="n">Call</span><span class="p">(</span><span class="n">Null</span><span class="p">(</span><span class="n">isolate</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">argv_12</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result_13</span><span class="o">-&gt;</span><span class="n">ToBoolean</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Value</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// return a;</span>
<span class="w">    </span><span class="n">args</span><span class="p">.</span><span class="n">GetReturnValue</span><span class="p">().</span><span class="n">Set</span><span class="p">(</span><span class="n">a_2</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>


<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Context</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ctx_14</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isolate</span><span class="o">-&gt;</span><span class="n">GetCurrentContext</span><span class="p">();</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">global_15</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx_14</span><span class="o">-&gt;</span><span class="n">Global</span><span class="p">();</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Boolean_16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;::</span><span class="n">Cast</span><span class="p">(</span><span class="n">global_15</span><span class="o">-&gt;</span><span class="n">Get</span><span class="p">(</span><span class="n">String</span><span class="o">::</span><span class="n">NewFromUtf8</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Boolean&quot;</span><span class="p">)));</span>
<span class="w">  </span><span class="n">String</span><span class="o">::</span><span class="n">Utf8Value</span><span class="w"> </span><span class="n">utf8value_tmp_17</span><span class="p">(</span><span class="n">n_1</span><span class="p">);</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">string_tmp_18</span><span class="p">(</span><span class="o">*</span><span class="n">utf8value_tmp_17</span><span class="p">);</span>
<span class="w">  </span><span class="n">String</span><span class="o">::</span><span class="n">Utf8Value</span><span class="w"> </span><span class="n">utf8value_tmp_19</span><span class="p">(</span><span class="n">Number</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">string_tmp_20</span><span class="p">(</span><span class="o">*</span><span class="n">utf8value_tmp_19</span><span class="p">);</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">argv_21</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">(</span><span class="n">n_1</span><span class="o">-&gt;</span><span class="n">IsBoolean</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">Number</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">IsBoolean</span><span class="p">())</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Boolean</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="n">n_1</span><span class="o">-&gt;</span><span class="n">ToBoolean</span><span class="p">(</span><span class="n">isolate</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Value</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Number</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ToBoolean</span><span class="p">(</span><span class="n">isolate</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Value</span><span class="p">())</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">((</span><span class="n">n_1</span><span class="o">-&gt;</span><span class="n">IsNumber</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">Number</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">IsNumber</span><span class="p">())</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Boolean</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="n">n_1</span><span class="o">-&gt;</span><span class="n">ToNumber</span><span class="p">(</span><span class="n">isolate</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Value</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Number</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ToNumber</span><span class="p">(</span><span class="n">isolate</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Value</span><span class="p">())</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">((</span><span class="n">n_1</span><span class="o">-&gt;</span><span class="n">IsString</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">Number</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">IsString</span><span class="p">())</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Boolean</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="n">string_tmp_18</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">string_tmp_20</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">False</span><span class="p">(</span><span class="n">isolate</span><span class="p">))))</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result_22</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Boolean_16</span><span class="o">-&gt;</span><span class="n">Call</span><span class="p">(</span><span class="n">Null</span><span class="p">(</span><span class="n">isolate</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">argv_21</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result_22</span><span class="o">-&gt;</span><span class="n">ToBoolean</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Value</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// return b;</span>
<span class="w">    </span><span class="n">args</span><span class="p">.</span><span class="n">GetReturnValue</span><span class="p">().</span><span class="n">Set</span><span class="p">(</span><span class="n">b_3</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>


<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// return fib(n - 1, b, a + b);</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">arg_23</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">n_1</span><span class="o">-&gt;</span><span class="n">IsNumber</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">Number</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">IsNumber</span><span class="p">())</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">Number</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="n">n_1</span><span class="o">-&gt;</span><span class="n">ToNumber</span><span class="p">(</span><span class="n">isolate</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Value</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Number</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ToNumber</span><span class="p">(</span><span class="n">isolate</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Value</span><span class="p">()))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Number</span><span class="o">&gt;::</span><span class="n">Cast</span><span class="p">(</span><span class="n">Null</span><span class="p">(</span><span class="n">isolate</span><span class="p">));</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">arg_24</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b_3</span><span class="p">;</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">arg_25</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">a_2</span><span class="o">-&gt;</span><span class="n">IsString</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">b_3</span><span class="o">-&gt;</span><span class="n">IsString</span><span class="p">())</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;::</span><span class="n">Cast</span><span class="p">(</span><span class="n">String</span><span class="o">::</span><span class="n">Concat</span><span class="p">(</span><span class="n">a_2</span><span class="o">-&gt;</span><span class="n">ToString</span><span class="p">(),</span><span class="w"> </span><span class="n">b_3</span><span class="o">-&gt;</span><span class="n">ToString</span><span class="p">()))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;::</span><span class="n">Cast</span><span class="p">((</span><span class="n">a_2</span><span class="o">-&gt;</span><span class="n">IsNumber</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">b_3</span><span class="o">-&gt;</span><span class="n">IsNumber</span><span class="p">())</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">Number</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="n">a_2</span><span class="o">-&gt;</span><span class="n">ToNumber</span><span class="p">(</span><span class="n">isolate</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Value</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b_3</span><span class="o">-&gt;</span><span class="n">ToNumber</span><span class="p">(</span><span class="n">isolate</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Value</span><span class="p">()))</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Number</span><span class="o">&gt;::</span><span class="n">Cast</span><span class="p">(</span><span class="n">Null</span><span class="p">(</span><span class="n">isolate</span><span class="p">)));</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">FunctionTemplate</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ftpl_27</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionTemplate</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="n">fib_0</span><span class="p">);</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fn_26</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftpl_27</span><span class="o">-&gt;</span><span class="n">GetFunction</span><span class="p">();</span>
<span class="w">  </span><span class="n">fn_26</span><span class="o">-&gt;</span><span class="n">SetName</span><span class="p">(</span><span class="n">String</span><span class="o">::</span><span class="n">NewFromUtf8</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;fib_0&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="n">n_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg_23</span><span class="p">;</span>
<span class="w">  </span><span class="n">a_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg_24</span><span class="p">;</span>
<span class="w">  </span><span class="n">b_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg_25</span><span class="p">;</span>
<span class="w">  </span><span class="k">goto</span><span class="w"> </span><span class="n">tail_recurse_4</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">jsc_main</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FunctionCallbackInfo</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Isolate</span><span class="o">*</span><span class="w"> </span><span class="n">isolate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="n">GetIsolate</span><span class="p">();</span>
<span class="nl">tail_recurse_5</span><span class="p">:</span>

<span class="w">  </span><span class="c1">// console.log(fib(50, 0, 1))</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dot_parent_7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isolate</span><span class="o">-&gt;</span><span class="n">GetCurrentContext</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Global</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Get</span><span class="p">(</span><span class="n">String</span><span class="o">::</span><span class="n">NewFromUtf8</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;console&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">property_8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">String</span><span class="o">::</span><span class="n">NewFromUtf8</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;log&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">dot_parent_7</span><span class="o">-&gt;</span><span class="n">IsObject</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">dot_parent_7</span><span class="p">.</span><span class="n">As</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">HasOwnProperty</span><span class="p">(</span><span class="n">isolate</span><span class="o">-&gt;</span><span class="n">GetCurrentContext</span><span class="p">(),</span><span class="w"> </span><span class="n">property_8</span><span class="p">).</span><span class="n">ToChecked</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">dot_parent_7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dot_parent_7</span><span class="p">.</span><span class="n">As</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetPrototype</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dot_result_6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dot_parent_7</span><span class="p">.</span><span class="n">As</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Get</span><span class="p">(</span><span class="n">isolate</span><span class="o">-&gt;</span><span class="n">GetCurrentContext</span><span class="p">(),</span><span class="w"> </span><span class="n">property_8</span><span class="p">).</span><span class="n">ToLocalChecked</span><span class="p">();</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">arg_9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Number</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">);</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">arg_10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Number</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">arg_11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Number</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">FunctionTemplate</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ftpl_13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionTemplate</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="n">fib_0</span><span class="p">);</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fn_12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftpl_13</span><span class="o">-&gt;</span><span class="n">GetFunction</span><span class="p">();</span>
<span class="w">  </span><span class="n">fn_12</span><span class="o">-&gt;</span><span class="n">SetName</span><span class="p">(</span><span class="n">String</span><span class="o">::</span><span class="n">NewFromUtf8</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;fib_0&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">argv_14</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">arg_9</span><span class="p">,</span><span class="w"> </span><span class="n">arg_10</span><span class="p">,</span><span class="w"> </span><span class="n">arg_11</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result_15</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fn_12</span><span class="o">-&gt;</span><span class="n">Call</span><span class="p">(</span><span class="n">Null</span><span class="p">(</span><span class="n">isolate</span><span class="p">),</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">argv_14</span><span class="p">);</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">arg_16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result_15</span><span class="p">;</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fn_17</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;::</span><span class="n">Cast</span><span class="p">(</span><span class="n">dot_result_6</span><span class="p">);</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">argv_18</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">arg_16</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result_19</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fn_17</span><span class="o">-&gt;</span><span class="n">Call</span><span class="p">(</span><span class="n">dot_parent_7</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">argv_18</span><span class="p">);</span>
<span class="w">  </span><span class="n">result_19</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">Init</span><span class="p">(</span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">exports</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">NODE_SET_METHOD</span><span class="p">(</span><span class="n">exports</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;jsc_main&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">jsc_main</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">NODE_MODULE</span><span class="p">(</span><span class="n">NODE_GYP_MODULE_NAME</span><span class="p">,</span><span class="w"> </span><span class="n">Init</span><span class="p">)</span>
</pre></div>
<p>This output gets compiled (by jsc) as a <a href="https://nodejs.org/api/addons.html">Node
addon</a> using
<a href="https://github.com/nodejs/node-gyp">node-gyp</a>.</p>
<p>The compiled addon is loaded by a single-line Javascript file generated by jsc:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>build
$<span class="w"> </span>jsc<span class="w"> </span>fib.js
$<span class="w"> </span>cat<span class="w"> </span>build/fib.js
require<span class="o">(</span><span class="s2">&quot;build/Release/fib.node&quot;</span><span class="o">)</span>.jsc_main<span class="o">()</span>
$<span class="w"> </span>node<span class="w"> </span>build/fib.js
<span class="m">12586269025</span>
</pre></div>
<h4 id="analysis">Analysis</h4><p>The code was a mess of bad formatting, unnecessary locals, inefficient
basic operations (e.g. huge, often unnecessary Boolean conversions),
and so on. The unnecessary locals was partially a by-product of
single-pass code generation. And the unnecessary conversions was
partly due to ignoring types (even types of literals that you don't
need Typescript/Flow to provide).</p>
<p>After I got this proof-of-concept working for basic examples, I wanted
to rewrite it around <a href="https://github.com/eatonphil/one-pass-code-generation-in-v8/blob/master/One-pass%20Code%20Generation%20in%20V8.pdf">destination-driven code
generation</a>,
a technique by Kent Dybvig used in V8's baseline compiler. And after a
few weeks not getting far in a refactor in Rust, I rewrote the
compiler in Typescript.</p>
<h3 id="the-second-pass">The second pass</h3><p>Written in Typescript and using the <a href="https://github.com/Microsoft/TypeScript/wiki/Using-the-Compiler-API">Typescript compiler
API</a>,
this second iteration was built to do destination-driven code
generation and leaf type propagation. Destination-driven code
generation allows a single-pass code generator to reduce redundant
reassignments. And leaf type propagation allows simple, obvious
optimizations such as just calling <code>V8::Boolean::IsTrue()</code>
on a statically-known boolean rather than calling
<code>V8::Value::Equals()</code>.</p>
<h4 id="example">Example</h4><p>Given the same fibonacci Javascript program from before, this
iteration produces the following C++:</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;lib.cc&quot;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">tco_fib</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FunctionCallbackInfo</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">_args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Isolate</span><span class="o">*</span><span class="w"> </span><span class="n">isolate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_args</span><span class="p">.</span><span class="n">GetIsolate</span><span class="p">();</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">args</span><span class="p">(</span><span class="n">_args</span><span class="p">.</span><span class="n">Length</span><span class="p">());;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">_args</span><span class="p">.</span><span class="n">Length</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_args</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="nl">tail_recurse_0</span><span class="p">:</span>

<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Number</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sym_rhs_4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Number</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sym_anon_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">StrictEquals</span><span class="p">(</span><span class="n">sym_rhs_4</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">True</span><span class="p">(</span><span class="n">isolate</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">False</span><span class="p">(</span><span class="n">isolate</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sym_anon_2</span><span class="o">-&gt;</span><span class="n">IsTrue</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">_args</span><span class="p">.</span><span class="n">GetReturnValue</span><span class="p">().</span><span class="n">Set</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Number</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sym_rhs_11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Number</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sym_anon_9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">StrictEquals</span><span class="p">(</span><span class="n">sym_rhs_11</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">True</span><span class="p">(</span><span class="n">isolate</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">False</span><span class="p">(</span><span class="n">isolate</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sym_anon_9</span><span class="o">-&gt;</span><span class="n">IsTrue</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">_args</span><span class="p">.</span><span class="n">GetReturnValue</span><span class="p">().</span><span class="n">Set</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Number</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sym_rhs_19</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Number</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sym_arg_17</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">genericMinus</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">sym_rhs_19</span><span class="p">);</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sym_arg_21</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">genericPlus</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="w">  </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sym_arg_17</span><span class="p">;</span>
<span class="w">  </span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="w">  </span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sym_arg_21</span><span class="p">;</span>
<span class="w">  </span><span class="k">goto</span><span class="w"> </span><span class="n">tail_recurse_0</span><span class="p">;</span>

<span class="w">  </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">jsc_main</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FunctionCallbackInfo</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">_args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Isolate</span><span class="o">*</span><span class="w"> </span><span class="n">isolate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_args</span><span class="p">.</span><span class="n">GetIsolate</span><span class="p">();</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">args</span><span class="p">(</span><span class="n">_args</span><span class="p">.</span><span class="n">Length</span><span class="p">());;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">_args</span><span class="p">.</span><span class="n">Length</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_args</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="nl">tail_recurse_1</span><span class="p">:</span>

<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Number</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sym_arg_29</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Number</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Number</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sym_arg_30</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Number</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Number</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sym_arg_31</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Number</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sym_args_32</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">sym_arg_29</span><span class="p">,</span><span class="w"> </span><span class="n">sym_arg_30</span><span class="p">,</span><span class="w"> </span><span class="n">sym_arg_31</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sym_fn_33</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FunctionTemplate</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="n">tco_fib</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">GetFunction</span><span class="p">();</span>
<span class="w">  </span><span class="n">sym_fn_33</span><span class="o">-&gt;</span><span class="n">SetName</span><span class="p">(</span><span class="n">String</span><span class="o">::</span><span class="n">NewFromUtf8</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;tco_fib&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sym_arg_28</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sym_fn_33</span><span class="o">-&gt;</span><span class="n">Call</span><span class="p">(</span><span class="n">sym_fn_33</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">sym_args_32</span><span class="p">);</span>

<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sym_args_34</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">sym_arg_28</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sym_parent_37</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isolate</span><span class="o">-&gt;</span><span class="n">GetCurrentContext</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Global</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Get</span><span class="p">(</span><span class="n">String</span><span class="o">::</span><span class="n">NewFromUtf8</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;console&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sym_anon_36</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sym_parent_37</span><span class="p">.</span><span class="n">As</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Get</span><span class="p">(</span><span class="n">String</span><span class="o">::</span><span class="n">NewFromUtf8</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;log&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sym_fn_35</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;::</span><span class="n">Cast</span><span class="p">(</span><span class="n">sym_anon_36</span><span class="p">);</span>
<span class="w">  </span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sym_anon_27</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sym_fn_35</span><span class="o">-&gt;</span><span class="n">Call</span><span class="p">(</span><span class="n">sym_fn_35</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">sym_args_34</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">Init</span><span class="p">(</span><span class="n">Local</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">exports</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">NODE_SET_METHOD</span><span class="p">(</span><span class="n">exports</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;jsc_main&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">jsc_main</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">NODE_MODULE</span><span class="p">(</span><span class="n">NODE_GYP_MODULE_NAME</span><span class="p">,</span><span class="w"> </span><span class="n">Init</span><span class="p">)</span>
</pre></div>
<h4 id="analysis">Analysis</h4><p>Common code (<code>genericPlus</code>, <code>genericMinus</code>) and
all imports have been pulled into <code>lib.cc</code> for clarity. And
the entire result is run through
<a href="https://clang.llvm.org/docs/ClangFormat.html">clang-format</a> if it is
present on the system.</p>
<p>The benefit of leaf type propagation can be seen everywhere a local is
declared that is not <code>Local<Value></code> and specifically in if
tests on statically known booleans:</p>
<div class="highlight"><pre><span></span><span class="p">...</span>
<span class="n">Local</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sym_anon_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">StrictEquals</span><span class="p">(</span><span class="n">sym_rhs_4</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">True</span><span class="p">(</span><span class="n">isolate</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">False</span><span class="p">(</span><span class="n">isolate</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sym_anon_2</span><span class="o">-&gt;</span><span class="n">IsTrue</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="p">...</span>
</pre></div>
<p>It's obvious to a human that there is another optimization you could
do here by not wrapping this check in a <code>V8::Boolean</code> at
all. The only types tracked in destinations are V8 types, not yet C++
types. But not needing to passing this through a <code>bool
toBoolean(Value v)</code> wrapper is still an improvement.</p>
<p>In general, unboxing has not really been explore. But the ultimate
goal is to use Typescript types to produce function- or block-level
unboxed versions -- perhaps using a toggle in code to specify safety 
la Common Lisp.</p>
<h3 id="next-steps">Next steps</h3><p>I broke tests and regressed on syntax support in the Typescript port,
so that's the first step. The second step is enough syntax to support
more interesting benchmarks than the fibonacci example (which has
comparative performance to Node.js/V8 but isn't saying much).</p>
<p>After that:</p>
<ul>
<li>Unboxed expressions</li>
<li>Unboxed blocks</li>
<li>Foreign-function interface</li>
<li>Self-hosting</li>
<li>Node-API compatible runtime without Node</li>
</ul>
<p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">Companion blog post to my talk on an AOT-compiled Javascript implementation built on Typescript <a href="https://t.co/0aHVJ9UzYh">https://t.co/0aHVJ9UzYh</a></p>&mdash; Phil Eaton (@phil_eaton) <a href="https://twitter.com/phil_eaton/status/1100397733867859968?ref_src=twsrc%5Etfw">February 26, 2019</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<style>.feedback{display:initial;}</style>
	</div>
	<div class="feedback">
	  <h4>Feedback</h4>
	  <p>As always,
	      please <a href="mailto:phil@eatonphil.com">email</a>
	      or <a href="https://twitter.com/eatonphil">tweet me</a>
	      with questions, corrections, or ideas!</p>

	</div>
      </div>
    </div>
    <footer>
      <div class="container">
	<div>
	  <div id="subscribe">
	    <iframe frameBorder="0" src="https://cdn.forms-content-1.sg-form.com/e8ed4c3b-dd46-11f0-b6e6-ce075f2c5f80"/>

	  </div>
	</div>
      </div>
    </footer>
    <script async onload="loadGA()" src="https://www.googletagmanager.com/gtag/js?id=UA-58109156-2"></script>
    <script>
      function loadGA() {
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());
	  gtag('config', 'UA-58109156-2');
      }
    </script>
    <script defer src="https://cdn.usefathom.com/script.js" data-site="CEPUOLOQ"></script>
  </body>
</html>
