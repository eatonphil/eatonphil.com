<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="canonical" href="https://notes.eatonphil.com/implementing-a-jq-clone-in-go.html">
    <title>Implementing a simple jq clone in Go, and basics of Go memory profiling | notes.eatonphil.com</title>
    <meta name="description" content="Implementing a simple jq clone in Go, and basics of Go memory profiling" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" href="/rss.xml" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono">
  </head>
  <body>
    <header>
      <!-- <div class="lfw"> -->
      <!-- 	<div class="container"> -->
      <!-- 	  <div class="row"> -->
      <!-- 	    <a href="https://eatonphil.com/hire-me.html">Hire me!</a> -->
      <!-- 	  </div> -->
      <!-- 	</div> -->
      <!-- </div> -->
      <div class="container">
        <div>
          <div class="row">
	    <div>
	      <a href="https://eatonphil.com" class="sm-link">
		Home
              </a>
	      <a href="/" class="sm-link">
		Notes
              </a>
	      <a href="/favorites.html" class="sm-link hide-mobile">
		Popular
              </a>
	      <a href="/rss.xml" class="sm-link">
		RSS
              </a>
	    </div>

	    <div class="subscribe">
	      <!-- <a href="https://eatonphil.com/hire-me.html">Hire me</a> -->
	      <!--
		  Hardcode link to home page because some pages don't
		  have a subscribe box. Some pages hide the subscribe.
		-->
	      <a class="fancy" href="https://eatonphil.com/subscribe.html">
		Subscribe
	      </a>
            </div>
	  </div>
	  <hr />
	  <div class="">
            <h2>July 10, 2022</h2>
            <h1>Implementing a simple jq clone in Go, and basics of Go memory profiling</h1>
	    
            <div class="row" style="padding-bottom: 5px">
              <div class="tags"><a href="/tags/go.html" class="tag">go</a><a href="/tags/parsing.html" class="tag">parsing</a><a href="/tags/profiling.html" class="tag">profiling</a><a href="/tags/json.html" class="tag">json</a></div>
            </div>
	  </div>
	</div>
      </div>
    </header>
    <div class="container">
      <div class="col-6">
	<div class="post">
          <p>In this post we'll build a basic jq clone in Go. It will only be able
to pull a single path out of each object it reads. It won't be able to
do filters, mapping, etc.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>cat<span class="w"> </span>large-file.json<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n2<span class="w"> </span><span class="p">|</span><span class="w"> </span>./jqgo<span class="w"> </span><span class="s1">&#39;.repo.url&#39;</span>
<span class="s2">&quot;https://api.github.com/repos/petroav/6.828&quot;</span>
<span class="s2">&quot;https://api.github.com/repos/rspt/rspt-theme&quot;</span>
</pre></div>
<p>We'll start by building a "control" implementation that uses Go's
builtin JSON library with a JSON path tool on top.</p>
<p>Then we'll implement a basic path-aware JSON parser in 600 lines of
Go. It's going to use a technique (that may have a better name but) I
call "partial parsing" or "fuzzy parsing" where we fully parse what we
care about and only <em>sort of</em> parse the rest.</p>
<p>Why partial parsing? There are two general reasons. One is to use
less memory than parsers that must always turn all of a text into an
object in your language. The other is for when the language has
complexities you don't want or need to deal with. We'll basically have
to deal with all the complexities of JSON so this post is about the
former reason: using less memory. I've written about a case for the
second reason though in <a href="https://datastation.multiprocess.io/blog/2021-10-31-building-a-nested-css-rule-expander.html">building a simple, fast SCSS
implementation</a>.</p>
<p class="note">
  This partial parser is more complex than a typical handwritten
  parser. If you are unfamiliar with handwritten JSON parsers, you may
  want to take a look
  at <a href="https://notes.eatonphil.com/tags/json.html">previous
  articles</a> I've written about parsing JSON.
</p><p>Once we get this partial parser working we'll turn to Go's builtin
profiler to find what we can do to make it faster.</p>
<p>All code for this post is <a href="https://github.com/eatonphil/jqgo">available on
Github</a>.</p>
<h3 id="machine-specs,-versions">Machine specs, versions</h3><p>Since we're going to be doing some rudimentary comparisons of
performance, here are my details. I am running everything on a
dedicated server, <a href="https://us.ovhcloud.com/bare-metal/rise/rise-1/">OVH
Rise-1</a>.</p>
<ul>
<li>RAM: 64 GB DDR4 ECC 2,133 MHz</li>
<li>Disk: 2x450 GB SSD NVMe in Soft RAID</li>
<li>Processor: Intel Xeon E3-1230v6 - 4c/8t - 3.5 GHz/3.9 GHz</li>
</ul>
<p>And relevant versions:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>jq<span class="w"> </span>--version
jq-1.6
$<span class="w"> </span>go<span class="w"> </span>version
go<span class="w"> </span>version<span class="w"> </span>go1.18<span class="w"> </span>linux/amd64
$<span class="w"> </span>uname<span class="w"> </span>-a
Linux<span class="w"> </span>phil<span class="w"> </span><span class="m">5</span>.18.10-100.fc35.x86_64<span class="w"> </span><span class="c1">#1 SMP PREEMPT_DYNAMIC Thu Jul 7 17:41:37 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux</span>
</pre></div>
<p>Now buckle up!</p>
<h3 id="jq-using-go's-builtin-json-library">jq using Go's builtin JSON library</h3><p>This is a very simple program. We just parse JSON data from stdin in a
loop. And after parsing each time we'll call a <code>extractValueAtPath</code>
function to grab the value at the path the user asks for.</p>
<p>To keep our path "parser" very simple we'll treat array access the
same as object access. So we'll look for <code>x.0</code> instead of <code>x[0]</code>,
unlike jq.</p>
<div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;encoding/json&quot;</span>
<span class="w">    </span><span class="s">&quot;io&quot;</span>
<span class="w">    </span><span class="s">&quot;log&quot;</span>
<span class="w">    </span><span class="s">&quot;os&quot;</span>
<span class="w">    </span><span class="s">&quot;strconv&quot;</span>
<span class="w">    </span><span class="s">&quot;strings&quot;</span>
<span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">extractValueAtPath</span><span class="p">(</span><span class="nx">a</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// TODO</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">path</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">Split</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;.&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">path</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">dec</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">NewDecoder</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">)</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span>

<span class="w">    </span><span class="nx">enc</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">NewEncoder</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">)</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">dec</span><span class="p">.</span><span class="nx">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">a</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">break</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">v</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">extractValueAtPath</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">path</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">enc</span><span class="p">.</span><span class="nx">Encode</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Then we implement the <code>extractValueAtPath</code> function itself,
entering into JSON arrays and objects until we reach the end of the
path.</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">extractValueAtPath</span><span class="p">(</span><span class="nx">a</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="kt">any</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">a</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">part</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">arr</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">v</span><span class="p">.([]</span><span class="kt">any</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">n</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strconv</span><span class="p">.</span><span class="nx">Atoi</span><span class="p">(</span><span class="nx">part</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="nx">v</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">arr</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span>
<span class="w">            </span><span class="k">continue</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">m</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">v</span><span class="p">.(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Path into a non-map</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">v</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">m</span><span class="p">[</span><span class="nx">part</span><span class="p">]</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Path does not exist</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">v</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</pre></div>
<p>Alright, let's give it a go module and build and run it!</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>go<span class="w"> </span>mod<span class="w"> </span>init<span class="w"> </span>control
$<span class="w"> </span>go<span class="w"> </span>mod<span class="w"> </span>tidy
$<span class="w"> </span>go<span class="w"> </span>build
<span class="c1"># Grab a test file</span>
$<span class="w"> </span>curl<span class="w"> </span>https://raw.githubusercontent.com/json-iterator/test-data/master/large-file.json<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;.[]&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>large-file.json
$<span class="w"> </span>cat<span class="w"> </span>large-file.json<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n2<span class="w"> </span><span class="p">|</span><span class="w"> </span>./control<span class="w"> </span><span class="s1">&#39;.repo.url&#39;</span>
<span class="s2">&quot;https://api.github.com/repos/petroav/6.828&quot;</span>
<span class="s2">&quot;https://api.github.com/repos/rspt/rspt-theme&quot;</span>
</pre></div>
<p>Sweet. Now let's make sure it produces the same thing as jq.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>cat<span class="w"> </span>large-file.json<span class="w"> </span><span class="p">|</span><span class="w"> </span>./control<span class="w"> </span><span class="s1">&#39;.repo.url&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>control.test
$<span class="w"> </span>cat<span class="w"> </span>large-file.json<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span><span class="s1">&#39;.repo.url&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>jq.test
$<span class="w"> </span>diff<span class="w"> </span>jq.test<span class="w"> </span>control.test
$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$?</span>
<span class="m">0</span>
</pre></div>
<p>Great! It's working for a basic query. Let's see how it performs.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>hyperfine<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s2">&quot;cat large-file.json | ./control &#39;.repo.url&#39; &gt; control.test&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s2">&quot;cat large-file.json | jq &#39;.repo.url&#39; &gt; jq.test&quot;</span>
Benchmark<span class="w"> </span><span class="m">1</span>:<span class="w"> </span>cat<span class="w"> </span>large-file.json<span class="w"> </span><span class="p">|</span><span class="w"> </span>./control<span class="w"> </span><span class="s1">&#39;.repo.url&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>control.test
<span class="w">  </span>Time<span class="w"> </span><span class="o">(</span>mean<span class="w"> </span>±<span class="w"> </span>σ<span class="o">)</span>:<span class="w">     </span><span class="m">310</span>.0<span class="w"> </span>ms<span class="w"> </span>±<span class="w">  </span><span class="m">14</span>.4<span class="w"> </span>ms<span class="w">    </span><span class="o">[</span>User:<span class="w"> </span><span class="m">296</span>.2<span class="w"> </span>ms,<span class="w"> </span>System:<span class="w"> </span><span class="m">49</span>.3<span class="w"> </span>ms<span class="o">]</span>
<span class="w">  </span>Range<span class="w"> </span><span class="o">(</span>min<span class="w"> </span>…<span class="w"> </span>max<span class="o">)</span>:<span class="w">   </span><span class="m">296</span>.1<span class="w"> </span>ms<span class="w"> </span>…<span class="w"> </span><span class="m">344</span>.9<span class="w"> </span>ms<span class="w">    </span><span class="m">10</span><span class="w"> </span>runs

Benchmark<span class="w"> </span><span class="m">2</span>:<span class="w"> </span>cat<span class="w"> </span>large-file.json<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span><span class="s1">&#39;.repo.url&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>jq.test
<span class="w">  </span>Time<span class="w"> </span><span class="o">(</span>mean<span class="w"> </span>±<span class="w"> </span>σ<span class="o">)</span>:<span class="w">     </span><span class="m">355</span>.8<span class="w"> </span>ms<span class="w"> </span>±<span class="w">   </span><span class="m">1</span>.1<span class="w"> </span>ms<span class="w">    </span><span class="o">[</span>User:<span class="w"> </span><span class="m">348</span>.8<span class="w"> </span>ms,<span class="w"> </span>System:<span class="w"> </span><span class="m">27</span>.7<span class="w"> </span>ms<span class="o">]</span>
<span class="w">  </span>Range<span class="w"> </span><span class="o">(</span>min<span class="w"> </span>…<span class="w"> </span>max<span class="o">)</span>:<span class="w">   </span><span class="m">354</span>.8<span class="w"> </span>ms<span class="w"> </span>…<span class="w"> </span><span class="m">358</span>.5<span class="w"> </span>ms<span class="w">    </span><span class="m">10</span><span class="w"> </span>runs

Summary
<span class="w">  </span><span class="s1">&#39;cat large-file.json | ./control &#39;</span>.repo.url<span class="s1">&#39; &gt; control.test&#39;</span><span class="w"> </span>ran
<span class="w">    </span><span class="m">1</span>.15<span class="w"> </span>±<span class="w"> </span><span class="m">0</span>.05<span class="w"> </span><span class="nb">times</span><span class="w"> </span>faster<span class="w"> </span>than<span class="w"> </span><span class="s1">&#39;cat large-file.json | jq &#39;</span>.repo.url<span class="s1">&#39; &gt; jq.test&#39;</span>
</pre></div>
<p>Now that's surprising! This naive implementation in Go is a bit faster
than standard jq. But our implementation supports a heck of a lot less
than jq. So this benchmark on its own isn't incredibly meaningful.</p>
<p>However, it's a good base for comparing to our next implementation.</p>
<p class="note">
  Astute readers may notice that this version doesn't use a buffered
  reader from stdin, while the next version will. I tried this version
  with and without wrapping stdin in a buffered reader but it didn't
  make a meaningful difference. It might be because Go's JSON decoder
  does its own buffering. I'm not sure.
</p><p>Let's do the fun implementation.</p>
<h3 id="partial-parsing">Partial parsing</h3><p>Unlike a typical handwritten parser this partial parser is going to
contain almost two parsers. One parser will care exactly about the
structure of JSON. The other parser will only care about reading past
the current value (whether it be a number or string or array or
object, etc.) The path we pass to the parser will be used to decide
whether each value should be fully parsed or partially parsed.</p>
<p class="note">
  I'll reiterate: this partial parser is more complex than a typical
  handwritten parser. If you are unfamiliar with handwritten JSON
  parsers, you may want to take a look
  at <a href="https://notes.eatonphil.com/tags/json.html">previous
  articles</a> I've written about parsing JSON.
</p><p>The shell of this partial parser is going to look similar to the shell
of the first parser.</p>
<div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;bufio&quot;</span>
<span class="w">    </span><span class="s">&quot;encoding/json&quot;</span>
<span class="w">    </span><span class="s">&quot;fmt&quot;</span>
<span class="w">    </span><span class="s">&quot;io&quot;</span>
<span class="w">    </span><span class="s">&quot;log&quot;</span>
<span class="w">    </span><span class="s">&quot;os&quot;</span>
<span class="w">    </span><span class="s">&quot;strconv&quot;</span>
<span class="w">    </span><span class="s">&quot;strings&quot;</span>
<span class="p">)</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">jsonReader</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">read</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span>
<span class="p">}</span>

<span class="o">...</span><span class="w"> </span><span class="nx">TO</span><span class="w"> </span><span class="nx">IMPLEMENT</span><span class="w"> </span><span class="o">...</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">path</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">Split</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;.&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">path</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">bufio</span><span class="p">.</span><span class="nx">NewReader</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">)</span>
<span class="w">    </span><span class="nx">enc</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">NewEncoder</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">)</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">jr</span><span class="w"> </span><span class="nx">jsonReader</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">val</span><span class="w"> </span><span class="kt">any</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="kt">error</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">jr</span><span class="p">.</span><span class="nx">reset</span><span class="p">()</span>

<span class="w">        </span><span class="nx">val</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">jr</span><span class="p">.</span><span class="nx">extractDataFromJsonPath</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">path</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">break</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Read&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">jr</span><span class="p">.</span><span class="nx">read</span><span class="p">))</span>
<span class="w">            </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatalln</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">enc</span><span class="p">.</span><span class="nx">Encode</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatalln</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Except instead of using the builtin JSON parser we'll call our own
<code>extractDataFromJsonPath</code> function that handles parsing and extraction
all at once.</p>
<p>Before doing that we'll add a few helper functions. The first one grabs
a byte from a reader and stores the read byte locally (so we can print
out all read bytes if the program fails).</p>
<div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">jsonReader</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">read</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">jr</span><span class="w"> </span><span class="o">*</span><span class="nx">jsonReader</span><span class="p">)</span><span class="w"> </span><span class="nx">readByte</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">bufio</span><span class="p">.</span><span class="nx">Reader</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">c</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">ReadByte</span><span class="p">()</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">byte</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">jr</span><span class="p">.</span><span class="nx">read</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">jr</span><span class="p">.</span><span class="nx">read</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">)</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">c</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</pre></div>
<p>The <code>reset</code> member zeroes out the <code>read</code> bytes and gets called before
each object is parsed in the <code>main</code> main loop.</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">jr</span><span class="w"> </span><span class="o">*</span><span class="nx">jsonReader</span><span class="p">)</span><span class="w"> </span><span class="nx">reset</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">jr</span><span class="p">.</span><span class="nx">read</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</pre></div>
<p>Now let's get into <code>extractDataFromJsonPath</code>.</p>
<h3 id="extractdatafromjsonpath">extractDataFromJsonPath</h3><p>This is the real parser. It expects a JSON object and fully parses the
object, almost.</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">jr</span><span class="w"> </span><span class="o">*</span><span class="nx">jsonReader</span><span class="p">)</span><span class="w"> </span><span class="nx">extractDataFromJsonPath</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">bufio</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">jr</span><span class="p">.</span><span class="nx">eatWhitespace</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">jr</span><span class="p">.</span><span class="nx">readByte</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Make sure we&#39;re actually going into an object</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="sc">&#39;{&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;Expected opening curly brace, got: &#39;%s&#39;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="kt">any</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">i</span><span class="o">++</span>

<span class="w">        </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">jr</span><span class="p">.</span><span class="nx">eatWhitespace</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">bs</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Peek</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nx">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">bs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="w">        </span><span class="c1">// We found the end of the object</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;}&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">r</span><span class="p">.</span><span class="nx">Discard</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="k">break</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Key-value pairs must be separated by commas</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;,&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">r</span><span class="p">.</span><span class="nx">Discard</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;Expected comma between key-value pairs, got: &#39;%s&#39;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">jr</span><span class="p">.</span><span class="nx">eatWhitespace</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Grab the key</span>
<span class="w">        </span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">jr</span><span class="p">.</span><span class="nx">expectString</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">jr</span><span class="p">.</span><span class="nx">eatWhitespace</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Find a colon separating key from value</span>
<span class="w">        </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">jr</span><span class="p">.</span><span class="nx">readByte</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="sc">&#39;:&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;Expected colon, got: &#39;%s&#39;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">jr</span><span class="p">.</span><span class="nx">eatWhitespace</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">        </span><span class="p">}</span>
</pre></div>
<p>Up to this point it looks like any old handwritten parser. There are a
few helpers in there (<code>eatWhitespace</code>, <code>expectString</code>) we'll implement
shortly.</p>
<p>But once we see each key and are ready to look for a value we can
decide if we need to fully parse the value (if the path goes into this
key) or if we can partially parse the value (because the path does not
go into this key).</p>
<div class="highlight"><pre><span></span><span class="w">        </span><span class="c1">// If the key is not the start of this path, skip past this value</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">jr</span><span class="p">.</span><span class="nx">eatValue</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">continue</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Otherwise this is a path we want, grab the value</span>
<span class="w">        </span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">jr</span><span class="p">.</span><span class="nx">expectValue</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span><span class="w"> </span><span class="nx">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</pre></div>
<p>And that's it! The core parsing loop is done. The meat now becomes 1)
the <code>eatValue</code> function that partially parses JSON and 2) the
<code>expectValue</code> function that either encounters a scalar value and
returns it or recursively calls <code>extractDataFromJsonPath</code> to enter some new object.</p>
<h4 id="notes-on-helper-naming">Notes on helper naming</h4><p>There are three main kinds of helpers you'll see. <code>expectX</code> helpers
like <code>expectString</code> will return early with an error if they fail to
find what they're looking for. <code>eatX</code> helpers like <code>eatWhitespace</code>
will not return any value and will only move the read cursor
forward. And <code>tryX</code> helpers like <code>tryNumber</code> will do the same thing as
<code>expectString</code> but return an additional boolean argument. So the
caller can decide whether or not to make other attempts at parsing.</p>
<p>But first let's fill in the two helpers we skipped. First off, <code>eatWhitespace</code>.</p>
<h3 id="eatwhitespace">eatWhitespace</h3><p>This function peeks and reads bytes while the bytes are whitespace.</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">jr</span><span class="w"> </span><span class="o">*</span><span class="nx">jsonReader</span><span class="p">)</span><span class="w"> </span><span class="nx">eatWhitespace</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">bufio</span><span class="p">.</span><span class="nx">Reader</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">bs</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Peek</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nx">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">bs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="w">        </span><span class="nx">isWhitespace</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39; &#39;</span><span class="w"> </span><span class="o">||</span>
<span class="w">            </span><span class="nx">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;\n&#39;</span><span class="w"> </span><span class="o">||</span>
<span class="w">            </span><span class="nx">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;\t&#39;</span><span class="w"> </span><span class="o">||</span>
<span class="w">            </span><span class="nx">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;\r&#39;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">isWhitespace</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">r</span><span class="p">.</span><span class="nx">Discard</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>That's it! Next we need to fill in <code>expectString</code>.</p>
<h3 id="expectstring">expectString</h3><p>This is a standard handwritten parser helper that looks for a
double quote and keeps collecting bytes until it finds an ending
double quote that is not escaped.</p>
<div class="highlight"><pre><span></span><span class="k">func</span><span class="w"> </span><span class="p">(</span><span class="n">jr</span><span class="w"> </span><span class="o">*</span><span class="n">jsonReader</span><span class="p">)</span><span class="w"> </span><span class="n">expectString</span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">*</span><span class="n">bufio</span><span class="o">.</span><span class="n">Reader</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="p">[]</span><span class="n">byte</span>

<span class="w">    </span><span class="n">err</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">jr</span><span class="o">.</span><span class="n">eatWhitespace</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">Look</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">opening</span><span class="w"> </span><span class="n">quote</span>
<span class="w">    </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">jr</span><span class="o">.</span><span class="n">readByte</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;&quot;&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s2">&quot;Expected double quote to start string, got: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">prev</span><span class="w"> </span><span class="n">byte</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">jr</span><span class="o">.</span><span class="n">readByte</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">err</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">prev</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="o">//</span><span class="w"> </span><span class="n">Just</span><span class="w"> </span><span class="n">skip</span>
<span class="w">            </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">byte</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="k">continue</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;&quot;&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="o">//</span><span class="w"> </span><span class="n">Overwrite</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">escaped</span><span class="w"> </span><span class="n">double</span><span class="w"> </span><span class="n">quote</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">prev</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">s</span><span class="p">[</span><span class="n">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&quot;&#39;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">//</span><span class="w"> </span><span class="n">Otherwise</span><span class="w"> </span><span class="n">it</span><span class="s1">&#39;s the actual end</span>
<span class="w">                </span><span class="k">break</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">        </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">string</span><span class="p">(</span><span class="n">s</span><span class="p">),</span><span class="w"> </span><span class="n">nil</span>
<span class="p">}</span>
</pre></div>
<p>Standard stuff! Now let's get back to those meaty functions we
introduced before, starting with <code>expectValue</code>.</p>
<h3 id="expectvalue">expectValue</h3><p>This function is called by <code>extractDataFromJsonPath</code> when it wants to
fully parse a value.</p>
<p>If we see a left curly brace, we call <code>extractDataFromJsonPath</code> with
it.</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">jr</span><span class="w"> </span><span class="o">*</span><span class="nx">jsonReader</span><span class="p">)</span><span class="w"> </span><span class="nx">expectValue</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">bufio</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">bs</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Peek</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">bs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;{&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">jr</span><span class="p">.</span><span class="nx">extractDataFromJsonPath</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span><span class="w"> </span><span class="nx">path</span><span class="p">)</span>
</pre></div>
<p>Otherwise if we see a left bracket we call a new helper
<code>extractArrayDataFromJsonPath</code> which will be almost identical to
<code>extractDataFromJsonPath</code> but for parsing array syntax.</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;[&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">jr</span><span class="p">.</span><span class="nx">extractArrayDataFromJsonPath</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span><span class="w"> </span><span class="nx">path</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
<p>If the value we're trying to parse isn't an array or object and
there's more of a path then we have to return null because we can't
enter into a scalar value.</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="c1">// Can&#39;t go any further into a path</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="w"> </span>!<span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Reached the end of this object but more of</span>
<span class="w">        </span><span class="c1">// the path remains. So this object doesn&#39;t</span>
<span class="w">        </span><span class="c1">// contain this path.</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span><span class="w"> </span><span class="n">nil</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
<p>Then we try to parse a scalar (numbers, strings, booleans, <code>null</code>) and
ultimately return an error if nothing worked.</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="nx">ok</span><span class="p">,</span><span class="w"> </span><span class="nx">val</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">jr</span><span class="p">.</span><span class="nx">tryScalar</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;Expected scalar, got: &#39;%s&#39;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">c</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">val</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="p">}</span>
</pre></div>
<p>Let's implement <code>tryScalar</code> and its dependencies now. And we'll come
back to <code>extractArrayDataFromJsonPath</code> afterward.</p>
<h3 id="tryscalar">tryScalar</h3><p>The <code>tryScalar</code> is similar to <code>expectValue</code>. It's called <code>tryScalar</code>
because it's allowed to fail.</p>
<p>We peek at the first byte and switch on a dedicated parsing helper
based on it.</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">jr</span><span class="w"> </span><span class="o">*</span><span class="nx">jsonReader</span><span class="p">)</span><span class="w"> </span><span class="nx">tryScalar</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">bufio</span><span class="p">.</span><span class="nx">Reader</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">bs</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Peek</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">bs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;&quot;&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">val</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">jr</span><span class="p">.</span><span class="nx">expectString</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">val</span><span class="p">),</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;t&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">val</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">jr</span><span class="p">.</span><span class="nx">expectIdentifier</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">val</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;f&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">val</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">jr</span><span class="p">.</span><span class="nx">expectIdentifier</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">val</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;n&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">val</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">jr</span><span class="p">.</span><span class="nx">expectIdentifier</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;null&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">val</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">jr</span><span class="p">.</span><span class="nx">tryNumber</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
<p>This passes control flow to two new functions, <code>expectIdentifier</code> and
<code>tryNumber</code>. Let's do <code>expectIdentifier</code> next.</p>
<h3 id="expectidentifier">expectIdentifier</h3><p>This function tries to match the reader on a string passed to it.</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">jr</span><span class="w"> </span><span class="o">*</span><span class="nx">jsonReader</span><span class="p">)</span><span class="w"> </span><span class="nx">expectIdentifier</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">bufio</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span><span class="w"> </span><span class="nx">ident</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">ident</span><span class="p">);</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">ReadByte</span><span class="p">()</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">s</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">ident</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;Unknown value: &#39;%s&#39;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">s</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
<p class="note">
  Thanks <a href="https://twitter.com/deliberatecoder">Michael
  Lynch</a> for pointing out in an earlier version that
  <code>expectIdentifier</code> does not need to <code>Peek</code>/<code>Discard</code> but can just
  <code>ReadByte</code> instead.
</p><h3 id="trynumber">tryNumber</h3><p>This function tries to parse a number. We'll do a very lazy number
parser that will <em>most likely</em> allow all valid numbers. Internally
we'll call <code>json.Unmarshal</code> on the bytes we build up to do the
conversion itself.</p>
<div class="highlight"><pre><span></span><span class="k">func</span><span class="w"> </span><span class="p">(</span><span class="n">jr</span><span class="w"> </span><span class="o">*</span><span class="n">jsonReader</span><span class="p">)</span><span class="w"> </span><span class="n">tryNumber</span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">*</span><span class="n">bufio</span><span class="o">.</span><span class="n">Reader</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb nb-Type">bool</span><span class="p">,</span><span class="w"> </span><span class="n">any</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="p">[]</span><span class="n">byte</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">Loop</span><span class="w"> </span><span class="n">trying</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">find</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">number</span><span class="o">-</span><span class="n">like</span><span class="w"> </span><span class="n">characters</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">row</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">bs</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="o">.</span><span class="n">Peek</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="bp">false</span><span class="p">,</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span><span class="w"> </span><span class="n">err</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">c</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">bs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="w">        </span><span class="n">isNumberCharacter</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="s1">&#39;9&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;e&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;-&#39;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">isNumberCharacter</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">break</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">append</span><span class="p">(</span><span class="n">number</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span>

<span class="w">        </span><span class="n">r</span><span class="o">.</span><span class="n">Discard</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">number</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">false</span><span class="p">,</span><span class="w"> </span><span class="n">nil</span><span class="p">,</span><span class="w"> </span><span class="n">nil</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="n">float64</span>
<span class="w">    </span><span class="n">err</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">json</span><span class="o">.</span><span class="n">Unmarshal</span><span class="p">(</span><span class="n">number</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">n</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="bp">true</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">err</span>
<span class="p">}</span>
</pre></div>
<p>If we can't find a number, that's ok. We'll just say so in the first
argument by returning <code>false</code>.</p>
<h3 id="outstanding-functions">Outstanding functions</h3><p>Ok we've come a while building out helper functions. The last two
remaining helpers are <code>extractArrayDataFromJsonPath</code> and
<code>eatValue</code>. Let's finish up these real parser functions before getting
to <code>eatValue</code>, the primary partial parsing function.</p>
<h3 id="extractarraydatafromjsonpath">extractArrayDataFromJsonPath</h3><p>This function is almost identical to <code>extractDataFromJsonPath</code> but
rather than parsing key-value pairs inside curly braces it parses
values inside brackets.</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">jr</span><span class="w"> </span><span class="o">*</span><span class="nx">jsonReader</span><span class="p">)</span><span class="w"> </span><span class="nx">extractArrayDataFromJsonPath</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">bufio</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Path inside an array must be an integer</span>
<span class="w">    </span><span class="nx">n</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strconv</span><span class="p">.</span><span class="nx">Atoi</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Look for opening bracket. Make sure we&#39;re in an array</span>
<span class="w">    </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">jr</span><span class="p">.</span><span class="nx">readByte</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="sc">&#39;[&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;Expected opening bracket, got: &#39;%s&#39;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="kt">any</span>
<span class="w">    </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">i</span><span class="o">++</span>

<span class="w">        </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">jr</span><span class="p">.</span><span class="nx">eatWhitespace</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">bs</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Peek</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nx">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">bs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="w">        </span><span class="c1">// Found closing bracket, exit the array</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;]&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">r</span><span class="p">.</span><span class="nx">Discard</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="k">break</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Array values must be separated by a comma</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;,&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">r</span><span class="p">.</span><span class="nx">Discard</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;Expected comma between key-value pairs, got: &#39;%s&#39;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">jr</span><span class="p">.</span><span class="nx">eatWhitespace</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">        </span><span class="p">}</span>
</pre></div>
<p>Just like <code>extractDataFromJsonPath</code> it either calls <code>eatValue</code> or
<code>expectValue</code> depending on whether the current index matches the
requested path.</p>
<div class="highlight"><pre><span></span><span class="w">        </span><span class="c1">// If the key is not the start of this path, skip past this value</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">jr</span><span class="p">.</span><span class="nx">eatValue</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">continue</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">jr</span><span class="p">.</span><span class="nx">expectValue</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span><span class="w"> </span><span class="nx">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</pre></div>
<p>That's it for full parser functions! Let's do the partial parser,
<code>eatValue</code>.</p>
<h3 id="eatvalue">eatValue</h3><p>This function is simpler than the full parser functions we wrote
before.</p>
<p>First off it looks for the simple case where the value is a scalar.</p>
<div class="highlight"><pre><span></span><span class="k">func</span><span class="w"> </span><span class="p">(</span><span class="n">jr</span><span class="w"> </span><span class="o">*</span><span class="n">jsonReader</span><span class="p">)</span><span class="w"> </span><span class="n">eatValue</span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">*</span><span class="n">bufio</span><span class="o">.</span><span class="n">Reader</span><span class="p">)</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="p">[]</span><span class="n">byte</span>

<span class="w">    </span><span class="n">inString</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="bp">false</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">prev</span><span class="w"> </span><span class="n">byte</span>

<span class="w">    </span><span class="n">err</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">jr</span><span class="o">.</span><span class="n">eatWhitespace</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">jr</span><span class="o">.</span><span class="n">tryScalar</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">It</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">scalar</span><span class="p">,</span><span class="w"> </span><span class="n">we</span><span class="s1">&#39;re done!</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">nil</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
<p>All it does is read until the value ends.</p>
<p>If the value is not a scalar though we need to read past complete JSON
arrays and/or objects.</p>
<p>To do this we'll simply read through bytes, monitoring a stack of
open and close braces and brackets. If we enter a string we'll skip
all bytes inside the string until the string ends.</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="c1">// Otherwise it&#39;s an array or object</span>
<span class="w">    </span><span class="nx">first</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">true</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">first</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">stack</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">first</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">false</span>

<span class="w">        </span><span class="nx">bs</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Peek</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nx">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">bs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">inString</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;&quot;&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">prev</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="sc">&#39;\\&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">inString</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// Two \\-es cancel eachother out</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;\\&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">prev</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;\\&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">prev</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">byte</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">prev</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">b</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="nx">r</span><span class="p">.</span><span class="nx">Discard</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="k">continue</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;[&#39;</span><span class="p">:</span>
<span class="w">            </span><span class="nx">stack</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">stack</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;]&#39;</span><span class="p">:</span>
<span class="w">            </span><span class="nx">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">stack</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">stack</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="w">            </span><span class="nx">stack</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">stack</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="nx">stack</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="sc">&#39;[&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;Unexpected end of array: &#39;%s&#39;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">c</span><span class="p">))</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;{&#39;</span><span class="p">:</span>
<span class="w">            </span><span class="nx">stack</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">stack</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;}&#39;</span><span class="p">:</span>
<span class="w">            </span><span class="nx">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">stack</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">stack</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="w">            </span><span class="nx">stack</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">stack</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="nx">stack</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="sc">&#39;{&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;Unexpected end of object: &#39;%s&#39;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">c</span><span class="p">))</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;&quot;&#39;</span><span class="p">:</span>
<span class="w">            </span><span class="nx">inString</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">            </span><span class="c1">// Closing quote case handled elsewhere, above</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">r</span><span class="p">.</span><span class="nx">Discard</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="nx">prev</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">b</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</pre></div>
<p>And we're finally done the first pass of the path-aware jq
implementation.</p>
<h3 id="build,-test,-benchmark">Build, test, benchmark</h3><p>Let's give it a go module, build and test it.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>go<span class="w"> </span>mod<span class="w"> </span>init<span class="w"> </span>jqgo
$<span class="w"> </span>go<span class="w"> </span>build
$<span class="w"> </span>curl<span class="w"> </span>https://raw.githubusercontent.com/json-iterator/test-data/master/large-file.json<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;.[]&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>large-file.json
$<span class="w"> </span>cat<span class="w"> </span>large-file.json<span class="w"> </span><span class="p">|</span><span class="w"> </span>./jqgo<span class="w"> </span><span class="s1">&#39;.repo.url&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>jqgo.test
$<span class="w"> </span>cat<span class="w"> </span>large-file.json<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span><span class="s1">&#39;.repo.url&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>jq.test
$<span class="w"> </span>diff<span class="w"> </span>jq.test<span class="w"> </span>jqgo.test
$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$?</span>
<span class="m">0</span>
</pre></div>
<p>Great! :) Let's benchmark it against jq and the control
implementation.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>hyperfine<span class="w"> </span>--warmup<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s2">&quot;cat large-file.json | ./control/control &#39;.repo.url&#39; &gt; control.test&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s2">&quot;cat large-file.json | ./jqgo &#39;.repo.url&#39; &gt; jqgo.test&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s2">&quot;cat large-file.json | jq &#39;.repo.url&#39; &gt; jq.test&quot;</span>
Benchmark<span class="w"> </span><span class="m">1</span>:<span class="w"> </span>cat<span class="w"> </span>large-file.json<span class="w"> </span><span class="p">|</span><span class="w"> </span>./control/control<span class="w"> </span><span class="s1">&#39;.repo.url&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>control.test
<span class="w">  </span>Time<span class="w"> </span><span class="o">(</span>mean<span class="w"> </span>±<span class="w"> </span>σ<span class="o">)</span>:<span class="w">     </span><span class="m">302</span>.0<span class="w"> </span>ms<span class="w"> </span>±<span class="w">   </span><span class="m">3</span>.4<span class="w"> </span>ms<span class="w">    </span><span class="o">[</span>User:<span class="w"> </span><span class="m">283</span>.7<span class="w"> </span>ms,<span class="w"> </span>System:<span class="w"> </span><span class="m">53</span>.1<span class="w"> </span>ms<span class="o">]</span>
<span class="w">  </span>Range<span class="w"> </span><span class="o">(</span>min<span class="w"> </span>…<span class="w"> </span>max<span class="o">)</span>:<span class="w">   </span><span class="m">297</span>.4<span class="w"> </span>ms<span class="w"> </span>…<span class="w"> </span><span class="m">309</span>.0<span class="w"> </span>ms<span class="w">    </span><span class="m">10</span><span class="w"> </span>runs

Benchmark<span class="w"> </span><span class="m">2</span>:<span class="w"> </span>cat<span class="w"> </span>large-file.json<span class="w"> </span><span class="p">|</span><span class="w"> </span>./jqgo<span class="w"> </span><span class="s1">&#39;.repo.url&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>jqgo.test
<span class="w">  </span>Time<span class="w"> </span><span class="o">(</span>mean<span class="w"> </span>±<span class="w"> </span>σ<span class="o">)</span>:<span class="w">     </span><span class="m">258</span>.8<span class="w"> </span>ms<span class="w"> </span>±<span class="w">   </span><span class="m">2</span>.2<span class="w"> </span>ms<span class="w">    </span><span class="o">[</span>User:<span class="w"> </span><span class="m">230</span>.3<span class="w"> </span>ms,<span class="w"> </span>System:<span class="w"> </span><span class="m">47</span>.6<span class="w"> </span>ms<span class="o">]</span>
<span class="w">  </span>Range<span class="w"> </span><span class="o">(</span>min<span class="w"> </span>…<span class="w"> </span>max<span class="o">)</span>:<span class="w">   </span><span class="m">256</span>.3<span class="w"> </span>ms<span class="w"> </span>…<span class="w"> </span><span class="m">262</span>.6<span class="w"> </span>ms<span class="w">    </span><span class="m">11</span><span class="w"> </span>runs

Benchmark<span class="w"> </span><span class="m">3</span>:<span class="w"> </span>cat<span class="w"> </span>large-file.json<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span><span class="s1">&#39;.repo.url&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>jq.test
<span class="w">  </span>Time<span class="w"> </span><span class="o">(</span>mean<span class="w"> </span>±<span class="w"> </span>σ<span class="o">)</span>:<span class="w">     </span><span class="m">357</span>.6<span class="w"> </span>ms<span class="w"> </span>±<span class="w">   </span><span class="m">2</span>.9<span class="w"> </span>ms<span class="w">    </span><span class="o">[</span>User:<span class="w"> </span><span class="m">350</span>.0<span class="w"> </span>ms,<span class="w"> </span>System:<span class="w"> </span><span class="m">28</span>.3<span class="w"> </span>ms<span class="o">]</span>
<span class="w">  </span>Range<span class="w"> </span><span class="o">(</span>min<span class="w"> </span>…<span class="w"> </span>max<span class="o">)</span>:<span class="w">   </span><span class="m">355</span>.0<span class="w"> </span>ms<span class="w"> </span>…<span class="w"> </span><span class="m">362</span>.9<span class="w"> </span>ms<span class="w">    </span><span class="m">10</span><span class="w"> </span>runs

Summary
<span class="w">  </span><span class="s1">&#39;cat large-file.json | ./jqgo &#39;</span>.repo.url<span class="s1">&#39; &gt; jqgo.test&#39;</span><span class="w"> </span>ran
<span class="w">    </span><span class="m">1</span>.17<span class="w"> </span>±<span class="w"> </span><span class="m">0</span>.02<span class="w"> </span><span class="nb">times</span><span class="w"> </span>faster<span class="w"> </span>than<span class="w"> </span><span class="s1">&#39;cat large-file.json | ./control/control &#39;</span>.repo.url<span class="s1">&#39; &gt; control.test&#39;</span>
<span class="w">    </span><span class="m">1</span>.38<span class="w"> </span>±<span class="w"> </span><span class="m">0</span>.02<span class="w"> </span><span class="nb">times</span><span class="w"> </span>faster<span class="w"> </span>than<span class="w"> </span><span class="s1">&#39;cat large-file.json | jq &#39;</span>.repo.url<span class="s1">&#39; &gt; jq.test&#39;</span>
</pre></div>
<p>Now to my surprise we're already beating the non-path-aware control
implementation! When I first wrote the path-aware version, it was
slower than the control. So I had to start performance profiling. For
this blog post I tried to remake the slowest variation I could
remember but I couldn't get it slower than this.</p>
<p>That said, the best version <em>was</em> faster than this so I <em>can</em>
demonstrate the process of profiling to improve performance.</p>
<p>Let's dig in. :)</p>
<h3 id="profiling-in-go">Profiling in Go</h3><p>There are various ways to enable profiling in Go. One way some people
recommend is through the <a href="https://dave.cheney.net/2013/06/30/how-to-write-benchmarks-in-go">builtin benchmark
support</a>
in <code>go test</code>. I don't really like this method though. I prefer to use
<a href="https://github.com/pkg/profile">pkg/profile</a> manually in <code>main.go</code>.</p>
<div class="highlight"><pre><span></span><span class="gu">@@ -9,6 +9,8 @@</span>
<span class="w"> </span>       &quot;os&quot;
<span class="w"> </span>       &quot;strconv&quot;
<span class="w"> </span>       &quot;strings&quot;
<span class="gi">+</span>
<span class="gi">+       &quot;github.com/pkg/profile&quot;</span>
<span class="w"> </span>)

<span class="w"> </span>type jsonReader struct {
<span class="gu">@@ -450,6 +452,7 @@</span>
<span class="w"> </span>}

<span class="w"> </span>func main() {
<span class="gi">+       defer profile.Start().Stop()</span>
<span class="w"> </span>       path := strings.Split(os.Args[1], &quot;.&quot;)
<span class="w"> </span>       if path[0] == &quot;&quot; {
<span class="w"> </span>               path = path[1:]
</pre></div>
<p>Build and run:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>go<span class="w"> </span>mod<span class="w"> </span>tidy
$<span class="w"> </span>go<span class="w"> </span>build
$<span class="w"> </span>cat<span class="w"> </span>large-file.json<span class="w"> </span><span class="p">|</span><span class="w"> </span>./jqgo<span class="w"> </span><span class="s1">&#39;.repo.url&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>/dev/null
<span class="m">2022</span>/07/11<span class="w"> </span><span class="m">02</span>:38:57<span class="w"> </span>profile:<span class="w"> </span>cpu<span class="w"> </span>profiling<span class="w"> </span>enabled,<span class="w"> </span>/tmp/profile3691177944/cpu.pprof
<span class="m">2022</span>/07/11<span class="w"> </span><span class="m">02</span>:38:58<span class="w"> </span>profile:<span class="w"> </span>cpu<span class="w"> </span>profiling<span class="w"> </span>disabled,<span class="w"> </span>/tmp/profile3691177944/cpu.pprof
</pre></div>
<p>Go can <a href="https://www.honeycomb.io/blog/golang-observability-using-the-new-pprof-web-ui-to-debug-memory-usage/">run a web
server</a>
to visualize the pprof results but I find (after literally a few years
of trying to figure it out) the CLI makes more sense to me.</p>
<div class="highlight"><pre><span></span><span class="err">$</span><span class="w"> </span><span class="k">go</span><span class="w"> </span><span class="nx">tool</span><span class="w"> </span><span class="nx">pprof</span><span class="w"> </span><span class="o">/</span><span class="nx">tmp</span><span class="o">/</span><span class="nx">profile3691177944</span><span class="o">/</span><span class="nx">cpu</span><span class="p">.</span><span class="nx">pprof</span>
<span class="nx">File</span><span class="p">:</span><span class="w"> </span><span class="nx">jqgo</span>
<span class="nx">Type</span><span class="p">:</span><span class="w"> </span><span class="nx">cpu</span>
<span class="nx">Time</span><span class="p">:</span><span class="w"> </span><span class="nx">Jul</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">2022</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="mi">38</span><span class="nx">am</span><span class="w"> </span><span class="p">(</span><span class="nx">UTC</span><span class="p">)</span>
<span class="nx">Duration</span><span class="p">:</span><span class="w"> </span><span class="mf">401.63</span><span class="nx">ms</span><span class="p">,</span><span class="w"> </span><span class="nx">Total</span><span class="w"> </span><span class="nx">samples</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">270</span><span class="nx">ms</span><span class="w"> </span><span class="p">(</span><span class="mf">67.23</span><span class="o">%</span><span class="p">)</span>
<span class="nx">Entering</span><span class="w"> </span><span class="nx">interactive</span><span class="w"> </span><span class="nx">mode</span><span class="w"> </span><span class="p">(</span><span class="kd">type</span><span class="w"> </span><span class="s">&quot;help&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">commands</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;o&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">options</span><span class="p">)</span>
<span class="p">(</span><span class="nx">pprof</span><span class="p">)</span>
</pre></div>
<p>Now we run <code>top10</code> to see where we spend the bulk of time.</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nx">pprof</span><span class="p">)</span><span class="w"> </span><span class="nx">top10</span>
<span class="nx">Showing</span><span class="w"> </span><span class="nx">nodes</span><span class="w"> </span><span class="nx">accounting</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="mi">260</span><span class="nx">ms</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="o">%</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="mi">260</span><span class="nx">ms</span><span class="w"> </span><span class="nx">total</span>
<span class="nx">Showing</span><span class="w"> </span><span class="nx">top</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="nx">nodes</span><span class="w"> </span><span class="nx">out</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="mi">31</span>
<span class="w">      </span><span class="nx">flat</span><span class="w">  </span><span class="nx">flat</span><span class="o">%</span><span class="w">   </span><span class="nx">sum</span><span class="o">%</span><span class="w">        </span><span class="nx">cum</span><span class="w">   </span><span class="nx">cum</span><span class="o">%</span>
<span class="w">      </span><span class="mi">90</span><span class="nx">ms</span><span class="w"> </span><span class="mf">34.62</span><span class="o">%</span><span class="w"> </span><span class="mf">34.62</span><span class="o">%</span><span class="w">      </span><span class="mi">230</span><span class="nx">ms</span><span class="w"> </span><span class="mf">88.46</span><span class="o">%</span><span class="w">  </span><span class="nx">main</span><span class="p">.(</span><span class="o">*</span><span class="nx">jsonReader</span><span class="p">).</span><span class="nx">eatValue</span>
<span class="w">      </span><span class="mi">60</span><span class="nx">ms</span><span class="w"> </span><span class="mf">23.08</span><span class="o">%</span><span class="w"> </span><span class="mf">57.69</span><span class="o">%</span><span class="w">       </span><span class="mi">70</span><span class="nx">ms</span><span class="w"> </span><span class="mf">26.92</span><span class="o">%</span><span class="w">  </span><span class="nx">bufio</span><span class="p">.(</span><span class="o">*</span><span class="nx">Reader</span><span class="p">).</span><span class="nx">Peek</span>
<span class="w">      </span><span class="mi">50</span><span class="nx">ms</span><span class="w"> </span><span class="mf">19.23</span><span class="o">%</span><span class="w"> </span><span class="mf">76.92</span><span class="o">%</span><span class="w">       </span><span class="mi">60</span><span class="nx">ms</span><span class="w"> </span><span class="mf">23.08</span><span class="o">%</span><span class="w">  </span><span class="nx">bufio</span><span class="p">.(</span><span class="o">*</span><span class="nx">Reader</span><span class="p">).</span><span class="nx">Discard</span>
<span class="w">      </span><span class="mi">20</span><span class="nx">ms</span><span class="w">  </span><span class="mf">7.69</span><span class="o">%</span><span class="w"> </span><span class="mf">84.62</span><span class="o">%</span><span class="w">       </span><span class="mi">20</span><span class="nx">ms</span><span class="w">  </span><span class="mf">7.69</span><span class="o">%</span><span class="w">  </span><span class="nx">syscall</span><span class="p">.</span><span class="nx">Syscall</span>
<span class="w">      </span><span class="mi">10</span><span class="nx">ms</span><span class="w">  </span><span class="mf">3.85</span><span class="o">%</span><span class="w"> </span><span class="mf">88.46</span><span class="o">%</span><span class="w">       </span><span class="mi">10</span><span class="nx">ms</span><span class="w">  </span><span class="mf">3.85</span><span class="o">%</span><span class="w">  </span><span class="nx">bufio</span><span class="p">.(</span><span class="o">*</span><span class="nx">Reader</span><span class="p">).</span><span class="nx">Buffered</span><span class="w"> </span><span class="p">(</span><span class="nx">inline</span><span class="p">)</span>
<span class="w">      </span><span class="mi">10</span><span class="nx">ms</span><span class="w">  </span><span class="mf">3.85</span><span class="o">%</span><span class="w"> </span><span class="mf">92.31</span><span class="o">%</span><span class="w">       </span><span class="mi">10</span><span class="nx">ms</span><span class="w">  </span><span class="mf">3.85</span><span class="o">%</span><span class="w">  </span><span class="nx">main</span><span class="p">.(</span><span class="o">*</span><span class="nx">jsonReader</span><span class="p">).</span><span class="nx">readByte</span>
<span class="w">      </span><span class="mi">10</span><span class="nx">ms</span><span class="w">  </span><span class="mf">3.85</span><span class="o">%</span><span class="w"> </span><span class="mf">96.15</span><span class="o">%</span><span class="w">       </span><span class="mi">10</span><span class="nx">ms</span><span class="w">  </span><span class="mf">3.85</span><span class="o">%</span><span class="w">  </span><span class="nx">runtime</span><span class="p">.</span><span class="nx">slicebytetostring</span>
<span class="w">      </span><span class="mi">10</span><span class="nx">ms</span><span class="w">  </span><span class="mf">3.85</span><span class="o">%</span><span class="w">   </span><span class="mi">100</span><span class="o">%</span><span class="w">       </span><span class="mi">10</span><span class="nx">ms</span><span class="w">  </span><span class="mf">3.85</span><span class="o">%</span><span class="w">  </span><span class="nx">runtime</span><span class="p">.</span><span class="nx">stkbucket</span>
<span class="w">         </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="o">%</span><span class="w">   </span><span class="mi">100</span><span class="o">%</span><span class="w">       </span><span class="mi">10</span><span class="nx">ms</span><span class="w">  </span><span class="mf">3.85</span><span class="o">%</span><span class="w">  </span><span class="nx">bufio</span><span class="p">.(</span><span class="o">*</span><span class="nx">Reader</span><span class="p">).</span><span class="nx">fill</span>
<span class="w">         </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="o">%</span><span class="w">   </span><span class="mi">100</span><span class="o">%</span><span class="w">       </span><span class="mi">10</span><span class="nx">ms</span><span class="w">  </span><span class="mf">3.85</span><span class="o">%</span><span class="w">  </span><span class="nx">encoding</span><span class="o">/</span><span class="nx">json</span><span class="p">.(</span><span class="o">*</span><span class="nx">Encoder</span><span class="p">).</span><span class="nx">Encode</span>
</pre></div>
<p>Now this is weird. Why are <code>Peek</code> and <code>Discard</code> so expensive? And why
are we spending so much time in <code>syscall.Syscall</code>? The entire point of
buffered I/O is to avoid hitting syscalls too frequently.</p>
<p>But since 88% of time is spent in <code>eatValue</code>, let's verify where in
<code>eatValue</code> we are spending that time.</p>
<p>Within the <code>pprof</code> REPL we can enter <code>list X</code> where <code>X</code> is a regexp of
a function name.</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nx">pprof</span><span class="p">)</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="nx">eatValue</span>
<span class="nx">Total</span><span class="p">:</span><span class="w"> </span><span class="mi">260</span><span class="nx">ms</span>
<span class="nx">ROUTINE</span><span class="w"> </span><span class="o">========================</span><span class="w"> </span><span class="nx">main</span><span class="p">.(</span><span class="o">*</span><span class="nx">jsonReader</span><span class="p">).</span><span class="nx">eatValue</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="o">/</span><span class="nx">home</span><span class="o">/</span><span class="nx">phil</span><span class="o">/</span><span class="nx">tmp</span><span class="o">/</span><span class="nx">jqgo</span><span class="o">/</span><span class="nx">mainprof</span><span class="p">.</span><span class="k">go</span>
<span class="w">      </span><span class="mi">90</span><span class="nx">ms</span><span class="w">      </span><span class="mi">230</span><span class="nx">ms</span><span class="w"> </span><span class="p">(</span><span class="nx">flat</span><span class="p">,</span><span class="w"> </span><span class="nx">cum</span><span class="p">)</span><span class="w"> </span><span class="mf">88.46</span><span class="o">%</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">Total</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">159</span><span class="p">:</span><span class="w">   </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">jr</span><span class="p">.</span><span class="nx">eatWhitespace</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">160</span><span class="p">:</span><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">161</span><span class="p">:</span><span class="w">           </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">162</span><span class="p">:</span><span class="w">   </span><span class="p">}</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">163</span><span class="p">:</span>
<span class="w">         </span><span class="p">.</span><span class="w">       </span><span class="mi">20</span><span class="nx">ms</span><span class="w">    </span><span class="mi">164</span><span class="p">:</span><span class="w">   </span><span class="nx">ok</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">jr</span><span class="p">.</span><span class="nx">tryScalar</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">165</span><span class="p">:</span><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">166</span><span class="p">:</span><span class="w">           </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">167</span><span class="p">:</span><span class="w">   </span><span class="p">}</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">168</span><span class="p">:</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">169</span><span class="p">:</span><span class="w">   </span><span class="c1">// It was a scalar, we&#39;re done!</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">170</span><span class="p">:</span><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">171</span><span class="p">:</span><span class="w">           </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">172</span><span class="p">:</span><span class="w">   </span><span class="p">}</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">173</span><span class="p">:</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">174</span><span class="p">:</span><span class="w">   </span><span class="c1">// Otherwise it&#39;s an array or object</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">175</span><span class="p">:</span><span class="w">   </span><span class="nx">first</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">176</span><span class="p">:</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">177</span><span class="p">:</span><span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="nx">first</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">stack</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">178</span><span class="p">:</span><span class="w">           </span><span class="nx">first</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">179</span><span class="p">:</span>
<span class="w">         </span><span class="p">.</span><span class="w">       </span><span class="mi">60</span><span class="nx">ms</span><span class="w">    </span><span class="mi">180</span><span class="p">:</span><span class="w">           </span><span class="nx">bs</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Peek</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">181</span><span class="p">:</span><span class="w">           </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">182</span><span class="p">:</span><span class="w">                   </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">183</span><span class="p">:</span><span class="w">           </span><span class="p">}</span>
<span class="w">      </span><span class="mi">10</span><span class="nx">ms</span><span class="w">       </span><span class="mi">10</span><span class="nx">ms</span><span class="w">    </span><span class="mi">184</span><span class="p">:</span><span class="w">           </span><span class="nx">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">bs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">185</span><span class="p">:</span>
<span class="w">      </span><span class="mi">10</span><span class="nx">ms</span><span class="w">       </span><span class="mi">10</span><span class="nx">ms</span><span class="w">    </span><span class="mi">186</span><span class="p">:</span><span class="w">           </span><span class="k">if</span><span class="w"> </span><span class="nx">inString</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">187</span><span class="p">:</span><span class="w">                   </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;&quot;&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">prev</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="sc">&#39;\\&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">188</span><span class="p">:</span><span class="w">                           </span><span class="nx">inString</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">189</span><span class="p">:</span><span class="w">                   </span><span class="p">}</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">190</span><span class="p">:</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">191</span><span class="p">:</span><span class="w">                   </span><span class="c1">// Two \\-es cancel eachother out</span>
<span class="w">      </span><span class="mi">10</span><span class="nx">ms</span><span class="w">       </span><span class="mi">10</span><span class="nx">ms</span><span class="w">    </span><span class="mi">192</span><span class="p">:</span><span class="w">                   </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;\\&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">prev</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;\\&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">193</span><span class="p">:</span><span class="w">                           </span><span class="nx">prev</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">byte</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">194</span><span class="p">:</span><span class="w">                   </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">195</span><span class="p">:</span><span class="w">                           </span><span class="nx">prev</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">b</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">196</span><span class="p">:</span><span class="w">                   </span><span class="p">}</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">197</span><span class="p">:</span>
<span class="w">         </span><span class="p">.</span><span class="w">       </span><span class="mi">60</span><span class="nx">ms</span><span class="w">    </span><span class="mi">198</span><span class="p">:</span><span class="w">                   </span><span class="nx">r</span><span class="p">.</span><span class="nx">Discard</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">199</span><span class="p">:</span><span class="w">                   </span><span class="k">continue</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">200</span><span class="p">:</span><span class="w">           </span><span class="p">}</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">201</span><span class="p">:</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">202</span><span class="p">:</span><span class="w">           </span><span class="k">switch</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">203</span><span class="p">:</span><span class="w">           </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;[&#39;</span><span class="p">:</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">204</span><span class="p">:</span><span class="w">                   </span><span class="nx">stack</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">stack</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span>
<span class="w">      </span><span class="mi">10</span><span class="nx">ms</span><span class="w">       </span><span class="mi">10</span><span class="nx">ms</span><span class="w">    </span><span class="mi">205</span><span class="p">:</span><span class="w">           </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;]&#39;</span><span class="p">:</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">206</span><span class="p">:</span><span class="w">                   </span><span class="nx">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">stack</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">stack</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">207</span><span class="p">:</span><span class="w">                   </span><span class="nx">stack</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">stack</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="nx">stack</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">208</span><span class="p">:</span><span class="w">                   </span><span class="k">if</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="sc">&#39;[&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">209</span><span class="p">:</span><span class="w">                           </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;Unexpected end of array: &#39;%s&#39;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">c</span><span class="p">))</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">210</span><span class="p">:</span><span class="w">                   </span><span class="p">}</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">211</span><span class="p">:</span><span class="w">           </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;{&#39;</span><span class="p">:</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">212</span><span class="p">:</span><span class="w">                   </span><span class="nx">stack</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">stack</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">213</span><span class="p">:</span><span class="w">           </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;}&#39;</span><span class="p">:</span>
<span class="w">      </span><span class="mi">50</span><span class="nx">ms</span><span class="w">       </span><span class="mi">50</span><span class="nx">ms</span><span class="w">    </span><span class="mi">214</span><span class="p">:</span><span class="w">                   </span><span class="nx">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">stack</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">stack</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">215</span><span class="p">:</span><span class="w">                   </span><span class="nx">stack</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">stack</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="nx">stack</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">216</span><span class="p">:</span><span class="w">                   </span><span class="k">if</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="sc">&#39;{&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">217</span><span class="p">:</span><span class="w">                           </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;Unexpected end of object: &#39;%s&#39;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">c</span><span class="p">))</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">218</span><span class="p">:</span><span class="w">                   </span><span class="p">}</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">219</span><span class="p">:</span><span class="w">           </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;&quot;&#39;</span><span class="p">:</span>
</pre></div>
<p>So by rank we can see we do spend the most time in <code>Peek</code> and
<code>Discard</code>. Then in pulling the last item out of the stack??? That's
weird. Let's ignore that.</p>
<h3 id="peek-and-discard">Peek and Discard</h3><p>Let's look at <code>Peek</code> in the pprof REPL:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nx">pprof</span><span class="p">)</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="nx">Peek</span>
<span class="nx">Total</span><span class="p">:</span><span class="w"> </span><span class="mi">260</span><span class="nx">ms</span>
<span class="nx">ROUTINE</span><span class="w"> </span><span class="o">========================</span><span class="w"> </span><span class="nx">bufio</span><span class="p">.(</span><span class="o">*</span><span class="nx">Reader</span><span class="p">).</span><span class="nx">Peek</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="o">/</span><span class="nx">usr</span><span class="o">/</span><span class="nx">local</span><span class="o">/</span><span class="k">go</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">bufio</span><span class="o">/</span><span class="nx">bufio</span><span class="p">.</span><span class="k">go</span>
<span class="w">      </span><span class="mi">60</span><span class="nx">ms</span><span class="w">       </span><span class="mi">70</span><span class="nx">ms</span><span class="w"> </span><span class="p">(</span><span class="nx">flat</span><span class="p">,</span><span class="w"> </span><span class="nx">cum</span><span class="p">)</span><span class="w"> </span><span class="mf">26.92</span><span class="o">%</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">Total</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">130</span><span class="p">:</span><span class="c1">// also returns an error explaining why the read is short. The error is</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">131</span><span class="p">:</span><span class="c1">// ErrBufferFull if n is larger than b&#39;s buffer size.</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">132</span><span class="p">:</span><span class="c1">//</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">133</span><span class="p">:</span><span class="c1">// Calling Peek prevents a UnreadByte or UnreadRune call from succeeding</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">134</span><span class="p">:</span><span class="c1">// until the next read operation.</span>
<span class="w">      </span><span class="mi">10</span><span class="nx">ms</span><span class="w">       </span><span class="mi">10</span><span class="nx">ms</span><span class="w">    </span><span class="mi">135</span><span class="p">:</span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">*</span><span class="nx">Reader</span><span class="p">)</span><span class="w"> </span><span class="nx">Peek</span><span class="p">(</span><span class="nx">n</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">136</span><span class="p">:</span><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">137</span><span class="p">:</span><span class="w">           </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">ErrNegativeCount</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">138</span><span class="p">:</span><span class="w">   </span><span class="p">}</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">139</span><span class="p">:</span>
<span class="w">      </span><span class="mi">10</span><span class="nx">ms</span><span class="w">       </span><span class="mi">10</span><span class="nx">ms</span><span class="w">    </span><span class="mi">140</span><span class="p">:</span><span class="w">   </span><span class="nx">b</span><span class="p">.</span><span class="nx">lastByte</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">141</span><span class="p">:</span><span class="w">   </span><span class="nx">b</span><span class="p">.</span><span class="nx">lastRuneSize</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">142</span><span class="p">:</span>
<span class="w">      </span><span class="mi">20</span><span class="nx">ms</span><span class="w">       </span><span class="mi">20</span><span class="nx">ms</span><span class="w">    </span><span class="mi">143</span><span class="p">:</span><span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">w</span><span class="o">-</span><span class="nx">b</span><span class="p">.</span><span class="nx">r</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">w</span><span class="o">-</span><span class="nx">b</span><span class="p">.</span><span class="nx">r</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">buf</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="p">.</span><span class="w">       </span><span class="mi">10</span><span class="nx">ms</span><span class="w">    </span><span class="mi">144</span><span class="p">:</span><span class="w">           </span><span class="nx">b</span><span class="p">.</span><span class="nx">fill</span><span class="p">()</span><span class="w"> </span><span class="c1">// b.w-b.r &lt; len(b.buf) =&gt; buffer is not full</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">145</span><span class="p">:</span><span class="w">   </span><span class="p">}</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">146</span><span class="p">:</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">147</span><span class="p">:</span><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">buf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">148</span><span class="p">:</span><span class="w">           </span><span class="k">return</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">buf</span><span class="p">[</span><span class="nx">b</span><span class="p">.</span><span class="nx">r</span><span class="p">:</span><span class="nx">b</span><span class="p">.</span><span class="nx">w</span><span class="p">],</span><span class="w"> </span><span class="nx">ErrBufferFull</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">149</span><span class="p">:</span><span class="w">   </span><span class="p">}</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">150</span><span class="p">:</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">151</span><span class="p">:</span><span class="w">   </span><span class="c1">// 0 &lt;= n &lt;= len(b.buf)</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">152</span><span class="p">:</span><span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="kt">error</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">153</span><span class="p">:</span><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="nx">avail</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">w</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">r</span><span class="p">;</span><span class="w"> </span><span class="nx">avail</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">154</span><span class="p">:</span><span class="w">           </span><span class="c1">// not enough data in buffer</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">155</span><span class="p">:</span><span class="w">           </span><span class="nx">n</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">avail</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">156</span><span class="p">:</span><span class="w">           </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">readErr</span><span class="p">()</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">157</span><span class="p">:</span><span class="w">           </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="mi">10</span><span class="nx">ms</span><span class="w">       </span><span class="mi">10</span><span class="nx">ms</span><span class="w">    </span><span class="mi">158</span><span class="p">:</span><span class="w">                   </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ErrBufferFull</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">159</span><span class="p">:</span><span class="w">           </span><span class="p">}</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">160</span><span class="p">:</span><span class="w">   </span><span class="p">}</span>
<span class="w">      </span><span class="mi">10</span><span class="nx">ms</span><span class="w">       </span><span class="mi">10</span><span class="nx">ms</span><span class="w">    </span><span class="mi">161</span><span class="p">:</span><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">buf</span><span class="p">[</span><span class="nx">b</span><span class="p">.</span><span class="nx">r</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">r</span><span class="o">+</span><span class="nx">n</span><span class="p">],</span><span class="w"> </span><span class="nx">err</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">162</span><span class="p">:}</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">163</span><span class="p">:</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">164</span><span class="p">:</span><span class="c1">// Discard skips the next n bytes, returning the number of bytes discarded.</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">165</span><span class="p">:</span><span class="c1">//</span>
<span class="w">         </span><span class="p">.</span><span class="w">          </span><span class="p">.</span><span class="w">    </span><span class="mi">166</span><span class="p">:</span><span class="c1">// If Discard skips fewer than n bytes, it also returns an error.</span>
</pre></div>
<p>The bulk of time here is spent in refilling the buffer (the <code>fill</code>
method). So it seems like while <code>bufio.Reader</code> buffers <em>reads</em> it
basically seems to not buffer <em>peeks</em>.</p>
<p>But hey, we were peeking and discarding one at a time anyway. Peeking
and discarding were the same cost in <code>eatValue</code>. So let's ignore
peeking for a second and think about discarding.</p>
<p>We could avoid doing so many discards if we just keep track of how
much we are peeking at in the loop and only discard once at the end of
the loop. (As an implementation detail, since there's a max internal
buffer size we'll need to actually periodically discard when we try to
peek and get a "buffer full" error.)</p>
<p>And based on that <code>top10</code> result above, we need to do this in
<code>eatValue</code>.</p>
<div class="highlight"><pre><span></span><span class="gu">@@ -170,16 +170,31 @@</span>
<span class="w"> </span>       }

<span class="w"> </span>       // Otherwise it&#39;s an array or object
<span class="gi">+       length := 0</span>
<span class="w"> </span>       first := true
<span class="gd">-</span>
<span class="gi">+       var bs []byte</span>
<span class="w"> </span>       for first || len(stack) &gt; 0 {
<span class="gi">+               length++</span>
<span class="w"> </span>               first = false

<span class="gd">-               bs, err := r.Peek(1)</span>
<span class="gd">-               if err != nil {</span>
<span class="gd">-                       return err</span>
<span class="gi">+               for {</span>
<span class="gi">+                       bs, err = r.Peek(length)</span>
<span class="gi">+                       if err == bufio.ErrBufferFull {</span>
<span class="gi">+                               _, err = r.Discard(length - 1)</span>
<span class="gi">+                               if err != nil {</span>
<span class="gi">+                                       return err</span>
<span class="gi">+                               }</span>
<span class="gi">+</span>
<span class="gi">+                               length = 1</span>
<span class="gi">+                               continue</span>
<span class="gi">+                       }</span>
<span class="gi">+                       if err != nil {</span>
<span class="gi">+                               return err</span>
<span class="gi">+                       }</span>
<span class="gi">+</span>
<span class="gi">+                       break</span>
<span class="w"> </span>               }
<span class="gd">-               b := bs[0]</span>
<span class="gi">+               b := bs[length-1]</span>

<span class="w"> </span>               if inString {
<span class="w"> </span>                       if b == &#39;&quot;&#39; &amp;&amp; prev != &#39;\\&#39; {
<span class="gu">@@ -193,7 +208,6 @@</span>
<span class="w"> </span>                               prev = b
<span class="w"> </span>                       }

<span class="gd">-                       r.Discard(1)</span>
<span class="w"> </span>                       continue
<span class="w"> </span>               }

<span class="gu">@@ -219,11 +233,11 @@</span>
<span class="w"> </span>                       // Closing quote case handled elsewhere, above
<span class="w"> </span>               }

<span class="gd">-               r.Discard(1)</span>
<span class="w"> </span>               prev = b
<span class="w"> </span>       }

<span class="gd">-       return nil</span>
<span class="gi">+       _, err = r.Discard(length)</span>
<span class="gi">+       return err</span>
<span class="w"> </span>}

<span class="w"> </span>func (jr *jsonReader) tryScalar(r *bufio.Reader) (bool, any, error) {
</pre></div>
<p>Comment out the <code>pkg/profile</code> bits (profiling slows the whole thing down), rebuild, and rerun:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>hyperfine<span class="w"> </span>--warmup<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s2">&quot;cat large-file.json | ./control/control &#39;.repo.url&#39; &gt; control.test&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s2">&quot;cat large-file.json | ./jqgo &#39;.repo.url&#39; &gt; jqgo.test&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s2">&quot;cat large-file.json | jq &#39;.repo.url&#39; &gt; jq.test&quot;</span>
Benchmark<span class="w"> </span><span class="m">1</span>:<span class="w"> </span>cat<span class="w"> </span>large-file.json<span class="w"> </span><span class="p">|</span><span class="w"> </span>./control/control<span class="w"> </span><span class="s1">&#39;.repo.url&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>control.test
<span class="w">  </span>Time<span class="w"> </span><span class="o">(</span>mean<span class="w"> </span>±<span class="w"> </span>σ<span class="o">)</span>:<span class="w">     </span><span class="m">302</span>.0<span class="w"> </span>ms<span class="w"> </span>±<span class="w">   </span><span class="m">4</span>.2<span class="w"> </span>ms<span class="w">    </span><span class="o">[</span>User:<span class="w"> </span><span class="m">287</span>.7<span class="w"> </span>ms,<span class="w"> </span>System:<span class="w"> </span><span class="m">49</span>.7<span class="w"> </span>ms<span class="o">]</span><span class="w">  </span>Range<span class="w"> </span><span class="o">(</span>min<span class="w"> </span>…<span class="w"> </span>max<span class="o">)</span>:<span class="w">   </span><span class="m">296</span>.6<span class="w"> </span>ms<span class="w"> </span>…<span class="w"> </span><span class="m">308</span>.2<span class="w"> </span>ms<span class="w">    </span><span class="m">10</span><span class="w"> </span>runs

Benchmark<span class="w"> </span><span class="m">2</span>:<span class="w"> </span>cat<span class="w"> </span>large-file.json<span class="w"> </span><span class="p">|</span><span class="w"> </span>./jqgo<span class="w"> </span><span class="s1">&#39;.repo.url&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>jqgo.test
<span class="w">  </span>Time<span class="w"> </span><span class="o">(</span>mean<span class="w"> </span>±<span class="w"> </span>σ<span class="o">)</span>:<span class="w">     </span><span class="m">215</span>.0<span class="w"> </span>ms<span class="w"> </span>±<span class="w">   </span><span class="m">1</span>.6<span class="w"> </span>ms<span class="w">    </span><span class="o">[</span>User:<span class="w"> </span><span class="m">189</span>.1<span class="w"> </span>ms,<span class="w"> </span>System:<span class="w"> </span><span class="m">46</span>.9<span class="w"> </span>ms<span class="o">]</span>
<span class="w">  </span>Range<span class="w"> </span><span class="o">(</span>min<span class="w"> </span>…<span class="w"> </span>max<span class="o">)</span>:<span class="w">   </span><span class="m">213</span>.5<span class="w"> </span>ms<span class="w"> </span>…<span class="w"> </span><span class="m">218</span>.7<span class="w"> </span>ms<span class="w">    </span><span class="m">13</span><span class="w"> </span>runs

Benchmark<span class="w"> </span><span class="m">3</span>:<span class="w"> </span>cat<span class="w"> </span>large-file.json<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span><span class="s1">&#39;.repo.url&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>jq.test
<span class="w">  </span>Time<span class="w"> </span><span class="o">(</span>mean<span class="w"> </span>±<span class="w"> </span>σ<span class="o">)</span>:<span class="w">     </span><span class="m">355</span>.7<span class="w"> </span>ms<span class="w"> </span>±<span class="w">   </span><span class="m">1</span>.4<span class="w"> </span>ms<span class="w">    </span><span class="o">[</span>User:<span class="w"> </span><span class="m">349</span>.9<span class="w"> </span>ms,<span class="w"> </span>System:<span class="w"> </span><span class="m">26</span>.4<span class="w"> </span>ms<span class="o">]</span>
<span class="w">  </span>Range<span class="w"> </span><span class="o">(</span>min<span class="w"> </span>…<span class="w"> </span>max<span class="o">)</span>:<span class="w">   </span><span class="m">354</span>.3<span class="w"> </span>ms<span class="w"> </span>…<span class="w"> </span><span class="m">359</span>.1<span class="w"> </span>ms<span class="w">    </span><span class="m">10</span><span class="w"> </span>runs

Summary
<span class="w">  </span><span class="s1">&#39;cat large-file.json | ./jqgo &#39;</span>.repo.url<span class="s1">&#39; &gt; jqgo.test&#39;</span><span class="w"> </span>ran
<span class="w">    </span><span class="m">1</span>.40<span class="w"> </span>±<span class="w"> </span><span class="m">0</span>.02<span class="w"> </span><span class="nb">times</span><span class="w"> </span>faster<span class="w"> </span>than<span class="w"> </span><span class="s1">&#39;cat large-file.json | ./control/control &#39;</span>.repo.url<span class="s1">&#39; &gt; control.test&#39;</span>
<span class="w">    </span><span class="m">1</span>.65<span class="w"> </span>±<span class="w"> </span><span class="m">0</span>.01<span class="w"> </span><span class="nb">times</span><span class="w"> </span>faster<span class="w"> </span>than<span class="w"> </span><span class="s1">&#39;cat large-file.json | jq &#39;</span>.repo.url<span class="s1">&#39; &gt; jq.test&#39;</span>
</pre></div>
<p>Great! We've shaved off another 40ms. Let's enable profiling,
re-run the program and go back into the pprof REPL.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>cat<span class="w"> </span>large-file.json<span class="w"> </span><span class="p">|</span><span class="w"> </span>./jqgo<span class="w"> </span><span class="s1">&#39;.repo.url&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>/dev/null
<span class="m">2022</span>/07/11<span class="w"> </span><span class="m">03</span>:12:07<span class="w"> </span>profile:<span class="w"> </span>cpu<span class="w"> </span>profiling<span class="w"> </span>enabled,<span class="w"> </span>/tmp/profile2229743747/cpu.pprof
<span class="m">2022</span>/07/11<span class="w"> </span><span class="m">03</span>:12:07<span class="w"> </span>profile:<span class="w"> </span>cpu<span class="w"> </span>profiling<span class="w"> </span>disabled,<span class="w"> </span>/tmp/profile2229743747/cpu.pprof
$<span class="w"> </span>go<span class="w"> </span>tool<span class="w"> </span>pprof<span class="w"> </span>/tmp/profile2229743747/cpu.pprof
File:<span class="w"> </span>jqgo
Type:<span class="w"> </span>cpu
Time:<span class="w"> </span>Jul<span class="w"> </span><span class="m">11</span>,<span class="w"> </span><span class="m">2022</span><span class="w"> </span>at<span class="w"> </span><span class="m">3</span>:12am<span class="w"> </span><span class="o">(</span>UTC<span class="o">)</span>
Duration:<span class="w"> </span><span class="m">401</span>.33ms,<span class="w"> </span>Total<span class="w"> </span><span class="nv">samples</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>210ms<span class="w"> </span><span class="o">(</span><span class="m">52</span>.33%<span class="o">)</span>
Entering<span class="w"> </span>interactive<span class="w"> </span>mode<span class="w"> </span><span class="o">(</span><span class="nb">type</span><span class="w"> </span><span class="s2">&quot;help&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>commands,<span class="w"> </span><span class="s2">&quot;o&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>options<span class="o">)</span>
<span class="o">(</span>pprof<span class="o">)</span><span class="w"> </span>top10
Showing<span class="w"> </span>nodes<span class="w"> </span>accounting<span class="w"> </span><span class="k">for</span><span class="w"> </span>210ms,<span class="w"> </span><span class="m">100</span>%<span class="w"> </span>of<span class="w"> </span>210ms<span class="w"> </span>total
Showing<span class="w"> </span>top<span class="w"> </span><span class="m">10</span><span class="w"> </span>nodes<span class="w"> </span>out<span class="w"> </span>of<span class="w"> </span><span class="m">20</span>
<span class="w">      </span>flat<span class="w">  </span>flat%<span class="w">   </span>sum%<span class="w">        </span>cum<span class="w">   </span>cum%
<span class="w">     </span>100ms<span class="w"> </span><span class="m">47</span>.62%<span class="w"> </span><span class="m">47</span>.62%<span class="w">      </span>180ms<span class="w"> </span><span class="m">85</span>.71%<span class="w">  </span>main.<span class="o">(</span>*jsonReader<span class="o">)</span>.eatValue
<span class="w">      </span>70ms<span class="w"> </span><span class="m">33</span>.33%<span class="w"> </span><span class="m">80</span>.95%<span class="w">       </span>70ms<span class="w"> </span><span class="m">33</span>.33%<span class="w">  </span>bufio.<span class="o">(</span>*Reader<span class="o">)</span>.Peek
<span class="w">      </span>10ms<span class="w">  </span><span class="m">4</span>.76%<span class="w"> </span><span class="m">85</span>.71%<span class="w">       </span>10ms<span class="w">  </span><span class="m">4</span>.76%<span class="w">  </span>encoding/json.<span class="o">(</span>*encodeState<span class="o">)</span>.string
<span class="w">      </span>10ms<span class="w">  </span><span class="m">4</span>.76%<span class="w"> </span><span class="m">90</span>.48%<span class="w">       </span>20ms<span class="w">  </span><span class="m">9</span>.52%<span class="w">  </span>main.<span class="o">(</span>*jsonReader<span class="o">)</span>.expectString
<span class="w">      </span>10ms<span class="w">  </span><span class="m">4</span>.76%<span class="w"> </span><span class="m">95</span>.24%<span class="w">       </span>10ms<span class="w">  </span><span class="m">4</span>.76%<span class="w">  </span>main.<span class="o">(</span>*jsonReader<span class="o">)</span>.readByte
<span class="w">      </span>10ms<span class="w">  </span><span class="m">4</span>.76%<span class="w">   </span><span class="m">100</span>%<span class="w">       </span>10ms<span class="w">  </span><span class="m">4</span>.76%<span class="w">  </span>reflect.Value.Type
<span class="w">         </span><span class="m">0</span><span class="w">     </span><span class="m">0</span>%<span class="w">   </span><span class="m">100</span>%<span class="w">       </span>10ms<span class="w">  </span><span class="m">4</span>.76%<span class="w">  </span>encoding/json.<span class="o">(</span>*Encoder<span class="o">)</span>.Encode
<span class="w">         </span><span class="m">0</span><span class="w">     </span><span class="m">0</span>%<span class="w">   </span><span class="m">100</span>%<span class="w">       </span>10ms<span class="w">  </span><span class="m">4</span>.76%<span class="w">  </span>encoding/json.<span class="o">(</span>*decodeState<span class="o">)</span>.literalStore
<span class="w">         </span><span class="m">0</span><span class="w">     </span><span class="m">0</span>%<span class="w">   </span><span class="m">100</span>%<span class="w">       </span>10ms<span class="w">  </span><span class="m">4</span>.76%<span class="w">  </span>encoding/json.<span class="o">(</span>*decodeState<span class="o">)</span>.unmarshal
<span class="w">         </span><span class="m">0</span><span class="w">     </span><span class="m">0</span>%<span class="w">   </span><span class="m">100</span>%<span class="w">       </span>10ms<span class="w">  </span><span class="m">4</span>.76%<span class="w">  </span>encoding/json.<span class="o">(</span>*decodeState<span class="o">)</span>.value
</pre></div>
<p>Nice, <code>syscall.Syscall</code> is no longer in the top 10. But <code>eatValue</code> is
and we're still spending a bunch of time in <code>Peek</code>. We didn't try to
stop calling <code>Peek</code> so much, we just cut down on calling <code>Discard</code>.</p>
<p>List <code>eatValue</code>.</p>
<div class="highlight"><pre><span></span><span class="o">(</span>pprof<span class="o">)</span><span class="w"> </span>list<span class="w"> </span>eatValue
Total:<span class="w"> </span>210ms
<span class="nv">ROUTINE</span><span class="w"> </span><span class="o">========================</span><span class="w"> </span>main.<span class="o">(</span>*jsonReader<span class="o">)</span>.eatValue<span class="w"> </span><span class="k">in</span><span class="w"> </span>/home/phil/tmp/jqgo/mainpeek.go
<span class="w">     </span>100ms<span class="w">      </span>180ms<span class="w"> </span><span class="o">(</span>flat,<span class="w"> </span>cum<span class="o">)</span><span class="w"> </span><span class="m">85</span>.71%<span class="w"> </span>of<span class="w"> </span>Total
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">159</span>:<span class="w">   </span>err<span class="w"> </span>:<span class="o">=</span><span class="w"> </span>jr.eatWhitespace<span class="o">(</span>r<span class="o">)</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">160</span>:<span class="w">   </span><span class="k">if</span><span class="w"> </span>err<span class="w"> </span>!<span class="o">=</span><span class="w"> </span>nil<span class="w"> </span><span class="o">{</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">161</span>:<span class="w">           </span><span class="k">return</span><span class="w"> </span>err
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">162</span>:<span class="w">   </span><span class="o">}</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">163</span>:
<span class="w">         </span>.<span class="w">       </span>20ms<span class="w">    </span><span class="m">164</span>:<span class="w">   </span>ok,<span class="w"> </span>_,<span class="w"> </span>err<span class="w"> </span>:<span class="o">=</span><span class="w"> </span>jr.tryScalar<span class="o">(</span>r<span class="o">)</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">165</span>:<span class="w">   </span><span class="k">if</span><span class="w"> </span>err<span class="w"> </span>!<span class="o">=</span><span class="w"> </span>nil<span class="w"> </span><span class="o">{</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">166</span>:<span class="w">           </span><span class="k">return</span><span class="w"> </span>err
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">167</span>:<span class="w">   </span><span class="o">}</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">168</span>:
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">169</span>:<span class="w">   </span>//<span class="w"> </span>It<span class="w"> </span>was<span class="w"> </span>a<span class="w"> </span>scalar,<span class="w"> </span>we<span class="s1">&#39;re done!</span>
<span class="s1">         .          .    170:   if ok {</span>
<span class="s1">         .          .    171:           return nil</span>
<span class="s1">         .          .    172:   }</span>
<span class="s1">         .          .    173:</span>
<span class="s1">         .          .    174:   // Otherwise it&#39;</span>s<span class="w"> </span>an<span class="w"> </span>array<span class="w"> </span>or<span class="w"> </span>object
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">175</span>:<span class="w">   </span>length<span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">176</span>:<span class="w">   </span>first<span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="nb">true</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">177</span>:<span class="w">   </span>var<span class="w"> </span>bs<span class="w"> </span><span class="o">[]</span>byte
<span class="w">      </span>20ms<span class="w">       </span>20ms<span class="w">    </span><span class="m">178</span>:<span class="w">   </span><span class="k">for</span><span class="w"> </span>first<span class="w"> </span><span class="o">||</span><span class="w"> </span>len<span class="o">(</span>stack<span class="o">)</span><span class="w"> </span>&gt;<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">{</span>
<span class="w">      </span>10ms<span class="w">       </span>10ms<span class="w">    </span><span class="m">179</span>:<span class="w">           </span>length++
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">180</span>:<span class="w">           </span><span class="nv">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">181</span>:
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">182</span>:<span class="w">           </span><span class="k">for</span><span class="w"> </span><span class="o">{</span>
<span class="w">      </span>20ms<span class="w">       </span>80ms<span class="w">    </span><span class="m">183</span>:<span class="w">                   </span>bs,<span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>r.Peek<span class="o">(</span>length<span class="o">)</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">184</span>:<span class="w">                   </span><span class="k">if</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>bufio.ErrBufferFull<span class="w"> </span><span class="o">{</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">185</span>:<span class="w">                           </span>_,<span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>r.Discard<span class="o">(</span>length<span class="w"> </span>-<span class="w"> </span><span class="m">1</span><span class="o">)</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">186</span>:<span class="w">                           </span><span class="k">if</span><span class="w"> </span>err<span class="w"> </span>!<span class="o">=</span><span class="w"> </span>nil<span class="w"> </span><span class="o">{</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">187</span>:<span class="w">                                   </span><span class="k">return</span><span class="w"> </span>err
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">188</span>:<span class="w">                           </span><span class="o">}</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">189</span>:
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">190</span>:<span class="w">                           </span><span class="nv">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">191</span>:<span class="w">                           </span><span class="k">continue</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">192</span>:<span class="w">                   </span><span class="o">}</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">193</span>:<span class="w">                   </span><span class="k">if</span><span class="w"> </span>err<span class="w"> </span>!<span class="o">=</span><span class="w"> </span>nil<span class="w"> </span><span class="o">{</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">194</span>:<span class="w">                           </span><span class="k">return</span><span class="w"> </span>err
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">195</span>:<span class="w">                   </span><span class="o">}</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">196</span>:
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">197</span>:<span class="w">                   </span><span class="k">break</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">198</span>:<span class="w">           </span><span class="o">}</span>
<span class="w">      </span>10ms<span class="w">       </span>10ms<span class="w">    </span><span class="m">199</span>:<span class="w">           </span>b<span class="w"> </span>:<span class="o">=</span><span class="w"> </span>bs<span class="o">[</span>length-1<span class="o">]</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">200</span>:
<span class="w">      </span>10ms<span class="w">       </span>10ms<span class="w">    </span><span class="m">201</span>:<span class="w">           </span><span class="k">if</span><span class="w"> </span>inString<span class="w"> </span><span class="o">{</span>
<span class="w">      </span>10ms<span class="w">       </span>10ms<span class="w">    </span><span class="m">202</span>:<span class="w">                   </span><span class="k">if</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;&quot;&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>prev<span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s1">&#39;\\&#39;</span><span class="w"> </span><span class="o">{</span>
<span class="w">                         </span><span class="m">203</span>:<span class="w">                           </span><span class="nv">inString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">204</span>:<span class="w">                   </span><span class="o">}</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">205</span>:
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">206</span>:<span class="w">                   </span>//<span class="w"> </span>Two<span class="w"> </span><span class="se">\\</span>-es<span class="w"> </span>cancel<span class="w"> </span>eachother<span class="w"> </span>out
<span class="w">      </span>20ms<span class="w">       </span>20ms<span class="w">    </span><span class="m">207</span>:<span class="w">                   </span><span class="k">if</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;\\&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nv">prev</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;\\&#39;</span><span class="w"> </span><span class="o">{</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">208</span>:<span class="w">                           </span><span class="nv">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>byte<span class="o">(</span><span class="m">0</span><span class="o">)</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">209</span>:<span class="w">                   </span><span class="o">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="o">{</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">210</span>:<span class="w">                           </span><span class="nv">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>b
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">211</span>:<span class="w">                   </span><span class="o">}</span>
<span class="w">         </span>.
</pre></div>
<p>The bulk of time is spent in <code>Peek</code>. Let's list <code>Peek</code> again.</p>
<div class="highlight"><pre><span></span><span class="o">(</span>pprof<span class="o">)</span><span class="w"> </span>list<span class="w"> </span>Peek
Total:<span class="w"> </span>210ms
<span class="nv">ROUTINE</span><span class="w"> </span><span class="o">========================</span><span class="w"> </span>bufio.<span class="o">(</span>*Reader<span class="o">)</span>.Peek<span class="w"> </span><span class="k">in</span><span class="w"> </span>/usr/local/go/src/bufio/bufio.go
<span class="w">      </span>70ms<span class="w">       </span>70ms<span class="w"> </span><span class="o">(</span>flat,<span class="w"> </span>cum<span class="o">)</span><span class="w"> </span><span class="m">33</span>.33%<span class="w"> </span>of<span class="w"> </span>Total
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">130</span>://<span class="w"> </span>also<span class="w"> </span>returns<span class="w"> </span>an<span class="w"> </span>error<span class="w"> </span>explaining<span class="w"> </span>why<span class="w"> </span>the<span class="w"> </span><span class="nb">read</span><span class="w"> </span>is<span class="w"> </span>short.<span class="w"> </span>The<span class="w"> </span>error<span class="w"> </span>is
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">131</span>://<span class="w"> </span>ErrBufferFull<span class="w"> </span><span class="k">if</span><span class="w"> </span>n<span class="w"> </span>is<span class="w"> </span>larger<span class="w"> </span>than<span class="w"> </span>b<span class="err">&#39;</span>s<span class="w"> </span>buffer<span class="w"> </span>size.
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">132</span>://
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">133</span>://<span class="w"> </span>Calling<span class="w"> </span>Peek<span class="w"> </span>prevents<span class="w"> </span>a<span class="w"> </span>UnreadByte<span class="w"> </span>or<span class="w"> </span>UnreadRune<span class="w"> </span>call<span class="w"> </span>from<span class="w"> </span>succeeding
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">134</span>://<span class="w"> </span><span class="k">until</span><span class="w"> </span>the<span class="w"> </span>next<span class="w"> </span><span class="nb">read</span><span class="w"> </span>operation.
<span class="w">      </span>10ms<span class="w">       </span>10ms<span class="w">    </span><span class="m">135</span>:func<span class="w"> </span><span class="o">(</span>b<span class="w"> </span>*Reader<span class="o">)</span><span class="w"> </span>Peek<span class="o">(</span>n<span class="w"> </span>int<span class="o">)</span><span class="w"> </span><span class="o">([]</span>byte,<span class="w"> </span>error<span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">136</span>:<span class="w">   </span><span class="k">if</span><span class="w"> </span>n<span class="w"> </span>&lt;<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">{</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">137</span>:<span class="w">           </span><span class="k">return</span><span class="w"> </span>nil,<span class="w"> </span>ErrNegativeCount
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">138</span>:<span class="w">   </span><span class="o">}</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">139</span>:
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">140</span>:<span class="w">   </span>b.lastByte<span class="w"> </span><span class="o">=</span><span class="w"> </span>-1
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">141</span>:<span class="w">   </span>b.lastRuneSize<span class="w"> </span><span class="o">=</span><span class="w"> </span>-1
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">142</span>:
<span class="w">      </span>10ms<span class="w">       </span>10ms<span class="w">    </span><span class="m">143</span>:<span class="w">   </span><span class="k">for</span><span class="w"> </span>b.w-b.r<span class="w"> </span>&lt;<span class="w"> </span>n<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>b.w-b.r<span class="w"> </span>&lt;<span class="w"> </span>len<span class="o">(</span>b.buf<span class="o">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>b.err<span class="w"> </span><span class="o">==</span><span class="w"> </span>nil<span class="w"> </span><span class="o">{</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">144</span>:<span class="w">           </span>b.fill<span class="o">()</span><span class="w"> </span>//<span class="w"> </span>b.w-b.r<span class="w"> </span>&lt;<span class="w"> </span>len<span class="o">(</span>b.buf<span class="o">)</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>buffer<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>full
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">145</span>:<span class="w">   </span><span class="o">}</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">146</span>:
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">147</span>:<span class="w">   </span><span class="k">if</span><span class="w"> </span>n<span class="w"> </span>&gt;<span class="w"> </span>len<span class="o">(</span>b.buf<span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">148</span>:<span class="w">           </span><span class="k">return</span><span class="w"> </span>b.buf<span class="o">[</span>b.r:b.w<span class="o">]</span>,<span class="w"> </span>ErrBufferFull
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">149</span>:<span class="w">   </span><span class="o">}</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">150</span>:
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">151</span>:<span class="w">   </span>//<span class="w"> </span><span class="m">0</span><span class="w"> </span>&lt;<span class="o">=</span><span class="w"> </span>n<span class="w"> </span>&lt;<span class="o">=</span><span class="w"> </span>len<span class="o">(</span>b.buf<span class="o">)</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">152</span>:<span class="w">   </span>var<span class="w"> </span>err<span class="w"> </span>error
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">153</span>:<span class="w">   </span><span class="k">if</span><span class="w"> </span>avail<span class="w"> </span>:<span class="o">=</span><span class="w"> </span>b.w<span class="w"> </span>-<span class="w"> </span>b.r<span class="p">;</span><span class="w"> </span>avail<span class="w"> </span>&lt;<span class="w"> </span>n<span class="w"> </span><span class="o">{</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">154</span>:<span class="w">           </span>//<span class="w"> </span>not<span class="w"> </span>enough<span class="w"> </span>data<span class="w"> </span><span class="k">in</span><span class="w"> </span>buffer
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">155</span>:<span class="w">           </span><span class="nv">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>avail
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">156</span>:<span class="w">           </span><span class="nv">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>b.readErr<span class="o">()</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">157</span>:<span class="w">           </span><span class="k">if</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>nil<span class="w"> </span><span class="o">{</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">158</span>:<span class="w">                   </span><span class="nv">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ErrBufferFull
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">159</span>:<span class="w">           </span><span class="o">}</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">160</span>:<span class="w">   </span><span class="o">}</span>
<span class="w">      </span>50ms<span class="w">       </span>50ms<span class="w">    </span><span class="m">161</span>:<span class="w">   </span><span class="k">return</span><span class="w"> </span>b.buf<span class="o">[</span>b.r<span class="w"> </span>:<span class="w"> </span>b.r+n<span class="o">]</span>,<span class="w"> </span>err
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">162</span>:<span class="o">}</span>
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">163</span>:
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">164</span>://<span class="w"> </span>Discard<span class="w"> </span>skips<span class="w"> </span>the<span class="w"> </span>next<span class="w"> </span>n<span class="w"> </span>bytes,<span class="w"> </span>returning<span class="w"> </span>the<span class="w"> </span>number<span class="w"> </span>of<span class="w"> </span>bytes<span class="w"> </span>discarded.
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">165</span>://
<span class="w">         </span>.<span class="w">          </span>.<span class="w">    </span><span class="m">166</span>://<span class="w"> </span>If<span class="w"> </span>Discard<span class="w"> </span>skips<span class="w"> </span>fewer<span class="w"> </span>than<span class="w"> </span>n<span class="w"> </span>bytes,<span class="w"> </span>it<span class="w"> </span>also<span class="w"> </span>returns<span class="w"> </span>an<span class="w"> </span>error.
</pre></div>
<p>Well it's not really clear to me from this why we spend so much time
slicing here.</p>
<p>We might be able to use <code>Peek</code> much less if we kept our own FIFO queue
of peeked-at bytes. But I don't feel like writing a correct, efficient
FIFO queue (a ring buffer, basically) and maybe there are other
aspects of this program we can look at. So let's give this train of
thought a break.</p>
<h3 id="memory-profiling">Memory profiling</h3><p>Let's change tactics entirely. Memory allocation tends to be
expensive. Allocating in a loop is generally a bad idea. And this
entire program is a loop. So let's try doing a memory profile instead
of a CPU profile.</p>
<p>Instead of <code>defer profile.Start().Stop()</code> we'll set <code>defer
profile.Start(profile.MemProfile).Stop()</code>.</p>
<p>Build, rerun and enter pprof with the <code>-alloc_space</code> flag. We want to
see where memory is being allocated.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>go<span class="w"> </span>build
$<span class="w"> </span>cat<span class="w"> </span>large-file.json<span class="w"> </span><span class="p">|</span><span class="w"> </span>./jqgo<span class="w"> </span><span class="s1">&#39;.repo.url&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>/dev/null
<span class="m">2022</span>/07/11<span class="w"> </span><span class="m">03</span>:24:55<span class="w"> </span>profile:<span class="w"> </span>memory<span class="w"> </span>profiling<span class="w"> </span>enabled<span class="w"> </span><span class="o">(</span>rate<span class="w"> </span><span class="m">4096</span><span class="o">)</span>,<span class="w"> </span>/tmp/profile1407859643/mem.pprof
<span class="m">2022</span>/07/11<span class="w"> </span><span class="m">03</span>:24:56<span class="w"> </span>profile:<span class="w"> </span>memory<span class="w"> </span>profiling<span class="w"> </span>disabled,<span class="w"> </span>/tmp/profile1407859643/mem.pprof
$<span class="w"> </span>go<span class="w"> </span>tool<span class="w"> </span>pprof<span class="w"> </span>-alloc_objects<span class="w"> </span>/tmp/profile1407859643/mem.pprof
File:<span class="w"> </span>jqgo
Type:<span class="w"> </span>alloc_objects
Time:<span class="w"> </span>Jul<span class="w"> </span><span class="m">11</span>,<span class="w"> </span><span class="m">2022</span><span class="w"> </span>at<span class="w"> </span><span class="m">3</span>:24am<span class="w"> </span><span class="o">(</span>UTC<span class="o">)</span>
Entering<span class="w"> </span>interactive<span class="w"> </span>mode<span class="w"> </span><span class="o">(</span><span class="nb">type</span><span class="w"> </span><span class="s2">&quot;help&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>commands,<span class="w"> </span><span class="s2">&quot;o&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>options<span class="o">)</span>
<span class="o">(</span>pprof<span class="o">)</span><span class="w"> </span>top10
Showing<span class="w"> </span>nodes<span class="w"> </span>accounting<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="m">365899</span>,<span class="w"> </span><span class="m">99</span>.95%<span class="w"> </span>of<span class="w"> </span><span class="m">366086</span><span class="w"> </span>total
Dropped<span class="w"> </span><span class="m">24</span><span class="w"> </span>nodes<span class="w"> </span><span class="o">(</span>cum<span class="w"> </span>&lt;<span class="o">=</span><span class="w"> </span><span class="m">1830</span><span class="o">)</span>
Showing<span class="w"> </span>top<span class="w"> </span><span class="m">10</span><span class="w"> </span>nodes<span class="w"> </span>out<span class="w"> </span>of<span class="w"> </span><span class="m">14</span>
<span class="w">      </span>flat<span class="w">  </span>flat%<span class="w">   </span>sum%<span class="w">        </span>cum<span class="w">   </span>cum%
<span class="w">    </span><span class="m">227585</span><span class="w"> </span><span class="m">62</span>.17%<span class="w"> </span><span class="m">62</span>.17%<span class="w">     </span><span class="m">262708</span><span class="w"> </span><span class="m">71</span>.76%<span class="w">  </span>main.<span class="o">(</span>*jsonReader<span class="o">)</span>.expectString
<span class="w">     </span><span class="m">40945</span><span class="w"> </span><span class="m">11</span>.18%<span class="w"> </span><span class="m">73</span>.35%<span class="w">      </span><span class="m">40945</span><span class="w"> </span><span class="m">11</span>.18%<span class="w">  </span>main.<span class="o">(</span>*jsonReader<span class="o">)</span>.readByte
<span class="w">     </span><span class="m">39500</span><span class="w"> </span><span class="m">10</span>.79%<span class="w"> </span><span class="m">84</span>.14%<span class="w">     </span><span class="m">252585</span><span class="w"> </span><span class="m">69</span>.00%<span class="w">  </span>main.<span class="o">(</span>*jsonReader<span class="o">)</span>.tryScalar
<span class="w">     </span><span class="m">30009</span><span class="w">  </span><span class="m">8</span>.20%<span class="w"> </span><span class="m">92</span>.34%<span class="w">      </span><span class="m">41924</span><span class="w"> </span><span class="m">11</span>.45%<span class="w">  </span>main.<span class="o">(</span>*jsonReader<span class="o">)</span>.tryNumber
<span class="w">     </span><span class="m">12055</span><span class="w">  </span><span class="m">3</span>.29%<span class="w"> </span><span class="m">95</span>.63%<span class="w">     </span><span class="m">215416</span><span class="w"> </span><span class="m">58</span>.84%<span class="w">  </span>main.<span class="o">(</span>*jsonReader<span class="o">)</span>.eatValue
<span class="w">      </span><span class="m">7555</span><span class="w">  </span><span class="m">2</span>.06%<span class="w"> </span><span class="m">97</span>.70%<span class="w">      </span><span class="m">11915</span><span class="w">  </span><span class="m">3</span>.25%<span class="w">  </span>encoding/json.Unmarshal
<span class="w">      </span><span class="m">4360</span><span class="w">  </span><span class="m">1</span>.19%<span class="w"> </span><span class="m">98</span>.89%<span class="w">       </span><span class="m">4360</span><span class="w">  </span><span class="m">1</span>.19%<span class="w">  </span>encoding/json.<span class="o">(</span>*decodeState<span class="o">)</span>.literalStore
<span class="w">      </span><span class="m">3847</span><span class="w">  </span><span class="m">1</span>.05%<span class="w"> </span><span class="m">99</span>.94%<span class="w">       </span><span class="m">3847</span><span class="w">  </span><span class="m">1</span>.05%<span class="w">  </span>main.<span class="o">(</span>*jsonReader<span class="o">)</span>.expectIdentifier
<span class="w">        </span><span class="m">43</span><span class="w"> </span><span class="m">0</span>.012%<span class="w"> </span><span class="m">99</span>.95%<span class="w">     </span><span class="m">365931</span><span class="w">   </span><span class="m">100</span>%<span class="w">  </span>runtime.main
<span class="w">         </span><span class="m">0</span><span class="w">     </span><span class="m">0</span>%<span class="w"> </span><span class="m">99</span>.95%<span class="w">       </span><span class="m">4360</span><span class="w">  </span><span class="m">1</span>.19%<span class="w">  </span>encoding/json.<span class="o">(</span>*decodeState<span class="o">)</span>.unmarshal
</pre></div>
<p>And just like in the CPU profile we can list functions to see where
the allocations happen in code. Let's list the biggest memory user
here, <code>expectString</code>.</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="n">pprof</span><span class="p">)</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">expectString</span>
<span class="n">Total</span><span class="p">:</span><span class="w"> </span><span class="mi">366086</span>
<span class="n">ROUTINE</span><span class="w"> </span><span class="o">========================</span><span class="w"> </span><span class="n">main</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">jsonReader</span><span class="p">)</span><span class="o">.</span><span class="n">expectString</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">phil</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">jqgo</span><span class="o">/</span><span class="n">mainpeek</span><span class="o">.</span><span class="n">go</span>
<span class="w">    </span><span class="mi">227585</span><span class="w">     </span><span class="mi">262708</span><span class="w"> </span><span class="p">(</span><span class="n">flat</span><span class="p">,</span><span class="w"> </span><span class="n">cum</span><span class="p">)</span><span class="w"> </span><span class="mf">71.76</span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Total</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">58</span><span class="p">:</span><span class="w">   </span><span class="n">err</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">jr</span><span class="o">.</span><span class="n">eatWhitespace</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">59</span><span class="p">:</span><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">60</span><span class="p">:</span><span class="w">           </span><span class="k">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">err</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">61</span><span class="p">:</span><span class="w">   </span><span class="p">}</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">62</span><span class="p">:</span>
<span class="w">         </span><span class="o">.</span><span class="w">       </span><span class="mi">4941</span><span class="w">     </span><span class="mi">63</span><span class="p">:</span><span class="w">   </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">jr</span><span class="o">.</span><span class="n">readByte</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">64</span><span class="p">:</span><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">65</span><span class="p">:</span><span class="w">           </span><span class="k">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">err</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">66</span><span class="p">:</span><span class="w">   </span><span class="p">}</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">67</span><span class="p">:</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">68</span><span class="p">:</span><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;&quot;&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">69</span><span class="p">:</span><span class="w">           </span><span class="k">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s2">&quot;Expected double quote to start string, got: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">70</span><span class="p">:</span><span class="w">   </span><span class="p">}</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">71</span><span class="p">:</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">72</span><span class="p">:</span><span class="w">   </span><span class="k">var</span><span class="w"> </span><span class="n">prev</span><span class="w"> </span><span class="n">byte</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">73</span><span class="p">:</span><span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="o">.</span><span class="w">      </span><span class="mi">30182</span><span class="w">     </span><span class="mi">74</span><span class="p">:</span><span class="w">           </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">jr</span><span class="o">.</span><span class="n">readByte</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">75</span><span class="p">:</span><span class="w">           </span><span class="k">if</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">76</span><span class="p">:</span><span class="w">                   </span><span class="k">return</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">err</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">77</span><span class="p">:</span><span class="w">           </span><span class="p">}</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">78</span><span class="p">:</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">79</span><span class="p">:</span><span class="w">           </span><span class="k">if</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">prev</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">80</span><span class="p">:</span><span class="w">                   </span><span class="o">//</span><span class="w"> </span><span class="n">Just</span><span class="w"> </span><span class="n">skip</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">81</span><span class="p">:</span><span class="w">                   </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">byte</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">82</span><span class="p">:</span><span class="w">                   </span><span class="k">continue</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">83</span><span class="p">:</span><span class="w">           </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;&quot;&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">84</span><span class="p">:</span><span class="w">                   </span><span class="o">//</span><span class="w"> </span><span class="n">Overwrite</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">escaped</span><span class="w"> </span><span class="n">double</span><span class="w"> </span><span class="n">quote</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">85</span><span class="p">:</span><span class="w">                   </span><span class="k">if</span><span class="w"> </span><span class="n">prev</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">86</span><span class="p">:</span><span class="w">                           </span><span class="n">s</span><span class="p">[</span><span class="n">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&quot;&#39;</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">87</span><span class="p">:</span><span class="w">                   </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">88</span><span class="p">:</span><span class="w">                           </span><span class="o">//</span><span class="w"> </span><span class="n">Otherwise</span><span class="w"> </span><span class="n">it</span><span class="s1">&#39;s the actual end</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">89</span><span class="p">:</span><span class="w">                           </span><span class="k">break</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">90</span><span class="p">:</span><span class="w">                   </span><span class="p">}</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">91</span><span class="p">:</span><span class="w">           </span><span class="p">}</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">92</span><span class="p">:</span>
<span class="w">    </span><span class="mi">146302</span><span class="w">     </span><span class="mi">146302</span><span class="w">     </span><span class="mi">93</span><span class="p">:</span><span class="w">           </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">94</span><span class="p">:</span><span class="w">           </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">95</span><span class="p">:</span><span class="w">   </span><span class="p">}</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">96</span><span class="p">:</span>
<span class="w">     </span><span class="mi">81283</span><span class="w">      </span><span class="mi">81283</span><span class="w">     </span><span class="mi">97</span><span class="p">:</span><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">string</span><span class="p">(</span><span class="n">s</span><span class="p">),</span><span class="w"> </span><span class="n">nil</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">98</span><span class="p">:}</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">     </span><span class="mi">99</span><span class="p">:</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">    </span><span class="mi">100</span><span class="p">:</span><span class="k">func</span><span class="w"> </span><span class="p">(</span><span class="n">jr</span><span class="w"> </span><span class="o">*</span><span class="n">jsonReader</span><span class="p">)</span><span class="w"> </span><span class="n">expectIdentifier</span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">*</span><span class="n">bufio</span><span class="o">.</span><span class="n">Reader</span><span class="p">,</span><span class="w"> </span><span class="n">ident</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">any</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">any</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">    </span><span class="mi">101</span><span class="p">:</span><span class="w">   </span><span class="k">var</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="p">[]</span><span class="n">byte</span>
<span class="w">         </span><span class="o">.</span><span class="w">          </span><span class="o">.</span><span class="w">    </span><span class="mi">102</span><span class="p">:</span>
</pre></div>
<p>And the biggest offender is growing the string! The good thing is that
growing this string can be amortized because we can share the
underlying string memory across calls on the <code>jsonResponse</code>
struct. This way, <code>expectString</code> only needs to grow the string when it
actually sees a bigger string than we've already seen.</p>
<p>The builtin <a href="https://pkg.go.dev/bytes#Buffer">bytes.Buffer</a> type does
exactly this. We can put a <code>bytes.Buffer</code> on the <code>jsonResponse</code> struct
because this code isn't multithreaded and because <code>expectString</code>
doesn't call itself.</p>
<div class="highlight"><pre><span></span><span class="err">@@</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="w"> </span><span class="err">@@</span>

<span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;bufio&quot;</span>
<span class="o">+</span><span class="w">       </span><span class="s">&quot;bytes&quot;</span>
<span class="w">        </span><span class="s">&quot;encoding/json&quot;</span>
<span class="w">        </span><span class="s">&quot;fmt&quot;</span>
<span class="w">        </span><span class="s">&quot;io&quot;</span>
<span class="err">@@</span><span class="w"> </span><span class="o">-</span><span class="mi">13</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="mi">14</span><span class="p">,</span><span class="mi">8</span><span class="w"> </span><span class="err">@@</span>

<span class="w"> </span><span class="kd">type</span><span class="w"> </span><span class="nx">jsonReader</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">read</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span>
<span class="o">+</span>
<span class="o">+</span><span class="w">       </span><span class="nx">expectString_buffer</span><span class="w"> </span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">jr</span><span class="w"> </span><span class="o">*</span><span class="nx">jsonReader</span><span class="p">)</span><span class="w"> </span><span class="nx">reset</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="err">@@</span><span class="w"> </span><span class="o">-</span><span class="mi">51</span><span class="p">,</span><span class="mi">7</span><span class="w"> </span><span class="o">+</span><span class="mi">54</span><span class="p">,</span><span class="mi">7</span><span class="w"> </span><span class="err">@@</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">jr</span><span class="w"> </span><span class="o">*</span><span class="nx">jsonReader</span><span class="p">)</span><span class="w"> </span><span class="nx">expectString</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">bufio</span><span class="p">.</span><span class="nx">Reader</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="o">-</span><span class="w">       </span><span class="kd">var</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span>
<span class="o">+</span><span class="w">       </span><span class="nx">jr</span><span class="p">.</span><span class="nx">expectString_buffer</span><span class="p">.</span><span class="nx">Reset</span><span class="p">()</span>

<span class="w">        </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">jr</span><span class="p">.</span><span class="nx">eatWhitespace</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="err">@@</span><span class="w"> </span><span class="o">-</span><span class="mi">81</span><span class="p">,</span><span class="mi">18</span><span class="w"> </span><span class="o">+</span><span class="mi">84</span><span class="p">,</span><span class="mi">18</span><span class="w"> </span><span class="err">@@</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;&quot;&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="c1">// Overwrite the escaped double quote</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="nx">prev</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;\\&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="o">-</span><span class="w">                               </span><span class="nx">s</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="sc">&#39;&quot;&#39;</span>
<span class="o">+</span><span class="w">                               </span><span class="nx">jr</span><span class="p">.</span><span class="nx">expectString_buffer</span><span class="p">.</span><span class="nx">Bytes</span><span class="p">()[</span><span class="nx">jr</span><span class="p">.</span><span class="nx">expectString_buffer</span><span class="p">.</span><span class="nx">Len</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="sc">&#39;&quot;&#39;</span>
<span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                </span><span class="c1">// Otherwise it&#39;s the actual end</span>
<span class="w">                                </span><span class="k">break</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>

<span class="o">-</span><span class="w">               </span><span class="nx">s</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span>
<span class="o">+</span><span class="w">               </span><span class="nx">jr</span><span class="p">.</span><span class="nx">expectString_buffer</span><span class="p">.</span><span class="nx">WriteByte</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
<span class="w">                </span><span class="nx">prev</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">b</span>
<span class="w">        </span><span class="p">}</span>

<span class="o">-</span><span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">s</span><span class="p">),</span><span class="w"> </span><span class="kc">nil</span>
<span class="o">+</span><span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="nx">jr</span><span class="p">.</span><span class="nx">expectString_buffer</span><span class="p">.</span><span class="nx">String</span><span class="p">(),</span><span class="w"> </span><span class="kc">nil</span>
<span class="w"> </span><span class="p">}</span>
</pre></div>
<p class="note">
  Or instead of sharing memory on the struct, maybe this would be a
  good place to use <a href="https://pkg.go.dev/sync#Pool">sync.Pool</a>?
</p><p>Disable <code>pkg/profile</code>, build and rerun with hyperfine.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>hyperfine<span class="w"> </span>--warmup<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s2">&quot;cat large-file.json | ./control/control &#39;.repo.url&#39; &gt; control.test&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s2">&quot;cat large-file.json | ./jqgo &#39;.repo.url&#39; &gt; jqgo.test&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s2">&quot;cat large-file.json | jq &#39;.repo.url&#39; &gt; jq.test&quot;</span>
Benchmark<span class="w"> </span><span class="m">1</span>:<span class="w"> </span>cat<span class="w"> </span>large-file.json<span class="w"> </span><span class="p">|</span><span class="w"> </span>./control/control<span class="w"> </span><span class="s1">&#39;.repo.url&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>control.test
<span class="w">  </span>Time<span class="w"> </span><span class="o">(</span>mean<span class="w"> </span>±<span class="w"> </span>σ<span class="o">)</span>:<span class="w">     </span><span class="m">307</span>.2<span class="w"> </span>ms<span class="w"> </span>±<span class="w">  </span><span class="m">10</span>.8<span class="w"> </span>ms<span class="w">    </span><span class="o">[</span>User:<span class="w"> </span><span class="m">292</span>.8<span class="w"> </span>ms,<span class="w"> </span>System:<span class="w"> </span><span class="m">49</span>.4<span class="w"> </span>ms<span class="o">]</span>
<span class="w">  </span>Range<span class="w"> </span><span class="o">(</span>min<span class="w"> </span>…<span class="w"> </span>max<span class="o">)</span>:<span class="w">   </span><span class="m">296</span>.5<span class="w"> </span>ms<span class="w"> </span>…<span class="w"> </span><span class="m">326</span>.2<span class="w"> </span>ms<span class="w">    </span><span class="m">10</span><span class="w"> </span>runs

Benchmark<span class="w"> </span><span class="m">2</span>:<span class="w"> </span>cat<span class="w"> </span>large-file.json<span class="w"> </span><span class="p">|</span><span class="w"> </span>./jqgo<span class="w"> </span><span class="s1">&#39;.repo.url&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>jqgo.test
<span class="w">  </span>Time<span class="w"> </span><span class="o">(</span>mean<span class="w"> </span>±<span class="w"> </span>σ<span class="o">)</span>:<span class="w">     </span><span class="m">210</span>.8<span class="w"> </span>ms<span class="w"> </span>±<span class="w">   </span><span class="m">2</span>.2<span class="w"> </span>ms<span class="w">    </span><span class="o">[</span>User:<span class="w"> </span><span class="m">185</span>.4<span class="w"> </span>ms,<span class="w"> </span>System:<span class="w"> </span><span class="m">44</span>.9<span class="w"> </span>ms<span class="o">]</span>
<span class="w">  </span>Range<span class="w"> </span><span class="o">(</span>min<span class="w"> </span>…<span class="w"> </span>max<span class="o">)</span>:<span class="w">   </span><span class="m">209</span>.1<span class="w"> </span>ms<span class="w"> </span>…<span class="w"> </span><span class="m">216</span>.8<span class="w"> </span>ms<span class="w">    </span><span class="m">14</span><span class="w"> </span>runs

Benchmark<span class="w"> </span><span class="m">3</span>:<span class="w"> </span>cat<span class="w"> </span>large-file.json<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span><span class="s1">&#39;.repo.url&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>jq.test
<span class="w">  </span>Time<span class="w"> </span><span class="o">(</span>mean<span class="w"> </span>±<span class="w"> </span>σ<span class="o">)</span>:<span class="w">     </span><span class="m">356</span>.1<span class="w"> </span>ms<span class="w"> </span>±<span class="w">   </span><span class="m">2</span>.6<span class="w"> </span>ms<span class="w">    </span><span class="o">[</span>User:<span class="w"> </span><span class="m">349</span>.1<span class="w"> </span>ms,<span class="w"> </span>System:<span class="w"> </span><span class="m">26</span>.9<span class="w"> </span>ms<span class="o">]</span>
<span class="w">  </span>Range<span class="w"> </span><span class="o">(</span>min<span class="w"> </span>…<span class="w"> </span>max<span class="o">)</span>:<span class="w">   </span><span class="m">354</span>.1<span class="w"> </span>ms<span class="w"> </span>…<span class="w"> </span><span class="m">362</span>.9<span class="w"> </span>ms<span class="w">    </span><span class="m">10</span><span class="w"> </span>runs

Summary
<span class="w">  </span><span class="s1">&#39;cat large-file.json | ./jqgo &#39;</span>.repo.url<span class="s1">&#39; &gt; jqgo.test&#39;</span><span class="w"> </span>ran
<span class="w">    </span><span class="m">1</span>.46<span class="w"> </span>±<span class="w"> </span><span class="m">0</span>.05<span class="w"> </span><span class="nb">times</span><span class="w"> </span>faster<span class="w"> </span>than<span class="w"> </span><span class="s1">&#39;cat large-file.json | ./control/control &#39;</span>.repo.url<span class="s1">&#39; &gt; control.test&#39;</span>
<span class="w">    </span><span class="m">1</span>.69<span class="w"> </span>±<span class="w"> </span><span class="m">0</span>.02<span class="w"> </span><span class="nb">times</span><span class="w"> </span>faster<span class="w"> </span>than<span class="w"> </span><span class="s1">&#39;cat large-file.json | jq &#39;</span>.repo.url<span class="s1">&#39; &gt; jq.test&#39;</span>
</pre></div>
<p>And we've shaved another 20ms off. That's not bad!</p>
<h3 id="coming-to-a-close">Coming to a close</h3><p>There is more we could do but this is a long post already.</p>
<p>For example, in the project repo I also built a <a href="https://github.com/eatonphil/jqgo/blob/main/vector.go">generic vector
type</a> with a
pop operation that is used for the stack in the <code>eatValue</code>
function. It is shared on the <code>jsonReader</code> instance like the
<code>expectString</code> buffer. This ended up shaving another 20ms. And I also
got rid of most conversions from <code>[]byte</code> to <code>string</code> (which is an
expensive allocation you may notice listed as <code>bytes.String()</code> in the
<code>top10</code> of <code>-alloc_objects</code> if you run the profiler again now.)</p>
<p>But hopefully you're getting the gist of how you might investigate CPU
and memory usage. For me it's still a lot of poking around and trying
different things. But after a few years of trying to get better at
profiling Go programs I think I'm starting to get the hang of it.</p>
<p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">I wrote a new blog post on implementing a simple jq clone from scratch in Go. This post explores partial/fuzzy parsing again and finishes with my approach to debugging memory/CPU usage in Go programs. It&#39;s a bit of a long post but hopefully worthwhile! :)<a href="https://t.co/DxilIVaUBa">https://t.co/DxilIVaUBa</a> <a href="https://t.co/as3Sr5I2G0">pic.twitter.com/as3Sr5I2G0</a></p>&mdash; Phil Eaton (@phil_eaton) <a href="https://twitter.com/phil_eaton/status/1546470283334270977?ref_src=twsrc%5Etfw">July 11, 2022</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<style>.feedback{display:initial;}</style>
	</div>
	<div class="feedback">
	  <h4>Feedback</h4>
	  <p>As always,
	      please <a href="mailto:phil@eatonphil.com">email</a>
	      or <a href="https://twitter.com/eatonphil">tweet me</a>
	      with questions, corrections, or ideas!</p>

	</div>
      </div>
    </div>
    <footer>
      <div class="container">
	<div>
	  <div class="row">
	    <div class="feedback">
	      <h4>Frequent Topics</h4>
	      <div class="tags"><a href="/tags/javascript.html" class="tag">javascript (24)</a><a href="/tags/go.html" class="tag">go (24)</a><a href="/tags/databases.html" class="tag">databases (24)</a><a href="/tags/parsing.html" class="tag">parsing (21)</a><a href="/tags/postgres.html" class="tag">postgres (18)</a><a href="/tags/compilers.html" class="tag">compilers (14)</a><a href="/tags/sql.html" class="tag">sql (11)</a><a href="/tags/interpreters.html" class="tag">interpreters (11)</a><a href="/tags/zig.html" class="tag">zig (9)</a><a href="/tags/lisp.html" class="tag">lisp (9)</a><a href="/tags/books.html" class="tag">books (9)</a><a href="/tags/python.html" class="tag">python (8)</a><a href="/tags/linux.html" class="tag">linux (7)</a><a href="/tags/learning.html" class="tag">learning (7)</a><a href="/tags/json.html" class="tag">json (7)</a><a href="/tags/x86-amd64.html" class="tag">x86/amd64 (6)</a><a href="/tags/scheme.html" class="tag">scheme (6)</a><a href="/tags/c.html" class="tag">c (6)</a><a href="/tags/typescript.html" class="tag">typescript (5)</a><a href="/tags/mysql.html" class="tag">mysql (5)</a></div>
	    </div>
	  </div>
	  <div id="subscribe">
	    <style type="text/css">
  /* LOADER */
  .ml-form-embedSubmitLoad {
      display: inline-block;
      width: 20px;
      height: 20px;
  }
  .g-recaptcha {
      transform: scale(1);
      -webkit-transform: scale(1);
      transform-origin: 0 0;
      -webkit-transform-origin: 0 0;
      height: ;
  }
  .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      border: 0;
  }
  .ml-form-embedSubmitLoad:after {
      content: " ";
      display: block;
      width: 11px;
      height: 11px;
      margin: 1px;
      border-radius: 50%;
      border: 4px solid #fff;
      border-color: #ffffff #ffffff #ffffff transparent;
      animation: ml-form-embedSubmitLoad 1.2s linear infinite;
  }
  @keyframes ml-form-embedSubmitLoad {
      0% {
          transform: rotate(0deg);
      }
      100% {
          transform: rotate(360deg);
      }
  }
  #mlb2-3175296.ml-form-embedContainer {
      box-sizing: border-box;
      display: table;
      margin: 0 auto;
      position: static;
      width: 100% !important;
  }
  #mlb2-3175296.ml-form-embedContainer h3,
  #mlb2-3175296.ml-form-embedContainer p,
  #mlb2-3175296.ml-form-embedContainer span,
  #mlb2-3175296.ml-form-embedContainer button {
      text-transform: none !important;
      letter-spacing: normal !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper {
      border-width: 0px;
      border-color: transparent;
  border-radius: 4px;
  border-style: solid;
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  position: relative;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-align-left { text-align: left; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-align-center {
  text-align: center;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-align-default { display: table-cell !important; vertical-align: middle !important; text-align: center !important; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-align-right { text-align: right; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedHeader img {
  border-top-left-radius: 4px;
  border-top-right-radius: 4px;
  height: auto;
  margin: 0 auto !important;
  max-width: 100%;
  width: undefinedpx;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody.ml-form-embedBodyHorizontal {
  padding-bottom: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent {
  text-align: left;
  margin: 0 0 20px 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent p,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent p {
  color: #000000;
  font-size: 14px;
  font-weight: 400;
  line-height: 20px;
  margin: 0 0 10px 0;
  text-align: left;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent ul,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent ol,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent ul,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent ol {
  color: #000000;
  font-size: 14px;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent ol ol,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent ol ol {
  list-style-type: lower-alpha;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent ol ol ol,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent ol ol ol {
  list-style-type: lower-roman;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent p a,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent p a {
  color: #000000;
  text-decoration: underline;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-block-form .ml-field-group {
  text-align: left!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-block-form .ml-field-group label {
  margin-bottom: 5px;
  color: #333333;
  font-size: 14px;
  font-weight: bold; font-style: normal; text-decoration: none;;
  display: inline-block;
  line-height: 20px;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedContent p:last-child,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-successBody .ml-form-successContent p:last-child {
  margin: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody form {
  margin: 0;
  width: 100%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-formContent,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow {
  margin: 0 0 20px 0;
  width: 100%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow {
  float: left;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-formContent.horozintalForm {
  margin: 0;
  padding: 0 0 20px 0;
  width: 100%;
  height: auto;
  float: left;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow {
  margin: 0 0 10px 0;
  width: 100%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow.ml-last-item {
  margin: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow.ml-formfieldHorizintal {
  margin: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input {
  background-color: #ffffff !important;
  color: #333333 !important;
  border-color: #cccccc;
  border-radius: 4px !important;
  border-style: solid !important;
  border-width: 1px !important;
  font-size: 14px !important;
  height: auto;
  line-height: 21px !important;
  margin-bottom: 0;
  margin-top: 0;
  margin-left: 0;
  margin-right: 0;
  padding: 10px 10px !important;
  width: 100% !important;
  box-sizing: border-box !important;
  max-width: 100% !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input::-webkit-input-placeholder,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input::-webkit-input-placeholder { color: #333333; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input::-moz-placeholder,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input::-moz-placeholder { color: #333333; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input:-ms-input-placeholder,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input:-ms-input-placeholder { color: #333333; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input:-moz-placeholder,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input:-moz-placeholder { color: #333333; }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow textarea, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow textarea {
  background-color: #ffffff !important;
  color: #333333 !important;
  border-color: #cccccc;
  border-radius: 4px !important;
  border-style: solid !important;
  border-width: 1px !important;
  font-size: 14px !important;
  height: auto;
  line-height: 21px !important;
  margin-bottom: 0;
  margin-top: 0;
  padding: 10px 10px !important;
  width: 100% !important;
  box-sizing: border-box !important;
  max-width: 100% !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before {
  border-color: #cccccc!important;
  background-color: #ffffff!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow input.custom-control-input[type="checkbox"]{
  box-sizing: border-box;
  padding: 0;
  position: absolute;
  z-index: -1;
  opacity: 0;
  margin-top: 5px;
  margin-left: -1.5rem;
  overflow: visible;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before {
  border-radius: 4px!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow input[type=checkbox]:checked~.label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox input[type=checkbox]:checked~.label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-input:checked~.custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-input:checked~.custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox input[type=checkbox]:checked~.label-description::after {
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23fff' d='M6.564.75l-3.59 3.612-1.538-1.55L0 4.26 2.974 7.25 8 2.193z'/%3e%3c/svg%3e");
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-input:checked~.custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-input:checked~.custom-control-label::after {
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e");
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-input:checked~.custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-input:checked~.custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-input:checked~.custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-input:checked~.custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox input[type=checkbox]:checked~.label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox input[type=checkbox]:checked~.label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow input[type=checkbox]:checked~.label-description::before  {
  border-color: #000000!important;
  background-color: #000000!important;
  color: #ffffff!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label::after {
  top: 2px;
  box-sizing: border-box;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::after {
  top: 0px!important;
  box-sizing: border-box!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::after {
  top: 0px!important;
  box-sizing: border-box!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::after {
  top: 0px!important;
  box-sizing: border-box!important;
  position: absolute;
  left: -1.5rem;
  display: block;
  width: 1rem;
  height: 1rem;
  content: "";
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::before {
  top: 0px!important;
  box-sizing: border-box!important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .custom-control-label::before {
  position: absolute;
  top: 4px;
  left: -1.5rem;
  display: block;
  width: 16px;
  height: 16px;
  pointer-events: none;
  content: "";
  background-color: #ffffff;
  border: #adb5bd solid 1px;
  border-radius: 50%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .custom-control-label::after {
  position: absolute;
  top: 2px!important;
  left: -1.5rem;
  display: block;
  width: 1rem;
  height: 1rem;
  content: "";
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::before, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::before {
  position: absolute;
  top: 4px;
  left: -1.5rem;
  display: block;
  width: 16px;
  height: 16px;
  pointer-events: none;
  content: "";
  background-color: #ffffff;
  border: #adb5bd solid 1px;
  border-radius: 50%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::after {
  position: absolute;
  top: 0px!important;
  left: -1.5rem;
  display: block;
  width: 1rem;
  height: 1rem;
  content: "";
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::after {
  position: absolute;
  top: 0px!important;
  left: -1.5rem;
  display: block;
  width: 1rem;
  height: 1rem;
  content: "";
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .custom-radio .custom-control-label::after {
  background: no-repeat 50%/50% 50%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .custom-checkbox .custom-control-label::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedPermissions .ml-form-embedPermissionsOptionsCheckbox .label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-interestGroupsRow .ml-form-interestGroupsRowCheckbox .label-description::after, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description::after {
  background: no-repeat 50%/50% 50%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-control, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-control {
  position: relative;
  display: block;
  min-height: 1.5rem;
  padding-left: 1.5rem;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-input, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-input, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-input, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-input {
  position: absolute;
  z-index: -1;
  opacity: 0;
  box-sizing: border-box;
  padding: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-radio .custom-control-label, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-radio .custom-control-label, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-checkbox .custom-control-label, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-checkbox .custom-control-label {
  color: #000000;
  font-size: 12px!important;
  line-height: 22px;
  margin-bottom: 0;
  position: relative;
  vertical-align: top;
  font-style: normal;
  font-weight: 700;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-fieldRow .custom-select, #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow .custom-select {
  background-color: #ffffff !important;
  color: #333333 !important;
  border-color: #cccccc;
  border-radius: 4px !important;
  border-style: solid !important;
  border-width: 1px !important;
  font-size: 14px !important;
  line-height: 20px !important;
  margin-bottom: 0;
  margin-top: 0;
  padding: 10px 28px 10px 12px !important;
  width: 100% !important;
  box-sizing: border-box !important;
  max-width: 100% !important;
  height: auto;
  display: inline-block;
  vertical-align: middle;
  background: url('https://assets.mlcdn.com/ml/images/default/dropdown.svg') no-repeat right .75rem center/8px 10px;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow {
  height: auto;
  width: 100%;
  float: left;
  }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-input-horizontal { width: 70%; float: left; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-button-horizontal { width: 30%; float: left; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-button-horizontal.labelsOn { padding-top: 25px;  }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .horizontal-fields { box-sizing: border-box; float: left; padding-right: 10px;  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow input {
  background-color: #ffffff;
  color: #333333;
  border-color: #cccccc;
  border-radius: 4px;
  border-style: solid;
  border-width: 1px;
  font-size: 14px;
  line-height: 20px;
  margin-bottom: 0;
  margin-top: 0;
  padding: 10px 10px;
  width: 100%;
  box-sizing: border-box;
  overflow-y: initial;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow button {
  background-color: #000000 !important;
  border-color: #000000;
  border-style: solid;
  border-width: 1px;
  border-radius: 4px;
  box-shadow: none;
  color: #ffffff !important;
  cursor: pointer;
  font-size: 14px !important;
  font-weight: 700;
  line-height: 20px;
  margin: 0 !important;
  padding: 10px !important;
  width: 100%;
  height: auto;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-horizontalRow button:hover {
  background-color: #333333 !important;
  border-color: #333333 !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow input[type="checkbox"] {
  box-sizing: border-box;
  padding: 0;
  position: absolute;
  z-index: -1;
  opacity: 0;
  margin-top: 5px;
  margin-left: -1.5rem;
  overflow: visible;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow .label-description {
  color: #000000;
  display: block;
  font-size: 12px;
  text-align: left;
  margin-bottom: 0;
  position: relative;
  vertical-align: top;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow label {
  font-weight: normal;
  margin: 0;
  padding: 0;
  position: relative;
  display: block;
  min-height: 24px;
  padding-left: 24px;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow label a {
  color: #000000;
  text-decoration: underline;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow label p {
  color: #000000 !important;
  font-size: 12px !important;
  font-weight: normal !important;
  line-height: 18px !important;
  padding: 0 !important;
  margin: 0 5px 0 0 !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow label p:last-child {
  margin: 0;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedSubmit {
  margin: 0 0 20px 0;
  float: left;
  width: 100%;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedSubmit button {
  background-color: #000000 !important;
  border: none !important;
  border-radius: 4px !important;
  box-shadow: none !important;
  color: #ffffff !important;
  cursor: pointer;
  font-size: 14px !important;
  font-weight: 700 !important;
  line-height: 21px !important;
  height: auto;
  padding: 10px !important;
  width: 100% !important;
  box-sizing: border-box !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedSubmit button.loading {
  display: none;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-embedSubmit button:hover {
  background-color: #333333 !important;
  }
  .ml-subscribe-close {
  width: 30px;
  height: 30px;
  background: url('https://assets.mlcdn.com/ml/images/default/modal_close.png') no-repeat;
  background-size: 30px;
  cursor: pointer;
  margin-top: -10px;
  margin-right: -10px;
  position: absolute;
  top: 0;
  right: 0;
  }
  .ml-error input, .ml-error textarea, .ml-error select {
  border-color: red!important;
  }
  .ml-error .custom-checkbox-radio-list {
  border: 1px solid red !important;
  border-radius: 4px;
  padding: 10px;
  }
  .ml-error .label-description,
  .ml-error .label-description p,
  .ml-error .label-description p a,
  .ml-error label:first-child {
  color: #ff0000 !important;
  }
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow.ml-error .label-description p,
  #mlb2-3175296.ml-form-embedContainer .ml-form-embedWrapper .ml-form-embedBody .ml-form-checkboxRow.ml-error .label-description p:first-letter {
  color: #ff0000 !important;
  }
  @media only screen and (max-width: 400px){
  .ml-form-embedWrapper.embedDefault, .ml-form-embedWrapper.embedPopup { width: 100%!important; }
  .ml-form-formContent.horozintalForm { float: left!important; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow { height: auto!important; width: 100%!important; float: left!important; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-input-horizontal { width: 100%!important; }
  .ml-form-formContent.horozintalForm .ml-form-horizontalRow .ml-input-horizontal > div { padding-right: 0px!important; padding-bottom: 10px; }
    .ml-form-formContent.horozintalForm .ml-button-horizontal { width: 100%!important; }
    .ml-form-formContent.horozintalForm .ml-button-horizontal.labelsOn { padding-top: 0px!important; }
    }
</style>
<div id="mlb2-3175296" class="ml-form-embedContainer ml-subscribe-form ml-subscribe-form-3175296">
  <hr />
  <div class="ml-form-align-center ">
    <div class="ml-form-embedWrapper embedForm">
      <div class="ml-form-embedBody ml-form-embedBodyDefault row-form">
        <div class="ml-form-embedContent" style=" ">
          <h4>Subscribe</h4>
          <p>Enter your email if you'd like to be kept in the loop about future articles!<br><br>You can expect 2 to 4 messages per month depending on how motivated I'm feeling. :)</p>
	  <p></p>
	  <p>Cheers,<br>Phil</p>
        </div>
        <form class="ml-block-form" action="https://assets.mailerlite.com/jsonp/303114/forms/78235486326359572/subscribe" data-code="" method="post" target="_blank">
          <div class="ml-form-formContent">
            <div class="ml-form-fieldRow ml-last-item">
              <div class="ml-field-group ml-field-email ml-validate-email ml-validate-required">
                <!-- input -->
                <input aria-label="email" aria-required="true" type="email" class="form-control" data-inputmask="" name="fields[email]" placeholder="Email" autocomplete="email">
                <!-- /input -->
                <!-- textarea -->
                <!-- /textarea -->
                <!-- select -->
                <!-- /select -->
                <!-- checkboxes -->
		<!-- /checkboxes -->
                <!-- radio -->
                <!-- /radio -->
                <!-- countries -->
                <!-- /countries -->
              </div>
            </div>
          </div>
          <!-- Privacy policy -->
          <!-- /Privacy policy -->
	  <div class="ml-form-recaptcha ml-validate-required" style="float: left;">
            <style type="text/css">
	      .ml-form-recaptcha {
		  margin-bottom: 20px;
	      }
	      .ml-form-recaptcha.ml-error iframe {
		  border: solid 1px #ff0000;
	      }
	      @media screen and (max-width: 480px) {
		  .ml-form-recaptcha {
		      width: 220px!important
		  }
		  .g-recaptcha {
		      transform: scale(0.78);
		      -webkit-transform: scale(0.78);
		      transform-origin: 0 0;
		      -webkit-transform-origin: 0 0;
		  }
	      }
	    </style>
	    <script src="https://www.google.com/recaptcha/api.js"></script>
	    <div class="g-recaptcha" data-sitekey="6Lf1KHQUAAAAAFNKEX1hdSWCS3mRMv4FlFaNslaD"></div>
	  </div>
          <input type="hidden" name="ml-submit" value="1">
          <div class="ml-form-embedSubmit">
            <button type="submit" class="primary">Subscribe</button>
            <button disabled="disabled" style="display: none;" type="button" class="loading">
              <div class="ml-form-embedSubmitLoad"></div>
              <span class="sr-only">Loading...</span>
            </button>
          </div>
          <input type="hidden" name="anticsrf" value="true">
        </form>
      </div>
      <div class="ml-form-successBody row-success" style="display: none">
        <div class="ml-form-successContent">
          <h3>Thanks :)</h3>
          <p>You're in.</p>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  function ml_webform_success_3175296() {
      var $ = ml_jQuery || jQuery;
      $('.ml-subscribe-form-3175296 .row-success').show();
      $('.ml-subscribe-form-3175296 .row-form').hide();
  }
</script>
<script src="https://groot.mailerlite.com/js/w/webforms.min.js?v300817f630ad0e957914d0b28a2b6d78" type="text/javascript"></script>

	  </div>
	</div>
      </div>
    </footer>
    <script async onload="loadGA()" src="https://www.googletagmanager.com/gtag/js?id=UA-58109156-2"></script>
    <script>
      function loadGA() {
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());
	  gtag('config', 'UA-58109156-2');
      }
    </script>
    <script defer src="https://cdn.usefathom.com/script.js" data-site="CEPUOLOQ"></script>
  </body>
</html>
