<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="canonical" href="https://notes.eatonphil.com/writing-a-template-library-in-python.html">
    <title>Writing a Jinja-inspired template library in Python | notes.eatonphil.com</title>
    <meta name="description" content="Writing a Jinja-inspired template library in Python" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" href="/rss.xml" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono">
  </head>
  <body>
    <header>
      <div class="lfw">
	<div class="container">
	  <div class="row">
	    <a href="https://eatonphil.com/2025-holiday-fundraiser.html">2025 holiday fundraiser</a>
	  </div>
	</div>
      </div>
      <div class="container">
        <div>
          <div class="row">
	    <div>
	      <a href="https://eatonphil.com" class="sm-link">
		Home
              </a>
	      <a href="/" class="sm-link">
		Blog
              </a>
	      <a href="/rss.xml" class="sm-link">
		RSS
              </a>
	    </div>

	    <div class="subscribe">
	      <!-- <a href="https://eatonphil.com/hire-me.html">Hire me</a> -->
	      <!--
		  Hardcode link to home page because some pages don't
		  have a subscribe box. Some pages hide the subscribe.
		-->
	      <a href="https://eatonphil.com/subscribe.html">
		Subscribe
	      </a>
            </div>
	  </div>
	  <hr />
	  <div class="">
            <h2>May 23, 2021</h2>
            <h1>Writing a Jinja-inspired template library in Python</h1>
	    
            <div class="row" style="padding-bottom: 5px">
              <div class="tags"><a href="/tags/python.html" class="tag">python</a><a href="/tags/parsing.html" class="tag">parsing</a><a href="/tags/template-library.html" class="tag">template-library</a></div>
            </div>
	  </div>
	</div>
      </div>
    </header>
    <div class="container">
      <div class="col-6">
	<div class="post">
          <p>In this post we'll build a minimal text templating library in Python
inspired by Jinja. It will be able to display variables and iterate
over arrays.</p>
<p>By the end of this article, with around 300 lines of code, we'll be
able to create this program:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pytemplate</span> <span class="kn">import</span> <span class="n">eval_template</span>

<span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">&lt;html&gt;</span>
<span class="s1">  &lt;body&gt;</span>
<span class="s1">  {</span><span class="si">% f</span><span class="s1">or-in(post, posts) %}</span>
<span class="s1">  &lt;article&gt;</span>
<span class="s1">    &lt;h1&gt;{{ get(post, &#39;title&#39;) }}&lt;/h1&gt;</span>
<span class="s1">    &lt;p&gt;</span>
<span class="s1">      {{ get(post, &#39;body&#39;) }}</span>
<span class="s1">    &lt;/p&gt;</span>
<span class="s1">  &lt;/article&gt;</span>
<span class="s1">  {</span><span class="si">% e</span><span class="s1">ndfor-in %}</span>
<span class="s1">  &lt;/body&gt;</span>
<span class="s1">&lt;/html&gt;</span>
<span class="s1">&#39;&#39;&#39;</span>

<span class="n">env</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;posts&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Hello world!&#39;</span><span class="p">,</span>
            <span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="s1">&#39;This is my first post!&#39;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Take two&#39;</span><span class="p">,</span>
            <span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="s1">&#39;This is a second post.&#39;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">],</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="n">eval_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">env</span><span class="p">))</span>
</pre></div>
<p>That runs and produces what we expect:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>python3<span class="w"> </span>test.py

&lt;html&gt;
<span class="w">  </span>&lt;body&gt;

<span class="w">  </span>&lt;article&gt;
<span class="w">    </span>&lt;h1&gt;Hello<span class="w"> </span>world!&lt;/h1&gt;
<span class="w">    </span>&lt;p&gt;
<span class="w">      </span>This<span class="w"> </span>is<span class="w"> </span>my<span class="w"> </span>first<span class="w"> </span>post!
<span class="w">    </span>&lt;/p&gt;
<span class="w">  </span>&lt;/article&gt;

<span class="w">  </span>&lt;article&gt;
<span class="w">    </span>&lt;h1&gt;Take<span class="w"> </span>two&lt;/h1&gt;
<span class="w">    </span>&lt;p&gt;
<span class="w">      </span>This<span class="w"> </span>is<span class="w"> </span>a<span class="w"> </span>second<span class="w"> </span>post.
<span class="w">    </span>&lt;/p&gt;
<span class="w">  </span>&lt;/article&gt;

<span class="w">  </span>&lt;/body&gt;
&lt;/html&gt;
</pre></div>
<p>All code is available on
<a href="https://github.com/eatonphil/pytemplate">Github</a>. Let's dig in.</p>
<h3 id="specification">Specification</h3><p>In this templating language, pytemplate, <code>{% $function () %}
... {% end$function %}</code> blocks are specially evaluated depending
on the particular function being called. For example, the <code>for-in
($iter_name, $array)</code> function will duplicate its children for
every element in <code>$array</code>. Within the body of the loop, the
variable <code>$iter_name</code> will exist and be set to the current
element in the array.</p>
<p>While we won't implement it here, you can imagine what the <code>if
($test)</code> block function might do.</p>
<h3 id="arguments,-expressions,-function-calls:-nodes">Arguments, expressions, function calls: nodes</h3><p>Function arguments are expressions (or <code>nodes</code> as we'll
call them). They can be strings (surrounded by single quotes),
identifiers found in a provided dictionary (or
<code>environment</code> as we'll call it), or nested function calls
(also called nodes).</p>
<h3 id="non-blocks:-tags">Non-blocks: tags</h3><p>The non-block syntax <code>{{ ... }}</code> are just called tags. The
inside of a tag is a node and is evaluated the same way a function
argument is.</p>
<h3 id="architecture">Architecture</h3><p>We'll break up the library into a few main parts:</p>
<ul>
<li>Lexer for the node language</li>
<li>Parser for the node language</li>
<li>Lexer for blocks, tags, and text</li>
<li>Parser for blocks, tags, and text</li>
<li>Interpreter that takes an AST and an environment dictionary and produces text</li>
<li>An entrypoint to tie all the above together</li>
</ul>
<p>We'll tackle these aspects in roughly reverse order.</p>
<h3 id="entrypoint">Entrypoint</h3><p>When we call the library we want to be able to just accept a template
string and an environment dictionary. The result of the entrypoint
will be the evaluated template.</p>
<p><span class="code-caption">pytemplate.py</span></p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">io</span>


<span class="k">def</span> <span class="nf">eval_template</span><span class="p">(</span><span class="n">template</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">lex</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
    <span class="n">ast</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span> <span class="k">as</span> <span class="n">memfd</span><span class="p">:</span>
        <span class="n">interpret</span><span class="p">(</span><span class="n">memfd</span><span class="p">,</span> <span class="n">ast</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">memfd</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</pre></div>
<p>Where lex, parse, and interpret have to do with the block- and
tag-level language.</p>
<h3 id="block,-tag-and-text-lexing">Block, tag and text lexing</h3><p>This process is responsible for turning the template string into an
array of tokens. To make the code simpler, lexing for the function
call and expression language is done separately. At this stage all
we'll look for is tokens consisting of block and tag end and beginning
markers. So
just <code>{%</code>, <code>%}</code>, <code>{{</code>, <code>}}</code>. If
a token is not one of these, it is regular text.</p>
<p><span class="code-caption">pytemplate.py</span></p>
<div class="highlight"><pre><span></span><span class="n">BLOCK_OPEN</span> <span class="o">=</span> <span class="s1">&#39;{%&#39;</span>
<span class="n">BLOCK_CLOSE</span> <span class="o">=</span> <span class="s1">&#39;%}&#39;</span>

<span class="n">TAG_OPEN</span> <span class="o">=</span> <span class="s1">&#39;{{&#39;</span>
<span class="n">TAG_CLOSE</span> <span class="o">=</span> <span class="s1">&#39;}}&#39;</span>


<span class="k">def</span> <span class="nf">getelement</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">cursor</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">cursor</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">cursor</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">source</span><span class="p">[</span><span class="n">cursor</span><span class="p">]</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">lex</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">current</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">cursor</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
        <span class="n">char</span> <span class="o">=</span> <span class="n">getelement</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">cursor</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;{&#39;</span><span class="p">:</span>
            <span class="c1"># Handle escaping {</span>
            <span class="k">if</span> <span class="n">getelement</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">cursor</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;{&#39;</span><span class="p">:</span>
                <span class="n">cursor</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>

            <span class="n">next_char</span> <span class="o">=</span> <span class="n">getelement</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">cursor</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">next_char</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">current</span><span class="p">:</span>
                    <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">current</span><span class="p">,</span>
                        <span class="s1">&#39;cursor&#39;</span><span class="p">:</span> <span class="n">cursor</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">current</span><span class="p">),</span>
                    <span class="p">})</span>
                    <span class="n">current</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

                <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">BLOCK_OPEN</span> <span class="k">if</span> <span class="n">next_char</span> <span class="o">==</span> <span class="s1">&#39;%&#39;</span> <span class="k">else</span> <span class="n">TAG_OPEN</span><span class="p">,</span>
                    <span class="s1">&#39;cursor&#39;</span><span class="p">:</span> <span class="n">cursor</span><span class="p">,</span>
                <span class="p">})</span>
                <span class="n">cursor</span> <span class="o">+=</span> <span class="mi">2</span>
                <span class="k">continue</span>

        <span class="k">if</span> <span class="n">char</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">]:</span>
            <span class="c1"># Handle escaping % and }</span>
            <span class="k">if</span> <span class="n">getelement</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">cursor</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">char</span><span class="p">:</span>
                <span class="n">cursor</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">getelement</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">cursor</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;}&#39;</span><span class="p">:</span>
                <span class="n">cursor</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">current</span><span class="p">:</span>
                <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">current</span><span class="p">,</span>
                    <span class="s1">&#39;cursor&#39;</span><span class="p">:</span> <span class="n">cursor</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">current</span><span class="p">),</span>
                <span class="p">})</span>
                <span class="n">current</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">BLOCK_CLOSE</span> <span class="k">if</span> <span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;%&#39;</span> <span class="k">else</span> <span class="n">TAG_CLOSE</span><span class="p">,</span>
                <span class="s1">&#39;cursor&#39;</span><span class="p">:</span> <span class="n">cursor</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="n">cursor</span> <span class="o">+=</span> <span class="mi">2</span>
            <span class="k">continue</span>

        <span class="n">current</span> <span class="o">+=</span> <span class="n">getelement</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">cursor</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">current</span><span class="p">:</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">current</span><span class="p">,</span>
            <span class="s1">&#39;cursor&#39;</span><span class="p">:</span> <span class="n">cursor</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">current</span><span class="p">),</span>
        <span class="p">})</span>

    <span class="k">return</span> <span class="n">tokens</span>
</pre></div>
<p>That's it for lexing!</p>
<h3 id="block,-tag-and-text-parsing">Block, tag and text parsing</h3><p>Next up is a matter of finding the ending/closing patterns in the array of tokens. There are a few main rules we'll look for:</p>
<ul>
<li>Every open tag symbol <code>{{</code> must be followed by a text token then a closing tag symbol <code>}}</code><ul>
<li>The text within the open and close tag must parse into a valid expression (we'll define this logic later)</li>
</ul>
</li>
<li>Every block symbol <code>{%</code> must be followed by a text token then an end of block symbol <code>%}</code><ul>
<li>The text token within the open and close block must parse into a valid function call (we'll define this logic later)</li>
</ul>
</li>
<li>Every block must have a matching end block where the text in the end block is <code>end</code> concatenated to the beginning of the function being called in the start block<ul>
<li>The text between two blocks can contain nested blocks or tags</li>
</ul>
</li>
</ul>
<p>Let's codify that:</p>
<p><span class="code-caption">pytemplate.py</span></p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">end_of_block_marker</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ast</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">cursor</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">getelement</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">cursor</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">TAG_OPEN</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">getelement</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">cursor</span><span class="o">+</span><span class="mi">2</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">TAG_CLOSE</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Expected closing tag&#39;</span><span class="p">)</span>

            <span class="n">node_tokens</span> <span class="o">=</span> <span class="n">lex_node</span><span class="p">(</span><span class="n">getelement</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">cursor</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
            <span class="n">node_ast</span> <span class="o">=</span> <span class="n">parse_node</span><span class="p">(</span><span class="n">node_tokens</span><span class="p">)</span>
            <span class="n">ast</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;tag&#39;</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">node_ast</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="n">cursor</span> <span class="o">+=</span> <span class="mi">3</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">TAG_CLOSE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Expected opening tag&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">BLOCK_OPEN</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">getelement</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">cursor</span><span class="o">+</span><span class="mi">2</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">BLOCK_CLOSE</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Expected end of block open&#39;</span><span class="p">)</span>

            <span class="n">block</span> <span class="o">=</span> <span class="n">getelement</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">cursor</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">node_tokens</span> <span class="o">=</span> <span class="n">lex_node</span><span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
            <span class="n">node_ast</span> <span class="o">=</span> <span class="n">parse_node</span><span class="p">(</span><span class="n">node_tokens</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">end_of_block_marker</span> <span class="ow">and</span> <span class="s1">&#39;end&#39;</span><span class="o">+</span><span class="n">end_of_block_marker</span> <span class="o">==</span> <span class="n">node_ast</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">ast</span><span class="p">,</span> <span class="n">cursor</span><span class="o">+</span><span class="mi">3</span>

            <span class="n">child</span><span class="p">,</span> <span class="n">cursor_offset</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="n">cursor</span><span class="o">+</span><span class="mi">3</span><span class="p">:],</span> <span class="n">node_ast</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">cursor_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Failed to find end of block&#39;</span><span class="p">)</span>

            <span class="n">ast</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;block&#39;</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">node_ast</span><span class="p">,</span>
                <span class="s1">&#39;child&#39;</span><span class="p">:</span> <span class="n">child</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="n">cursor</span> <span class="o">+=</span> <span class="n">cursor_offset</span> <span class="o">+</span> <span class="mi">3</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">BLOCK_CLOSE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Expected start of block open&#39;</span><span class="p">)</span>

        <span class="n">ast</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">cursor</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">ast</span><span class="p">,</span> <span class="n">cursor</span>
</pre></div>
<p>And that's it for parsing blocks and tags. Now we have to get into the
node language.</p>
<h3 id="node-lexing">Node lexing</h3><p>In the node language, everything is either a literal or a function
call. Whitespace is ignored. The only special symbols in the node
language are commas and parentheses.</p>
<p>So to break the text into tokens we just iterate over all characters
until we find whitespace or a symbol. Accumulate the characters that
are not either. Add everything but whitespace to the list of tokens.</p>
<p><span class="code-caption">pytemplate.py</span></p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">lex_node</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">current</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">while</span> <span class="n">cursor</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
        <span class="n">char</span> <span class="o">=</span> <span class="n">getelement</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">cursor</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">char</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">current</span><span class="p">:</span>
                <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">current</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;literal&#39;</span><span class="p">,</span>
                <span class="p">})</span>
                <span class="n">current</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="n">cursor</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">char</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">current</span><span class="p">:</span>
                <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">current</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;literal&#39;</span><span class="p">,</span>
                <span class="p">})</span>
                <span class="n">current</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">char</span><span class="p">,</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;syntax&#39;</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="n">cursor</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>

        <span class="n">current</span> <span class="o">+=</span> <span class="n">char</span>
        <span class="n">cursor</span> <span class="o">+=</span><span class="mi">1</span>

    <span class="k">return</span> <span class="n">tokens</span>
</pre></div>
<p>And that's it for node lexing.</p>
<h3 id="node-parsing">Node parsing</h3><p>We'll break this up into two functions. The first is just for parsing
literals and function calls.</p>
<p><span class="code-caption">pytemplate.py</span></p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">parse_node</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ast</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="n">cursor</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">getelement</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">cursor</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;literal&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Expected literal&#39;</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">next_t</span> <span class="o">=</span> <span class="n">getelement</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">cursor</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">next_t</span><span class="p">:</span>
            <span class="n">ast</span> <span class="o">=</span> <span class="n">t</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="n">next_t</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;(&#39;</span><span class="p">:</span>
            <span class="n">ast</span> <span class="o">=</span> <span class="n">t</span>
            <span class="k">break</span>

        <span class="n">cursor</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">next_t</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;(&#39;</span><span class="p">:</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">cursor</span> <span class="o">=</span> <span class="n">parse_node_args</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="n">cursor</span><span class="p">:])</span>
            <span class="n">ast</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;function&#39;</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">cursor</span> <span class="o">+=</span> <span class="mi">2</span>

        <span class="k">break</span>

    <span class="k">if</span> <span class="n">cursor</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Failed to parse node: &#39;</span> <span class="o">+</span> <span class="n">tokens</span><span class="p">[</span><span class="n">cursor</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">ast</span>
</pre></div>
<p>The second is for parsing function call arguments.</p>
<p><span class="code-caption">pytemplate.py</span></p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">parse_node_args</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">cursor</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">getelement</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">cursor</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;)&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">args</span><span class="p">,</span> <span class="n">cursor</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;,&#39;</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;,&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Expected comma to separate args&#39;</span><span class="p">)</span>

        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">getelement</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">cursor</span><span class="p">))</span>
        <span class="n">cursor</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">args</span><span class="p">,</span> <span class="n">cursor</span>
</pre></div>
<p>And that's it for parsing and lexing the entire whole template and
node language!</p>
<h3 id="interpreting">Interpreting</h3><p>Interpreting is a matter of iterating over the AST recursively,
writing out literal text, evaluating the contents of tags, and doing
special processing for blocks.</p>
<p><span class="code-caption">pytemplate.py</span></p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">interpret</span><span class="p">(</span><span class="n">outfd</span><span class="p">,</span> <span class="n">ast</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ast</span><span class="p">:</span>
        <span class="n">item_type</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">item_type</span> <span class="o">==</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span>
            <span class="n">outfd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">item_type</span> <span class="o">==</span> <span class="s1">&#39;tag&#39;</span><span class="p">:</span>
            <span class="n">tag_value</span> <span class="o">=</span> <span class="n">interpret_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
            <span class="n">outfd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tag_value</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">item_type</span> <span class="o">==</span> <span class="s1">&#39;block&#39;</span><span class="p">:</span>
            <span class="n">interpret_block</span><span class="p">(</span><span class="n">outfd</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;child&#39;</span><span class="p">],</span> <span class="n">env</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unknown type: &#39;</span> <span class="o">+</span> <span class="n">item_type</span><span class="p">)</span>
</pre></div>
<h4 id="intepreting-nodes">Intepreting nodes</h4><p>A node is one of two things:</p>
<ul>
<li>A literal which is either a<ul>
<li>String if surrounded by single quotes</li>
<li>Otherwise an identifier to be looked up in the environment dictionary</li>
</ul>
</li>
<li>Or a function call</li>
</ul>
<p><span class="code-caption">pytemplate.py</span></p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">interpret_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;literal&#39;</span><span class="p">:</span>
        <span class="c1"># Is a string</span>
        <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&#39;&quot;</span> <span class="ow">and</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Default to an env lookup</span>
        <span class="k">return</span> <span class="n">env</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]]</span>

    <span class="n">function</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span>
</pre></div>
<p>Let's define <code>==</code> which checks if all args are equal. First
we have to interpret all args and then we return True if they are all
equal.</p>
<p><span class="code-caption">pytemplate.py</span></p>
<div class="highlight"><pre><span></span>    <span class="k">if</span> <span class="n">function</span> <span class="o">==</span> <span class="s1">&#39;==&#39;</span><span class="p">:</span>
        <span class="n">arg_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">interpret_node</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">arg_vals</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">arg_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg_vals</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>
</pre></div>
<p>Now let's define a helper for retrieving an entry from a dictionary,
called <code>get</code>. This will evaluate its first arg and assume
it is a dictionary. Then it will evaluate its second arg and assume it
is a key in the dictionary. Then it will return the result of looking
up the key in the dictionary.</p>
<p><span class="code-caption">pytemplate.py</span></p>
<div class="highlight"><pre><span></span>    <span class="k">if</span> <span class="n">function</span> <span class="o">==</span> <span class="s1">&#39;get&#39;</span><span class="p">:</span>
        <span class="n">arg_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">interpret_node</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">arg_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">arg_vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</pre></div>
<p>And if its neither of these supported functions, just raise an error.</p>
<p><span class="code-caption">pytemplate.py</span></p>
<div class="highlight"><pre><span></span>    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unknown function: &#39;</span> <span class="o">+</span> <span class="n">function</span><span class="p">)</span>
</pre></div>
<h4 id="interpreting-blocks">Interpreting blocks</h4><p>Blocks are just a little different than a generic node. In addition to
being evaluated they act on a child AST within the start and end of
the block.</p>
<p>For example, in an <code>if</code> block we will evaluate its argument
and recursively call <code>interpret</code> on the child AST if the argument is
truthy.</p>
<p><span class="code-caption">pytemplate.py</span></p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">interpret_block</span><span class="p">(</span><span class="n">outfd</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
    <span class="n">function</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">function</span> <span class="o">==</span> <span class="s1">&#39;if&#39;</span> <span class="ow">and</span> <span class="n">interpret_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
        <span class="n">interpret</span><span class="p">(</span><span class="n">outfd</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">return</span>
</pre></div>
<p>And for <code>for-in</code> we will use the first argument as the name
of an identifier to be copied into a child environment
dictionary. We'll interpret the second argument and then iterate over
it, calling <code>interpret</code> recursively for each item in the
array and passing the child environment dictionary so it has access to
the current element.</p>
<p><span class="code-caption">pytemplate.py</span></p>
<div class="highlight"><pre><span></span>    <span class="k">if</span> <span class="n">function</span> <span class="o">==</span> <span class="s1">&#39;for-in&#39;</span><span class="p">:</span>
        <span class="n">loop_variable</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">loop_iter_variable</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">interpret_node</span><span class="p">(</span><span class="n">loop_variable</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
            <span class="n">child_env</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">child_env</span><span class="p">[</span><span class="n">loop_iter_variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">elem</span>
            <span class="n">interpret</span><span class="p">(</span><span class="n">outfd</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">child_env</span><span class="p">)</span>

        <span class="k">return</span>
</pre></div>
<p>Just like before, if we see a block we don't support yet, throw an
error.</p>
<p><span class="code-caption">pytemplate.py</span></p>
<div class="highlight"><pre><span></span>    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unsupported block node function: &#39;</span> <span class="o">+</span> <span class="n">function</span><span class="p">)</span>
</pre></div>
<p>And that's that. :)</p>
<h3 id="run-it">Run it</h3><p>Now we can give the example from the beginning a shot.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>python3<span class="w"> </span>test.py

&lt;html&gt;
<span class="w">  </span>&lt;body&gt;

<span class="w">  </span>&lt;article&gt;
<span class="w">    </span>&lt;h1&gt;Hello<span class="w"> </span>world!&lt;/h1&gt;
<span class="w">    </span>&lt;p&gt;
<span class="w">      </span>This<span class="w"> </span>is<span class="w"> </span>my<span class="w"> </span>first<span class="w"> </span>post!
<span class="w">    </span>&lt;/p&gt;
<span class="w">  </span>&lt;/article&gt;

<span class="w">  </span>&lt;article&gt;
<span class="w">    </span>&lt;h1&gt;Take<span class="w"> </span>two&lt;/h1&gt;
<span class="w">    </span>&lt;p&gt;
<span class="w">      </span>This<span class="w"> </span>is<span class="w"> </span>a<span class="w"> </span>second<span class="w"> </span>post.
<span class="w">    </span>&lt;/p&gt;
<span class="w">  </span>&lt;/article&gt;

<span class="w">  </span>&lt;/body&gt;
&lt;/html&gt;
</pre></div>
<p>Pretty sweet for only 300 lines of Python!</p>
<p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">Been wanting to write a Python template library ever since I failed trying to do so years ago in Standard ML. Here&#39;s my take on a Jinja-like library!<a href="https://t.co/P1nAV6fSxk">https://t.co/P1nAV6fSxk</a> <a href="https://t.co/DbXQt1JYx8">pic.twitter.com/DbXQt1JYx8</a></p>&mdash; Phil Eaton (@phil_eaton) <a href="https://twitter.com/phil_eaton/status/1396535283190046722?ref_src=twsrc%5Etfw">May 23, 2021</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<style>.feedback{display:initial;}</style>
	</div>
	<div class="feedback">
	  <h4>Feedback</h4>
	  <p>As always,
	      please <a href="mailto:phil@eatonphil.com">email</a>
	      or <a href="https://twitter.com/eatonphil">tweet me</a>
	      with questions, corrections, or ideas!</p>

	</div>
      </div>
    </div>
    <footer>
      <div class="container">
	<div>
	  <div id="subscribe">
	    <iframe frameBorder="0" src="https://cdn.forms-content-1.sg-form.com/e8ed4c3b-dd46-11f0-b6e6-ce075f2c5f80"/>

	  </div>
	</div>
      </div>
    </footer>
    <script async onload="loadGA()" src="https://www.googletagmanager.com/gtag/js?id=UA-58109156-2"></script>
    <script>
      function loadGA() {
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());
	  gtag('config', 'UA-58109156-2');
      }
    </script>
    <script defer src="https://cdn.usefathom.com/script.js" data-site="CEPUOLOQ"></script>
  </body>
</html>
