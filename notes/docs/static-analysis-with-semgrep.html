<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="canonical" href="https://notes.eatonphil.com/static-analysis-with-semgrep.html">
    <title>Static analysis with semgrep: practical examples using Docker | notes.eatonphil.com</title>
    <meta name="description" content="Static analysis with semgrep: practical examples using Docker" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" href="/rss.xml" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono">

    <script async onload="loadGA()" src="https://www.googletagmanager.com/gtag/js?id=UA-58109156-2"></script>
    <script>
      function loadGA() {
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());
	  gtag('config', 'UA-58109156-2');
      }
    </script>
    <script defer src="https://cdn.usefathom.com/script.js" data-site="CEPUOLOQ"></script>
  </head>
  <body>
    <header>
      <div class="lfw">
	<div class="container">
	  <div class="row">
	    <a href="https://eatonphil.com/2025-holiday-fundraiser.html">2025 Holiday Fundraiser</a>
	  </div>
	</div>
      </div>
      <div class="container">
        <div>
          <div class="row">
	    <div>
	      <a href="https://eatonphil.com" class="sm-link">
		Home
              </a>
	      <a href="/" class="sm-link">
		Blog
              </a>
	      <a href="/rss.xml" class="sm-link">
		RSS
              </a>
	    </div>

	    <div class="subscribe">
	      <!-- <a href="https://eatonphil.com/hire-me.html">Hire me</a> -->
	      <!--
		  Hardcode link to home page because some pages don't
		  have a subscribe box. Some pages hide the subscribe.
		-->
	      <a href="https://eatonphil.com/subscribe.html">
		Subscribe
	      </a>
            </div>
	  </div>
	  <hr />
	  <div class="">
            <h2>December 20, 2020</h2>
            <h1>Static analysis with semgrep: practical examples using Docker</h1>
	    
            <div class="row" style="padding-bottom: 5px">
              <div class="tags"><a href="/tags/semgrep.html" class="tag">semgrep</a><a href="/tags/static-analysis.html" class="tag">static analysis</a><a href="/tags/docker.html" class="tag">docker</a></div>
            </div>
	  </div>
	</div>
      </div>
    </header>
    <div class="container">
      <div class="col-6">
	<div class="post">
          <p>In this post we'll get a basic semgrep environment set up in Docker
running some custom rules against our code.</p>
<h3 id="existing-linters">Existing linters</h3><p>Linters like <a href="https://www.pylint.org/">pylint</a> for Python or
<a href="https://eslint.org/">eslint</a> for JavaScript are great for general,
broad language standards. But what about common nits in code review
like using print statements instead of a logger, or using a defer
statement inside a for loop (Go specific), or the existence of
multiple nested loops.</p>
<p>Most developers don't have experience working with language
parsing. So it's fairly uncommon in small- and medium-sized teams to
see custom linting rules. And while no single linter or language is
that much more complex than the other (it's all just AST operations),
there is a small penalty to learning the AST and framework for each
language linter.</p>
<h3 id="semgrep">Semgrep</h3><p><a href="https://semgrep.dev/">Semgrep</a> is a generic tool for finding patterns
in source code. Unlike traditional regex (and traditional grep) it can
find recursive patterns. This makes it especially useful as a tool to
learn for finding patterns in any language.</p>
<p>An advantage of semgrep rules is that you can learn the semgrep
pattern matching syntax (which is surprisingly easy) and then you can
write rules for any language you'd like to write rules for.</p>
<p>And while the <a href="https://semgrep.dev/editor">online rule tester</a> is
awesome, I had a hard time going from that to a working sample on my
own laptop with Docker. We'll do just that.</p>
<h3 id="catching-print-statements-in-python">Catching print statements in Python</h3><p>Let's say we want a script to fail on any use of print statements in
Python:</p>
<div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">cat</span> <span class="n">test</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">simple</span><span class="o">-</span><span class="nb">print</span><span class="o">.</span><span class="n">py</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG: here&quot;</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG: &quot;</span><span class="p">,</span> <span class="s2">&quot;now here&quot;</span><span class="p">)</span>
</pre></div>
<p>The current <a href="https://semgrep.dev/editor">default example</a> shown in the
online editor happens to be for just this. Click the Advanced tab and
you'll see the following:</p>
<div class="highlight"><pre><span></span><span class="nt">rules</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fail-on-print</span>
<span class="w">  </span><span class="nt">pattern</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">print(&quot;...&quot;)</span>
<span class="w">  </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">Semgrep found a match</span>
<span class="w">  </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">WARNING</span>
</pre></div>
<p>Copy this into <code>config.yml</code>. Let's modify the pattern to
warn on all print calls, not just print calls with a single string
argument:</p>
<div class="highlight"><pre><span></span><span class="nt">rules</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fail-on-print</span>
<span class="w">  </span><span class="nt">pattern</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">print(...)</span>
<span class="w">  </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">Semgrep found a match</span>
<span class="w">  </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">WARNING</span>
</pre></div>
<p>The editor doesn't mention it (nor do any docs I can find) but we also
need to include two keys in the individual rule
object: <code>mode</code> and <code>languages</code>.</p>
<div class="highlight"><pre><span></span><span class="nt">rules</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fail-on-print</span>
<span class="w">  </span><span class="nt">pattern</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">print(...)</span>
<span class="w">  </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">Semgrep found a match</span>
<span class="w">  </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">WARNING</span>
<span class="w">  </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">search</span>
<span class="w">  </span><span class="nt">languages</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;generic&quot;</span><span class="p p-Indicator">]</span>
</pre></div>
<p>Semgrep fails really weirdly if you set <code>mode</code> to
anything other than <code>search</code>, but it won't warn you that
what you set is garbage. The <code>languages</code> setting is
similarly fickle and doesn't give you much feedback if you set it
incorrectly.</p>
<p class="note">
  Also, I'm using the "generic" language here because I don't
  understand the difference between languages and as far as I'm
  concerned the syntax I'm using here is already pretty generic.
</p><p>We run the semgrep Docker image:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>-v<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span><span class="s2">:/src&quot;</span><span class="w"> </span>returntocorp/semgrep<span class="w"> </span>--config<span class="o">=</span>config.yml<span class="w"> </span>test/python
A<span class="w"> </span>new<span class="w"> </span>version<span class="w"> </span>of<span class="w"> </span>Semgrep<span class="w"> </span>is<span class="w"> </span>available.<span class="w"> </span>Please<span class="w"> </span>see<span class="w"> </span>https://github.com/returntocorp/semgrep#upgrading<span class="w"> </span><span class="k">for</span><span class="w"> </span>more<span class="w"> </span>information.
running<span class="w"> </span><span class="m">1</span><span class="w"> </span>rules...
test/python/simple-print.py
severity:warning<span class="w"> </span>rule:fail-on-print:<span class="w"> </span>Semgrep<span class="w"> </span>found<span class="w"> </span>a<span class="w"> </span>match

<span class="m">2</span>:print<span class="o">(</span><span class="s2">&quot;DEBUG: here&quot;</span><span class="o">)</span>
ran<span class="w"> </span><span class="m">1</span><span class="w"> </span>rules<span class="w"> </span>on<span class="w"> </span><span class="m">1</span><span class="w"> </span>files:<span class="w"> </span><span class="m">1</span><span class="w"> </span>findings<span class="s2">&quot;&quot;</span><span class="o">)</span>
</pre></div>
<p>And there we've got our warning!</p>
<p class="note">
  Not completely clear to me why we're getting warned about a new
  version when we've pulled <code>latest</code> as the linked docs
  suggest. Maybe there's a newer version that hasn't made it into a
  Docker image yet.
</p><h3 id="catching-fmt.print*-statements-in-go">Catching fmt.Print* statements in Go</h3><p>Let's say we also want to fail on print statements in Go (because we
should use a logger instead):</p>
<div class="highlight"><pre><span></span><span class="err">$</span><span class="w"> </span><span class="nx">cat</span><span class="w"> </span><span class="nx">test</span><span class="o">/</span><span class="nx">golang</span><span class="o">/</span><span class="nx">simple</span><span class="o">-</span><span class="nx">print</span><span class="p">.</span><span class="k">go</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">main</span>

<span class="kn">import</span><span class="w"> </span><span class="s">&quot;fmt&quot;</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;here&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
<span class="w">  </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%s\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">a</span><span class="p">)</span>
<span class="w">  </span><span class="nx">e</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;My crazy error&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
<p>We could try to look for any <code>import "fmt"</code> code in a file
but that would fail on uses of <code>fmt.Sprintf</code>
or <code>fmt.Errorf</code> which are fine. Instead we'll just focus on
uses of <code>fmt.Printf</code> or <code>fmt.Println</code>:</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">$ cat go-config.yml</span>
<span class="l l-Scalar l-Scalar-Plain">rules</span><span class="p p-Indicator">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fail-on-print</span>
<span class="w">  </span><span class="nt">pattern-either</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">pattern</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fmt.Printf(...)</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">pattern</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fmt.Println(...)</span>
<span class="w">  </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">Semgrep found a match</span>
<span class="w">  </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">WARNING</span>
<span class="w">  </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">search</span>
<span class="w">  </span><span class="nt">languages</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;generic&quot;</span><span class="p p-Indicator">]</span>
</pre></div>
<p>Run the Go config against the Go files:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>-v<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span><span class="s2">:/src&quot;</span><span class="w"> </span>returntocorp/semgrep<span class="w"> </span>--config<span class="o">=</span>go-config.yml<span class="w"> </span>test/golang
A<span class="w"> </span>new<span class="w"> </span>version<span class="w"> </span>of<span class="w"> </span>Semgrep<span class="w"> </span>is<span class="w"> </span>available.<span class="w"> </span>Please<span class="w"> </span>see<span class="w"> </span>https://github.com/returntocorp/semgrep#upgrading<span class="w"> </span><span class="k">for</span><span class="w"> </span>more<span class="w"> </span>information.
running<span class="w"> </span><span class="m">1</span><span class="w"> </span>rules...
test/golang/simple-print.go
severity:warning<span class="w"> </span>rule:fail-on-print:<span class="w"> </span>Semgrep<span class="w"> </span>found<span class="w"> </span>a<span class="w"> </span>match

<span class="m">8</span>:fmt.Printf<span class="o">(</span><span class="s2">&quot;%s\n&quot;</span>,<span class="w"> </span>a<span class="o">)</span>
--------------------------------------------------------------------------------
<span class="m">7</span>:fmt.Println<span class="o">(</span>a<span class="o">)</span>
ran<span class="w"> </span><span class="m">1</span><span class="w"> </span>rules<span class="w"> </span>on<span class="w"> </span><span class="m">1</span><span class="w"> </span>files:<span class="w"> </span><span class="m">2</span><span class="w"> </span>findings
</pre></div>
<p>Cool! Making some sense. Now let's try a harder pattern.</p>
<h3 id="catching-triple-nested-for-loops">Catching triple-nested for loops</h3><p>Let's try to warn on the triple-nested loop in this code:</p>
<div class="highlight"><pre><span></span><span class="err">$</span><span class="w"> </span><span class="nx">cat</span><span class="w"> </span><span class="nx">test</span><span class="o">/</span><span class="nx">golang</span><span class="o">/</span><span class="nx">loopy</span><span class="p">.</span><span class="k">go</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">main</span>

<span class="kn">import</span><span class="w"> </span><span class="s">&quot;log&quot;</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">doneFirst</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">j</span>

<span class="w">      </span><span class="nx">going</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">      </span><span class="nx">k</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="nx">going</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">break</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">k</span><span class="o">++</span>
<span class="w">        </span><span class="nx">log</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">doneFirst</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>If we want to catch the use of nested for loops here then we'll need
to search for the loops surrounded by arbitrary
syntax. Semgrep's <code>...</code> syntax makes this easy.</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">$ cat go-config2.yml</span>
<span class="l l-Scalar l-Scalar-Plain">rules</span><span class="p p-Indicator">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fail-on-3-loop</span>
<span class="w">  </span><span class="nt">pattern</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">for ... {</span>
<span class="w">      </span><span class="no">...</span>
<span class="w">      </span><span class="no">for ... {</span>
<span class="w">        </span><span class="no">...</span>

<span class="w">        </span><span class="no">for ... {</span>
<span class="w">          </span><span class="no">...</span>
<span class="w">        </span><span class="no">}</span>
<span class="w">        </span><span class="no">...</span>
<span class="w">      </span><span class="no">}</span>
<span class="w">      </span><span class="no">...</span>
<span class="w">    </span><span class="no">}</span>
<span class="w">  </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">Semgrep found a match</span>
<span class="w">  </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">WARNING</span>
<span class="w">  </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">search</span>
<span class="w">  </span><span class="nt">languages</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;generic&quot;</span><span class="p p-Indicator">]</span>
</pre></div>
<p>And run semgrep:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>-v<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span><span class="s2">:/src&quot;</span><span class="w"> </span>returntocorp/semgrep<span class="w"> </span>--config<span class="o">=</span>go-config2.yml<span class="w"> </span>test/golang
A<span class="w"> </span>new<span class="w"> </span>version<span class="w"> </span>of<span class="w"> </span>Semgrep<span class="w"> </span>is<span class="w"> </span>available.<span class="w"> </span>Please<span class="w"> </span>see<span class="w"> </span>https://github.com/returntocorp/semgrep#upgrading<span class="w"> </span><span class="k">for</span><span class="w"> </span>more<span class="w"> </span>information.
running<span class="w"> </span><span class="m">1</span><span class="w"> </span>rules...
test/golang/loopy.go
severity:warning<span class="w"> </span>rule:fail-on-3-loop:<span class="w"> </span>Semgrep<span class="w"> </span>found<span class="w"> </span>a<span class="w"> </span>match

<span class="m">7</span>:for<span class="w"> </span>i<span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">;</span><span class="w"> </span>i<span class="w"> </span>&lt;<span class="w"> </span><span class="m">10</span><span class="p">;</span><span class="w"> </span>i++<span class="w"> </span><span class="o">{</span>
<span class="m">8</span>:<span class="w">              </span>log.Print<span class="o">(</span>i<span class="o">)</span>
<span class="m">9</span>:
<span class="m">10</span>:<span class="w">             </span><span class="k">for</span><span class="w"> </span>j<span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">;</span><span class="w"> </span>j<span class="w"> </span>&lt;<span class="w"> </span><span class="m">100</span><span class="p">;</span><span class="w"> </span>j++<span class="w"> </span><span class="o">{</span>
<span class="m">11</span>:<span class="w">                     </span>c<span class="w"> </span>:<span class="o">=</span><span class="w"> </span>i<span class="w"> </span>*<span class="w"> </span>j
<span class="m">12</span>:
<span class="m">13</span>:<span class="w">                     </span>going<span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="nb">true</span>
<span class="m">14</span>:<span class="w">                     </span>k<span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="m">15</span>:<span class="w">                     </span><span class="k">for</span><span class="w"> </span>going<span class="w"> </span><span class="o">{</span>
<span class="m">16</span>:<span class="w">                             </span><span class="k">if</span><span class="w"> </span><span class="nv">k</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>c<span class="w"> </span><span class="o">{</span>
--------<span class="w"> </span><span class="o">[</span>hid<span class="w"> </span><span class="m">10</span><span class="w"> </span>additional<span class="w"> </span>lines,<span class="w"> </span>adjust<span class="w"> </span>with<span class="w"> </span>--max-lines-per-finding<span class="o">]</span><span class="w"> </span>--------
ran<span class="w"> </span><span class="m">1</span><span class="w"> </span>rules<span class="w"> </span>on<span class="w"> </span><span class="m">2</span><span class="w"> </span>files:<span class="w"> </span><span class="m">1</span><span class="w"> </span>findings
</pre></div>
<p>That's just swell.</p>
<h3 id="limits-of-static-analysis">Limits of static analysis</h3><p>Now let's say we refactor one of the inner loops into its own
function.</p>
<div class="highlight"><pre><span></span><span class="err">$</span><span class="w"> </span><span class="nx">cat</span><span class="w"> </span><span class="nx">test</span><span class="o">/</span><span class="nx">golang</span><span class="o">/</span><span class="nx">loopy</span><span class="p">.</span><span class="k">go</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">main</span>

<span class="kn">import</span><span class="w"> </span><span class="s">&quot;log&quot;</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">inner</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">j</span>

<span class="w">  </span><span class="nx">going</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="nx">k</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="nx">going</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">break</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">k</span><span class="o">++</span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">doneFirst</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">inner</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">j</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">doneFirst</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>And run semgrep again:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>-v<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span><span class="s2">:/src&quot;</span><span class="w"> </span>returntocorp/semgrep<span class="w"> </span>--config<span class="o">=</span>go-config2.yml<span class="w"> </span>test/golang
<span class="w"> </span>A<span class="w"> </span>new<span class="w"> </span>version<span class="w"> </span>of<span class="w"> </span>Semgrep<span class="w"> </span>is<span class="w"> </span>available.<span class="w"> </span>Please<span class="w"> </span>see<span class="w"> </span>https://github.com/returntocorp/semgrep#upgrading<span class="w"> </span><span class="k">for</span><span class="w"> </span>more<span class="w"> </span>information.
<span class="w"> </span>running<span class="w"> </span><span class="m">1</span><span class="w"> </span>rules...
<span class="w"> </span>ran<span class="w"> </span><span class="m">1</span><span class="w"> </span>rules<span class="w"> </span>on<span class="w"> </span><span class="m">2</span><span class="w"> </span>files:<span class="w"> </span><span class="m">0</span><span class="w"> </span>findings
</pre></div>
<p>Well great. The 3-nested loop still exists but we can't find it
anymore because it's not syntactically obvious anymore.</p>
<p>At this point we'd need to start getting into linting based on runtime
analysis. If you know of a tool that does this and lets you write
rules like semgrep for it, please tell me!</p>
<h3 id="in-summary">In summary</h3><p>In the end though, it's still very useful to be able to learn a single
language for writing syntax rules at a high level to enforce behavior
in code. Furthermore, a generic syntax matcher helps you write easily
write rules for things that don't already have linters like YAML
or JSON configuration or Vagrantfiles.</p>
<p>It can be annoying to work around some missing docs in semgrep but
overall it's a great tool for the kit.</p>
<p><blockquote class="twitter-tweet"><p lang="en" dir="ltr"><a href="https://twitter.com/hashtag/semgrep?src=hash&amp;ref_src=twsrc%5Etfw">#semgrep</a> is a really neat tool for syntactic analysis. Here are a few simple examples (catch print statements, triple nested loops, etc.) using Docker. Includes some necessary info the docs don&#39;t get into<a href="https://t.co/UDHEH5JmOa">https://t.co/UDHEH5JmOa</a></p>&mdash; Phil Eaton (@phil_eaton) <a href="https://twitter.com/phil_eaton/status/1340785372364738562?ref_src=twsrc%5Etfw">December 20, 2020</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<style>.feedback{display:initial;}</style>
	</div>
	<div class="feedback">
	  <h4>Feedback</h4>
	  <p>As always,
	      please <a href="mailto:phil@eatonphil.com">email</a>
	      or <a href="https://twitter.com/eatonphil">tweet me</a>
	      with questions, corrections, or ideas!</p>

	</div>
      </div>
    </div>
    <footer>
      <div class="container">
	<div>
	  <div id="subscribe">
	    <iframe frameBorder="0" src="https://cdn.forms-content-1.sg-form.com/e8ed4c3b-dd46-11f0-b6e6-ce075f2c5f80"/>

	  </div>
	</div>
      </div>
    </footer>
  </body>
</html>
