<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="canonical" href="https://notes.eatonphil.com/2023-10-19-write-file-to-disk-with-io_uring.html">
    <title>io_uring basics: Writing a file to disk | notes.eatonphil.com</title>
    <meta name="description" content="io_uring basics: Writing a file to disk" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" href="/rss.xml" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono">

    <script async onload="loadGA()" src="https://www.googletagmanager.com/gtag/js?id=UA-58109156-2"></script>
    <script>
      function loadGA() {
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());
	  gtag('config', 'UA-58109156-2');
      }
    </script>
    <script defer src="https://cdn.usefathom.com/script.js" data-site="CEPUOLOQ"></script>
  </head>
  <body>
    <header>
      <div class="lfw">
	<div class="container">
	  <div class="row">
	    <a href="https://eatonphil.com/2025-holiday-fundraiser.html">2025 Holiday Fundraiser</a>
	  </div>
	</div>
      </div>
      <div class="container">
        <div>
          <div class="row">
	    <div>
	      <a href="https://eatonphil.com" class="sm-link">
		Home
              </a>
	      <a href="/" class="sm-link">
		Blog
              </a>
	      <a href="/rss.xml" class="sm-link">
		RSS
              </a>
	    </div>

	    <div class="subscribe">
	      <!-- <a href="https://eatonphil.com/hire-me.html">Hire me</a> -->
	      <!--
		  Hardcode link to home page because some pages don't
		  have a subscribe box. Some pages hide the subscribe.
		-->
	      <a href="https://eatonphil.com/subscribe.html">
		Subscribe
	      </a>
            </div>
	  </div>
	  <hr />
	  <div class="">
            <h2>October 19, 2023</h2>
            <h1>io_uring basics: Writing a file to disk</h1>
	    
            <div class="row" style="padding-bottom: 5px">
              <div class="tags"><a href="/tags/go.html" class="tag">go</a><a href="/tags/zig.html" class="tag">zig</a><a href="/tags/io_uring.html" class="tag">io_uring</a></div>
            </div>
	  </div>
	</div>
      </div>
    </header>
    <div class="container">
      <div class="col-6">
	<div class="post">
          <p>King and I <a href="https://tigerbeetle.com/blog/a-friendly-abstraction-over-iouring-and-kqueue/">wrote a blog
post</a>
about building an event-driven cross-platform IO library that used
io_uring on Linux. We sketched out how it works at a high level but I
hadn't yet internalized how you actually code with io_uring. So I
strapped myself down this week and wrote <a href="https://github.com/eatonphil/io-playground">some
benchmarks</a> to build my
intuition about io_uring and other IO models.</p>
<p>I started with implementations in Go and ported them to Zig to make
sure I had done the Go versions decently. And I got some help from
King and other internetters to find some inefficiencies in my code.</p>
<p>This post will walk through my process, getting increasingly efficient
(and a little increasingly complex) ways to write an entire file to
disk with io_uring, from Go and Zig.</p>
<p>Notably, we're not going to <code>fsync()</code> and we're not going to use
<code>O_DIRECT</code>. So we won't be testing the entire IO pipeline from
userland to disk hardware but just how fast IO gets to the kernel. The
focus of this post is more on IO methods and using io_uring, not
absolute numbers.</p>
<p>All code for this post is <a href="https://github.com/eatonphil/io_uring-basics-writing-file">available on
GitHub</a>.</p>
<p class="note">
  This code is going to indirectly show some differences in timing
  between Go and Zig. I could care less about benchmarketing. And I
  hope something about Zig vs Go is not what you take away from this
  post either.
  <br />
  <br />
  The goal is to build an intuition and be generally
  correct. Observing the same relative behavior between
  implementations across two languages helps me gain confidence what
  I'm doing is correct.
</p><h3 id="io_uring">io_uring</h3><p>With normal blocking syscalls you just call <code>read()</code> or <code>write()</code> and
wait for the results. io_uring is one of Linux's more powerful
<em>asynchronous</em> IO offerings. Unlike epoll, you can use io_uring with
both files and network connections. And unlike epoll you can even have
the syscall run in the kernel.</p>
<p>To interact with io_uring, you register a submission queue for syscalls
and their arguments. And you register a completion queue for syscall
results.</p>
<p>You can batch many syscalls in one single call to io_uring,
effectively turning up to N (4096 at most) syscalls into just one
syscall. The kernel still does all the work of the N syscalls but you
avoid some overhead.</p>
<p>As you check the completion queue and handle completed submissions,
the submission queue is also freed all or somewhat, and you can now
add more submissions.</p>
<p>For a more complete understanding, check out the kernel document
<a href="https://kernel.dk/io_uring.pdf">Efficient IO with io_uring</a>.</p>
<h3 id="io_uring-vs-liburing">io_uring vs liburing</h3><p>io_uring is a complex, low-level interface. Shuveb Hussain has <a href="https://unixism.net/2020/04/io-uring-by-example-part-1-introduction/">an
excellent
series</a>
on programming io_uring. But that was too low-level for me as I was
trying to figure out how to just get something working.</p>
<p>Instead, most people use <a href="https://github.com/axboe/liburing">liburing</a>
or a ported version of it like <a href="https://github.com/ziglang/zig/blob/master/lib/std/os/linux/io_uring.zig">the Zig standard library's
io_uring.zig</a>
or <a href="https://github.com/Iceber/iouring-go">Iceber's iouring-go</a>.</p>
<p>io_uring started clicking for me when I tried out the iouring-go
library. So we'll start there.</p>
<h3 id="boilerplate">Boilerplate</h3><p>First off, let's set up some boilerplate for the Go and Zig code.</p>
<p>In main.go add:</p>
<div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="s">&quot;bytes&quot;</span>
<span class="w">  </span><span class="s">&quot;fmt&quot;</span>
<span class="w">  </span><span class="s">&quot;os&quot;</span>
<span class="w">  </span><span class="s">&quot;time&quot;</span>
<span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">assert</span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">b</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">panic</span><span class="p">(</span><span class="s">&quot;assert&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">BUFFER_SIZE</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">4096</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">readNBytes</span><span class="p">(</span><span class="nx">fn</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">f</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

<span class="w">  </span><span class="nx">data</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">n</span><span class="p">)</span>

<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">buffer</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="nx">BUFFER_SIZE</span><span class="p">)</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">read</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">Read</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">data</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">buffer</span><span class="p">[:</span><span class="nx">read</span><span class="p">]</span><span class="o">...</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">n</span><span class="p">)</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">data</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">benchmark</span><span class="p">(</span><span class="nx">name</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="nx">fn</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">os</span><span class="p">.</span><span class="nx">File</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="p">)</span>
<span class="w">  </span><span class="nx">f</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">OpenFile</span><span class="p">(</span><span class="s">&quot;out.bin&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">O_RDWR</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">O_CREATE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">O_TRUNC</span><span class="p">,</span><span class="w"> </span><span class="mo">0755</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">t1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">()</span>

<span class="w">  </span><span class="nx">fn</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>

<span class="w">  </span><span class="nx">s</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Sub</span><span class="p">(</span><span class="nx">t1</span><span class="p">).</span><span class="nx">Seconds</span><span class="p">()</span>
<span class="w">  </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;,%f,%f\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="nb">float64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span><span class="o">/</span><span class="nx">s</span><span class="p">)</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">Close</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">assert</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">readNBytes</span><span class="p">(</span><span class="s">&quot;out.bin&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">data</span><span class="p">)),</span><span class="w"> </span><span class="nx">data</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
<p>And in main.zig add:</p>
<div class="highlight"><pre><span></span><span class="kr">const</span><span class="w"> </span><span class="n">std</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">@import</span><span class="p">(</span><span class="s">&quot;std&quot;</span><span class="p">);</span>

<span class="kr">const</span><span class="w"> </span><span class="n">OUT_FILE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;out.bin&quot;</span><span class="p">;</span>
<span class="kr">const</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="o">:</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4096</span><span class="p">;</span>

<span class="k">fn</span><span class="w"> </span><span class="n">readNBytes</span><span class="p">(</span>
<span class="w">  </span><span class="n">allocator</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="kr">const</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">Allocator</span><span class="p">,</span>
<span class="w">  </span><span class="n">filename</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">  </span><span class="n">n</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="o">!</span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">const</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">fs</span><span class="p">.</span><span class="n">cwd</span><span class="p">().</span><span class="n">openFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="p">.{});</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="n">file</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>

<span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">allocator</span><span class="p">.</span><span class="n">alloc</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
<span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">allocator</span><span class="p">.</span><span class="n">alloc</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="p">);</span>

<span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">written</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">nwritten</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">file</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="w">    </span><span class="nb">@memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">written</span><span class="p">..],</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="n">nwritten</span><span class="p">]);</span>
<span class="w">    </span><span class="n">written</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">nwritten</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">assert</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">const</span><span class="w"> </span><span class="n">Benchmark</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">t</span><span class="o">:</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">Timer</span><span class="p">,</span>
<span class="w">  </span><span class="n">file</span><span class="o">:</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">fs</span><span class="p">.</span><span class="n">File</span><span class="p">,</span>
<span class="w">  </span><span class="n">data</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">  </span><span class="n">allocator</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="kr">const</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">Allocator</span><span class="p">,</span>

<span class="w">  </span><span class="k">fn</span><span class="w"> </span><span class="n">init</span><span class="p">(</span>
<span class="w">    </span><span class="n">allocator</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="kr">const</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">Allocator</span><span class="p">,</span>
<span class="w">    </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="n">data</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="o">!</span><span class="n">Benchmark</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">getStdOut</span><span class="p">().</span><span class="n">writer</span><span class="p">().</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;{s}&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span><span class="n">name</span><span class="p">});</span>

<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">fs</span><span class="p">.</span><span class="n">cwd</span><span class="p">().</span><span class="n">createFile</span><span class="p">(</span><span class="n">OUT_FILE</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span>
<span class="w">      </span><span class="p">.</span><span class="n">truncate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Benchmark</span><span class="p">{</span>
<span class="w">      </span><span class="p">.</span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">Timer</span><span class="p">.</span><span class="n">start</span><span class="p">(),</span>
<span class="w">      </span><span class="p">.</span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file</span><span class="p">,</span>
<span class="w">      </span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">,</span>
<span class="w">      </span><span class="p">.</span><span class="n">allocator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allocator</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">fn</span><span class="w"> </span><span class="n">stop</span><span class="p">(</span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">Benchmark</span><span class="p">)</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">@as</span><span class="p">(</span><span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="nb">@floatFromInt</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">t</span><span class="p">.</span><span class="n">read</span><span class="p">()))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">ns_per_s</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">getStdOut</span><span class="p">().</span><span class="n">writer</span><span class="p">().</span><span class="n">print</span><span class="p">(</span>
<span class="w">      </span><span class="s">&quot;,{d},{d}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="p">.{</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="nb">@as</span><span class="p">(</span><span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="nb">@floatFromInt</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">len</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="k">unreachable</span><span class="p">;</span>

<span class="w">    </span><span class="n">b</span><span class="p">.</span><span class="n">file</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>

<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readNBytes</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">allocator</span><span class="p">,</span><span class="w"> </span><span class="n">OUT_FILE</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="k">unreachable</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">assert</span><span class="p">(</span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">eql</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">data</span><span class="p">));</span>
<span class="w">    </span><span class="n">b</span><span class="p">.</span><span class="n">allocator</span><span class="p">.</span><span class="n">free</span><span class="p">(</span><span class="n">in</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</pre></div>
<h3 id="keep-it-simple:-write()">Keep it simple: write()</h3><p>Now let's add the naive version of writing bytes to disk: calling
<code>write()</code> repeatedly until all data has been written to disk.</p>
<p>In <code>main.go</code>:</p>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">size</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">104857600</span><span class="w"> </span><span class="c1">// 100MiB</span>
<span class="w">  </span><span class="nx">data</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">readNBytes</span><span class="p">(</span><span class="s">&quot;/dev/random&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">size</span><span class="p">)</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">RUNS</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">10</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">RUNS</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">benchmark</span><span class="p">(</span><span class="s">&quot;blocking&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="o">*</span><span class="nx">os</span><span class="p">.</span><span class="nx">File</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">BUFFER_SIZE</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">size</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">min</span><span class="p">(</span><span class="nx">BUFFER_SIZE</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="o">-</span><span class="nx">i</span><span class="p">)</span>
<span class="w">        </span><span class="nx">n</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">i</span><span class="o">+</span><span class="nx">size</span><span class="p">])</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">assert</span><span class="p">(</span><span class="nx">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">BUFFER_SIZE</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>And in <code>main.zig</code>:</p>
<div class="highlight"><pre><span></span><span class="kr">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="o">!</span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">allocator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">std</span><span class="p">.</span><span class="n">heap</span><span class="p">.</span><span class="n">page_allocator</span><span class="p">;</span>

<span class="w">  </span><span class="kr">const</span><span class="w"> </span><span class="n">SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">104857600</span><span class="p">;</span><span class="w"> </span><span class="c1">// 100MiB</span>
<span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">readNBytes</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/dev/random&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">SIZE</span><span class="p">);</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="n">allocator</span><span class="p">.</span><span class="n">free</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

<span class="w">  </span><span class="kr">const</span><span class="w"> </span><span class="n">RUNS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">run</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">run</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">RUNS</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">run</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="kr">var</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">Benchmark</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;blocking&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
<span class="w">      </span><span class="k">defer</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>

<span class="w">      </span><span class="kr">var</span><span class="w"> </span><span class="n">i</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">const</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">@min</span><span class="p">(</span><span class="n">BUFFER_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="w">        </span><span class="kr">const</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="p">..</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="p">]);</span>
<span class="w">        </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">assert</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Let's build and run these programs and store the results to CSV we
can analyze with DuckDB.</p>
<p>Go first:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>go<span class="w"> </span>build<span class="w"> </span>main.go<span class="w"> </span>-o<span class="w"> </span>gomain
$<span class="w"> </span>./gomain<span class="w"> </span>&gt;<span class="w"> </span>go.csv
$<span class="w"> </span>duckdb<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;select column0 as method, avg(cast(column1 as double)) || &#39;s&#39; avg_time, format_bytes(avg(column2::double)::bigint) || &#39;/s&#39; as avg_throughput from &#39;go.csv&#39; group by column0 order by avg(cast(column1 as double)) asc&quot;</span>
</pre></div>
<table>
<thead><tr>
<th>method</th>
<th>avg_time</th>
<th>avg_throughput</th>
</tr>
</thead>
<tbody>
<tr>
<td>blocking</td>
<td>0.07251540000000001s</td>
<td>1.4GB/s</td>
</tr>
</tbody>
</table>
<p>And Zig:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>zig<span class="w"> </span>build-exe<span class="w"> </span>main.zig
$<span class="w"> </span>./main<span class="w"> </span>&gt;<span class="w"> </span>zig.csv
$<span class="w"> </span>duckdb<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;select column0 as method, avg(cast(column1 as double)) || &#39;s&#39; avg_time, format_bytes(avg(column2::double)::bigint) || &#39;/s&#39; as avg_throughput from &#39;zig.csv&#39; group by column0 order by avg(cast(column1 as double)) asc&quot;</span>
</pre></div>
<table>
<thead><tr>
<th>method</th>
<th>avg_time</th>
<th>avg_throughput</th>
</tr>
</thead>
<tbody>
<tr>
<td>blocking</td>
<td>0.0656907669s</td>
<td>1.5GB/s</td>
</tr>
</tbody>
</table>
<p>Alright, we've got a baseline now and both language implementations
are in the same ballpark.</p>
<p>Let's add a simple io_uring version!</p>
<h3 id="io_uring,-1-entry,-go">io_uring, 1 entry, Go</h3><p>The <a href="https://github.com/Iceber/iouring-go#quickstart">iouring-go</a>
library has really excellent documentation for getting started.</p>
<p>To keep it simple, we'll use io_uring with only 1 entry. Add the
following to <code>func main()</code> after the existing <code>benchmark()</code> call in
<code>main.go</code>:</p>
<div class="highlight"><pre><span></span><span class="n">benchmark</span><span class="p">(</span><span class="s">&quot;io_uring&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">os</span><span class="p">.</span><span class="n">File</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">iour</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">iouring</span><span class="p">.</span><span class="n">New</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">defer</span><span class="w"> </span><span class="n">iour</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">data</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nl">size</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">BUFFER_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">-</span><span class="n">i</span><span class="p">)</span>
<span class="w">    </span><span class="nl">prepRequest</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">iouring</span><span class="p">.</span><span class="n">Pwrite</span><span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">Fd</span><span class="p">()),</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">i</span><span class="o">+</span><span class="n">size</span><span class="p">],</span><span class="w"> </span><span class="n">uint64</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
<span class="w">    </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">iour</span><span class="p">.</span><span class="n">SubmitRequest</span><span class="p">(</span><span class="n">prepRequest</span><span class="p">,</span><span class="w"> </span><span class="nb">nil</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="o">&lt;-</span><span class="n">res</span><span class="p">.</span><span class="n">Done</span><span class="p">()</span>
<span class="w">    </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">res</span><span class="p">.</span><span class="n">ReturnInt</span><span class="p">()</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">i</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">})</span>
</pre></div>
<p>Note that <code>benchmark</code> takes care of <code>f.Seek(0)</code> before each run. And
it also validates that the file contents are equivalent to the input
<code>data</code>. So it validates the benchmark for correctness.</p>
<p>Alright, let's run this new Go implementation with io_uring!</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>go<span class="w"> </span>mod<span class="w"> </span>init<span class="w"> </span>gomain
$<span class="w"> </span>go<span class="w"> </span>mod<span class="w"> </span>tidy
$<span class="w"> </span>go<span class="w"> </span>build<span class="w"> </span>main.go<span class="w"> </span>-o<span class="w"> </span>gomain
$<span class="w"> </span>./gomain<span class="w"> </span>&gt;<span class="w"> </span>go.csv
$<span class="w"> </span>duckdb<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;select column0 as method, avg(cast(column1 as double)) || &#39;s&#39; avg_time, format_bytes(avg(column2::double)::bigint) || &#39;/s&#39; as avg_throughput from &#39;go.csv&#39; group by column0 order by avg(cast(column1 as double)) asc&quot;</span>
</pre></div>
<table>
<thead><tr>
<th>method</th>
<th>avg_time</th>
<th>avg_throughput</th>
</tr>
</thead>
<tbody>
<tr>
<td>blocking</td>
<td>0.0811486s</td>
<td>1.3GB/s</td>
</tr>
<tr>
<td>io_uring</td>
<td>0.5083049999999999s</td>
<td>213.2MB/s</td>
</tr>
</tbody>
</table>
<p>Well that looks terrible.</p>
<p>Let's port it to Zig to see if we notice the same behavior there.</p>
<h3 id="io_uring,-1-entry,-zig">io_uring, 1 entry, Zig</h3><p>There isn't an official Zig tutorial on io_uring I'm aware of. But
<a href="https://github.com/ziglang/zig/blob/master/lib/std/os/linux/io_uring.zig">io_uring.zig</a>
is easy enough to browse through. And there are tests in that file
that also show how to use it.</p>
<p>And now that we've explored a bit in Go the basic gist should be
similar:</p>
<ul>
<li>initialize io_uring</li>
<li>submit an entry</li>
<li>wait for it to finish</li>
<li>move on</li>
</ul>
<p>Add the following to <code>fn main()</code> after the existing benchmark block in
<code>main.zig</code>:</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">Benchmark</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;iouring&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>

<span class="w">  </span><span class="kr">const</span><span class="w"> </span><span class="n">entries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">ring</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">os</span><span class="p">.</span><span class="n">linux</span><span class="p">.</span><span class="n">IO_Uring</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="n">ring</span><span class="p">.</span><span class="n">deinit</span><span class="p">();</span>

<span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">i</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">@min</span><span class="p">(</span><span class="n">BUFFER_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">ring</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">file</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="p">..</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="p">],</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>

<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">submitted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">ring</span><span class="p">.</span><span class="n">submit_and_wait</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">assert</span><span class="p">(</span><span class="n">submitted</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">cqe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">ring</span><span class="p">.</span><span class="n">copy_cqe</span><span class="p">();</span>
<span class="w">    </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">assert</span><span class="p">(</span><span class="n">cqe</span><span class="p">.</span><span class="n">err</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">.</span><span class="n">SUCCESS</span><span class="p">);</span>
<span class="w">    </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">assert</span><span class="p">(</span><span class="n">cqe</span><span class="p">.</span><span class="n">res</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">@as</span><span class="p">(</span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="nb">@intCast</span><span class="p">(</span><span class="n">cqe</span><span class="p">.</span><span class="n">res</span><span class="p">));</span>
<span class="w">    </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">assert</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Now build and run:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>zig<span class="w"> </span>build-exe<span class="w"> </span>main.zig
$<span class="w"> </span>./main<span class="w"> </span>&gt;<span class="w"> </span>zig.csv
$<span class="w"> </span>duckdb<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;select column0 as method, avg(cast(column1 as double)) || &#39;s&#39; avg_time, format_bytes(avg(column2::double)::bigint) || &#39;/s&#39; as avg_throughput from &#39;zig.csv&#39; group by column0 order by avg(cast(column1 as double)) asc&quot;</span>
</pre></div>
<table>
<thead><tr>
<th>method</th>
<th>avg_time</th>
<th>avg_throughput</th>
</tr>
</thead>
<tbody>
<tr>
<td>blocking</td>
<td>0.06650093630000001s</td>
<td>1.5GB/s</td>
</tr>
<tr>
<td>io_uring</td>
<td>0.17542890139999998s</td>
<td>597.7MB/s</td>
</tr>
</tbody>
</table>
<p>Well it's similarly pretty bad. But our implementation ignores one
major aspect of io_uring: batching requests.</p>
<p>Let's do some refactoring!</p>
<h3 id="io_uring,-n-entries,-go">io_uring, N entries, Go</h3><p>To support submitting N entries, we're going to have an inner loop
running up to N that fills up N entries to io_uring.</p>
<p>Then we'll wait for the N submissions to complete and check their
results.</p>
<p>We'll keep going until we write the entire file.</p>
<p>All of this can stay inside the loop in <code>main</code>, I'm just dropping
preceding whitespace for nicer formatting here:</p>
<div class="highlight"><pre><span></span><span class="nx">benchmarkIOUringNEntries</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">nEntries</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">benchmark</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;io_uring_%d_entries&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">nEntries</span><span class="p">),</span><span class="w"> </span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">File</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">iour</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">iouring</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nb">uint</span><span class="p">(</span><span class="nx">nEntries</span><span class="p">))</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">iour</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

<span class="w">    </span><span class="nx">requests</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">([]</span><span class="nx">iouring</span><span class="p">.</span><span class="nx">PrepRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">nEntries</span><span class="p">)</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">BUFFER_SIZE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">nEntries</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">submittedEntries</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">nEntries</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">base</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">BUFFER_SIZE</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">base</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">break</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nx">submittedEntries</span><span class="o">++</span>
<span class="w">        </span><span class="nx">size</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">min</span><span class="p">(</span><span class="nx">BUFFER_SIZE</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="o">-</span><span class="nx">i</span><span class="p">)</span>
<span class="w">        </span><span class="nx">requests</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">iouring</span><span class="p">.</span><span class="nx">Pwrite</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">Fd</span><span class="p">()),</span><span class="w"> </span><span class="nx">data</span><span class="p">[</span><span class="nx">base</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">base</span><span class="o">+</span><span class="nx">size</span><span class="p">],</span><span class="w"> </span><span class="nb">uint64</span><span class="p">(</span><span class="nx">base</span><span class="p">))</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="nx">submittedEntries</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">break</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">iour</span><span class="p">.</span><span class="nx">SubmitRequests</span><span class="p">(</span><span class="nx">requests</span><span class="p">[:</span><span class="nx">submittedEntries</span><span class="p">],</span><span class="w"> </span><span class="kc">nil</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="o">&lt;-</span><span class="nx">res</span><span class="p">.</span><span class="nx">Done</span><span class="p">()</span>

<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">ErrResults</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">ReturnInt</span><span class="p">()</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>
<span class="nx">benchmarkIOUringNEntries</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nx">benchmarkIOUringNEntries</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
</pre></div>
<p>There are some specific things in there to notice.</p>
<p>First, toward the end of the file we may not have <code>N</code> entries to
submit. We may have <code>1</code> or even <code>0</code>.</p>
<p>If we have <code>0</code> to submit, we need to not even submit anything
otherwise the Go library hangs. Similarly, if we don't slice
<code>requests</code> to <code>requests[:submittedEntries]</code>, the Go library will
segfault if <code>submittedEntries &lt; N</code>.</p>
<p>Other than that, let's build and run this!</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>go<span class="w"> </span>build<span class="w"> </span>-o<span class="w"> </span>gomain
$<span class="w"> </span>./gomain<span class="w"> </span>&gt;<span class="w"> </span>go.csv
$<span class="w"> </span>duckdb<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;select column0 as method, avg(cast(column1 as double)) || &#39;s&#39; avg_time, format_bytes(avg(column2::double)::bigint) || &#39;/s&#39; as avg_throughput from &#39;go.csv&#39; group by column0 order by avg(cast(column1 as double)) asc&quot;</span>
</pre></div>
<table>
<thead><tr>
<th>method</th>
<th>avg_time</th>
<th>avg_throughput</th>
</tr>
</thead>
<tbody>
<tr>
<td>blocking</td>
<td>0.0740368s</td>
<td>1.4GB/s</td>
</tr>
<tr>
<td>io_uring_128_entries</td>
<td>0.127519s</td>
<td>836.6MB/s</td>
</tr>
<tr>
<td>io_uring_1_entries</td>
<td>0.46831579999999995s</td>
<td>226.9MB/s</td>
</tr>
</tbody>
</table>
<p>Now we're getting somewhere! Still half the throughput but a 4x
improvement from using only a single entry.</p>
<p>Let's port the N entry code to Zig.</p>
<h3 id="io_uring,-n-entries,-zig">io_uring, N entries, Zig</h3><p>Unlike Go we can't do closures, so we'll have to make
<code>benchmarkIOUringNEntries</code> a top-level function and keep the calls to
it in the loop in <code>main</code>:</p>
<div class="highlight"><pre><span></span><span class="kr">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="o">!</span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">allocator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">std</span><span class="p">.</span><span class="n">heap</span><span class="p">.</span><span class="n">page_allocator</span><span class="p">;</span>

<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">104857600</span><span class="p">;</span><span class="w"> </span><span class="c1">// 100MiB</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">readNBytes</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/dev/random&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">SIZE</span><span class="p">);</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="n">allocator</span><span class="p">.</span><span class="n">free</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">RUNS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">run</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">run</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">RUNS</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">run</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="kr">var</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">Benchmark</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;blocking&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
<span class="w">            </span><span class="k">defer</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>

<span class="w">            </span><span class="kr">var</span><span class="w"> </span><span class="n">i</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kr">const</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">@min</span><span class="p">(</span><span class="n">BUFFER_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="w">                </span><span class="kr">const</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="p">..</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="p">]);</span>
<span class="w">                </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">assert</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="n">benchmarkIOUringNEntries</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="n">benchmarkIOUringNEntries</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>And for the implementation itself, the only two big differences from
the first version are that we'll bulk-read completion events (<code>cqe</code>s)
and that we'll create and wait for many submissions at once.</p>
<div class="highlight"><pre><span></span><span class="k">fn</span><span class="w"> </span><span class="n">benchmarkIOUringNEntries</span><span class="p">(</span>
<span class="w">  </span><span class="n">allocator</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="kr">const</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">Allocator</span><span class="p">,</span>
<span class="w">  </span><span class="n">data</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">  </span><span class="n">nEntries</span><span class="o">:</span><span class="w"> </span><span class="n">u13</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="o">!</span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">const</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">allocPrint</span><span class="p">(</span><span class="n">allocator</span><span class="p">.</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;iouring_{}_entries&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span><span class="n">nEntries</span><span class="p">});</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="n">allocator</span><span class="p">.</span><span class="n">free</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>

<span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">Benchmark</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>

<span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">ring</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">os</span><span class="p">.</span><span class="n">linux</span><span class="p">.</span><span class="n">IO_Uring</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">nEntries</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="n">ring</span><span class="p">.</span><span class="n">deinit</span><span class="p">();</span>

<span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">cqes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">allocator</span><span class="p">.</span><span class="n">alloc</span><span class="p">(</span><span class="n">std</span><span class="p">.</span><span class="n">os</span><span class="p">.</span><span class="n">linux</span><span class="p">.</span><span class="n">io_uring_cqe</span><span class="p">,</span><span class="w"> </span><span class="n">nEntries</span><span class="p">);</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="n">allocator</span><span class="p">.</span><span class="n">free</span><span class="p">(</span><span class="n">cqes</span><span class="p">);</span>

<span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">i</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">nEntries</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">submittedEntries</span><span class="o">:</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">j</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nEntries</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kr">const</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">base</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="n">submittedEntries</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">      </span><span class="kr">const</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">@min</span><span class="p">(</span><span class="n">BUFFER_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">base</span><span class="p">);</span>
<span class="w">      </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">ring</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">file</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">base</span><span class="w"> </span><span class="p">..</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="p">],</span><span class="w"> </span><span class="n">base</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">submitted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">ring</span><span class="p">.</span><span class="n">submit_and_wait</span><span class="p">(</span><span class="n">submittedEntries</span><span class="p">);</span>
<span class="w">    </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">assert</span><span class="p">(</span><span class="n">submitted</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">submittedEntries</span><span class="p">);</span>

<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">waited</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">ring</span><span class="p">.</span><span class="n">copy_cqes</span><span class="p">(</span><span class="n">cqes</span><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="n">submitted</span><span class="p">],</span><span class="w"> </span><span class="n">submitted</span><span class="p">);</span>
<span class="w">    </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">assert</span><span class="p">(</span><span class="n">waited</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">submitted</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">cqes</span><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="n">submitted</span><span class="p">])</span><span class="w"> </span><span class="o">|*</span><span class="n">cqe</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">assert</span><span class="p">(</span><span class="n">cqe</span><span class="p">.</span><span class="n">err</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">.</span><span class="n">SUCCESS</span><span class="p">);</span>
<span class="w">      </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">assert</span><span class="p">(</span><span class="n">cqe</span><span class="p">.</span><span class="n">res</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">      </span><span class="kr">const</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">@as</span><span class="p">(</span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="nb">@intCast</span><span class="p">(</span><span class="n">cqe</span><span class="p">.</span><span class="n">res</span><span class="p">));</span>
<span class="w">      </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">assert</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Let's build and run:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>zig<span class="w"> </span>build-exe<span class="w"> </span>main.zig
$<span class="w"> </span>./main<span class="w"> </span>&gt;<span class="w"> </span>zig.csv
$<span class="w"> </span>duckdb<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;select column0 as method, avg(cast(column1 as double)) || &#39;s&#39; avg_time, format_bytes(avg(column2::double)::bigint) || &#39;/s&#39; as avg_throughput from &#39;zig.csv&#39; group by column0 order by avg(cast(column1 as double)) asc&quot;</span>
</pre></div>
<table>
<thead><tr>
<th>method</th>
<th>avg_time</th>
<th>avg_throughput</th>
</tr>
</thead>
<tbody>
<tr>
<td>blocking</td>
<td>0.0674331114s</td>
<td>1.5GB/s</td>
</tr>
<tr>
<td>iouring_128_entries</td>
<td>0.06773539590000001s</td>
<td>1.5GB/s</td>
</tr>
<tr>
<td>iouring_1_entries</td>
<td>0.1855542556s</td>
<td>569.9MB/s</td>
</tr>
</tbody>
</table>
<p>Huh, that's surprising! We caught up to blocking writes with io_uring
in Zig, but not in Go, even though we made good progress in Go.</p>
<h3 id="ring-buffers">Ring buffers</h3><p>But we can do a bit better. We're doing batching, but the API is
called "io_uring" not "io_batch". We're not even making use of the
ring buffer behavior io_uring gives us!</p>
<p>We are waiting for all submitted results complete. But there's no
reason to do that. Instead we should submit as much as we can. But we
should not block waiting for completions. We should handle completions
when they happen. And we should retry submissions until we're done
reading. Retrying if there's no space for the moment.</p>
<p>Unfortunately the Go library doesn't seem to expose this ring behavior
of io_uring. Or I've missed it.</p>
<p>But we can do it in Zig. Let's go.</p>
<h3 id="io_uring,-ring-buffer,-zig">io_uring, ring buffer, Zig</h3><p>We need to change the way we track which offsets we need to submit so
far. We also need to keep the loop going until we are sure we have
<em>written</em> all data. And we need to stop blocking on the number we
submitted; never blocking at all.</p>
<div class="highlight"><pre><span></span><span class="k">fn</span><span class="w"> </span><span class="n">benchmarkIOUringNEntries</span><span class="p">(</span>
<span class="w">  </span><span class="n">allocator</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="kr">const</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">Allocator</span><span class="p">,</span>
<span class="w">  </span><span class="n">data</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">  </span><span class="n">nEntries</span><span class="o">:</span><span class="w"> </span><span class="n">u13</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="o">!</span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">const</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">allocPrint</span><span class="p">(</span><span class="n">allocator</span><span class="p">.</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;iouring_{}_entries&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span><span class="n">nEntries</span><span class="p">});</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="n">allocator</span><span class="p">.</span><span class="n">free</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>

<span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">Benchmark</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>

<span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">ring</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">os</span><span class="p">.</span><span class="n">linux</span><span class="p">.</span><span class="n">IO_Uring</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">nEntries</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="n">ring</span><span class="p">.</span><span class="n">deinit</span><span class="p">();</span>

<span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">cqes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">allocator</span><span class="p">.</span><span class="n">alloc</span><span class="p">(</span><span class="n">std</span><span class="p">.</span><span class="n">os</span><span class="p">.</span><span class="n">linux</span><span class="p">.</span><span class="n">io_uring_cqe</span><span class="p">,</span><span class="w"> </span><span class="n">nEntries</span><span class="p">);</span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="n">allocator</span><span class="p">.</span><span class="n">free</span><span class="p">(</span><span class="n">cqes</span><span class="p">);</span>

<span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">written</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">i</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">written</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">submittedEntries</span><span class="o">:</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">j</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kr">const</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">base</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="kr">const</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">@min</span><span class="p">(</span><span class="n">BUFFER_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">base</span><span class="p">);</span>
<span class="w">      </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ring</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">file</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">base</span><span class="w"> </span><span class="p">..</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="p">],</span><span class="w"> </span><span class="n">base</span><span class="p">)</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="o">|</span><span class="n">e</span><span class="o">|</span><span class="w"> </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">error</span><span class="p">.</span><span class="n">SubmissionQueueFull</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">break</span><span class="p">,</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">unreachable</span><span class="p">,</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">      </span><span class="n">submittedEntries</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">      </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">ring</span><span class="p">.</span><span class="n">submit_and_wait</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">cqesDone</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">ring</span><span class="p">.</span><span class="n">copy_cqes</span><span class="p">(</span><span class="n">cqes</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">cqes</span><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="n">cqesDone</span><span class="p">])</span><span class="w"> </span><span class="o">|*</span><span class="n">cqe</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">assert</span><span class="p">(</span><span class="n">cqe</span><span class="p">.</span><span class="n">err</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">.</span><span class="n">SUCCESS</span><span class="p">);</span>
<span class="w">      </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">assert</span><span class="p">(</span><span class="n">cqe</span><span class="p">.</span><span class="n">res</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">      </span><span class="kr">const</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">@as</span><span class="p">(</span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="nb">@intCast</span><span class="p">(</span><span class="n">cqe</span><span class="p">.</span><span class="n">res</span><span class="p">));</span>
<span class="w">      </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">assert</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="p">);</span>
<span class="w">      </span><span class="n">written</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>The code got a bit simpler! Granted, we're omitting error handling.</p>
<p>Build and run:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>zig<span class="w"> </span>build-exe<span class="w"> </span>main.zig
$<span class="w"> </span>./main<span class="w"> </span>&gt;<span class="w"> </span>zig.csv
$<span class="w"> </span>duckdb<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;select column0 as method, avg(cast(column1 as double)) || &#39;s&#39; avg_time, format_bytes(avg(column2::double)::bigint) || &#39;/s&#39; as avg_throughput from &#39;zig.csv&#39; group by column0 order by avg(cast(column1 as double)) asc&quot;</span>
</pre></div>
<table>
<thead><tr>
<th>method</th>
<th>avg_time</th>
<th>avg_throughput</th>
</tr>
</thead>
<tbody>
<tr>
<td>iouring_128_entries</td>
<td>0.06035423609999999s</td>
<td>1.7GB/s</td>
</tr>
<tr>
<td>iouring_1_entries</td>
<td>0.0610197624s</td>
<td>1.7GB/s</td>
</tr>
<tr>
<td>blocking</td>
<td>0.0671628515s</td>
<td>1.5GB/s</td>
</tr>
</tbody>
</table>
<p>Not bad!</p>
<h3 id="crank-it-up">Crank it up</h3><p>We've been inserting 100MiB of data. Let's go up to 1GiB to see how
that affects things. Ideally the more data we write the more we
reflect realistic long-term results.</p>
<p>In <code>main.zig</code> just change <code>SIZE</code> to <code>1073741824</code>. Rebuild and run:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>zig<span class="w"> </span>build-exe<span class="w"> </span>main.zig
$<span class="w"> </span>./main<span class="w"> </span>&gt;<span class="w"> </span>zig.csv
$<span class="w"> </span>duckdb<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;select column0 as method, avg(cast(column1 as double)) || &#39;s&#39; avg_time, format_bytes(avg(column2::double)::bigint) || &#39;/s&#39; as avg_throughput from &#39;out.csv&#39; group by column0 order by avg(cast(column1 as double)) asc&quot;</span>
</pre></div>
<table>
<thead><tr>
<th>method</th>
<th>avg_time</th>
<th>avg_throughput</th>
</tr>
</thead>
<tbody>
<tr>
<td>iouring_128_entries</td>
<td>0.6063814535s</td>
<td>1.7GB/s</td>
</tr>
<tr>
<td>iouring_1_entries</td>
<td>0.6167537295000001s</td>
<td>1.7GB/s</td>
</tr>
<tr>
<td>blocking</td>
<td>0.6831747749s</td>
<td>1.5GB/s</td>
</tr>
</tbody>
</table>
<p>No real difference, perfect!</p>
<p>Let's make one more change though. Let's up the <code>BUFFER_SIZE</code> from
4KiB to 1MiB.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>zig<span class="w"> </span>build-exe<span class="w"> </span>main.zig
$<span class="w"> </span>./main<span class="w"> </span>&gt;<span class="w"> </span>zig.csv
$<span class="w"> </span>duckdb<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;select column0 as method, avg(cast(column1 as double)) || &#39;s&#39; avg_time, format_bytes(avg(column2::double)::bigint) || &#39;/s&#39; as avg_throughput from &#39;out.csv&#39; group by column0 order by avg(cast(column1 as double)) asc&quot;</span>
</pre></div>
<table>
<thead><tr>
<th>method</th>
<th>avg_time</th>
<th>avg_throughput</th>
</tr>
</thead>
<tbody>
<tr>
<td>iouring_128_entries</td>
<td>0.2756831357s</td>
<td>3.8GB/s</td>
</tr>
<tr>
<td>iouring_1_entries</td>
<td>0.27575404880000004s</td>
<td>3.8GB/s</td>
</tr>
<tr>
<td>blocking</td>
<td>0.2833337046s</td>
<td>3.7GB/s</td>
</tr>
</tbody>
</table>
<p>Hey that's an improvement!</p>
<h3 id="control">Control</h3><p>All these numbers are machine-specific obviously. So what does an
existing tool like
<a href="https://fio.readthedocs.io/en/latest/fio_doc.html">fio</a> say?
(Assuming I'm using it correctly. I await your corrections!)</p>
<p>With a 4KiB buffer size:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>fio<span class="w"> </span>--name<span class="o">=</span>fiotest<span class="w"> </span>--rw<span class="o">=</span>write<span class="w"> </span>--size<span class="o">=</span>1G<span class="w"> </span>--bs<span class="o">=</span>4k<span class="w"> </span>--group_reporting<span class="w"> </span>--ioengine<span class="o">=</span>sync
fiotest:<span class="w"> </span><span class="o">(</span><span class="nv">g</span><span class="o">=</span><span class="m">0</span><span class="o">)</span>:<span class="w"> </span><span class="nv">rw</span><span class="o">=</span>write,<span class="w"> </span><span class="nv">bs</span><span class="o">=(</span>R<span class="o">)</span><span class="w"> </span>4096B-4096B,<span class="w"> </span><span class="o">(</span>W<span class="o">)</span><span class="w"> </span>4096B-4096B,<span class="w"> </span><span class="o">(</span>T<span class="o">)</span><span class="w"> </span>4096B-4096B,<span class="w"> </span><span class="nv">ioengine</span><span class="o">=</span>sync,<span class="w"> </span><span class="nv">iodepth</span><span class="o">=</span><span class="m">1</span>
fio-3.33
Starting<span class="w"> </span><span class="m">1</span><span class="w"> </span>process
Jobs:<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">(</span><span class="nv">f</span><span class="o">=</span><span class="m">1</span><span class="o">)</span>
fiotest:<span class="w"> </span><span class="o">(</span><span class="nv">groupid</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">jobs</span><span class="o">=</span><span class="m">1</span><span class="o">)</span>:<span class="w"> </span><span class="nv">err</span><span class="o">=</span><span class="w"> </span><span class="m">0</span>:<span class="w"> </span><span class="nv">pid</span><span class="o">=</span><span class="m">2437359</span>:<span class="w"> </span>Thu<span class="w"> </span>Oct<span class="w"> </span><span class="m">19</span><span class="w"> </span><span class="m">23</span>:33:42<span class="w"> </span><span class="m">2023</span>
<span class="w">  </span>write:<span class="w"> </span><span class="nv">IOPS</span><span class="o">=</span>282k,<span class="w"> </span><span class="nv">BW</span><span class="o">=</span>1102MiB/s<span class="w"> </span><span class="o">(</span>1156MB/s<span class="o">)(</span>1024MiB/929msec<span class="o">)</span><span class="p">;</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>zone<span class="w"> </span>resets
<span class="w">    </span>clat<span class="w"> </span><span class="o">(</span>nsec<span class="o">)</span>:<span class="w"> </span><span class="nv">min</span><span class="o">=</span><span class="m">2349</span>,<span class="w"> </span><span class="nv">max</span><span class="o">=</span><span class="m">54099</span>,<span class="w"> </span><span class="nv">avg</span><span class="o">=</span><span class="m">2709</span>.48,<span class="w"> </span><span class="nv">stdev</span><span class="o">=</span><span class="m">1325</span>.83
<span class="w">     </span>lat<span class="w"> </span><span class="o">(</span>nsec<span class="o">)</span>:<span class="w"> </span><span class="nv">min</span><span class="o">=</span><span class="m">2390</span>,<span class="w"> </span><span class="nv">max</span><span class="o">=</span><span class="m">54139</span>,<span class="w"> </span><span class="nv">avg</span><span class="o">=</span><span class="m">2752</span>.89,<span class="w"> </span><span class="nv">stdev</span><span class="o">=</span><span class="m">1334</span>.62
<span class="w">    </span>clat<span class="w"> </span>percentiles<span class="w"> </span><span class="o">(</span>nsec<span class="o">)</span>:
<span class="w">     </span><span class="p">|</span><span class="w">  </span><span class="m">1</span>.00th<span class="o">=[</span><span class="w"> </span><span class="m">2416</span><span class="o">]</span>,<span class="w">  </span><span class="m">5</span>.00th<span class="o">=[</span><span class="w"> </span><span class="m">2416</span><span class="o">]</span>,<span class="w"> </span><span class="m">10</span>.00th<span class="o">=[</span><span class="w"> </span><span class="m">2416</span><span class="o">]</span>,<span class="w"> </span><span class="m">20</span>.00th<span class="o">=[</span><span class="w"> </span><span class="m">2448</span><span class="o">]</span>,
<span class="w">     </span><span class="p">|</span><span class="w"> </span><span class="m">30</span>.00th<span class="o">=[</span><span class="w"> </span><span class="m">2448</span><span class="o">]</span>,<span class="w"> </span><span class="m">40</span>.00th<span class="o">=[</span><span class="w"> </span><span class="m">2448</span><span class="o">]</span>,<span class="w"> </span><span class="m">50</span>.00th<span class="o">=[</span><span class="w"> </span><span class="m">2448</span><span class="o">]</span>,<span class="w"> </span><span class="m">60</span>.00th<span class="o">=[</span><span class="w"> </span><span class="m">2480</span><span class="o">]</span>,
<span class="w">     </span><span class="p">|</span><span class="w"> </span><span class="m">70</span>.00th<span class="o">=[</span><span class="w"> </span><span class="m">2512</span><span class="o">]</span>,<span class="w"> </span><span class="m">80</span>.00th<span class="o">=[</span><span class="w"> </span><span class="m">2544</span><span class="o">]</span>,<span class="w"> </span><span class="m">90</span>.00th<span class="o">=[</span><span class="w"> </span><span class="m">2832</span><span class="o">]</span>,<span class="w"> </span><span class="m">95</span>.00th<span class="o">=[</span><span class="w"> </span><span class="m">3504</span><span class="o">]</span>,
<span class="w">     </span><span class="p">|</span><span class="w"> </span><span class="m">99</span>.00th<span class="o">=[</span><span class="w"> </span><span class="m">5792</span><span class="o">]</span>,<span class="w"> </span><span class="m">99</span>.50th<span class="o">=[</span><span class="m">15296</span><span class="o">]</span>,<span class="w"> </span><span class="m">99</span>.90th<span class="o">=[</span><span class="m">19584</span><span class="o">]</span>,<span class="w"> </span><span class="m">99</span>.95th<span class="o">=[</span><span class="m">20096</span><span class="o">]</span>,
<span class="w">     </span><span class="p">|</span><span class="w"> </span><span class="m">99</span>.99th<span class="o">=[</span><span class="m">22656</span><span class="o">]</span>
<span class="w">   </span>bw<span class="w"> </span><span class="o">(</span><span class="w">  </span>KiB/s<span class="o">)</span>:<span class="w"> </span><span class="nv">min</span><span class="o">=</span><span class="m">940856</span>,<span class="w"> </span><span class="nv">max</span><span class="o">=</span><span class="m">940856</span>,<span class="w"> </span><span class="nv">per</span><span class="o">=</span><span class="m">83</span>.36%,<span class="w"> </span><span class="nv">avg</span><span class="o">=</span><span class="m">940856</span>.00,<span class="w"> </span><span class="nv">stdev</span><span class="o">=</span><span class="w"> </span><span class="m">0</span>.00,<span class="w"> </span><span class="nv">samples</span><span class="o">=</span><span class="m">1</span>
<span class="w">   </span>iops<span class="w">        </span>:<span class="w"> </span><span class="nv">min</span><span class="o">=</span><span class="m">235214</span>,<span class="w"> </span><span class="nv">max</span><span class="o">=</span><span class="m">235214</span>,<span class="w"> </span><span class="nv">avg</span><span class="o">=</span><span class="m">235214</span>.00,<span class="w"> </span><span class="nv">stdev</span><span class="o">=</span><span class="w"> </span><span class="m">0</span>.00,<span class="w"> </span><span class="nv">samples</span><span class="o">=</span><span class="m">1</span>
<span class="w">  </span>lat<span class="w"> </span><span class="o">(</span>usec<span class="o">)</span><span class="w">   </span>:<span class="w"> </span><span class="nv">4</span><span class="o">=</span><span class="m">97</span>.22%,<span class="w"> </span><span class="nv">10</span><span class="o">=</span><span class="m">2</span>.03%,<span class="w"> </span><span class="nv">20</span><span class="o">=</span><span class="m">0</span>.71%,<span class="w"> </span><span class="nv">50</span><span class="o">=</span><span class="m">0</span>.04%,<span class="w"> </span><span class="nv">100</span><span class="o">=</span><span class="m">0</span>.01%
<span class="w">  </span>cpu<span class="w">          </span>:<span class="w"> </span><span class="nv">usr</span><span class="o">=</span><span class="m">17</span>.35%,<span class="w"> </span><span class="nv">sys</span><span class="o">=</span><span class="m">82</span>.11%,<span class="w"> </span><span class="nv">ctx</span><span class="o">=</span><span class="m">26</span>,<span class="w"> </span><span class="nv">majf</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">minf</span><span class="o">=</span><span class="m">11</span>
<span class="w">  </span>IO<span class="w"> </span>depths<span class="w">    </span>:<span class="w"> </span><span class="nv">1</span><span class="o">=</span><span class="m">100</span>.0%,<span class="w"> </span><span class="nv">2</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span><span class="nv">4</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span><span class="nv">8</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span><span class="nv">16</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span><span class="nv">32</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span>&gt;<span class="o">=</span><span class="nv">64</span><span class="o">=</span><span class="m">0</span>.0%
<span class="w">     </span>submit<span class="w">    </span>:<span class="w"> </span><span class="nv">0</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span><span class="nv">4</span><span class="o">=</span><span class="m">100</span>.0%,<span class="w"> </span><span class="nv">8</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span><span class="nv">16</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span><span class="nv">32</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span><span class="nv">64</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span>&gt;<span class="o">=</span><span class="nv">64</span><span class="o">=</span><span class="m">0</span>.0%
<span class="w">     </span><span class="nb">complete</span><span class="w">  </span>:<span class="w"> </span><span class="nv">0</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span><span class="nv">4</span><span class="o">=</span><span class="m">100</span>.0%,<span class="w"> </span><span class="nv">8</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span><span class="nv">16</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span><span class="nv">32</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span><span class="nv">64</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span>&gt;<span class="o">=</span><span class="nv">64</span><span class="o">=</span><span class="m">0</span>.0%
<span class="w">     </span>issued<span class="w"> </span>rwts:<span class="w"> </span><span class="nv">total</span><span class="o">=</span><span class="m">0</span>,262144,0,0<span class="w"> </span><span class="nv">short</span><span class="o">=</span><span class="m">0</span>,0,0,0<span class="w"> </span><span class="nv">dropped</span><span class="o">=</span><span class="m">0</span>,0,0,0
<span class="w">     </span>latency<span class="w">   </span>:<span class="w"> </span><span class="nv">target</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">window</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">percentile</span><span class="o">=</span><span class="m">100</span>.00%,<span class="w"> </span><span class="nv">depth</span><span class="o">=</span><span class="m">1</span>

Run<span class="w"> </span>status<span class="w"> </span>group<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">(</span>all<span class="w"> </span><span class="nb">jobs</span><span class="o">)</span>:
<span class="w">  </span>WRITE:<span class="w"> </span><span class="nv">bw</span><span class="o">=</span>1102MiB/s<span class="w"> </span><span class="o">(</span>1156MB/s<span class="o">)</span>,<span class="w"> </span>1102MiB/s-1102MiB/s<span class="w"> </span><span class="o">(</span>1156MB/s-1156MB/s<span class="o">)</span>,<span class="w"> </span><span class="nv">io</span><span class="o">=</span>1024MiB<span class="w"> </span><span class="o">(</span>1074MB<span class="o">)</span>,<span class="w"> </span><span class="nv">run</span><span class="o">=</span><span class="m">929</span>-929msec
</pre></div>
<p>1.2GB/s is about in the ballpark of what we got.</p>
<p>And with a 1MiB buffer size?</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>fio<span class="w"> </span>--name<span class="o">=</span>fiotest<span class="w"> </span>--rw<span class="o">=</span>write<span class="w"> </span>--size<span class="o">=</span>1G<span class="w"> </span>--bs<span class="o">=</span>1M<span class="w"> </span>--group_reporting<span class="w"> </span>--ioengine<span class="o">=</span>sync
fiotest:<span class="w"> </span><span class="o">(</span><span class="nv">g</span><span class="o">=</span><span class="m">0</span><span class="o">)</span>:<span class="w"> </span><span class="nv">rw</span><span class="o">=</span>write,<span class="w"> </span><span class="nv">bs</span><span class="o">=(</span>R<span class="o">)</span><span class="w"> </span>1024KiB-1024KiB,<span class="w"> </span><span class="o">(</span>W<span class="o">)</span><span class="w"> </span>1024KiB-1024KiB,<span class="w"> </span><span class="o">(</span>T<span class="o">)</span><span class="w"> </span>1024KiB-1024KiB,<span class="w"> </span><span class="nv">ioengine</span><span class="o">=</span>sync,<span class="w"> </span><span class="nv">iodepth</span><span class="o">=</span><span class="m">1</span>
fio-3.33
Starting<span class="w"> </span><span class="m">1</span><span class="w"> </span>process
fiotest:<span class="w"> </span>Laying<span class="w"> </span>out<span class="w"> </span>IO<span class="w"> </span>file<span class="w"> </span><span class="o">(</span><span class="m">1</span><span class="w"> </span>file<span class="w"> </span>/<span class="w"> </span>1024MiB<span class="o">)</span>

fiotest:<span class="w"> </span><span class="o">(</span><span class="nv">groupid</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">jobs</span><span class="o">=</span><span class="m">1</span><span class="o">)</span>:<span class="w"> </span><span class="nv">err</span><span class="o">=</span><span class="w"> </span><span class="m">0</span>:<span class="w"> </span><span class="nv">pid</span><span class="o">=</span><span class="m">2437239</span>:<span class="w"> </span>Thu<span class="w"> </span>Oct<span class="w"> </span><span class="m">19</span><span class="w"> </span><span class="m">23</span>:32:09<span class="w"> </span><span class="m">2023</span>
<span class="w">  </span>write:<span class="w"> </span><span class="nv">IOPS</span><span class="o">=</span><span class="m">3953</span>,<span class="w"> </span><span class="nv">BW</span><span class="o">=</span>3954MiB/s<span class="w"> </span><span class="o">(</span>4146MB/s<span class="o">)(</span>1024MiB/259msec<span class="o">)</span><span class="p">;</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>zone<span class="w"> </span>resets
<span class="w">    </span>clat<span class="w"> </span><span class="o">(</span>usec<span class="o">)</span>:<span class="w"> </span><span class="nv">min</span><span class="o">=</span><span class="m">221</span>,<span class="w"> </span><span class="nv">max</span><span class="o">=</span><span class="m">1205</span>,<span class="w"> </span><span class="nv">avg</span><span class="o">=</span><span class="m">241</span>.83,<span class="w"> </span><span class="nv">stdev</span><span class="o">=</span><span class="m">43</span>.93
<span class="w">     </span>lat<span class="w"> </span><span class="o">(</span>usec<span class="o">)</span>:<span class="w"> </span><span class="nv">min</span><span class="o">=</span><span class="m">228</span>,<span class="w"> </span><span class="nv">max</span><span class="o">=</span><span class="m">1250</span>,<span class="w"> </span><span class="nv">avg</span><span class="o">=</span><span class="m">251</span>.68,<span class="w"> </span><span class="nv">stdev</span><span class="o">=</span><span class="m">45</span>.80
<span class="w">    </span>clat<span class="w"> </span>percentiles<span class="w"> </span><span class="o">(</span>usec<span class="o">)</span>:
<span class="w">     </span><span class="p">|</span><span class="w">  </span><span class="m">1</span>.00th<span class="o">=[</span><span class="w">  </span><span class="m">225</span><span class="o">]</span>,<span class="w">  </span><span class="m">5</span>.00th<span class="o">=[</span><span class="w">  </span><span class="m">225</span><span class="o">]</span>,<span class="w"> </span><span class="m">10</span>.00th<span class="o">=[</span><span class="w">  </span><span class="m">227</span><span class="o">]</span>,<span class="w"> </span><span class="m">20</span>.00th<span class="o">=[</span><span class="w">  </span><span class="m">227</span><span class="o">]</span>,
<span class="w">     </span><span class="p">|</span><span class="w"> </span><span class="m">30</span>.00th<span class="o">=[</span><span class="w">  </span><span class="m">231</span><span class="o">]</span>,<span class="w"> </span><span class="m">40</span>.00th<span class="o">=[</span><span class="w">  </span><span class="m">233</span><span class="o">]</span>,<span class="w"> </span><span class="m">50</span>.00th<span class="o">=[</span><span class="w">  </span><span class="m">235</span><span class="o">]</span>,<span class="w"> </span><span class="m">60</span>.00th<span class="o">=[</span><span class="w">  </span><span class="m">239</span><span class="o">]</span>,
<span class="w">     </span><span class="p">|</span><span class="w"> </span><span class="m">70</span>.00th<span class="o">=[</span><span class="w">  </span><span class="m">243</span><span class="o">]</span>,<span class="w"> </span><span class="m">80</span>.00th<span class="o">=[</span><span class="w">  </span><span class="m">249</span><span class="o">]</span>,<span class="w"> </span><span class="m">90</span>.00th<span class="o">=[</span><span class="w">  </span><span class="m">262</span><span class="o">]</span>,<span class="w"> </span><span class="m">95</span>.00th<span class="o">=[</span><span class="w">  </span><span class="m">269</span><span class="o">]</span>,
<span class="w">     </span><span class="p">|</span><span class="w"> </span><span class="m">99</span>.00th<span class="o">=[</span><span class="w">  </span><span class="m">302</span><span class="o">]</span>,<span class="w"> </span><span class="m">99</span>.50th<span class="o">=[</span><span class="w">  </span><span class="m">318</span><span class="o">]</span>,<span class="w"> </span><span class="m">99</span>.90th<span class="o">=[</span><span class="w"> </span><span class="m">1074</span><span class="o">]</span>,<span class="w"> </span><span class="m">99</span>.95th<span class="o">=[</span><span class="w"> </span><span class="m">1205</span><span class="o">]</span>,
<span class="w">     </span><span class="p">|</span><span class="w"> </span><span class="m">99</span>.99th<span class="o">=[</span><span class="w"> </span><span class="m">1205</span><span class="o">]</span>
<span class="w">  </span>lat<span class="w"> </span><span class="o">(</span>usec<span class="o">)</span><span class="w">   </span>:<span class="w"> </span><span class="nv">250</span><span class="o">=</span><span class="m">80</span>.96%,<span class="w"> </span><span class="nv">500</span><span class="o">=</span><span class="m">18</span>.85%
<span class="w">  </span>lat<span class="w"> </span><span class="o">(</span>msec<span class="o">)</span><span class="w">   </span>:<span class="w"> </span><span class="nv">2</span><span class="o">=</span><span class="m">0</span>.20%
<span class="w">  </span>cpu<span class="w">          </span>:<span class="w"> </span><span class="nv">usr</span><span class="o">=</span><span class="m">4</span>.26%,<span class="w"> </span><span class="nv">sys</span><span class="o">=</span><span class="m">94</span>.96%,<span class="w"> </span><span class="nv">ctx</span><span class="o">=</span><span class="m">3</span>,<span class="w"> </span><span class="nv">majf</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">minf</span><span class="o">=</span><span class="m">10</span>
<span class="w">  </span>IO<span class="w"> </span>depths<span class="w">    </span>:<span class="w"> </span><span class="nv">1</span><span class="o">=</span><span class="m">100</span>.0%,<span class="w"> </span><span class="nv">2</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span><span class="nv">4</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span><span class="nv">8</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span><span class="nv">16</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span><span class="nv">32</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span>&gt;<span class="o">=</span><span class="nv">64</span><span class="o">=</span><span class="m">0</span>.0%
<span class="w">     </span>submit<span class="w">    </span>:<span class="w"> </span><span class="nv">0</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span><span class="nv">4</span><span class="o">=</span><span class="m">100</span>.0%,<span class="w"> </span><span class="nv">8</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span><span class="nv">16</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span><span class="nv">32</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span><span class="nv">64</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span>&gt;<span class="o">=</span><span class="nv">64</span><span class="o">=</span><span class="m">0</span>.0%
<span class="w">     </span><span class="nb">complete</span><span class="w">  </span>:<span class="w"> </span><span class="nv">0</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span><span class="nv">4</span><span class="o">=</span><span class="m">100</span>.0%,<span class="w"> </span><span class="nv">8</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span><span class="nv">16</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span><span class="nv">32</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span><span class="nv">64</span><span class="o">=</span><span class="m">0</span>.0%,<span class="w"> </span>&gt;<span class="o">=</span><span class="nv">64</span><span class="o">=</span><span class="m">0</span>.0%
<span class="w">     </span>issued<span class="w"> </span>rwts:<span class="w"> </span><span class="nv">total</span><span class="o">=</span><span class="m">0</span>,1024,0,0<span class="w"> </span><span class="nv">short</span><span class="o">=</span><span class="m">0</span>,0,0,0<span class="w"> </span><span class="nv">dropped</span><span class="o">=</span><span class="m">0</span>,0,0,0
<span class="w">     </span>latency<span class="w">   </span>:<span class="w"> </span><span class="nv">target</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">window</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">percentile</span><span class="o">=</span><span class="m">100</span>.00%,<span class="w"> </span><span class="nv">depth</span><span class="o">=</span><span class="m">1</span>

Run<span class="w"> </span>status<span class="w"> </span>group<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">(</span>all<span class="w"> </span><span class="nb">jobs</span><span class="o">)</span>:
<span class="w">  </span>WRITE:<span class="w"> </span><span class="nv">bw</span><span class="o">=</span>3954MiB/s<span class="w"> </span><span class="o">(</span>4146MB/s<span class="o">)</span>,<span class="w"> </span>3954MiB/s-3954MiB/s<span class="w"> </span><span class="o">(</span>4146MB/s-4146MB/s<span class="o">)</span>,<span class="w"> </span><span class="nv">io</span><span class="o">=</span>1024MiB<span class="w"> </span><span class="o">(</span>1074MB<span class="o">)</span>,<span class="w"> </span><span class="nv">run</span><span class="o">=</span><span class="m">259</span>-259msec
</pre></div>
<p>3.9GB/s is also roughly in the same ballpark we got.</p>
<p>Our code seems reasonable!</p>
<h3 id="what's-next?">What's next?</h3><p>None of this is original. <code>fio</code> is a similar tool, written in C, with
many different IO engines including <code>libaio</code> and <code>writev</code> support. And
it has many different IO workloads.</p>
<p>But it's been enjoyable to learn more about these APIs. How to program
them and how they compare to eachother.</p>
<p>So next steps could include adding additional IO engines or IO
workloads.</p>
<p>Also, either I need to understand Iceber's Go library better or its
API needs to be loosened up a little bit so we can get that awesome
ring buffer behavior we could use from Zig.</p>
<p>Keep an eye out here and on my <a href="https://github.com/eatonphil/io-playground">io-playground
repo</a>!</p>
<h3 id="selected-responses-after-publication">Selected responses after publication</h3><ul>
<li>wizeman on lobsters
<a href="https://lobste.rs/s/rimkv3/io_uring_basics_writing_file_disk#c_qvlx5u">suggests</a>
measuring at least 30 seconds worth of writing data and
<code>fsync()</code>-ing if you want to test the entire IO subsystem and not
just hitting the kernel cache.</li>
</ul>
<p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">Digging into io_uring has been on my list for a long time now! This week I finally made made some progress.<br><br>Let&#39;s go on a little journey through a few increasingly complex (and useful) implementations of writing a file to disk with io_uring.<a href="https://t.co/gR9K2OQs2R">https://t.co/gR9K2OQs2R</a> <a href="https://t.co/TMaC8QYL6k">pic.twitter.com/TMaC8QYL6k</a></p>&mdash; Phil Eaton (@eatonphil) <a href="https://twitter.com/eatonphil/status/1715151609615773965?ref_src=twsrc%5Etfw">October 19, 2023</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<style>.feedback{display:initial;}</style>
	</div>
	<div class="feedback">
	  <h4>Feedback</h4>
	  <p>As always,
	      please <a href="mailto:phil@eatonphil.com">email</a>
	      or <a href="https://twitter.com/eatonphil">tweet me</a>
	      with questions, corrections, or ideas!</p>

	</div>
      </div>
    </div>
    <footer>
      <div class="container">
	<div>
	  <div id="subscribe">
	    <iframe frameBorder="0" src="https://cdn.forms-content-1.sg-form.com/e8ed4c3b-dd46-11f0-b6e6-ce075f2c5f80"/>

	  </div>
	</div>
      </div>
    </footer>
  </body>
</html>
