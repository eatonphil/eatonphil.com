<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="canonical" href="https://notes.eatonphil.com/2024-10-31-checking-linearizability-in-go.html">
    <title>Checking linearizability in Go | notes.eatonphil.com</title>
    <meta name="description" content="Checking linearizability in Go" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" href="/rss.xml" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono">

    <script async onload="loadGA()" src="https://www.googletagmanager.com/gtag/js?id=UA-58109156-2"></script>
    <script>
      function loadGA() {
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());
	  gtag('config', 'UA-58109156-2');
      }
    </script>
    <script defer src="https://cdn.usefathom.com/script.js" data-site="CEPUOLOQ"></script>
  </head>
  <body>
    <header>
      <div class="lfw">
	<div class="container">
	  <div class="row">
	    <a href="https://eatonphil.com/2025-holiday-fundraiser.html">2025 Holiday Fundraiser</a>
	  </div>
	</div>
      </div>
      <div class="container">
        <div>
          <div class="row">
	    <div>
	      <a href="https://eatonphil.com" class="sm-link">
		Home
              </a>
	      <a href="/" class="sm-link">
		Blog
              </a>
	      <a href="/rss.xml" class="sm-link">
		RSS
              </a>
	    </div>

	    <div class="subscribe">
	      <!-- <a href="https://eatonphil.com/hire-me.html">Hire me</a> -->
	      <!--
		  Hardcode link to home page because some pages don't
		  have a subscribe box. Some pages hide the subscribe.
		-->
	      <a href="https://eatonphil.com/subscribe.html">
		Subscribe
	      </a>
            </div>
	  </div>
	  <hr />
	  <div class="">
            <h2>October 31, 2024</h2>
            <h1>Checking linearizability in Go</h1>
	    
            <div class="row" style="padding-bottom: 5px">
              <div class="tags"><a href="/tags/go.html" class="tag">go</a><a href="/tags/distsys.html" class="tag">distsys</a></div>
            </div>
	  </div>
	</div>
      </div>
    </header>
    <div class="container">
      <div class="col-6">
	<div class="post">
          <p><!-- -*- mode: markdown -*- --></p>
<p>You want to check for strict consistency
(<a href="https://jepsen.io/consistency/models/linearizable">linearizability</a>)
for your project but you don't want to have to <a href="https://github.com/jepsen-io/">deal with the
JVM</a>. <a href="https://github.com/anishathalye/porcupine">Porcupine</a>,
used by a number of real-world systems like etcd and TiDB, has you
covered!</p>
<p>Importantly, neither Jepsen projects nor Porcupine can <em>prove</em>
linearizability. They can only help you <em>build confidence</em> that you
aren't obviously <em>violating</em> linearizability.</p>
<p>The Porcupine README is pretty good but doesn't give complete working
code, so I'm going to walk through checking linearizability of a
distributed register. And then we'll tweak things a bit by checking
linearizability for a distributed key-value store.</p>
<p>But rather than implementing a distributed register and implementing a
distributed key-value store, to keep this post concise, we're just
going to imagine that they exist and we'll come up with some example
histories we might see.</p>
<p>Code for this post can be found on
<a href="https://github.com/eatonphil/linearizability-playground">GitHub</a>.</p>
<h3 id="boilerplate">Boilerplate</h3><p>Create a new directory and <code>go mod init lintest</code>. Let's add the
imports we need and a helper function for generating a visualization
of a history, in <code>main.go</code>:</p>
<div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>

<span class="kn">import</span><span class="w"> </span><span class="s">&quot;os&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="s">&quot;log&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="s">&quot;github.com/anishathalye/porcupine&quot;</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">visualizeTempFile</span><span class="p">(</span><span class="nx">model</span><span class="w"> </span><span class="nx">porcupine</span><span class="p">.</span><span class="nx">Model</span><span class="p">,</span><span class="w"> </span><span class="nx">info</span><span class="w"> </span><span class="nx">porcupine</span><span class="p">.</span><span class="nx">LinearizationInfo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">file</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">CreateTemp</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;*.html&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="s">&quot;failed to create temp file&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">porcupine</span><span class="p">.</span><span class="nx">Visualize</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span><span class="w"> </span><span class="nx">info</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="s">&quot;visualization failed&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;wrote visualization to %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">.</span><span class="nx">Name</span><span class="p">())</span>
<span class="p">}</span>
</pre></div>
<h3 id="a-distributed-register">A distributed register</h3><p>A distributed register is like a distributed key-value store but
there's only a single key.</p>
<p>We need to tell Porcupine what the inputs and outputs for this system
are. And we'll later describe for it how an idealized version of this
system should behave as it receives each input; what output the
idealized version should produce.</p>
<p>Each time we send a command to the distributed register it will
include an operation (to get or to set the register). And if it is a
set command it will include a value.</p>
<div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">registerInput</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">operation</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="c1">// &quot;get&quot; and &quot;set&quot;</span>
<span class="w">    </span><span class="nx">value</span><span class="w"> </span><span class="kt">int</span>
<span class="p">}</span>
</pre></div>
<p>The register is an integer register.</p>
<p>Now we will define a model for Porcupine which, again, is the
idealized version of this system.</p>
<div class="highlight"><pre><span></span><span class="k">func</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">registerModel</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">porcupine</span><span class="o">.</span><span class="n">Model</span><span class="p">{</span>
<span class="w">        </span><span class="n">Init</span><span class="p">:</span><span class="w"> </span><span class="k">func</span><span class="p">()</span><span class="w"> </span><span class="n">any</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="n">Step</span><span class="p">:</span><span class="w"> </span><span class="k">func</span><span class="p">(</span><span class="n">stateAny</span><span class="p">,</span><span class="w"> </span><span class="n">inputAny</span><span class="p">,</span><span class="w"> </span><span class="n">outputAny</span><span class="w"> </span><span class="n">any</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb nb-Type">bool</span><span class="p">,</span><span class="w"> </span><span class="n">any</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">input</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">inputAny</span><span class="o">.</span><span class="p">(</span><span class="n">registerInput</span><span class="p">)</span>
<span class="w">            </span><span class="n">output</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">outputAny</span><span class="o">.</span><span class="p">(</span><span class="nb nb-Type">int</span><span class="p">)</span>
<span class="w">            </span><span class="n">state</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">stateAny</span><span class="o">.</span><span class="p">(</span><span class="nb nb-Type">int</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">input</span><span class="o">.</span><span class="n">operation</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;set&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="bp">true</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="o">.</span><span class="n">value</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">input</span><span class="o">.</span><span class="n">operation</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;get&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">readCorrectValue</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">state</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">readCorrectValue</span><span class="p">,</span><span class="w"> </span><span class="n">state</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">panic</span><span class="p">(</span><span class="s2">&quot;Unexpected operation&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
<p>The step function accepts anything because it has to be able to model
any sort of system with its different inputs and outputs and current
state. So we have to handle casting from the <code>any</code> type to what we
know are the inputs and outputs and state. And finally we actually do
the state change and return the new state as well as if the given
output matches what we know it should be.</p>
<h3 id="an-invalid-history">An invalid history</h3><p>Now we've only defined the idealized version of this system. Let's
pretend we have some real-world implementation of this. We might have
two clients and they might issue concurrent get and set requests.</p>
<p>Every time we stimulate the system we will generate a new history that
we can validate with Porcupine against our model to see if the history
is linearizable.</p>
<p>Let's imagine these two clients concurrently set the register to some
value. Both sets succeed. Then both clients read the register. And
they get different values. Here's what that history would look like
modeled for Porcupine.</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="nx">ops</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="nx">porcupine</span><span class="p">.</span><span class="nx">Operation</span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Client 3 sets the register to 100. The request starts at t0 and ends at t2.</span>
<span class="w">        </span><span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nx">registerInput</span><span class="p">{</span><span class="s">&quot;set&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">},</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="cm">/* end state at t2 is 100 */</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">},</span>
<span class="w">        </span><span class="c1">// Client 5 sets the register to 200. The request starts at t3 and ends at t4.</span>
<span class="w">        </span><span class="p">{</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="nx">registerInput</span><span class="p">{</span><span class="s">&quot;set&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">},</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="cm">/* end state at t3 is 200 */</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">},</span>
<span class="w">        </span><span class="c1">// Client 3 reads the register. The request starts at t5 and ends at t6.</span>
<span class="w">        </span><span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nx">registerInput</span><span class="p">{</span><span class="s">&quot;get&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="cm">/* doesn&#39;t matter */</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">},</span>
<span class="w">        </span><span class="c1">// Client 5 reads the register. The request starts at t7 and ends at t8. Reads a stale value!</span>
<span class="w">        </span><span class="p">{</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="nx">registerInput</span><span class="p">{</span><span class="s">&quot;get&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="cm">/* doesn&#39;t matter */</span><span class="p">},</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">},</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">info</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">porcupine</span><span class="p">.</span><span class="nx">CheckOperationsVerbose</span><span class="p">(</span><span class="nx">registerModel</span><span class="p">,</span><span class="w"> </span><span class="nx">ops</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="nx">visualizeTempFile</span><span class="p">(</span><span class="nx">registerModel</span><span class="p">,</span><span class="w"> </span><span class="nx">info</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">porcupine</span><span class="p">.</span><span class="nx">Ok</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="s">&quot;expected operations to be linearizable&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>If we build and run this code:</p>
<div class="highlight"><pre><span></span><span class="err">$</span><span class="w"> </span><span class="k">go</span><span class="w"> </span><span class="k">mod</span><span class="w"> </span><span class="n">tidy</span>
<span class="k">go</span><span class="err">:</span><span class="w"> </span><span class="n">finding</span><span class="w"> </span><span class="k">module</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">package</span><span class="w"> </span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">anishathalye</span><span class="o">/</span><span class="n">porcupine</span>
<span class="k">go</span><span class="err">:</span><span class="w"> </span><span class="k">found</span><span class="w"> </span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">anishathalye</span><span class="o">/</span><span class="n">porcupine</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">anishathalye</span><span class="o">/</span><span class="n">porcupine</span><span class="w"> </span><span class="n">v0</span><span class="mf">.1.6</span>
<span class="err">$</span><span class="w"> </span><span class="k">go</span><span class="w"> </span><span class="n">build</span>
<span class="err">$</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lintest</span>
<span class="mi">2024</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span><span class="mi">31</span><span class="w"> </span><span class="mi">19</span><span class="err">:</span><span class="mi">54</span><span class="err">:</span><span class="mi">08</span><span class="w"> </span><span class="n">wrote</span><span class="w"> </span><span class="n">visualization</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="o">/</span><span class="nf">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">cb</span><span class="o">/</span><span class="n">v27m749d0sj89h9ydfq0f0940000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="mf">463308000.</span><span class="n">html</span>
<span class="nl">panic</span><span class="p">:</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="n">operations</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">linearizable</span>

<span class="n">goroutine</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">[</span><span class="n">running</span><span class="o">]</span><span class="err">:</span>
<span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="p">()</span>
<span class="w">        </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">phil</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">lintest</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="k">go</span><span class="err">:</span><span class="mi">59</span><span class="w"> </span><span class="o">+</span><span class="mh">0x394</span>
</pre></div>
<p>Porcupine caught the stale value. Open that HTML file to see
the visualization.</p>
<p><img src="/assets/bad-register-history.png" alt="/assets/bad-register-history.png"></p>
<h3 id="a-valid-history">A valid history</h3><p>Let's say we fix the bug so now there's no stale read. The new history
would look like this:</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="nx">ops</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="nx">porcupine</span><span class="p">.</span><span class="nx">Operation</span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Client 3 sets the register to 100. The request starts at t0 and ends at t2.</span>
<span class="w">        </span><span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nx">registerInput</span><span class="p">{</span><span class="s">&quot;set&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">},</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="cm">/* end state at t2 is 100 */</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">},</span>
<span class="w">        </span><span class="c1">// Client 5 sets the register to 200. The request starts at t3 and ends at t4.</span>
<span class="w">        </span><span class="p">{</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="nx">registerInput</span><span class="p">{</span><span class="s">&quot;set&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">},</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="cm">/* end state at t3 is 200 */</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">},</span>
<span class="w">        </span><span class="c1">// Client 3 reads the register. The request starts at t5 and ends at t6.</span>
<span class="w">        </span><span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nx">registerInput</span><span class="p">{</span><span class="s">&quot;get&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="cm">/* doesn&#39;t matter */</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">},</span>
<span class="w">        </span><span class="c1">// Client 5 reads the register. The request starts at t7 and ends at t8.</span>
<span class="w">        </span><span class="p">{</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="nx">registerInput</span><span class="p">{</span><span class="s">&quot;get&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="cm">/* doesn&#39;t matter */</span><span class="p">},</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">},</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
<p>Rebuild, rerun <code>lintest</code> (it should exit successfully now), and open
the visualization.</p>
<p><img src="/assets/good-register-history.png" alt="/assets/good-register-history.png"></p>
<p>Great! Now let's make things a little more complicated by modeling a
distributed key-value store rather than a distributed register.</p>
<h3 id="distributed-key-value">Distributed key-value</h3><p>The inputs of this system will be slightly more complex. They will
take a <code>key</code> along with the <code>operation</code> and <code>value</code>.</p>
<div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">kvInput</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">operation</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="c1">// &quot;get&quot; and &quot;set&quot;</span>
<span class="w">    </span><span class="nx">key</span><span class="w"> </span><span class="kt">string</span>
<span class="w">    </span><span class="nx">value</span><span class="w"> </span><span class="kt">int</span>
<span class="p">}</span>
</pre></div>
<p>And when we model the distributed key-value store with the state and
output at each step being a <code>map[string]int</code>.</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="n">kvModel</span><span class="w"> </span><span class="err">:</span><span class="o">=</span><span class="w"> </span><span class="n">porcupine</span><span class="p">.</span><span class="n">Model</span><span class="err">{</span>
<span class="w">        </span><span class="nl">Init</span><span class="p">:</span><span class="w"> </span><span class="n">func</span><span class="p">()</span><span class="w"> </span><span class="ow">any</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">map</span><span class="o">[</span><span class="n">string</span><span class="o">]</span><span class="nc">int</span><span class="err">{}</span>
<span class="w">        </span><span class="err">}</span><span class="p">,</span>
<span class="w">        </span><span class="nl">Step</span><span class="p">:</span><span class="w"> </span><span class="n">func</span><span class="p">(</span><span class="n">stateAny</span><span class="p">,</span><span class="w"> </span><span class="n">inputAny</span><span class="p">,</span><span class="w"> </span><span class="n">outputAny</span><span class="w"> </span><span class="ow">any</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">bool</span><span class="p">,</span><span class="w"> </span><span class="ow">any</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="k">input</span><span class="w"> </span><span class="err">:</span><span class="o">=</span><span class="w"> </span><span class="n">inputAny</span><span class="p">.(</span><span class="n">kvInput</span><span class="p">)</span>
<span class="w">            </span><span class="k">output</span><span class="w"> </span><span class="err">:</span><span class="o">=</span><span class="w"> </span><span class="n">outputAny</span><span class="p">.(</span><span class="k">map</span><span class="o">[</span><span class="n">string</span><span class="o">]</span><span class="nc">int</span><span class="p">)</span>
<span class="w">            </span><span class="k">state</span><span class="w"> </span><span class="err">:</span><span class="o">=</span><span class="w"> </span><span class="n">stateAny</span><span class="p">.(</span><span class="k">map</span><span class="o">[</span><span class="n">string</span><span class="o">]</span><span class="nc">int</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="k">input</span><span class="p">.</span><span class="k">operation</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">&quot;set&quot;</span><span class="w"> </span><span class="err">{</span>
<span class="w">                </span><span class="n">newState</span><span class="w"> </span><span class="err">:</span><span class="o">=</span><span class="w"> </span><span class="k">map</span><span class="o">[</span><span class="n">string</span><span class="o">]</span><span class="nc">int</span><span class="err">{}</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="err">:</span><span class="o">=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="err">{</span>
<span class="w">                    </span><span class="n">newState</span><span class="o">[</span><span class="n">k</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span>
<span class="w">                </span><span class="err">}</span>
<span class="w">                </span><span class="n">newState</span><span class="o">[</span><span class="n">input.key</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">input</span><span class="p">.</span><span class="k">value</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="k">true</span><span class="p">,</span><span class="w"> </span><span class="n">newState</span>
<span class="w">            </span><span class="err">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">input</span><span class="p">.</span><span class="k">operation</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">&quot;get&quot;</span><span class="w"> </span><span class="err">{</span>
<span class="w">                </span><span class="n">readCorrectValue</span><span class="w"> </span><span class="err">:</span><span class="o">=</span><span class="w"> </span><span class="k">output</span><span class="o">[</span><span class="n">input.key</span><span class="o">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">state</span><span class="o">[</span><span class="n">input.key</span><span class="o">]</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">readCorrectValue</span><span class="p">,</span><span class="w"> </span><span class="k">state</span>
<span class="w">            </span><span class="err">}</span>

<span class="w">            </span><span class="n">panic</span><span class="p">(</span><span class="ss">&quot;Unexpected operation&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="err">}</span><span class="p">,</span>
<span class="w">    </span><span class="err">}</span>
</pre></div>
<p>And now the history gets slightly more complex because we are now
working with some specific key. But we'll otherwise use the same
history as before.</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="nx">ops</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="nx">porcupine</span><span class="p">.</span><span class="nx">Operation</span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Client 3 set key `a` to 100. The request starts at t0 and ends at t2.</span>
<span class="w">        </span><span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nx">kvInput</span><span class="p">{</span><span class="s">&quot;set&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">},</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="p">{</span><span class="s">&quot;a&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">},</span><span class="w"> </span><span class="mi">2</span><span class="p">},</span>
<span class="w">        </span><span class="c1">// Client 5 set key `a` to 200. The request starts at t3 and ends at t4.</span>
<span class="w">        </span><span class="p">{</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="nx">kvInput</span><span class="p">{</span><span class="s">&quot;set&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">},</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="p">{</span><span class="s">&quot;a&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">},</span><span class="w"> </span><span class="mi">4</span><span class="p">},</span>
<span class="w">        </span><span class="c1">// Client 3 read key `a`. The request starts at t5 and ends at t6.</span>
<span class="w">        </span><span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nx">kvInput</span><span class="p">{</span><span class="s">&quot;get&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="cm">/* doesn&#39;t matter */</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="p">{</span><span class="s">&quot;a&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">},</span><span class="w"> </span><span class="mi">6</span><span class="p">},</span>
<span class="w">        </span><span class="c1">// Client 5 read key `a`. The request starts at t7 and ends at t8.</span>
<span class="w">        </span><span class="p">{</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="nx">kvInput</span><span class="p">{</span><span class="s">&quot;get&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="cm">/* doesn&#39;t matter */</span><span class="p">},</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="p">{</span><span class="s">&quot;a&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">},</span><span class="w"> </span><span class="mi">8</span><span class="p">},</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
<p>Build and run. Open the visualization.</p>
<p><img src="/assets/good-kv-history.png" alt="/assets/good-kv-history.png"></p>
<p>And there we go!</p>
<h3 id="what's-next">What's next</h3><p>These are just a few simple examples that are not hooked up to a real
system. But it still seemed useful to show how you model one or two
simple different systems and check a history with Porcupine.</p>
<p>Another aspect of Porcupine I did not cover is partitioning the state
space. The
<a href="https://pkg.go.dev/github.com/anishathalye/porcupine#Model">docs</a>
say:</p>
<blockquote><p>Implementing the partition functions can greatly improve
performance. If you're implementing the partition function, the
model Init and Step functions can be per-partition. For example, if
your specification is for a key-value store and you partition by
key, then the per-partition state representation can just be a
single value rather than a map.</p>
</blockquote>
<p>Perhaps that, and hooking this up to some "real" system, would be a
good next step.</p>
<p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">I wrote a short tutorial on using Porcupine to check for linearizability (without needing to deal with the JVM).<a href="https://t.co/kqeBz2jX76">https://t.co/kqeBz2jX76</a> <a href="https://t.co/teXvlp2zcv">pic.twitter.com/teXvlp2zcv</a></p>&mdash; Phil Eaton (@eatonphil) <a href="https://twitter.com/eatonphil/status/1852143540131844109?ref_src=twsrc%5Etfw">November 1, 2024</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<style>.feedback{display:initial;}</style>
	</div>
	<div class="feedback">
	  <h4>Feedback</h4>
	  <p>As always,
	      please <a href="mailto:phil@eatonphil.com">email</a>
	      or <a href="https://twitter.com/eatonphil">tweet me</a>
	      with questions, corrections, or ideas!</p>

	</div>
      </div>
    </div>
    <footer>
      <div class="container">
	<div>
	  <div id="subscribe">
	    <iframe frameBorder="0" src="https://cdn.forms-content-1.sg-form.com/e8ed4c3b-dd46-11f0-b6e6-ce075f2c5f80"/>

	  </div>
	</div>
      </div>
    </footer>
  </body>
</html>
