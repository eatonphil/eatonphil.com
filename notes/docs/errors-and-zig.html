<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="canonical" href="https://notes.eatonphil.com/errors-and-zig.html">
    <title>Errors and Zig | notes.eatonphil.com</title>
    <meta name="description" content="Errors and Zig" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" href="/rss.xml" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono">
  </head>
  <body>
    <header>
      <div class="lfw">
	<div class="container">
	  <div class="row">
	    <a href="https://eatonphil.com/30.html">Turning 30, a little fundraiser ðŸŽ‰</a>
	  </div>
	</div>
      </div>
      <div class="container">
        <div>
          <div class="row">
	    <div>
	      <a href="https://eatonphil.com" class="sm-link">
		Home
              </a>
	      <a href="/" class="sm-link">
		Blog
              </a>
	      <a href="/rss.xml" class="sm-link">
		RSS
              </a>
	    </div>

	    <div class="subscribe">
	      <!-- <a href="https://eatonphil.com/hire-me.html">Hire me</a> -->
	      <!--
		  Hardcode link to home page because some pages don't
		  have a subscribe box. Some pages hide the subscribe.
		-->
	      <a href="https://eatonphil.com/subscribe.html">
		Subscribe
	      </a>
            </div>
	  </div>
	  <hr />
	  <div class="">
            <h2>March 21, 2023</h2>
            <h1>Errors and Zig</h1>
	    
            <div class="row" style="padding-bottom: 5px">
              <div class="tags"><a href="/tags/zig.html" class="tag">zig</a></div>
            </div>
	  </div>
	</div>
      </div>
    </header>
    <div class="container">
      <div class="col-6">
	<div class="post">
          <p>At TigerBeetle these last few weeks I've been doing a mix of
documenting client libraries, writing sample code for client
libraries, and writing integration tests against the sample code.</p>
<p>The client library documentation is generated with a Zig script. The
sample code is integration tested with a Zig script. A bunch of Zig
scripts.</p>
<p>It's not the same
<a href="https://github.com/tigerbeetledb/tigerbeetle/blob/main/docs/TIGER_STYLE.md">rigorous</a>
sort of Zig as the main database. (We're generally more lax about
scripts and test code.)</p>
<p><em>And I'm specifically writing this post on my personal blog since my
script code is not under incredible scrutiny.</em></p>
<p>Furthermore, I'm still new to Zig. Since I'm still learning, there
have been a few things that tripped me up.</p>
<p>And now that I've written this out, I realize most of my stumbling was
related to errors.</p>
<h3 id="failure">Failure</h3><p>Lots of things in programs allocate memory. This sounds dumb and
obvious but before programming Zig I did not appreciate how many
operations I'm used to allocate memory. I've previously only
programmed in GC languages that do the allocations behind the scenes.</p>
<p>Furthermore, memory allocation can fail. Zig makes allocation failures
explicit. So lots of things in Zig code need to handle failure.</p>
<p>Selectively omitting error handling is not allowed:</p>
<div class="highlight"><pre><span></span><span class="kr">const</span><span class="w"> </span><span class="n">std</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">@import</span><span class="p">(</span><span class="s">&quot;std&quot;</span><span class="p">);</span>

<span class="k">fn</span><span class="w"> </span><span class="n">thing</span><span class="p">(</span><span class="n">a</span><span class="o">:</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">Allocator</span><span class="p">)</span><span class="w"> </span><span class="o">!</span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">allocPrint</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{});</span>
<span class="p">}</span>

<span class="kr">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="o">!</span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">arena</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">heap</span><span class="p">.</span><span class="n">ArenaAllocator</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">std</span><span class="p">.</span><span class="n">heap</span><span class="p">.</span><span class="n">page_allocator</span><span class="p">);</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="n">arena</span><span class="p">.</span><span class="n">deinit</span><span class="p">();</span>

<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">allocator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arena</span><span class="p">.</span><span class="n">allocator</span><span class="p">();</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="n">thing</span><span class="p">(</span><span class="n">allocator</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>Run <code>zig run test.zig</code>:</p>
<div class="highlight"><pre><span></span>test.zig:4:23:<span class="w"> </span>error:<span class="w"> </span>error<span class="w"> </span>is<span class="w"> </span>ignored
<span class="w">    </span>std.fmt.allocPrint<span class="o">(</span>a,<span class="w"> </span><span class="s2">&quot;&quot;</span>,<span class="w"> </span>.<span class="o">{})</span><span class="p">;</span>
<span class="w">    </span>~~~~~~~~~~~~~~~~~~^~~~~~~~~~~~
test.zig:4:23:<span class="w"> </span>note:<span class="w"> </span>consider<span class="w"> </span>using<span class="w"> </span><span class="s1">&#39;try&#39;</span>,<span class="w"> </span><span class="s1">&#39;catch&#39;</span>,<span class="w"> </span>or<span class="w"> </span><span class="s1">&#39;if&#39;</span>
referenced<span class="w"> </span>by:
<span class="w">    </span>main:<span class="w"> </span>test.zig:12:9
<span class="w">    </span>callMain:<span class="w"> </span>/home/phil/vendor/zig-linux-x86_64-0.11.0-dev.2213+515e1c93e/lib/std/start.zig:617:32
<span class="w">    </span>remaining<span class="w"> </span>reference<span class="w"> </span>traces<span class="w"> </span>hidden<span class="p">;</span><span class="w"> </span>use<span class="w"> </span><span class="s1">&#39;-freference-trace&#39;</span><span class="w"> </span>to<span class="w"> </span>see<span class="w"> </span>all<span class="w"> </span>reference<span class="w"> </span>traces
</pre></div>
<p>This ends up meaning lots of code like:</p>
<div class="highlight"><pre><span></span><span class="k">fn</span><span class="w"> </span><span class="n">do_stuff</span><span class="p">(</span>
<span class="w">  </span><span class="n">alloc</span><span class="o">:</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">Allocator</span><span class="p">,</span><span class="w"> </span><span class="c1">// Let&#39;s assume this is an arena allocator so I don&#39;t care about freeing.</span>
<span class="w">  </span><span class="n">stuff</span><span class="o">:</span><span class="w"> </span><span class="n">Stuff</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="o">!</span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">ArrayList</span><span class="p">([]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">).</span><span class="n">init</span><span class="p">(</span><span class="n">alloc</span><span class="p">);</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">appendSlice</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="n">_</span><span class="p">][]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;first of something&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;one more&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">stuff</span><span class="p">.</span><span class="n">thing</span><span class="p">);</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="k">try</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">allocPrint</span><span class="p">(</span><span class="n">alloc</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;build some string {s}.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span><span class="n">stuff</span><span class="p">.</span><span class="n">athing</span><span class="p">}));</span>

<span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">other_stuff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">allocPrint</span><span class="p">(</span><span class="n">alloc</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;things... {s}&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span><span class="n">blah</span><span class="p">});</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="n">do_other_stuff</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">items</span><span class="p">,</span><span class="w"> </span><span class="n">other_stuff</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>You have <code>try</code>-es all over the place.</p>
<h3 id="limits-of-<code>try</code>">Limits of <code>try</code></h3><p>Now I don't have a problem with acknowledging that allocations can
fail. At least outside of scripts. In scripts like I've been writing
though I don't really care.</p>
<p>Having all of those <code>try</code>-es is just extra typing all over the place.</p>
<p>It would be nice if I could have instead done:</p>
<div class="highlight"><pre><span></span><span class="k">fn</span><span class="w"> </span><span class="n">do_stuff</span><span class="p">(</span>
<span class="w">  </span><span class="n">alloc</span><span class="o">:</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">Allocator</span><span class="p">,</span><span class="w"> </span><span class="c1">// Let&#39;s assume this is an arena allocator so I don&#39;t care about freeing.</span>
<span class="w">  </span><span class="n">stuff</span><span class="o">:</span><span class="w"> </span><span class="n">Stuff</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="o">!</span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">ArrayList</span><span class="p">([]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">).</span><span class="n">init</span><span class="p">(</span><span class="n">alloc</span><span class="p">);</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">x</span><span class="p">.</span><span class="n">appendSlice</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="n">_</span><span class="p">][]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;first of something&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;one more&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="n">x</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">stuff</span><span class="p">.</span><span class="n">thing</span><span class="p">);</span>
<span class="w">    </span><span class="n">x</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">std</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">allocPrint</span><span class="p">(</span><span class="n">alloc</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;build some string {s}.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span><span class="n">stuff</span><span class="p">.</span><span class="n">athing</span><span class="p">}));</span>

<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">other_stuff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">allocPrint</span><span class="p">(</span><span class="n">alloc</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;things... {s}&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span><span class="n">blah</span><span class="p">});</span>

<span class="w">    </span><span class="n">do_other_stuff</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">items</span><span class="p">,</span><span class="w"> </span><span class="n">other_stuff</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>But Zig's <code>try</code> doesn't work like that. I'm not sure why not. The
Zig developers are sensible so I'm sure there's a good reason.</p>
<p>Still, are there other options?</p>
<h3 id="<code>catch-unreachable</code>"><code>catch unreachable</code></h3><p>So the problem isn't just that you have to acknowledge memory
allocation failures but that these failures within every helper
function need to be acknowledged by the caller of the helper
function. Failures infiltrate the entire call tree.</p>
<p>Now of course these potential failures would exist whether or not Zig
exposed them. So I don't mean to say it's Zig's fault for exposing
them.</p>
<p>But you can avoid failure handling by instead of <code>try</code>-ing everything,
mark error conditions as <code>unreachable</code>.</p>
<div class="highlight"><pre><span></span><span class="k">fn</span><span class="w"> </span><span class="n">do_stuff</span><span class="p">(</span>
<span class="w">  </span><span class="n">alloc</span><span class="o">:</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">Allocator</span><span class="p">,</span><span class="w"> </span><span class="c1">// Let&#39;s assume this is an arena allocator so I don&#39;t care about freeing.</span>
<span class="w">  </span><span class="n">stuff</span><span class="o">:</span><span class="w"> </span><span class="n">Stuff</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">ArrayList</span><span class="p">([]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">).</span><span class="n">init</span><span class="p">(</span><span class="n">alloc</span><span class="p">);</span>
<span class="w">  </span><span class="n">x</span><span class="p">.</span><span class="n">appendSlice</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="n">_</span><span class="p">][]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;first of something&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;one more&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="p">})</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="k">unreachable</span><span class="p">;</span>
<span class="w">  </span><span class="n">x</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">stuff</span><span class="p">.</span><span class="n">thing</span><span class="p">)</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="k">unreachable</span><span class="p">;</span>
<span class="w">  </span><span class="n">x</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">std</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">allocPrint</span><span class="p">(</span><span class="n">alloc</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;build some string {s}.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span><span class="n">stuff</span><span class="p">.</span><span class="n">athing</span><span class="p">})</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="k">unreachable</span><span class="p">)</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="k">unreachable</span><span class="p">;</span>

<span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">other_stuff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">allocPrint</span><span class="p">(</span><span class="n">alloc</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;things... {s}&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span><span class="n">blah</span><span class="p">})</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="k">unreachable</span><span class="p">;</span>

<span class="w">  </span><span class="n">do_other_stuff</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">items</span><span class="p">,</span><span class="w"> </span><span class="n">other_stuff</span><span class="p">)</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="k">unreachable</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>As you can see from the function signature, this function no longer
returns any error at all. But it could possibly panic.</p>
<p>Now in scripts, for things like memory allocations that can fail, I
actually think it's reasonable to mark allocation failures as
unreachable.</p>
<p>But I took it a bit further. Using <code>@panic</code> or <code>unreachable</code> in
general failure conditions.</p>
<div class="highlight"><pre><span></span><span class="k">fn</span><span class="w"> </span><span class="n">run</span><span class="p">(</span><span class="n">alloc</span><span class="o">:</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">Allocator</span><span class="p">,</span><span class="w"> </span><span class="n">cmds</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">ChildProcess</span><span class="p">.</span><span class="n">exec</span><span class="p">(.{</span>
<span class="w">    </span><span class="p">.</span><span class="n">allocator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">allocator</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">argv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cmd</span><span class="p">,</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">term</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">Exited</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">|</span><span class="n">code</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">code</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">@panic</span><span class="p">(</span><span class="s">&quot;Expected command to succeed.&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">unreachable</span><span class="p">,</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<h3 id="handling-panics">Handling panics</h3><p>But there are some things that will fail quite frequently (like
running subprocesses or interacting with the filesystem in general).</p>
<p>Panicing (like what happens if <code>@panic()</code> <s>or `unreachable`</s> is hit) in
these situations is all good until you have things that you want to
get cleaned up.</p>
<p class="note">
  My <a href="https://matklad.github.io/">coworker</a> points out I'm
  wrongly conflating <code>unreachable</code>
  and <code>@panic()</code> since depending on the release mode,
  hitting <code>unreachable</code> is actually undefined behavior
  whereas <code>@panic()</code> is always a panic.
</p><p>Panics don't trigger <code>defer</code> or <code>errdefer</code> statements. So if you have
a script that starts a background process or creates a temporary
directory, and if you panic in that script, the script won't be able
to run <code>defer</code> steps to stop the background process or delete the
temporary directory.</p>
<p>There are panic handlers in Zig (not yet documented, Ctrl-f for "TODO:
pub fn panic" in the <a href="https://ziglang.org/documentation/master/">Zig
docs</a>. But I'd just be
getting further from what seems sensible if I went in that direction.</p>
<h3 id="zig-errors">Zig errors</h3><p>So I stopped panic-ing everywhere and switched to using real Zig
errors, like:</p>
<div class="highlight"><pre><span></span><span class="k">fn</span><span class="w"> </span><span class="n">run</span><span class="p">(</span><span class="n">alloc</span><span class="o">:</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">Allocator</span><span class="p">,</span><span class="w"> </span><span class="n">cmds</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="o">!</span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">ChildProcess</span><span class="p">.</span><span class="n">exec</span><span class="p">(.{</span>
<span class="w">    </span><span class="p">.</span><span class="n">allocator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">allocator</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">argv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cmd</span><span class="p">,</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">term</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">Exited</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">|</span><span class="n">code</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">code</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Expected command to succeed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.{});</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">error</span><span class="p">.</span><span class="n">RunCommandFailed</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">unreachable</span><span class="p">,</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>It's pretty sweet. You get to make up a new <code>error</code> enum wherever
you'd like.</p>
<p>It is unfortunate you can't (currently) include a payload with the
error return value. There's an <a href="https://github.com/ziglang/zig/issues/2647">active issue discussing
it</a>.</p>
<p>But so far I've been able to work around that, as seen in that example
above, by logging before returning an error. Since most of the time
the payload you want to return is detailed information to provide
context.</p>
<p>This logging is fine in a CLI application but probably not everything
you'd want in a library. I'm not sure.</p>
<p>And now without panics, functions that deal with <code>error</code> enums and
<code>try</code> work with <code>defer</code> and <code>errdefer</code> again! Cleanup of my
background processes and temporary directories happens like I want.</p>
<h3 id="handling-errors-with-<code>if</code>">Handling errors with <code>if</code></h3><p>Ok so now that I'm fully bought into Zig errors there were still a few
more things that tripped me up.</p>
<p>First is that you can handle errors a few ways. You already saw the
first one with <code>try</code>.</p>
<div class="highlight"><pre><span></span><span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">thingThatCouldFail</span><span class="p">();</span>
</pre></div>
<p>This will cause the function the statement is inside to short-circuit,
returning immediately, if <code>thingThatCouldFail</code> has an error result.</p>
<p>But then I wanted to retry a function that could fail in a loop after
handling the error.</p>
<div class="highlight"><pre><span></span><span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">x</span><span class="o">:</span><span class="w"> </span><span class="n">SomeType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">somedefault</span><span class="p">;</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">tries</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">thingThatCouldFail</span><span class="p">())</span><span class="w"> </span><span class="o">|</span><span class="n">good_value</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">good_value</span><span class="p">;</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// do something that should fix it for the next time</span>
<span class="w">    </span><span class="n">tries</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
<p>But that isn't a real syntax. The Zig docs show an example of how you
can use <code>if</code> with an <code>error</code> function:</p>
<div class="highlight"><pre><span></span><span class="k">fn</span><span class="w"> </span><span class="n">doAThing</span><span class="p">(</span><span class="n">str</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parseU64</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">))</span><span class="w"> </span><span class="o">|</span><span class="n">number</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">doSomethingWithNumber</span><span class="p">(</span><span class="n">number</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="o">|</span><span class="n">err</span><span class="o">|</span><span class="w"> </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">error</span><span class="p">.</span><span class="n">Overflow</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// handle overflow...</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="c1">// we promise that InvalidChar won&#39;t happen (or crash in debug mode if it does)</span>
<span class="w">    </span><span class="k">error</span><span class="p">.</span><span class="n">InvalidChar</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">unreachable</span><span class="p">,</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>But I don't care about the error at this moment (maybe I should, but I
don't right now).</p>
<p>So I tried:</p>
<div class="highlight"><pre><span></span><span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">x</span><span class="o">:</span><span class="w"> </span><span class="n">SomeType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">somedefault</span><span class="p">;</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">tries</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">thingThatCouldFail</span><span class="p">())</span><span class="w"> </span><span class="o">|</span><span class="n">good_value</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">good_value</span><span class="p">;</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// do something that should fix it for the next time</span>
<span class="w">      </span><span class="n">tries</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
<p>But that gives me an obscure type error.</p>
<p>I was stumped here for a while until I decided to try the whole syntax
in that example. And it turns out that at least the capture part is
necessary at the parser layer:</p>
<div class="highlight"><pre><span></span><span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">x</span><span class="o">:</span><span class="w"> </span><span class="n">SomeType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">somedefault</span><span class="p">;</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">tries</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">thingThatCouldFail</span><span class="p">())</span><span class="w"> </span><span class="o">|</span><span class="n">good_value</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">good_value</span><span class="p">;</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="o">|</span><span class="n">err</span><span class="o">|</span><span class="w"> </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// do something that should fix it for the next time</span>
<span class="w">        </span><span class="n">tries</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
<p>And eventually I guessed an unnamed error variable might also work
without the switch, and that was correct:</p>
<div class="highlight"><pre><span></span><span class="w">  </span><span class="kr">var</span><span class="w"> </span><span class="n">x</span><span class="o">:</span><span class="w"> </span><span class="n">SomeType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">somedefault</span><span class="p">;</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">tries</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">thingThatCouldFail</span><span class="p">())</span><span class="w"> </span><span class="o">|</span><span class="n">good_value</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">good_value</span><span class="p">;</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// do something that should fix it for the next time</span>
<span class="w">      </span><span class="n">tries</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
<p>Nice!</p>
<h3 id="<code>catch</code>-blocks"><code>catch</code> blocks</h3><p>One last thing that I was stumbling around with was that when you use
<code>catch</code> with a function that returns an error or some non-void value,
the catch must "return" a value of the same type as the function.</p>
<p>The Zig docs show a simple example:</p>
<div class="highlight"><pre><span></span><span class="kr">const</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseU64</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="mi">13</span><span class="p">;</span>
</pre></div>
<p>But I also use <code>catch</code> with blocks sometimes:</p>
<div class="highlight"><pre><span></span><span class="kr">const</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseU64</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// do some more complex stuff, maybe log, who knows</span>
<span class="p">};</span>
</pre></div>
<p>But that won't compile. So the "trick" is to combine Zig's <a href="https://ziglang.org/documentation/master/#Blocks">named
blocks</a> with
<code>catch</code>.</p>
<div class="highlight"><pre><span></span><span class="kr">const</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseU64</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="n">blk</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// do some more complex stuff, maybe log, who knows</span>

<span class="w">  </span><span class="c1">// and then &quot;return&quot; a result</span>
<span class="w">  </span><span class="k">break</span><span class="w"> </span><span class="o">:</span><span class="n">blk</span><span class="w"> </span><span class="mi">13</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
<h3 id="contributing-to-zig-docs">Contributing to Zig docs</h3><p>I didn't want to write this post without offering some of my examples
to the docs. While there's a dedicated effort around autodoc, the tool
that builds docs for the standard library, I haven't yet stumbled on
docs for contributing the main Zig docs.</p>
<p>So I grepped in the Zig repo <code>git grep 'Blocks are expressions.'</code>, a
phrase that showed up in the HTML docs, and found
<code>doc/langref.html.in</code>.</p>
<p>Then someone on the <a href="https://discord.gg/gxsFFjE">Zig Programming Language
Discord</a> pointed me at running
<code>zig build docs</code> in the repo root to generate the HTML.</p>
<p>And now I've got a <a href="https://github.com/ziglang/zig/pull/15042">PR up</a>!
We'll see what folks think.</p>
<p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">I wrote a new post about error-handling and Zig, as I&#39;ve been doing a bunch of scripting with Zig recently.<br><br>I stumbled a few times so maybe that will be useful to you. And I was able to turn parts of my stumbling into a potential PR to the Zig docs. ðŸŽ‰<a href="https://t.co/00RVWpodmd">https://t.co/00RVWpodmd</a> <a href="https://t.co/wENSEpj63A">pic.twitter.com/wENSEpj63A</a></p>&mdash; Phil Eaton (@eatonphil) <a href="https://twitter.com/eatonphil/status/1638350047887622145?ref_src=twsrc%5Etfw">March 22, 2023</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<style>.feedback{display:initial;}</style>
	</div>
	<div class="feedback">
	  <h4>Feedback</h4>
	  <p>As always,
	      please <a href="mailto:phil@eatonphil.com">email</a>
	      or <a href="https://twitter.com/eatonphil">tweet me</a>
	      with questions, corrections, or ideas!</p>

	</div>
      </div>
    </div>
    <footer>
      <div class="container">
	<div>
	  <div id="subscribe">
	    <iframe frameBorder="0" src="https://cdn.forms-content-1.sg-form.com/e8ed4c3b-dd46-11f0-b6e6-ce075f2c5f80"/>

	  </div>
	</div>
      </div>
    </footer>
    <script async onload="loadGA()" src="https://www.googletagmanager.com/gtag/js?id=UA-58109156-2"></script>
    <script>
      function loadGA() {
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());
	  gtag('config', 'UA-58109156-2');
      }
    </script>
    <script defer src="https://cdn.usefathom.com/script.js" data-site="CEPUOLOQ"></script>
  </body>
</html>
