<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="canonical" href="https://notes.eatonphil.com/writing-a-simple-python-compiler.html">
    <title>Writing a simple Python compiler: 1. hello, fibonacci | notes.eatonphil.com</title>
    <meta name="description" content="Writing a simple Python compiler: 1. hello, fibonacci" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" href="/rss.xml" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono">
  </head>
  <body>
    <header>
      <div class="lfw">
	<div class="container">
	  <div class="row">
	    <a href="https://eatonphil.com/2025-holiday-fundraiser.html">2025 Holiday Fundraiser</a>
	  </div>
	</div>
      </div>
      <div class="container">
        <div>
          <div class="row">
	    <div>
	      <a href="https://eatonphil.com" class="sm-link">
		Home
              </a>
	      <a href="/" class="sm-link">
		Blog
              </a>
	      <a href="/rss.xml" class="sm-link">
		RSS
              </a>
	    </div>

	    <div class="subscribe">
	      <!-- <a href="https://eatonphil.com/hire-me.html">Hire me</a> -->
	      <!--
		  Hardcode link to home page because some pages don't
		  have a subscribe box. Some pages hide the subscribe.
		-->
	      <a href="https://eatonphil.com/subscribe.html">
		Subscribe
	      </a>
            </div>
	  </div>
	  <hr />
	  <div class="">
            <h2>August 16, 2020</h2>
            <h1>Writing a simple Python compiler: 1. hello, fibonacci</h1>
	    
            <div class="row" style="padding-bottom: 5px">
              <div class="tags"><a href="/tags/python.html" class="tag">python</a><a href="/tags/compilers.html" class="tag">compilers</a><a href="/tags/cpython.html" class="tag">cpython</a><a href="/tags/c.html" class="tag">c</a></div>
            </div>
	  </div>
	</div>
      </div>
    </header>
    <div class="container">
      <div class="col-6">
	<div class="post">
          <p>In this post we'll write a Python to C compiler in Python. This is
especially easy to do since Python has a <a href="https://docs.python.org/3/library/ast.html">builtin parser
library</a> and because a
number of <a href="https://docs.python.org/3/c-api/">CPython internals are exposed for extension
writers</a>.</p>
<p>By the end of this post, in a few hundred lines of Python, we'll be able to
compile and run the following program:</p>
<div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">cat</span> <span class="n">tests</span><span class="o">/</span><span class="n">recursive_fib</span><span class="o">.</span><span class="n">py</span>
<span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">n</span>

    <span class="k">return</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">fib</span><span class="p">(</span><span class="mi">40</span><span class="p">))</span>
<span class="err">$</span> <span class="n">python3</span> <span class="n">pyc</span> <span class="n">tests</span><span class="o">/</span><span class="n">recursive_fib</span><span class="o">.</span><span class="n">py</span>
<span class="err">$</span> <span class="o">./</span><span class="nb">bin</span><span class="o">/</span><span class="n">a</span><span class="o">.</span><span class="n">out</span>
<span class="mi">102334155</span>
</pre></div>
<p>This post implements an extremely small subset of Python and
<strong>completely gives up on even trying to manage memory</strong> because I
cannot fathom manual reference counting. Maybe some day I'll find a
way to swap in an easy GC like Boehm.</p>
<p><a href="https://github.com/eatonphil/pyc">Source code for this project is available on Github.</a></p>
<h3 id="dependencies">Dependencies</h3><p>We'll need Python3, GCC, libpython3, and clang-format.</p>
<p>On Fedora-based systems:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>gcc<span class="w"> </span>python3-devel<span class="w"> </span>clang-format<span class="w"> </span>python3
</pre></div>
<p>And on Debian-based systems:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>gcc<span class="w"> </span>python3-dev<span class="w"> </span>clang-format<span class="w"> </span>python3
</pre></div>
<p class="note">
  This program will likely work as well on Windows, Mac, FreeBSD,
  etc. but I haven't gone through the trouble of testing this (or
  providing custom compiler directives). Pull requests welcome!
</p><h3 id="a-hand-written-first-pass">A hand-written first-pass</h3><p>Before we get into the compiler, let's write the fibonacci program by
hand in C using libpython.</p>
<p>As described in the <a href="https://docs.python.org/3/extending/embedding.html#very-high-level-embedding">Python embedding
guide</a>
we'll need to include libpython and initialize it in
our <code>main.c</code>:</p>
<div class="highlight"><pre><span></span><span class="cp">#define PY_SSIZE_T_CLEAN</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Python.h&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Py_Initialize</span><span class="p">();</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>To compile against libpython, we'll use
<a href="https://helpmanual.io/man1/python3-config/">python3-config</a> installed
as part of <code>python3-devel</code> to tell us what should be linked
at each step during compilation.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>gcc<span class="w"> </span>-c<span class="w"> </span>-o<span class="w"> </span>main.o<span class="w"> </span><span class="k">$(</span>python3-config<span class="w"> </span>--cflags<span class="k">)</span><span class="w"> </span>main.c
$<span class="w"> </span>gcc<span class="w"> </span><span class="k">$(</span>python3-config<span class="w"> </span>--ldflags<span class="k">)</span><span class="w"> </span>main.o
$<span class="w"> </span>./a.out<span class="p">;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$?</span>
<span class="m">0</span>
</pre></div>
<p>Cool! Now as we think about translating the fibonacci implementation,
we want to keep everything as Python objects for as long as
possible. This means passing and receiving
<a href="https://docs.python.org/3/c-api/object.html">PyObject*</a> to and from
all functions, and converting all C integers to
<a href="https://docs.python.org/3/c-api/long.html">PyLong*</a>, a "subtype" of
<code>PyObject*</code>. You can imagine that everything in Python is
an <code>object</code> until you operate on it.</p>
<p class="note">
  For more information on objects in Python, check out
  the <a href="https://docs.python.org/3/reference/datamodel.html">Data
  model</a> page in Python docs.
</p><p>To map a C integer to a <code>PyLong*</code> we use
<a href="https://docs.python.org/3/c-api/long.html#c.PyLong_FromLong">PyLong_FromLong</a>. To
map in reverse, we use
<a href="https://docs.python.org/3/c-api/long.html#c.PyLong_AsLong">PyLong_AsLong</a>.</p>
<p>To compare two <code>PyObject*</code>s we can use
<a href="https://docs.python.org/3/c-api/object.html#c.PyObject_RichCompareBool">PyObject_RichCompareBool</a>
which will handle the comparison regardless of the type of the two
parameters. Without this helper we'd have to write complex checks to
make sure that the two sides are the same and if they are, unwrap them
into their underlying C value and compare the C value.</p>
<p>We can use
<a href="https://docs.python.org/3/c-api/number.html#c.PyNumber_Add">PyNumber_Add</a>
and
<a href="https://docs.python.org/3/c-api/number.html#c.PyNumber_Subtract">PyNumber_Subtract</a>
for basic arithmetic, and there are many similar helpers available to
us for operations down the line.</p>
<p>Now we can write a translation:</p>
<div class="highlight"><pre><span></span><span class="cp">#define PY_SSIZE_T_CLEAN</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Python.h&gt;</span>

<span class="n">PyObject</span><span class="o">*</span><span class="w"> </span><span class="nf">fib</span><span class="p">(</span><span class="n">PyObject</span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">PyObject</span><span class="o">*</span><span class="w"> </span><span class="n">zero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyLong_FromLong</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="n">PyObject</span><span class="o">*</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyLong_FromLong</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">PyObject_RichCompareBool</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="n">Py_EQ</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">PyObject_RichCompareBool</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">one</span><span class="p">,</span><span class="w"> </span><span class="n">Py_EQ</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">PyObject</span><span class="o">*</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fib</span><span class="p">(</span><span class="n">PyNumber_Subtract</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">one</span><span class="p">));</span>

<span class="w">  </span><span class="n">PyObject</span><span class="o">*</span><span class="w"> </span><span class="n">two</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyLong_FromLong</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="w">  </span><span class="n">PyObject</span><span class="o">*</span><span class="w"> </span><span class="n">right</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fib</span><span class="p">(</span><span class="n">PyNumber_Subtract</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">two</span><span class="p">));</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">PyNumber_Add</span><span class="p">(</span><span class="n">left</span><span class="p">,</span><span class="w"> </span><span class="n">right</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Py_Initialize</span><span class="p">();</span>

<span class="w">  </span><span class="n">PyObject</span><span class="o">*</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fib</span><span class="p">(</span><span class="n">PyLong_FromLong</span><span class="p">(</span><span class="mi">7</span><span class="p">));</span><span class="w"> </span><span class="c1">// Should be 13</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">PyLong_AsLong</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>Compile and run it:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>gcc<span class="w"> </span>-c<span class="w"> </span>-o<span class="w"> </span>main.o<span class="w"> </span><span class="k">$(</span>python3-config<span class="w"> </span>--cflags<span class="k">)</span><span class="w"> </span>main.c
$<span class="w"> </span>gcc<span class="w"> </span><span class="k">$(</span>python3-config<span class="w"> </span>--ldflags<span class="k">)</span><span class="w"> </span>main.o
$<span class="w"> </span>./a.out<span class="p">;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$?</span>
<span class="m">13</span>
</pre></div>
<p>That's great! But we cheated in one place. We assumed that the input
to the <code>fib</code> function was an integer, and we propagated
that assumption everywhere we wrote <code>PyNumber_*</code>
operations. When we write the compiler, we'll need to check that both
arguments are an integer before we call a numeric helper, otherwise we
may need to call a string concatenation helper or something else
entirely.</p>
<h3 id="compiler-architecture">Compiler Architecture</h3><p>We'll break the code into four major parts:</p>
<ol>
<li><code>libpyc.c</code>: helper functions for generated code</li>
<li><code>pyc/context.py</code>: utilities for scope and writing code in memory</li>
<li><code>pyc/codegen.py</code>: for generating C code from a Python AST</li>
<li><code>pyc/__main__.py</code>: the entrypoint</li>
</ol>
<p class="note">
  When I'm writing a new compiler using an existing parser I almost
  always start with the entrypoint and code generator so I can explore
  the AST. However, it's easiest to explain the code if we start with
  the utilities first.
</p><p>We'll also want an empty <code>pyc/__init__.py</code>.</p>
<h3 id="libpyc.c">libpyc.c</h3><p>This C file will contain three helper functions for safely adding,
subtracting, and printing. It will be concatenated to the top of the
generated C file. We'll only support integers for now but this
structure sets us up for supporting more types later on.</p>
<p>We'll use
<a href="https://docs.python.org/3/c-api/long.html#c.PyLong_Check">PyLong_Check</a>
before calling number-specific methods.</p>
<div class="highlight"><pre><span></span><span class="cp">#define PY_SSIZE_T_CLEAN</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Python.h&gt;</span>

<span class="kr">inline</span><span class="w"> </span><span class="n">PyObject</span><span class="o">*</span><span class="w"> </span><span class="nf">PYC_Add</span><span class="p">(</span><span class="n">PyObject</span><span class="o">*</span><span class="w"> </span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">PyObject</span><span class="o">*</span><span class="w"> </span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// TODO: allow __add__ override</span>

<span class="w">  </span><span class="c1">// Includes ints and bools</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">PyLong_Check</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">PyLong_Check</span><span class="p">(</span><span class="n">r</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">PyNumber_Add</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// TODO: handle str, etc.</span>

<span class="w">  </span><span class="c1">// TODO: throw exception</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span><span class="w"> </span><span class="n">PyObject</span><span class="o">*</span><span class="w"> </span><span class="nf">PYC_Sub</span><span class="p">(</span><span class="n">PyObject</span><span class="o">*</span><span class="w"> </span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">PyObject</span><span class="o">*</span><span class="w"> </span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// TODO: allow __add__ override</span>

<span class="w">  </span><span class="c1">// Includes ints and bools</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">PyLong_Check</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">PyLong_Check</span><span class="p">(</span><span class="n">r</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">PyNumber_Subtract</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// TODO: handle str, etc.</span>

<span class="w">  </span><span class="c1">// TODO: throw exception</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span><span class="w"> </span><span class="n">PyObject</span><span class="o">*</span><span class="w"> </span><span class="nf">PYC_Print</span><span class="p">(</span><span class="n">PyObject</span><span class="o">*</span><span class="w"> </span><span class="n">o</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">PyObject_Print</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="w"> </span><span class="n">stdout</span><span class="p">,</span><span class="w"> </span><span class="n">Py_PRINT_RAW</span><span class="p">);</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">Py_None</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>That's it! We could generate these as strings in Python but it gets
hairy to do so. By using a dedicated C file, we can take advantage of
syntax highlighting since this file is only C code. And since we've
marked all functions as <code>inline</code>, there's no runtime cost
to using not embedding these as strings in Python.</p>
<h3 id="pyc/context.py">pyc/context.py</h3><p>This file will contain a <code>Context</code> class for managing
identifiers in scope and for proxying to a <code>Writer</code> class
that contains helpers for writing lines of C code.</p>
<p>We'll have two instances of the <code>Writer</code> class in
<code>Context</code> so that we can write to a body (or
current/primary) region and an initialization region.</p>
<p>The initialization region is necessary in case there are any variables
declared at the top-level. We can't initialize these variables in C
outside of a function since every <code>PyObject*</code> must be
created after calling <code>Py_Initialize</code>. This section will be
written into our C <code>main</code> function before we enter a
compiled Python <code>main</code> function.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">copy</span>


<span class="k">class</span> <span class="nc">Writer</span><span class="p">():</span>
    <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">indent</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;  &quot;</span> <span class="o">*</span> <span class="n">indent</span><span class="p">)</span> <span class="o">+</span> <span class="n">exp</span>

    <span class="k">def</span> <span class="nf">writeln</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stmt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">indent</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">stmt</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">indent</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write_statement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stmt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">indent</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeln</span><span class="p">(</span><span class="n">stmt</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="n">indent</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Context</span><span class="p">():</span>
    <span class="n">initializations</span> <span class="o">=</span> <span class="n">Writer</span><span class="p">()</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">Writer</span><span class="p">()</span>
    <span class="n">indentation</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">scope</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">namings</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
        <span class="c1"># Helpers to avoid passing in self.indentation every time</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">initializations</span><span class="s2">&quot;, &quot;</span><span class="n">body</span><span class="s2">&quot;]</span>
        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>
                <span class="k">return</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">),</span> <span class="n">name</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:])(</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">indentation</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">namings</span><span class="p">[</span><span class="n">source_name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">register_global</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">loc</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">namings</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">loc</span><span class="p">,</span>
            <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">register_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;tmp&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">namings</span><span class="p">[</span><span class="n">local</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">local</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="c1"># naming dictionary is copied, so we need to capture scope</span>
            <span class="c1"># at declaration</span>
            <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">namings</span><span class="p">[</span><span class="n">local</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># For some reason copy.deepcopy doesn&#39;t do this</span>
        <span class="n">new</span><span class="o">.</span><span class="n">namings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">new</span><span class="o">.</span><span class="n">namings</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new</span>

    <span class="k">def</span> <span class="nf">at_toplevel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span> <span class="o">==</span> <span class="mi">0</span>
</pre></div>
<p>This is all pretty boring boilerplate. Let's move on.</p>
<h3 id="pyc/<strong>main</strong>.py">pyc/<strong>main</strong>.py</h3><p>The entrypoint is responsible for reading source code, parsing it,
calling the code generator, writing the source code to a C file, and
compiling it.</p>
<p>First, we read and parse the source code:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">context</span> <span class="kn">import</span> <span class="n">Context</span>
<span class="kn">from</span> <span class="nn">codegen</span> <span class="kn">import</span> <span class="n">generate</span>

<span class="n">BUILTINS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;print&quot;</span><span class="p">:</span> <span class="s2">&quot;PYC_Print&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</pre></div>
<p>Then we write <code>libpyc.c</code> into the body, register builtins,
and run code generation:</p>
<div class="highlight"><pre><span></span><span class="o">...</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">()</span>
    <span class="o">...</span>

    <span class="n">ctx</span> <span class="o">=</span> <span class="n">Context</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;libpyc.c&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">body_write</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">builtin</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">BUILTINS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">register_global</span><span class="p">(</span><span class="n">builtin</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>

    <span class="n">generate</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">tree</span><span class="p">)</span>
</pre></div>
<p>Next, we create a clean output directory and write
<code>main.c</code> with the generated code and a <code>main</code>
function to initialization Python and any global variables:</p>
<div class="highlight"><pre><span></span><span class="o">...</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
   <span class="o">...</span>

    <span class="c1"># Create and move to working directory</span>
    <span class="n">outdir</span> <span class="o">=</span> <span class="s2">&quot;bin&quot;</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;main.c&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

        <span class="n">main</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">namings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">)[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;int main(int argc, char *argv[]) </span><span class="se">{{</span>
<span class="s2">  Py_Initialize();</span>

<span class="s2">  // Initialize globals, if any.</span>
<span class="si">{</span><span class="n">ctx</span><span class="o">.</span><span class="n">initializations</span><span class="o">.</span><span class="n">content</span><span class="si">}</span>
<span class="s2">  PyObject* r = </span><span class="si">{</span><span class="n">main</span><span class="si">}</span><span class="s2">();</span>
<span class="s2">  return PyLong_AsLong(r);</span>
<span class="se">}}</span><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
<p>Finally, we run <code>clang-format</code> and <code>gcc</code> against
the generated C code:</p>
<div class="highlight"><pre><span></span><span class="o">...</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="o">...</span>

    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;clang-format&quot;</span><span class="p">,</span> <span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="s2">&quot;main.c&quot;</span><span class="p">])</span>

    <span class="n">cflags_raw</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s2">&quot;python3-config&quot;</span><span class="p">,</span> <span class="s2">&quot;--cflags&quot;</span><span class="p">])</span>
    <span class="n">cflags</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">cflags_raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gcc&quot;</span><span class="p">,</span> <span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="s2">&quot;main.o&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cflags</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;main.c&quot;</span><span class="p">]</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

    <span class="n">ldflags_raw</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s2">&quot;python3-config&quot;</span><span class="p">,</span> <span class="s2">&quot;--ldflags&quot;</span><span class="p">])</span>
    <span class="n">ldflags</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ldflags_raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gcc&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ldflags</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;main.o&quot;</span><span class="p">]</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
</pre></div>
<p>All together:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">context</span> <span class="kn">import</span> <span class="n">Context</span>
<span class="kn">from</span> <span class="nn">codegen</span> <span class="kn">import</span> <span class="n">generate</span>

<span class="n">BUILTINS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;print&quot;</span><span class="p">:</span> <span class="s2">&quot;PYC_Print&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

    <span class="n">ctx</span> <span class="o">=</span> <span class="n">Context</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;libpyc.c&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">body_write</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">builtin</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">BUILTINS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">register_global</span><span class="p">(</span><span class="n">builtin</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>

    <span class="n">generate</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">tree</span><span class="p">)</span>

    <span class="c1"># Create and move to working directory</span>
    <span class="n">outdir</span> <span class="o">=</span> <span class="s2">&quot;bin&quot;</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;main.c&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

        <span class="n">main</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">namings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">)[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;int main(int argc, char *argv[]) </span><span class="se">{{</span>
<span class="s2">  Py_Initialize();</span>

<span class="s2">  // Initialize globals, if any.</span>
<span class="si">{</span><span class="n">ctx</span><span class="o">.</span><span class="n">initializations</span><span class="o">.</span><span class="n">content</span><span class="si">}</span>
<span class="s2">  PyObject* r = </span><span class="si">{</span><span class="n">main</span><span class="si">}</span><span class="s2">();</span>
<span class="s2">  return PyLong_AsLong(r);</span>
<span class="se">}}</span><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;clang-format&quot;</span><span class="p">,</span> <span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="s2">&quot;main.c&quot;</span><span class="p">])</span>

    <span class="n">cflags_raw</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s2">&quot;python3-config&quot;</span><span class="p">,</span> <span class="s2">&quot;--cflags&quot;</span><span class="p">])</span>
    <span class="n">cflags</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">cflags_raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gcc&quot;</span><span class="p">,</span> <span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="s2">&quot;main.o&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cflags</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;main.c&quot;</span><span class="p">]</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

    <span class="n">ldflags_raw</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s2">&quot;python3-config&quot;</span><span class="p">,</span> <span class="s2">&quot;--ldflags&quot;</span><span class="p">])</span>
    <span class="n">ldflags</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ldflags_raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gcc&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ldflags</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;main.o&quot;</span><span class="p">]</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>


<span class="n">main</span><span class="p">()</span>
</pre></div>
<p>Done!</p>
<h3 id="pyc/codegen.py">pyc/codegen.py</h3><p>Lastly we write the translation layer from Python AST to C. We'll
break this out into 10 helper functions. It is helpful to have the
<a href="https://docs.python.org/3/library/ast.html#abstract-grammar">AST
spec</a> for
reference.</p>
<h4 id="1/10:-generate">1/10: generate</h4><p>The entrypoint of the code generator is <code>generate(ctx: Context,
exp)</code>. It generates code for any object with a <code>body</code>
attribute storing a list of statements. This function will generate
code for objects like modules, function bodies, if bodies, etc.</p>
<p>The statements we'll support to begin are:</p>
<ul>
<li><code>ast.Assign</code></li>
<li><code>ast.FunctionDef</code></li>
<li><code>ast.Return</code></li>
<li><code>ast.If</code></li>
<li>and <code>ast.Expr</code></li>
</ul>
<p>For each statement, we'll simply pass on generation to an associated
helper function. In the case of expression generation though, we'll
also add a noop operation on the result of the expression otherwise
the compiler will complain about an unused variable.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">stmt</span> <span class="ow">in</span> <span class="n">module</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">):</span>
            <span class="n">generate_assign</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">stmt</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">):</span>
            <span class="n">generate_function_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">stmt</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Return</span><span class="p">):</span>
            <span class="n">generate_return</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">stmt</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">If</span><span class="p">):</span>
            <span class="n">generate_if</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">stmt</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">generate_expression</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">stmt</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">body_writeln</span><span class="p">(</span><span class="s2">&quot;// noop to hide unused warning&quot;</span><span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">body_write_statement</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2"> += 0&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported statement type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
<p class="note">
  Remember to throw exceptions aggressively otherwise you'll have a
  bad time debugging programs using new syntax.
</p><p>Let's dig into these helpers.</p>
<h4 id="2/10:-generate_assign">2/10: generate_assign</h4><p>To generate assignment code, we need to check if we're at the
top-level or not. If we're at the top-level we can declare the
variable but we can't initialize it yet. So we add the initialization
code to the <code>initialization</code> section of the program.</p>
<p>If we're not at the top-level, we can declare and assign in one
statement.</p>
<p>Before doing either though, we register the variable name so we can
get a safe local name to use in generated code. Then we compile the
right-hand side so we can assign it to the left-hand side.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ast</span>

<span class="kn">from</span> <span class="nn">context</span> <span class="kn">import</span> <span class="n">Context</span>


<span class="k">def</span> <span class="nf">initialize_variable</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">at_toplevel</span><span class="p">():</span>
        <span class="n">decl</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PyObject* </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">body_write_statement</span><span class="p">(</span><span class="n">decl</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">init</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">initializations_write_statement</span><span class="p">(</span><span class="n">init</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">body_write_statement</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PyObject* </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">generate_assign</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">stmt</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">):</span>
    <span class="c1"># TODO: support assigning to a tuple</span>
    <span class="n">local</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">register_local</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">generate_expression</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">stmt</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">initialize_variable</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">local</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
</pre></div>
<p>We're going to need to implement <code>generate_expression</code> to
make this work.</p>
<h4 id="3/10:-generate_expression">3/10: generate_expression</h4><p>Just like for statements in <code>generate</code>, there are a few
kinds of expressions we need to implement:</p>
<ul>
<li><code>ast.Num</code></li>
<li><code>ast.BinOp</code></li>
<li><code>ast.BoolOp</code></li>
<li><code>ast.Name</code></li>
<li><code>ast.Compare</code></li>
<li>and <code>ast.Call</code></li>
</ul>
<p>For <code>ast.Num</code>, we just need to wrap the literal number as a
<code>PyLong*</code>. And for <code>ast.Name</code> we just need to
look up the local name in context. Otherwise we delegate to more
helper functions.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_expression</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Num</span><span class="p">):</span>
        <span class="c1"># TODO: deal with non-integers</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">register_local</span><span class="p">(</span><span class="s2">&quot;num&quot;</span><span class="p">)</span>
        <span class="n">initialize_variable</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;PyLong_FromLong(</span><span class="si">{</span><span class="n">exp</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tmp</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">BinOp</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">generate_bin_op</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">BoolOp</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">generate_bool_op</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get_local</span><span class="p">(</span><span class="n">exp</span><span class="o">.</span><span class="n">id</span><span class="p">)[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Compare</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">generate_compare</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">generate_call</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span>

    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported expression: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
<p>For every code generation helper that is an expression, we store the
expression in a local variable and return the variable's name so that
parent nodes in the AST can refer to the child. This can result in
inefficient code generation (useless assignment) but that's not really
a big deal for a project like this and will likely be optimized away
by GCC anyway. The more annoying aspect is that useless assignment
just makes the generated code harder to read.</p>
<h4 id="4/10:-generate_bin_op">4/10: generate_bin_op</h4><p>For binary operators we need to support addition and
subtraction. Other binary operators like equality or and/or are
represented in <code>ast.Compare</code> and <code>ast.BoolOp</code>.</p>
<p>This is easy to write because we already prepared helpers in
<code>libpyc.c</code>: <code>PYC_Sub</code> and <code>PYC_Add</code>.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_bin_op</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">binop</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">BinOp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">register_local</span><span class="p">(</span><span class="s2">&quot;binop&quot;</span><span class="p">)</span>

    <span class="n">l</span> <span class="o">=</span> <span class="n">generate_expression</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">binop</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">generate_expression</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">binop</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binop</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Add</span><span class="p">):</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">body_write_statement</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PyObject* </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2"> = PYC_Add(</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binop</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Sub</span><span class="p">):</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">body_write_statement</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PyObject* </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2"> = PYC_Sub(</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported binary operator: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">binop</span><span class="o">.</span><span class="n">op</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</pre></div>
<p>Easy enough.</p>
<h4 id="5/10:-generate_bool_op">5/10: generate_bool_op</h4><p>We only need to support <code>or</code> for the fibonacci program, but
<code>or</code> in Python is more complicated than in C. In Python,
the first value to be truthy short-circuits the expression and the
result is its value, not <code>True</code>.</p>
<p>We'll use <code>goto</code> to short-circuit and we'll use
<a href="https://docs.python.org/3/c-api/object.html#c.PyObject_IsTrue">PyObject_IsTrue</a>
to do the truthy check:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_bool_op</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">boolop</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">BoolOp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">register_local</span><span class="p">(</span><span class="s2">&quot;boolop&quot;</span><span class="p">)</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">body_write_statement</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PyObject* </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">boolop</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Or</span><span class="p">):</span>
        <span class="n">done_or</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">register_local</span><span class="p">(</span><span class="s2">&quot;done_or&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">boolop</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">generate_expression</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">body_write_statement</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">body_writeln</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;if (PyObject_IsTrue(</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">)) </span><span class="se">{{</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">body_write_statement</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;goto </span><span class="si">{</span><span class="n">done_or</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">indentation</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">body_writeln</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">)</span>

        <span class="n">ctx</span><span class="o">.</span><span class="n">body_writeln</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">done_or</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</pre></div>
<p class="note">
  Now that I write this down I see we could probably move this
  function into <code>libpyc.c</code> if we used a loop. Maybe in
  the next iteration.
</p><p>We move on.</p>
<h4 id="6/10:-generate_compare">6/10: generate_compare</h4><p>This function handles equality and inequality checks. We'll adapt the
<code>PyObject_RichCompareBool</code> helper we used in the
hand-written translation.</p>
<p>The only additional thing to keep in mind is that the right-hand side
is passed as an array. So we have to iterate through it and apply the
equality/inequality check on all objects in the list.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_compare</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">exp</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Compare</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">register_local</span><span class="p">(</span><span class="s2">&quot;compare&quot;</span><span class="p">)</span>
    <span class="n">left</span> <span class="o">=</span> <span class="n">generate_expression</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">exp</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">body_write_statement</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PyObject* </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">left</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">exp</span><span class="o">.</span><span class="n">ops</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">generate_expression</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">exp</span><span class="o">.</span><span class="n">comparators</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Eq</span><span class="p">):</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">body_write_statement</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2"> = PyObject_RichCompare(</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">, Py_EQ)&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">NotEq</span><span class="p">):</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">body_write_statement</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2"> = PyObject_RichCompare(</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">, Py_NE)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported comparison: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">op</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</pre></div>
<h4 id="7/10:-generate_call">7/10: generate_call</h4><p>The last expression is simple enough. We compile the call's arguments
first, then the function itself, then we call the function with the
arguments like any C function. Calling the C function directly will
have ramifications for interacting with Python libraries (basically,
we won't be able to interact with any) but it's the easiest way to get
started.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_call</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">exp</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">generate_expression</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">exp</span><span class="o">.</span><span class="n">args</span><span class="p">])</span>
    <span class="n">fun</span> <span class="o">=</span> <span class="n">generate_expression</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">exp</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">register_local</span><span class="p">(</span><span class="s2">&quot;call_result&quot;</span><span class="p">)</span>

    <span class="c1"># TODO: lambdas and closures need additional work</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">body_write_statement</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;PyObject* </span><span class="si">{</span><span class="n">res</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">fun</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>
</pre></div>
<p>And that's it for expressions! Just a few more statement helpers to
support.</p>
<h4 id="8/10:-generate_function_def">8/10: generate_function_def</h4><p>This is a fun one. First we register the function name in scope. Then
we copy the context so variables within the function body are
contained within the function body. We increment <code>scope</code> so
we know we've left the top-level. Finally, we compile the body.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_function_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">fd</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">register_local</span><span class="p">(</span><span class="n">fd</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="n">childCtx</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;PyObject* </span><span class="si">{</span><span class="n">childCtx</span><span class="o">.</span><span class="n">register_local</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">fd</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">args</span><span class="p">])</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">body_writeln</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PyObject* </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2">) </span><span class="se">{{</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">childCtx</span><span class="o">.</span><span class="n">scope</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">childCtx</span><span class="o">.</span><span class="n">indentation</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">generate</span><span class="p">(</span><span class="n">childCtx</span><span class="p">,</span> <span class="n">fd</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">childCtx</span><span class="o">.</span><span class="n">ret</span><span class="p">:</span>
        <span class="n">childCtx</span><span class="o">.</span><span class="n">body_write_statement</span><span class="p">(</span><span class="s2">&quot;return Py_None&quot;</span><span class="p">)</span>

    <span class="n">ctx</span><span class="o">.</span><span class="n">body_writeln</span><span class="p">(</span><span class="s2">&quot;}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
<p>The check for <code>childCtx.ret</code> isn't strictly necessary
because we could just emit a return even if there already was
one. Asking <code>generate_return</code> to set this attribute and
having <code>generate_function_def</code> check it just makes the
generate code a little prettier.</p>
<h4 id="9/10:-generate_return">9/10: generate_return</h4><p>Very straightforward, we just compile the value to be returned and
then we emit a <code>return</code> statement.</p>
<p>We store the return value so that the function definition can know
whether to add a <code>return PyNone</code> statement.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_return</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Return</span><span class="p">):</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">ret</span> <span class="o">=</span> <span class="n">generate_expression</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">body_writeln</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">body_write_statement</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;return </span><span class="si">{</span><span class="n">ctx</span><span class="o">.</span><span class="n">ret</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
<p>And we've got one last statement to support!</p>
<h4 id="10/10:-generate_if">10/10: generate_if</h4><p>You know the deal: compile the test and if the test is truthy, enter
the compiled body. We'll deal with the else body another time.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_if</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">exp</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">If</span><span class="p">):</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">generate_expression</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">exp</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">body_writeln</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;if (PyObject_IsTrue(</span><span class="si">{</span><span class="n">test</span><span class="si">}</span><span class="s2">)) </span><span class="se">{{</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">indentation</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">generate</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span>
    <span class="c1"># TODO: handle exp.orelse</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">indentation</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">body_writeln</span><span class="p">(</span><span class="s2">&quot;}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
<p>And we're done the compiler!</p>
<h3 id="trying-it-out">Trying it out</h3><p>As promised:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>cat<span class="w"> </span>tests/recursive_fib.py
def<span class="w"> </span>fib<span class="o">(</span>n<span class="o">)</span>:
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>or<span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span>:
<span class="w">        </span><span class="k">return</span><span class="w"> </span>n

<span class="w">    </span><span class="k">return</span><span class="w"> </span>fib<span class="o">(</span>n<span class="w"> </span>-<span class="w"> </span><span class="m">1</span><span class="o">)</span><span class="w"> </span>+<span class="w"> </span>fib<span class="o">(</span>n<span class="w"> </span>-<span class="w"> </span><span class="m">2</span><span class="o">)</span>


def<span class="w"> </span>main<span class="o">()</span>:
<span class="w">    </span>print<span class="o">(</span>fib<span class="o">(</span><span class="m">40</span><span class="o">))</span>
$<span class="w"> </span>python3<span class="w"> </span>pyc<span class="w"> </span>tests/recursive_fib.py
$<span class="w"> </span>./bin/a.out
<span class="m">102334155</span>
</pre></div>
<h4 id="microbenchmarking,-or-making-compiler-twitter-unhappy">Microbenchmarking, or making compiler Twitter unhappy</h4><p>Keep in mind this implementation does a small fraction of what CPython
is doing.</p>
<p>If you time the generated code:</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>python3<span class="w"> </span>pyc<span class="w"> </span>tests/recursive_fib.py
$<span class="w"> </span><span class="nb">time</span><span class="w"> </span>./bin/a.out
<span class="m">102334155</span>
./bin/a.out<span class="w">  </span><span class="m">18</span>.69s<span class="w"> </span>user<span class="w"> </span><span class="m">0</span>.03s<span class="w"> </span>system<span class="w"> </span><span class="m">99</span>%<span class="w"> </span>cpu<span class="w"> </span><span class="m">18</span>.854<span class="w"> </span>total
</pre></div>
<p>And CPython (with <code>main()</code> append to the source):</p>
<div class="highlight"><pre><span></span><span class="nb">time</span><span class="w"> </span>python3<span class="w"> </span>tests/recursive_fib.py
<span class="m">102334155</span>
python3<span class="w"> </span>tests/recursive_fib.py<span class="w">  </span><span class="m">76</span>.24s<span class="w"> </span>user<span class="w"> </span><span class="m">0</span>.11s<span class="w"> </span>system<span class="w"> </span><span class="m">99</span>%<span class="w"> </span>cpu<span class="w"> </span><span class="m">1</span>:16.81<span class="w"> </span>total
</pre></div>
<p>The only reason I mention this is because when I did a <a href="/compiling-dynamic-programming-languages.html#next-steps-with-jsc">similar
compiler project for JavaScript targeting
C++/libV8</a>,
the generated code was about the same or a little slower in speed.</p>
<p>I haven't gotten <em>that much</em> better at writing these compilers.</p>
<p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">Latest post up, on writing a simple Python to C compiler (in Python).<a href="https://t.co/4kkji0XXbp">https://t.co/4kkji0XXbp</a></p>&mdash; Phil Eaton (@phil_eaton) <a href="https://twitter.com/phil_eaton/status/1295134027335204865?ref_src=twsrc%5Etfw">August 16, 2020</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<style>.feedback{display:initial;}</style>
	</div>
	<div class="feedback">
	  <h4>Feedback</h4>
	  <p>As always,
	      please <a href="mailto:phil@eatonphil.com">email</a>
	      or <a href="https://twitter.com/eatonphil">tweet me</a>
	      with questions, corrections, or ideas!</p>

	</div>
      </div>
    </div>
    <footer>
      <div class="container">
	<div>
	  <div id="subscribe">
	    <iframe frameBorder="0" src="https://cdn.forms-content-1.sg-form.com/e8ed4c3b-dd46-11f0-b6e6-ce075f2c5f80"/>

	  </div>
	</div>
      </div>
    </footer>
    <script async onload="loadGA()" src="https://www.googletagmanager.com/gtag/js?id=UA-58109156-2"></script>
    <script>
      function loadGA() {
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());
	  gtag('config', 'UA-58109156-2');
      }
    </script>
    <script defer src="https://cdn.usefathom.com/script.js" data-site="CEPUOLOQ"></script>
  </body>
</html>
